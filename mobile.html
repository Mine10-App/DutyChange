<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- PWA Meta Tags -->
    <meta name="application-name" content="Duty Manager">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Duty Manager">
    <meta name="description" content="Duty and Leave Management System for staff">
    <meta name="format-detection" content="telephone=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="msapplication-TileColor" content="#2196F3">
    <meta name="msapplication-tap-highlight" content="no">
    <meta name="theme-color" content="#2196F3">
    
    <!-- Icons -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%232196F3'/%3E%3Ccircle cx='50' cy='35' r='12' fill='white'/%3E%3Cpath d='M50,55 C65,55 70,70 70,70 L30,70 C30,70 35,55 50,55 Z' fill='white'/%3E%3Cpath d='M35,75 L65,75 L65,85 C65,90 60,95 50,95 C40,95 35,90 35,85 Z' fill='white'/%3E%3C/svg%3E">
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%232196F3'/%3E%3Ccircle cx='50' cy='35' r='12' fill='white'/%3E%3Cpath d='M50,55 C65,55 70,70 70,70 L30,70 C30,70 35,55 50,55 Z' fill='white'/%3E%3Cpath d='M35,75 L65,75 L65,85 C65,90 60,95 50,95 C40,95 35,90 35,85 Z' fill='white'/%3E%3C/svg%3E">
    
    <!-- Manifest -->
    <link rel="manifest" href="data:application/manifest+json,{
        \"name\": \"Duty Manager\",
        \"short_name\": \"DutyMgr\",
        \"description\": \"Duty and Leave Management System\",
        \"start_url\": \"./\",
        \"display\": \"standalone\",
        \"background_color\": \"#2196F3\",
        \"theme_color\": \"#2196F3\",
        \"orientation\": \"portrait\",
        \"icons\": [
            {
                \"src\": \"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%232196F3'/%3E%3Ccircle cx='50' cy='35' r='12' fill='white'/%3E%3Cpath d='M50,55 C65,55 70,70 70,70 L30,70 C30,70 35,55 50,55 Z' fill='white'/%3E%3Cpath d='M35,75 L65,75 L65,85 C65,90 60,95 50,95 C40,95 35,90 35,85 Z' fill='white'/%3E%3C/svg%3E\",
                \"sizes\": \"192x192\",
                \"type\": \"image/svg+xml\"
            },
            {
                \"src\": \"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%232196F3'/%3E%3Ccircle cx='50' cy='35' r='12' fill='white'/%3E%3Cpath d='M50,55 C65,55 70,70 70,70 L30,70 C30,70 35,55 50,55 Z' fill='white'/%3E%3Cpath d='M35,75 L65,75 L65,85 C65,90 60,95 50,95 C40,95 35,90 35,85 Z' fill='white'/%3E%3C/svg%3E\",
                \"sizes\": \"512x512\",
                \"type\": \"image/svg+xml\"
            }
        ]
    }">
    
    <title>Duty Manager</title>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    
    <!-- SHA-256 Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js"></script>
    
    <style>
        :root {
            --primary-color: #2196F3;
            --primary-dark: #1976D2;
            --primary-light: #E3F2FD;
            --secondary-color: #4CAF50;
            --secondary-dark: #388E3C;
            --danger-color: #F44336;
            --warning-color: #FF9800;
            --info-color: #2196F3;
            --success-color: #4CAF50;
            --text-primary: #212121;
            --text-secondary: #757575;
            --background-color: #F5F7FA;
            --card-background: #FFFFFF;
            --border-color: #E0E0E0;
            --shadow-color: rgba(0,0,0,0.1);
            --sidebar-width: 280px;
            --header-height: 60px;
            --bottom-nav-height: 56px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--background-color);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* Loading Overlay */
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }

        #loadingOverlay.active {
            display: flex;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--primary-light);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast Container */
        #toastContainer {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 400px;
        }

        .toast {
            background: var(--card-background);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 4px 20px var(--shadow-color);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInRight 0.3s ease;
            border-left: 4px solid var(--primary-color);
            max-width: 100%;
        }

        .toast.success {
            border-left-color: var(--success-color);
        }

        .toast.error {
            border-left-color: var(--danger-color);
        }

        .toast.warning {
            border-left-color: var(--warning-color);
        }

        .toast.info {
            border-left-color: var(--info-color);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Login Container */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-card {
            background: var(--card-background);
            border-radius: 20px;
            padding: 40px 30px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            text-align: center;
        }

        .app-logo {
            width: 80px;
            height: 80px;
            background: var(--primary-color);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            color: white;
            font-size: 36px;
        }

        .app-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .app-subtitle {
            color: var(--text-secondary);
            margin-bottom: 32px;
            font-size: 16px;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-weight: 500;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s;
            background: var(--card-background);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .form-input.error {
            border-color: var(--danger-color);
        }

        .error-message {
            color: var(--danger-color);
            font-size: 14px;
            margin-top: 8px;
            display: none;
        }

        .btn {
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            margin-top: 8px;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        /* Dashboard Container */
        .dashboard-container {
            display: none;
            min-height: 100vh;
        }

        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--header-height);
            background: var(--card-background);
            display: flex;
            align-items: center;
            padding: 0 20px;
            box-shadow: 0 2px 10px var(--shadow-color);
            z-index: 1000;
        }

        .menu-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-primary);
            cursor: pointer;
            padding: 8px;
            margin-right: 16px;
        }

        .header-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            flex: 1;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            cursor: pointer;
        }

        /* Sidebar */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1001;
            display: none;
            backdrop-filter: blur(5px);
        }

        .sidebar-overlay.active {
            display: block;
        }

        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            width: var(--sidebar-width);
            background: var(--card-background);
            z-index: 1002;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .sidebar.active {
            transform: translateX(0);
        }

        .sidebar-header {
            padding: 30px 20px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar-user-name {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .sidebar-user-details {
            font-size: 14px;
            opacity: 0.9;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .nav-items {
            padding: 20px 0;
            flex: 1;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            color: var(--text-primary);
            text-decoration: none;
            border-left: 4px solid transparent;
            transition: all 0.3s;
        }

        .nav-item:hover {
            background: var(--primary-light);
        }

        .nav-item.active {
            background: var(--primary-light);
            color: var(--primary-color);
            border-left-color: var(--primary-color);
        }

        .nav-item-icon {
            font-size: 20px;
            width: 24px;
            text-align: center;
        }

        .nav-item-text {
            flex: 1;
            font-size: 15px;
            font-weight: 500;
        }

        .nav-item-badge {
            background: var(--danger-color);
            color: white;
            border-radius: 10px;
            padding: 2px 8px;
            font-size: 12px;
            min-width: 20px;
            text-align: center;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--bottom-nav-height);
            background: var(--card-background);
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            box-shadow: 0 -2px 10px var(--shadow-color);
            z-index: 999;
        }

        .bottom-nav-btn {
            background: none;
            border: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            padding: 8px;
            flex: 1;
            transition: all 0.3s;
        }

        .bottom-nav-btn.active {
            color: var(--primary-color);
        }

        .bottom-nav-icon {
            font-size: 20px;
        }

        /* Main Content */
        .main-content {
            padding: 20px;
            margin-top: var(--header-height);
            margin-bottom: var(--bottom-nav-height);
            min-height: calc(100vh - var(--header-height) - var(--bottom-nav-height));
        }

        .section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards */
        .card {
            background: var(--card-background);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px var(--shadow-color);
            border: 1px solid var(--border-color);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--primary-light);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Welcome Card */
        .welcome-card {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
        }

        .welcome-card .card-title {
            color: white;
            border-bottom-color: rgba(255,255,255,0.2);
        }

        .balance-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin: 20px 0;
        }

        .balance-item {
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .balance-value {
            font-size: 32px;
            font-weight: 700;
            margin: 8px 0;
        }

        .balance-label {
            font-size: 14px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 20px;
        }

        .action-btn {
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .action-btn.primary {
            background: var(--primary-color);
            color: white;
        }

        .action-btn.success {
            background: var(--success-color);
            color: white;
        }

        .action-btn.warning {
            background: var(--warning-color);
            color: white;
        }

        /* Today's Info */
        .today-info {
            display: grid;
            gap: 12px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .info-label {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .info-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Forms */
        .form-row {
            display: grid;
            gap: 16px;
            margin-bottom: 16px;
        }

        @media (min-width: 768px) {
            .form-row {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        select.form-input {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23757575' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14L2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            background-size: 12px;
            padding-right: 40px;
        }

        /* Tables */
        .table-responsive {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            margin-top: 16px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-background);
            min-width: 600px;
        }

        th {
            background: var(--primary-light);
            padding: 16px;
            text-align: left;
            font-weight: 600;
            color: var(--text-primary);
            border-bottom: 2px solid var(--border-color);
        }

        td {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        tr:last-child td {
            border-bottom: none;
        }

        /* Status Badges */
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .status-pending {
            background: #FFF3CD;
            color: #856404;
        }

        .status-approved {
            background: #D4EDDA;
            color: #155724;
        }

        .status-rejected {
            background: #F8D7DA;
            color: #721C24;
        }

        /* Roster */
        .roster-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }

        .roster-card {
            background: var(--card-background);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid var(--border-color);
        }

        .roster-date {
            font-weight: 600;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--primary-light);
        }

        .roster-staff {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .roster-staff:last-child {
            border-bottom: none;
        }

        /* Duty Time Colors */
        .duty-time {
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 12px;
        }

        .duty-0730-1530 {
            background: #FFF3CD;
            color: #856404;
        }

        .duty-0830-1630 {
            background: #E2D9F3;
            color: #563d7c;
        }

        .duty-1030-1830 {
            background: #FFFDE7;
            color: #827717;
        }

        .duty-1530-2330 {
            background: #E3F2FD;
            color: #0d47a1;
        }

        .duty-1630-0030 {
            background: #F5F5F5;
            color: #424242;
        }

        .duty-off {
            background: #D4EDDA;
            color: #155724;
        }

        /* Announcements */
        .announcement-banner {
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 16px;
            color: white;
        }

        .announcement-high {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .announcement-medium {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .announcement-low {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .empty-state-text {
            font-size: 16px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .balance-grid {
                grid-template-columns: 1fr;
            }
            
            .quick-actions {
                grid-template-columns: 1fr;
            }
            
            .roster-grid {
                grid-template-columns: 1fr;
            }
            
            .main-content {
                padding: 16px;
            }
        }

        /* PWA Install Prompt */
        .install-prompt {
            position: fixed;
            bottom: 80px;
            right: 16px;
            background: var(--card-background);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 4px 20px var(--shadow-color);
            max-width: 300px;
            animation: slideInUp 0.3s ease;
            border: 2px solid var(--primary-color);
            z-index: 1001;
        }

        .install-prompt.hidden {
            display: none;
        }

        @keyframes slideInUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Network Status */
        .network-status {
            position: fixed;
            top: 80px;
            right: 16px;
            background: var(--danger-color);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            display: none;
            align-items: center;
            gap: 8px;
            z-index: 1001;
        }

        .network-status.online {
            background: var(--success-color);
            display: flex;
        }

        .network-status.offline {
            background: var(--danger-color);
            display: flex;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay">
        <div class="spinner"></div>
        <div id="loadingText">Loading...</div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer"></div>

    <!-- Login Container -->
    <div class="login-container" id="loginContainer">
        <div class="login-card">
            <div class="app-logo">üìã</div>
            <h1 class="app-title">Duty Manager</h1>
            <p class="app-subtitle">Staff Duty & Leave Management</p>
            
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label" for="username">Username</label>
                    <input type="text" id="username" class="form-input" placeholder="Enter your username" required>
                    <div class="error-message" id="usernameError"></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="password">Password</label>
                    <input type="password" id="password" class="form-input" placeholder="Enter your password" required>
                    <div class="error-message" id="passwordError"></div>
                </div>
                
                <button type="submit" class="btn btn-primary" id="loginBtn">
                    <span>üîê</span> Sign In
                </button>
            </form>
        </div>
    </div>

    <!-- Dashboard Container -->
    <div class="dashboard-container" id="dashboardContainer">
        <!-- Header -->
        <div class="header">
            <button class="menu-btn" id="menuBtn">‚ò∞</button>
            <div class="header-title" id="headerTitle">Dashboard</div>
            <div class="user-avatar" id="userAvatar">U</div>
        </div>

        <!-- Sidebar Overlay -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-user-name" id="sidebarUserName">John Doe</div>
                <div class="sidebar-user-details">
                    <span>RC No: <span id="sidebarUserRC">001</span></span>
                    <span>Level: <span id="sidebarUserLevel">Staff</span></span>
                </div>
            </div>
            
            <div class="nav-items">
                <a href="#" class="nav-item active" data-section="home">
                    <span class="nav-item-icon">üè†</span>
                    <span class="nav-item-text">Dashboard</span>
                </a>
                <a href="#" class="nav-item" data-section="dutyChange">
                    <span class="nav-item-icon">üîÑ</span>
                    <span class="nav-item-text">Duty Change</span>
                </a>
                <a href="#" class="nav-item" data-section="leaveApplication">
                    <span class="nav-item-icon">üìÖ</span>
                    <span class="nav-item-text">Apply Leave</span>
                </a>
                <a href="#" class="nav-item" data-section="myRequests">
                    <span class="nav-item-icon">üìã</span>
                    <span class="nav-item-text">My Requests</span>
                    <span class="nav-item-badge" id="myRequestsBadge" style="display: none;">0</span>
                </a>
                <a href="#" class="nav-item" data-section="pendingRequests" id="pendingRequestsItem" style="display: none;">
                    <span class="nav-item-icon">‚è≥</span>
                    <span class="nav-item-text">Pending</span>
                    <span class="nav-item-badge" id="pendingRequestsBadge">0</span>
                </a>
                <a href="#" class="nav-item" data-section="viewAllRoster">
                    <span class="nav-item-icon">üë•</span>
                    <span class="nav-item-text">All Roster</span>
                </a>
                
                <!-- Admin Sections -->
                <a href="#" class="nav-item admin-nav" data-section="adminAnnouncements" style="display: none;">
                    <span class="nav-item-icon">üì¢</span>
                    <span class="nav-item-text">Announcements</span>
                </a>
                <a href="#" class="nav-item admin-nav" data-section="adminDutyRoster" style="display: none;">
                    <span class="nav-item-icon">üìù</span>
                    <span class="nav-item-text">Duty Roster</span>
                </a>
                <a href="#" class="nav-item admin-nav" data-section="adminLeaveBalance" style="display: none;">
                    <span class="nav-item-icon">üí∞</span>
                    <span class="nav-item-text">Leave Balance</span>
                </a>
            </div>
            
            <div style="padding: 20px; border-top: 1px solid var(--border-color);">
                <button class="btn btn-primary" id="logoutBtn" style="background: var(--danger-color);">
                    <span>üö™</span> Logout
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content" id="mainContent">
            <!-- Dashboard Section -->
            <div class="section active" id="homeSection">
                <div id="announcementsContainer"></div>
                
                <div class="card welcome-card">
                    <div class="card-header">
                        <div class="card-title">Welcome, <span id="welcomeName">User</span>!</div>
                    </div>
                    
                    <div class="balance-grid">
                        <div class="balance-item">
                            <div class="balance-label">Sick Leave</div>
                            <div class="balance-value" id="slBalance">12.0</div>
                        </div>
                        <div class="balance-item">
                            <div class="balance-label">FRL</div>
                            <div class="balance-value" id="frlBalance">6.0</div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Today's Info</div>
                    </div>
                    <div class="today-info">
                        <div class="info-item">
                            <span class="info-label">Current Duty:</span>
                            <span class="info-value" id="todayDuty">07:30 - 15:30</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Next Duty:</span>
                            <span class="info-value" id="nextDuty">Tomorrow 08:30 - 16:30</span>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Quick Actions</div>
                    </div>
                    <div class="quick-actions">
                        <button class="action-btn warning" onclick="showSection('dutyChange')">
                            <span>üîÑ</span> Change Duty
                        </button>
                        <button class="action-btn success" onclick="showSection('leaveApplication')">
                            <span>üìÖ</span> Apply Leave
                        </button>
                        <button class="action-btn primary" onclick="showSection('myRequests')">
                            <span>üìã</span> My Requests
                        </button>
                        <button class="action-btn primary" onclick="showSection('viewAllRoster')">
                            <span>üë•</span> View Roster
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Duty Change Section -->
            <div class="section" id="dutyChangeSection">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Request Duty Change</div>
                    </div>
                    
                    <div class="alert alert-warning" style="background: #FFF3CD; color: #856404; padding: 12px; border-radius: 8px; margin-bottom: 20px;">
                        <strong>Note:</strong> Requests must be made at least 24 hours in advance.
                    </div>
                    
                    <form id="dutyChangeForm">
                        <div class="form-group">
                            <label class="form-label" for="changeDate">Change Date</label>
                            <input type="date" id="changeDate" class="form-input" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="changeDutyTime">Your Duty Time</label>
                            <select id="changeDutyTime" class="form-input" required>
                                <option value="">Select duty time</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="requestToStaff">Swap With Staff</label>
                            <select id="requestToStaff" class="form-input" required>
                                <option value="">Select staff member</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="requestToDutyTime">Their Duty Time</label>
                            <select id="requestToDutyTime" class="form-input" required>
                                <option value="">Select duty time</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="changeReason">Reason (Optional)</label>
                            <textarea id="changeReason" class="form-input" rows="3" placeholder="Brief reason for duty change"></textarea>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 24px;">
                            <button type="button" class="btn" onclick="showSection('home')" style="background: var(--border-color); color: var(--text-primary);">
                                Cancel
                            </button>
                            <button type="submit" class="btn btn-primary">
                                Submit Request
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Leave Application Section -->
            <div class="section" id="leaveApplicationSection">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Apply for Leave</div>
                    </div>
                    
                    <div class="alert alert-info" style="background: var(--primary-light); color: var(--primary-dark); padding: 12px; border-radius: 8px; margin-bottom: 20px;">
                        <strong>Application Rules:</strong>
                        <div style="margin-top: 8px; font-size: 14px;">
                            <div>‚Ä¢ Sick Leave: Minimum 2 hours before duty time</div>
                            <div>‚Ä¢ FRL: Minimum 1 hour before duty time</div>
                            <div>‚Ä¢ Leave balance will be deducted immediately</div>
                        </div>
                    </div>
                    
                    <form id="leaveApplicationForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="leaveType">Leave Type</label>
                                <select id="leaveType" class="form-input" required>
                                    <option value="">Select type</option>
                                    <option value="Sick Leave">Sick Leave</option>
                                    <option value="FRL">FRL</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="leaveDate">Leave Date</label>
                                <input type="date" id="leaveDate" class="form-input" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="leaveDutyTime">Duty Time</label>
                                <select id="leaveDutyTime" class="form-input" required>
                                    <option value="">Select duty time</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="leaveDuration">Duration</label>
                                <select id="leaveDuration" class="form-input" required>
                                    <option value="0.5">Half Day</option>
                                    <option value="1" selected>1 Day</option>
                                    <option value="2">2 Days</option>
                                    <option value="3">3 Days</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="leaveReason">Reason</label>
                            <textarea id="leaveReason" class="form-input" rows="4" placeholder="Please provide reason for leave" required></textarea>
                        </div>
                        
                        <div id="leaveRulesAlert" class="alert alert-warning" style="margin-top: 20px; display: none;"></div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 24px;">
                            <button type="button" class="btn" onclick="showSection('home')" style="background: var(--border-color); color: var(--text-primary);">
                                Cancel
                            </button>
                            <button type="submit" class="btn btn-success">
                                Submit Application
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- My Requests Section -->
            <div class="section" id="myRequestsSection">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">My Requests</div>
                    </div>
                    
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Date</th>
                                    <th>Details</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="myRequestsTable">
                                <!-- Filled by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="empty-state" id="myRequestsEmpty" style="display: none;">
                        <div class="empty-state-icon">üìã</div>
                        <div class="empty-state-text">No requests found</div>
                    </div>
                </div>
            </div>
            
            <!-- Pending Requests Section -->
            <div class="section" id="pendingRequestsSection">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Pending Requests</div>
                    </div>
                    
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>From</th>
                                    <th>Date</th>
                                    <th>Details</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="pendingRequestsTable">
                                <!-- Filled by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="empty-state" id="pendingRequestsEmpty" style="display: none;">
                        <div class="empty-state-icon">‚è≥</div>
                        <div class="empty-state-text">No pending requests</div>
                    </div>
                </div>
            </div>
            
            <!-- All Roster Section -->
            <div class="section" id="viewAllRosterSection">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Complete Roster</div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="rosterStartDate">From Date</label>
                            <input type="date" id="rosterStartDate" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="rosterEndDate">To Date</label>
                            <input type="date" id="rosterEndDate" class="form-input">
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="loadRoster()" style="margin-top: 16px; width: 100%;">
                        Load Roster
                    </button>
                    
                    <div id="rosterContainer" style="margin-top: 24px;"></div>
                </div>
            </div>
            
            <!-- Admin Announcements Section -->
            <div class="section" id="adminAnnouncementsSection">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Create Announcement</div>
                    </div>
                    
                    <form id="announcementForm">
                        <div class="form-group">
                            <label class="form-label" for="announcementTitle">Title</label>
                            <input type="text" id="announcementTitle" class="form-input" placeholder="Enter announcement title" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="announcementContent">Content</label>
                            <textarea id="announcementContent" class="form-input" rows="4" placeholder="Enter announcement content" required></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="announcementPriority">Priority</label>
                            <select id="announcementPriority" class="form-input">
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>
                        
                        <button type="submit" class="btn btn-primary" style="margin-top: 16px; width: 100%;">
                            Create Announcement
                        </button>
                    </form>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Active Announcements</div>
                    </div>
                    <div id="activeAnnouncements"></div>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <button class="bottom-nav-btn active" onclick="showSection('home')">
                <span class="bottom-nav-icon">üè†</span>
                <span>Home</span>
            </button>
            <button class="bottom-nav-btn" onclick="showSection('dutyChange')">
                <span class="bottom-nav-icon">üîÑ</span>
                <span>Change</span>
            </button>
            <button class="bottom-nav-btn" onclick="showSection('leaveApplication')">
                <span class="bottom-nav-icon">üìÖ</span>
                <span>Leave</span>
            </button>
            <button class="bottom-nav-btn" onclick="showSection('myRequests')">
                <span class="bottom-nav-icon">üìã</span>
                <span>Requests</span>
            </button>
            <button class="bottom-nav-btn" onclick="showSection('viewAllRoster')">
                <span class="bottom-nav-icon">üë•</span>
                <span>Roster</span>
            </button>
        </div>
    </div>

    <!-- PWA Install Prompt -->
    <div class="install-prompt hidden" id="installPrompt">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
            <div style="width: 40px; height: 40px; background: var(--primary-color); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px;">üì±</div>
            <div>
                <div style="font-weight: 600; font-size: 14px;">Install Duty Manager</div>
                <div style="font-size: 12px; color: var(--text-secondary);">Quick access on your home screen</div>
            </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
            <button class="btn" id="installLaterBtn" style="background: var(--border-color); color: var(--text-primary); font-size: 14px; padding: 8px;">Later</button>
            <button class="btn btn-primary" id="installNowBtn" style="font-size: 14px; padding: 8px;">Install</button>
        </div>
    </div>

    <!-- Network Status -->
    <div class="network-status" id="networkStatus">
        <span id="networkIcon">üåê</span>
        <span id="networkText">Offline</span>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let allUsers = [];
        let dutyRoster = {};
        let leaveBalances = {};
        let allRequests = [];
        let announcements = [];
        let deferredPrompt = null;
        let isOnline = navigator.onLine;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
            setupNetworkListener();
            setupInstallPrompt();
            checkSession();
        });

        function initApp() {
            // Setup login form
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }

            // Setup navigation
            setupNavigation();

            // Setup form listeners
            setupFormListeners();

            // Set minimum dates
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('changeDate').min = today;
            document.getElementById('leaveDate').min = today;
            document.getElementById('rosterStartDate').value = today;
            
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 7);
            document.getElementById('rosterEndDate').value = tomorrow.toISOString().split('T')[0];
        }

        function setupNavigation() {
            // Mobile menu
            const menuBtn = document.getElementById('menuBtn');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');

            menuBtn.addEventListener('click', () => {
                sidebar.classList.add('active');
                sidebarOverlay.classList.add('active');
            });

            sidebarOverlay.addEventListener('click', () => {
                sidebar.classList.remove('active');
                sidebarOverlay.classList.remove('active');
            });

            // Nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const section = item.dataset.section;
                    showSection(section);
                    sidebar.classList.remove('active');
                    sidebarOverlay.classList.remove('active');
                });
            });

            // Bottom nav
            document.querySelectorAll('.bottom-nav-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.bottom-nav-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                });
            });

            // Logout
            document.getElementById('logoutBtn').addEventListener('click', () => {
                if (confirm('Are you sure you want to logout?')) {
                    localStorage.removeItem('dutySystemSession');
                    location.reload();
                }
            });
        }

        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });

            // Show selected section
            const targetSection = document.getElementById(sectionId + 'Section');
            if (targetSection) {
                targetSection.classList.add('active');
            }

            // Update header title
            const titles = {
                home: 'Dashboard',
                dutyChange: 'Duty Change',
                leaveApplication: 'Apply Leave',
                myRequests: 'My Requests',
                pendingRequests: 'Pending Requests',
                viewAllRoster: 'All Roster',
                adminAnnouncements: 'Announcements',
                adminDutyRoster: 'Duty Roster',
                adminLeaveBalance: 'Leave Balance'
            };
            document.getElementById('headerTitle').textContent = titles[sectionId] || sectionId;

            // Update active nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.section === sectionId) {
                    item.classList.add('active');
                }
            });

            // Load section data
            loadSectionData(sectionId);
        }

        function loadSectionData(sectionId) {
            switch(sectionId) {
                case 'home':
                    loadDashboard();
                    break;
                case 'dutyChange':
                    loadDutyChangeForm();
                    break;
                case 'leaveApplication':
                    loadLeaveForm();
                    break;
                case 'myRequests':
                    loadMyRequests();
                    break;
                case 'pendingRequests':
                    loadPendingRequests();
                    break;
                case 'viewAllRoster':
                    loadRoster();
                    break;
                case 'adminAnnouncements':
                    loadAdminAnnouncements();
                    break;
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            showLoading(true, 'Signing in...');

            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();

            // Clear previous errors
            document.getElementById('usernameError').style.display = 'none';
            document.getElementById('passwordError').style.display = 'none';

            // Validate input
            if (!username) {
                showError('usernameError', 'Please enter username');
                showLoading(false);
                return;
            }

            if (!password) {
                showError('passwordError', 'Please enter password');
                showLoading(false);
                return;
            }

            // Check credentials (simulate with hardcoded data for demo)
            // In production, this would be server-side authentication
            if (username === 'admin' && password === 'admin123') {
                // Simulate successful login
                const user = {
                    username: 'admin',
                    name: 'Admin User',
                    rcNo: '001',
                    level: 'Supervisor',
                    expiry: Date.now() + (8 * 60 * 60 * 1000) // 8 hours
                };
                localStorage.setItem('dutySystemSession', JSON.stringify(user));
                await loginUser(user);
            } else if (username === 'staff' && password === 'staff123') {
                const user = {
                    username: 'staff',
                    name: 'Staff User',
                    rcNo: '002',
                    level: 'User',
                    expiry: Date.now() + (8 * 60 * 60 * 1000)
                };
                localStorage.setItem('dutySystemSession', JSON.stringify(user));
                await loginUser(user);
            } else {
                showError('passwordError', 'Invalid username or password');
                showLoading(false);
            }
        }

        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.style.display = 'block';
        }

        async function loginUser(userData) {
            currentUser = userData;
            showLoading(true, 'Loading dashboard...');

            // Update UI
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('dashboardContainer').style.display = 'block';

            // Update user info
            document.getElementById('userAvatar').textContent = userData.name.charAt(0);
            document.getElementById('sidebarUserName').textContent = userData.name;
            document.getElementById('sidebarUserRC').textContent = userData.rcNo;
            document.getElementById('sidebarUserLevel').textContent = userData.level;
            document.getElementById('welcomeName').textContent = userData.name;

            // Show/hide admin sections
            const isAdmin = userData.level === 'Supervisor';
            document.querySelectorAll('.admin-nav').forEach(el => {
                el.style.display = isAdmin ? 'flex' : 'none';
            });
            
            // Show/hide pending requests
            const pendingItem = document.getElementById('pendingRequestsItem');
            if (isAdmin) {
                pendingItem.style.display = 'flex';
            }

            // Initialize data
            await initializeData();

            showLoading(false);
            showToast(`Welcome back, ${userData.name}!`, 'success');
        }

        async function initializeData() {
            try {
                // Load initial data
                await loadSampleData();
                
                // Update UI
                updateDashboard();
                updateRequestCounts();
                
            } catch (error) {
                console.error('Error initializing data:', error);
                showToast('Failed to load data', 'error');
            }
        }

        async function loadSampleData() {
            // Sample user data
            allUsers = [
                { username: 'admin', name: 'Admin User', RCNo: '001', Level: 'Supervisor' },
                { username: 'staff1', name: 'John Smith', RCNo: '002', Level: 'User' },
                { username: 'staff2', name: 'Jane Doe', RCNo: '003', Level: 'User' },
                { username: 'staff3', name: 'Bob Johnson', RCNo: '004', Level: 'User' }
            ];

            // Sample duty roster
            const today = new Date();
            dutyRoster = {};
            for (let i = 0; i < 7; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                const dateStr = date.toISOString().split('T')[0];
                
                dutyRoster[dateStr] = {
                    'staff1': ['07:30-15:30', '08:30-16:30', 'Off'][i % 3],
                    'staff2': ['08:30-16:30', 'Off', '07:30-15:30'][i % 3],
                    'staff3': ['Off', '07:30-15:30', '08:30-16:30'][i % 3]
                };
            }

            // Sample leave balances
            leaveBalances = {
                'staff1': { SL: 12, FRL: 6 },
                'staff2': { SL: 10, FRL: 5 },
                'staff3': { SL: 8, FRL: 4 }
            };

            // Sample requests
            allRequests = [
                {
                    id: '1',
                    type: 'dutyChange',
                    fromUsername: 'staff2',
                    fromName: 'Jane Doe',
                    date: new Date(today.getTime() + 86400000).toISOString().split('T')[0],
                    dutyTime: '08:30-16:30',
                    toUsername: 'staff1',
                    toName: 'John Smith',
                    toDutyTime: '07:30-15:30',
                    status: 'pending',
                    timestamp: new Date().toISOString()
                }
            ];

            // Sample announcements
            announcements = [
                {
                    id: '1',
                    title: 'System Maintenance',
                    content: 'The system will be down for maintenance on Saturday from 2 AM to 4 AM.',
                    priority: 'high',
                    createdAt: new Date().toISOString()
                }
            ];
        }

        function updateDashboard() {
            const today = new Date().toISOString().split('T')[0];
            
            // Update leave balances
            if (currentUser && leaveBalances[currentUser.username]) {
                document.getElementById('slBalance').textContent = leaveBalances[currentUser.username].SL;
                document.getElementById('frlBalance').textContent = leaveBalances[currentUser.username].FRL;
            }

            // Update today's duty
            if (dutyRoster[today] && dutyRoster[today][currentUser.username]) {
                const duty = dutyRoster[today][currentUser.username];
                document.getElementById('todayDuty').textContent = duty === 'Off' ? 'Off Day' : duty;
            }

            // Load announcements
            loadAnnouncements();
        }

        function loadAnnouncements() {
            const container = document.getElementById('announcementsContainer');
            container.innerHTML = '';

            announcements.forEach(ann => {
                const banner = document.createElement('div');
                banner.className = `announcement-banner announcement-${ann.priority}`;
                banner.innerHTML = `
                    <div style="font-weight: 600; margin-bottom: 8px;">${ann.title}</div>
                    <div style="font-size: 14px; opacity: 0.9;">${ann.content}</div>
                `;
                container.appendChild(banner);
            });
        }

        function loadDutyChangeForm() {
            const dateInput = document.getElementById('changeDate');
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            dateInput.value = tomorrow.toISOString().split('T')[0];
            dateInput.min = tomorrow.toISOString().split('T')[0];

            // Populate staff dropdown
            const staffSelect = document.getElementById('requestToStaff');
            staffSelect.innerHTML = '<option value="">Select staff member</option>';
            allUsers.forEach(user => {
                if (user.username !== currentUser.username && user.Level === 'User') {
                    const option = document.createElement('option');
                    option.value = user.username;
                    option.textContent = `${user.name} (RC: ${user.RCNo})`;
                    staffSelect.appendChild(option);
                }
            });
        }

        function loadLeaveForm() {
            const dateInput = document.getElementById('leaveDate');
            const today = new Date();
            dateInput.value = today.toISOString().split('T')[0];
            dateInput.min = today.toISOString().split('T')[0];
        }

        function loadMyRequests() {
            const tbody = document.getElementById('myRequestsTable');
            const emptyState = document.getElementById('myRequestsEmpty');
            
            const myReqs = allRequests.filter(req => req.fromUsername === currentUser.username);
            
            if (myReqs.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            tbody.innerHTML = '';
            
            myReqs.forEach(req => {
                const tr = document.createElement('tr');
                let details = '';
                
                if (req.type === 'dutyChange') {
                    details = `Swap with ${req.toName} (${req.toDutyTime})`;
                }
                
                let statusClass = '';
                switch(req.status) {
                    case 'pending': statusClass = 'status-pending'; break;
                    case 'approved': statusClass = 'status-approved'; break;
                    case 'rejected': statusClass = 'status-rejected'; break;
                }
                
                tr.innerHTML = `
                    <td>${req.type === 'dutyChange' ? 'Duty Change' : 'Leave'}</td>
                    <td>${new Date(req.date).toLocaleDateString()}</td>
                    <td>${details}</td>
                    <td><span class="status-badge ${statusClass}">${req.status}</span></td>
                    <td>
                        ${req.status === 'pending' ? 
                            `<button class="action-btn" style="background: var(--danger-color); color: white; padding: 4px 12px; border-radius: 4px; border: none; font-size: 12px;" onclick="cancelRequest('${req.id}')">Cancel</button>` : 
                            ''}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function loadPendingRequests() {
            const tbody = document.getElementById('pendingRequestsTable');
            const emptyState = document.getElementById('pendingRequestsEmpty');
            
            const pendingReqs = allRequests.filter(req => 
                req.status === 'pending' && 
                req.type === 'dutyChange' && 
                req.toUsername === currentUser.username
            );
            
            if (pendingReqs.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            tbody.innerHTML = '';
            
            pendingReqs.forEach(req => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${req.fromName}</td>
                    <td>${new Date(req.date).toLocaleDateString()}</td>
                    <td>Swap ${req.dutyTime} with ${req.toDutyTime}</td>
                    <td>
                        <div style="display: flex; gap: 8px;">
                            <button class="action-btn" style="background: var(--success-color); color: white; padding: 4px 12px; border-radius: 4px; border: none; font-size: 12px;" 
                                    onclick="respondToRequest('${req.id}', 'approved')">Accept</button>
                            <button class="action-btn" style="background: var(--danger-color); color: white; padding: 4px 12px; border-radius: 4px; border: none; font-size: 12px;" 
                                    onclick="respondToRequest('${req.id}', 'rejected')">Reject</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateRequestCounts() {
            // My pending requests
            const myPending = allRequests.filter(req => 
                req.fromUsername === currentUser.username && 
                req.status === 'pending'
            ).length;
            
            const myBadge = document.getElementById('myRequestsBadge');
            if (myPending > 0) {
                myBadge.textContent = myPending;
                myBadge.style.display = 'inline-block';
            } else {
                myBadge.style.display = 'none';
            }
            
            // Pending requests for me
            const pendingForMe = allRequests.filter(req => 
                req.status === 'pending' && 
                req.type === 'dutyChange' && 
                req.toUsername === currentUser.username
            ).length;
            
            const pendingBadge = document.getElementById('pendingRequestsBadge');
            if (pendingForMe > 0) {
                pendingBadge.textContent = pendingForMe;
                pendingBadge.style.display = 'inline-block';
            } else {
                pendingBadge.style.display = 'none';
            }
        }

        function loadRoster() {
            const container = document.getElementById('rosterContainer');
            const startDate = document.getElementById('rosterStartDate').value;
            const endDate = document.getElementById('rosterEndDate').value;
            
            if (!startDate || !endDate) {
                showToast('Please select date range', 'warning');
                return;
            }
            
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            let html = '<div class="roster-grid">';
            
            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                const dateStr = d.toISOString().split('T')[0];
                const dayName = d.toLocaleDateString('en-US', { weekday: 'short' });
                const dateFormatted = d.toLocaleDateString('en-US', { day: 'numeric', month: 'short' });
                
                html += `
                    <div class="roster-card">
                        <div class="roster-date">${dayName}, ${dateFormatted}</div>
                `;
                
                allUsers.forEach(user => {
                    if (user.Level === 'User') {
                        let duty = 'Off';
                        let dutyClass = 'duty-off';
                        
                        if (dutyRoster[dateStr] && dutyRoster[dateStr][user.username]) {
                            duty = dutyRoster[dateStr][user.username];
                            if (duty !== 'Off') {
                                dutyClass = `duty-${duty.replace(':', '').replace('-', '')}`;
                            }
                        }
                        
                        html += `
                            <div class="roster-staff">
                                <div>${user.name}</div>
                                <div><span class="duty-time ${dutyClass}">${duty}</span></div>
                            </div>
                        `;
                    }
                });
                
                html += '</div>';
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        function loadAdminAnnouncements() {
            const container = document.getElementById('activeAnnouncements');
            container.innerHTML = '';
            
            announcements.forEach(ann => {
                const div = document.createElement('div');
                div.className = `announcement-banner announcement-${ann.priority}`;
                div.style.marginBottom = '12px';
                div.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; margin-bottom: 4px;">${ann.title}</div>
                            <div style="font-size: 14px; opacity: 0.9;">${ann.content}</div>
                        </div>
                        <button onclick="deleteAnnouncement('${ann.id}')" style="background: none; border: none; color: white; cursor: pointer; padding: 4px;">‚úï</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // Form handling
        function setupFormListeners() {
            // Duty change form
            const dutyChangeForm = document.getElementById('dutyChangeForm');
            if (dutyChangeForm) {
                dutyChangeForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await submitDutyChange();
                });
            }

            // Leave application form
            const leaveForm = document.getElementById('leaveApplicationForm');
            if (leaveForm) {
                leaveForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await submitLeaveApplication();
                });

                // Real-time validation
                document.getElementById('leaveType').addEventListener('change', validateLeave);
                document.getElementById('leaveDate').addEventListener('change', validateLeave);
                document.getElementById('leaveDutyTime').addEventListener('change', validateLeave);
            }

            // Announcement form
            const announcementForm = document.getElementById('announcementForm');
            if (announcementForm) {
                announcementForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await createAnnouncement();
                });
            }

            // Staff selection
            document.getElementById('requestToStaff').addEventListener('change', function() {
                const selectedUser = allUsers.find(u => u.username === this.value);
                if (selectedUser) {
                    // In a real app, load their duty time for the selected date
                }
            });
        }

        async function submitDutyChange() {
            const date = document.getElementById('changeDate').value;
            const toStaff = document.getElementById('requestToStaff').value;
            
            if (!date || !toStaff) {
                showToast('Please fill all required fields', 'warning');
                return;
            }

            showLoading(true, 'Submitting request...');

            // Simulate API call
            await new Promise(resolve => setTimeout(resolve, 1000));

            const newRequest = {
                id: 'req_' + Date.now(),
                type: 'dutyChange',
                fromUsername: currentUser.username,
                fromName: currentUser.name,
                date: date,
                dutyTime: '07:30-15:30', // This should come from form
                toUsername: toStaff,
                toName: allUsers.find(u => u.username === toStaff)?.name || '',
                toDutyTime: '08:30-16:30', // This should come from form
                status: 'pending',
                timestamp: new Date().toISOString()
            };

            allRequests.push(newRequest);
            updateRequestCounts();
            
            showLoading(false);
            showToast('Duty change request submitted!', 'success');
            showSection('home');
            document.getElementById('dutyChangeForm').reset();
        }

        async function submitLeaveApplication() {
            const leaveType = document.getElementById('leaveType').value;
            const date = document.getElementById('leaveDate').value;
            const duration = document.getElementById('leaveDuration').value;
            const reason = document.getElementById('leaveReason').value;

            if (!leaveType || !date || !duration || !reason) {
                showToast('Please fill all required fields', 'warning');
                return;
            }

            showLoading(true, 'Processing leave application...');

            // Check balance
            if (leaveBalances[currentUser.username]) {
                if (leaveType === 'Sick Leave' && leaveBalances[currentUser.username].SL < parseFloat(duration)) {
                    showToast('Insufficient Sick Leave balance', 'error');
                    showLoading(false);
                    return;
                }
                if (leaveType === 'FRL' && leaveBalances[currentUser.username].FRL < parseFloat(duration)) {
                    showToast('Insufficient FRL balance', 'error');
                    showLoading(false);
                    return;
                }
            }

            // Simulate API call
            await new Promise(resolve => setTimeout(resolve, 1000));

            // Deduct from balance
            if (leaveBalances[currentUser.username]) {
                if (leaveType === 'Sick Leave') {
                    leaveBalances[currentUser.username].SL -= parseFloat(duration);
                } else {
                    leaveBalances[currentUser.username].FRL -= parseFloat(duration);
                }
            }

            const newRequest = {
                id: 'leave_' + Date.now(),
                type: 'leave',
                leaveType: leaveType,
                fromUsername: currentUser.username,
                fromName: currentUser.name,
                date: date,
                duration: parseFloat(duration),
                reason: reason,
                status: 'approved', // Auto-approved for demo
                timestamp: new Date().toISOString(),
                approvedBy: 'System'
            };

            allRequests.push(newRequest);
            updateRequestCounts();
            
            showLoading(false);
            showToast(`${leaveType} application submitted successfully!`, 'success');
            updateDashboard();
            showSection('home');
            document.getElementById('leaveApplicationForm').reset();
        }

        function validateLeave() {
            const type = document.getElementById('leaveType').value;
            const date = document.getElementById('leaveDate').value;
            const dutyTime = document.getElementById('leaveDutyTime').value;
            const alertDiv = document.getElementById('leaveRulesAlert');

            if (!type || !date || !dutyTime) {
                alertDiv.style.display = 'none';
                return;
            }

            // Simple validation logic
            const now = new Date();
            const leaveDate = new Date(date);
            const hoursDiff = (leaveDate - now) / (1000 * 60 * 60);

            let message = '';
            let isValid = true;

            if (type === 'Sick Leave' && hoursDiff < 2) {
                message = '‚ö†Ô∏è Sick Leave requires at least 2 hours notice before duty time.';
                isValid = false;
            } else if (type === 'FRL' && hoursDiff < 1) {
                message = '‚ö†Ô∏è FRL requires at least 1 hour notice before duty time.';
                isValid = false;
            } else if (hoursDiff < 0) {
                message = '‚ö†Ô∏è Cannot apply for leave in the past.';
                isValid = false;
            } else {
                message = '‚úÖ You can apply for this leave.';
            }

            alertDiv.textContent = message;
            alertDiv.style.display = 'block';
            alertDiv.style.background = isValid ? '#D4EDDA' : '#FFF3CD';
            alertDiv.style.color = isValid ? '#155724' : '#856404';
        }

        async function cancelRequest(requestId) {
            if (!confirm('Are you sure you want to cancel this request?')) return;

            const request = allRequests.find(req => req.id === requestId);
            if (request) {
                request.status = 'cancelled';
                updateRequestCounts();
                loadMyRequests();
                showToast('Request cancelled', 'success');
            }
        }

        async function respondToRequest(requestId, response) {
            const request = allRequests.find(req => req.id === requestId);
            if (request) {
                request.status = response;
                request.respondedAt = new Date().toISOString();
                updateRequestCounts();
                loadPendingRequests();
                showToast(`Request ${response}`, 'success');
            }
        }

        async function createAnnouncement() {
            const title = document.getElementById('announcementTitle').value;
            const content = document.getElementById('announcementContent').value;
            const priority = document.getElementById('announcementPriority').value;

            if (!title || !content) {
                showToast('Please fill all fields', 'warning');
                return;
            }

            const newAnnouncement = {
                id: 'ann_' + Date.now(),
                title: title,
                content: content,
                priority: priority,
                createdAt: new Date().toISOString(),
                createdBy: currentUser.name
            };

            announcements.unshift(newAnnouncement);
            document.getElementById('announcementForm').reset();
            loadAdminAnnouncements();
            showToast('Announcement created', 'success');
        }

        function deleteAnnouncement(announcementId) {
            announcements = announcements.filter(ann => ann.id !== announcementId);
            loadAdminAnnouncements();
            showToast('Announcement deleted', 'success');
        }

        // Session management
        function checkSession() {
            const session = localStorage.getItem('dutySystemSession');
            if (session) {
                try {
                    const user = JSON.parse(session);
                    if (user.expiry > Date.now()) {
                        loginUser(user);
                    } else {
                        localStorage.removeItem('dutySystemSession');
                    }
                } catch (e) {
                    localStorage.removeItem('dutySystemSession');
                }
            }
        }

        // Utility functions
        function showLoading(show, text = 'Loading...') {
            const overlay = document.getElementById('loadingOverlay');
            const textEl = document.getElementById('loadingText');
            
            if (overlay) {
                if (show) {
                    overlay.classList.add('active');
                    if (textEl) textEl.textContent = text;
                } else {
                    overlay.classList.remove('active');
                }
            }
        }

        function showToast(message, type = 'info', duration = 3000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span style="font-size: 20px;">
                    ${type === 'success' ? '‚úÖ' : 
                      type === 'error' ? '‚ùå' : 
                      type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}
                </span>
                <span>${message}</span>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // PWA features
        function setupInstallPrompt() {
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                
                // Show install prompt after 10 seconds
                setTimeout(() => {
                    if (deferredPrompt && !localStorage.getItem('installPromptShown')) {
                        showInstallPrompt();
                    }
                }, 10000);
            });

            window.addEventListener('appinstalled', () => {
                deferredPrompt = null;
                localStorage.setItem('installPromptShown', 'true');
                document.getElementById('installPrompt').classList.add('hidden');
                showToast('App installed successfully!', 'success');
            });

            // Install prompt buttons
            document.getElementById('installNowBtn').addEventListener('click', async () => {
                if (!deferredPrompt) return;
                
                const prompt = document.getElementById('installPrompt');
                prompt.style.animation = 'slideInUp 0.3s ease reverse';
                setTimeout(() => prompt.classList.add('hidden'), 300);
                
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`User response: ${outcome}`);
                deferredPrompt = null;
                localStorage.setItem('installPromptShown', 'true');
            });

            document.getElementById('installLaterBtn').addEventListener('click', () => {
                const prompt = document.getElementById('installPrompt');
                prompt.style.animation = 'slideInUp 0.3s ease reverse';
                setTimeout(() => prompt.classList.add('hidden'), 300);
                localStorage.setItem('installPromptShown', 'true');
            });
        }

        function showInstallPrompt() {
            if (deferredPrompt && !localStorage.getItem('installPromptShown')) {
                const prompt = document.getElementById('installPrompt');
                prompt.classList.remove('hidden');
                prompt.style.animation = 'slideInUp 0.3s ease';
            }
        }

        function setupNetworkListener() {
            const networkStatus = document.getElementById('networkStatus');
            const networkIcon = document.getElementById('networkIcon');
            const networkText = document.getElementById('networkText');

            function updateNetworkStatus() {
                isOnline = navigator.onLine;
                
                if (isOnline) {
                    networkStatus.classList.remove('offline');
                    networkStatus.classList.add('online');
                    networkIcon.textContent = '‚úÖ';
                    networkText.textContent = 'Online';
                    
                    // Hide after 3 seconds when online
                    setTimeout(() => {
                        networkStatus.style.display = 'none';
                    }, 3000);
                } else {
                    networkStatus.classList.remove('online');
                    networkStatus.classList.add('offline');
                    networkIcon.textContent = '‚ö†Ô∏è';
                    networkText.textContent = 'Offline';
                    networkStatus.style.display = 'flex';
                }
            }

            window.addEventListener('online', () => {
                updateNetworkStatus();
                showToast('You are back online', 'success');
            });

            window.addEventListener('offline', () => {
                updateNetworkStatus();
                showToast('You are offline. Some features may not work.', 'warning');
            });

            updateNetworkStatus();
        }

        // Add service worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').catch(err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>
</body>
</html>
