<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duty Status Board - Public View</title>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        body {
            background: #f5f7fa;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .header .current-date {
            color: #7f8c8d;
            font-size: 16px;
            font-weight: 500;
        }

        .refresh-btn {
            margin-top: 10px;
            padding: 8px 20px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .refresh-btn:hover {
            background: #2980b9;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 1024px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #e0e6ed;
        }

        .card h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card h2 .icon {
            font-size: 20px;
        }

        .card.full-width {
            grid-column: 1 / -1;
        }

        .alert {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid;
            font-size: 14px;
        }

        .alert-info {
            background: #e8f4fc;
            border-color: #3498db;
            color: #2c3e50;
        }

        .alert-success {
            background: #d4edda;
            border-color: #27ae60;
            color: #155724;
        }

        .alert-warning {
            background: #fff3cd;
            border-color: #f39c12;
            color: #856404;
        }

        .alert-danger {
            background: #f8d7da;
            border-color: #e74c3c;
            color: #721c24;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            margin-top: 15px;
            border: 1px solid #e0e6ed;
            border-radius: 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e6ed;
            font-size: 14px;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
            position: sticky;
            top: 0;
        }

        td {
            color: #2c3e50;
        }

        tr:hover {
            background: #f8f9fa;
        }

        /* Status badges */
        .status-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .status-sick {
            background: linear-gradient(135deg, #ffd8a6 0%, #ffc078 100%);
            color: #e8590c;
        }

        .status-frl {
            background: linear-gradient(135deg, #a3daff 0%, #8bcbff 100%);
            color: #0c63e4;
        }

        .status-pending {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            color: #856404;
        }

        .status-approved {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
        }

        .status-rejected {
            background: linear-gradient(135deg, #f8d7da 0%, #f1b0b7 100%);
            color: #721c24;
        }

        /* Duty change colors */
        .duty-change-item {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid;
            background: #f8f9fa;
        }

        .duty-change-approved {
            border-left-color: #27ae60;
        }

        .duty-change-pending {
            border-left-color: #f39c12;
        }

        /* Leave entry form */
        .leave-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            color: #2c3e50;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e6ed;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-control:focus {
            outline: none;
            border-color: #3498db;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #219653;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        textarea.form-control {
            min-height: 60px;
            resize: vertical;
        }

        /* Staff status board */
        .status-board {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .staff-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            border: 2px solid #e0e6ed;
            transition: all 0.3s;
        }

        .staff-card.sick {
            border-color: #ffc078;
            background: linear-gradient(135deg, #fff9f0 0%, #ffe8cc 100%);
        }

        .staff-card.frl {
            border-color: #8bcbff;
            background: linear-gradient(135deg, #f0f9ff 0%, #e1f2ff 100%);
        }

        .staff-card.on-duty {
            border-color: #81c784;
            background: linear-gradient(135deg, #f0f9f0 0%, #e2f3e2 100%);
        }

        .staff-card.off-duty {
            border-color: #a0a0a0;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }

        .staff-name {
            font-weight: 600;
            font-size: 16px;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .staff-rc {
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 8px;
        }

        .staff-status {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .staff-details {
            font-size: 12px;
            color: #666;
            margin-top: 8px;
        }

        .staff-duty-time {
            font-size: 13px;
            color: #2c3e50;
            font-weight: 500;
            margin-top: 5px;
        }

        /* Today's overview */
        .overview-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-box {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            background: white;
            border: 2px solid #e0e6ed;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
            margin: 5px 0;
        }

        .stat-label {
            font-size: 12px;
            color: #7f8c8d;
            text-transform: uppercase;
        }

        .stat-box.sick {
            border-color: #ffc078;
            background: linear-gradient(135deg, #fff9f0 0%, #ffe8cc 100%);
        }

        .stat-box.frl {
            border-color: #8bcbff;
            background: linear-gradient(135deg, #f0f9ff 0%, #e1f2ff 100%);
        }

        .stat-box.duty-change {
            border-color: #9575cd;
            background: linear-gradient(135deg, #f3f0ff 0%, #e8e4ff 100%);
        }

        .stat-box.on-duty {
            border-color: #81c784;
            background: linear-gradient(135deg, #f0f9f0 0%, #e2f3e2 100%);
        }

        /* Loading spinner */
        .loading {
            text-align: center;
            padding: 30px;
            color: #7f8c8d;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px dashed #e0e6ed;
        }

        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        /* Phone report form */
        .phone-report-form {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 8px;
            border: 2px dashed #3498db;
            margin-top: 20px;
        }

        .phone-report-form h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Recent activity */
        .activity-list {
            margin-top: 15px;
        }

        .activity-item {
            padding: 10px;
            border-left: 3px solid;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .activity-sick {
            border-left-color: #ff922b;
        }

        .activity-frl {
            border-left-color: #339af0;
        }

        .activity-duty-change {
            border-left-color: #9c36b5;
        }

        .activity-time {
            font-size: 11px;
            color: #7f8c8d;
            margin-top: 3px;
        }

        /* Filters */
        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 6px 12px;
            border: 2px solid #e0e6ed;
            background: white;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter-btn.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        .filter-btn:hover:not(.active) {
            border-color: #3498db;
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 22px;
            }
            
            .header .current-date {
                font-size: 14px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .status-board {
                grid-template-columns: 1fr;
            }
            
            .overview-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Color key */
        .color-key {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e0e6ed;
        }

        .key-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
        }

        .key-color {
            width: 15px;
            height: 15px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üìã Duty Status Board</h1>
            <div class="current-date" id="currentDateTime">Loading...</div>
            <p style="color: #7f8c8d; margin-top: 5px; font-size: 14px;">Public View - No Login Required</p>
            <button class="refresh-btn" onclick="loadAllData()">üîÑ Refresh Data</button>
        </div>

        <!-- Overview Statistics -->
        <div class="card">
            <h2><span class="icon">üìä</span> Today's Overview</h2>
            <div class="overview-stats" id="overviewStats">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading statistics...</p>
                </div>
            </div>
        </div>

        <!-- Main Dashboard -->
        <div class="dashboard">
            <!-- Today's Sick Leave -->
            <div class="card">
                <h2><span class="icon">ü§í</span> Today's Sick Leave</h2>
                <div id="todaySickLeave">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading sick leave data...</p>
                    </div>
                </div>
            </div>

            <!-- Today's FRL -->
            <div class="card">
                <h2><span class="icon">üèùÔ∏è</span> Today's FRL</h2>
                <div id="todayFRL">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading FRL data...</p>
                    </div>
                </div>
            </div>

            <!-- Approved Duty Changes -->
            <div class="card full-width">
                <h2><span class="icon">üîÑ</span> Approved Duty Changes (Today & Tomorrow)</h2>
                <div class="filters" id="dutyChangeFilters">
                    <button class="filter-btn active" onclick="filterDutyChanges('all')">All Changes</button>
                    <button class="filter-btn" onclick="filterDutyChanges('today')">Today Only</button>
                    <button class="filter-btn" onclick="filterDutyChanges('tomorrow')">Tomorrow</button>
                </div>
                <div id="approvedDutyChanges">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading duty changes...</p>
                    </div>
                </div>
            </div>

            <!-- Staff Status Board -->
            <div class="card full-width">
                <h2><span class="icon">üë•</span> Staff Status Board</h2>
                <div class="color-key">
                    <div class="key-item">
                        <div class="key-color" style="background: linear-gradient(135deg, #fff9f0 0%, #ffe8cc 100%); border: 2px solid #ffc078;"></div>
                        <span>Sick Leave</span>
                    </div>
                    <div class="key-item">
                        <div class="key-color" style="background: linear-gradient(135deg, #f0f9ff 0%, #e1f2ff 100%); border: 2px solid #8bcbff;"></div>
                        <span>FRL</span>
                    </div>
                    <div class="key-item">
                        <div class="key-color" style="background: linear-gradient(135deg, #f0f9f0 0%, #e2f3e2 100%); border: 2px solid #81c784;"></div>
                        <span>On Duty</span>
                    </div>
                    <div class="key-item">
                        <div class="key-color" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border: 2px solid #a0a0a0;"></div>
                        <span>Off Duty</span>
                    </div>
                </div>
                <div class="status-board" id="staffStatusBoard">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading staff status...</p>
                    </div>
                </div>
            </div>

            <!-- Phone-Reported Leave Entry -->
            <div class="card full-width">
                <div class="phone-report-form">
                    <h3><span class="icon">üìû</span> Phone-Reported Leave Entry</h3>
                    <p class="alert alert-info">Use this form to record leaves that are reported by phone. This will create a pending leave request for supervisor approval.</p>
                    
                    <form id="phoneLeaveForm" onsubmit="submitPhoneLeave(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="phoneStaffName">Staff Name *</label>
                                <input type="text" id="phoneStaffName" class="form-control" placeholder="Enter staff name" required>
                                <small style="color: #666; font-size: 11px;">Start typing to see suggestions</small>
                                <div id="staffSuggestions" style="display: none; position: absolute; background: white; border: 1px solid #ddd; max-height: 200px; overflow-y: auto; z-index: 1000;"></div>
                            </div>
                            <div class="form-group">
                                <label for="phoneStaffRC">RC Number *</label>
                                <input type="text" id="phoneStaffRC" class="form-control" placeholder="Enter RC number" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="phoneLeaveType">Leave Type *</label>
                                <select id="phoneLeaveType" class="form-control" required>
                                    <option value="">Select leave type</option>
                                    <option value="Sick Leave">Sick Leave</option>
                                    <option value="FRL">FRL</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="phoneLeaveDate">Leave Date *</label>
                                <input type="date" id="phoneLeaveDate" class="form-control" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="phoneDutyTime">Duty Time *</label>
                                <input type="text" id="phoneDutyTime" class="form-control" placeholder="e.g., 08:00-16:00" required>
                            </div>
                            <div class="form-group">
                                <label for="phoneDuration">Duration *</label>
                                <select id="phoneDuration" class="form-control" required>
                                    <option value="1">1 Day</option>
                                    <option value="0.5">Half Day</option>
                                    <option value="2">2 Days</option>
                                    <option value="3">3 Days</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="phoneReason">Reason for Leave *</label>
                                <textarea id="phoneReason" class="form-control" rows="2" placeholder="Enter reason for leave (e.g., fever, personal work, etc.)" required></textarea>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="phoneReportedBy">Reported By *</label>
                                <input type="text" id="phoneReportedBy" class="form-control" placeholder="Your name" required>
                            </div>
                            <div class="form-group">
                                <label for="phoneContact">Contact Number</label>
                                <input type="text" id="phoneContact" class="form-control" placeholder="Contact number (optional)">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="alert alert-warning" id="phoneFormAlert">
                                Fill in all required fields marked with *
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <button type="submit" class="btn btn-success">üìû Submit Phone-Reported Leave</button>
                            <button type="button" class="btn btn-danger" onclick="clearPhoneForm()">Clear Form</button>
                        </div>
                    </form>
                    
                    <div id="phoneFormSuccess" style="display: none;" class="alert alert-success">
                        Leave successfully recorded! A pending request has been created for supervisor approval.
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="card">
                <h2><span class="icon">üïí</span> Recent Activity</h2>
                <div class="activity-list" id="recentActivity">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading recent activity...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div style="text-align: center; margin-top: 30px; padding: 15px; color: #7f8c8d; font-size: 12px;">
            Duty Status Board ‚Ä¢ Auto-refreshes every 60 seconds ‚Ä¢ Last updated: <span id="lastUpdatedTime">--:--:--</span>
        </div>
    </div>

    <!-- Firebase Configuration -->
    <script>
        // Firebase configuration (same as your main app)
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
    </script>

    <script>
        // Global variables
        let allStaff = [];
        let dutyRoster = {};
        let leaveRequests = [];
        let allRequests = [];
        let refreshInterval;
        let currentDate = new Date().toISOString().split('T')[0];

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Duty Status Board loading...');
            
            // Set default date for forms
            document.getElementById('phoneLeaveDate').value = currentDate;
            
            // Load all data
            loadAllData();
            
            // Start auto-refresh
            startAutoRefresh();
            
            // Update current date/time display
            updateDateTime();
            setInterval(updateDateTime, 1000);
            
            // Setup staff name suggestions
            setupStaffSuggestions();
        });

        // Load all data from Firebase
        async function loadAllData() {
            try {
                console.log('Loading data from Firebase...');
                
                // Update last updated time
                updateLastUpdatedTime();
                
                // Load staff data (you may need to store staff list in Firebase)
                await loadStaffData();
                
                // Load duty roster
                await loadDutyRoster();
                
                // Load leave requests
                await loadLeaveRequests();
                
                // Load all requests
                await loadAllRequests();
                
                // Update all displays
                updateAllDisplays();
                
                console.log('Data loaded successfully');
            } catch (error) {
                console.error('Error loading data:', error);
                showErrorMessage('Failed to load data. Please refresh the page.');
            }
        }

        // Load staff data
        async function loadStaffData() {
            try {
                // Try to load from Firebase or use default data
                // You may want to create a 'staff' collection in Firebase
                const staffDoc = await db.collection('staff').doc('all').get();
                if (staffDoc.exists) {
                    allStaff = staffDoc.data().staff || [];
                } else {
                    // Default staff list (you should populate this from your main app)
                    allStaff = [
                        { name: "Irufan1", rcNo: "001", username: "irufan1" },
                        { name: "Irufan2", rcNo: "002", username: "irufan2" },
                        { name: "Hussain", rcNo: "003", username: "hussain" },
                        { name: "Mohamed", rcNo: "004", username: "mohamed" }
                        // Add more staff as needed
                    ];
                }
                
                console.log('Staff data loaded:', allStaff.length, 'staff members');
            } catch (error) {
                console.error('Error loading staff data:', error);
                allStaff = [];
            }
        }

        // Load duty roster
        async function loadDutyRoster() {
            try {
                const rosterDoc = await db.collection('dutyRoster').doc('current').get();
                if (rosterDoc.exists) {
                    dutyRoster = rosterDoc.data() || {};
                    console.log('Duty roster loaded:', Object.keys(dutyRoster).length, 'dates');
                } else {
                    dutyRoster = {};
                    console.log('No duty roster found');
                }
            } catch (error) {
                console.error('Error loading duty roster:', error);
                dutyRoster = {};
            }
        }

        // Load leave requests
        async function loadLeaveRequests() {
            try {
                // This would be from your main app's requests collection
                const requestsDoc = await db.collection('requests').doc('all').get();
                if (requestsDoc.exists && requestsDoc.data().requests) {
                    allRequests = requestsDoc.data().requests;
                    console.log('Requests loaded:', allRequests.length, 'requests');
                    
                    // Filter for leave requests
                    leaveRequests = allRequests.filter(req => req.type === 'leave');
                } else {
                    allRequests = [];
                    leaveRequests = [];
                    console.log('No requests found');
                }
            } catch (error) {
                console.error('Error loading requests:', error);
                allRequests = [];
                leaveRequests = [];
            }
        }

        // Load all requests (for activity feed)
        async function loadAllRequests() {
            try {
                // Already loaded in loadLeaveRequests()
                // Filter for recent activity
                const today = new Date();
                const sevenDaysAgo = new Date(today);
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                
                // Get recent requests for activity feed
                recentRequests = allRequests.filter(req => {
                    const reqDate = new Date(req.timestamp || req.approvedAt || req.createdAt);
                    return reqDate >= sevenDaysAgo;
                });
                
                // Sort by date (newest first)
                recentRequests.sort((a, b) => {
                    const dateA = new Date(a.timestamp || a.approvedAt || a.createdAt);
                    const dateB = new Date(b.timestamp || b.approvedAt || b.createdAt);
                    return dateB - dateA;
                });
            } catch (error) {
                console.error('Error loading all requests:', error);
            }
        }

        // Update all displays
        function updateAllDisplays() {
            updateOverviewStats();
            updateTodaySickLeave();
            updateTodayFRL();
            updateApprovedDutyChanges();
            updateStaffStatusBoard();
            updateRecentActivity();
        }

        // Update overview statistics
        function updateOverviewStats() {
            const container = document.getElementById('overviewStats');
            const today = currentDate;
            
            // Get today's leave requests
            const todaySickLeave = leaveRequests.filter(req => 
                req.status === 'approved' && 
                req.date === today && 
                req.leaveType === 'Sick Leave'
            ).length;
            
            const todayFRL = leaveRequests.filter(req => 
                req.status === 'approved' && 
                req.date === today && 
                req.leaveType === 'FRL'
            ).length;
            
            // Get duty changes for today
            const todayDutyChanges = allRequests.filter(req => 
                req.type === 'dutyChange' && 
                req.status === 'approved' && 
                req.date === today
            ).length;
            
            // Count staff on duty today
            let onDutyCount = 0;
            if (dutyRoster[today]) {
                Object.values(dutyRoster[today]).forEach(duty => {
                    if (duty && duty !== 'Off' && duty !== 'Not Scheduled') {
                        onDutyCount++;
                    }
                });
            }
            
            container.innerHTML = `
                <div class="stat-box sick">
                    <div class="stat-label">Sick Leave</div>
                    <div class="stat-value">${todaySickLeave}</div>
                    <div class="stat-label">Today</div>
                </div>
                <div class="stat-box frl">
                    <div class="stat-label">FRL</div>
                    <div class="stat-value">${todayFRL}</div>
                    <div class="stat-label">Today</div>
                </div>
                <div class="stat-box duty-change">
                    <div class="stat-label">Duty Changes</div>
                    <div class="stat-value">${todayDutyChanges}</div>
                    <div class="stat-label">Today</div>
                </div>
                <div class="stat-box on-duty">
                    <div class="stat-label">On Duty</div>
                    <div class="stat-value">${onDutyCount}</div>
                    <div class="stat-label">Today</div>
                </div>
            `;
        }

        // Update today's sick leave display
        function updateTodaySickLeave() {
            const container = document.getElementById('todaySickLeave');
            const today = currentDate;
            
            const todaySickRequests = leaveRequests.filter(req => 
                req.status === 'approved' && 
                req.date === today && 
                req.leaveType === 'Sick Leave'
            );
            
            if (todaySickRequests.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üòä</div>
                        <p>No sick leave today</p>
                        <p style="font-size: 12px;">All staff are healthy!</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="table-container"><table><thead><tr><th>Staff</th><th>RC</th><th>Duration</th><th>Reason</th><th>Reported</th></tr></thead><tbody>';
            
            todaySickRequests.forEach(req => {
                const staff = allStaff.find(s => s.username === req.fromUsername) || { name: req.fromName, rcNo: req.fromRcNo };
                const reportedTime = req.timestamp ? formatTime(new Date(req.timestamp)) : 'Unknown';
                
                html += `
                    <tr>
                        <td><strong>${staff.name}</strong></td>
                        <td>${staff.rcNo}</td>
                        <td><span class="status-badge status-sick">${req.duration} day(s)</span></td>
                        <td>${req.reason || 'Not specified'}</td>
                        <td class="timestamp">${reportedTime}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        // Update today's FRL display
        function updateTodayFRL() {
            const container = document.getElementById('todayFRL');
            const today = currentDate;
            
            const todayFRLRequests = leaveRequests.filter(req => 
                req.status === 'approved' && 
                req.date === today && 
                req.leaveType === 'FRL'
            );
            
            if (todayFRLRequests.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üòä</div>
                        <p>No FRL today</p>
                        <p style="font-size: 12px;">All staff are available!</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="table-container"><table><thead><tr><th>Staff</th><th>RC</th><th>Duration</th><th>Reason</th><th>Reported</th></tr></thead><tbody>';
            
            todayFRLRequests.forEach(req => {
                const staff = allStaff.find(s => s.username === req.fromUsername) || { name: req.fromName, rcNo: req.fromRcNo };
                const reportedTime = req.timestamp ? formatTime(new Date(req.timestamp)) : 'Unknown';
                
                html += `
                    <tr>
                        <td><strong>${staff.name}</strong></td>
                        <td>${staff.rcNo}</td>
                        <td><span class="status-badge status-frl">${req.duration} day(s)</span></td>
                        <td>${req.reason || 'Not specified'}</td>
                        <td class="timestamp">${reportedTime}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        // Update approved duty changes
        function updateApprovedDutyChanges() {
            const container = document.getElementById('approvedDutyChanges');
            
            // Get approved duty changes for today and tomorrow
            const today = currentDate;
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowStr = tomorrow.toISOString().split('T')[0];
            
            const approvedChanges = allRequests.filter(req => 
                req.type === 'dutyChange' && 
                req.status === 'approved' && 
                (req.date === today || req.date === tomorrowStr)
            );
            
            if (approvedChanges.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üîÑ</div>
                        <p>No approved duty changes</p>
                        <p style="font-size: 12px;">All duties are as scheduled</p>
                    </div>
                `;
                return;
            }
            
            // Sort by date then time
            approvedChanges.sort((a, b) => {
                if (a.date === b.date) {
                    return (a.timestamp || '').localeCompare(b.timestamp || '');
                }
                return a.date.localeCompare(b.date);
            });
            
            let html = '';
            
            approvedChanges.forEach(req => {
                const isToday = req.date === today;
                const dateLabel = isToday ? 'Today' : 'Tomorrow';
                
                html += `
                    <div class="duty-change-item duty-change-approved">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <strong>${dateLabel} (${req.date})</strong><br>
                                <span style="font-size: 14px;">
                                    ${req.fromName} (${req.dutyTime}) ‚Üî ${req.toName} (${req.toDutyTime})
                                </span>
                                ${req.reason ? `<div style="margin-top: 5px; font-size: 13px; color: #666;">Reason: ${req.reason}</div>` : ''}
                            </div>
                            <div style="text-align: right;">
                                <span class="status-badge status-approved">Approved</span><br>
                                <span style="font-size: 11px; color: #7f8c8d;">${formatTimeAgo(req.approvedAt || req.timestamp)}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Filter duty changes
        function filterDutyChanges(filter) {
            // Update filter buttons
            document.querySelectorAll('#dutyChangeFilters .filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // For now, just reload the data
            updateApprovedDutyChanges();
        }

        // Update staff status board
        function updateStaffStatusBoard() {
            const container = document.getElementById('staffStatusBoard');
            const today = currentDate;
            
            if (allStaff.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <div class="icon">üë•</div>
                        <p>No staff data available</p>
                        <p style="font-size: 12px;">Please check Firebase connection</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            allStaff.forEach(staff => {
                // Check if staff is on leave today
                const todayLeave = leaveRequests.find(req => 
                    req.status === 'approved' && 
                    req.date === today && 
                    req.fromUsername === staff.username
                );
                
                // Get today's duty
                let dutyTime = 'Not Scheduled';
                let dutyStatus = 'Not Scheduled';
                if (dutyRoster[today] && dutyRoster[today][staff.username]) {
                    dutyTime = dutyRoster[today][staff.username];
                    dutyStatus = dutyTime === 'Off' ? 'Off Duty' : 'On Duty';
                }
                
                // Determine card class based on status
                let cardClass = 'staff-card';
                let statusBadge = '';
                let statusDetails = '';
                
                if (todayLeave) {
                    cardClass += todayLeave.leaveType === 'Sick Leave' ? ' sick' : ' frl';
                    statusBadge = `<span class="status-badge ${todayLeave.leaveType === 'Sick Leave' ? 'status-sick' : 'status-frl'}">${todayLeave.leaveType}</span>`;
                    statusDetails = `<div class="staff-details">${todayLeave.reason || 'Not specified'}</div>`;
                    dutyStatus = `On ${todayLeave.leaveType}`;
                } else if (dutyTime === 'Off') {
                    cardClass += ' off-duty';
                    dutyStatus = 'Off Duty';
                } else if (dutyTime && dutyTime !== 'Not Scheduled') {
                    cardClass += ' on-duty';
                }
                
                html += `
                    <div class="${cardClass}">
                        <div class="staff-name">${staff.name}</div>
                        <div class="staff-rc">RC: ${staff.rcNo}</div>
                        <div class="staff-status">${statusBadge} ${dutyStatus}</div>
                        <div class="staff-duty-time">${dutyTime}</div>
                        ${statusDetails}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Update recent activity
        function updateRecentActivity() {
            const container = document.getElementById('recentActivity');
            
            // Get recent activity (last 10 items)
            const recentActivity = allRequests.slice(0, 10);
            
            if (recentActivity.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üïí</div>
                        <p>No recent activity</p>
                        <p style="font-size: 12px;">Activity will appear here</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            recentActivity.forEach(req => {
                let activityClass = 'activity-item';
                let icon = 'üìù';
                let description = '';
                let time = req.timestamp || req.approvedAt || req.createdAt;
                
                if (req.type === 'leave') {
                    activityClass += req.leaveType === 'Sick Leave' ? ' activity-sick' : ' activity-frl';
                    icon = req.leaveType === 'Sick Leave' ? 'ü§í' : 'üèùÔ∏è';
                    description = `${req.fromName} - ${req.leaveType} (${req.duration} day)`;
                } else if (req.type === 'dutyChange') {
                    activityClass += ' activity-duty-change';
                    icon = 'üîÑ';
                    description = `${req.fromName} ‚Üî ${req.toName}`;
                }
                
                html += `
                    <div class="${activityClass}">
                        <div style="display: flex; align-items: start; gap: 10px;">
                            <div style="font-size: 18px;">${icon}</div>
                            <div>
                                <div>${description}</div>
                                <div class="activity-time">${formatTimeAgo(time)}</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Setup staff name suggestions
        function setupStaffSuggestions() {
            const nameInput = document.getElementById('phoneStaffName');
            const rcInput = document.getElementById('phoneStaffRC');
            const suggestionsDiv = document.getElementById('staffSuggestions');
            
            nameInput.addEventListener('input', function() {
                const query = this.value.toLowerCase();
                if (query.length < 2) {
                    suggestionsDiv.style.display = 'none';
                    return;
                }
                
                const matches = allStaff.filter(staff => 
                    staff.name.toLowerCase().includes(query) || 
                    staff.rcNo.includes(query)
                ).slice(0, 5);
                
                if (matches.length === 0) {
                    suggestionsDiv.style.display = 'none';
                    return;
                }
                
                suggestionsDiv.innerHTML = '';
                matches.forEach(staff => {
                    const div = document.createElement('div');
                    div.style.padding = '8px';
                    div.style.cursor = 'pointer';
                    div.style.borderBottom = '1px solid #eee';
                    div.innerHTML = `${staff.name} (RC: ${staff.rcNo})`;
                    div.onclick = function() {
                        nameInput.value = staff.name;
                        rcInput.value = staff.rcNo;
                        suggestionsDiv.style.display = 'none';
                    };
                    suggestionsDiv.appendChild(div);
                });
                
                suggestionsDiv.style.display = 'block';
                suggestionsDiv.style.width = nameInput.offsetWidth + 'px';
            });
            
            // Hide suggestions when clicking outside
            document.addEventListener('click', function(e) {
                if (!nameInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
                    suggestionsDiv.style.display = 'none';
                }
            });
        }

        // Submit phone-reported leave
        async function submitPhoneLeave(event) {
            event.preventDefault();
            
            const staffName = document.getElementById('phoneStaffName').value.trim();
            const rcNo = document.getElementById('phoneStaffRC').value.trim();
            const leaveType = document.getElementById('phoneLeaveType').value;
            const leaveDate = document.getElementById('phoneLeaveDate').value;
            const dutyTime = document.getElementById('phoneDutyTime').value.trim();
            const duration = document.getElementById('phoneDuration').value;
            const reason = document.getElementById('phoneReason').value.trim();
            const reportedBy = document.getElementById('phoneReportedBy').value.trim();
            const contact = document.getElementById('phoneContact').value.trim();
            
            // Validation
            if (!staffName || !rcNo || !leaveType || !leaveDate || !dutyTime || !reason || !reportedBy) {
                document.getElementById('phoneFormAlert').style.display = 'block';
                document.getElementById('phoneFormAlert').textContent = 'Please fill all required fields marked with *';
                document.getElementById('phoneFormAlert').className = 'alert alert-danger';
                return;
            }
            
            // Find or create staff
            let staff = allStaff.find(s => s.rcNo === rcNo);
            if (!staff) {
                // Create a temporary staff entry
                const username = staffName.toLowerCase().replace(/\s+/g, '');
                staff = { name: staffName, rcNo: rcNo, username: username };
                allStaff.push(staff);
            }
            
            // Create leave request
            const leaveRequest = {
                id: 'phone_' + Date.now(),
                type: 'leave',
                leaveType: leaveType,
                fromUsername: staff.username,
                fromName: staff.name,
                fromRcNo: rcNo,
                date: leaveDate,
                dutyTime: dutyTime,
                duration: parseFloat(duration),
                reason: reason,
                status: 'pending',
                source: 'phone',
                reportedBy: reportedBy,
                contact: contact,
                timestamp: new Date().toISOString(),
                history: [{
                    action: 'phone_reported',
                    by: reportedBy,
                    timestamp: new Date().toISOString(),
                    note: 'Reported via phone'
                }]
            };
            
            try {
                // Add to all requests
                allRequests.push(leaveRequest);
                
                // Save to Firebase
                await db.collection('requests').doc('all').set({ requests: allRequests });
                
                // Show success message
                document.getElementById('phoneFormSuccess').style.display = 'block';
                document.getElementById('phoneFormAlert').style.display = 'none';
                
                // Clear form
                clearPhoneForm();
                
                // Update displays
                updateAllDisplays();
                
                // Hide success message after 5 seconds
                setTimeout(() => {
                    document.getElementById('phoneFormSuccess').style.display = 'none';
                }, 5000);
                
                console.log('Phone-reported leave submitted:', leaveRequest);
                
            } catch (error) {
                console.error('Error saving phone leave:', error);
                document.getElementById('phoneFormAlert').textContent = 'Error saving leave request. Please try again.';
                document.getElementById('phoneFormAlert').className = 'alert alert-danger';
                document.getElementById('phoneFormAlert').style.display = 'block';
            }
        }

        // Clear phone form
        function clearPhoneForm() {
            document.getElementById('phoneLeaveForm').reset();
            document.getElementById('phoneLeaveDate').value = currentDate;
            document.getElementById('phoneFormAlert').style.display = 'block';
            document.getElementById('phoneFormAlert').textContent = 'Fill in all required fields marked with *';
            document.getElementById('phoneFormAlert').className = 'alert alert-warning';
        }

        // Update date/time display
        function updateDateTime() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            const timeStr = now.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            });
            document.getElementById('currentDateTime').textContent = `${dateStr} ‚Ä¢ ${timeStr}`;
        }

        // Update last updated time
        function updateLastUpdatedTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            });
            document.getElementById('lastUpdatedTime').textContent = timeStr;
        }

        // Start auto-refresh
        function startAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            
            refreshInterval = setInterval(() => {
                loadAllData();
                console.log('Auto-refreshing data...');
            }, 60000); // Refresh every 60 seconds
        }

        // Utility functions
        function formatTime(date) {
            return date.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }

        function formatTimeAgo(timestamp) {
            if (!timestamp) return 'Unknown time';
            
            const now = new Date();
            const past = new Date(timestamp);
            const diffMs = now - past;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);
            
            if (diffMins < 1) return 'just now';
            if (diffMins < 60) return `${diffMins} minute${diffMins !== 1 ? 's' : ''} ago`;
            if (diffHours < 24) return `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
            if (diffDays < 7) return `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;
            
            return past.toLocaleDateString();
        }

        function showErrorMessage(message) {
            const header = document.querySelector('.header');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-danger';
            errorDiv.textContent = message;
            errorDiv.style.marginTop = '10px';
            
            // Remove any existing error
            const existingError = header.querySelector('.alert-danger');
            if (existingError) {
                existingError.remove();
            }
            
            header.appendChild(errorDiv);
            
            // Auto-remove after 10 seconds
            setTimeout(() => {
                errorDiv.remove();
            }, 10000);
        }

        // Manual refresh function (called by button)
        window.refreshData = function() {
            loadAllData();
        };
    </script>
</body>
</html>
