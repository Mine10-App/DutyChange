<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duty Status Board - Public View</title>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <!-- External Firebase Configuration -->
    <script src="dcfire.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        body {
            background: #f5f7fa;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
        }

        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .header .current-date {
            color: #7f8c8d;
            font-size: 16px;
            font-weight: 500;
        }

        .refresh-btn {
            margin-top: 10px;
            padding: 8px 20px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .refresh-btn:hover {
            background: #2980b9;
        }

        .refresh-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 1200px) {
            .dashboard {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #e0e6ed;
            position: relative;
        }

        .card h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card h2 .icon {
            font-size: 20px;
        }

        .card.full-width {
            grid-column: 1 / -1;
        }

        /* Shift-specific colors */
        .shift-morning {
            border-left: 4px solid #f39c12;
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        }

        .shift-afternoon {
            border-left: 4px solid #3498db;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        }

        .shift-night {
            border-left: 4px solid #2c3e50;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
        }

        .shift-night td {
            color: white;
        }

        .shift-night .staff-name {
            color: white;
        }

        /* Connection Status */
        .connection-status {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            background: #f8f9fa;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-dot.online {
            background: #27ae60;
            animation: pulse 2s infinite;
        }

        .status-dot.offline {
            background: #e74c3c;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            margin-top: 15px;
            border: 1px solid #e0e6ed;
            border-radius: 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e6ed;
            font-size: 14px;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
            position: sticky;
            top: 0;
        }

        td {
            color: #2c3e50;
        }

        tr:hover {
            background: #f8f9fa;
        }

        /* Status badges */
        .status-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .status-sick {
            background: linear-gradient(135deg, #ffd8a6 0%, #ffc078 100%);
            color: #e8590c;
        }

        .status-frl {
            background: linear-gradient(135deg, #a3daff 0%, #8bcbff 100%);
            color: #0c63e4;
        }

        .status-pending {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            color: #856404;
        }

        .status-approved {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
        }

        .status-rejected {
            background: linear-gradient(135deg, #f8d7da 0%, #f1b0b7 100%);
            color: #721c24;
        }

        /* Duty time badges */
        .duty-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
            margin: 2px;
        }

        .duty-morning {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            color: #856404;
            border: 1px solid #f39c12;
        }

        .duty-afternoon {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            color: #0c5460;
            border: 1px solid #3498db;
        }

        .duty-night {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            border: 1px solid #1a252f;
        }

        /* Staff cards */
        .staff-card {
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            border: 2px solid #e0e6ed;
            background: white;
        }

        .staff-name {
            font-weight: 600;
            font-size: 16px;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .staff-rc {
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 5px;
        }

        .staff-duty {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .staff-time {
            font-size: 13px;
            color: #2c3e50;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Shift panels */
        .shift-panel {
            margin-bottom: 20px;
            border-radius: 8px;
            overflow: hidden;
        }

        .shift-header {
            padding: 12px;
            font-weight: 600;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .shift-staff-count {
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
        }

        .shift-staff-list {
            padding: 15px;
            background: rgba(255, 255, 255, 0.9);
        }

        /* Current shift indicator */
        .current-shift-indicator {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(52, 152, 219, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: 600;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Time display */
        .time-display {
            font-size: 36px;
            font-weight: bold;
            text-align: center;
            margin: 10px 0;
            color: #2c3e50;
        }

        .date-display {
            font-size: 18px;
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        /* Color key */
        .color-key {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e0e6ed;
        }

        .key-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
        }

        .key-color {
            width: 15px;
            height: 15px;
            border-radius: 3px;
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 22px;
            }
            
            .header .current-date {
                font-size: 14px;
            }
            
            .current-shift-indicator {
                top: 10px;
                padding: 8px 15px;
                font-size: 14px;
            }
            
            .time-display {
                font-size: 28px;
            }
            
            .date-display {
                font-size: 16px;
            }
            
            .connection-status {
                position: static;
                margin-top: 10px;
                justify-content: center;
            }
        }

        /* Loading spinner */
        .loading {
            text-align: center;
            padding: 30px;
            color: #7f8c8d;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Alert messages */
        .alert {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid;
            font-size: 14px;
        }

        .alert-info {
            background: #e8f4fc;
            border-color: #3498db;
            color: #2c3e50;
        }

        .alert-warning {
            background: #fff3cd;
            border-color: #f39c12;
            color: #856404;
        }

        .alert-danger {
            background: #f8d7da;
            border-color: #e74c3c;
            color: #721c24;
        }

        .alert-success {
            background: #d4edda;
            border-color: #27ae60;
            color: #155724;
        }

        /* Local storage indicator */
        .local-storage-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #f39c12;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 12px;
            display: none;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <!-- Current Shift Indicator -->
    <div class="current-shift-indicator" id="currentShiftIndicator">
        <span id="currentShiftText">Loading...</span>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üìã Duty Status Board</h1>
            <div class="time-display" id="currentTime">--:--:--</div>
            <div class="date-display" id="currentDate">-- --- ----</div>
            <p style="color: #7f8c8d; margin-top: 5px; font-size: 14px;">Public View - No Login Required</p>
            <button class="refresh-btn" onclick="loadAllData()" id="refreshBtn">üîÑ Refresh Data</button>
            
            <!-- Connection Status -->
            <div class="connection-status" id="connectionStatus">
                <span class="status-dot offline" id="statusDot"></span>
                <span id="statusText">Connecting...</span>
            </div>
        </div>

        <!-- Color Key -->
        <div class="card">
            <h2><span class="icon">üé®</span> Shift Colors</h2>
            <div class="color-key">
                <div class="key-item">
                    <div class="key-color" style="background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); border: 2px solid #f39c12;"></div>
                    <span>Morning Shift (05:30-13:30, 07:30-15:30, 08:30-16:30)</span>
                </div>
                <div class="key-item">
                    <div class="key-color" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: 2px solid #3498db;"></div>
                    <span>Afternoon Shift (15:30-23:30, 16:30-00:30, 17:30-01:30)</span>
                </div>
                <div class="key-item">
                    <div class="key-color" style="background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); border: 2px solid #1a252f;"></div>
                    <span>Night Shift (00:30-08:30)</span>
                </div>
            </div>
        </div>

        <!-- Main Dashboard -->
        <div class="dashboard">
            <!-- Morning Shift Staff -->
            <div class="card shift-morning">
                <h2><span class="icon">üåÖ</span> Morning Shift Staff</h2>
                <div class="alert alert-info">
                    <strong>Shift Times:</strong><br>
                    ‚Ä¢ 05:30 - 13:30<br>
                    ‚Ä¢ 07:30 - 15:30<br>
                    ‚Ä¢ 08:30 - 16:30
                </div>
                <div id="morningShiftStaff">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading morning shift...</p>
                    </div>
                </div>
            </div>

            <!-- Afternoon Shift Staff -->
            <div class="card shift-afternoon">
                <h2><span class="icon">üåá</span> Afternoon Shift Staff</h2>
                <div class="alert alert-info">
                    <strong>Shift Times:</strong><br>
                    ‚Ä¢ 15:30 - 23:30<br>
                    ‚Ä¢ 16:30 - 00:30<br>
                    ‚Ä¢ 17:30 - 01:30
                </div>
                <div id="afternoonShiftStaff">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading afternoon shift...</p>
                    </div>
                </div>
            </div>

            <!-- Night Shift Staff -->
            <div class="card shift-night">
                <h2><span class="icon">üåô</span> Night Shift Staff</h2>
                <div class="alert alert-info" style="background: rgba(255,255,255,0.1); color: white; border-color: #3498db;">
                    <strong>Shift Times:</strong><br>
                    ‚Ä¢ 00:30 - 08:30
                </div>
                <div id="nightShiftStaff">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading night shift...</p>
                    </div>
                </div>
            </div>

            <!-- Today's Sick Leave -->
            <div class="card">
                <h2><span class="icon">ü§í</span> Today's Sick Leave</h2>
                <div id="todaySickLeave">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading sick leave data...</p>
                    </div>
                </div>
            </div>

            <!-- Today's FRL -->
            <div class="card">
                <h2><span class="icon">üèùÔ∏è</span> Today's FRL</h2>
                <div id="todayFRL">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading FRL data...</p>
                    </div>
                </div>
            </div>

            <!-- Duty Changes -->
            <div class="card">
                <h2><span class="icon">üîÑ</span> Recent Duty Changes</h2>
                <div id="dutyChanges">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading duty changes...</p>
                    </div>
                </div>
            </div>

            <!-- Staff Status Overview -->
            <div class="card full-width">
                <h2><span class="icon">üë•</span> All Staff Status</h2>
                <div id="staffStatusOverview">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading staff status...</p>
                    </div>
                </div>
            </div>

            <!-- Phone-Reported Leave Entry -->
            <div class="card full-width">
                <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 20px; border-radius: 8px; border: 2px dashed #3498db;">
                    <h3><span class="icon">üìû</span> Phone-Reported Leave Entry</h3>
                    <p class="alert alert-info">Use this form to record leaves that are reported by phone. This will create a pending leave request for supervisor approval.</p>
                    
                    <form id="phoneLeaveForm" onsubmit="submitPhoneLeave(event)">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; color: #2c3e50; font-size: 14px; font-weight: 500; margin-bottom: 5px;">Staff Name *</label>
                                <input type="text" id="phoneStaffName" style="width: 100%; padding: 10px; border: 2px solid #e0e6ed; border-radius: 6px; font-size: 14px;" placeholder="Enter staff name" required>
                            </div>
                            <div>
                                <label style="display: block; color: #2c3e50; font-size: 14px; font-weight: 500; margin-bottom: 5px;">RC Number *</label>
                                <input type="text" id="phoneStaffRC" style="width: 100%; padding: 10px; border: 2px solid #e0e6ed; border-radius: 6px; font-size: 14px;" placeholder="Enter RC number" required>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; color: #2c3e50; font-size: 14px; font-weight: 500; margin-bottom: 5px;">Leave Type *</label>
                                <select id="phoneLeaveType" style="width: 100%; padding: 10px; border: 2px solid #e0e6ed; border-radius: 6px; font-size: 14px;" required>
                                    <option value="">Select leave type</option>
                                    <option value="Sick Leave">Sick Leave</option>
                                    <option value="FRL">FRL</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; color: #2c3e50; font-size: 14px; font-weight: 500; margin-bottom: 5px;">Leave Date *</label>
                                <input type="date" id="phoneLeaveDate" style="width: 100%; padding: 10px; border: 2px solid #e0e6ed; border-radius: 6px; font-size: 14px;" required>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; color: #2c3e50; font-size: 14px; font-weight: 500; margin-bottom: 5px;">Duty Time *</label>
                                <select id="phoneDutyTime" style="width: 100%; padding: 10px; border: 2px solid #e0e6ed; border-radius: 6px; font-size: 14px;" required>
                                    <option value="">Select duty time</option>
                                    <option value="0530-1330">05:30 - 13:30</option>
                                    <option value="0730-1530">07:30 - 15:30</option>
                                    <option value="0830-1630">08:30 - 16:30</option>
                                    <option value="1530-2330">15:30 - 23:30</option>
                                    <option value="1630-0030">16:30 - 00:30</option>
                                    <option value="1730-0130">17:30 - 01:30</option>
                                    <option value="0030-0830">00:30 - 08:30</option>
                                    <option value="Off">Off Duty</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; color: #2c3e50; font-size: 14px; font-weight: 500; margin-bottom: 5px;">Duration *</label>
                                <select id="phoneDuration" style="width: 100%; padding: 10px; border: 2px solid #e0e6ed; border-radius: 6px; font-size: 14px;" required>
                                    <option value="1">1 Day</option>
                                    <option value="0.5">Half Day</option>
                                    <option value="2">2 Days</option>
                                    <option value="3">3 Days</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; color: #2c3e50; font-size: 14px; font-weight: 500; margin-bottom: 5px;">Reason for Leave *</label>
                            <textarea id="phoneReason" style="width: 100%; padding: 10px; border: 2px solid #e0e6ed; border-radius: 6px; font-size: 14px; min-height: 60px; resize: vertical;" placeholder="Enter reason for leave (e.g., fever, personal work, etc.)" required></textarea>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; color: #2c3e50; font-size: 14px; font-weight: 500; margin-bottom: 5px;">Reported By *</label>
                                <input type="text" id="phoneReportedBy" style="width: 100%; padding: 10px; border: 2px solid #e0e6ed; border-radius: 6px; font-size: 14px;" placeholder="Your name" required>
                            </div>
                            <div>
                                <label style="display: block; color: #2c3e50; font-size: 14px; font-weight: 500; margin-bottom: 5px;">Contact Number</label>
                                <input type="text" id="phoneContact" style="width: 100%; padding: 10px; border: 2px solid #e0e6ed; border-radius: 6px; font-size: 14px;" placeholder="Contact number (optional)">
                            </div>
                        </div>
                        
                        <div class="alert alert-warning" id="phoneFormAlert">
                            Fill in all required fields marked with *
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button type="submit" class="btn-success" style="padding: 10px 20px; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; background: #27ae60; color: white;" id="submitPhoneBtn">üìû Submit Phone-Reported Leave</button>
                            <button type="button" class="btn-danger" onclick="clearPhoneForm()" style="padding: 10px 20px; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; background: #e74c3c; color: white;">Clear Form</button>
                        </div>
                    </form>
                    
                    <div id="phoneFormSuccess" style="display: none;" class="alert alert-success">
                        Leave successfully recorded! A pending request has been created for supervisor approval.
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div style="text-align: center; margin-top: 30px; padding: 15px; color: #7f8c8d; font-size: 12px;">
            Duty Status Board ‚Ä¢ Auto-refreshes every 30 seconds ‚Ä¢ Last updated: <span id="lastUpdatedTime">--:--:--</span>
        </div>
    </div>

    <!-- Local Storage Indicator -->
    <div class="local-storage-indicator" id="localStorageIndicator">
        Using offline data
    </div>

    <script>
        // Global variables
        let allStaff = [];
        let dutyRoster = {};
        let leaveRequests = [];
        let allRequests = [];
        let refreshInterval;
        let currentDate = new Date().toISOString().split('T')[0];
        let isOnline = false;
        let db; // Firebase database reference

        // Define shift timings
        const SHIFT_TIMINGS = {
            MORNING: ['0530-1330', '0730-1530', '0830-1630'],
            AFTERNOON: ['1530-2330', '1630-0030', '1730-0130'],
            NIGHT: ['0030-0830']
        };

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Duty Status Board loading...');
            
            // Set default date for forms
            document.getElementById('phoneLeaveDate').value = currentDate;
            
            // Initialize Firebase
            initializeFirebase();
            
            // Start real-time updates
            updateDateTime();
            setInterval(updateDateTime, 1000);
            
            // Set up offline/online detection
            setupConnectionMonitoring();
            
            // Load data
            setTimeout(() => {
                loadAllData();
            }, 1000);
            
            // Start auto-refresh
            startAutoRefresh();
        });

        // Initialize Firebase
        function initializeFirebase() {
            if (typeof firebase !== 'undefined' && firebase.apps.length > 0) {
                db = firebase.firestore();
                console.log('Firebase initialized from dcfire.js');
                
                // Enable Firestore offline persistence
                db.enablePersistence()
                    .then(() => {
                        console.log('Firestore persistence enabled');
                        updateConnectionStatus(true);
                    })
                    .catch((err) => {
                        console.warn('Firestore persistence error:', err.code);
                        updateConnectionStatus(false);
                    });
            } else {
                console.error('Firebase not initialized. Check dcfire.js');
                updateConnectionStatus(false);
                showErrorMessage('Firebase not initialized. Please check your internet connection and refresh the page.');
            }
        }

        // Setup connection monitoring
        function setupConnectionMonitoring() {
            // Check initial connection
            updateConnectionStatus(navigator.onLine);
            
            // Listen for online/offline events
            window.addEventListener('online', () => {
                updateConnectionStatus(true);
                if (db) {
                    loadAllData();
                }
            });
            
            window.addEventListener('offline', () => {
                updateConnectionStatus(false);
                showLocalStorageIndicator();
            });
        }

        // Update connection status display
        function updateConnectionStatus(online) {
            isOnline = online;
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            const refreshBtn = document.getElementById('refreshBtn');
            
            if (online) {
                statusDot.className = 'status-dot online';
                statusText.textContent = 'Online';
                refreshBtn.disabled = false;
                hideLocalStorageIndicator();
            } else {
                statusDot.className = 'status-dot offline';
                statusText.textContent = 'Offline';
                refreshBtn.disabled = true;
                showLocalStorageIndicator();
            }
        }

        // Show/hide local storage indicator
        function showLocalStorageIndicator() {
            const indicator = document.getElementById('localStorageIndicator');
            indicator.style.display = 'block';
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 3000);
        }

        function hideLocalStorageIndicator() {
            document.getElementById('localStorageIndicator').style.display = 'none';
        }

        // Load all data from Firebase
        async function loadAllData() {
            if (!db) {
                console.warn('Firebase not available, cannot load data');
                updateConnectionStatus(false);
                return;
            }
            
            try {
                console.log('Loading data from Firebase...');
                
                // Disable refresh button during load
                const refreshBtn = document.getElementById('refreshBtn');
                refreshBtn.disabled = true;
                refreshBtn.innerHTML = 'üîÑ Loading...';
                
                // Update last updated time
                updateLastUpdatedTime();
                
                // Load all data in parallel
                await Promise.all([
                    loadStaffData(),
                    loadDutyRoster(),
                    loadAllRequests()
                ]);
                
                // Update all displays
                updateAllDisplays();
                
                console.log('Data loaded successfully');
                updateConnectionStatus(true);
                
            } catch (error) {
                console.error('Error loading data:', error);
                showErrorMessage(`Failed to load data: ${error.message}. Using cached data.`);
                updateConnectionStatus(false);
            } finally {
                // Re-enable refresh button
                const refreshBtn = document.getElementById('refreshBtn');
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = 'üîÑ Refresh Data';
            }
        }

        // Load staff data
        async function loadStaffData() {
            try {
                // Try to load from users collection
                const usersSnapshot = await db.collection('users').get();
                if (!usersSnapshot.empty) {
                    allStaff = [];
                    usersSnapshot.forEach(doc => {
                        const userData = doc.data();
                        if (userData.Level === 'User') {
                            allStaff.push({
                                name: userData.name,
                                rcNo: userData.RCNo,
                                username: userData.username
                            });
                        }
                    });
                    console.log('Staff data loaded from users collection:', allStaff.length);
                } else {
                    console.log('No staff data found in Firebase');
                    allStaff = []; // Reset to empty array
                }
            } catch (error) {
                console.error('Error loading staff data:', error);
                throw error;
            }
        }

        // Load duty roster
        async function loadDutyRoster() {
            try {
                const rosterDoc = await db.collection('dutyRoster').doc('current').get();
                if (rosterDoc.exists) {
                    dutyRoster = rosterDoc.data() || {};
                    console.log('Duty roster loaded:', Object.keys(dutyRoster).length, 'dates');
                } else {
                    dutyRoster = {};
                    console.log('No duty roster found');
                }
            } catch (error) {
                console.error('Error loading duty roster:', error);
                throw error;
            }
        }

        // Load all requests
        async function loadAllRequests() {
            try {
                const requestsDoc = await db.collection('requests').doc('all').get();
                if (requestsDoc.exists && requestsDoc.data().requests) {
                    allRequests = requestsDoc.data().requests;
                    leaveRequests = allRequests.filter(req => req.type === 'leave');
                    console.log('Requests loaded:', allRequests.length, 'requests');
                } else {
                    allRequests = [];
                    leaveRequests = [];
                    console.log('No requests found');
                }
            } catch (error) {
                console.error('Error loading requests:', error);
                throw error;
            }
        }

        // Update all displays
        function updateAllDisplays() {
            updateCurrentShift();
            updateMorningShiftStaff();
            updateAfternoonShiftStaff();
            updateNightShiftStaff();
            updateTodaySickLeave();
            updateTodayFRL();
            updateDutyChanges();
            updateStaffStatusOverview();
        }

        // Update current shift indicator
        function updateCurrentShift() {
            const now = new Date();
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            const currentTime = currentHour * 100 + currentMinute;
            
            let currentShift = '';
            let shiftColor = '';
            
            // Determine current shift based on time
            if (currentTime >= 530 && currentTime < 1330) {
                currentShift = 'üåÖ Morning Shift (05:30 - 13:30)';
                shiftColor = '#f39c12';
            } else if (currentTime >= 730 && currentTime < 1530) {
                currentShift = 'üåÖ Morning Shift (07:30 - 15:30)';
                shiftColor = '#f39c12';
            } else if (currentTime >= 830 && currentTime < 1630) {
                currentShift = 'üåÖ Morning Shift (08:30 - 16:30)';
                shiftColor = '#f39c12';
            } else if (currentTime >= 1530 && currentTime < 2330) {
                currentShift = 'üåá Afternoon Shift (15:30 - 23:30)';
                shiftColor = '#3498db';
            } else if ((currentTime >= 1630 && currentTime < 2400) || (currentTime >= 0 && currentTime < 30)) {
                currentShift = 'üåá Afternoon Shift (16:30 - 00:30)';
                shiftColor = '#3498db';
            } else if ((currentTime >= 1730 && currentTime < 2400) || (currentTime >= 0 && currentTime < 130)) {
                currentShift = 'üåá Afternoon Shift (17:30 - 01:30)';
                shiftColor = '#3498db';
            } else if ((currentTime >= 30 && currentTime < 830) || (currentTime >= 0 && currentTime < 830)) {
                currentShift = 'üåô Night Shift (00:30 - 08:30)';
                shiftColor = '#2c3e50';
            } else {
                currentShift = 'üìã Between Shifts';
                shiftColor = '#7f8c8d';
            }
            
            document.getElementById('currentShiftText').textContent = currentShift;
            document.getElementById('currentShiftIndicator').style.background = `rgba(${parseInt(shiftColor.slice(1,3), 16)}, ${parseInt(shiftColor.slice(3,5), 16)}, ${parseInt(shiftColor.slice(5,7), 16)}, 0.9)`;
        }

        // Update morning shift staff
        function updateMorningShiftStaff() {
            const container = document.getElementById('morningShiftStaff');
            const today = currentDate;
            
            if (!dutyRoster[today] || allStaff.length === 0) {
                container.innerHTML = '<div class="alert alert-warning">No duty roster data available for today</div>';
                return;
            }
            
            const morningStaff = [];
            
            // Find staff with morning shift duties
            allStaff.forEach(staff => {
                if (dutyRoster[today][staff.username]) {
                    const dutyTime = dutyRoster[today][staff.username];
                    if (SHIFT_TIMINGS.MORNING.includes(dutyTime)) {
                        // Check if staff is on leave
                        const onLeave = leaveRequests.find(req => 
                            req.status === 'approved' && 
                            req.date === today && 
                            req.fromUsername === staff.username
                        );
                        
                        if (!onLeave) {
                            morningStaff.push({
                                staff: staff,
                                dutyTime: dutyTime
                            });
                        }
                    }
                }
            });
            
            if (morningStaff.length === 0) {
                container.innerHTML = '<div class="alert alert-warning">No morning shift staff scheduled for today</div>';
                return;
            }
            
            let html = '';
            morningStaff.forEach(item => {
                html += `
                    <div class="staff-card">
                        <div class="staff-name">${item.staff.name}</div>
                        <div class="staff-rc">RC: ${item.staff.rcNo}</div>
                        <div class="staff-duty">
                            <span class="duty-badge duty-morning">${formatDutyTime(item.dutyTime)}</span>
                        </div>
                        <div class="staff-time">üìÖ Today</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Update afternoon shift staff
        function updateAfternoonShiftStaff() {
            const container = document.getElementById('afternoonShiftStaff');
            const today = currentDate;
            
            if (!dutyRoster[today] || allStaff.length === 0) {
                container.innerHTML = '<div class="alert alert-warning">No duty roster data available for today</div>';
                return;
            }
            
            const afternoonStaff = [];
            
            // Find staff with afternoon shift duties
            allStaff.forEach(staff => {
                if (dutyRoster[today][staff.username]) {
                    const dutyTime = dutyRoster[today][staff.username];
                    if (SHIFT_TIMINGS.AFTERNOON.includes(dutyTime)) {
                        // Check if staff is on leave
                        const onLeave = leaveRequests.find(req => 
                            req.status === 'approved' && 
                            req.date === today && 
                            req.fromUsername === staff.username
                        );
                        
                        if (!onLeave) {
                            afternoonStaff.push({
                                staff: staff,
                                dutyTime: dutyTime
                            });
                        }
                    }
                }
            });
            
            if (afternoonStaff.length === 0) {
                container.innerHTML = '<div class="alert alert-warning">No afternoon shift staff scheduled for today</div>';
                return;
            }
            
            let html = '';
            afternoonStaff.forEach(item => {
                html += `
                    <div class="staff-card">
                        <div class="staff-name">${item.staff.name}</div>
                        <div class="staff-rc">RC: ${item.staff.rcNo}</div>
                        <div class="staff-duty">
                            <span class="duty-badge duty-afternoon">${formatDutyTime(item.dutyTime)}</span>
                        </div>
                        <div class="staff-time">üìÖ Today</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Update night shift staff
        function updateNightShiftStaff() {
            const container = document.getElementById('nightShiftStaff');
            const today = currentDate;
            
            if (!dutyRoster[today] || allStaff.length === 0) {
                container.innerHTML = '<div class="alert alert-warning">No duty roster data available for today</div>';
                return;
            }
            
            const nightStaff = [];
            
            // Find staff with night shift duties
            allStaff.forEach(staff => {
                if (dutyRoster[today][staff.username]) {
                    const dutyTime = dutyRoster[today][staff.username];
                    if (SHIFT_TIMINGS.NIGHT.includes(dutyTime)) {
                        // Check if staff is on leave
                        const onLeave = leaveRequests.find(req => 
                            req.status === 'approved' && 
                            req.date === today && 
                            req.fromUsername === staff.username
                        );
                        
                        if (!onLeave) {
                            nightStaff.push({
                                staff: staff,
                                dutyTime: dutyTime
                            });
                        }
                    }
                }
            });
            
            if (nightStaff.length === 0) {
                container.innerHTML = '<div class="alert alert-warning">No night shift staff scheduled for today</div>';
                return;
            }
            
            let html = '';
            nightStaff.forEach(item => {
                html += `
                    <div class="staff-card" style="background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2);">
                        <div class="staff-name" style="color: white;">${item.staff.name}</div>
                        <div class="staff-rc" style="color: rgba(255,255,255,0.7);">RC: ${item.staff.rcNo}</div>
                        <div class="staff-duty">
                            <span class="duty-badge duty-night">${formatDutyTime(item.dutyTime)}</span>
                        </div>
                        <div class="staff-time" style="color: rgba(255,255,255,0.7);">üìÖ Today</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Update today's sick leave display
        function updateTodaySickLeave() {
            const container = document.getElementById('todaySickLeave');
            const today = currentDate;
            
            const todaySickRequests = leaveRequests.filter(req => 
                req.status === 'approved' && 
                req.date === today && 
                req.leaveType === 'Sick Leave'
            );
            
            if (todaySickRequests.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-success">
                        <strong>No sick leave today</strong><br>
                        All staff are healthy!
                    </div>
                `;
                return;
            }
            
            let html = '<div class="table-container"><table><thead><tr><th>Staff</th><th>RC</th><th>Duty Time</th><th>Duration</th></tr></thead><tbody>';
            
            todaySickRequests.forEach(req => {
                const staff = allStaff.find(s => s.username === req.fromUsername) || { name: req.fromName, rcNo: req.fromRcNo };
                const dutyTime = dutyRoster[today] ? dutyRoster[today][req.fromUsername] : 'Not scheduled';
                
                html += `
                    <tr>
                        <td><strong>${staff.name}</strong></td>
                        <td>${staff.rcNo}</td>
                        <td>${formatDutyTime(dutyTime)}</td>
                        <td><span class="status-badge status-sick">${req.duration} day(s)</span></td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        // Update today's FRL display
        function updateTodayFRL() {
            const container = document.getElementById('todayFRL');
            const today = currentDate;
            
            const todayFRLRequests = leaveRequests.filter(req => 
                req.status === 'approved' && 
                req.date === today && 
                req.leaveType === 'FRL'
            );
            
            if (todayFRLRequests.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-success">
                        <strong>No FRL today</strong><br>
                        All staff are available!
                    </div>
                `;
                return;
            }
            
            let html = '<div class="table-container"><table><thead><tr><th>Staff</th><th>RC</th><th>Duty Time</th><th>Duration</th></tr></thead><tbody>';
            
            todayFRLRequests.forEach(req => {
                const staff = allStaff.find(s => s.username === req.fromUsername) || { name: req.fromName, rcNo: req.fromRcNo };
                const dutyTime = dutyRoster[today] ? dutyRoster[today][req.fromUsername] : 'Not scheduled';
                
                html += `
                    <tr>
                        <td><strong>${staff.name}</strong></td>
                        <td>${staff.rcNo}</td>
                        <td>${formatDutyTime(dutyTime)}</td>
                        <td><span class="status-badge status-frl">${req.duration} day(s)</span></td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        // Update duty changes
        function updateDutyChanges() {
            const container = document.getElementById('dutyChanges');
            const today = currentDate;
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowStr = tomorrow.toISOString().split('T')[0];
            
            const recentChanges = allRequests.filter(req => 
                req.type === 'dutyChange' && 
                req.status === 'approved' && 
                (req.date === today || req.date === tomorrowStr)
            ).slice(0, 5); // Show only 5 most recent
            
            if (recentChanges.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-success">
                        <strong>No recent duty changes</strong><br>
                        All duties are as scheduled
                    </div>
                `;
                return;
            }
            
            let html = '';
            recentChanges.forEach(req => {
                const isToday = req.date === today;
                const dateLabel = isToday ? 'Today' : 'Tomorrow';
                
                html += `
                    <div class="staff-card" style="margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <div style="font-weight: 600; color: #2c3e50;">${dateLabel} (${req.date})</div>
                                <div style="font-size: 13px; margin-top: 5px;">
                                    ${req.fromName} ‚Üî ${req.toName}
                                </div>
                                <div style="font-size: 12px; color: #666; margin-top: 3px;">
                                    ${req.dutyTime} ‚Üí ${req.toDutyTime}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <span class="status-badge status-approved">Approved</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Update staff status overview
        function updateStaffStatusOverview() {
            const container = document.getElementById('staffStatusOverview');
            const today = currentDate;
            
            if (allStaff.length === 0) {
                container.innerHTML = '<div class="alert alert-warning">No staff data available</div>';
                return;
            }
            
            let html = '<div class="table-container"><table><thead><tr><th>Staff</th><th>RC</th><th>Duty Time</th><th>Status</th><th>Shift</th></tr></thead><tbody>';
            
            allStaff.forEach(staff => {
                let dutyTime = 'Not scheduled';
                let status = 'On Duty';
                let statusClass = 'status-approved';
                let shift = '';
                let shiftBadge = '';
                
                if (dutyRoster[today] && dutyRoster[today][staff.username]) {
                    dutyTime = dutyRoster[today][staff.username];
                    
                    // Determine shift
                    if (SHIFT_TIMINGS.MORNING.includes(dutyTime)) {
                        shift = 'Morning';
                        shiftBadge = 'duty-morning';
                    } else if (SHIFT_TIMINGS.AFTERNOON.includes(dutyTime)) {
                        shift = 'Afternoon';
                        shiftBadge = 'duty-afternoon';
                    } else if (SHIFT_TIMINGS.NIGHT.includes(dutyTime)) {
                        shift = 'Night';
                        shiftBadge = 'duty-night';
                    } else if (dutyTime === 'Off') {
                        shift = 'Off';
                        shiftBadge = '';
                    }
                    
                    // Check if staff is on leave
                    const onLeave = leaveRequests.find(req => 
                        req.status === 'approved' && 
                        req.date === today && 
                        req.fromUsername === staff.username
                    );
                    
                    if (onLeave) {
                        status = onLeave.leaveType;
                        statusClass = onLeave.leaveType === 'Sick Leave' ? 'status-sick' : 'status-frl';
                    }
                }
                
                html += `
                    <tr>
                        <td><strong>${staff.name}</strong></td>
                        <td>${staff.rcNo}</td>
                        <td>${formatDutyTime(dutyTime)}</td>
                        <td><span class="status-badge ${statusClass}">${status}</span></td>
                        <td>${shiftBadge ? `<span class="duty-badge ${shiftBadge}">${shift}</span>` : shift}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        // Submit phone-reported leave
        async function submitPhoneLeave(event) {
            event.preventDefault();
            
            if (!isOnline) {
                document.getElementById('phoneFormAlert').textContent = 'Cannot submit while offline. Please check your internet connection.';
                document.getElementById('phoneFormAlert').className = 'alert alert-danger';
                document.getElementById('phoneFormAlert').style.display = 'block';
                return;
            }
            
            const staffName = document.getElementById('phoneStaffName').value.trim();
            const rcNo = document.getElementById('phoneStaffRC').value.trim();
            const leaveType = document.getElementById('phoneLeaveType').value;
            const leaveDate = document.getElementById('phoneLeaveDate').value;
            const dutyTime = document.getElementById('phoneDutyTime').value;
            const duration = document.getElementById('phoneDuration').value;
            const reason = document.getElementById('phoneReason').value.trim();
            const reportedBy = document.getElementById('phoneReportedBy').value.trim();
            const contact = document.getElementById('phoneContact').value.trim();
            
            // Validation
            if (!staffName || !rcNo || !leaveType || !leaveDate || !dutyTime || !reason || !reportedBy) {
                document.getElementById('phoneFormAlert').style.display = 'block';
                document.getElementById('phoneFormAlert').textContent = 'Please fill all required fields marked with *';
                document.getElementById('phoneFormAlert').className = 'alert alert-danger';
                return;
            }
            
            // Disable submit button
            const submitBtn = document.getElementById('submitPhoneBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = 'üìû Submitting...';
            
            try {
                // Create leave request
                const leaveRequest = {
                    id: 'phone_' + Date.now(),
                    type: 'leave',
                    leaveType: leaveType,
                    fromUsername: staffName.toLowerCase().replace(/\s+/g, ''),
                    fromName: staffName,
                    fromRcNo: rcNo,
                    date: leaveDate,
                    dutyTime: dutyTime,
                    duration: parseFloat(duration),
                    reason: reason,
                    status: 'pending',
                    source: 'phone',
                    reportedBy: reportedBy,
                    contact: contact,
                    timestamp: new Date().toISOString(),
                    history: [{
                        action: 'phone_reported',
                        by: reportedBy,
                        timestamp: new Date().toISOString(),
                        note: 'Reported via phone'
                    }]
                };
                
                // Add to all requests
                allRequests.push(leaveRequest);
                leaveRequests.push(leaveRequest);
                
                // Save to Firebase
                await db.collection('requests').doc('all').set({ requests: allRequests });
                
                // Show success message
                document.getElementById('phoneFormSuccess').style.display = 'block';
                document.getElementById('phoneFormAlert').style.display = 'none';
                
                // Clear form
                clearPhoneForm();
                
                // Update displays
                updateAllDisplays();
                
                console.log('Phone-reported leave submitted:', leaveRequest);
                
                // Hide success message after 5 seconds
                setTimeout(() => {
                    document.getElementById('phoneFormSuccess').style.display = 'none';
                }, 5000);
                
            } catch (error) {
                console.error('Error saving phone leave:', error);
                document.getElementById('phoneFormAlert').textContent = `Error saving leave request: ${error.message}. Please try again.`;
                document.getElementById('phoneFormAlert').className = 'alert alert-danger';
                document.getElementById('phoneFormAlert').style.display = 'block';
            } finally {
                // Re-enable submit button
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'üìû Submit Phone-Reported Leave';
            }
        }

        // Clear phone form
        function clearPhoneForm() {
            document.getElementById('phoneLeaveForm').reset();
            document.getElementById('phoneLeaveDate').value = currentDate;
            document.getElementById('phoneFormAlert').style.display = 'block';
            document.getElementById('phoneFormAlert').textContent = 'Fill in all required fields marked with *';
            document.getElementById('phoneFormAlert').className = 'alert alert-warning';
        }

        // Update date/time display
        function updateDateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            });
            const dateStr = now.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            document.getElementById('currentTime').textContent = timeStr;
            document.getElementById('currentDate').textContent = dateStr;
            
            // Update current shift every minute
            if (now.getSeconds() === 0) {
                updateCurrentShift();
            }
        }

        // Update last updated time
        function updateLastUpdatedTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            });
            document.getElementById('lastUpdatedTime').textContent = timeStr;
        }

        // Start auto-refresh
        function startAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            
            refreshInterval = setInterval(() => {
                if (isOnline && db) {
                    loadAllData();
                    console.log('Auto-refreshing data...');
                }
            }, 30000); // Refresh every 30 seconds
        }

        // Show error message
        function showErrorMessage(message) {
            const header = document.querySelector('.header');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-danger';
            errorDiv.textContent = message;
            errorDiv.style.marginTop = '10px';
            
            // Remove any existing error
            const existingError = header.querySelector('.alert-danger');
            if (existingError) {
                existingError.remove();
            }
            
            header.appendChild(errorDiv);
            
            // Auto-remove after 10 seconds
            setTimeout(() => {
                errorDiv.remove();
            }, 10000);
        }

        // Utility functions
        function formatDutyTime(dutyTime) {
            if (!dutyTime || dutyTime === 'Not scheduled' || dutyTime === 'Off') {
                return dutyTime;
            }
            
            // Format as HH:MM - HH:MM
            if (dutyTime.includes('-')) {
                const [start, end] = dutyTime.split('-');
                const formatTime = (timeStr) => {
                    if (timeStr.length === 4) {
                        return timeStr.slice(0, 2) + ':' + timeStr.slice(2);
                    }
                    return timeStr;
                };
                return `${formatTime(start)} - ${formatTime(end)}`;
            }
            
            return dutyTime;
        }

        // Manual refresh function
        window.loadAllData = function() {
            if (db) {
                loadAllData();
            } else {
                showErrorMessage('Firebase not available. Please check your connection.');
            }
        };
    </script>
</body>
</html>
