<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duty Staff Dashboard - General View</title>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        body {
            background: #f5f7fa;
            min-height: 100vh;
            padding: 20px;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 20px 30px;
            border-radius: 15px 15px 0 0;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .current-time {
            display: flex;
            gap: 15px;
            font-size: 13px;
            margin-top: 10px;
        }

        /* Dashboard Container */
        .dashboard-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        @media (min-width: 1200px) {
            .dashboard-container {
                grid-template-columns: 1fr 1fr;
            }
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border: 1px solid #e0e6ed;
            margin-bottom: 20px;
        }

        .card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 16px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .refresh-btn {
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            margin-top: 10px;
            border: 1px solid #e0e6ed;
            border-radius: 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #e0e6ed;
            font-size: 12px;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }

        tr:hover {
            background: #f8f9fa;
        }

        /* Status Indicators */
        .status-pending {
            color: #f39c12;
            font-weight: 500;
        }

        .status-approved {
            color: #27ae60;
            font-weight: 500;
        }

        .status-rejected {
            color: #e74c3c;
            font-weight: 500;
        }

        .status-on-leave {
            color: #e74c3c;
            font-weight: bold;
            background: #ffebee;
            padding: 2px 6px;
            border-radius: 3px;
        }

        .status-duty-change {
            color: #3498db;
            font-weight: bold;
            background: #e8f4fc;
            padding: 2px 6px;
            border-radius: 3px;
        }

        /* Filters */
        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-group label {
            display: block;
            color: #2c3e50;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .filter-control {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #e0e6ed;
            border-radius: 6px;
            font-size: 13px;
        }

        /* Today's Highlights */
        .highlights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .highlight-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #e0e6ed;
        }

        .highlight-value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
            margin: 5px 0;
        }

        .highlight-label {
            font-size: 12px;
            color: #7f8c8d;
            text-transform: uppercase;
        }

        /* Form for Manual Leave Entry */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            color: #2c3e50;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e0e6ed;
            border-radius: 6px;
            font-size: 14px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #219653;
        }

        /* Alerts */
        .alert {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid;
            font-size: 13px;
        }

        .alert-info {
            background: #e8f4fc;
            border-color: #3498db;
            color: #2c3e50;
        }

        .alert-success {
            background: #d4edda;
            border-color: #27ae60;
            color: #155724;
        }

        .alert-warning {
            background: #fff3cd;
            border-color: #f39c12;
            color: #856404;
        }

        /* Staff List */
        .staff-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .staff-tag {
            background: #f0f0f0;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .staff-tag.on-leave {
            background: #ffebee;
            color: #e74c3c;
            border-left: 3px solid #e74c3c;
        }

        .staff-tag.duty-change {
            background: #e8f4fc;
            color: #3498db;
            border-left: 3px solid #3498db;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 30px;
            color: #7f8c8d;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Duty Change Details */
        .change-details {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
            margin-top: 5px;
            font-size: 11px;
        }

        .change-details strong {
            color: #2c3e50;
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .action-btn.print {
            background: #6c757d;
            color: white;
        }

        .action-btn.export {
            background: #17a2b8;
            color: white;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>Duty Staff Dashboard</h1>
        <p>General View - Duty Changes & Leave Status</p>
        <div class="current-time">
            <span id="currentDate">Loading...</span>
            <span id="currentTime">00:00:00</span>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="dashboard-container">
        <!-- Left Column -->
        <div>
            <!-- Today's Highlights -->
            <div class="card">
                <h3>Today's Overview <span id="todayDate"></span></h3>
                <div class="highlights-grid">
                    <div class="highlight-box">
                        <div class="highlight-label">On Duty</div>
                        <div class="highlight-value" id="onDutyCount">0</div>
                    </div>
                    <div class="highlight-box">
                        <div class="highlight-label">On Sick Leave</div>
                        <div class="highlight-value" id="sickLeaveCount">0</div>
                    </div>
                    <div class="highlight-box">
                        <div class="highlight-label">On FRL</div>
                        <div class="highlight-value" id="frlCount">0</div>
                    </div>
                    <div class="highlight-box">
                        <div class="highlight-label">Duty Changes</div>
                        <div class="highlight-value" id="dutyChangesCount">0</div>
                    </div>
                </div>
            </div>

            <!-- Quick Staff Status -->
            <div class="card">
                <h3>Staff Status Today</h3>
                <div id="staffStatusList" class="staff-list">
                    <!-- Staff status will be loaded here -->
                </div>
            </div>

            <!-- Manual Leave Entry -->
            <div class="card">
                <h3>Report Leave (Phone/Manual Entry)</h3>
                <div class="alert alert-info">
                    Use this form to enter leave for staff who report by phone or other means.
                </div>
                
                <form id="manualLeaveForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="leaveStaff">Staff Name *</label>
                            <select id="leaveStaff" class="form-control" required>
                                <option value="">Select staff member</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="leaveType">Leave Type *</label>
                            <select id="leaveType" class="form-control" required>
                                <option value="">Select type</option>
                                <option value="Sick Leave">Sick Leave</option>
                                <option value="FRL">FRL</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="leaveDate">Leave Date *</label>
                            <input type="date" id="leaveDate" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="leaveDuration">Duration *</label>
                            <select id="leaveDuration" class="form-control" required>
                                <option value="1">1 Day</option>
                                <option value="0.5">Half Day</option>
                                <option value="2">2 Days</option>
                                <option value="3">3 Days</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="leaveReason">Reason/Details *</label>
                        <textarea id="leaveReason" class="form-control" rows="3" placeholder="Enter reason for leave (include who reported it, time, etc.)" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="reportedBy">Reported By</label>
                        <input type="text" id="reportedBy" class="form-control" placeholder="Your name/initials">
                    </div>
                    
                    <button type="submit" class="btn btn-success">Submit Leave Entry</button>
                </form>
            </div>
        </div>

        <!-- Right Column -->
        <div>
            <!-- Approved Duty Changes -->
            <div class="card">
                <h3>Approved Duty Changes <button class="refresh-btn" onclick="loadDutyChanges()">âŸ³</button></h3>
                <div class="filters">
                    <div class="filter-group">
                        <label for="changeDateFilter">Date</label>
                        <input type="date" id="changeDateFilter" class="filter-control">
                    </div>
                    <div class="filter-group">
                        <label for="changeStaffFilter">Staff</label>
                        <select id="changeStaffFilter" class="filter-control">
                            <option value="">All Staff</option>
                        </select>
                    </div>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Staff Involved</th>
                                <th>Change Details</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="dutyChangesTable">
                            <!-- Duty changes will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Current Leave Status -->
            <div class="card">
                <h3>Current Leave Status <button class="refresh-btn" onclick="loadLeaveStatus()">âŸ³</button></h3>
                <div class="filters">
                    <div class="filter-group">
                        <label for="leaveDateFilter">Date</label>
                        <input type="date" id="leaveDateFilter" class="filter-control">
                    </div>
                    <div class="filter-group">
                        <label for="leaveTypeFilter">Leave Type</label>
                        <select id="leaveTypeFilter" class="filter-control">
                            <option value="">All Types</option>
                            <option value="Sick Leave">Sick Leave</option>
                            <option value="FRL">FRL</option>
                        </select>
                    </div>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Staff</th>
                                <th>Leave Type</th>
                                <th>Date</th>
                                <th>Duration</th>
                                <th>Reason</th>
                                <th>Reported By</th>
                            </tr>
                        </thead>
                        <tbody id="leaveStatusTable">
                            <!-- Leave status will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Duty Roster (Today) -->
            <div class="card">
                <h3>Today's Duty Roster</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Staff</th>
                                <th>Scheduled Duty</th>
                                <th>Actual Duty</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody id="todayRosterTable">
                            <!-- Today's roster will be loaded here -->
                        </tbody>
                    </table>
                </div>
                <div class="quick-actions">
                    <button class="action-btn print" onclick="printReport()">
                        ðŸ“„ Print Report
                    </button>
                    <button class="action-btn export" onclick="exportToExcel()">
                        ðŸ“Š Export to Excel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="loadingIndicator" class="loading" style="display: none;">
        <div class="spinner"></div>
        <p>Loading data...</p>
    </div>

    <script>
        // Firebase Configuration (Use your actual config)
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            projectId: "YOUR_PROJECT",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Global variables
        let allUsers = [];
        let dutyRoster = {};
        let allRequests = [];
        let leaveBalances = {};
        let today = new Date().toISOString().split('T')[0];

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing Duty Staff Dashboard...');
            
            // Update current date and time
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            
            // Set default dates
            document.getElementById('leaveDate').value = today;
            document.getElementById('changeDateFilter').value = today;
            document.getElementById('leaveDateFilter').value = today;
            document.getElementById('todayDate').textContent = formatDate(today);
            
            // Initialize page
            initializePage();
            
            // Setup event listeners
            document.getElementById('manualLeaveForm').addEventListener('submit', function(e) {
                e.preventDefault();
                submitManualLeave();
            });
            
            document.getElementById('changeDateFilter').addEventListener('change', loadDutyChanges);
            document.getElementById('changeStaffFilter').addEventListener('change', loadDutyChanges);
            document.getElementById('leaveDateFilter').addEventListener('change', loadLeaveStatus);
            document.getElementById('leaveTypeFilter').addEventListener('change', loadLeaveStatus);
        });

        function updateCurrentTime() {
            const now = new Date();
            document.getElementById('currentDate').textContent = now.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('en-US', {
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        async function initializePage() {
            showLoading(true);
            
            try {
                // Load all data
                await Promise.all([
                    loadUsers(),
                    loadDutyRoster(),
                    loadAllRequests(),
                    loadLeaveBalances()
                ]);
                
                // Populate staff dropdowns
                populateStaffDropdowns();
                
                // Load all sections
                loadTodayOverview();
                loadDutyChanges();
                loadLeaveStatus();
                loadTodayRoster();
                loadStaffStatus();
                
                showLoading(false);
                console.log('Page initialized successfully');
                
            } catch (error) {
                console.error('Error initializing page:', error);
                showLoading(false);
                alert('Failed to load data. Please refresh the page.');
            }
        }

        function showLoading(show) {
            document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
        }

        // FIREBASE FUNCTIONS
        async function loadUsers() {
            try {
                // Try to load users from Firestore first
                const snapshot = await db.collection('users').get();
                if (!snapshot.empty) {
                    allUsers = snapshot.docs.map(doc => doc.data());
                } else {
                    // Fallback to default users if none in Firestore
                    allUsers = [
                        { username: 'irufan1', name: 'Irufan', RCNo: '001', Level: 'User' },
                        { username: 'hussain1', name: 'Hussain', RCNo: '002', Level: 'User' },
                        { username: 'mohamed1', name: 'Mohamed', RCNo: '003', Level: 'User' },
                        { username: 'staff4', name: 'Staff 4', RCNo: '004', Level: 'User' },
                        { username: 'staff5', name: 'Staff 5', RCNo: '005', Level: 'User' }
                    ];
                }
                console.log('Users loaded:', allUsers.length);
            } catch (error) {
                console.error('Error loading users:', error);
                allUsers = [];
            }
        }

        async function loadDutyRoster() {
            try {
                const doc = await db.collection('dutyRoster').doc('current').get();
                if (doc.exists) {
                    dutyRoster = doc.data() || {};
                    console.log('Duty roster loaded:', Object.keys(dutyRoster).length, 'dates');
                } else {
                    dutyRoster = {};
                }
            } catch (error) {
                console.error('Error loading duty roster:', error);
                dutyRoster = {};
            }
        }

        async function loadAllRequests() {
            try {
                const doc = await db.collection('requests').doc('all').get();
                if (doc.exists && doc.data().requests) {
                    allRequests = doc.data().requests;
                    console.log('Requests loaded:', allRequests.length);
                } else {
                    allRequests = [];
                }
            } catch (error) {
                console.error('Error loading requests:', error);
                allRequests = [];
            }
        }

        async function loadLeaveBalances() {
            try {
                const doc = await db.collection('leaveBalances').doc('current').get();
                if (doc.exists) {
                    leaveBalances = doc.data() || {};
                    console.log('Leave balances loaded:', Object.keys(leaveBalances).length, 'users');
                } else {
                    leaveBalances = {};
                }
            } catch (error) {
                console.error('Error loading leave balances:', error);
                leaveBalances = {};
            }
        }

        // DATA DISPLAY FUNCTIONS
        function populateStaffDropdowns() {
            const leaveStaffSelect = document.getElementById('leaveStaff');
            const changeStaffFilter = document.getElementById('changeStaffFilter');
            
            leaveStaffSelect.innerHTML = '<option value="">Select staff member</option>';
            changeStaffFilter.innerHTML = '<option value="">All Staff</option>';
            
            allUsers.forEach(user => {
                const option1 = document.createElement('option');
                option1.value = user.username;
                option1.textContent = `${user.name} (${user.RCNo})`;
                leaveStaffSelect.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = user.username;
                option2.textContent = `${user.name} (${user.RCNo})`;
                changeStaffFilter.appendChild(option2.cloneNode(true));
            });
        }

        function loadTodayOverview() {
            const todayDate = today;
            
            // Count staff on duty
            let onDutyCount = 0;
            let sickLeaveCount = 0;
            let frlCount = 0;
            
            allUsers.forEach(user => {
                if (user.Level === 'User') {
                    // Check for approved leave
                    const approvedLeave = allRequests.find(req => 
                        req.fromUsername === user.username &&
                        req.type === 'leave' &&
                        req.status === 'approved' &&
                        req.date === todayDate
                    );
                    
                    if (approvedLeave) {
                        if (approvedLeave.leaveType === 'Sick Leave') {
                            sickLeaveCount++;
                        } else if (approvedLeave.leaveType === 'FRL') {
                            frlCount++;
                        }
                    } else if (dutyRoster[todayDate] && dutyRoster[todayDate][user.username]) {
                        if (dutyRoster[todayDate][user.username] !== 'Off') {
                            onDutyCount++;
                        }
                    }
                }
            });
            
            // Count duty changes for today
            const dutyChangesCount = allRequests.filter(req => 
                req.type === 'dutyChange' && 
                req.status === 'approved' && 
                req.date === todayDate
            ).length;
            
            // Update display
            document.getElementById('onDutyCount').textContent = onDutyCount;
            document.getElementById('sickLeaveCount').textContent = sickLeaveCount;
            document.getElementById('frlCount').textContent = frlCount;
            document.getElementById('dutyChangesCount').textContent = dutyChangesCount;
        }

        function loadDutyChanges() {
            const dateFilter = document.getElementById('changeDateFilter').value || today;
            const staffFilter = document.getElementById('changeStaffFilter').value;
            
            const tbody = document.getElementById('dutyChangesTable');
            tbody.innerHTML = '';
            
            const approvedChanges = allRequests.filter(req => 
                req.type === 'dutyChange' && 
                req.status === 'approved' &&
                (!dateFilter || req.date === dateFilter) &&
                (!staffFilter || req.fromUsername === staffFilter || req.toUsername === staffFilter)
            );
            
            if (approvedChanges.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" style="text-align: center;">No approved duty changes found</td></tr>`;
                return;
            }
            
            approvedChanges.forEach(change => {
                const tr = document.createElement('tr');
                
                const fromUser = allUsers.find(u => u.username === change.fromUsername);
                const toUser = allUsers.find(u => u.username === change.toUsername);
                
                const changeDetails = `
                    <div class="change-details">
                        <strong>${fromUser ? fromUser.name : change.fromUsername}</strong> (${change.dutyTime}) 
                        â†” 
                        <strong>${toUser ? toUser.name : change.toUsername}</strong> (${change.toDutyTime})
                        ${change.reason ? `<br><small>Reason: ${change.reason}</small>` : ''}
                    </div>
                `;
                
                tr.innerHTML = `
                    <td>${change.date}</td>
                    <td>${fromUser ? fromUser.name : change.fromUsername} â†” ${toUser ? toUser.name : change.toUsername}</td>
                    <td>${changeDetails}</td>
                    <td class="status-approved">Approved</td>
                `;
                
                tbody.appendChild(tr);
            });
        }

        function loadLeaveStatus() {
            const dateFilter = document.getElementById('leaveDateFilter').value || today;
            const typeFilter = document.getElementById('leaveTypeFilter').value;
            
            const tbody = document.getElementById('leaveStatusTable');
            tbody.innerHTML = '';
            
            const leaveRequests = allRequests.filter(req => 
                req.type === 'leave' && 
                req.status === 'approved' &&
                (!dateFilter || req.date === dateFilter) &&
                (!typeFilter || req.leaveType === typeFilter)
            );
            
            if (leaveRequests.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align: center;">No leave records found</td></tr>`;
                return;
            }
            
            leaveRequests.forEach(leave => {
                const tr = document.createElement('tr');
                
                const user = allUsers.find(u => u.username === leave.fromUsername);
                const reportedBy = leave.reportedBy || leave.approvedBy || 'System';
                
                tr.innerHTML = `
                    <td>${user ? user.name : leave.fromUsername}</td>
                    <td>${leave.leaveType}</td>
                    <td>${leave.date}</td>
                    <td>${leave.duration} day(s)</td>
                    <td>${leave.reason || 'No reason provided'}</td>
                    <td>${reportedBy}</td>
                `;
                
                tbody.appendChild(tr);
            });
        }

        function loadTodayRoster() {
            const tbody = document.getElementById('todayRosterTable');
            tbody.innerHTML = '';
            
            allUsers.forEach(user => {
                if (user.Level === 'User') {
                    const tr = document.createElement('tr');
                    
                    // Get scheduled duty
                    const scheduledDuty = dutyRoster[today] && dutyRoster[today][user.username] ?
                        dutyRoster[today][user.username] : 'Not Scheduled';
                    
                    // Check for approved leave
                    const approvedLeave = allRequests.find(req => 
                        req.fromUsername === user.username &&
                        req.type === 'leave' &&
                        req.status === 'approved' &&
                        req.date === today
                    );
                    
                    let actualDuty = scheduledDuty;
                    let notes = '';
                    
                    if (approvedLeave) {
                        actualDuty = `${approvedLeave.leaveType}`;
                        notes = `On leave: ${approvedLeave.reason || 'No reason provided'}`;
                    } else if (scheduledDuty === 'Off') {
                        actualDuty = 'Off Duty';
                    }
                    
                    // Check for duty changes affecting this staff
                    const dutyChange = allRequests.find(req => 
                        req.type === 'dutyChange' &&
                        req.status === 'approved' &&
                        req.date === today &&
                        (req.fromUsername === user.username || req.toUsername === user.username)
                    );
                    
                    if (dutyChange) {
                        const otherUser = allUsers.find(u => u.username === 
                            (dutyChange.fromUsername === user.username ? dutyChange.toUsername : dutyChange.fromUsername));
                        notes = `Swapped with ${otherUser ? otherUser.name : 'another staff'}`;
                        actualDuty = user.username === dutyChange.fromUsername ? 
                            dutyChange.toDutyTime : dutyChange.dutyTime;
                    }
                    
                    tr.innerHTML = `
                        <td>${user.name} (${user.RCNo})</td>
                        <td>${scheduledDuty}</td>
                        <td>${actualDuty}</td>
                        <td>${notes}</td>
                    `;
                    
                    tbody.appendChild(tr);
                }
            });
        }

        function loadStaffStatus() {
            const container = document.getElementById('staffStatusList');
            container.innerHTML = '';
            
            allUsers.forEach(user => {
                if (user.Level === 'User') {
                    const tag = document.createElement('div');
                    tag.className = 'staff-tag';
                    
                    // Check for approved leave
                    const approvedLeave = allRequests.find(req => 
                        req.fromUsername === user.username &&
                        req.type === 'leave' &&
                        req.status === 'approved' &&
                        req.date === today
                    );
                    
                    // Check for duty changes
                    const dutyChange = allRequests.find(req => 
                        req.type === 'dutyChange' &&
                        req.status === 'approved' &&
                        req.date === today &&
                        (req.fromUsername === user.username || req.toUsername === user.username)
                    );
                    
                    if (approvedLeave) {
                        tag.className += ' on-leave';
                        tag.innerHTML = `${user.name} (${approvedLeave.leaveType === 'Sick Leave' ? 'SL' : 'FRL'})`;
                    } else if (dutyChange) {
                        tag.className += ' duty-change';
                        tag.innerHTML = `${user.name} (Changed)`;
                    } else {
                        tag.innerHTML = user.name;
                    }
                    
                    container.appendChild(tag);
                }
            });
        }

        async function submitManualLeave() {
            const staff = document.getElementById('leaveStaff').value;
            const leaveType = document.getElementById('leaveType').value;
            const date = document.getElementById('leaveDate').value;
            const duration = parseFloat(document.getElementById('leaveDuration').value);
            const reason = document.getElementById('leaveReason').value.trim();
            const reportedBy = document.getElementById('reportedBy').value.trim();
            
            if (!staff || !leaveType || !date || !reason) {
                alert('Please fill in all required fields');
                return;
            }
            
            if (!confirm(`Submit ${leaveType} for selected staff on ${date}?`)) {
                return;
            }
            
            try {
                // Create leave request
                const leaveRequest = {
                    id: 'manual_' + Date.now(),
                    type: 'leave',
                    leaveType: leaveType,
                    fromUsername: staff,
                    fromName: allUsers.find(u => u.username === staff)?.name || staff,
                    fromRcNo: allUsers.find(u => u.username === staff)?.RCNo || '',
                    date: date,
                    dutyTime: 'Manual Entry',
                    duration: duration,
                    reason: reason,
                    reportedBy: reportedBy || 'Duty Staff',
                    status: 'approved',
                    timestamp: new Date().toISOString(),
                    approvedBy: 'Duty Staff (Manual Entry)',
                    approvedAt: new Date().toISOString(),
                    history: [{
                        action: 'created_manually',
                        by: reportedBy || 'Duty Staff',
                        timestamp: new Date().toISOString()
                    }]
                };
                
                // Add to requests
                allRequests.push(leaveRequest);
                
                // Update leave balance if applicable
                if (leaveType === 'Sick Leave' || leaveType === 'FRL') {
                    const balanceType = leaveType === 'Sick Leave' ? 'SL' : 'FRL';
                    if (!leaveBalances[staff]) {
                        leaveBalances[staff] = {SL: 12, FRL: 6};
                    }
                    leaveBalances[staff][balanceType] = Math.max(0, 
                        (leaveBalances[staff][balanceType] || 0) - duration
                    );
                    
                    // Save updated balances
                    await db.collection('leaveBalances').doc('current').set(leaveBalances);
                }
                
                // Save updated requests
                await db.collection('requests').doc('all').set({ requests: allRequests });
                
                alert(`${leaveType} recorded successfully for staff!`);
                
                // Clear form
                document.getElementById('manualLeaveForm').reset();
                document.getElementById('leaveDate').value = today;
                
                // Refresh displays
                loadTodayOverview();
                loadLeaveStatus();
                loadTodayRoster();
                loadStaffStatus();
                
            } catch (error) {
                console.error('Error submitting leave:', error);
                alert('Failed to submit leave. Please try again.');
            }
        }

        function printReport() {
            const printWindow = window.open('', '_blank');
            const todayFormatted = formatDate(today);
            
            printWindow.document.write(`
                <html>
                <head>
                    <title>Duty Staff Report - ${todayFormatted}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        h1 { color: #2c3e50; margin-bottom: 20px; }
                        h3 { color: #3498db; margin-top: 30px; }
                        table { border-collapse: collapse; width: 100%; margin-top: 10px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 12px; }
                        th { background-color: #f2f2f2; }
                        .status-approved { color: #27ae60; }
                        .summary { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin: 20px 0; }
                        .summary-box { border: 1px solid #ddd; padding: 15px; text-align: center; }
                        .footer { margin-top: 30px; font-size: 11px; color: #666; }
                    </style>
                </head>
                <body>
                    <h1>Duty Staff Report</h1>
                    <p><strong>Date:</strong> ${todayFormatted}</p>
                    <p><strong>Generated:</strong> ${new Date().toLocaleString()}</p>
                    
                    <div class="summary">
                        <div class="summary-box">
                            <strong>On Duty</strong><br>
                            <span style="font-size: 24px;">${document.getElementById('onDutyCount').textContent}</span>
                        </div>
                        <div class="summary-box">
                            <strong>Sick Leave</strong><br>
                            <span style="font-size: 24px;">${document.getElementById('sickLeaveCount').textContent}</span>
                        </div>
                        <div class="summary-box">
                            <strong>FRL</strong><br>
                            <span style="font-size: 24px;">${document.getElementById('frlCount').textContent}</span>
                        </div>
                        <div class="summary-box">
                            <strong>Duty Changes</strong><br>
                            <span style="font-size: 24px;">${document.getElementById('dutyChangesCount').textContent}</span>
                        </div>
                    </div>
                    
                    <h3>Today's Duty Roster</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Staff</th>
                                <th>Scheduled Duty</th>
                                <th>Actual Duty</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${document.getElementById('todayRosterTable').innerHTML}
                        </tbody>
                    </table>
                    
                    <h3>Leave Status Today</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Staff</th>
                                <th>Leave Type</th>
                                <th>Duration</th>
                                <th>Reason</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${document.getElementById('leaveStatusTable').innerHTML}
                        </tbody>
                    </table>
                    
                    <div class="footer">
                        <p>Duty Staff Dashboard - General View</p>
                        <p>Report generated automatically</p>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        function exportToExcel() {
            // Simple CSV export
            let csvContent = "data:text/csv;charset=utf-8,";
            
            // Add headers
            csvContent += "Staff,RC No,Scheduled Duty,Actual Duty,Status,Leave Type,Notes\r\n";
            
            // Add data
            allUsers.forEach(user => {
                if (user.Level === 'User') {
                    const scheduledDuty = dutyRoster[today] && dutyRoster[today][user.username] ?
                        dutyRoster[today][user.username] : 'Not Scheduled';
                    
                    const approvedLeave = allRequests.find(req => 
                        req.fromUsername === user.username &&
                        req.type === 'leave' &&
                        req.status === 'approved' &&
                        req.date === today
                    );
                    
                    let actualDuty = scheduledDuty;
                    let status = 'On Duty';
                    let leaveType = '';
                    let notes = '';
                    
                    if (approvedLeave) {
                        actualDuty = approvedLeave.leaveType;
                        status = 'On Leave';
                        leaveType = approvedLeave.leaveType;
                        notes = approvedLeave.reason || '';
                    } else if (scheduledDuty === 'Off') {
                        status = 'Off Duty';
                        actualDuty = 'Off';
                    }
                    
                    const row = [
                        user.name,
                        user.RCNo,
                        scheduledDuty,
                        actualDuty,
                        status,
                        leaveType,
                        notes.replace(/,/g, ';') // Replace commas in notes to avoid CSV issues
                    ].join(',');
                    
                    csvContent += row + "\r\n";
                }
            });
            
            // Create download link
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `duty_staff_report_${today}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        // Auto-refresh data every 5 minutes
        setInterval(() => {
            console.log('Auto-refreshing data...');
            initializePage();
        }, 300000); // 5 minutes

        // Listen for changes in Firestore
        db.collection('requests').doc('all')
            .onSnapshot((doc) => {
                if (doc.exists && doc.data().requests) {
                    allRequests = doc.data().requests;
                    loadTodayOverview();
                    loadDutyChanges();
                    loadLeaveStatus();
                    loadTodayRoster();
                    loadStaffStatus();
                    console.log('Data updated from Firestore');
                }
            });
    </script>
</body>
</html>
