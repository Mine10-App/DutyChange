<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA Meta Tags -->
    <meta name="application-name" content="Duty Manager">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Duty Manager">
    <meta name="description" content="Duty and Leave Management System">
    <meta name="format-detection" content="telephone=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="msapplication-TileColor" content="#3498db">
    <meta name="msapplication-tap-highlight" content="no">
    <meta name="theme-color" content="#3498db">
    
    <!-- iOS PWA Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Duty Manager">
    
    <!-- Icons using Data URLs -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Ccircle cx='96' cy='96' r='90' fill='%233498db'/%3E%3Ccircle cx='96' cy='50' r='25' fill='white'/%3E%3Cpath d='M96,85 Q120,85 130,110 L62,110 Q72,85 96,85 Z' fill='white'/%3E%3Crect x='75' y='110' width='42' height='40' rx='10' fill='white'/%3E%3Cpath d='M30,30 L30,60 L45,45 Z' fill='%2327ae60'/%3E%3Ctext x='96' y='165' text-anchor='middle' fill='white' font-family='Arial' font-weight='bold' font-size='24'%3EDM%3C/text%3E%3C/svg%3E">
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Ccircle cx='96' cy='96' r='90' fill='%233498db'/%3E%3Ccircle cx='96' cy='50' r='25' fill='white'/%3E%3Cpath d='M96,85 Q120,85 130,110 L62,110 Q72,85 96,85 Z' fill='white'/%3E%3Crect x='75' y='110' width='42' height='40' rx='10' fill='white'/%3E%3Cpath d='M30,30 L30,60 L45,45 Z' fill='%2327ae60'/%3E%3Ctext x='96' y='165' text-anchor='middle' fill='white' font-family='Arial' font-weight='bold' font-size='24'%3EDM%3C/text%3E%3C/svg%3E" type="image/svg+xml">
    
    <!-- Splash Screens (iOS) -->
    <link rel="apple-touch-startup-image" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='320' height='568'%3E%3Crect width='320' height='568' fill='%233498db'/%3E%3Ccircle cx='160' cy='200' r='60' fill='white'/%3E%3Cpath d='M160,270 Q220,270 250,330 L70,330 Q100,270 160,270 Z' fill='white'/%3E%3Crect x='130' y='330' width='60' height='50' rx='10' fill='white'/%3E%3Ctext x='160' y='500' text-anchor='middle' fill='white' font-family='Arial' font-weight='bold' font-size='32'%3EDuty Manager%3C/text%3E%3C/svg%3E">
    
    <!-- Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <title>Duty Manager</title>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>
    
    <!-- SHA-256 Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js"></script>
    
    <!-- External files -->
    <script src="dcfire.js" defer></script>
    <script src="user.js" defer></script>
    
    <style>
        /* MOBILE-APP LIKE STYLES */
        :root {
            --primary: #3498db;
            --primary-dark: #2980b9;
            --secondary: #2c3e50;
            --success: #27ae60;
            --danger: #e74c3c;
            --warning: #f39c12;
            --info: #3498db;
            --light: #f5f7fa;
            --dark: #2c3e50;
            --gray: #95a5a6;
            --light-gray: #ecf0f1;
            --border: #e0e6ed;
            --card-bg: #ffffff;
            --sidebar-bg: #2c3e50;
            --input-bg: #f8f9fa;
            --shadow: 0 2px 10px rgba(0,0,0,0.08);
            --shadow-lg: 0 5px 20px rgba(0,0,0,0.12);
            --radius: 12px;
            --radius-sm: 8px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            background: var(--light);
            color: var(--dark);
            line-height: 1.5;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            height: 100vh;
            height: -webkit-fill-available;
        }

        /* iOS Safe Areas */
        .safe-area-top {
            padding-top: env(safe-area-inset-top);
        }

        .safe-area-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--primary);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.3s;
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-logo {
            width: 80px;
            height: 80px;
            background: white;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }

        .loading-logo svg {
            width: 50px;
            height: 50px;
        }

        .loading-text {
            color: white;
            font-size: 18px;
            font-weight: 600;
        }

        .loading-dots {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        .loading-dot {
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            opacity: 0.5;
            animation: dotPulse 1.4s infinite;
        }

        .loading-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .loading-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        /* App Container */
        .app-container {
            display: none;
            width: 100%;
            height: 100vh;
            height: -webkit-fill-available;
            background: var(--light);
            position: relative;
        }

        /* Header (iOS Style) */
        .app-header {
            height: 60px;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            padding: 0 15px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-left, .header-right {
            flex: 0 0 auto;
            display: flex;
            align-items: center;
        }

        .header-center {
            flex: 1;
            text-align: center;
            font-weight: 600;
            font-size: 17px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Side Navigation (Android Style) */
        .side-nav {
            position: fixed;
            top: 0;
            left: -280px;
            bottom: 0;
            width: 280px;
            background: var(--sidebar-bg);
            z-index: 1000;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 5px 0 15px rgba(0,0,0,0.1);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .side-nav.active {
            transform: translateX(280px);
        }

        .nav-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .nav-overlay.active {
            display: block;
            opacity: 1;
        }

        .nav-header {
            background: var(--primary);
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .nav-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            font-weight: bold;
        }

        .nav-user-info h3 {
            color: white;
            font-size: 18px;
            margin-bottom: 5px;
        }

        .nav-user-info p {
            color: rgba(255,255,255,0.8);
            font-size: 14px;
        }

        .nav-items {
            padding: 10px 0;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            color: white;
            text-decoration: none;
            transition: var(--transition);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .nav-item:hover, .nav-item.active {
            background: rgba(255,255,255,0.1);
        }

        .nav-icon {
            width: 24px;
            margin-right: 15px;
            font-size: 20px;
            text-align: center;
        }

        .nav-badge {
            margin-left: auto;
            background: var(--danger);
            color: white;
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 10px;
            min-width: 20px;
            text-align: center;
        }

        /* Bottom Navigation (Mobile App Style) */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-bg);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            border-top: 1px solid var(--border);
            z-index: 100;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }

        .bottom-nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px 0;
            color: var(--gray);
            text-decoration: none;
            transition: var(--transition);
        }

        .bottom-nav-item.active {
            color: var(--primary);
        }

        .bottom-nav-icon {
            font-size: 22px;
            margin-bottom: 4px;
        }

        .bottom-nav-label {
            font-size: 11px;
            font-weight: 500;
        }

        /* Main Content */
        .main-content {
            padding: 70px 0 60px;
            height: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .content-section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .content-section.active {
            display: block;
        }

        /* Cards (iOS Style) */
        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 20px;
            margin: 15px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary);
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--dark);
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px;
        }

        .stat-card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 15px;
            text-align: center;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: var(--primary);
            margin: 10px 0;
        }

        .stat-label {
            font-size: 13px;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Buttons (iOS Style) */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 14px 20px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            gap: 8px;
            -webkit-appearance: none;
            appearance: none;
            user-select: none;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        .btn-block {
            width: 100%;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin: 15px;
        }

        /* Forms (iOS Style) */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
            font-size: 15px;
        }

        .form-control {
            width: 100%;
            padding: 14px;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 16px;
            background: var(--input-bg);
            transition: var(--transition);
            -webkit-appearance: none;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .form-select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%237f8c8d' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14L2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 12px;
            padding-right: 40px;
        }

        /* Alerts (iOS Style) */
        .alert {
            padding: 15px;
            border-radius: var(--radius-sm);
            margin: 15px;
            border-left: 4px solid;
            background: var(--light-gray);
            font-size: 14px;
            line-height: 1.4;
        }

        .alert-info {
            border-color: var(--info);
            background: #e8f4fc;
        }

        .alert-success {
            border-color: var(--success);
            background: #d4edda;
        }

        .alert-warning {
            border-color: var(--warning);
            background: #fff3cd;
        }

        .alert-danger {
            border-color: var(--danger);
            background: #f8d7da;
        }

        /* Lists (iOS Style) */
        .list {
            background: var(--card-bg);
            border-radius: var(--radius);
            margin: 15px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .list-item {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: var(--transition);
        }

        .list-item:last-child {
            border-bottom: none;
        }

        .list-item:hover {
            background: var(--light-gray);
        }

        .list-item-content {
            flex: 1;
        }

        .list-item-title {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .list-item-subtitle {
            font-size: 13px;
            color: var(--gray);
        }

        /* Notifications */
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }

        /* Swipe Actions */
        .swipe-actions {
            display: flex;
            overflow: hidden;
        }

        .swipe-action {
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 500;
            min-width: 80px;
        }

        .swipe-action.approve {
            background: var(--success);
        }

        .swipe-action.reject {
            background: var(--danger);
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes dotPulse {
            0%, 60%, 100% { opacity: 0.5; }
            30% { opacity: 1; }
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        /* iOS Like Switches */
        .switch {
            position: relative;
            display: inline-block;
            width: 52px;
            height: 32px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: var(--transition);
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 24px;
            width: 24px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: var(--transition);
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary);
        }

        input:checked + .slider:before {
            transform: translateX(20px);
        }

        /* iOS Like Segmented Control */
        .segmented-control {
            display: flex;
            background: var(--light-gray);
            border-radius: var(--radius-sm);
            padding: 4px;
            margin: 15px;
        }

        .segment {
            flex: 1;
            padding: 10px;
            text-align: center;
            font-weight: 500;
            color: var(--gray);
            border-radius: var(--radius-sm);
            transition: var(--transition);
            cursor: pointer;
        }

        .segment.active {
            background: white;
            color: var(--primary);
            box-shadow: var(--shadow);
        }

        /* iOS Like Action Sheet */
        .action-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-radius: 20px 20px 0 0;
            padding: 20px;
            z-index: 1001;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 -5px 20px rgba(0,0,0,0.15);
        }

        .action-sheet.active {
            transform: translateY(0);
        }

        .action-sheet-title {
            text-align: center;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }

        .action-sheet-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .action-sheet-btn {
            padding: 16px;
            text-align: center;
            border-radius: var(--radius-sm);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }

        .action-sheet-btn.destructive {
            color: var(--danger);
        }

        .action-sheet-btn.cancel {
            color: var(--gray);
            border-top: 1px solid var(--border);
            margin-top: 10px;
            padding-top: 15px;
        }

        /* iOS Like Pull to Refresh */
        .pull-to-refresh {
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transform: translateY(-60px);
            transition: opacity 0.3s;
        }

        .pull-to-refresh.active {
            opacity: 1;
        }

        .refresh-spinner {
            width: 30px;
            height: 30px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--gray);
        }

        .empty-state-icon {
            font-size: 60px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--dark);
        }

        .empty-state-text {
            font-size: 14px;
            margin-bottom: 20px;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            max-width: calc(100% - 40px);
        }

        .toast {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInRight 0.3s ease;
            max-width: 350px;
            border-left: 4px solid;
        }

        .toast.success {
            border-color: var(--success);
        }

        .toast.error {
            border-color: var(--danger);
        }

        .toast.warning {
            border-color: var(--warning);
        }

        .toast.info {
            border-color: var(--info);
        }

        /* Responsive */
        @media (max-width: 767px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            .card {
                margin: 10px;
                padding: 15px;
            }
        }

        @media (min-width: 768px) {
            .app-container {
                max-width: 768px;
                margin: 0 auto;
                box-shadow: 0 0 20px rgba(0,0,0,0.1);
                border-radius: 20px;
                overflow: hidden;
                height: 90vh;
                margin-top: 5vh;
            }
            
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* Dark Mode Support */
        @media (prefers-color-scheme: dark) {
            :root {
                --primary: #3498db;
                --primary-dark: #2980b9;
                --secondary: #34495e;
                --light: #1a1a2e;
                --dark: #ecf0f1;
                --gray: #95a5a6;
                --light-gray: #2c3e50;
                --border: #34495e;
                --card-bg: #2c3e50;
                --sidebar-bg: #1a1a2e;
                --input-bg: #34495e;
            }
        }

        /* Install Prompt */
        .install-prompt {
            position: fixed;
            bottom: 80px;
            right: 15px;
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 15px;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            max-width: 300px;
            animation: bounce 2s infinite;
            border: 2px solid var(--primary);
        }

        .install-prompt.hidden {
            display: none;
        }

        /* Network Status */
        .network-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: var(--danger);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            display: none;
            align-items: center;
            gap: 5px;
            z-index: 1001;
            animation: fadeIn 0.3s;
        }

        .network-status.online {
            background: var(--success);
        }
    </style>
</head>
<body class="safe-area-top safe-area-bottom">
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-logo">
            <svg viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="45" fill="#3498db"/>
                <circle cx="50" cy="35" r="12" fill="white"/>
                <path d="M50,55 C65,55 70,70 70,70 L30,70 C30,70 35,55 50,55 Z" fill="white"/>
                <rect x="35" y="75" width="30" height="15" rx="5" fill="white"/>
                <path d="M20,20 L20,40 L30,30 Z" fill="#27ae60"/>
            </svg>
        </div>
        <div class="loading-text">Duty Manager</div>
        <div class="loading-dots">
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Network Status -->
    <div class="network-status" id="networkStatus">
        <span id="networkIcon">‚ö†Ô∏è</span>
        <span id="networkText">Offline</span>
    </div>

    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-container">
            <div class="login-logo">
                <div class="logo-circle">
                    <svg viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="45" fill="#3498db"/>
                        <circle cx="50" cy="35" r="12" fill="white"/>
                        <path d="M50,55 C65,55 70,70 70,70 L30,70 C30,70 35,55 50,55 Z" fill="white"/>
                        <rect x="35" y="75" width="30" height="15" rx="5" fill="white"/>
                        <path d="M20,20 L20,40 L30,30 Z" fill="#27ae60"/>
                    </svg>
                </div>
                <h1>Duty Manager</h1>
                <p>Secure duty management system</p>
            </div>
            
            <form id="loginForm" class="login-form">
                <div class="form-group">
                    <label for="username" class="form-label">Username</label>
                    <input type="text" id="username" class="form-control" placeholder="Enter your username" required autofocus>
                </div>
                
                <div class="form-group">
                    <label for="password" class="form-label">Password</label>
                    <input type="password" id="password" class="form-control" placeholder="Enter your password" required>
                </div>
                
                <button type="submit" class="btn btn-primary btn-block" id="loginBtn">
                    <span>üîê</span> Sign In
                </button>
            </form>
            
            <div class="login-footer">
                <p>Version 1.0.0</p>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div class="app-container" id="appContainer">
        <!-- Header -->
        <header class="app-header">
            <div class="header-left">
                <button class="btn btn-icon" id="menuBtn">
                    <span>‚ò∞</span>
                </button>
            </div>
            <div class="header-center" id="pageTitle">Dashboard</div>
            <div class="header-right">
                <button class="btn btn-icon" id="notificationBtn">
                    <span>üîî</span>
                    <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                </button>
            </div>
        </header>

        <!-- Side Navigation -->
        <div class="side-nav" id="sideNav">
            <div class="nav-header">
                <div class="nav-avatar" id="navAvatar">U</div>
                <div class="nav-user-info">
                    <h3 id="navUserName">User Name</h3>
                    <p id="navUserDetails">RC: 000 ‚Ä¢ Level: User</p>
                </div>
            </div>
            
            <div class="nav-items">
                <a href="#" class="nav-item active" data-section="dashboard">
                    <span class="nav-icon">üè†</span>
                    <span>Dashboard</span>
                </a>
                <a href="#" class="nav-item" data-section="dutyChange">
                    <span class="nav-icon">üîÑ</span>
                    <span>Change Duty</span>
                </a>
                <a href="#" class="nav-item" data-section="leave">
                    <span class="nav-icon">üìÖ</span>
                    <span>Apply Leave</span>
                </a>
                <a href="#" class="nav-item" data-section="myRequests">
                    <span class="nav-icon">üìã</span>
                    <span>My Requests</span>
                    <span class="nav-badge" id="myRequestsBadge" style="display: none;">0</span>
                </a>
                <a href="#" class="nav-item" data-section="roster">
                    <span class="nav-icon">üìä</span>
                    <span>My Roster</span>
                </a>
                <a href="#" class="nav-item" data-section="allRoster">
                    <span class="nav-icon">üë•</span>
                    <span>All Roster</span>
                </a>
                <a href="#" class="nav-item admin-nav" data-section="pending" id="pendingNav" style="display: none;">
                    <span class="nav-icon">‚è≥</span>
                    <span>Pending</span>
                    <span class="nav-badge" id="pendingBadge">0</span>
                </a>
                
                <!-- Admin Sections -->
                <div class="nav-divider"></div>
                <div class="nav-section-label">Admin</div>
                <a href="#" class="nav-item admin-nav" data-section="announcements" style="display: none;">
                    <span class="nav-icon">üì¢</span>
                    <span>Announcements</span>
                </a>
                <a href="#" class="nav-item admin-nav" data-section="manageRoster" style="display: none;">
                    <span class="nav-icon">üìù</span>
                    <span>Manage Roster</span>
                </a>
                <a href="#" class="nav-item admin-nav" data-section="manageLeave" style="display: none;">
                    <span class="nav-icon">üí∞</span>
                    <span>Leave Balance</span>
                </a>
                <a href="#" class="nav-item admin-nav" data-section="approvals" style="display: none;">
                    <span class="nav-icon">‚úÖ</span>
                    <span>Approvals</span>
                </a>
                
                <div class="nav-divider"></div>
                <a href="#" class="nav-item" id="logoutBtn">
                    <span class="nav-icon">üö™</span>
                    <span>Logout</span>
                </a>
            </div>
        </div>

        <!-- Navigation Overlay -->
        <div class="nav-overlay" id="navOverlay"></div>

        <!-- Main Content -->
        <main class="main-content" id="mainContent">
            <!-- Dashboard Section -->
            <section class="content-section active" id="dashboardSection">
                <div class="pull-to-refresh" id="pullToRefresh">
                    <div class="refresh-spinner"></div>
                </div>
                
                <div id="announcementsContainer"></div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Welcome, <span id="welcomeName">User</span>!</div>
                        <button class="btn btn-icon" onclick="refreshDashboard()">
                            <span>üîÑ</span>
                        </button>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">üè•</div>
                            <div class="stat-value" id="slBalance">0</div>
                            <div class="stat-label">Sick Leave</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üå¥</div>
                            <div class="stat-value" id="frlBalance">0</div>
                            <div class="stat-label">FRL Balance</div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <p><strong>Today's Duty:</strong> <span id="todayDutyTime">Not Scheduled</span></p>
                        <p><strong>Next Duty:</strong> <span id="nextDutyTime">No upcoming duty</span></p>
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="showSection('dutyChange')">
                            <span>üîÑ</span> Change Duty
                        </button>
                        <button class="btn btn-success" onclick="showSection('leave')">
                            <span>üìÖ</span> Apply Leave
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Quick Actions</div>
                    </div>
                    <div class="btn-group" style="flex-direction: column;">
                        <button class="btn btn-outline" onclick="showSection('myRequests')">
                            <span>üìã</span> View My Requests
                        </button>
                        <button class="btn btn-outline" onclick="showSection('roster')">
                            <span>üìä</span> View My Roster
                        </button>
                        <button class="btn btn-outline" onclick="showSection('allRoster')">
                            <span>üë•</span> View All Roster
                        </button>
                    </div>
                </div>
            </section>

            <!-- Duty Change Section -->
            <section class="content-section" id="dutyChangeSection">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Duty Change Request</div>
                    </div>
                    
                    <form id="dutyChangeForm">
                        <div class="form-group">
                            <label for="changeDate" class="form-label">Change Date</label>
                            <input type="date" id="changeDate" class="form-control" required min="">
                        </div>
                        
                        <div class="form-group">
                            <label for="changeDutyTime" class="form-label">Your Duty Time</label>
                            <select id="changeDutyTime" class="form-control form-select" required>
                                <option value="">Select duty time</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="requestToStaff" class="form-label">Request To</label>
                            <select id="requestToStaff" class="form-control form-select" required>
                                <option value="">Select staff member</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="requestToDutyTime" class="form-label">Their Duty Time</label>
                            <select id="requestToDutyTime" class="form-control form-select" required>
                                <option value="">Select duty time</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="changeReason" class="form-label">Reason (Optional)</label>
                            <textarea id="changeReason" class="form-control" rows="3" placeholder="Brief reason for duty change"></textarea>
                        </div>
                        
                        <div class="btn-group">
                            <button type="submit" class="btn btn-success">
                                <span>üì§</span> Submit Request
                            </button>
                            <button type="button" class="btn btn-outline" onclick="showSection('dashboard')">
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </section>

            <!-- Leave Application Section -->
            <section class="content-section" id="leaveSection">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Leave Application</div>
                    </div>
                    
                    <form id="leaveForm">
                        <div class="form-group">
                            <label for="leaveType" class="form-label">Leave Type</label>
                            <select id="leaveType" class="form-control form-select" required>
                                <option value="">Select leave type</option>
                                <option value="Sick Leave">Sick Leave</option>
                                <option value="FRL">FRL</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="leaveDate" class="form-label">Leave Date</label>
                            <input type="date" id="leaveDate" class="form-control" required min="">
                        </div>
                        
                        <div class="form-group">
                            <label for="leaveDutyTime" class="form-label">Duty Time</label>
                            <select id="leaveDutyTime" class="form-control form-select" required>
                                <option value="">Select duty time</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="leaveDuration" class="form-label">Duration</label>
                            <select id="leaveDuration" class="form-control form-select" required>
                                <option value="1">1 Day</option>
                                <option value="0.5">Half Day</option>
                                <option value="2">2 Days</option>
                                <option value="3">3 Days</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="leaveReason" class="form-label">Reason</label>
                            <textarea id="leaveReason" class="form-control" rows="3" placeholder="Please provide reason for leave" required></textarea>
                        </div>
                        
                        <div class="alert" id="leaveRulesAlert">
                            Select leave type, date and duty time to see rules
                        </div>
                        
                        <div class="btn-group">
                            <button type="submit" class="btn btn-success" id="submitLeaveBtn">
                                <span>üì§</span> Submit Application
                            </button>
                            <button type="button" class="btn btn-outline" onclick="showSection('dashboard')">
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </section>

            <!-- My Requests Section -->
            <section class="content-section" id="myRequestsSection">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">My Requests</div>
                        <button class="btn btn-icon" onclick="refreshMyRequests()">
                            <span>üîÑ</span>
                        </button>
                    </div>
                    
                    <div class="segmented-control" id="requestsFilter">
                        <div class="segment active" data-filter="all">All</div>
                        <div class="segment" data-filter="pending">Pending</div>
                        <div class="segment" data-filter="approved">Approved</div>
                        <div class="segment" data-filter="rejected">Rejected</div>
                    </div>
                    
                    <div id="myRequestsList" class="list"></div>
                </div>
            </section>

            <!-- My Roster Section -->
            <section class="content-section" id="rosterSection">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">My Duty Roster</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="rosterStartDate" class="form-label">Start Date</label>
                        <input type="date" id="rosterStartDate" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label for="rosterEndDate" class="form-label">End Date</label>
                        <input type="date" id="rosterEndDate" class="form-control">
                    </div>
                    
                    <button class="btn btn-primary btn-block" onclick="loadMyRoster()">
                        <span>üìä</span> Load Roster
                    </button>
                    
                    <div id="myRosterContainer" style="margin-top: 20px;"></div>
                </div>
            </section>

            <!-- All Roster Section -->
            <section class="content-section" id="allRosterSection">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Complete Duty Roster</div>
                    </div>
                    
                    <div class="alert alert-info">
                        <strong>Color Coding:</strong>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 10px;">
                            <div><span style="padding: 4px 8px; border-radius: 4px; background: #fff3cd; color: #856404;">07:30-15:30</span></div>
                            <div><span style="padding: 4px 8px; border-radius: 4px; background: #e2d9f3; color: #563d7c;">08:30-16:30</span></div>
                            <div><span style="padding: 4px 8px; border-radius: 4px; background: #fffde7; color: #827717;">10:30-18:30</span></div>
                            <div><span style="padding: 4px 8px; border-radius: 4px; background: #e3f2fd; color: #0d47a1;">15:30-23:30</span></div>
                            <div><span style="padding: 4px 8px; border-radius: 4px; background: #f5f5f5; color: #424242;">16:30-00:30</span></div>
                            <div><span style="padding: 4px 8px; border-radius: 4px; background: #d4edda; color: #155724;">Off Duty</span></div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="allRosterStartDate" class="form-label">Start Date</label>
                        <input type="date" id="allRosterStartDate" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label for="allRosterEndDate" class="form-label">End Date</label>
                        <input type="date" id="allRosterEndDate" class="form-control">
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="loadAllRoster()">
                            <span>üìä</span> Load Roster
                        </button>
                        <button class="btn btn-outline" onclick="toggleRosterView()">
                            <span id="rosterViewBtn">üìÖ Calendar View</span>
                        </button>
                    </div>
                    
                    <div id="allRosterContainer" style="margin-top: 20px;"></div>
                </div>
            </section>

            <!-- Pending Requests Section -->
            <section class="content-section" id="pendingSection">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Pending Requests</div>
                        <button class="btn btn-icon" onclick="refreshPendingRequests()">
                            <span>üîÑ</span>
                        </button>
                    </div>
                    
                    <div id="pendingRequestsList" class="list"></div>
                </div>
            </section>
        </main>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <a href="#" class="bottom-nav-item active" data-section="dashboard">
                <span class="bottom-nav-icon">üè†</span>
                <span class="bottom-nav-label">Home</span>
            </a>
            <a href="#" class="bottom-nav-item" data-section="dutyChange">
                <span class="bottom-nav-icon">üîÑ</span>
                <span class="bottom-nav-label">Change</span>
            </a>
            <a href="#" class="bottom-nav-item" data-section="leave">
                <span class="bottom-nav-icon">üìÖ</span>
                <span class="bottom-nav-label">Leave</span>
            </a>
            <a href="#" class="bottom-nav-item" data-section="myRequests">
                <span class="bottom-nav-icon">üìã</span>
                <span class="bottom-nav-label">Requests</span>
                <span class="notification-badge" id="bottomRequestsBadge" style="display: none;"></span>
            </a>
            <a href="#" class="bottom-nav-item" data-section="allRoster">
                <span class="bottom-nav-icon">üë•</span>
                <span class="bottom-nav-label">Roster</span>
            </a>
        </nav>
    </div>

    <!-- Action Sheet (for confirmations) -->
    <div class="action-sheet" id="actionSheet">
        <div class="action-sheet-title" id="actionSheetTitle">Confirm Action</div>
        <div class="action-sheet-actions" id="actionSheetActions"></div>
    </div>

    <!-- Install Prompt -->
    <div class="install-prompt hidden" id="installPrompt">
        <div style="text-align: center; margin-bottom: 10px;">
            <div style="font-weight: bold; margin-bottom: 5px;">üì± Install Duty Manager</div>
            <div style="font-size: 12px; color: var(--gray);">Get quick access on your home screen</div>
        </div>
        <div class="btn-group" style="margin: 0;">
            <button class="btn btn-primary" id="installNowBtn">Install</button>
            <button class="btn btn-outline" id="installLaterBtn">Later</button>
        </div>
    </div>

    <script>
        // Mobile App Core
        class MobileApp {
            constructor() {
                this.currentUser = null;
                this.allUsers = [];
                this.dutyRoster = {};
                this.leaveBalances = {};
                this.allRequests = [];
                this.announcements = [];
                this.currentSection = 'dashboard';
                this.isOnline = navigator.onLine;
                this.pwaManager = null;
                this.swipeStartX = 0;
                this.swipeStartY = 0;
                this.pullStartY = 0;
                this.isPulling = false;
                this.rosterViewMode = 'grid';
                
                this.init();
            }
            
            init() {
                this.setupEventListeners();
                this.setupTouchGestures();
                this.setupNetworkDetection();
                this.checkSession();
                this.setupPWA();
                this.hideLoadingScreen();
            }
            
            hideLoadingScreen() {
                setTimeout(() => {
                    document.getElementById('loadingScreen').classList.add('hidden');
                    setTimeout(() => {
                        document.getElementById('loadingScreen').style.display = 'none';
                    }, 300);
                }, 1500);
            }
            
            setupEventListeners() {
                // Login form
                document.getElementById('loginForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleLogin();
                });
                
                // Navigation
                document.getElementById('menuBtn').addEventListener('click', () => this.toggleSideNav());
                document.getElementById('navOverlay').addEventListener('click', () => this.toggleSideNav());
                
                // Side nav items
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        const section = item.dataset.section;
                        this.showSection(section);
                        this.toggleSideNav();
                    });
                });
                
                // Bottom nav items
                document.querySelectorAll('.bottom-nav-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        const section = item.dataset.section;
                        this.showSection(section);
                    });
                });
                
                // Action sheet buttons
                document.getElementById('installNowBtn').addEventListener('click', () => this.installPWA());
                document.getElementById('installLaterBtn').addEventListener('click', () => this.hideInstallPrompt());
                
                // Logout
                document.getElementById('logoutBtn').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.showActionSheet('Logout', 'Are you sure you want to logout?', [
                        { text: 'Logout', style: 'destructive', action: () => this.logout() },
                        { text: 'Cancel', style: 'cancel' }
                    ]);
                });
                
                // Forms
                document.getElementById('dutyChangeForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.submitDutyChange();
                });
                
                document.getElementById('leaveForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.submitLeave();
                });
                
                // Date inputs
                const today = new Date().toISOString().split('T')[0];
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                const tomorrowStr = tomorrow.toISOString().split('T')[0];
                
                document.getElementById('changeDate').min = today;
                document.getElementById('changeDate').value = tomorrowStr;
                document.getElementById('leaveDate').min = today;
                document.getElementById('leaveDate').value = tomorrowStr;
                
                // Roster dates
                const nextWeek = new Date();
                nextWeek.setDate(nextWeek.getDate() + 7);
                document.getElementById('rosterStartDate').value = today;
                document.getElementById('rosterEndDate').value = nextWeek.toISOString().split('T')[0];
                document.getElementById('allRosterStartDate').value = today;
                document.getElementById('allRosterEndDate').value = nextWeek.toISOString().split('T')[0];
                
                // Requests filter
                document.querySelectorAll('.segment').forEach(segment => {
                    segment.addEventListener('click', () => {
                        document.querySelectorAll('.segment').forEach(s => s.classList.remove('active'));
                        segment.classList.add('active');
                        this.filterRequests(segment.dataset.filter);
                    });
                });
            }
            
            setupTouchGestures() {
                // Swipe to go back
                let startX, startY;
                const mainContent = document.getElementById('mainContent');
                
                mainContent.addEventListener('touchstart', (e) => {
                    startX = e.touches[0].clientX;
                    startY = e.touches[0].clientY;
                });
                
                mainContent.addEventListener('touchmove', (e) => {
                    if (!startX || !startY) return;
                    
                    const diffX = e.touches[0].clientX - startX;
                    const diffY = e.touches[0].clientY - startY;
                    
                    // Only detect horizontal swipe
                    if (Math.abs(diffX) > Math.abs(diffY)) {
                        if (diffX > 50 && this.currentSection !== 'dashboard') {
                            // Swipe right to go back
                            this.showPreviousSection();
                            startX = null;
                            startY = null;
                        }
                    }
                });
                
                // Pull to refresh
                const pullToRefresh = document.getElementById('pullToRefresh');
                let pullStartY = 0;
                let pulling = false;
                
                mainContent.addEventListener('touchstart', (e) => {
                    if (window.scrollY === 0) {
                        pullStartY = e.touches[0].pageY;
                    }
                });
                
                mainContent.addEventListener('touchmove', (e) => {
                    if (!pullStartY) return;
                    
                    const pullDistance = e.touches[0].pageY - pullStartY;
                    
                    if (pullDistance > 0 && window.scrollY === 0) {
                        e.preventDefault();
                        pullToRefresh.style.transform = `translateY(${Math.min(pullDistance, 60)}px)`;
                        
                        if (pullDistance > 100 && !pulling) {
                            pulling = true;
                            pullToRefresh.classList.add('active');
                            this.refreshDashboard();
                        }
                    }
                });
                
                mainContent.addEventListener('touchend', () => {
                    if (pullStartY) {
                        pullStartY = null;
                        pullToRefresh.style.transform = 'translateY(-60px)';
                        
                        if (pulling) {
                            setTimeout(() => {
                                pullToRefresh.classList.remove('active');
                                pulling = false;
                            }, 1000);
                        }
                    }
                });
            }
            
            setupNetworkDetection() {
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    this.showToast('You are back online', 'success');
                    this.updateNetworkStatus();
                });
                
                window.addEventListener('offline', () => {
                    this.isOnline = false;
                    this.showToast('You are offline', 'warning');
                    this.updateNetworkStatus();
                });
                
                this.updateNetworkStatus();
            }
            
            updateNetworkStatus() {
                const status = document.getElementById('networkStatus');
                if (!status) return;
                
                if (this.isOnline) {
                    status.classList.remove('offline');
                    status.classList.add('online');
                    status.querySelector('#networkIcon').textContent = '‚úÖ';
                    status.querySelector('#networkText').textContent = 'Online';
                    setTimeout(() => {
                        status.style.display = 'none';
                    }, 3000);
                } else {
                    status.classList.remove('online');
                    status.classList.add('offline');
                    status.querySelector('#networkIcon').textContent = '‚ö†Ô∏è';
                    status.querySelector('#networkText').textContent = 'Offline';
                    status.style.display = 'flex';
                }
            }
            
            setupPWA() {
                this.pwaManager = new PWAManager(this);
                
                // Check if app is installed
                if (window.matchMedia('(display-mode: standalone)').matches) {
                    document.body.classList.add('standalone');
                }
            }
            
            async handleLogin() {
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value.trim();
                
                if (!username || !password) {
                    this.showToast('Please enter username and password', 'warning');
                    return;
                }
                
                if (!users || !Array.isArray(users)) {
                    this.showToast('System error. Please try again.', 'error');
                    return;
                }
                
                const user = users.find(u => u.username === username);
                
                if (!user) {
                    this.showToast('Invalid username or password', 'error');
                    return;
                }
                
                const hashedPassword = sha256(password);
                
                if (hashedPassword === user.passwordHash) {
                    const sessionData = {
                        username: user.username,
                        name: user.name,
                        rcNo: user.RCNo,
                        level: user.Level,
                        expiry: Date.now() + (8 * 60 * 60 * 1000)
                    };
                    
                    localStorage.setItem('dutySystemSession', JSON.stringify(sessionData));
                    await this.loginUser(sessionData);
                } else {
                    this.showToast('Invalid username or password', 'error');
                }
            }
            
            async loginUser(userData) {
                this.currentUser = userData;
                this.allUsers = users || [];
                
                // Show app, hide login
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                
                // Update UI
                document.getElementById('navAvatar').textContent = userData.name.charAt(0).toUpperCase();
                document.getElementById('navUserName').textContent = userData.name;
                document.getElementById('navUserDetails').textContent = `RC: ${userData.rcNo} ‚Ä¢ ${userData.level}`;
                document.getElementById('welcomeName').textContent = userData.name;
                
                // Show/hide admin sections
                const isAdmin = userData.level === 'Supervisor';
                document.querySelectorAll('.admin-nav').forEach(el => {
                    el.style.display = isAdmin ? 'flex' : 'none';
                });
                
                // Load data
                await this.loadInitialData();
                
                // Request notifications
                this.requestNotificationPermission();
                
                // Show welcome
                this.showToast(`Welcome back, ${userData.name}!`, 'success');
                
                // Setup real-time updates
                this.setupRealtimeUpdates();
            }
            
            async loadInitialData() {
                try {
                    // Load all data
                    await Promise.all([
                        this.loadDutyRoster(),
                        this.loadLeaveBalances(),
                        this.loadAllRequests(),
                        this.loadAnnouncements()
                    ]);
                    
                    // Update UI
                    this.updateUserBalance();
                    this.updateRequestCounts();
                    this.loadAnnouncementsView();
                    this.updateDashboard();
                    
                } catch (error) {
                    console.error('Error loading data:', error);
                    this.showToast('Failed to load data', 'error');
                }
            }
            
            async loadDutyRoster() {
                try {
                    const doc = await db.collection('dutyRoster').doc('current').get();
                    this.dutyRoster = doc.exists ? doc.data() || {} : {};
                    return this.dutyRoster;
                } catch (error) {
                    console.error('Error loading duty roster:', error);
                    this.dutyRoster = {};
                    return this.dutyRoster;
                }
            }
            
            async loadLeaveBalances() {
                try {
                    const doc = await db.collection('leaveBalances').doc('current').get();
                    if (doc.exists) {
                        this.leaveBalances = doc.data() || {};
                    } else {
                        this.leaveBalances = {};
                        this.allUsers.forEach(user => {
                            this.leaveBalances[user.username] = {
                                SL: 12,
                                FRL: 6
                            };
                        });
                        await this.saveLeaveBalances();
                    }
                    return this.leaveBalances;
                } catch (error) {
                    console.error('Error loading leave balances:', error);
                    this.leaveBalances = {};
                    return this.leaveBalances;
                }
            }
            
            async loadAllRequests() {
                try {
                    const doc = await db.collection('requests').doc('all').get();
                    if (doc.exists && doc.data().requests) {
                        this.allRequests = doc.data().requests;
                    } else {
                        this.allRequests = [];
                    }
                    return this.allRequests;
                } catch (error) {
                    console.error('Error loading requests:', error);
                    this.allRequests = [];
                    return this.allRequests;
                }
            }
            
            async loadAnnouncements() {
                try {
                    const doc = await db.collection('announcements').doc('all').get();
                    if (doc.exists && doc.data().announcements) {
                        this.announcements = doc.data().announcements;
                    } else {
                        this.announcements = [];
                        await this.saveAnnouncements();
                    }
                    return this.announcements;
                } catch (error) {
                    console.error('Error loading announcements:', error);
                    this.announcements = [];
                    return this.announcements;
                }
            }
            
            async saveLeaveBalances() {
                try {
                    await db.collection('leaveBalances').doc('current').set(this.leaveBalances);
                    return true;
                } catch (error) {
                    console.error('Error saving leave balances:', error);
                    this.showToast('Failed to save leave balances', 'error');
                    return false;
                }
            }
            
            async saveAllRequests() {
                try {
                    await db.collection('requests').doc('all').set({ requests: this.allRequests });
                    return true;
                } catch (error) {
                    console.error('Error saving requests:', error);
                    this.showToast('Failed to save requests', 'error');
                    return false;
                }
            }
            
            async saveAnnouncements() {
                try {
                    await db.collection('announcements').doc('all').set({ announcements: this.announcements });
                    return true;
                } catch (error) {
                    console.error('Error saving announcements:', error);
                    this.showToast('Failed to save announcements', 'error');
                    return false;
                }
            }
            
            updateUserBalance() {
                if (!this.currentUser) return;
                
                const balance = this.leaveBalances[this.currentUser.username] || {SL: 0, FRL: 0};
                document.getElementById('slBalance').textContent = balance.SL.toFixed(1);
                document.getElementById('frlBalance').textContent = balance.FRL.toFixed(1);
            }
            
            updateRequestCounts() {
                if (!this.currentUser) return;
                
                // Pending requests for user
                const pendingForUser = this.allRequests.filter(req => 
                    req.status === 'pending' && 
                    req.type === 'dutyChange' && 
                    req.toUsername === this.currentUser.username
                ).length;
                
                const pendingNav = document.getElementById('pendingNav');
                const pendingBadge = document.getElementById('pendingBadge');
                
                if (pendingForUser > 0) {
                    pendingNav.style.display = 'flex';
                    pendingBadge.textContent = pendingForUser;
                    pendingBadge.style.display = 'inline-block';
                } else {
                    pendingNav.style.display = 'none';
                    pendingBadge.style.display = 'none';
                }
                
                // My pending requests
                const myPending = this.allRequests.filter(req => 
                    req.fromUsername === this.currentUser.username && 
                    req.status === 'pending'
                ).length;
                
                const myBadge = document.getElementById('myRequestsBadge');
                const bottomBadge = document.getElementById('bottomRequestsBadge');
                
                if (myPending > 0) {
                    myBadge.textContent = myPending;
                    myBadge.style.display = 'inline-block';
                    bottomBadge.textContent = myPending;
                    bottomBadge.style.display = 'inline-block';
                } else {
                    myBadge.style.display = 'none';
                    bottomBadge.style.display = 'none';
                }
            }
            
            showSection(sectionId) {
                // Hide all sections
                document.querySelectorAll('.content-section').forEach(section => {
                    section.classList.remove('active');
                });
                
                // Show selected section
                const section = document.getElementById(sectionId + 'Section');
                if (section) {
                    section.classList.add('active');
                }
                
                // Update navigation
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.dataset.section === sectionId) {
                        item.classList.add('active');
                    }
                });
                
                document.querySelectorAll('.bottom-nav-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.dataset.section === sectionId) {
                        item.classList.add('active');
                    }
                });
                
                // Update page title
                const titles = {
                    dashboard: 'Dashboard',
                    dutyChange: 'Duty Change',
                    leave: 'Apply Leave',
                    myRequests: 'My Requests',
                    roster: 'My Roster',
                    allRoster: 'All Roster',
                    pending: 'Pending Requests',
                    announcements: 'Announcements',
                    manageRoster: 'Manage Roster',
                    manageLeave: 'Leave Balance',
                    approvals: 'Approvals'
                };
                
                document.getElementById('pageTitle').textContent = titles[sectionId] || sectionId;
                this.currentSection = sectionId;
                
                // Load section data
                this.loadSectionData(sectionId);
                
                // Scroll to top
                document.getElementById('mainContent').scrollTop = 0;
            }
            
            showPreviousSection() {
                if (this.currentSection !== 'dashboard') {
                    this.showSection('dashboard');
                }
            }
            
            loadSectionData(sectionId) {
                switch(sectionId) {
                    case 'dashboard':
                        this.updateDashboard();
                        break;
                    case 'dutyChange':
                        this.loadDutyChangeForm();
                        break;
                    case 'leave':
                        this.loadLeaveForm();
                        break;
                    case 'myRequests':
                        this.loadMyRequests();
                        break;
                    case 'roster':
                        // Auto load roster
                        break;
                    case 'allRoster':
                        // Auto load all roster
                        break;
                    case 'pending':
                        this.loadPendingRequests();
                        break;
                }
            }
            
            toggleSideNav() {
                const sideNav = document.getElementById('sideNav');
                const overlay = document.getElementById('navOverlay');
                
                sideNav.classList.toggle('active');
                overlay.classList.toggle('active');
                
                // Disable scroll when nav is open
                document.body.style.overflow = sideNav.classList.contains('active') ? 'hidden' : '';
            }
            
            updateDashboard() {
                const today = new Date().toISOString().split('T')[0];
                const todayDuty = document.getElementById('todayDutyTime');
                const nextDuty = document.getElementById('nextDutyTime');
                
                // Today's duty
                if (this.dutyRoster[today] && this.dutyRoster[today][this.currentUser.username]) {
                    const duty = this.dutyRoster[today][this.currentUser.username];
                    todayDuty.textContent = duty === 'Off' ? 'Off Duty' : duty;
                } else {
                    todayDuty.textContent = 'Not Scheduled';
                }
                
                // Next duty
                const tomorrow = new Date();
                let foundNext = false;
                
                for (let i = 1; i <= 7; i++) {
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    const dateStr = tomorrow.toISOString().split('T')[0];
                    if (this.dutyRoster[dateStr] && this.dutyRoster[dateStr][this.currentUser.username]) {
                        const duty = this.dutyRoster[dateStr][this.currentUser.username];
                        if (duty !== 'Off') {
                            const date = new Date(dateStr);
                            const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                            nextDuty.textContent = `${dayName}: ${duty}`;
                            foundNext = true;
                            break;
                        }
                    }
                }
                
                if (!foundNext) {
                    nextDuty.textContent = 'No upcoming duty';
                }
                
                // Update balance
                this.updateUserBalance();
            }
            
            refreshDashboard() {
                this.updateDashboard();
                this.loadAnnouncementsView();
                this.showToast('Dashboard refreshed', 'success');
            }
            
            loadAnnouncementsView() {
                const container = document.getElementById('announcementsContainer');
                if (!container) return;
                
                container.innerHTML = '';
                
                const now = new Date();
                const activeAnnouncements = this.announcements.filter(ann => {
                    if (ann.status === 'expired' || ann.status === 'archived') return false;
                    if (ann.expiry && new Date(ann.expiry) < now) return false;
                    return ann.target === 'all' || 
                           (ann.target === 'specific' && ann.targetUsers && 
                            ann.targetUsers.includes(this.currentUser.username));
                });
                
                if (activeAnnouncements.length === 0) return;
                
                activeAnnouncements.slice(0, 3).forEach(ann => {
                    const announcement = document.createElement('div');
                    announcement.className = `card announcement priority-${ann.priority}`;
                    announcement.style.margin = '15px';
                    announcement.style.borderLeft = `4px solid ${this.getPriorityColor(ann.priority)}`;
                    
                    announcement.innerHTML = `
                        <div style="font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                            <span>üì¢</span> ${ann.title}
                        </div>
                        <div style="margin-bottom: 10px; font-size: 14px;">${ann.content}</div>
                        <div style="font-size: 12px; color: var(--gray);">
                            ${ann.createdBy} ‚Ä¢ ${this.formatTimeAgo(ann.createdAt)}
                        </div>
                    `;
                    
                    container.appendChild(announcement);
                });
            }
            
            getPriorityColor(priority) {
                const colors = {
                    high: '#e74c3c',
                    medium: '#f39c12',
                    low: '#27ae60'
                };
                return colors[priority] || '#3498db';
            }
            
            formatTimeAgo(timestamp) {
                const now = new Date();
                const past = new Date(timestamp);
                const diffMs = now - past;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMins / 60);
                const diffDays = Math.floor(diffHours / 24);
                
                if (diffMins < 1) return 'just now';
                if (diffMins < 60) return `${diffMins}m ago`;
                if (diffHours < 24) return `${diffHours}h ago`;
                if (diffDays < 7) return `${diffDays}d ago`;
                return past.toLocaleDateString();
            }
            
            async submitDutyChange() {
                const date = document.getElementById('changeDate').value;
                const dutyTime = document.getElementById('changeDutyTime').value;
                const toStaff = document.getElementById('requestToStaff').value;
                const toDutyTime = document.getElementById('requestToDutyTime').value;
                const reason = document.getElementById('changeReason').value;
                
                if (!date || !dutyTime || !toStaff || !toDutyTime) {
                    this.showToast('Please fill all required fields', 'warning');
                    return;
                }
                
                if (dutyTime === 'Off' || toDutyTime === 'Off') {
                    this.showToast('Cannot request duty change on off days', 'warning');
                    return;
                }
                
                const requestDate = new Date(date);
                const now = new Date();
                const hoursDiff = (requestDate - now) / (1000 * 60 * 60);
                
                if (hoursDiff < 24) {
                    this.showToast('Duty changes must be requested at least 24 hours in advance', 'warning');
                    return;
                }
                
                const toUser = this.allUsers.find(u => u.username === toStaff);
                if (!toUser) {
                    this.showToast('Selected staff not found', 'error');
                    return;
                }
                
                const request = {
                    id: 'req_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    type: 'dutyChange',
                    fromUsername: this.currentUser.username,
                    fromName: this.currentUser.name,
                    fromRcNo: this.currentUser.rcNo,
                    date: date,
                    dutyTime: dutyTime,
                    toUsername: toStaff,
                    toName: toUser.name,
                    toRcNo: toUser.RCNo,
                    toDutyTime: toDutyTime,
                    reason: reason,
                    status: 'pending',
                    timestamp: new Date().toISOString(),
                    history: [{
                        action: 'created',
                        by: this.currentUser.name,
                        timestamp: new Date().toISOString()
                    }]
                };
                
                this.allRequests.push(request);
                
                const success = await this.saveAllRequests();
                if (success) {
                    this.updateRequestCounts();
                    this.showToast('Duty change request submitted!', 'success');
                    this.showSection('dashboard');
                    document.getElementById('dutyChangeForm').reset();
                }
            }
            
            async submitLeave() {
                const leaveType = document.getElementById('leaveType').value;
                const date = document.getElementById('leaveDate').value;
                const dutyTime = document.getElementById('leaveDutyTime').value;
                const duration = parseFloat(document.getElementById('leaveDuration').value);
                const reason = document.getElementById('leaveReason').value;
                
                if (!leaveType || !date || !dutyTime || !reason) {
                    this.showToast('Please fill all required fields', 'warning');
                    return;
                }
                
                if (dutyTime === 'Off' || dutyTime === '') {
                    this.showToast('You are off duty on this date', 'warning');
                    return;
                }
                
                const userBalance = this.leaveBalances[this.currentUser.username];
                if (!userBalance) {
                    this.showToast('Error: User balance not found', 'error');
                    return;
                }
                
                // Deduct from balance
                if (leaveType === 'Sick Leave') {
                    if (userBalance.SL < duration) {
                        this.showToast(`Insufficient Sick Leave balance. Available: ${userBalance.SL.toFixed(1)} days`, 'warning');
                        return;
                    }
                    userBalance.SL -= duration;
                    userBalance.SL = Math.max(0, userBalance.SL);
                } else if (leaveType === 'FRL') {
                    if (userBalance.FRL < duration) {
                        this.showToast(`Insufficient FRL balance. Available: ${userBalance.FRL.toFixed(1)} days`, 'warning');
                        return;
                    }
                    userBalance.FRL -= duration;
                    userBalance.FRL = Math.max(0, userBalance.FRL);
                }
                
                await this.saveLeaveBalances();
                
                const request = {
                    id: 'req_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    type: 'leave',
                    leaveType: leaveType,
                    fromUsername: this.currentUser.username,
                    fromName: this.currentUser.name,
                    fromRcNo: this.currentUser.rcNo,
                    date: date,
                    dutyTime: dutyTime,
                    duration: duration,
                    reason: reason,
                    status: 'approved',
                    timestamp: new Date().toISOString(),
                    approvedBy: 'System (Auto-approved)',
                    approvedAt: new Date().toISOString(),
                    history: [{
                        action: 'created_and_approved',
                        by: this.currentUser.name,
                        timestamp: new Date().toISOString(),
                        note: 'Leave balance deducted immediately upon application'
                    }]
                };
                
                this.allRequests.push(request);
                
                const success = await this.saveAllRequests();
                if (success) {
                    this.updateUserBalance();
                    this.updateRequestCounts();
                    this.showToast(`${leaveType} application submitted successfully! ${duration} day(s) deducted.`, 'success');
                    this.showSection('dashboard');
                    document.getElementById('leaveForm').reset();
                }
            }
            
            loadMyRequests() {
                const container = document.getElementById('myRequestsList');
                if (!container) return;
                
                const myReqs = this.allRequests.filter(req => req.fromUsername === this.currentUser.username);
                
                if (myReqs.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üìã</div>
                            <div class="empty-state-title">No Requests</div>
                            <div class="empty-state-text">You haven't made any requests yet</div>
                        </div>
                    `;
                    return;
                }
                
                myReqs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                container.innerHTML = '';
                myReqs.forEach(req => {
                    const item = document.createElement('div');
                    item.className = 'list-item';
                    
                    let details = '';
                    if (req.type === 'dutyChange') {
                        details = `Swap with ${req.toName} (${req.toDutyTime})`;
                    } else {
                        details = `${req.leaveType} - ${req.duration} day(s)`;
                    }
                    
                    let statusClass = 'status-' + req.status;
                    let statusText = req.status.charAt(0).toUpperCase() + req.status.slice(1);
                    let statusColor = req.status === 'approved' ? 'var(--success)' : 
                                     req.status === 'rejected' ? 'var(--danger)' : 
                                     req.status === 'pending' ? 'var(--warning)' : 'var(--gray)';
                    
                    item.innerHTML = `
                        <div class="list-item-content">
                            <div class="list-item-title">${req.type === 'dutyChange' ? 'Duty Change' : 'Leave'}</div>
                            <div class="list-item-subtitle">${req.date} ‚Ä¢ ${details}</div>
                        </div>
                        <div style="color: ${statusColor}; font-weight: 500; font-size: 14px;">
                            ${statusText}
                        </div>
                    `;
                    
                    container.appendChild(item);
                });
            }
            
            filterRequests(filter) {
                // Implementation for filtering requests
            }
            
            refreshMyRequests() {
                this.loadMyRequests();
                this.showToast('Requests refreshed', 'success');
            }
            
            loadPendingRequests() {
                const container = document.getElementById('pendingRequestsList');
                if (!container) return;
                
                const pendingReqs = this.allRequests.filter(req => 
                    req.status === 'pending' && 
                    req.type === 'dutyChange' && 
                    req.toUsername === this.currentUser.username
                );
                
                if (pendingReqs.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">‚è≥</div>
                            <div class="empty-state-title">No Pending Requests</div>
                            <div class="empty-state-text">You don't have any pending requests</div>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = '';
                pendingReqs.forEach(req => {
                    const item = document.createElement('div');
                    item.className = 'list-item';
                    
                    item.innerHTML = `
                        <div class="list-item-content">
                            <div class="list-item-title">${req.fromName}</div>
                            <div class="list-item-subtitle">${req.date} ‚Ä¢ Swap ${req.dutyTime} with ${req.toDutyTime}</div>
                            ${req.reason ? `<div class="list-item-subtitle" style="margin-top: 4px; font-style: italic;">"${req.reason}"</div>` : ''}
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-success btn-sm" onclick="mobileApp.approveRequest('${req.id}')">Accept</button>
                            <button class="btn btn-danger btn-sm" onclick="mobileApp.rejectRequest('${req.id}')">Reject</button>
                        </div>
                    `;
                    
                    container.appendChild(item);
                });
            }
            
            async approveRequest(requestId) {
                const request = this.allRequests.find(req => req.id === requestId);
                if (!request) return;
                
                // Swap duty times
                const date = request.date;
                if (this.dutyRoster[date]) {
                    const fromDuty = this.dutyRoster[date][request.fromUsername];
                    const toDuty = this.dutyRoster[date][request.toUsername];
                    
                    this.dutyRoster[date][request.fromUsername] = toDuty;
                    this.dutyRoster[date][request.toUsername] = fromDuty;
                    
                    await db.collection('dutyRoster').doc('current').set(this.dutyRoster);
                }
                
                request.status = 'approved';
                request.respondedAt = new Date().toISOString();
                request.respondedBy = this.currentUser.name;
                request.history.push({
                    action: 'approved',
                    by: this.currentUser.name,
                    timestamp: new Date().toISOString()
                });
                
                await this.saveAllRequests();
                this.updateRequestCounts();
                this.showToast('Request approved!', 'success');
                this.loadPendingRequests();
            }
            
            async rejectRequest(requestId) {
                const request = this.allRequests.find(req => req.id === requestId);
                if (!request) return;
                
                request.status = 'rejected';
                request.respondedAt = new Date().toISOString();
                request.respondedBy = this.currentUser.name;
                request.history.push({
                    action: 'rejected',
                    by: this.currentUser.name,
                    timestamp: new Date().toISOString()
                });
                
                await this.saveAllRequests();
                this.updateRequestCounts();
                this.showToast('Request rejected', 'warning');
                this.loadPendingRequests();
            }
            
            refreshPendingRequests() {
                this.loadPendingRequests();
                this.showToast('Pending requests refreshed', 'success');
            }
            
            loadDutyChangeForm() {
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                document.getElementById('changeDate').value = tomorrow.toISOString().split('T')[0];
                
                const staffSelect = document.getElementById('requestToStaff');
                if (staffSelect) {
                    staffSelect.innerHTML = '<option value="">Select staff member</option>';
                    this.allUsers.forEach(user => {
                        if (user.username !== this.currentUser.username && user.Level === 'User') {
                            const option = document.createElement('option');
                            option.value = user.username;
                            option.textContent = `${user.name} (RC: ${user.RCNo})`;
                            staffSelect.appendChild(option);
                        }
                    });
                }
                
                this.loadUserDutyTimes('changeDutyTime', tomorrow.toISOString().split('T')[0]);
            }
            
            loadLeaveForm() {
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                document.getElementById('leaveDate').value = tomorrow.toISOString().split('T')[0];
                this.loadUserDutyTimes('leaveDutyTime', tomorrow.toISOString().split('T')[0]);
                this.updateLeaveRules();
            }
            
            loadUserDutyTimes(selectId, date) {
                const select = document.getElementById(selectId);
                if (!select || !date || !this.currentUser) return;
                
                select.innerHTML = '<option value="">Select duty time</option>';
                const dutyTime = this.dutyRoster[date] && this.dutyRoster[date][this.currentUser.username];
                
                if (dutyTime) {
                    const option = document.createElement('option');
                    option.value = dutyTime;
                    option.textContent = dutyTime === 'Off' ? 'Off Duty' : dutyTime;
                    select.appendChild(option);
                }
            }
            
            updateLeaveRules() {
                // Implementation for leave rules
            }
            
            loadMyRoster() {
                // Implementation for loading my roster
            }
            
            loadAllRoster() {
                // Implementation for loading all roster
            }
            
            toggleRosterView() {
                this.rosterViewMode = this.rosterViewMode === 'grid' ? 'calendar' : 'grid';
                document.getElementById('rosterViewBtn').textContent = 
                    this.rosterViewMode === 'grid' ? 'üìÖ Calendar View' : 'üìã Grid View';
            }
            
            requestNotificationPermission() {
                if ("Notification" in window && Notification.permission === "default") {
                    Notification.requestPermission();
                }
            }
            
            showActionSheet(title, message, actions) {
                const sheet = document.getElementById('actionSheet');
                const sheetTitle = document.getElementById('actionSheetTitle');
                const sheetActions = document.getElementById('actionSheetActions');
                
                sheetTitle.textContent = title;
                sheetActions.innerHTML = `
                    <div style="text-align: center; margin-bottom: 20px; color: var(--gray); font-size: 14px;">
                        ${message}
                    </div>
                `;
                
                actions.forEach(action => {
                    const btn = document.createElement('div');
                    btn.className = `action-sheet-btn ${action.style || ''}`;
                    btn.textContent = action.text;
                    btn.onclick = () => {
                        sheet.classList.remove('active');
                        if (action.action) action.action();
                    };
                    sheetActions.appendChild(btn);
                });
                
                sheet.classList.add('active');
            }
            
            showToast(message, type = 'info', duration = 3000) {
                const container = document.getElementById('toastContainer');
                if (!container) return;
                
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `
                    <span class="toast-icon">
                        ${type === 'success' ? '‚úÖ' : 
                          type === 'error' ? '‚ùå' : 
                          type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}
                    </span>
                    <span>${message}</span>
                `;
                
                container.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateX(100%)';
                    setTimeout(() => toast.remove(), 300);
                }, duration);
            }
            
            checkSession() {
                const session = localStorage.getItem('dutySystemSession');
                if (session) {
                    try {
                        const user = JSON.parse(session);
                        if (user.expiry > Date.now()) {
                            this.loginUser(user);
                        } else {
                            localStorage.removeItem('dutySystemSession');
                        }
                    } catch (e) {
                        localStorage.removeItem('dutySystemSession');
                    }
                }
            }
            
            logout() {
                localStorage.removeItem('dutySystemSession');
                location.reload();
            }
            
            setupRealtimeUpdates() {
                if (typeof db === 'undefined') return;
                
                // Listen for requests updates
                db.collection('requests').doc('all')
                    .onSnapshot((doc) => {
                        if (doc.exists && doc.data().requests) {
                            this.allRequests = doc.data().requests;
                            this.updateRequestCounts();
                            
                            if (this.currentSection === 'myRequests') {
                                this.loadMyRequests();
                            }
                            if (this.currentSection === 'pending') {
                                this.loadPendingRequests();
                            }
                        }
                    });
                
                // Listen for announcements
                db.collection('announcements').doc('all')
                    .onSnapshot((doc) => {
                        if (doc.exists && doc.data().announcements) {
                            this.announcements = doc.data().announcements;
                            if (this.currentSection === 'dashboard') {
                                this.loadAnnouncementsView();
                            }
                        }
                    });
                
                // Listen for roster changes
                db.collection('dutyRoster').doc('current')
                    .onSnapshot((doc) => {
                        if (doc.exists) {
                            this.dutyRoster = doc.data() || {};
                            if (this.currentSection === 'dashboard') {
                                this.updateDashboard();
                            }
                        }
                    });
            }
        }

        // PWA Manager
        class PWAManager {
            constructor(app) {
                this.app = app;
                this.deferredPrompt = null;
                this.isStandalone = false;
                
                this.init();
            }
            
            init() {
                this.checkStandalone();
                this.setupInstallPrompt();
                this.registerServiceWorker();
            }
            
            checkStandalone() {
                this.isStandalone = window.matchMedia('(display-mode: standalone)').matches || 
                                   window.navigator.standalone;
                
                if (this.isStandalone) {
                    document.body.classList.add('standalone-app');
                }
            }
            
            setupInstallPrompt() {
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    this.deferredPrompt = e;
                    
                    if (!this.isStandalone && !localStorage.getItem('installPromptShown')) {
                        setTimeout(() => this.showInstallPrompt(), 5000);
                    }
                });
                
                window.addEventListener('appinstalled', () => {
                    localStorage.setItem('installPromptShown', 'true');
                    this.hideInstallPrompt();
                    this.app.showToast('App installed successfully!', 'success');
                });
            }
            
            showInstallPrompt() {
                const prompt = document.getElementById('installPrompt');
                prompt.classList.remove('hidden');
                
                document.getElementById('installNowBtn').onclick = async () => {
                    prompt.style.animation = 'slideOutDown 0.3s ease';
                    setTimeout(() => prompt.classList.add('hidden'), 300);
                    
                    this.deferredPrompt.prompt();
                    const { outcome } = await this.deferredPrompt.userChoice;
                    console.log(`User response: ${outcome}`);
                    this.deferredPrompt = null;
                    localStorage.setItem('installPromptShown', 'true');
                };
                
                document.getElementById('installLaterBtn').onclick = () => {
                    prompt.style.animation = 'slideOutDown 0.3s ease';
                    setTimeout(() => prompt.classList.add('hidden'), 300);
                    localStorage.setItem('installPromptShown', 'true');
                };
            }
            
            hideInstallPrompt() {
                document.getElementById('installPrompt').classList.add('hidden');
            }
            
            async registerServiceWorker() {
                if ('serviceWorker' in navigator) {
                    try {
                        await navigator.serviceWorker.register('/service-worker.js');
                        console.log('Service Worker registered');
                    } catch (error) {
                        console.error('Service Worker registration failed:', error);
                    }
                }
            }
            
            installPWA() {
                if (this.deferredPrompt) {
                    this.deferredPrompt.prompt();
                }
            }
        }

        // Initialize the app
        let mobileApp;
        
        document.addEventListener('DOMContentLoaded', () => {
            mobileApp = new MobileApp();
            
            // Make app globally accessible for button clicks
            window.mobileApp = mobileApp;
            
            // Add CSS for dynamic styles
            const style = document.createElement('style');
            style.textContent = `
                .btn-sm { padding: 8px 12px; font-size: 13px; }
                .btn-icon { background: none; border: none; color: white; padding: 8px; }
                .login-screen { 
                    height: 100vh; 
                    display: flex; 
                    align-items: center; 
                    justify-content: center; 
                    background: linear-gradient(135deg, #3498db, #2c3e50);
                    padding: 20px;
                }
                .login-container { 
                    background: white; 
                    border-radius: 20px; 
                    padding: 30px; 
                    width: 100%; 
                    max-width: 400px; 
                    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
                }
                .login-logo { text-align: center; margin-bottom: 30px; }
                .login-logo h1 { margin: 15px 0 5px; color: #2c3e50; }
                .login-logo p { color: #95a5a6; margin-bottom: 20px; }
                .logo-circle { 
                    width: 80px; 
                    height: 80px; 
                    background: #3498db; 
                    border-radius: 20px; 
                    display: flex; 
                    align-items: center; 
                    justify-content: center; 
                    margin: 0 auto;
                }
                .login-footer { 
                    text-align: center; 
                    margin-top: 20px; 
                    color: #95a5a6; 
                    font-size: 12px; 
                }
                .nav-divider { 
                    height: 1px; 
                    background: rgba(255,255,255,0.1); 
                    margin: 10px 20px; 
                }
                .nav-section-label { 
                    color: rgba(255,255,255,0.5); 
                    font-size: 12px; 
                    text-transform: uppercase; 
                    letter-spacing: 1px; 
                    padding: 10px 20px; 
                }
                .action-buttons { display: flex; gap: 8px; }
                .announcement { animation: fadeIn 0.5s ease; }
                @keyframes slideOutDown {
                    from { transform: translateY(0); opacity: 1; }
                    to { transform: translateY(100%); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
        });
    </script>
</body>
</html>
