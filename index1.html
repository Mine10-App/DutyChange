<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Duty Management System</title>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <!-- SHA-256 Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js"></script>
    
    <!-- CSS File -->
    <style>
        /* Mobile-First Responsive CSS for Duty Management System */

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
}

body {
    background: #f5f7fa;
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 15px;
    font-size: 14px;
}

/* Login Page */
.login-container {
    background: white;
    border-radius: 12px;
    box-shadow: 0 3px 15px rgba(0, 0, 0, 0.1);
    width: 100%;
    max-width: 400px;
    padding: 30px 25px;
    margin: 0 auto;
}

.logo {
    text-align: center;
    margin-bottom: 25px;
}

.logo h1 {
    color: #2c3e50;
    font-size: 24px;
    margin-bottom: 5px;
}

.logo p {
    color: #7f8c8d;
    font-size: 13px;
}

.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    color: #2c3e50;
    font-size: 13px;
    font-weight: 500;
    margin-bottom: 6px;
}

.form-control {
    width: 100%;
    padding: 12px;
    border: 2px solid #e0e6ed;
    border-radius: 8px;
    font-size: 15px;
    transition: all 0.3s;
}

.form-control:focus {
    outline: none;
    border-color: #3498db;
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
}

.btn {
    padding: 12px 20px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    text-align: center;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.btn-primary {
    background: #3498db;
    color: white;
}

.btn-primary:hover {
    background: #2980b9;
}

.btn-success {
    background: #27ae60;
    color: white;
}

.btn-success:hover {
    background: #219653;
}

.btn-danger {
    background: #e74c3c;
    color: white;
}

.btn-danger:hover {
    background: #c0392b;
}

.btn-warning {
    background: #f39c12;
    color: white;
}

.btn-warning:hover {
    background: #d68910;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #545b62;
}

.btn-block {
    width: 100%;
    display: block;
}

.error-message {
    background: #ffeaea;
    color: #e74c3c;
    padding: 10px;
    border-radius: 6px;
    margin-top: 15px;
    display: none;
    font-size: 13px;
}

/* Dashboard */
.dashboard-container {
    display: none;
    width: 100%;
    height: 100vh;
    background: white;
    position: fixed;
    top: 0;
    left: 0;
    z-index: 1000;
    overflow: hidden;
}

/* Header */
.dashboard-header {
    background: linear-gradient(135deg, #2c3e50, #3498db);
    color: white;
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    height: 60px;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1001;
}

.user-info h2 {
    font-size: 16px;
    margin-bottom: 3px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 150px;
}

.user-details {
    font-size: 12px;
    opacity: 0.9;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.mobile-menu-btn {
    display: none;
    flex-direction: column;
    justify-content: space-between;
    width: 24px;
    height: 20px;
    cursor: pointer;
    margin-right: 15px;
}

.mobile-menu-btn span {
    display: block;
    width: 100%;
    height: 2px;
    background: white;
    border-radius: 2px;
    transition: all 0.3s;
}

.header-actions {
    display: flex;
    gap: 8px;
}

/* Navigation */
.dashboard-nav {
    background: #34495e;
    position: fixed;
    top: 60px;
    left: -280px;
    bottom: 0;
    width: 280px;
    padding: 15px 0;
    overflow-y: auto;
    transition: left 0.3s ease;
    z-index: 1000;
}

.dashboard-nav.active {
    left: 0;
}

.nav-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 20px 15px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    margin-bottom: 10px;
    color: white;
    font-weight: 600;
}

.close-nav {
    background: none;
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.nav-btn {
    background: none;
    border: none;
    color: white;
    padding: 12px 20px;
    width: 100%;
    text-align: left;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: all 0.3s;
    border-left: 4px solid transparent;
}

.nav-btn:hover {
    background: rgba(255, 255, 255, 0.1);
    border-left-color: rgba(255, 255, 255, 0.3);
}

.nav-btn.active {
    background: rgba(52, 152, 219, 0.2);
    border-left-color: #3498db;
}

.nav-icon {
    font-size: 18px;
    width: 24px;
    text-align: center;
}

.nav-text {
    flex: 1;
}

.nav-divider {
    color: rgba(255, 255, 255, 0.5);
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 1px;
    padding: 15px 20px 5px;
    margin-top: 10px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.notification-badge {
    background: #e74c3c;
    color: white;
    border-radius: 10px;
    padding: 2px 8px;
    font-size: 11px;
    min-width: 20px;
    text-align: center;
}

.notification-dot {
    display: inline-block;
    width: 8px;
    height: 8px;
    background-color: #e74c3c;
    border-radius: 50%;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.3; }
    100% { opacity: 1; }
}

/* Content Area */
.dashboard-content {
    padding: 75px 15px 15px;
    min-height: 100vh;
    background: #f5f7fa;
    overflow-y: auto;
}

.section {
    display: none;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.section.active {
    display: block;
}

/* Cards */
.card {
    background: white;
    border-radius: 10px;
    padding: 20px 15px;
    margin-bottom: 15px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    border: 1px solid #e0e6ed;
}

.card h3 {
    color: #2c3e50;
    margin-bottom: 15px;
    font-size: 16px;
    border-bottom: 2px solid #3498db;
    padding-bottom: 8px;
}

/* Announcement Banner */
.announcement-banner {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 15px;
    position: relative;
    overflow: hidden;
}

.announcement-banner.priority-high {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    animation: pulse-banner 2s infinite;
}

.announcement-banner.priority-medium {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
}

.announcement-banner.priority-low {
    background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
}

@keyframes pulse-banner {
    0% { box-shadow: 0 0 0 0 rgba(245, 87, 108, 0.4); }
    70% { box-shadow: 0 0 0 10px rgba(245, 87, 108, 0); }
    100% { box-shadow: 0 0 0 0 rgba(245, 87, 108, 0); }
}

.announcement-title {
    font-size: 15px;
    font-weight: 600;
    margin-bottom: 5px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.announcement-icon {
    font-size: 18px;
}

.announcement-content {
    font-size: 13px;
    opacity: 0.95;
    margin-bottom: 8px;
    line-height: 1.4;
}

.announcement-meta {
    font-size: 11px;
    opacity: 0.8;
    margin-top: 8px;
}

.announcement-target {
    background: rgba(255, 255, 255, 0.2);
    padding: 3px 8px;
    border-radius: 10px;
    font-size: 10px;
    display: inline-block;
    margin-top: 5px;
}

.announcement-actions {
    position: absolute;
    top: 10px;
    right: 10px;
    display: flex;
    gap: 5px;
}

.announcement-btn {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    width: 24px;
    height: 24px;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    transition: all 0.3s;
}

.announcement-btn:hover {
    background: rgba(255, 255, 255, 0.3);
}

/* Forms */
.form-row {
    margin-bottom: 12px;
}

textarea.form-control {
    min-height: 80px;
    resize: vertical;
    font-family: inherit;
}

.form-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

.form-actions .btn {
    flex: 1;
}

/* Tables */
.table-container {
    overflow-x: auto;
    margin-top: 15px;
    border: 1px solid #e0e6ed;
    border-radius: 6px;
    -webkit-overflow-scrolling: touch;
}

table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    min-width: 600px;
}

th, td {
    padding: 10px;
    text-align: left;
    border-bottom: 1px solid #e0e6ed;
    font-size: 13px;
}

th {
    background: #f8f9fa;
    font-weight: 600;
    color: #2c3e50;
    position: sticky;
    top: 0;
}

td {
    vertical-align: top;
}

tr:hover {
    background: #f8f9fa;
}

/* Quick Actions */
.quick-actions {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 10px;
    margin-top: 20px;
}

.quick-actions .btn {
    flex-direction: column;
    padding: 12px 8px;
    height: auto;
    min-height: 70px;
    white-space: normal;
    line-height: 1.3;
}

.btn-icon {
    font-size: 20px;
    margin-bottom: 5px;
}

/* Balance Display */
.balance-display {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 10px;
    margin-top: 15px;
    margin-bottom: 20px;
}

.balance-box {
    background: #f8f9fa;
    padding: 15px 10px;
    border-radius: 8px;
    text-align: center;
    border: 2px solid #e0e6ed;
}

.balance-value {
    font-size: 24px;
    font-weight: bold;
    color: #2c3e50;
    margin: 5px 0;
}

.balance-label {
    font-size: 11px;
    color: #7f8c8d;
    text-transform: uppercase;
    display: block;
}

/* Excel Import Area */
.excel-import-area {
    background: #f8f9fa;
    border: 2px dashed #3498db;
    border-radius: 8px;
    padding: 20px 15px;
    text-align: center;
    margin-bottom: 15px;
    cursor: pointer;
}

.excel-import-area:hover {
    background: #e8f4fc;
}

.import-hint {
    font-size: 12px;
    color: #666;
    margin-top: 5px;
}

.excel-paste-box {
    width: 100%;
    min-height: 100px;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-family: monospace;
    font-size: 12px;
    resize: vertical;
}

/* Tab Controls */
.tab-controls {
    display: flex;
    gap: 5px;
    margin-bottom: 15px;
    border-bottom: 2px solid #e0e6ed;
    padding-bottom: 10px;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}

.tab-btn {
    padding: 8px 12px;
    border: none;
    background: #f0f0f0;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.3s;
    white-space: nowrap;
    flex-shrink: 0;
}

.tab-btn.active {
    background: #3498db;
    color: white;
}

/* Loading */
.loading {
    text-align: center;
    padding: 30px 15px;
    color: #7f8c8d;
}

.spinner {
    border: 3px solid #f3f3f3;
    border-top: 3px solid #3498db;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    animation: spin 1s linear infinite;
    margin: 0 auto 10px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Status */
.status-pending {
    color: #f39c12;
    font-weight: 500;
}

.status-approved {
    color: #27ae60;
    font-weight: 500;
}

.status-rejected {
    color: #e74c3c;
    font-weight: 500;
}

.status-off {
    color: #7f8c8d;
    font-weight: 500;
}

.status-completed {
    color: #3498db;
    font-weight: 500;
}

/* Action Buttons */
.action-buttons {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
}

.action-btn {
    padding: 4px 8px;
    border: none;
    border-radius: 4px;
    font-size: 11px;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
}

.action-btn.approve {
    background: #d4edda;
    color: #155724;
}

.action-btn.reject {
    background: #f8d7da;
    color: #721c24;
}

.action-btn.view {
    background: #d1ecf1;
    color: #0c5460;
}

.action-btn.apply {
    background: #cce5ff;
    color: #004085;
}

.action-btn.delete {
    background: #f8d7da;
    color: #721c24;
}

.action-btn.edit {
    background: #fff3cd;
    color: #856404;
}

/* Alerts */
.alert {
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 15px;
    border-left: 4px solid;
    font-size: 13px;
    line-height: 1.4;
}

.alert-info {
    background: #e8f4fc;
    border-color: #3498db;
    color: #2c3e50;
}

.alert-success {
    background: #d4edda;
    border-color: #27ae60;
    color: #155724;
}

.alert-warning {
    background: #fff3cd;
    border-color: #f39c12;
    color: #856404;
}

.alert-danger {
    background: #f8d7da;
    border-color: #e74c3c;
    color: #721c24;
}

/* Excel-like table */
.excel-table {
    font-family: inherit;
    font-size: 12px;
}

.excel-table td {
    padding: 8px;
    border: 1px solid #ddd;
    white-space: nowrap;
}

.excel-table th {
    background: #f0f0f0;
    border: 1px solid #ddd;
    font-size: 11px;
}

.excel-input {
    width: 100%;
    border: none;
    background: transparent;
    font-family: inherit;
    font-size: 12px;
    padding: 4px;
}

.excel-input:focus {
    outline: 2px solid #3498db;
    background: white;
}

/* Calendar View */
.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
    margin-top: 15px;
}

.calendar-day {
    border: 1px solid #e0e6ed;
    padding: 8px 4px;
    min-height: 50px;
    border-radius: 4px;
    background: #f8f9fa;
    font-size: 12px;
    overflow: hidden;
}

.calendar-day.off-day {
    background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
}

.calendar-day.duty-day {
    background: linear-gradient(135deg, #cce5ff 0%, #b8daff 100%);
}

.calendar-day.today {
    border: 2px solid #3498db;
    background: linear-gradient(135deg, #e8f4fc 0%, #d1ecf1 100%);
}

.day-header {
    font-weight: bold;
    font-size: 11px;
    color: #2c3e50;
    margin-bottom: 3px;
    text-align: center;
}

.duty-time {
    font-size: 10px;
    color: #155724;
    text-align: center;
}

.off-time {
    font-size: 10px;
    color: #721c24;
    text-align: center;
}

/* Request History */
.request-history-table {
    font-size: 12px;
}

.request-history-table td {
    padding: 8px 6px;
    vertical-align: top;
}

.request-details {
    background: #f8f9fa;
    padding: 5px;
    border-radius: 4px;
    margin: 2px 0;
    font-size: 11px;
}

.status-update {
    font-style: italic;
    color: #666;
    font-size: 11px;
}

.timestamp {
    font-size: 11px;
    color: #888;
}

/* View All Roster Styles */
.roster-all-view {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}

.staff-name {
    font-weight: 600;
    color: #2c3e50;
    font-size: 12px;
}

.leave-indicator {
    background: linear-gradient(135deg, #ffd6a5 0%, #ffc677 100%);
    border: 1px solid #ffb142;
    border-radius: 3px;
    padding: 2px 5px;
    font-size: 9px;
    margin-left: 3px;
    color: #cc8e35;
    font-weight: bold;
    display: inline-block;
}

.off-day-cell {
    background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%) !important;
    color: #155724 !important;
    font-weight: 500;
}

/* DUTY TIME COLORS WITH GRADIENTS */
.duty-0730-1530 {
    background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%) !important;
    color: #856404 !important;
}

.duty-0830-1630 {
    background: linear-gradient(135deg, #e2d9f3 0%, #d6c6f7 100%) !important;
    color: #563d7c !important;
}

.duty-1030-1830 {
    background: linear-gradient(135deg, #fffde7 0%, #fff9c4 100%) !important;
    color: #827717 !important;
}

.duty-1530-2330 {
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%) !important;
    color: #0d47a1 !important;
}

.duty-1630-0030 {
    background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%) !important;
    color: #424242 !important;
}

.duty-1730-0130 {
    background: linear-gradient(135deg, #eeeeee 0%, #bdbdbd 100%) !important;
    color: #212121 !important;
}

.duty-0030-0830 {
    background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%) !important;
    color: #c62828 !important;
}

.duty-leave {
    background: linear-gradient(135deg, #ffd8a6 0%, #ffc078 100%) !important;
    color: #e8590c !important;
    border: 1px dashed #fd7e14 !important;
}

.duty-0000-0800 {
    background: linear-gradient(135deg, #e8f4fc 0%, #d1ecf1 100%) !important;
    color: #0c5460 !important;
}

.duty-0600-1400 {
    background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%) !important;
    color: #155724 !important;
}

.duty-0700-1500 {
    background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%) !important;
    color: #856404 !important;
}

.duty-0800-1600 {
    background: linear-gradient(135deg, #e2d9f3 0%, #d6c6f7 100%) !important;
    color: #563d7c !important;
}

.duty-1200-2000 {
    background: linear-gradient(135deg, #c7e5d4 0%, #a5d6a7 100%) !important;
    color: #1b5e20 !important;
}

.duty-1300-2100 {
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%) !important;
    color: #0d47a1 !important;
}

.duty-1600-0000 {
    background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%) !important;
    color: #424242 !important;
}

.duty-1900-0300 {
    background: linear-gradient(135deg, #e0e0e0 0%, #9e9e9e 100%) !important;
    color: #000 !important;
}

.duty-2100-0500 {
    background: linear-gradient(135deg, #bdbdbd 0%, #757575 100%) !important;
    color: #fff !important;
}

.duty-2300-0700 {
    background: linear-gradient(135deg, #9e9e9e 0%, #616161 100%) !important;
    color: #fff !important;
}

.duty-mixed {
    background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%) !important;
    color: #856404 !important;
    border: 1px dashed #f39c12 !important;
}

.duty-special {
    background: linear-gradient(135deg, #e2d9f3 0%, #d6c6f7 100%) !important;
    color: #563d7c !important;
    border: 1px dashed #9c27b0 !important;
}

.duty-other {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%) !important;
    color: #495057 !important;
    border: 1px dashed #6c757d !important;
}

.today-cell {
    border: 2px solid #3498db !important;
    box-shadow: 0 0 5px rgba(52, 152, 219, 0.3) !important;
}

/* Date Navigation */
.date-navigation {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    margin-bottom: 15px;
}

.date-nav-btn {
    background: #3498db;
    color: white;
    border: none;
    border-radius: 5px;
    padding: 8px 12px;
    cursor: pointer;
    font-size: 12px;
    transition: background 0.3s;
    white-space: nowrap;
}

.date-nav-btn:hover {
    background: #2980b9;
}

.current-date-display {
    font-weight: 600;
    color: #2c3e50;
    font-size: 13px;
    text-align: center;
    flex: 1;
}

/* Legend */
.legend {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 8px;
    margin-top: 15px;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 6px;
    border: 1px solid #e0e6ed;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 11px;
}

.legend-color {
    width: 15px;
    height: 15px;
    border-radius: 3px;
    border: 1px solid rgba(0,0,0,0.1);
    flex-shrink: 0;
}

/* Announcement Admin Styles */
.announcement-form-card {
    margin-bottom: 20px;
}

.priority-options {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    margin-top: 10px;
}

.priority-btn {
    padding: 10px 5px;
    border: 2px solid #e0e6ed;
    border-radius: 6px;
    background: white;
    cursor: pointer;
    text-align: center;
    transition: all 0.3s;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 3px;
}

.priority-btn:hover {
    transform: translateY(-2px);
}

.priority-btn.active {
    border-color: #3498db;
    background: #e8f4fc;
}

.priority-btn.high {
    border-left-color: #e74c3c;
}

.priority-btn.medium {
    border-left-color: #f39c12;
}

.priority-btn.low {
    border-left-color: #27ae60;
}

.target-options {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
}

.target-option {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 13px;
}

.char-count {
    color: #666;
    font-size: 11px;
    display: block;
    margin-top: 3px;
}

.no-announcements {
    text-align: center;
    padding: 30px 15px;
    color: #7f8c8d;
    background: #f8f9fa;
    border-radius: 8px;
    border: 2px dashed #e0e6ed;
}

.no-announcements .icon {
    font-size: 40px;
    margin-bottom: 10px;
    opacity: 0.5;
}

/* Overlay for mobile menu */
.overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 999;
}

.overlay.active {
    display: block;
}

/* Media Queries */
@media (min-width: 768px) {
    body {
        padding: 20px;
    }
    
    .dashboard-container {
        position: relative;
        height: auto;
        min-height: 600px;
        max-width: 1200px;
        margin: 0 auto;
        border-radius: 15px;
        overflow: hidden;
    }
    
    .dashboard-header {
        position: relative;
        height: auto;
        padding: 20px 30px;
    }
    
    .dashboard-nav {
        position: relative;
        top: 0;
        left: 0;
        width: 100%;
        height: auto;
        display: flex;
        padding: 12px 30px;
        gap: 10px;
        flex-wrap: wrap;
        overflow: visible;
    }
    
    .nav-header, .close-nav {
        display: none;
    }
    
    .nav-btn {
        border-left: none;
        border-radius: 6px;
        padding: 8px 16px;
        width: auto;
        font-size: 13px;
    }
    
    .nav-btn:hover {
        border-left: none;
        background: rgba(255, 255, 255, 0.1);
    }
    
    .nav-btn.active {
        background: #3498db;
        border-left: none;
    }
    
    .nav-icon {
        display: none;
    }
    
    .nav-divider {
        display: none;
    }
    
    .mobile-menu-btn {
        display: none;
    }
    
    .dashboard-content {
        padding: 25px;
        min-height: 500px;
    }
    
    .card {
        padding: 20px;
    }
    
    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
    }
    
    .form-actions {
        display: flex;
        gap: 10px;
    }
    
    .form-actions .btn {
        flex: none;
        width: auto;
    }
    
    .btn-block {
        width: auto;
        display: inline-flex;
    }
    
    .quick-actions {
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 15px;
    }
    
    .quick-actions .btn {
        padding: 15px 10px;
    }
    
    .overlay {
        display: none !important;
    }
}

@media (min-width: 1024px) {
    .form-row {
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    }
    
    .balance-display {
        grid-template-columns: repeat(2, 1fr);
        max-width: 500px;
    }
    
    .quick-actions {
        grid-template-columns: repeat(5, 1fr);
    }
}

@media (max-width: 767px) {
    .user-info h2 {
        max-width: 120px;
    }
    
    .header-actions {
        flex-shrink: 0;
    }
    
    .mobile-menu-btn {
        display: flex;
    }
    
    .nav-btn {
        justify-content: flex-start;
    }
    
    .priority-options {
        grid-template-columns: 1fr;
    }
    
    .target-options {
        flex-direction: column;
        gap: 8px;
    }
    
    .date-navigation {
        flex-direction: column;
        gap: 8px;
    }
    
    .date-nav-btn {
        width: 100%;
    }
    
    .current-date-display {
        order: -1;
        margin-bottom: 5px;
    }
    
    .roster-all-view table {
        min-width: 800px;
    }
    
    #announcementStaff {
        height: 150px;
    }
}

@media (max-width: 480px) {
    .login-container {
        padding: 20px 15px;
    }
    
    .logo h1 {
        font-size: 22px;
    }
    
    .dashboard-header {
        padding: 12px 15px;
    }
    
    .dashboard-content {
        padding: 70px 10px 10px;
    }
    
    .card {
        padding: 15px 12px;
    }
    
    .balance-value {
        font-size: 22px;
    }
    
    .quick-actions {
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
    }
    
    .quick-actions .btn {
        min-height: 60px;
        padding: 10px 5px;
        font-size: 13px;
    }
    
    .btn-icon {
        font-size: 18px;
    }
    
    .legend {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .calendar-grid {
        grid-template-columns: repeat(7, 1fr);
        gap: 2px;
    }
    
    .calendar-day {
        padding: 4px 2px;
        min-height: 40px;
        font-size: 11px;
    }
    
    .day-header {
        font-size: 10px;
    }
}

/* Print Styles */
@media print {
    .dashboard-nav,
    .mobile-menu-btn,
    .header-actions,
    .form-actions,
    .tab-controls,
    .action-buttons,
    .announcement-actions,
    button {
        display: none !important;
    }
    
    .dashboard-container {
        position: static;
        height: auto;
        box-shadow: none;
        border-radius: 0;
    }
    
    .dashboard-header {
        position: static;
        margin-bottom: 20px;
    }
    
    .dashboard-content {
        padding: 0;
        overflow: visible;
    }
    
    .card {
        box-shadow: none;
        border: 1px solid #ddd;
        page-break-inside: avoid;
    }
    
    .section {
        display: block !important;
        page-break-before: always;
    }
    
    .section.active {
        page-break-before: auto;
    }
    
    .table-container {
        overflow: visible;
    }
    
    table {
        page-break-inside: avoid;
    }
}
        </style>
</head>
<body>
    <!-- Login Container -->
    <div class="login-container" id="loginContainer">
        <div class="logo">
            <h1>Duty Management</h1>
            <p>Secure Login System</p>
        </div>
        
        <form id="loginForm">
            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" class="form-control" placeholder="Enter username" required autofocus>
            </div>
            
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" class="form-control" placeholder="Enter password" required>
            </div>
            
            <button type="submit" class="btn btn-primary btn-block" id="loginBtn">Login</button>
            
            <div class="error-message" id="errorMessage">
                Invalid username or password
            </div>
        </form>
    </div>
    
    <!-- Dashboard Container -->
    <div class="dashboard-container" id="dashboardContainer">
        <!-- Header -->
        <div class="dashboard-header">
            <div class="user-info">
                <h2 id="userName">User Name</h2>
                <div class="user-details">
                    <span>RC: <span id="userRC">000</span></span>
                    <span>Level: <span id="userLevel">User</span></span>
                </div>
            </div>
            <div class="mobile-menu-btn" id="mobileMenuBtn">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <div class="header-actions">
                <button class="btn btn-danger" id="logoutBtn">Logout</button>
            </div>
        </div>
        
        <!-- Navigation -->
        <div class="dashboard-nav" id="dashboardNav">
            <div class="nav-header">
                <span>Menu</span>
                <button class="close-nav" id="closeNavBtn">√ó</button>
            </div>
            <button class="nav-btn active" data-section="home">
                <span class="nav-icon">üè†</span>
                <span class="nav-text">Dashboard</span>
            </button>
            <button class="nav-btn" data-section="dutyChange">
                <span class="nav-icon">üîÑ</span>
                <span class="nav-text">Duty Change</span>
            </button>
            <button class="nav-btn" data-section="leaveApplication">
                <span class="nav-icon">üìÖ</span>
                <span class="nav-text">Apply Leave</span>
            </button>
            <button class="nav-btn" data-section="myRequests">
                <span class="nav-icon">üìã</span>
                <span class="nav-text">My Requests</span>
            </button>
            <button class="nav-btn" data-section="viewMyRoster">
                <span class="nav-icon">üë§</span>
                <span class="nav-text">My Roster</span>
            </button>
            <button class="nav-btn" data-section="viewAllRoster" id="viewAllRosterBtn">
                <span class="nav-icon">üë•</span>
                <span class="nav-text">View All Roster</span>
            </button>
            <button class="nav-btn" data-section="pendingRequests" id="pendingRequestsBtn" style="display:none;">
                <span class="nav-icon">‚è≥</span>
                <span class="nav-text">Pending</span>
                <span id="pendingCount" class="notification-badge">0</span>
            </button>
            
            <!-- Admin Only -->
            <div class="nav-divider" id="adminDivider" style="display:none;">Admin</div>
            <button class="nav-btn" data-section="adminDutyRoster" id="adminDutyRosterBtn" style="display:none;">
                <span class="nav-icon">üìä</span>
                <span class="nav-text">Duty Roster</span>
            </button>
            <button class="nav-btn" data-section="adminLeaveBalance" id="adminLeaveBalanceBtn" style="display:none;">
                <span class="nav-icon">üí∞</span>
                <span class="nav-text">Leave Balance</span>
            </button>
            <button class="nav-btn" data-section="adminApprovals" id="adminApprovalsBtn" style="display:none;">
                <span class="nav-icon">‚úÖ</span>
                <span class="nav-text">Approvals</span>
            </button>
            <button class="nav-btn" data-section="adminRequestHistory" id="adminRequestHistoryBtn" style="display:none;">
                <span class="nav-icon">üìú</span>
                <span class="nav-text">Request History</span>
                <span id="historyNotification" class="notification-dot" style="display:none;"></span>
            </button>
            <button class="nav-btn" data-section="adminAnnouncements" id="adminAnnouncementsBtn" style="display:none;">
                <span class="nav-icon">üì¢</span>
                <span class="nav-text">Announcements</span>
            </button>
        </div>
        
        <!-- Content Area -->
        <div class="dashboard-content">
            <!-- Dashboard -->
            <div class="section active" id="homeSection">
                <div id="homeAnnouncements">
                    <!-- Announcements will be loaded here -->
                </div>
                
                <div class="card">
                    <h3>Welcome, <span id="welcomeName">User</span>!</h3>
                    
                    <div class="balance-display">
                        <div class="balance-box">
                            <div class="balance-label">Sick Leave</div>
                            <div class="balance-value" id="slBalance">0</div>
                            <div class="balance-label">Days</div>
                        </div>
                        <div class="balance-box">
                            <div class="balance-label">FRL Balance</div>
                            <div class="balance-value" id="frlBalance">0</div>
                            <div class="balance-label">Days</div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <p><strong>Today's Duty:</strong> <span id="todayDutyTime">Not Scheduled</span></p>
                        <p><strong>Next Duty:</strong> <span id="nextDutyTime">No upcoming duty</span></p>
                        <div id="homeNotifications" style="margin-top: 10px; display: none;">
                            <!-- Notifications will appear here -->
                        </div>
                    </div>
                    
                    <div class="quick-actions">
                        <button class="btn btn-warning" onclick="showSection('dutyChange')">
                            <span class="btn-icon">üîÑ</span>
                            Duty Change
                        </button>
                        <button class="btn btn-success" onclick="showSection('leaveApplication')">
                            <span class="btn-icon">üìÖ</span>
                            Apply Leave
                        </button>
                        <button class="btn btn-primary" onclick="showSection('myRequests')">
                            <span class="btn-icon">üìã</span>
                            My Requests
                        </button>
                        <button class="btn btn-primary" onclick="showSection('viewMyRoster')">
                            <span class="btn-icon">üë§</span>
                            My Roster
                        </button>
                        <button class="btn btn-primary" onclick="showSection('viewAllRoster')">
                            <span class="btn-icon">üë•</span>
                            All Roster
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Duty Change Request -->
            <div class="section" id="dutyChangeSection">
                <div class="card">
                    <h3>Duty Change Request</h3>
                    
                    <div class="alert alert-warning">
                        <strong>Note:</strong> Requests must be made at least 24 hours in advance. No back dates allowed.
                    </div>
                    
                    <form id="dutyChangeForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="changeDate">Change Date *</label>
                                <input type="date" id="changeDate" class="form-control" required min="">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="changeDutyTime">Your Duty Time *</label>
                                <select id="changeDutyTime" class="form-control" required>
                                    <option value="">Select duty time</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="requestToStaff">Request To Staff *</label>
                                <select id="requestToStaff" class="form-control" required>
                                    <option value="">Select staff member</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="requestToRcNo">Staff RC No</label>
                                <input type="text" id="requestToRcNo" class="form-control" readonly>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="requestToDutyTime">Staff's Duty Time *</label>
                                <select id="requestToDutyTime" class="form-control" required>
                                    <option value="">Select duty time</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="changeReason">Reason (Optional)</label>
                                <textarea id="changeReason" class="form-control" rows="2" placeholder="Brief reason for duty change"></textarea>
                            </div>
                        </div>
                        
                        <div class="form-row form-actions">
                            <button type="submit" class="btn btn-success">Submit Request</button>
                            <button type="button" class="btn btn-danger" onclick="showSection('home')">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Leave Application -->
            <div class="section" id="leaveApplicationSection">
                <div class="card">
                    <h3>Leave Application</h3>
                    
                    <div class="alert alert-info">
                        <p><strong>Application Rules:</strong></p>
                        <p>‚Ä¢ Sick Leave: Minimum 2 hours before duty time</p>
                        <p>‚Ä¢ FRL: Minimum 1 hour before duty time</p>
                        <p>‚Ä¢ No back dated applications allowed</p>
                    </div>
                    
                    <form id="leaveApplicationForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="leaveType">Leave Type *</label>
                                <select id="leaveType" class="form-control" required>
                                    <option value="">Select leave type</option>
                                    <option value="Sick Leave">Sick Leave</option>
                                    <option value="FRL">FRL</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="leaveDate">Leave Date *</label>
                                <input type="date" id="leaveDate" class="form-control" required min="">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="leaveDutyTime">Duty Time *</label>
                                <select id="leaveDutyTime" class="form-control" required>
                                    <option value="">Select duty time</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="leaveDuration">Duration *</label>
                                <select id="leaveDuration" class="form-control" required>
                                    <option value="1">1 Day</option>
                                    <option value="0.5">Half Day</option>
                                    <option value="2">2 Days</option>
                                    <option value="3">3 Days</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="leaveReason">Reason *</label>
                                <textarea id="leaveReason" class="form-control" rows="3" placeholder="Please provide reason for leave" required></textarea>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="alert" id="leaveRulesAlert">
                                Select leave type, date and duty time to see rules
                            </div>
                        </div>
                        
                        <div class="form-row form-actions">
                            <button type="submit" class="btn btn-success" id="submitLeaveBtn">Submit Application</button>
                            <button type="button" class="btn btn-danger" onclick="showSection('home')">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- My Requests -->
            <div class="section" id="myRequestsSection">
                <div class="card">
                    <h3>My Requests</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Date</th>
                                    <th>Details</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="myRequestsTable">
                                <!-- Filled by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- My Roster (User View) -->
            <div class="section" id="viewMyRosterSection">
                <div class="card">
                    <h3>My Duty Roster</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="myRosterMonth">View Month</label>
                            <input type="month" id="myRosterMonth" class="form-control" value="">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="myRosterViewType">View Type</label>
                            <select id="myRosterViewType" class="form-control">
                                <option value="table">Table View</option>
                                <option value="calendar">Calendar View</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <button class="btn btn-primary btn-block" onclick="loadMyRoster()">Load Roster</button>
                    </div>
                    
                    <div class="alert alert-info">
                        This shows your scheduled duties. Changes must be requested via Duty Change.
                    </div>
                    
                    <div id="myRosterContainer" style="margin-top: 20px;">
                        <!-- Roster will be displayed here -->
                    </div>
                </div>
            </div>
            
            <!-- Pending Requests -->
            <div class="section" id="pendingRequestsSection">
                <div class="card">
                    <h3>Pending Requests For You</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>From</th>
                                    <th>Date</th>
                                    <th>Details</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="pendingRequestsTable">
                                <!-- Filled by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- View All Roster (Accessible to All Users) -->
            <div class="section" id="viewAllRosterSection">
                <div class="card">
                    <h3>Complete Duty Roster - All Staff</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="allRosterStartDate">From Date</label>
                            <input type="date" id="allRosterStartDate" class="form-control" value="">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="allRosterEndDate">To Date</label>
                            <input type="date" id="allRosterEndDate" class="form-control" value="">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="allRosterViewType">View Type</label>
                            <select id="allRosterViewType" class="form-control">
                                <option value="table">Daily Table</option>
                                <option value="staff">Staff View</option>
                                <option value="calendar">Calendar View</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <button class="btn btn-primary btn-block" onclick="loadAllRoster()">Load Roster</button>
                    </div>
                    
                    <div class="form-row">
                        <button class="btn btn-secondary btn-block" onclick="printAllRoster()">Print</button>
                    </div>
                    
                    <div class="alert alert-info">
                        This shows the complete duty roster for all staff members. Different shift timings are color-coded for easy identification.
                    </div>
                    
                    <div id="allRosterContainer" style="margin-top: 20px;">
                        <!-- Complete roster will be displayed here -->
                    </div>
                </div>
            </div>
            
            <!-- Admin: Announcement Management -->
            <div class="section" id="adminAnnouncementsSection">
                <div class="card announcement-form-card">
                    <h3>Create Announcement</h3>
                    
                    <form id="announcementForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="announcementTitle">Title *</label>
                                <input type="text" id="announcementTitle" class="form-control" placeholder="Enter announcement title" required maxlength="100">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="announcementPriority">Priority *</label>
                                <div class="priority-options">
                                    <div class="priority-btn high" data-priority="high" onclick="selectPriority('high')">
                                        <span>High</span>
                                        <small>Urgent</small>
                                    </div>
                                    <div class="priority-btn medium active" data-priority="medium" onclick="selectPriority('medium')">
                                        <span>Medium</span>
                                        <small>Important</small>
                                    </div>
                                    <div class="priority-btn low" data-priority="low" onclick="selectPriority('low')">
                                        <span>Low</span>
                                        <small>Notice</small>
                                    </div>
                                </div>
                                <input type="hidden" id="announcementPriority" value="medium" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="announcementContent">Content *</label>
                                <textarea id="announcementContent" class="form-control" rows="4" placeholder="Enter announcement details..." required maxlength="500"></textarea>
                                <small class="char-count">Maximum 500 characters</small>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Target Audience *</label>
                                <div class="target-options">
                                    <label class="target-option">
                                        <input type="radio" name="target" value="all" checked onchange="updateTargetSelection()">
                                        All Staff
                                    </label>
                                    <label class="target-option">
                                        <input type="radio" name="target" value="specific" onchange="updateTargetSelection()">
                                        Specific Staff
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-row" id="specificStaffSection" style="display: none;">
                            <div class="form-group">
                                <label for="announcementStaff">Select Staff</label>
                                <select id="announcementStaff" class="form-control" multiple>
                                    <!-- Staff options will be loaded -->
                                </select>
                                <small class="char-count">Hold Ctrl/Cmd to select multiple staff</small>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="announcementExpiry">Expiry Date</label>
                                <input type="date" id="announcementExpiry" class="form-control">
                                <small class="char-count">Leave empty for no expiry</small>
                            </div>
                        </div>
                        
                        <div class="form-row form-actions">
                            <button type="submit" class="btn btn-success" id="createAnnouncementBtn">Create Announcement</button>
                            <button type="button" class="btn btn-danger" onclick="clearAnnouncementForm()">Clear Form</button>
                        </div>
                    </form>
                </div>
                
                <div class="card">
                    <h3>Active Announcements</h3>
                    <div id="activeAnnouncementsList">
                        <!-- Active announcements will be loaded here -->
                    </div>
                </div>
                
                <div class="card">
                    <h3>Expired Announcements</h3>
                    <div id="expiredAnnouncementsList">
                        <!-- Expired announcements will be loaded here -->
                    </div>
                </div>
            </div>
            
            <!-- Admin: Duty Roster Management -->
            <div class="section" id="adminDutyRosterSection">
                <div class="card">
                    <h3>Duty Roster Management</h3>
                    
                    <div class="tab-controls">
                        <button class="tab-btn active" onclick="showRosterTab('excelImport')">Excel Import</button>
                        <button class="tab-btn" onclick="showRosterTab('manualEntry')">Manual Entry</button>
                        <button class="tab-btn" onclick="showRosterTab('viewRoster')">View Roster</button>
                    </div>
                    
                    <!-- Excel Import Tab -->
                    <div id="excelImportTab" class="roster-tab active">
                        <div class="alert alert-info">
                            <strong>Instructions:</strong> Copy your Excel data and paste below. Format: Date in first column, then staff names as columns, duty times as rows.
                        </div>
                        
                        <div class="excel-import-area" onclick="document.getElementById('excelPasteBox').focus()">
                            <p>üìã <strong>Click here and paste Excel data</strong></p>
                            <p class="import-hint">Format: Tab-separated values from Excel</p>
                        </div>
                        
                        <textarea id="excelPasteBox" class="excel-paste-box" placeholder="Paste Excel data here (Ctrl+V)...
Example:
Date	Irufan	Hussain	Mohamed
2024-01-01	08:00-16:00	16:00-00:00	00:00-08:00
2024-01-02	16:00-00:00	08:00-16:00	Off"></textarea>
                        
                        <div class="form-row">
                            <button class="btn btn-success btn-block" onclick="processExcelPaste()">Process Data</button>
                            <button class="btn btn-primary btn-block" onclick="loadSampleData()">Load Sample</button>
                            <button class="btn btn-danger btn-block" onclick="clearExcelPaste()">Clear</button>
                        </div>
                        
                        <div id="excelPreview" style="margin-top: 20px; display: none;">
                            <h4>Preview</h4>
                            <div class="table-container">
                                <table class="excel-table" id="excelPreviewTable">
                                    <!-- Preview will be shown here -->
                                </table>
                            </div>
                            <button class="btn btn-success btn-block" onclick="saveExcelData()" style="margin-top: 10px;">Save to Roster</button>
                        </div>
                    </div>
                    
                    <!-- Manual Entry Tab -->
                    <div id="manualEntryTab" class="roster-tab">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="rosterDate">Date</label>
                                <input type="date" id="rosterDate" class="form-control" value="">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="rosterStaffSingle">Staff</label>
                                <select id="rosterStaffSingle" class="form-control">
                                    <option value="">Select staff</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="rosterDutyTime">Duty Time</label>
                                <input type="text" id="rosterDutyTime" class="form-control" placeholder="e.g., 08:00-16:00 or Off">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <button class="btn btn-success btn-block" onclick="addRosterEntry()">Add Entry</button>
                            <button class="btn btn-primary btn-block" onclick="clearRosterForm()">Clear</button>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <h4>Today's Entries</h4>
                            <div class="table-container">
                                <table id="todayRosterTable">
                                    <thead>
                                        <tr>
                                            <th>Staff</th>
                                            <th>Duty Time</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Filled by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- View Roster Tab -->
                    <div id="viewRosterTab" class="roster-tab">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="viewRosterDate">View Date</label>
                                <input type="date" id="viewRosterDate" class="form-control" value="">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="viewRosterStaff">Staff Filter</label>
                                <select id="viewRosterStaff" class="form-control">
                                    <option value="">All Staff</option>
                                </select>
                            </div>
                        </div>
                        
                        <button class="btn btn-primary btn-block" onclick="loadRosterView()">Load Roster</button>
                        
                        <div id="rosterViewContainer" style="margin-top: 20px;">
                            <!-- Roster will be displayed here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Admin: Leave Balance Management -->
            <div class="section" id="adminLeaveBalanceSection">
                <div class="card">
                    <h3>Leave Balance Management</h3>
                    
                    <div class="tab-controls">
                        <button class="tab-btn active" onclick="showBalanceTab('bulkUpdate')">Bulk Update</button>
                        <button class="tab-btn" onclick="showBalanceTab('individual')">Individual</button>
                    </div>
                    
                    <!-- Bulk Update Tab -->
                    <div id="bulkUpdateTab" class="balance-tab active">
                        <div class="alert alert-info">
                            <strong>Instructions:</strong> Enter SL and FRL balances in days (e.g., 12.5 for 12 days and half day)
                        </div>
                        
                        <div class="table-container">
                            <table class="excel-table">
                                <thead>
                                    <tr>
                                        <th>Staff</th>
                                        <th>RC No</th>
                                        <th>SL Balance</th>
                                        <th>FRL Balance</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="bulkBalanceTable">
                                    <!-- Filled by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="form-row">
                            <button class="btn btn-success btn-block" onclick="saveAllBalances()">Save All Changes</button>
                            <button class="btn btn-primary btn-block" onclick="resetAllBalances()">Reset All to Default</button>
                        </div>
                    </div>
                    
                    <!-- Individual Tab -->
                    <div id="individualTab" class="balance-tab">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="balanceStaff">Select Staff</label>
                                <select id="balanceStaff" class="form-control">
                                    <option value="">Select staff</option>
                                </select>
                            </div>
                        </div>
                        
                        <div id="individualBalanceForm" style="display: none;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="individualSL">Sick Leave (Days)</label>
                                    <input type="number" id="individualSL" class="form-control" step="0.5" min="0">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="individualFRL">FRL (Days)</label>
                                    <input type="number" id="individualFRL" class="form-control" step="0.5" min="0">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <button class="btn btn-success btn-block" onclick="saveIndividualBalance()">Save Balance</button>
                                <button class="btn btn-primary btn-block" onclick="resetIndividualBalance()">Reset to Default</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Admin: Approve Requests -->
            <div class="section" id="adminApprovalsSection">
                <div class="card">
                    <h3>Approve/Reject Requests</h3>
                    
                    <div class="tab-controls">
                        <button class="tab-btn active" onclick="showApprovalsTab('pending')">Pending</button>
                        <button class="tab-btn" onclick="showApprovalsTab('approved')">Approved</button>
                        <button class="tab-btn" onclick="showApprovalsTab('rejected')">Rejected</button>
                    </div>
                    
                    <div id="pendingApprovalsTab" class="approvals-tab active">
                        <div class="table-container">
                            <table class="request-history-table">
                                <thead>
                                    <tr>
                                        <th>Staff</th>
                                        <th>Type</th>
                                        <th>Date</th>
                                        <th>Details</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="adminApprovalsTable">
                                    <!-- Filled by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div id="approvedApprovalsTab" class="approvals-tab">
                        <div class="table-container">
                            <table class="request-history-table">
                                <thead>
                                    <tr>
                                        <th>Staff</th>
                                        <th>Type</th>
                                        <th>Date</th>
                                        <th>Details</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="approvedRequestsTable">
                                    <!-- Filled by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div id="rejectedApprovalsTab" class="approvals-tab">
                        <div class="table-container">
                            <table class="request-history-table">
                                <thead>
                                    <tr>
                                        <th>Staff</th>
                                        <th>Type</th>
                                        <th>Date</th>
                                        <th>Details</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="rejectedRequestsTable">
                                    <!-- Filled by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Admin: Request History -->
            <div class="section" id="adminRequestHistorySection">
                <div class="card">
                    <h3>All Requests History</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="historyFilterStaff">Filter by Staff</label>
                            <select id="historyFilterStaff" class="form-control">
                                <option value="">All Staff</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="historyFilterType">Filter by Type</label>
                            <select id="historyFilterType" class="form-control">
                                <option value="">All Types</option>
                                <option value="dutyChange">Duty Change</option>
                                <option value="leave">Leave</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="historyFilterStatus">Filter by Status</label>
                            <select id="historyFilterStatus" class="form-control">
                                <option value="">All Status</option>
                                <option value="pending">Pending</option>
                                <option value="approved">Approved</option>
                                <option value="rejected">Rejected</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="historyStartDate">From Date</label>
                            <input type="date" id="historyStartDate" class="form-control">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="historyEndDate">To Date</label>
                            <input type="date" id="historyEndDate" class="form-control">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <button class="btn btn-primary btn-block" onclick="loadRequestHistory()">Filter</button>
                        <button class="btn btn-secondary btn-block" onclick="clearHistoryFilters()">Clear Filters</button>
                    </div>
                    
                    <div class="table-container" style="margin-top: 20px;">
                        <table class="request-history-table">
                            <thead>
                                <tr>
                                    <th>Staff</th>
                                    <th>Type</th>
                                    <th>Date</th>
                                    <th>Details</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="requestHistoryTable">
                                <!-- Filled by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Files -->
    <script src="dcfire.js"></script>
    <script src="user.js"></script>
    
<script>
// Global variables
let currentUser = null;
let allUsers = [];
let dutyRoster = {};
let leaveBalances = {};
let allRequests = [];
let announcements = [];
let userDisplayNameMap = {};
let firebaseReady = false;

// Updated color mapping for different duty times
const dutyTimeColorMap = {
    '0730-1530': 'duty-0730-1530',
    '0830-1630': 'duty-0830-1630',
    '1030-1830': 'duty-1030-1830',
    '1530-2330': 'duty-1530-2330',
    '1630-0030': 'duty-1630-0030',
    '1730-0130': 'duty-1730-0130',
    '0030-0830': 'duty-0030-0830',
    '0000-0800': 'duty-0000-0800',
    '0600-1400': 'duty-0600-1400',
    '0700-1500': 'duty-0700-1500',
    '0800-1600': 'duty-0800-1600',
    '1200-2000': 'duty-1200-2000',
    '1300-2100': 'duty-1300-2100',
    '1600-0000': 'duty-1600-0000',
    '1900-0300': 'duty-1900-0300',
    '2100-0500': 'duty-2100-0500',
    '2300-0700': 'duty-2300-0700',
    'mixed': 'duty-mixed',
    'special': 'duty-special',
    'leave': 'duty-leave'
};

// Initialize the application
document.addEventListener('DOMContentLoaded', function() {
    // Check if Firebase is available
    if (typeof db === 'undefined') {
        console.error('Firebase is not initialized. Make sure dcfire.js is loaded.');
        alert('Firebase initialization failed. Please check your configuration.');
        return;
    }
    
    // Wait for user data to load
    setTimeout(() => {
        if (typeof users === 'undefined') {
            console.error('User data not loaded. Make sure user.js is loaded.');
            alert('User data not loaded. Please check user.js file.');
            return;
        }
        
        firebaseReady = true;
        console.log('Firebase and user data loaded successfully');
        initApp();
    }, 1000);
});

function initApp() {
    if (!firebaseReady) {
        console.log('Waiting for Firebase to be ready...');
        setTimeout(initApp, 500);
        return;
    }
    
    console.log('Initializing application...');
    
    // Setup login
    document.getElementById('loginForm').addEventListener('submit', function(e) {
        e.preventDefault();
        handleLogin();
    });
    
    // Set minimum dates
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('changeDate').min = today;
    document.getElementById('leaveDate').min = today;
    document.getElementById('rosterDate').value = today;
    document.getElementById('viewRosterDate').value = today;
    document.getElementById('myRosterMonth').value = today.substring(0, 7);
    document.getElementById('allRosterStartDate').value = today;
    
    // Set end date to 7 days from now
    const endDate = new Date(today);
    endDate.setDate(endDate.getDate() + 7);
    document.getElementById('allRosterEndDate').value = endDate.toISOString().split('T')[0];
    
    // Mobile menu functionality
    document.getElementById('mobileMenuBtn').addEventListener('click', function() {
        document.getElementById('dashboardNav').classList.add('active');
        document.getElementById('overlay')?.classList.add('active');
    });
    
    document.getElementById('closeNavBtn').addEventListener('click', closeMobileMenu);
    
    // Create overlay for mobile menu if it doesn't exist
    if (!document.getElementById('overlay')) {
        const overlay = document.createElement('div');
        overlay.id = 'overlay';
        overlay.className = 'overlay';
        overlay.addEventListener('click', closeMobileMenu);
        document.body.appendChild(overlay);
    }
    
    // Check session
    checkSession();
}

function closeMobileMenu() {
    document.getElementById('dashboardNav').classList.remove('active');
    document.getElementById('overlay')?.classList.remove('active');
}

function getDateAfterDays(startDate, days) {
    const date = new Date(startDate);
    date.setDate(date.getDate() + days);
    return date.toISOString().split('T')[0];
}

function checkSession() {
    const session = localStorage.getItem('dutySystemSession');
    if (session) {
        try {
            const user = JSON.parse(session);
            if (user.expiry > Date.now()) {
                loginUser(user);
            } else {
                localStorage.removeItem('dutySystemSession');
            }
        } catch (e) {
            localStorage.removeItem('dutySystemSession');
        }
    }
}

function handleLogin() {
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value.trim();
    const errorMsg = document.getElementById('errorMessage');
    
    if (!username || !password) {
        showError('Please enter both username and password');
        return;
    }
    
    if (!users || !Array.isArray(users)) {
        showError('User database not loaded');
        return;
    }
    
    const user = users.find(u => u.username === username);
    
    if (!user) {
        showError('Invalid username or password');
        return;
    }
    
    // Hash and check password
    const hashedPassword = sha256(password);
    
    if (hashedPassword === user.passwordHash) {
        const sessionData = {
            username: user.username,
            name: user.name,
            rcNo: user.RCNo,
            level: user.Level,
            expiry: Date.now() + (8 * 60 * 60 * 1000)
        };
        
        localStorage.setItem('dutySystemSession', JSON.stringify(sessionData));
        loginUser(sessionData);
    } else {
        showError('Invalid username or password');
    }
}

function showError(message) {
    const errorMsg = document.getElementById('errorMessage');
    errorMsg.textContent = message;
    errorMsg.style.display = 'block';
}

function loginUser(userData) {
    currentUser = userData;
    allUsers = users || [];
    
    console.log('User logged in:', currentUser);
    
    // Initialize user display name map
    initializeUserDisplayMap();
    
    // Update UI
    document.getElementById('loginContainer').style.display = 'none';
    document.getElementById('dashboardContainer').style.display = 'block';
    
    document.getElementById('userName').textContent = userData.name;
    document.getElementById('userRC').textContent = userData.rcNo;
    document.getElementById('userLevel').textContent = userData.level;
    document.getElementById('welcomeName').textContent = userData.name;
    
    // Show/hide admin sections
    if (userData.level === 'Supervisor') {
        document.getElementById('adminDutyRosterBtn').style.display = 'flex';
        document.getElementById('adminLeaveBalanceBtn').style.display = 'flex';
        document.getElementById('adminApprovalsBtn').style.display = 'flex';
        document.getElementById('adminRequestHistoryBtn').style.display = 'flex';
        document.getElementById('adminAnnouncementsBtn').style.display = 'flex';
        document.getElementById('adminDivider').style.display = 'block';
    }
    
    // Always show "View All Roster" button to all users
    document.getElementById('viewAllRosterBtn').style.display = 'flex';
    
    // Initialize data and UI
    initializeData();
    setupNavigation();
    setupEventListeners();
    updateDashboard();
}

function initializeUserDisplayMap() {
    userDisplayNameMap = {};
    allUsers.forEach(user => {
        userDisplayNameMap[user.name] = user.username;
        userDisplayNameMap[user.RCNo] = user.username;
        userDisplayNameMap[user.username] = user.username;
        
        const nameLower = user.name.toLowerCase();
        const usernameLower = user.username.toLowerCase();
        userDisplayNameMap[nameLower] = user.username;
        userDisplayNameMap[usernameLower] = user.username;
    });
    
    console.log('User display map initialized:', userDisplayNameMap);
}

// FIREBASE FUNCTIONS
function loadDutyRoster() {
    console.log('Loading duty roster from Firebase...');
    return db.collection('dutyRoster').doc('current').get()
        .then(doc => {
            if (doc.exists) {
                dutyRoster = doc.data() || {};
                console.log('Duty roster loaded from Firebase:', Object.keys(dutyRoster).length, 'dates');
            } else {
                dutyRoster = {};
                saveDutyRoster();
            }
        })
        .catch(error => {
            console.error('Error loading duty roster:', error);
            dutyRoster = {};
        });
}

function saveDutyRoster() {
    console.log('Saving duty roster to Firebase...');
    return db.collection('dutyRoster').doc('current').set(dutyRoster)
        .then(() => {
            console.log('Duty roster saved to Firebase');
        })
        .catch(error => {
            console.error('Error saving duty roster:', error);
            alert('Failed to save duty roster. Please try again.');
        });
}

function loadLeaveBalances() {
    console.log('Loading leave balances from Firebase...');
    return db.collection('leaveBalances').doc('current').get()
        .then(doc => {
            if (doc.exists) {
                leaveBalances = doc.data() || {};
                console.log('Leave balances loaded from Firebase:', Object.keys(leaveBalances).length, 'users');
            } else {
                leaveBalances = {};
                allUsers.forEach(user => {
                    leaveBalances[user.username] = {
                        SL: 12,
                        FRL: 6
                    };
                });
                saveLeaveBalances();
            }
        })
        .catch(error => {
            console.error('Error loading leave balances:', error);
            leaveBalances = {};
        });
}

function saveLeaveBalances() {
    console.log('Saving leave balances to Firebase...');
    return db.collection('leaveBalances').doc('current').set(leaveBalances)
        .then(() => {
            console.log('Leave balances saved to Firebase');
        })
        .catch(error => {
            console.error('Error saving leave balances:', error);
            alert('Failed to save leave balances. Please try again.');
        });
}

function loadAllRequests() {
    console.log('Loading all requests from Firebase...');
    return db.collection('requests').doc('all').get()
        .then(doc => {
            if (doc.exists && doc.data().requests) {
                allRequests = doc.data().requests;
                console.log('Requests loaded from Firebase:', allRequests.length, 'requests');
            } else {
                allRequests = [];
            }
            updateRequestCounts();
        })
        .catch(error => {
            console.error('Error loading requests:', error);
            allRequests = [];
        });
}

function saveAllRequests() {
    console.log('Saving all requests to Firebase...');
    return db.collection('requests').doc('all').set({ requests: allRequests })
        .then(() => {
            console.log('Requests saved to Firebase');
        })
        .catch(error => {
            console.error('Error saving requests:', error);
            alert('Failed to save requests. Please try again.');
        });
}

function loadAnnouncements() {
    console.log('Loading announcements from Firebase...');
    return db.collection('announcements').doc('all').get()
        .then(doc => {
            if (doc.exists && doc.data().announcements) {
                announcements = doc.data().announcements;
                console.log('Announcements loaded from Firebase:', announcements.length, 'announcements');
            } else {
                announcements = [];
                saveAnnouncements();
            }
        })
        .catch(error => {
            console.error('Error loading announcements:', error);
            announcements = [];
        });
}

function saveAnnouncements() {
    console.log('Saving announcements to Firebase...');
    return db.collection('announcements').doc('all').set({ announcements: announcements })
        .then(() => {
            console.log('Announcements saved to Firebase');
        })
        .catch(error => {
            console.error('Error saving announcements:', error);
            alert('Failed to save announcements. Please try again.');
        });
}

async function initializeData() {
    console.log('Initializing all data from Firebase...');
    
    try {
        await Promise.all([
            loadDutyRoster(),
            loadLeaveBalances(),
            loadAllRequests(),
            loadAnnouncements()
        ]);
        
        console.log('All data loaded successfully from Firebase');
        updateUserBalance();
        
    } catch (error) {
        console.error('Error initializing data:', error);
        alert('Failed to load data from Firebase. Please refresh the page.');
    }
}

function updateUserBalance() {
    if (!currentUser) return;
    
    const balance = leaveBalances[currentUser.username] || {SL: 0, FRL: 0};
    document.getElementById('slBalance').textContent = balance.SL.toFixed(1);
    document.getElementById('frlBalance').textContent = balance.FRL.toFixed(1);
}

function setupNavigation() {
    const navBtns = document.querySelectorAll('.nav-btn');
    navBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            navBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            const sectionId = this.getAttribute('data-section');
            showSection(sectionId);
            
            // Close mobile menu on mobile
            if (window.innerWidth <= 767) {
                closeMobileMenu();
            }
        });
    });
    
    // Logout button
    document.getElementById('logoutBtn').addEventListener('click', function() {
        localStorage.removeItem('dutySystemSession');
        location.reload();
    });
}

function showSection(sectionId) {
    // Hide all sections
    document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
    });
    
    // Show selected section
    const section = document.getElementById(sectionId + 'Section');
    if (section) {
        section.classList.add('active');
        
        // Load section data
        switch(sectionId) {
            case 'home':
                loadHomeAnnouncements();
                break;
            case 'dutyChange':
                loadDutyChangeForm();
                break;
            case 'leaveApplication':
                loadLeaveForm();
                break;
            case 'myRequests':
                loadMyRequests();
                break;
            case 'viewMyRoster':
                loadMyRoster();
                break;
            case 'viewAllRoster':
                loadAllRoster();
                break;
            case 'pendingRequests':
                loadPendingRequests();
                break;
            case 'adminAnnouncements':
                loadAnnouncementsAdmin();
                break;
            case 'adminDutyRoster':
                loadDutyRosterAdmin();
                break;
            case 'adminLeaveBalance':
                loadLeaveBalanceAdmin();
                break;
            case 'adminApprovals':
                loadAdminApprovals();
                break;
            case 'adminRequestHistory':
                loadAdminRequestHistory();
                break;
        }
        
        // Scroll to top on mobile
        if (window.innerWidth <= 767) {
            window.scrollTo(0, 0);
        }
    }
}

function loadHomeAnnouncements() {
    const container = document.getElementById('homeAnnouncements');
    container.innerHTML = '';
    
    const now = new Date();
    const activeAnnouncements = announcements.filter(ann => {
        if (ann.status === 'expired' || ann.status === 'archived') return false;
        if (ann.expiry && new Date(ann.expiry) < now) return false;
        
        if (ann.target === 'all') return true;
        if (ann.target === 'specific' && ann.targetUsers && ann.targetUsers.includes(currentUser.username)) return true;
        return false;
    });
    
    if (activeAnnouncements.length === 0) return;
    
    activeAnnouncements.sort((a, b) => {
        const priorityOrder = {high: 0, medium: 1, low: 2};
        if (priorityOrder[a.priority] !== priorityOrder[b.priority]) {
            return priorityOrder[a.priority] - priorityOrder[b.priority];
        }
        return new Date(b.createdAt) - new Date(a.createdAt);
    });
    
    activeAnnouncements.forEach(ann => {
        const announcementDiv = document.createElement('div');
        announcementDiv.className = `announcement-banner priority-${ann.priority}`;
        
        let targetText = '';
        if (ann.target === 'all') {
            targetText = 'All Staff';
        } else {
            const targetNames = ann.targetUsers.map(username => {
                const user = allUsers.find(u => u.username === username);
                return user ? user.name : username;
            }).join(', ');
            targetText = `For: ${targetNames}`;
        }
        
        announcementDiv.innerHTML = `
            <div class="announcement-title">
                <span class="announcement-icon">üì¢</span>
                ${ann.title}
            </div>
            <div class="announcement-content">${ann.content}</div>
            <div class="announcement-meta">
                <div>
                    By: ${ann.createdBy} ‚Ä¢ ${formatTimeAgo(ann.createdAt)}
                    ${ann.expiry ? `<br>Expires: ${formatDate(ann.expiry)}` : ''}
                </div>
                <div class="announcement-target">${targetText}</div>
            </div>
        `;
        
        container.appendChild(announcementDiv);
    });
}

// Setup event listeners for the system
function setupEventListeners() {
    // Announcement listeners
    document.getElementById('createAnnouncementBtn')?.addEventListener('click', createAnnouncement);
    document.getElementById('clearAnnouncementBtn')?.addEventListener('click', clearAnnouncementForm);
    document.getElementById('announcementPriority')?.addEventListener('change', selectPriority);
    document.getElementById('announcementTarget')?.addEventListener('change', updateTargetSelection);
    
    // Duty change listeners
    document.getElementById('dutyChangeForm')?.addEventListener('submit', submitDutyChange);
    document.getElementById('leaveForm')?.addEventListener('submit', submitLeaveApplication);
    
    // Navigation listeners
    document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', (e) => {
            const tabId = e.target.getAttribute('href')?.substring(1);
            showTab(tabId);
        });
    });
    
    // Real-time updates
    setInterval(checkForUserUpdates, 30000); // Check every 30 seconds
}

// Load user duty times for form
function loadUserDutyTimes() {
    if (!currentUser) return;
    
    const db = firebase.firestore();
    db.collection('duty_times')
        .where('userId', '==', currentUser.uid)
        .where('status', '==', 'active')
        .get()
        .then(snapshot => {
            const select = document.getElementById('currentDuty');
            if (select) {
                select.innerHTML = '<option value="">Select current duty</option>';
                snapshot.forEach(doc => {
                    const duty = doc.data();
                    const option = document.createElement('option');
                    option.value = `${duty.date}|${duty.startTime}|${duty.endTime}`;
                    option.textContent = `${formatDate(duty.date)}: ${duty.startTime} - ${duty.endTime}`;
                    select.appendChild(option);
                });
            }
        })
        .catch(handleFirebaseError);
}

// Load staff duty times for admin
function loadStaffDutyTimes() {
    const db = firebase.firestore();
    db.collection('duty_times')
        .where('date', '>=', new Date().toISOString().split('T')[0])
        .orderBy('date')
        .get()
        .then(snapshot => {
            const staffDuties = {};
            snapshot.forEach(doc => {
                const duty = doc.data();
                if (!staffDuties[duty.userId]) {
                    staffDuties[duty.userId] = [];
                }
                staffDuties[duty.userId].push(duty);
            });
            window.staffDutyCache = staffDuties;
        })
        .catch(handleFirebaseError);
}

// Load duty change form
function loadDutyChangeForm() {
    loadUserDutyTimes();
    loadStaffDutyTimes();
    
    // Set minimum date for change to tomorrow
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    document.getElementById('newDutyDate')?.setAttribute('min', tomorrow.toISOString().split('T')[0]);
}

// Load leave form
function loadLeaveForm() {
    // Load leave balance
    if (currentUser) {
        const db = firebase.firestore();
        db.collection('leave_balances').doc(currentUser.uid).get()
            .then(doc => {
                if (doc.exists) {
                    const balance = doc.data();
                    document.getElementById('leaveBalance').textContent = balance.annual || 0;
                }
            })
            .catch(handleFirebaseError);
    }
    
    // Set date restrictions
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('leaveStart')?.setAttribute('min', today);
    document.getElementById('leaveEnd')?.setAttribute('min', today);
    
    // Date change listeners
    document.getElementById('leaveStart')?.addEventListener('change', updateLeaveRules);
    document.getElementById('leaveEnd')?.addEventListener('change', updateLeaveRules);
}

// Update leave form rules based on selection
function updateLeaveRules() {
    const startDate = document.getElementById('leaveStart').value;
    const endDate = document.getElementById('leaveEnd').value;
    const halfDaySelect = document.getElementById('leaveHalfDay');
    
    if (!startDate || !endDate) return;
    
    if (startDate === endDate) {
        halfDaySelect.disabled = false;
    } else {
        halfDaySelect.disabled = true;
        halfDaySelect.value = 'no';
    }
}

// Submit duty change request
function submitDutyChange(e) {
    e.preventDefault();
    if (!currentUser) return;
    
    const formData = new FormData(e.target);
    const requestData = {
        userId: currentUser.uid,
        userName: currentUser.displayName || currentUser.email,
        currentDuty: formData.get('currentDuty'),
        newDate: formData.get('newDutyDate'),
        newStartTime: formData.get('newStartTime'),
        newEndTime: formData.get('newEndTime'),
        reason: formData.get('reason'),
        status: 'pending',
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        type: 'duty_change'
    };
    
    const db = firebase.firestore();
    db.collection('requests').add(requestData)
        .then(() => {
            alert('Duty change request submitted successfully!');
            e.target.reset();
            updateRequestCounts();
        })
        .catch(handleFirebaseError);
}

// Submit leave application
function submitLeaveApplication(e) {
    e.preventDefault();
    if (!currentUser) return;
    
    const formData = new FormData(e.target);
    const startDate = new Date(formData.get('leaveStart'));
    const endDate = new Date(formData.get('leaveEnd'));
    const days = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
    
    const requestData = {
        userId: currentUser.uid,
        userName: currentUser.displayName || currentUser.email,
        leaveType: formData.get('leaveType'),
        startDate: formData.get('leaveStart'),
        endDate: formData.get('leaveEnd'),
        halfDay: formData.get('leaveHalfDay'),
        days: days,
        reason: formData.get('leaveReason'),
        contact: formData.get('emergencyContact'),
        status: 'pending',
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        type: 'leave'
    };
    
    const db = firebase.firestore();
    db.collection('requests').add(requestData)
        .then(() => {
            alert('Leave application submitted successfully!');
            e.target.reset();
            updateRequestCounts();
        })
        .catch(handleFirebaseError);
}

// Update request counts in navbar
function updateRequestCounts() {
    if (!isAdmin) return;
    
    const db = firebase.firestore();
    db.collection('requests')
        .where('status', '==', 'pending')
        .get()
        .then(snapshot => {
            const count = snapshot.size;
            const badge = document.querySelector('.request-count');
            if (badge) {
                badge.textContent = count;
                badge.style.display = count > 0 ? 'inline-block' : 'none';
            }
        })
        .catch(handleFirebaseError);
}

// Load user's requests
function loadMyRequests() {
    if (!currentUser) return;
    
    const db = firebase.firestore();
    const container = document.getElementById('myRequestsContainer');
    if (!container) return;
    
    db.collection('requests')
        .where('userId', '==', currentUser.uid)
        .orderBy('createdAt', 'desc')
        .get()
        .then(snapshot => {
            container.innerHTML = '';
            
            if (snapshot.empty) {
                container.innerHTML = '<p class="text-muted">No requests found.</p>';
                return;
            }
            
            snapshot.forEach(doc => {
                const request = doc.data();
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${request.type === 'duty_change' ? 'Duty Change' : 'Leave'}</td>
                    <td>${formatDate(request.startDate || request.newDate)}</td>
                    <td>${request.type === 'leave' ? `${request.days} day(s)` : `${request.newStartTime} - ${request.newEndTime}`}</td>
                    <td><span class="badge bg-${getStatusColor(request.status)}">${request.status}</span></td>
                    <td>${request.reason || '-'}</td>
                    <td>
                        ${request.status === 'pending' ? 
                            `<button class="btn btn-sm btn-danger" onclick="cancelRequest('${doc.id}')">Cancel</button>` : 
                            formatDateTime(request.respondedAt || request.createdAt)}
                    </td>
                `;
                container.appendChild(row);
            });
        })
        .catch(handleFirebaseError);
}

// Load user's roster
function loadMyRoster() {
    if (!currentUser) return;
    
    const db = firebase.firestore();
    const today = new Date().toISOString().split('T')[0];
    
    db.collection('duty_times')
        .where('userId', '==', currentUser.uid)
        .where('date', '>=', today)
        .orderBy('date')
        .limit(30)
        .get()
        .then(snapshot => {
            const container = document.getElementById('myRosterContainer');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (snapshot.empty) {
                container.innerHTML = '<p class="text-muted">No upcoming duties scheduled.</p>';
                return;
            }
            
            snapshot.forEach(doc => {
                const duty = doc.data();
                const dutyItem = document.createElement('div');
                dutyItem.className = 'duty-item';
                dutyItem.innerHTML = `
                    <div class="duty-date">${formatDate(duty.date)}</div>
                    <div class="duty-time ${getDutyTimeClass(duty.startTime, duty.endTime)}">
                        ${duty.startTime} - ${duty.endTime}
                    </div>
                    <div class="duty-location">${duty.location || 'Main Office'}</div>
                `;
                container.appendChild(dutyItem);
            });
        })
        .catch(handleFirebaseError);
}

// Display table view for all roster
function displayTableView(rosters) {
    const container = document.getElementById('allRosterContainer');
    if (!container) return;
    
    container.innerHTML = `
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Staff</th>
                        <th>Shift</th>
                        <th>Time</th>
                        <th>Location</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="rosterTableBody"></tbody>
            </table>
        </div>
    `;
    
    const tbody = document.getElementById('rosterTableBody');
    rosters.forEach(roster => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${formatDate(roster.date)}</td>
            <td>${roster.staffName}</td>
            <td>${roster.shiftType || 'Regular'}</td>
            <td>${roster.startTime} - ${roster.endTime}</td>
            <td>${roster.location || 'Main Office'}</td>
            <td><span class="badge bg-${getDutyTimeClass(roster.startTime, roster.endTime)}">Active</span></td>
        `;
        tbody.appendChild(row);
    });
}

// Get CSS class for duty time
function getDutyTimeClass(startTime, endTime) {
    const startHour = parseInt(startTime.split(':')[0]);
    if (startHour < 6) return 'warning'; // Early morning
    if (startHour < 14) return 'success'; // Day shift
    if (startHour < 22) return 'primary'; // Evening shift
    return 'secondary'; // Night shift
}

// Display all roster in table format
function displayAllRosterTable() {
    const db = firebase.firestore();
    const startDate = document.getElementById('rosterStartDate').value;
    const endDate = document.getElementById('rosterEndDate').value;
    
    let query = db.collection('duty_times')
        .where('date', '>=', startDate)
        .where('date', '<=', endDate)
        .orderBy('date');
    
    query.get()
        .then(snapshot => {
            const rosters = [];
            snapshot.forEach(doc => {
                rosters.push({ id: doc.id, ...doc.data() });
            });
            displayTableView(rosters);
            generateRosterSummary(rosters);
        })
        .catch(handleFirebaseError);
}

// Display calendar view
function displayCalendarView(rosters) {
    const container = document.getElementById('allRosterContainer');
    if (!container) return;
    
    // Group by date
    const byDate = {};
    rosters.forEach(roster => {
        if (!byDate[roster.date]) {
            byDate[roster.date] = [];
        }
        byDate[roster.date].push(roster);
    });
    
    container.innerHTML = '';
    Object.keys(byDate).sort().forEach(date => {
        const dateCard = document.createElement('div');
        dateCard.className = 'card mb-3';
        dateCard.innerHTML = `
            <div class="card-header bg-light">
                <h5 class="mb-0">${formatDate(date)}</h5>
            </div>
            <div class="card-body">
                <div class="row" id="roster-${date}"></div>
            </div>
        `;
        container.appendChild(dateCard);
        
        const row = document.getElementById(`roster-${date}`);
        byDate[date].forEach(roster => {
            const col = document.createElement('div');
            col.className = 'col-md-6 mb-2';
            col.innerHTML = `
                <div class="card h-100">
                    <div class="card-body">
                        <h6 class="card-title">${roster.staffName}</h6>
                        <p class="card-text">
                            <i class="fas fa-clock"></i> ${roster.startTime} - ${roster.endTime}<br>
                            <i class="fas fa-map-marker-alt"></i> ${roster.location || 'Main Office'}
                        </p>
                    </div>
                </div>
            `;
            row.appendChild(col);
        });
    });
}

// Display daily view
function displayAllRosterDaily() {
    const db = firebase.firestore();
    const date = document.getElementById('rosterDailyDate').value;
    
    db.collection('duty_times')
        .where('date', '==', date)
        .orderBy('startTime')
        .get()
        .then(snapshot => {
            const container = document.getElementById('allRosterContainer');
            container.innerHTML = `
                <h4 class="mb-3">Roster for ${formatDate(date)}</h4>
                <div class="timeline" id="dailyTimeline"></div>
            `;
            
            const timeline = document.getElementById('dailyTimeline');
            snapshot.forEach(doc => {
                const duty = doc.data();
                const item = document.createElement('div');
                item.className = 'timeline-item';
                item.innerHTML = `
                    <div class="timeline-time">${duty.startTime} - ${duty.endTime}</div>
                    <div class="timeline-content">
                        <h5>${duty.staffName}</h5>
                        <p>${duty.shiftType || 'Regular Shift'} ‚Ä¢ ${duty.location || 'Main Office'}</p>
                    </div>
                `;
                timeline.appendChild(item);
            });
        })
        .catch(handleFirebaseError);
}

// Display by staff view
function displayAllRosterByStaff() {
    const db = firebase.firestore();
    const startDate = document.getElementById('rosterStartDate').value;
    const endDate = document.getElementById('rosterEndDate').value;
    
    db.collection('duty_times')
        .where('date', '>=', startDate)
        .where('date', '<=', endDate)
        .get()
        .then(snapshot => {
            const byStaff = {};
            snapshot.forEach(doc => {
                const duty = doc.data();
                if (!byStaff[duty.userId]) {
                    byStaff[duty.userId] = {
                        name: duty.staffName,
                        duties: []
                    };
                }
                byStaff[duty.userId].duties.push(duty);
            });
            
            const container = document.getElementById('allRosterContainer');
            container.innerHTML = '';
            
            Object.values(byStaff).forEach(staff => {
                const card = document.createElement('div');
                card.className = 'card mb-3';
                card.innerHTML = `
                    <div class="card-header">
                        <h5 class="mb-0">${staff.name}</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Time</th>
                                        <th>Location</th>
                                    </tr>
                                </thead>
                                <tbody id="staff-${staff.name.replace(/\s+/g, '-')}"></tbody>
                            </table>
                        </div>
                    </div>
                `;
                container.appendChild(card);
                
                const tbody = document.getElementById(`staff-${staff.name.replace(/\s+/g, '-')}`);
                staff.duties.sort((a, b) => a.date.localeCompare(b.date)).forEach(duty => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${formatDate(duty.date)}</td>
                        <td>${duty.startTime} - ${duty.endTime}</td>
                        <td>${duty.location || 'Main Office'}</td>
                    `;
                    tbody.appendChild(row);
                });
            });
        })
        .catch(handleFirebaseError);
}

// Display calendar view
function displayAllRosterCalendar() {
    const container = document.getElementById('allRosterContainer');
    container.innerHTML = `
        <div id="rosterCalendar"></div>
        <script>
            // Initialize FullCalendar
            document.addEventListener('DOMContentLoaded', function() {
                const calendarEl = document.getElementById('rosterCalendar');
                const calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    events: '/api/roster-events', // You'd need to implement this endpoint
                    eventClick: function(info) {
                        alert('Event: ' + info.event.title);
                    }
                });
                calendar.render();
            });
        </script>
    `;
}

// Navigate all roster views
function navigateAllRoster(view) {
    switch(view) {
        case 'table':
            displayAllRosterTable();
            break;
        case 'daily':
            displayAllRosterDaily();
            break;
        case 'staff':
            displayAllRosterByStaff();
            break;
        case 'calendar':
            displayAllRosterCalendar();
            break;
    }
}

// Format date range for display
function formatDateRange(startDate, endDate) {
    if (startDate === endDate) {
        return formatDate(startDate);
    }
    return `${formatDate(startDate)} - ${formatDate(endDate)}`;
}

// Generate roster summary
function generateRosterSummary(rosters) {
    const summary = {
        totalShifts: rosters.length,
        staffCount: new Set(rosters.map(r => r.userId)).size,
        datesCovered: new Set(rosters.map(r => r.date)).size
    };
    
    const container = document.getElementById('rosterSummary');
    if (container) {
        container.innerHTML = `
            <div class="row text-center">
                <div class="col-md-4">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <h1 class="display-4">${summary.totalShifts}</h1>
                            <p class="card-text">Total Shifts</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <h1 class="display-4">${summary.staffCount}</h1>
                            <p class="card-text">Staff Members</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <h1 class="display-4">${summary.datesCovered}</h1>
                            <p class="card-text">Days Covered</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
}

// Print all roster
function printAllRoster() {
    window.print();
}

// Load pending requests for admin
function loadPendingRequests() {
    const db = firebase.firestore();
    const container = document.getElementById('pendingRequestsContainer');
    if (!container) return;
    
    db.collection('requests')
        .where('status', '==', 'pending')
        .orderBy('createdAt', 'desc')
        .get()
        .then(snapshot => {
            container.innerHTML = '';
            
            if (snapshot.empty) {
                container.innerHTML = '<p class="text-muted">No pending requests.</p>';
                return;
            }
            
            snapshot.forEach(doc => {
                const request = doc.data();
                const card = document.createElement('div');
                card.className = 'card mb-3';
                card.innerHTML = `
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">${request.type === 'duty_change' ? 'Duty Change' : 'Leave'} Request</h5>
                        <span class="badge bg-warning">Pending</span>
                    </div>
                    <div class="card-body">
                        <p><strong>Staff:</strong> ${request.userName}</p>
                        <p><strong>Date:</strong> ${formatDate(request.startDate || request.newDate)}</p>
                        ${request.type === 'leave' ? 
                            `<p><strong>Duration:</strong> ${request.days} day(s)</p>
                             <p><strong>Half Day:</strong> ${request.halfDay === 'yes' ? 'Yes' : 'No'}</p>` :
                            `<p><strong>New Time:</strong> ${request.newStartTime} - ${request.newEndTime}</p>`
                        }
                        <p><strong>Reason:</strong> ${request.reason}</p>
                        ${request.contact ? `<p><strong>Emergency Contact:</strong> ${request.contact}</p>` : ''}
                        <div class="btn-group">
                            <button class="btn btn-success" onclick="respondToRequest('${doc.id}', 'approved')">Approve</button>
                            <button class="btn btn-danger" onclick="respondToRequest('${doc.id}', 'rejected')">Reject</button>
                            <button class="btn btn-secondary" onclick="showRequestDetails('${doc.id}')">Details</button>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        })
        .catch(handleFirebaseError);
}

// Cancel a request
function cancelRequest(requestId) {
    if (!confirm('Are you sure you want to cancel this request?')) return;
    
    const db = firebase.firestore();
    db.collection('requests').doc(requestId).update({
        status: 'cancelled',
        cancelledAt: firebase.firestore.FieldValue.serverTimestamp()
    })
    .then(() => {
        alert('Request cancelled successfully.');
        loadMyRequests();
    })
    .catch(handleFirebaseError);
}

// Respond to a request (admin)
function respondToRequest(requestId, action) {
    const db = firebase.firestore();
    const requestRef = db.collection('requests').doc(requestId);
    
    requestRef.get()
        .then(doc => {
            if (!doc.exists) return;
            
            const request = doc.data();
            const updates = {
                status: action,
                respondedAt: firebase.firestore.FieldValue.serverTimestamp(),
                respondedBy: currentUser.email
            };
            
            return requestRef.update(updates);
        })
        .then(() => {
            alert(`Request ${action} successfully.`);
            loadPendingRequests();
            updateRequestCounts();
        })
        .catch(handleFirebaseError);
}

// Show user notification
function showUserNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 5000);
}

// Load duty roster for admin management
function loadDutyRosterAdmin() {
    const db = firebase.firestore();
    const today = new Date().toISOString().split('T')[0];
    
    db.collection('duty_times')
        .where('date', '>=', today)
        .orderBy('date')
        .limit(100)
        .get()
        .then(snapshot => {
            const container = document.getElementById('adminRosterContainer');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (snapshot.empty) {
                container.innerHTML = '<p class="text-muted">No roster entries found.</p>';
                return;
            }
            
            // Group by date
            const byDate = {};
            snapshot.forEach(doc => {
                const duty = { id: doc.id, ...doc.data() };
                if (!byDate[duty.date]) {
                    byDate[duty.date] = [];
                }
                byDate[duty.date].push(duty);
            });
            
            Object.keys(byDate).sort().forEach(date => {
                const dateSection = document.createElement('div');
                dateSection.className = 'card mb-4';
                dateSection.innerHTML = `
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">${formatDate(date)}</h5>
                        <button class="btn btn-sm btn-primary" onclick="addRosterEntry('${date}')">
                            <i class="fas fa-plus"></i> Add Entry
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Staff</th>
                                        <th>Time</th>
                                        <th>Location</th>
                                        <th>Shift Type</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="roster-${date}"></tbody>
                            </table>
                        </div>
                    </div>
                `;
                container.appendChild(dateSection);
                
                const tbody = document.getElementById(`roster-${date}`);
                byDate[date].forEach(duty => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${duty.staffName}</td>
                        <td>${duty.startTime} - ${duty.endTime}</td>
                        <td>${duty.location || 'Main Office'}</td>
                        <td>${duty.shiftType || 'Regular'}</td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="editRosterEntry('${duty.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteRosterEntry('${duty.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            });
        })
        .catch(handleFirebaseError);
}

// Show roster tab
function showRosterTab() {
    loadDutyRosterAdmin();
}

// Process Excel paste
function processExcelPaste(text) {
    const rows = text.split('\n').filter(row => row.trim());
    const data = [];
    
    rows.forEach((row, index) => {
        const cells = row.split('\t').map(cell => cell.trim());
        if (cells.length >= 5) {
            data.push({
                date: cells[0],
                staffName: cells[1],
                startTime: cells[2],
                endTime: cells[3],
                location: cells[4],
                shiftType: cells[5] || 'Regular'
            });
        }
    });
    
    displayExcelPreview(data);
    return data;
}

// Save Excel data
function saveExcelData(data) {
    const db = firebase.firestore();
    const batch = db.batch();
    
    data.forEach(item => {
        if (!isValidDate(item.date) || !item.staffName || !item.startTime || !item.endTime) {
            console.warn('Invalid row skipped:', item);
            return;
        }
        
        const ref = db.collection('duty_times').doc();
        batch.set(ref, {
            ...item,
            userId: findUsernameFromDisplayName(item.staffName),
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
    });
    
    batch.commit()
        .then(() => {
            alert(`${data.length} roster entries saved successfully!`);
            clearExcelPaste();
            loadDutyRosterAdmin();
        })
        .catch(handleFirebaseError);
}

// Find username from display name
function findUsernameFromDisplayName(displayName) {
    // This would typically query your user database
    // For now, return a placeholder or implement your user mapping logic
    return displayName.toLowerCase().replace(/\s+/g, '.');
}

// Validate date
function isValidDate(dateString) {
    const regex = /^\d{4}-\d{2}-\d{2}$/;
    if (!regex.test(dateString)) return false;
    
    const date = new Date(dateString);
    return date instanceof Date && !isNaN(date);
}

// Load sample data
function loadSampleData() {
    const sampleData = `2024-01-15\tJohn Doe\t09:00\t17:00\tMain Office\tDay Shift
2024-01-15\tJane Smith\t13:00\t21:00\tBranch Office\tEvening Shift
2024-01-16\tJohn Doe\t17:00\t01:00\tMain Office\tNight Shift`;
    
    document.getElementById('excelPaste').value = sampleData;
    document.getElementById('processExcelBtn').click();
}

// Clear Excel paste
function clearExcelPaste() {
    document.getElementById('excelPaste').value = '';
    document.getElementById('excelPreview').innerHTML = '';
}

// Load today's roster
function loadTodayRoster() {
    const today = new Date().toISOString().split('T')[0];
    const db = firebase.firestore();
    
    db.collection('duty_times')
        .where('date', '==', today)
        .orderBy('startTime')
        .get()
        .then(snapshot => {
            const container = document.getElementById('todayRoster');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (snapshot.empty) {
                container.innerHTML = '<p class="text-muted">No duties scheduled for today.</p>';
                return;
            }
            
            snapshot.forEach(doc => {
                const duty = doc.data();
                const item = document.createElement('div');
                item.className = 'list-group-item';
                item.innerHTML = `
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">${duty.staffName}</h6>
                        <small class="text-muted">${duty.startTime} - ${duty.endTime}</small>
                    </div>
                    <p class="mb-1">${duty.location || 'Main Office'}</p>
                    <small class="text-muted">${duty.shiftType || 'Regular Shift'}</small>
                `;
                container.appendChild(item);
            });
        })
        .catch(handleFirebaseError);
}

// Add roster entry
function addRosterEntry(date = null) {
    const modal = new bootstrap.Modal(document.getElementById('rosterModal'));
    const form = document.getElementById('rosterForm');
    form.reset();
    
    if (date) {
        document.getElementById('rosterDate').value = date;
    } else {
        document.getElementById('rosterDate').value = new Date().toISOString().split('T')[0];
    }
    
    document.getElementById('rosterModalTitle').textContent = 'Add Roster Entry';
    document.getElementById('saveRosterBtn').textContent = 'Save Entry';
    document.getElementById('saveRosterBtn').onclick = () => saveRosterEntry();
    
    modal.show();
}

// Clear roster form
function clearRosterForm() {
    document.getElementById('rosterForm').reset();
}

// Edit roster entry
function editRosterEntry(entryId) {
    const db = firebase.firestore();
    db.collection('duty_times').doc(entryId).get()
        .then(doc => {
            if (!doc.exists) return;
            
            const duty = doc.data();
            const form = document.getElementById('rosterForm');
            
            document.getElementById('rosterDate').value = duty.date;
            document.getElementById('rosterStaff').value = duty.staffName;
            document.getElementById('rosterStartTime').value = duty.startTime;
            document.getElementById('rosterEndTime').value = duty.endTime;
            document.getElementById('rosterLocation').value = duty.location || '';
            document.getElementById('rosterShiftType').value = duty.shiftType || 'Regular';
            
            const modal = new bootstrap.Modal(document.getElementById('rosterModal'));
            document.getElementById('rosterModalTitle').textContent = 'Edit Roster Entry';
            document.getElementById('saveRosterBtn').textContent = 'Update Entry';
            document.getElementById('saveRosterBtn').onclick = () => saveRosterEntry(entryId);
            
            modal.show();
        })
        .catch(handleFirebaseError);
}

// Delete roster entry
function deleteRosterEntry(entryId) {
    if (!confirm('Are you sure you want to delete this roster entry?')) return;
    
    const db = firebase.firestore();
    db.collection('duty_times').doc(entryId).delete()
        .then(() => {
            alert('Roster entry deleted successfully.');
            loadDutyRosterAdmin();
        })
        .catch(handleFirebaseError);
}

// Load roster view
function loadRosterView() {
    loadTodayRoster();
    loadMyRoster();
}

// Load leave balance admin
function loadLeaveBalanceAdmin() {
    const db = firebase.firestore();
    
    db.collection('users').where('role', '!=', 'admin').get()
        .then(snapshot => {
            const container = document.getElementById('leaveBalanceContainer');
            if (!container) return;
            
            container.innerHTML = '';
            
            const users = [];
            snapshot.forEach(doc => {
                users.push({ id: doc.id, ...doc.data() });
            });
            
            // Load balances for each user
            Promise.all(users.map(user => 
                db.collection('leave_balances').doc(user.id).get()
                    .then(balanceDoc => ({
                        ...user,
                        balance: balanceDoc.exists ? balanceDoc.data() : { annual: 0, taken: 0, remaining: 0 }
                    }))
            ))
            .then(userBalances => {
                displayBulkBalanceTable(userBalances);
            });
        })
        .catch(handleFirebaseError);
}

// Show balance tab
function showBalanceTab() {
    loadLeaveBalanceAdmin();
}

// Load bulk balance table
function loadBulkBalanceTable() {
    // This is called from loadLeaveBalanceAdmin
}

// Update temporary balance
function updateTempBalance(userId, field, value) {
    const input = document.querySelector(`[data-user="${userId}"][data-field="${field}"]`);
    if (input) {
        input.value = value;
        input.classList.add('table-warning');
    }
}

// Save all balances
function saveAllBalances() {
    const rows = document.querySelectorAll('#balanceTable tbody tr');
    const updates = [];
    
    rows.forEach(row => {
        const userId = row.dataset.userId;
        const annual = parseFloat(row.querySelector('.annual-balance').value) || 0;
        const taken = parseFloat(row.querySelector('.taken-balance').value) || 0;
        
        updates.push({
            userId,
            balance: {
                annual,
                taken,
                remaining: annual - taken,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedBy: currentUser.email
            }
        });
    });
    
    const db = firebase.firestore();
    const batch = db.batch();
    
    updates.forEach(update => {
        const ref = db.collection('leave_balances').doc(update.userId);
        batch.set(ref, update.balance, { merge: true });
    });
    
    batch.commit()
        .then(() => {
            alert('All balances saved successfully!');
            loadLeaveBalanceAdmin();
        })
        .catch(handleFirebaseError);
}

// Reset all balances
function resetAllBalances() {
    if (!confirm('Reset all balances to default values?')) return;
    
    const rows = document.querySelectorAll('#balanceTable tbody tr');
    rows.forEach(row => {
        row.querySelector('.annual-balance').value = 18;
        row.querySelector('.taken-balance').value = 0;
    });
}

// Reset user balance
function resetUserBalance(userId) {
    const row = document.querySelector(`tr[data-user-id="${userId}"]`);
    if (row) {
        row.querySelector('.annual-balance').value = 18;
        row.querySelector('.taken-balance').value = 0;
    }
}

// Save individual balance
function saveIndividualBalance(userId) {
    const row = document.querySelector(`tr[data-user-id="${userId}"]`);
    if (!row) return;
    
    const annual = parseFloat(row.querySelector('.annual-balance').value) || 0;
    const taken = parseFloat(row.querySelector('.taken-balance').value) || 0;
    
    const db = firebase.firestore();
    db.collection('leave_balances').doc(userId).set({
        annual,
        taken,
        remaining: annual - taken,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedBy: currentUser.email
    }, { merge: true })
    .then(() => {
        alert('Balance updated successfully!');
        row.querySelectorAll('input').forEach(input => {
            input.classList.remove('table-warning');
        });
    })
    .catch(handleFirebaseError);
}

// Reset individual balance
function resetIndividualBalance(userId) {
    if (!confirm('Reset this user\'s balance to default?')) return;
    
    const db = firebase.firestore();
    db.collection('leave_balances').doc(userId).set({
        annual: 18,
        taken: 0,
        remaining: 18,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedBy: currentUser.email
    }, { merge: true })
    .then(() => {
        alert('Balance reset successfully!');
        loadLeaveBalanceAdmin();
    })
    .catch(handleFirebaseError);
}

// Load admin approvals
function loadAdminApprovals() {
    loadPendingApprovals();
    loadApprovedRequests();
    loadRejectedRequests();
}

// Show approvals tab
function showApprovalsTab() {
    loadAdminApprovals();
}

// Load pending approvals
function loadPendingApprovals() {
    // Similar to loadPendingRequests but with different display
    loadPendingRequests();
}

// Load approved requests
function loadApprovedRequests() {
    const db = firebase.firestore();
    const container = document.getElementById('approvedRequestsContainer');
    if (!container) return;
    
    db.collection('requests')
        .where('status', '==', 'approved')
        .orderBy('respondedAt', 'desc')
        .limit(50)
        .get()
        .then(snapshot => {
            container.innerHTML = '';
            
            if (snapshot.empty) {
                container.innerHTML = '<p class="text-muted">No approved requests found.</p>';
                return;
            }
            
            snapshot.forEach(doc => {
                const request = doc.data();
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${request.userName}</td>
                    <td>${request.type === 'leave' ? 'Leave' : 'Duty Change'}</td>
                    <td>${formatDate(request.startDate || request.newDate)}</td>
                    <td>${request.type === 'leave' ? `${request.days} day(s)` : `${request.newStartTime} - ${request.newEndTime}`}</td>
                    <td>${formatDateTime(request.respondedAt)}</td>
                    <td>${request.respondedBy}</td>
                `;
                container.appendChild(row);
            });
        })
        .catch(handleFirebaseError);
}

// Load rejected requests
function loadRejectedRequests() {
    const db = firebase.firestore();
    const container = document.getElementById('rejectedRequestsContainer');
    if (!container) return;
    
    db.collection('requests')
        .where('status', '==', 'rejected')
        .orderBy('respondedAt', 'desc')
        .limit(50)
        .get()
        .then(snapshot => {
            container.innerHTML = '';
            
            if (snapshot.empty) {
                container.innerHTML = '<p class="text-muted">No rejected requests found.</p>';
                return;
            }
            
            snapshot.forEach(doc => {
                const request = doc.data();
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${request.userName}</td>
                    <td>${request.type === 'leave' ? 'Leave' : 'Duty Change'}</td>
                    <td>${formatDate(request.startDate || request.newDate)}</td>
                    <td>${request.type === 'leave' ? `${request.days} day(s)` : `${request.newStartTime} - ${request.newEndTime}`}</td>
                    <td>${formatDateTime(request.respondedAt)}</td>
                    <td>${request.reason || 'No reason provided'}</td>
                `;
                container.appendChild(row);
            });
        })
        .catch(handleFirebaseError);
}

// Admin approve request
function adminApprove(requestId) {
    respondToRequest(requestId, 'approved');
}

// Admin apply duty change
function adminApplyDutyChange(requestId) {
    const db = firebase.firestore();
    
    db.collection('requests').doc(requestId).get()
        .then(doc => {
            if (!doc.exists) return;
            
            const request = doc.data();
            
            // Find and update the original duty
            const [date, oldStart, oldEnd] = request.currentDuty.split('|');
            
            return db.collection('duty_times')
                .where('userId', '==', request.userId)
                .where('date', '==', date)
                .where('startTime', '==', oldStart)
                .where('endTime', '==', oldEnd)
                .get();
        })
        .then(snapshot => {
            if (snapshot.empty) {
                throw new Error('Original duty not found');
            }
            
            const batch = firebase.firestore().batch();
            snapshot.forEach(doc => {
                batch.update(doc.ref, {
                    startTime: request.newStartTime,
                    endTime: request.newEndTime,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            });
            
            return batch.commit();
        })
        .then(() => {
            return respondToRequest(requestId, 'approved');
        })
        .catch(handleFirebaseError);
}

// Admin reject request
function adminReject(requestId) {
    const reason = prompt('Please provide a reason for rejection:');
    if (!reason) return;
    
    const db = firebase.firestore();
    db.collection('requests').doc(requestId).update({
        status: 'rejected',
        rejectionReason: reason,
        respondedAt: firebase.firestore.FieldValue.serverTimestamp(),
        respondedBy: currentUser.email
    })
    .then(() => {
        alert('Request rejected.');
        loadPendingRequests();
        updateRequestCounts();
    })
    .catch(handleFirebaseError);
}

// Load admin request history
function loadAdminRequestHistory() {
    const db = firebase.firestore();
    const container = document.getElementById('requestHistoryContainer');
    if (!container) return;
    
    let query = db.collection('requests').orderBy('createdAt', 'desc').limit(100);
    
    const typeFilter = document.getElementById('historyTypeFilter').value;
    const statusFilter = document.getElementById('historyStatusFilter').value;
    const dateFilter = document.getElementById('historyDateFilter').value;
    
    if (typeFilter) {
        query = query.where('type', '==', typeFilter);
    }
    
    if (statusFilter) {
        query = query.where('status', '==', statusFilter);
    }
    
    if (dateFilter) {
        const startDate = new Date(dateFilter);
        startDate.setHours(0, 0, 0, 0);
        const endDate = new Date(dateFilter);
        endDate.setHours(23, 59, 59, 999);
        
        query = query.where('createdAt', '>=', startDate)
                     .where('createdAt', '<=', endDate);
    }
    
    query.get()
        .then(snapshot => {
            container.innerHTML = '';
            
            if (snapshot.empty) {
                container.innerHTML = '<p class="text-muted">No requests found.</p>';
                return;
            }
            
            snapshot.forEach(doc => {
                const request = doc.data();
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDateTime(request.createdAt)}</td>
                    <td>${request.userName}</td>
                    <td>${request.type === 'leave' ? 'Leave' : 'Duty Change'}</td>
                    <td>${formatDate(request.startDate || request.newDate)}</td>
                    <td><span class="badge bg-${getStatusColor(request.status)}">${request.status}</span></td>
                    <td>${request.respondedBy || '-'}</td>
                    <td>${formatDateTime(request.respondedAt) || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="viewRequestDetails('${doc.id}')">
                            Details
                        </button>
                    </td>
                `;
                container.appendChild(row);
            });
        })
        .catch(handleFirebaseError);
}

// Load request history
function loadRequestHistory() {
    loadAdminRequestHistory();
}

// Clear history filters
function clearHistoryFilters() {
    document.getElementById('historyTypeFilter').value = '';
    document.getElementById('historyStatusFilter').value = '';
    document.getElementById('historyDateFilter').value = '';
    loadAdminRequestHistory();
}

// Update dashboard
function updateDashboard() {
    if (!currentUser) return;
    
    const db = firebase.firestore();
    const today = new Date().toISOString().split('T')[0];
    
    // Load today's duty
    db.collection('duty_times')
        .where('userId', '==', currentUser.uid)
        .where('date', '==', today)
        .get()
        .then(snapshot => {
            const container = document.getElementById('todayDuty');
            if (container) {
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-muted">No duty scheduled for today.</p>';
                } else {
                    const duty = snapshot.docs[0].data();
                    container.innerHTML = `
                        <div class="card bg-primary text-white">
                            <div class="card-body">
                                <h5 class="card-title">Today's Duty</h5>
                                <p class="card-text">
                                    <i class="fas fa-clock"></i> ${duty.startTime} - ${duty.endTime}<br>
                                    <i class="fas fa-map-marker-alt"></i> ${duty.location || 'Main Office'}
                                </p>
                            </div>
                        </div>
                    `;
                }
            }
        });
    
    // Load leave balance
    db.collection('leave_balances').doc(currentUser.uid).get()
        .then(doc => {
            if (doc.exists) {
                const balance = doc.data();
                const container = document.getElementById('leaveBalanceDisplay');
                if (container) {
                    container.innerHTML = `
                        <div class="card bg-success text-white">
                            <div class="card-body">
                                <h5 class="card-title">Leave Balance</h5>
                                <p class="card-text display-6">${balance.remaining || 0} days</p>
                                <small>Annual: ${balance.annual || 0} | Taken: ${balance.taken || 0}</small>
                            </div>
                        </div>
                    `;
                }
            }
        });
    
    // Load recent announcements
    db.collection('announcements')
        .where('expires', '>=', today)
        .where('status', '==', 'active')
        .orderBy('createdAt', 'desc')
        .limit(3)
        .get()
        .then(snapshot => {
            const container = document.getElementById('recentAnnouncements');
            if (container) {
                container.innerHTML = '';
                
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-muted">No recent announcements.</p>';
                    return;
                }
                
                snapshot.forEach(doc => {
                    const announcement = doc.data();
                    const item = document.createElement('div');
                    item.className = 'list-group-item';
                    item.innerHTML = `
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${announcement.title}</h6>
                            <small class="text-muted">${formatTimeAgo(announcement.createdAt)}</small>
                        </div>
                        <p class="mb-1">${announcement.content.substring(0, 100)}...</p>
                        <small class="text-muted">Priority: <span class="badge bg-${announcement.priority}">${announcement.priority}</span></small>
                    `;
                    container.appendChild(item);
                });
            }
        });
}

// Check for user updates
function checkForUserUpdates() {
    if (!currentUser) return;
    
    const db = firebase.firestore();
    const lastChecked = localStorage.getItem('lastUpdateCheck') || 0;
    
    db.collection('user_updates')
        .where('userId', '==', currentUser.uid)
        .where('timestamp', '>', new Date(parseInt(lastChecked)))
        .orderBy('timestamp', 'desc')
        .limit(5)
        .get()
        .then(snapshot => {
            if (!snapshot.empty) {
                showUserUpdates(snapshot);
                localStorage.setItem('lastUpdateCheck', Date.now().toString());
            }
        })
        .catch(handleFirebaseError);
}

// Show user updates
function showUserUpdates(snapshot) {
    const updates = [];
    snapshot.forEach(doc => {
        updates.push(doc.data());
    });
    
    if (updates.length > 0) {
        const notification = document.createElement('div');
        notification.className = 'toast-container position-fixed top-0 end-0 p-3';
        notification.style.zIndex = '9999';
        
        updates.forEach(update => {
            const toast = document.createElement('div');
            toast.className = 'toast show';
            toast.innerHTML = `
                <div class="toast-header bg-${update.type || 'info'} text-white">
                    <strong class="me-auto">${update.title || 'Update'}</strong>
                    <small>${formatTimeAgo(update.timestamp)}</small>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
                </div>
                <div class="toast-body">
                    ${update.message}
                </div>
            `;
            notification.appendChild(toast);
            
            // Auto-remove after 10 seconds
            setTimeout(() => {
                toast.remove();
            }, 10000);
        });
        
        document.body.appendChild(notification);
    }
}

// Format time ago
function formatTimeAgo(timestamp) {
    if (!timestamp) return 'Just now';
    
    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
    const now = new Date();
    const seconds = Math.floor((now - date) / 1000);
    
    if (seconds < 60) return 'Just now';
    
    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return `${minutes}m ago`;
    
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return `${hours}h ago`;
    
    const days = Math.floor(hours / 24);
    if (days < 7) return `${days}d ago`;
    
    return formatDate(date);
}

// Format date time
function formatDateTime(timestamp) {
    if (!timestamp) return 'N/A';
    
    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
    return date.toLocaleString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// Format date
function formatDate(dateString) {
    if (!dateString) return 'N/A';
    
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
    });
}

// Handle Firebase errors
function handleFirebaseError(error) {
    console.error('Firebase error:', error);
    
    let message = 'An error occurred. Please try again.';
    
    switch(error.code) {
        case 'permission-denied':
            message = 'You do not have permission to perform this action.';
            break;
        case 'unauthenticated':
            message = 'Please sign in to continue.';
            break;
        case 'network-request-failed':
            message = 'Network error. Please check your connection.';
            break;
    }
    
    showUserNotification(message, 'danger');
}

// Setup realtime listeners
function setupRealtimeListeners() {
    if (!currentUser) return;
    
    const db = firebase.firestore();
    
    // Real-time announcements
    db.collection('announcements')
        .where('status', '==', 'active')
        .where('expires', '>=', new Date().toISOString().split('T')[0])
        .orderBy('createdAt', 'desc')
        .limit(10)
        .onSnapshot(snapshot => {
            if (isAdmin) {
                loadAnnouncementsAdmin();
            } else {
                loadActiveAnnouncements();
            }
        });
    
    // Real-time requests for admin
    if (isAdmin) {
        db.collection('requests')
            .where('status', '==', 'pending')
            .onSnapshot(() => {
                updateRequestCounts();
                loadPendingRequests();
            });
    }
    
    // Real-time user requests
    db.collection('requests')
        .where('userId', '==', currentUser.uid)
        .onSnapshot(() => {
            loadMyRequests();
        });
    
    // Real-time roster updates
    db.collection('duty_times')
        .where('userId', '==', currentUser.uid)
        .where('date', '>=', new Date().toISOString().split('T')[0])
        .onSnapshot(() => {
            loadMyRoster();
            loadTodayRoster();
        });
}

// Utility functions
function formatTimeAgo(timestamp) {
    const now = new Date();
    const past = new Date(timestamp);
    const diffMs = now - past;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMins / 60);
    const diffDays = Math.floor(diffHours / 24);
    
    if (diffMins < 1) return 'just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    if (diffDays < 7) return `${diffDays}d ago`;
    
    return past.toLocaleDateString();
}

function formatDateTime(timestamp) {
    const date = new Date(timestamp);
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString();
}

// Handle window resize for responsive behavior
window.addEventListener('resize', function() {
    if (window.innerWidth > 767) {
        closeMobileMenu();
    }
});

// Setup real-time listeners
function setupRealtimeListeners() {
    try {
        db.collection('announcements').doc('all')
            .onSnapshot((doc) => {
                if (doc.exists) {
                    announcements = doc.data().announcements || [];
                    if (document.getElementById('homeSection').classList.contains('active')) {
                        loadHomeAnnouncements();
                    }
                }
            }, handleFirebaseError);

        db.collection('requests').doc('all')
            .onSnapshot((doc) => {
                if (doc.exists && doc.data().requests) {
                    allRequests = doc.data().requests;
                    updateRequestCounts();
                }
            }, handleFirebaseError);
            
        console.log('Real-time listeners established');
    } catch (error) {
        console.error('Error setting up real-time listeners:', error);
    }
}

function handleFirebaseError(error) {
    console.error('Firebase error:', error);
    
    if (error.code === 'failed-precondition' || error.message.includes('QUIC')) {
        console.log('Retrying Firebase operation...');
        setTimeout(() => {
            initializeData();
        }, 2000);
    } else {
        alert('A Firebase error occurred. Please check your connection and try again.');
    }
}

// Call this after login
setTimeout(setupRealtimeListeners, 2000);

    </script>
</body>
</html>
