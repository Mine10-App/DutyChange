<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Duty Management</title>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <!-- SHA-256 Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js"></script>
    
    <!-- External Firebase and User files -->
    <script src="dcfire.js" defer></script>
    <script src="user.js" defer></script>
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* MOBILE FIRST CSS - Optimized for mobile screens */
        :root {
            --primary-color: #3498db;
            --primary-dark: #2980b9;
            --secondary-color: #2c3e50;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --gray-color: #7f8c8d;
            --border-color: #e0e6ed;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            --radius: 12px;
            --radius-sm: 8px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        html {
            height: 100%;
            font-size: 16px;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.5;
            height: 100%;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Login Container - Mobile Optimized */
        .login-container {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 400px;
            padding: 30px 25px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            margin: 0;
        }
        
        .logo {
            text-align: center;
            margin-bottom: 25px;
        }
        
        .logo h1 {
            color: var(--secondary-color);
            font-size: 24px;
            margin-bottom: 5px;
            font-weight: 700;
        }
        
        .logo p {
            color: var(--gray-color);
            font-size: 14px;
        }
        
        .form-group {
            margin-bottom: 18px;
        }
        
        .form-group label {
            display: block;
            color: var(--secondary-color);
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .form-control {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 16px;
            transition: all 0.3s;
            background: white;
            -webkit-appearance: none;
            appearance: none;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        /* Buttons - Mobile Friendly */
        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            height: 50px;
            touch-action: manipulation;
        }
        
        .btn:active {
            transform: translateY(2px);
        }
        
        .btn-primary {
            background: var(--primary-color);
            color: white;
        }
        
        .btn-primary:active {
            background: var(--primary-dark);
        }
        
        .btn-success {
            background: var(--success-color);
            color: white;
        }
        
        .btn-danger {
            background: var(--danger-color);
            color: white;
        }
        
        .btn-warning {
            background: var(--warning-color);
            color: white;
        }
        
        .btn-secondary {
            background: var(--gray-color);
            color: white;
        }
        
        .btn-icon {
            width: 44px;
            height: 44px;
            padding: 0;
            border-radius: 50%;
            justify-content: center;
        }
        
        .btn-block {
            width: 100%;
        }
        
        /* Dashboard Container */
        .dashboard-container {
            display: none;
            width: 100%;
            min-height: 100vh;
            background: white;
            flex-direction: column;
        }
        
        /* Mobile Header */
        .dashboard-header {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            color: white;
            padding: 16px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .user-info h2 {
            font-size: 18px;
            margin-bottom: 4px;
            font-weight: 600;
        }
        
        .user-details {
            font-size: 12px;
            opacity: 0.9;
            display: flex;
            gap: 12px;
        }
        
        .menu-toggle {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            padding: 8px;
            cursor: pointer;
        }
        
        /* Mobile Navigation Drawer */
        .mobile-nav {
            position: fixed;
            top: 0;
            left: -280px;
            width: 280px;
            height: 100vh;
            background: white;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            transition: left 0.3s ease;
            overflow-y: auto;
            padding-top: 60px;
        }
        
        .mobile-nav.active {
            left: 0;
        }
        
        .nav-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }
        
        .nav-overlay.active {
            display: block;
        }
        
        .mobile-nav-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 10px;
        }
        
        .mobile-nav-header h3 {
            color: var(--secondary-color);
            font-size: 18px;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            text-decoration: none;
            color: var(--dark-color);
            transition: background 0.3s;
        }
        
        .nav-item:active {
            background: var(--light-color);
        }
        
        .nav-item i {
            width: 24px;
            margin-right: 12px;
            font-size: 18px;
            color: var(--primary-color);
        }
        
        .nav-item span {
            flex: 1;
            font-size: 16px;
        }
        
        .notification-badge {
            background: var(--danger-color);
            color: white;
            border-radius: 10px;
            padding: 2px 8px;
            font-size: 12px;
            min-width: 20px;
            text-align: center;
        }
        
        /* Bottom Navigation for Mobile */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }
        
        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px;
            text-decoration: none;
            color: var(--gray-color);
            flex: 1;
        }
        
        .bottom-nav-item.active {
            color: var(--primary-color);
        }
        
        .bottom-nav-item i {
            font-size: 20px;
            margin-bottom: 4px;
        }
        
        .bottom-nav-item span {
            font-size: 11px;
            text-align: center;
        }
        
        /* Content Area */
        .dashboard-content {
            flex: 1;
            padding: 20px 16px;
            padding-bottom: 70px; /* Space for bottom nav */
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .section {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .section.active {
            display: block;
        }
        
        /* Cards */
        .card {
            background: white;
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }
        
        .card h3 {
            color: var(--secondary-color);
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .card h3 i {
            font-size: 20px;
        }
        
        /* Quick Actions Grid */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 15px;
        }
        
        .action-card {
            background: white;
            border-radius: var(--radius-sm);
            padding: 16px;
            text-align: center;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            text-decoration: none;
            color: var(--dark-color);
            transition: transform 0.2s;
        }
        
        .action-card:active {
            transform: translateY(2px);
        }
        
        .action-card i {
            font-size: 24px;
            margin-bottom: 8px;
            color: var(--primary-color);
        }
        
        .action-card h4 {
            font-size: 14px;
            margin-bottom: 4px;
        }
        
        .action-card p {
            font-size: 12px;
            color: var(--gray-color);
        }
        
        /* Balance Display - Mobile */
        .balance-display {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin: 15px 0;
        }
        
        .balance-box {
            background: var(--light-color);
            padding: 16px;
            border-radius: var(--radius-sm);
            text-align: center;
            border: 2px solid var(--border-color);
        }
        
        .balance-value {
            font-size: 28px;
            font-weight: bold;
            color: var(--secondary-color);
            margin: 5px 0;
        }
        
        .balance-label {
            font-size: 12px;
            color: var(--gray-color);
            text-transform: uppercase;
        }
        
        /* Mobile Forms */
        .form-row {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-group-inline {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        select.form-control {
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 40px;
        }
        
        /* Mobile Tables */
        .table-container {
            overflow-x: auto;
            margin-top: 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            -webkit-overflow-scrolling: touch;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            min-width: 600px;
        }
        
        th, td {
            padding: 12px 10px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            font-size: 14px;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: var(--secondary-color);
            font-size: 13px;
            position: sticky;
            left: 0;
        }
        
        /* Mobile List Views */
        .list-view {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .list-item {
            background: white;
            border-radius: var(--radius-sm);
            padding: 16px;
            border: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .list-item-content {
            flex: 1;
        }
        
        .list-item-title {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .list-item-subtitle {
            font-size: 13px;
            color: var(--gray-color);
        }
        
        .list-item-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        /* Alerts */
        .alert {
            padding: 14px;
            border-radius: var(--radius-sm);
            margin-bottom: 15px;
            border-left: 4px solid;
            font-size: 14px;
        }
        
        .alert-info {
            background: #e8f4fc;
            border-color: var(--primary-color);
            color: var(--secondary-color);
        }
        
        .alert-success {
            background: #d4edda;
            border-color: var(--success-color);
            color: #155724;
        }
        
        .alert-warning {
            background: #fff3cd;
            border-color: var(--warning-color);
            color: #856404;
        }
        
        .alert-danger {
            background: #f8d7da;
            border-color: var(--danger-color);
            color: #721c24;
        }
        
        /* Mobile Tabs */
        .tab-controls {
            display: flex;
            overflow-x: auto;
            margin-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
            -webkit-overflow-scrolling: touch;
            gap: 5px;
        }
        
        .tab-btn {
            padding: 10px 16px;
            border: none;
            background: #f0f0f0;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .tab-btn.active {
            background: var(--primary-color);
            color: white;
        }
        
        /* Mobile Roster View */
        .roster-day {
            background: white;
            border-radius: var(--radius-sm);
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid var(--border-color);
        }
        
        .roster-day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .roster-date {
            font-weight: 600;
            color: var(--secondary-color);
        }
        
        .roster-duty {
            font-size: 14px;
            padding: 4px 10px;
            border-radius: 20px;
            background: var(--light-color);
        }
        
        /* Swipeable Content */
        .swipe-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scroll-snap-type: x mandatory;
        }
        
        .swipe-item {
            scroll-snap-align: start;
            min-width: 100%;
        }
        
        /* Loading States */
        .loading {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray-color);
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Pull to Refresh */
        .pull-to-refresh {
            position: absolute;
            top: -60px;
            left: 0;
            right: 0;
            text-align: center;
            padding: 20px;
            color: var(--gray-color);
        }
        
        /* Mobile Date Pickers */
        input[type="date"],
        input[type="month"] {
            min-height: 50px;
        }
        
        /* Announcements */
        .announcement-card {
            background: white;
            border-radius: var(--radius);
            padding: 18px;
            margin-bottom: 16px;
            border-left: 4px solid;
            box-shadow: var(--shadow);
        }
        
        .announcement-card.high {
            border-left-color: var(--danger-color);
            background: linear-gradient(135deg, #fff5f5, white);
        }
        
        .announcement-card.medium {
            border-left-color: var(--warning-color);
            background: linear-gradient(135deg, #fff9e6, white);
        }
        
        .announcement-card.low {
            border-left-color: var(--success-color);
            background: linear-gradient(135deg, #f0fff4, white);
        }
        
        .announcement-title {
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .announcement-content {
            font-size: 14px;
            margin-bottom: 12px;
            line-height: 1.5;
        }
        
        .announcement-meta {
            font-size: 12px;
            color: var(--gray-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* Status Badges */
        .status-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-approved {
            background: #d4edda;
            color: #155724;
        }
        
        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 8px 12px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .action-btn:active {
            transform: translateY(2px);
        }
        
        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray-color);
        }
        
        .empty-state i {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        /* Switches and Toggles */
        .switch {
            position: relative;
            display: inline-block;
            width: 52px;
            height: 26px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: var(--primary-color);
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        /* Search Bar */
        .search-bar {
            position: relative;
            margin-bottom: 16px;
        }
        
        .search-bar input {
            width: 100%;
            padding: 14px 16px 14px 44px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 16px;
        }
        
        .search-bar i {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-color);
        }
        
        /* Modal Overlay */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        
        .modal.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: white;
            border-radius: var(--radius);
            padding: 24px;
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            transform: translateY(20px);
            transition: transform 0.3s;
        }
        
        .modal.active .modal-content {
            transform: translateY(0);
        }
        
        /* Responsive Adjustments */
        @media (min-width: 768px) {
            .login-container {
                padding: 40px;
            }
            
            .quick-actions {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .form-row {
                flex-direction: row;
                flex-wrap: wrap;
            }
            
            .form-row .form-group {
                flex: 1;
                min-width: 200px;
            }
            
            .mobile-nav {
                display: none;
            }
            
            .bottom-nav {
                display: none;
            }
            
            .dashboard-content {
                padding-bottom: 20px;
            }
        }
        
        /* Print Styles */
        @media print {
            .bottom-nav,
            .dashboard-header,
            .btn {
                display: none !important;
            }
            
            .dashboard-content {
                padding: 0;
            }
            
            .card {
                box-shadow: none;
                border: 1px solid #000;
            }
        }
        
        /* High Contrast Mode */
        @media (prefers-contrast: high) {
            .btn {
                border: 2px solid currentColor;
            }
            
            .card {
                border: 2px solid currentColor;
            }
        }
        
        /* Reduced Motion */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <!-- Login Container -->
    <div class="login-container" id="loginContainer">
        <div class="logo">
            <h1>Duty Management</h1>
            <p>Secure Login System</p>
        </div>
        
        <form id="loginForm">
            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" class="form-control" placeholder="Enter username" required autofocus>
            </div>
            
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" class="form-control" placeholder="Enter password" required>
            </div>
            
            <button type="submit" class="btn btn-primary" id="loginBtn">
                <i class="fas fa-sign-in-alt"></i> Login
            </button>
            
            <div class="error-message" id="errorMessage">
                Invalid username or password
            </div>
        </form>
    </div>
    
    <!-- Dashboard Container -->
    <div class="dashboard-container" id="dashboardContainer">
        <!-- Mobile Header -->
        <div class="dashboard-header">
            <div class="header-top">
                <div class="user-info">
                    <h2 id="userName">User Name</h2>
                    <div class="user-details">
                        <span>RC: <span id="userRC">000</span></span>
                        <span>Level: <span id="userLevel">User</span></span>
                    </div>
                </div>
                <button class="menu-toggle" id="menuToggle">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </div>
        
        <!-- Mobile Navigation Drawer -->
        <div class="mobile-nav" id="mobileNav">
            <div class="mobile-nav-header">
                <h3>Navigation Menu</h3>
            </div>
            <a href="#" class="nav-item" data-section="home" onclick="showSection('home')">
                <i class="fas fa-home"></i>
                <span>Dashboard</span>
            </a>
            <a href="#" class="nav-item" data-section="dutyChange" onclick="showSection('dutyChange')">
                <i class="fas fa-exchange-alt"></i>
                <span>Duty Change</span>
            </a>
            <a href="#" class="nav-item" data-section="leaveApplication" onclick="showSection('leaveApplication')">
                <i class="fas fa-calendar-minus"></i>
                <span>Apply Leave</span>
            </a>
            <a href="#" class="nav-item" data-section="myRequests" onclick="showSection('myRequests')">
                <i class="fas fa-list"></i>
                <span>My Requests</span>
                <span class="notification-badge" id="mobileRequestCount">0</span>
            </a>
            <a href="#" class="nav-item" data-section="viewMyRoster" onclick="showSection('viewMyRoster')">
                <i class="fas fa-calendar-alt"></i>
                <span>My Roster</span>
            </a>
            <a href="#" class="nav-item" data-section="viewAllRoster" onclick="showSection('viewAllRoster')">
                <i class="fas fa-calendar-week"></i>
                <span>All Roster</span>
            </a>
            
            <!-- Admin Sections -->
            <div class="mobile-nav-header" id="adminNavHeader" style="display: none;">
                <h3>Admin</h3>
            </div>
            <a href="#" class="nav-item" data-section="pendingRequests" id="mobilePendingRequests" onclick="showSection('pendingRequests')" style="display: none;">
                <i class="fas fa-clock"></i>
                <span>Pending Requests</span>
                <span class="notification-badge" id="mobilePendingCount">0</span>
            </a>
            <a href="#" class="nav-item" data-section="adminAnnouncements" id="mobileAnnouncements" onclick="showSection('adminAnnouncements')" style="display: none;">
                <i class="fas fa-bullhorn"></i>
                <span>Announcements</span>
            </a>
            <a href="#" class="nav-item" data-section="adminDutyRoster" id="mobileDutyRoster" onclick="showSection('adminDutyRoster')" style="display: none;">
                <i class="fas fa-edit"></i>
                <span>Duty Roster</span>
            </a>
            <a href="#" class="nav-item" data-section="adminLeaveBalance" id="mobileLeaveBalance" onclick="showSection('adminLeaveBalance')" style="display: none;">
                <i class="fas fa-balance-scale"></i>
                <span>Leave Balance</span>
            </a>
            <a href="#" class="nav-item" data-section="adminApprovals" id="mobileApprovals" onclick="showSection('adminApprovals')" style="display: none;">
                <i class="fas fa-check-circle"></i>
                <span>Approvals</span>
            </a>
            
            <!-- Logout Button -->
            <div style="padding: 20px; border-top: 1px solid var(--border-color); margin-top: 20px;">
                <button class="btn btn-danger btn-block" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>
        
        <!-- Navigation Overlay -->
        <div class="nav-overlay" id="navOverlay"></div>
        
        <!-- Content Area -->
        <div class="dashboard-content">
            <!-- Dashboard -->
            <div class="section active" id="homeSection">
                <div id="homeAnnouncements">
                    <!-- Announcements will be loaded here -->
                </div>
                
                <div class="card">
                    <h3><i class="fas fa-tachometer-alt"></i> Dashboard</h3>
                    
                    <div class="balance-display">
                        <div class="balance-box">
                            <div class="balance-label">Sick Leave</div>
                            <div class="balance-value" id="slBalance">0</div>
                            <div class="balance-label">Days</div>
                        </div>
                        <div class="balance-box">
                            <div class="balance-label">FRL Balance</div>
                            <div class="balance-value" id="frlBalance">0</div>
                            <div class="balance-label">Days</div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <p><strong>Today's Duty:</strong> <span id="todayDutyTime">Not Scheduled</span></p>
                        <p><strong>Next Duty:</strong> <span id="nextDutyTime">No upcoming duty</span></p>
                        <div id="homeNotifications" style="margin-top: 10px; display: none;">
                            <!-- Notifications will appear here -->
                        </div>
                    </div>
                    
                    <h4 style="margin: 20px 0 10px 0;">Quick Actions</h4>
                    <div class="quick-actions">
                        <a href="#" class="action-card" onclick="showSection('dutyChange')">
                            <i class="fas fa-exchange-alt"></i>
                            <h4>Duty Change</h4>
                            <p>Request swap</p>
                        </a>
                        <a href="#" class="action-card" onclick="showSection('leaveApplication')">
                            <i class="fas fa-calendar-minus"></i>
                            <h4>Apply Leave</h4>
                            <p>Sick/FRL</p>
                        </a>
                        <a href="#" class="action-card" onclick="showSection('myRequests')">
                            <i class="fas fa-list"></i>
                            <h4>My Requests</h4>
                            <p>View status</p>
                        </a>
                        <a href="#" class="action-card" onclick="showSection('viewMyRoster')">
                            <i class="fas fa-calendar-alt"></i>
                            <h4>My Roster</h4>
                            <p>View schedule</p>
                        </a>
                        <a href="#" class="action-card" onclick="showSection('viewAllRoster')">
                            <i class="fas fa-calendar-week"></i>
                            <h4>All Roster</h4>
                            <p>Team schedule</p>
                        </a>
                        <a href="#" class="action-card" onclick="updateDashboard()">
                            <i class="fas fa-sync-alt"></i>
                            <h4>Refresh</h4>
                            <p>Update data</p>
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Duty Change Request -->
            <div class="section" id="dutyChangeSection">
                <div class="card">
                    <h3><i class="fas fa-exchange-alt"></i> Duty Change Request</h3>
                    
                    <div class="alert alert-warning">
                        <strong>Note:</strong> Requests must be made at least 24 hours in advance.
                    </div>
                    
                    <form id="dutyChangeForm">
                        <div class="form-group">
                            <label for="changeDate">Change Date *</label>
                            <input type="date" id="changeDate" class="form-control" required min="">
                        </div>
                        
                        <div class="form-group">
                            <label for="changeDutyTime">Your Duty Time *</label>
                            <select id="changeDutyTime" class="form-control" required>
                                <option value="">Select duty time</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="requestToStaff">Request To Staff *</label>
                            <select id="requestToStaff" class="form-control" required>
                                <option value="">Select staff member</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="requestToDutyTime">Staff's Duty Time *</label>
                            <select id="requestToDutyTime" class="form-control" required>
                                <option value="">Select duty time</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="changeReason">Reason (Optional)</label>
                            <textarea id="changeReason" class="form-control" rows="2" placeholder="Brief reason for duty change"></textarea>
                        </div>
                        
                        <div class="form-row" style="flex-direction: row; gap: 10px; margin-top: 20px;">
                            <button type="submit" class="btn btn-success" style="flex: 1;">
                                <i class="fas fa-paper-plane"></i> Submit
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="showSection('home')" style="flex: 1;">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Leave Application -->
            <div class="section" id="leaveApplicationSection">
                <div class="card">
                    <h3><i class="fas fa-calendar-minus"></i> Apply Leave</h3>
                    
                    <div class="alert alert-info">
                        <p><strong>Application Rules:</strong></p>
                        <p>• Sick Leave: 2+ hours before duty</p>
                        <p>• FRL: 1+ hour before duty</p>
                        <p>• No backdated applications</p>
                    </div>
                    
                    <form id="leaveApplicationForm">
                        <div class="form-group">
                            <label for="leaveType">Leave Type *</label>
                            <select id="leaveType" class="form-control" required>
                                <option value="">Select leave type</option>
                                <option value="Sick Leave">Sick Leave</option>
                                <option value="FRL">FRL</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="leaveDate">Leave Date *</label>
                            <input type="date" id="leaveDate" class="form-control" required min="">
                        </div>
                        
                        <div class="form-group">
                            <label for="leaveDutyTime">Duty Time *</label>
                            <select id="leaveDutyTime" class="form-control" required>
                                <option value="">Select duty time</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="leaveDuration">Duration *</label>
                            <select id="leaveDuration" class="form-control" required>
                                <option value="1">1 Day</option>
                                <option value="0.5">Half Day</option>
                                <option value="2">2 Days</option>
                                <option value="3">3 Days</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="leaveReason">Reason *</label>
                            <textarea id="leaveReason" class="form-control" rows="3" placeholder="Please provide reason for leave" required></textarea>
                        </div>
                        
                        <div class="alert" id="leaveRulesAlert">
                            Select leave type, date and duty time to see rules
                        </div>
                        
                        <div class="form-row" style="flex-direction: row; gap: 10px; margin-top: 20px;">
                            <button type="submit" class="btn btn-success" id="submitLeaveBtn" style="flex: 1;">
                                <i class="fas fa-paper-plane"></i> Submit
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="showSection('home')" style="flex: 1;">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- My Requests - Mobile Optimized -->
            <div class="section" id="myRequestsSection">
                <div class="card">
                    <h3><i class="fas fa-list"></i> My Requests</h3>
                    
                    <div class="search-bar">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchRequests" placeholder="Search requests...">
                    </div>
                    
                    <div class="list-view" id="myRequestsList">
                        <!-- Requests will be loaded here -->
                    </div>
                </div>
            </div>
            
            <!-- My Roster - Mobile View -->
            <div class="section" id="viewMyRosterSection">
                <div class="card">
                    <h3><i class="fas fa-calendar-alt"></i> My Roster</h3>
                    
                    <div class="form-row" style="flex-direction: row;">
                        <div class="form-group" style="flex: 2;">
                            <label for="myRosterMonth">Month</label>
                            <input type="month" id="myRosterMonth" class="form-control" value="">
                        </div>
                        <div class="form-group" style="flex: 1; margin-top: 25px;">
                            <button class="btn btn-primary" onclick="loadMyRoster()">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        Shows your scheduled duties. Changes via Duty Change.
                    </div>
                    
                    <div id="myRosterContainer" style="margin-top: 20px;">
                        <!-- Roster will be displayed here -->
                    </div>
                </div>
            </div>
            
            <!-- View All Roster - Mobile Optimized -->
            <div class="section" id="viewAllRosterSection">
                <div class="card">
                    <h3><i class="fas fa-calendar-week"></i> All Roster</h3>
                    
                    <div class="form-group">
                        <label for="allRosterStartDate">From Date</label>
                        <input type="date" id="allRosterStartDate" class="form-control" value="">
                    </div>
                    
                    <div class="form-group">
                        <label for="allRosterEndDate">To Date</label>
                        <input type="date" id="allRosterEndDate" class="form-control" value="">
                    </div>
                    
                    <div class="form-row" style="flex-direction: row; gap: 10px; margin-top: 10px;">
                        <button class="btn btn-primary" onclick="loadAllRoster()" style="flex: 1;">
                            <i class="fas fa-eye"></i> View
                        </button>
                        <button class="btn btn-secondary" onclick="printAllRoster()" style="flex: 1;">
                            <i class="fas fa-print"></i> Print
                        </button>
                    </div>
                    
                    <div class="alert alert-info">
                        Complete duty roster for all staff members.
                    </div>
                    
                    <div id="allRosterContainer" style="margin-top: 20px;">
                        <!-- Roster will be displayed here -->
                    </div>
                </div>
            </div>
            
            <!-- Pending Requests (Admin/User) -->
            <div class="section" id="pendingRequestsSection">
                <div class="card">
                    <h3><i class="fas fa-clock"></i> Pending Requests</h3>
                    
                    <div class="list-view" id="pendingRequestsList">
                        <!-- Pending requests will be loaded here -->
                    </div>
                </div>
            </div>
            
            <!-- Admin: Announcement Management -->
            <div class="section" id="adminAnnouncementsSection">
                <div class="card">
                    <h3><i class="fas fa-bullhorn"></i> Create Announcement</h3>
                    
                    <form id="announcementForm">
                        <div class="form-group">
                            <label for="announcementTitle">Title *</label>
                            <input type="text" id="announcementTitle" class="form-control" placeholder="Enter title" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="announcementContent">Content *</label>
                            <textarea id="announcementContent" class="form-control" rows="4" placeholder="Enter announcement details..." required></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>Priority *</label>
                            <div class="form-row" style="flex-direction: row;">
                                <button type="button" class="btn btn-danger" onclick="selectPriority('high')" style="flex: 1; margin: 2px;">High</button>
                                <button type="button" class="btn btn-warning" onclick="selectPriority('medium')" style="flex: 1; margin: 2px;">Medium</button>
                                <button type="button" class="btn btn-success" onclick="selectPriority('low')" style="flex: 1; margin: 2px;">Low</button>
                            </div>
                            <input type="hidden" id="announcementPriority" value="medium">
                        </div>
                        
                        <div class="form-group">
                            <label>Target Audience *</label>
                            <select id="announcementTarget" class="form-control" onchange="toggleStaffSelection()">
                                <option value="all">All Staff</option>
                                <option value="specific">Specific Staff</option>
                            </select>
                        </div>
                        
                        <div class="form-group" id="specificStaffGroup" style="display: none;">
                            <label for="announcementStaff">Select Staff</label>
                            <select id="announcementStaff" class="form-control" multiple style="height: 120px;">
                                <!-- Staff options will be loaded -->
                            </select>
                        </div>
                        
                        <div class="form-row" style="flex-direction: row; gap: 10px; margin-top: 20px;">
                            <button type="submit" class="btn btn-success" style="flex: 1;">
                                <i class="fas fa-plus"></i> Create
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="clearAnnouncementForm()" style="flex: 1;">
                                <i class="fas fa-times"></i> Clear
                            </button>
                        </div>
                    </form>
                </div>
                
                <div class="card">
                    <h3><i class="fas fa-bullhorn"></i> Active Announcements</h3>
                    <div id="activeAnnouncementsList">
                        <!-- Active announcements will be loaded here -->
                    </div>
                </div>
            </div>
            
            <!-- Other Admin Sections would follow similar mobile-optimized patterns -->
        </div>
        
        <!-- Bottom Navigation -->
        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <a href="#" class="bottom-nav-item active" data-section="home" onclick="showSection('home')">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </a>
            <a href="#" class="bottom-nav-item" data-section="dutyChange" onclick="showSection('dutyChange')">
                <i class="fas fa-exchange-alt"></i>
                <span>Change</span>
            </a>
            <a href="#" class="bottom-nav-item" data-section="leaveApplication" onclick="showSection('leaveApplication')">
                <i class="fas fa-calendar-minus"></i>
                <span>Leave</span>
            </a>
            <a href="#" class="bottom-nav-item" data-section="myRequests" onclick="showSection('myRequests')">
                <i class="fas fa-list"></i>
                <span>Requests</span>
                <span class="notification-badge" id="bottomRequestCount" style="position: absolute; top: 4px; right: 20px; font-size: 10px; padding: 1px 4px;">0</span>
            </a>
            <a href="#" class="bottom-nav-item" data-section="viewMyRoster" onclick="showSection('viewMyRoster')">
                <i class="fas fa-calendar-alt"></i>
                <span>Roster</span>
            </a>
        </div>
    </div>

    <!-- Modal for details -->
    <div class="modal" id="detailsModal">
        <div class="modal-content">
            <h3 id="modalTitle"></h3>
            <div id="modalContent"></div>
            <button class="btn btn-secondary btn-block" onclick="closeModal()" style="margin-top: 20px;">
                <i class="fas fa-times"></i> Close
            </button>
        </div>
    </div>

    <script>
// Mobile-First Responsive Duty Management System
// Global variables

// Add this at the beginning of your script
function checkFirebaseConnection() {
    console.log('Checking Firebase connection...');
    console.log('Firebase app name:', firebase.app().name);
    console.log('Firebase project ID:', firebase.app().options.projectId);
    
    // Test Firebase connection
    db.collection('test').doc('test').get()
        .then(() => console.log('Firebase connection successful'))
        .catch(error => console.error('Firebase connection failed:', error));
}

// Call this after Firebase is ready
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, checking Firebase...');
    
    // Check if Firebase and db are available
    if (typeof firebase === 'undefined') {
        console.error('Firebase SDK not loaded');
        return;
    }
    
    if (typeof db === 'undefined') {
        console.error('Firestore db not defined. Check dcfire.js');
        return;
    }
    
    // Test Firebase connection
    checkFirebaseConnection();
    
    // Rest of your initialization...
});


let currentUser = null;
let allUsers = [];
let dutyRoster = {};
let leaveBalances = {};
let allRequests = [];
let announcements = [];
let userDisplayNameMap = {};
let firebaseReady = false;

// Mobile menu toggle

function toggleMobileMenu() {
    const menuToggle = document.getElementById('menuToggle');
    const nav = document.getElementById('mobileNav');
    const overlay = document.getElementById('navOverlay');
    
    menuToggle.classList.toggle('active');
    nav.classList.toggle('active');
    overlay.classList.toggle('active');
}

// Close mobile menu when clicking outside
function closeMobileMenu() {
    const menuToggle = document.getElementById('menuToggle');
    const nav = document.getElementById('mobileNav');
    const overlay = document.getElementById('navOverlay');
    
    menuToggle.classList.remove('active');
    nav.classList.remove('active');
    overlay.classList.remove('active');
}

// Wait for Firebase and user data to load
document.addEventListener('DOMContentLoaded', function() {
    // Check if Firebase is available
    if (typeof db === 'undefined') {
        console.error('Firebase is not initialized. Make sure dcfire.js is loaded.');
        showError('Firebase initialization failed. Please check your configuration.');
        return;
    }
    
    // Wait for user data to load
    setTimeout(() => {
        if (typeof users === 'undefined') {
            console.error('User data not loaded. Make sure user.js is loaded.');
            showError('User data not loaded. Please check user.js file.');
            return;
        }
        
        firebaseReady = true;
        console.log('Firebase and user data loaded successfully');
        initApp();
    }, 1000);
});

// Color mapping for duty times
const dutyTimeColorMap = {
    '0730-1530': 'duty-0730-1530',
    '0830-1630': 'duty-0830-1630',
    '1030-1830': 'duty-1030-1830',
    '1530-2330': 'duty-1530-2330',
    '1630-0030': 'duty-1630-0030',
    '1730-0130': 'duty-1730-0130',
    '0030-0830': 'duty-0030-0830',
    '0000-0800': 'duty-0000-0800',
    '0100-0900': 'duty-0100-0900',
    '0200-1000': 'duty-0200-1000',
    '0300-1100': 'duty-0300-1100',
    '0400-1200': 'duty-0400-1200',
    '0500-1300': 'duty-0500-1300',
    '0600-1400': 'duty-0600-1400',
    '0630-1430': 'duty-0630-1430',
    '0700-1500': 'duty-0700-1500',
    '0800-1600': 'duty-0800-1600',
    '1000-1800': 'duty-1000-1800',
    '1100-1900': 'duty-1100-1900',
    '1130-1930': 'duty-1130-1930',
    '1200-2000': 'duty-1200-2000',
    '1230-2030': 'duty-1230-2030',
    '1300-2100': 'duty-1300-2100',
    '1330-2130': 'duty-1330-2130',
    '1400-2200': 'duty-1400-2200',
    '1430-2230': 'duty-1430-2230',
    '1500-2300': 'duty-1500-2300',
    '1600-0000': 'duty-1600-0000',
    '1800-0200': 'duty-1800-0200',
    '1830-0230': 'duty-1830-0230',
    '1900-0300': 'duty-1900-0300',
    '1930-0330': 'duty-1930-0330',
    '2000-0400': 'duty-2000-0400',
    '2030-0430': 'duty-2030-0430',
    '2100-0500': 'duty-2100-0500',
    '2130-0530': 'duty-2130-0530',
    '2200-0600': 'duty-2200-0600',
    '2230-0630': 'duty-2230-0630',
    '2300-0700': 'duty-2300-0700',
    '2330-0730': 'duty-2330-0730',
    'mixed': 'duty-mixed',
    'special': 'duty-special',
    'leave': 'duty-leave'
};

function initApp() {
    if (!firebaseReady) {
        console.log('Waiting for Firebase to be ready...');
        setTimeout(initApp, 500);
        return;
    }
    
    console.log('Initializing application...');
    
    // Setup mobile menu toggle - FIXED ID
    document.getElementById('menuToggle').addEventListener('click', toggleMobileMenu);
    
    // Close menu when clicking on overlay
    document.getElementById('navOverlay').addEventListener('click', closeMobileMenu);
    
    // Setup login form
    document.getElementById('loginForm').addEventListener('submit', function(e) {
        e.preventDefault();
        handleLogin();
    });
    
    // Set minimum dates
    const today = new Date().toISOString().split('T')[0];
    setMinimumDates(today);
    
    // Check session
    checkSession();

     // Close menu when clicking outside on mobile
    document.addEventListener('click', function(event) {
        const menuToggle = document.getElementById('menuToggle');
        const nav = document.getElementById('mobileNav');
        const isClickInside = nav.contains(event.target) || menuToggle.contains(event.target);
        
        if (window.innerWidth <= 768 && !isClickInside && nav.classList.contains('active')) {
            closeMobileMenu();
        }
    });
    
    // Setup navigation items
    document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const section = this.getAttribute('data-section');
            if (section) {
                showSection(section);
                closeMobileMenu();
            }
        });
    });
    
    // Setup bottom navigation
    document.querySelectorAll('.bottom-nav-item').forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const section = this.getAttribute('data-section');
            if (section) {
                showSection(section);
            }
            
            // Update active state
            document.querySelectorAll('.bottom-nav-item').forEach(i => i.classList.remove('active'));
            this.classList.add('active');
        });
    });
    
    // Setup logout button
    document.getElementById('logoutBtn').addEventListener('click', function() {
        if (confirm('Are you sure you want to logout?')) {
            localStorage.removeItem('dutySystemSession');
            location.reload();
        }
    });
}


function setMinimumDates(today) {
    const dateInputs = [
        'changeDate', 'leaveDate', 'rosterDate', 'viewRosterDate',
        'allRosterStartDate', 'allRosterEndDate'
    ];
    
    dateInputs.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            if (id === 'allRosterStartDate') {
                element.value = today;
            } else if (id === 'allRosterEndDate') {
                element.value = getDateAfterDays(today, 7);
            } else if (id === 'changeDate' || id === 'leaveDate') {
                element.min = today;
                element.value = getDateAfterDays(today, 1);
            } else {
                element.value = today;
            }
        }
    });
    
    document.getElementById('myRosterMonth').value = today.substring(0, 7);
}

function getDateAfterDays(startDate, days) {
    const date = new Date(startDate);
    date.setDate(date.getDate() + days);
    return date.toISOString().split('T')[0];
}

function checkSession() {
    const session = localStorage.getItem('dutySystemSession');
    if (session) {
        try {
            const user = JSON.parse(session);
            if (user.expiry > Date.now()) {
                loginUser(user);
            } else {
                localStorage.removeItem('dutySystemSession');
            }
        } catch (e) {
            localStorage.removeItem('dutySystemSession');
        }
    }
}

function handleLogin() {
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value.trim();
    
    if (!username || !password) {
        showError('Please enter both username and password');
        return;
    }
    
    if (!users || !Array.isArray(users)) {
        showError('User database not loaded');
        return;
    }
    
    const user = users.find(u => u.username === username);
    
    if (!user) {
        showError('Invalid username or password');
        return;
    }
    
    // Hash and check password
    const hashedPassword = sha256(password);
    
    if (hashedPassword === user.passwordHash) {
        const sessionData = {
            username: user.username,
            name: user.name,
            rcNo: user.RCNo,
            level: user.Level,
            expiry: Date.now() + (8 * 60 * 60 * 1000)
        };
        
        localStorage.setItem('dutySystemSession', JSON.stringify(sessionData));
        loginUser(sessionData);
    } else {
        showError('Invalid username or password');
    }
}

function showError(message) {
    const errorMsg = document.getElementById('errorMessage');
    errorMsg.textContent = message;
    errorMsg.style.display = 'block';
    
    // Auto hide error after 5 seconds
    setTimeout(() => {
        errorMsg.style.display = 'none';
    }, 5000);
}

function loginUser(userData) {
    currentUser = userData;
    allUsers = users || [];
    
    console.log('User logged in:', currentUser);
    
    // Initialize user display name map
    initializeUserDisplayMap();
    
    // Update UI
    document.getElementById('loginContainer').style.display = 'none';
    document.getElementById('dashboardContainer').style.display = 'block';
    
    // Update user info
    updateUserInfo(userData);
    
    // Show/hide admin sections
    setupAdminSections();
    
    // Initialize data and UI
    initializeData();
    setupNavigation();
    setupEventListeners();
    updateDashboard();
}

function updateUserInfo(userData) {
    document.getElementById('userName').textContent = userData.name;
    document.getElementById('userRC').textContent = userData.rcNo;
    document.getElementById('userLevel').textContent = userData.level;
    document.getElementById('welcomeName').textContent = userData.name;
}

function setupAdminSections() {
    const adminButtons = [
        'adminDutyRosterBtn',
        'adminLeaveBalanceBtn',
        'adminApprovalsBtn',
        'adminRequestHistoryBtn',
        'adminAnnouncementsBtn'
    ];
    
    adminButtons.forEach(btnId => {
        const btn = document.getElementById(btnId);
        if (btn) {
            btn.style.display = currentUser.level === 'Supervisor' ? 'inline-block' : 'none';
        }
    });
    
    // Always show "View All Roster" button to all users
    document.getElementById('viewAllRosterBtn').style.display = 'inline-block';
}

function initializeUserDisplayMap() {
    userDisplayNameMap = {};
    allUsers.forEach(user => {
        userDisplayNameMap[user.name] = user.username;
        userDisplayNameMap[user.RCNo] = user.username;
        userDisplayNameMap[user.username] = user.username;
        
        // For names like "Irufan1", "Irufan2"
        if (user.name.includes('Irufan')) {
            const match = user.name.match(/Irufan\s*(\d*)/i);
            if (match && match[1]) {
                userDisplayNameMap[`Irufan${match[1]}`] = user.username;
            }
        }
        
        const nameLower = user.name.toLowerCase();
        const usernameLower = user.username.toLowerCase();
        userDisplayNameMap[nameLower] = user.username;
        userDisplayNameMap[usernameLower] = user.username;
    });
}

// FIREBASE FUNCTIONS
async function loadDutyRoster() {
    console.log('Attempting to load duty roster...');
    try {
        const doc = await db.collection('dutyRoster').doc('current').get();
        console.log('Duty roster document:', doc);
        
        if (doc.exists) {
            dutyRoster = doc.data() || {};
            console.log('Duty roster data loaded:', dutyRoster);
        } else {
            console.log('Duty roster document does not exist, creating default...');
            dutyRoster = {};
            await saveDutyRoster();
        }
    } catch (error) {
        console.error('Error loading duty roster:', error);
        console.error('Error details:', error.message, error.code);
        dutyRoster = {};
    }
}

async function loadLeaveBalances() {
    console.log('Attempting to load leave balances...');
    try {
        const doc = await db.collection('leaveBalances').doc('current').get();
        console.log('Leave balances document:', doc);
        
        if (doc.exists) {
            leaveBalances = doc.data() || {};
            console.log('Leave balances data loaded:', leaveBalances);
        } else {
            console.log('Leave balances document does not exist, creating default...');
            leaveBalances = {};
            allUsers.forEach(user => {
                leaveBalances[user.username] = {
                    SL: 12,
                    FRL: 6
                };
            });
            await saveLeaveBalances();
        }
    } catch (error) {
        console.error('Error loading leave balances:', error);
        console.error('Error details:', error.message, error.code);
        leaveBalances = {};
    }
}

async function loadAllRequests() {
    console.log('Attempting to load all requests...');
    try {
        const doc = await db.collection('requests').doc('all').get();
        console.log('Requests document:', doc);
        
        if (doc.exists && doc.data().requests) {
            allRequests = doc.data().requests;
            console.log('Requests data loaded, count:', allRequests.length);
        } else {
            console.log('Requests document does not exist or empty, creating default...');
            allRequests = [];
            await saveAllRequests();
        }
        updateRequestCounts();
    } catch (error) {
        console.error('Error loading requests:', error);
        console.error('Error details:', error.message, error.code);
        allRequests = [];
    }
}

async function loadAnnouncements() {
    console.log('Attempting to load announcements...');
    try {
        const doc = await db.collection('announcements').doc('all').get();
        console.log('Announcements document:', doc);
        
        if (doc.exists && doc.data().announcements) {
            announcements = doc.data().announcements;
            console.log('Announcements data loaded, count:', announcements.length);
        } else {
            console.log('Announcements document does not exist, creating default...');
            announcements = [];
            await saveAnnouncements();
        }
    } catch (error) {
        console.error('Error loading announcements:', error);
        console.error('Error details:', error.message, error.code);
        announcements = [];
    }
}

async function saveAnnouncements() {
    try {
        await db.collection('announcements').doc('all').set({ announcements: announcements });
    } catch (error) {
        console.error('Error saving announcements:', error);
        alert('Failed to save announcements. Please try again.');
    }
}

async function initializeData() {
    console.log('Starting data initialization...');
    
    try {
        console.log('Loading duty roster...');
        await loadDutyRoster();
        console.log('Duty roster loaded:', dutyRoster);
        
        console.log('Loading leave balances...');
        await loadLeaveBalances();
        console.log('Leave balances loaded:', leaveBalances);
        
        console.log('Loading all requests...');
        await loadAllRequests();
        console.log('All requests loaded:', allRequests);
        
        console.log('Loading announcements...');
        await loadAnnouncements();
        console.log('Announcements loaded:', announcements);
        
        updateUserBalance();
        console.log('Data initialization complete');
        
    } catch (error) {
        console.error('Error initializing data:', error);
        alert('Failed to load data from Firebase. Please refresh the page.');
    }
}

function updateUserBalance() {
    if (!currentUser) return;
    
    const balance = leaveBalances[currentUser.username] || {SL: 0, FRL: 0};
    document.getElementById('slBalance').textContent = balance.SL.toFixed(1);
    document.getElementById('frlBalance').textContent = balance.FRL.toFixed(1);
}

function setupNavigation() {
    const navBtns = document.querySelectorAll('.nav-btn');
    navBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            navBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            const sectionId = this.getAttribute('data-section');
            showSection(sectionId);
            
            // Close mobile menu after selection
            if (window.innerWidth <= 768) {
                closeMobileMenu();
            }
        });
    });
    
    // Logout button
    document.getElementById('logoutBtn').addEventListener('click', function() {
        if (confirm('Are you sure you want to logout?')) {
            localStorage.removeItem('dutySystemSession');
            location.reload();
        }
    });
}

function showSection(sectionId) {
    // Hide all sections
    document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
    });
    
    // Show selected section
    const section = document.getElementById(sectionId + 'Section');
    if (section) {
        section.classList.add('active');
        
        // Update bottom navigation active state
        document.querySelectorAll('.bottom-nav-item').forEach(item => {
            item.classList.remove('active');
            if (item.getAttribute('data-section') === sectionId) {
                item.classList.add('active');
            }
        });
        
        // Load section data
        loadSectionData(sectionId);
    }
}

function loadSectionData(sectionId) {
    switch(sectionId) {
        case 'home':
            loadHomeAnnouncements();
            break;
        case 'dutyChange':
            loadDutyChangeForm();
            break;
        case 'leaveApplication':
            loadLeaveForm();
            break;
        case 'myRequests':
            loadMyRequests();
            break;
        case 'viewMyRoster':
            loadMyRoster();
            break;
        case 'viewAllRoster':
            loadAllRoster();
            break;
        case 'pendingRequests':
            loadPendingRequests();
            break;
        case 'adminAnnouncements':
            loadAnnouncementsAdmin();
            break;
        case 'adminDutyRoster':
            loadDutyRosterAdmin();
            break;
        case 'adminLeaveBalance':
            loadLeaveBalanceAdmin();
            break;
        case 'adminApprovals':
            loadAdminApprovals();
            break;
        case 'adminRequestHistory':
            loadAdminRequestHistory();
            break;
    }
    
    // Scroll to top on mobile
    if (window.innerWidth <= 768) {
        window.scrollTo(0, 0);
    }
}

// HOME SECTION FUNCTIONS
function loadHomeAnnouncements() {
    const container = document.getElementById('homeAnnouncements');
    if (!container) return;
    
    // Clear existing content
    container.innerHTML = '';
    
    // Sort announcements by date (newest first)
    const sortedAnnouncements = announcements.sort((a, b) => 
        new Date(b.timestamp) - new Date(a.timestamp)
    );
    
    if (sortedAnnouncements.length === 0) {
        container.innerHTML = '<div class="alert alert-info">No announcements yet.</div>';
        return;
    }
    
    // Display announcements (max 5 on mobile for better performance)
    const maxDisplay = window.innerWidth <= 768 ? 5 : 10;
    const displayAnnouncements = sortedAnnouncements.slice(0, maxDisplay);
    
    displayAnnouncements.forEach(announcement => {
        const announcementDate = new Date(announcement.timestamp);
        const formattedDate = announcementDate.toLocaleDateString('en-US', {
            weekday: 'short',
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        const announcementElement = document.createElement('div');
        announcementElement.className = 'announcement-card';
        announcementElement.innerHTML = `
            <div class="announcement-header">
                <strong>${announcement.title}</strong>
                <small class="text-muted">${formattedDate}</small>
            </div>
            <div class="announcement-body">
                ${announcement.message.replace(/\n/g, '<br>')}
            </div>
            <div class="announcement-footer">
                <small>Posted by: ${announcement.postedBy}</small>
            </div>
        `;
        
        container.appendChild(announcementElement);
    });
    
    // Show "load more" on mobile if there are more announcements
    if (window.innerWidth <= 768 && sortedAnnouncements.length > maxDisplay) {
        const loadMoreBtn = document.createElement('button');
        loadMoreBtn.className = 'btn btn-secondary btn-sm mt-2';
        loadMoreBtn.textContent = 'Load More Announcements';
        loadMoreBtn.addEventListener('click', function() {
            loadAllAnnouncements(container, sortedAnnouncements);
            this.remove();
        });
        container.appendChild(loadMoreBtn);
    }
}

function loadAllAnnouncements(container, allAnnouncements) {
    container.innerHTML = '';
    
    allAnnouncements.forEach(announcement => {
        const announcementDate = new Date(announcement.timestamp);
        const formattedDate = announcementDate.toLocaleDateString('en-US', {
            weekday: 'short',
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        const announcementElement = document.createElement('div');
        announcementElement.className = 'announcement-card';
        announcementElement.innerHTML = `
            <div class="announcement-header">
                <strong>${announcement.title}</strong>
                <small class="text-muted">${formattedDate}</small>
            </div>
            <div class="announcement-body">
                ${announcement.message.replace(/\n/g, '<br>')}
            </div>
            <div class="announcement-footer">
                <small>Posted by: ${announcement.postedBy}</small>
            </div>
        `;
        
        container.appendChild(announcementElement);
    });
}

// DUTY CHANGE FUNCTIONS
function loadDutyChangeForm() {
    // Set default date to tomorrow
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    const tomorrowStr = tomorrow.toISOString().split('T')[0];
    
    const dateInput = document.getElementById('changeDate');
    if (dateInput) {
        dateInput.value = tomorrowStr;
        dateInput.min = new Date().toISOString().split('T')[0];
    }
    
    // Load user's duty times
    loadUserDutyTimes('changeDutyTime', tomorrowStr);
    
    // Clear form
    document.getElementById('swapWith').value = '';
    document.getElementById('changeReason').value = '';
}

function loadUserDutyTimes(selectId, date) {
    if (!date || !dutyRoster[date] || !currentUser) return;
    
    const userDuty = dutyRoster[date][currentUser.username];
    const select = document.getElementById(selectId);
    
    if (!select) return;
    
    select.innerHTML = '<option value="">Select Duty Time</option>';
    
    if (userDuty && userDuty !== 'Off') {
        const option = document.createElement('option');
        option.value = userDuty;
        option.textContent = userDuty;
        select.appendChild(option);
    } else {
        const option = document.createElement('option');
        option.value = 'Off';
        option.textContent = 'Off Duty';
        select.appendChild(option);
    }
    
    // Add other available duty times
    const allDutyTimes = new Set();
    Object.values(dutyRoster[date] || {}).forEach(time => {
        if (time && time !== 'Off') {
            allDutyTimes.add(time);
        }
    });
    
    allDutyTimes.forEach(time => {
        if (time !== userDuty) {
            const option = document.createElement('option');
            option.value = time;
            option.textContent = time;
            select.appendChild(option);
        }
    });
}

async function submitDutyChange() {
    if (!currentUser) {
        showError('Please login first');
        return;
    }
    
    const date = document.getElementById('changeDate').value;
    const currentDuty = document.getElementById('changeDutyTime').value;
    const swapWith = document.getElementById('swapWith').value;
    const reason = document.getElementById('changeReason').value.trim();
    
    if (!date || !currentDuty || !swapWith || !reason) {
        showError('Please fill all fields');
        return;
    }
    
    // Check if date is in the past
    const selectedDate = new Date(date);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    if (selectedDate < today) {
        showError('Cannot request duty change for past dates');
        return;
    }
    
    // Validate swap partner
    let swapUsername = '';
    
    if (userDisplayNameMap[swapWith]) {
        swapUsername = userDisplayNameMap[swapWith];
    } else {
        // Try to find by RC number or partial name
        const foundUser = allUsers.find(user => 
            user.RCNo === swapWith || 
            user.name.toLowerCase().includes(swapWith.toLowerCase())
        );
        
        if (foundUser) {
            swapUsername = foundUser.username;
        } else {
            showError('User not found. Please enter full name or RC number');
            return;
        }
    }
    
    if (swapUsername === currentUser.username) {
        showError('Cannot swap duty with yourself');
        return;
    }
    
    // Check if swap partner is scheduled for duty on that date
    if (!dutyRoster[date] || !dutyRoster[date][swapUsername] || dutyRoster[date][swapUsername] === 'Off') {
        showError('Selected staff is not scheduled for duty on this date');
        return;
    }
    
    // Check for existing pending requests for same date
    const existingRequest = allRequests.find(req => 
        req.fromUsername === currentUser.username &&
        req.date === date &&
        req.status === 'pending' &&
        req.type === 'duty_change'
    );
    
    if (existingRequest) {
        showError('You already have a pending duty change request for this date');
        return;
    }
    
    // Create request object
    const request = {
        id: Date.now().toString(),
        type: 'duty_change',
        fromUsername: currentUser.username,
        fromName: currentUser.name,
        toUsername: swapUsername,
        toName: allUsers.find(u => u.username === swapUsername)?.name || swapUsername,
        date: date,
        currentDuty: currentDuty,
        requestedDuty: dutyRoster[date][swapUsername],
        reason: reason,
        status: 'pending',
        timestamp: new Date().toISOString()
    };
    
    // Add to requests array
    allRequests.unshift(request);
    
    try {
        await saveAllRequests();
        
        // Clear form
        document.getElementById('dutyChangeForm').reset();
        
        // Show success message
        alert('Duty change request submitted successfully!');
        
        // Reload requests if on that section
        if (document.getElementById('myRequestsSection').classList.contains('active')) {
            loadMyRequests();
        }
    } catch (error) {
        console.error('Error submitting request:', error);
        showError('Failed to submit request. Please try again.');
    }
}

// LEAVE APPLICATION FUNCTIONS
function loadLeaveForm() {
    // Set default date to tomorrow
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    const tomorrowStr = tomorrow.toISOString().split('T')[0];
    
    const dateInput = document.getElementById('leaveDate');
    if (dateInput) {
        dateInput.value = tomorrowStr;
        dateInput.min = new Date().toISOString().split('T')[0];
    }
    
    // Load user's duty times
    loadUserDutyTimes('leaveDutyTime', tomorrowStr);
    
    // Clear form
    document.getElementById('leaveType').value = 'Sick Leave';
    document.getElementById('leaveReason').value = '';
    
    // Update leave rules display
    updateLeaveRules();
}

function updateLeaveRules() {
    const leaveType = document.getElementById('leaveType').value;
    const leaveDate = document.getElementById('leaveDate').value;
    const rulesContainer = document.getElementById('leaveRules');
    
    if (!rulesContainer) return;
    
    let rulesHtml = '<div class="alert alert-warning">';
    
    if (leaveType === 'Sick Leave') {
        rulesHtml += '<strong>Sick Leave Rules:</strong><br>';
        rulesHtml += '• Requires medical certificate if more than 2 days<br>';
        rulesHtml += '• Maximum 12 days per year<br>';
        rulesHtml += '• Cannot be taken on weekends unless emergency';
    } else {
        rulesHtml += '<strong>Family Responsibility Leave Rules:</strong><br>';
        rulesHtml += '• Maximum 6 days per year<br>';
        rulesHtml += '• Requires proof of family event<br>';
        rulesHtml += '• 24-hour notice required';
    }
    
    // Add date-specific rules
    if (leaveDate) {
        const date = new Date(leaveDate);
        const dayOfWeek = date.getDay();
        
        if (dayOfWeek === 0 || dayOfWeek === 6) {
            rulesHtml += '<br>• <span class="text-danger">Weekend leave requires supervisor approval</span>';
        }
    }
    
    rulesHtml += '</div>';
    rulesContainer.innerHTML = rulesHtml;
}

async function submitLeaveApplication() {
    if (!currentUser) {
        showError('Please login first');
        return;
    }
    
    const date = document.getElementById('leaveDate').value;
    const currentDuty = document.getElementById('leaveDutyTime').value;
    const leaveType = document.getElementById('leaveType').value;
    const reason = document.getElementById('leaveReason').value.trim();
    
    if (!date || !currentDuty || !reason) {
        showError('Please fill all fields');
        return;
    }
    
    // Check if date is in the past
    const selectedDate = new Date(date);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    if (selectedDate < today) {
        showError('Cannot apply for leave on past dates');
        return;
    }
    
    // Check user's leave balance
    const userBalance = leaveBalances[currentUser.username] || {SL: 0, FRL: 0};
    const leaveTypeKey = leaveType === 'Sick Leave' ? 'SL' : 'FRL';
    
    if (userBalance[leaveTypeKey] <= 0) {
        showError(`Insufficient ${leaveType} balance`);
        return;
    }
    
    // Check for existing pending leave request for same date
    const existingRequest = allRequests.find(req => 
        req.fromUsername === currentUser.username &&
        req.date === date &&
        req.status === 'pending' &&
        req.type === 'leave'
    );
    
    if (existingRequest) {
        showError('You already have a pending leave request for this date');
        return;
    }
    
    // Check if already on approved leave for this date
    const approvedLeave = allRequests.find(req => 
        req.fromUsername === currentUser.username &&
        req.date === date &&
        req.status === 'approved' &&
        req.type === 'leave'
    );
    
    if (approvedLeave) {
        showError('You already have approved leave for this date');
        return;
    }
    
    // Create request object
    const request = {
        id: Date.now().toString(),
        type: 'leave',
        fromUsername: currentUser.username,
        fromName: currentUser.name,
        date: date,
        leaveType: leaveType,
        reason: reason,
        status: 'pending',
        timestamp: new Date().toISOString()
    };
    
    // Add to requests array
    allRequests.unshift(request);
    
    try {
        await saveAllRequests();
        
        // Clear form
        document.getElementById('leaveApplicationForm').reset();
        
        // Show success message
        alert('Leave application submitted successfully!');
        
        // Reload requests if on that section
        if (document.getElementById('myRequestsSection').classList.contains('active')) {
            loadMyRequests();
        }
    } catch (error) {
        console.error('Error submitting leave application:', error);
        showError('Failed to submit leave application. Please try again.');
    }
}

// MY REQUESTS FUNCTIONS
function loadMyRequests() {
    const container = document.getElementById('myRequestsContainer');
    if (!container) return;
    
    // Filter requests for current user
    const userRequests = allRequests.filter(req => 
        req.fromUsername === currentUser.username
    ).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    
    if (userRequests.length === 0) {
        container.innerHTML = '<div class="alert alert-info">No requests found.</div>';
        return;
    }
    
    // Create table for desktop, cards for mobile
    let html = '';
    
    if (window.innerWidth > 768) {
        html = '<div class="table-responsive"><table class="table table-striped">';
        html += '<thead><tr>';
        html += '<th>Date</th>';
        html += '<th>Type</th>';
        html += '<th>Details</th>';
        html += '<th>Status</th>';
        html += '<th>Date Submitted</th>';
        html += '<th>Actions</th>';
        html += '</tr></thead><tbody>';
        
        userRequests.forEach(request => {
            html += '<tr>';
            html += `<td>${request.date}</td>`;
            html += `<td>${request.type === 'duty_change' ? 'Duty Change' : 'Leave'}</td>`;
            
            if (request.type === 'duty_change') {
                html += `<td>Swap ${request.currentDuty} with ${request.toName} (${request.requestedDuty})</td>`;
            } else {
                html += `<td>${request.leaveType}: ${request.reason.substring(0, 50)}${request.reason.length > 50 ? '...' : ''}</td>`;
            }
            
            html += `<td><span class="badge ${getStatusBadgeClass(request.status)}">${request.status}</span></td>`;
            
            const requestDate = new Date(request.timestamp);
            html += `<td>${requestDate.toLocaleDateString()} ${requestDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</td>`;
            
            html += '<td>';
            if (request.status === 'pending') {
                html += `<button class="btn btn-sm btn-danger" onclick="cancelRequest('${request.id}')">Cancel</button>`;
            } else if (request.status === 'approved' && request.type === 'duty_change') {
                html += `<button class="btn btn-sm btn-info" onclick="viewSwapDetails('${request.id}')">Details</button>`;
            }
            html += '</td>';
            
            html += '</tr>';
        });
        
        html += '</tbody></table></div>';
    } else {
        // Mobile view - cards
        html = '<div class="requests-mobile">';
        
        userRequests.forEach(request => {
            const requestDate = new Date(request.timestamp);
            const formattedDate = requestDate.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
            
            html += '<div class="request-card">';
            html += '<div class="request-header">';
            html += `<span class="request-type">${request.type === 'duty_change' ? '🔀 Duty Change' : '🏖️ Leave'}</span>`;
            html += `<span class="request-date">${formattedDate}</span>`;
            html += '</div>';
            
            html += '<div class="request-body">';
            html += `<p><strong>Date:</strong> ${request.date}</p>`;
            
            if (request.type === 'duty_change') {
                html += `<p><strong>Swap:</strong> ${request.currentDuty} ↔ ${request.toName}</p>`;
                html += `<p><strong>To:</strong> ${request.requestedDuty}</p>`;
            } else {
                html += `<p><strong>Type:</strong> ${request.leaveType}</p>`;
                html += `<p><strong>Reason:</strong> ${request.reason.substring(0, 60)}${request.reason.length > 60 ? '...' : ''}</p>`;
            }
            
            html += `<p><strong>Status:</strong> <span class="badge ${getStatusBadgeClass(request.status)}">${request.status}</span></p>`;
            html += '</div>';
            
            html += '<div class="request-actions">';
            if (request.status === 'pending') {
                html += `<button class="btn btn-sm btn-danger btn-block" onclick="cancelRequest('${request.id}')">Cancel Request</button>`;
            } else if (request.status === 'approved' && request.type === 'duty_change') {
                html += `<button class="btn btn-sm btn-info btn-block" onclick="viewSwapDetails('${request.id}')">View Details</button>`;
            }
            html += '</div>';
            
            html += '</div>';
        });
        
        html += '</div>';
    }
    
    container.innerHTML = html;
}

function getStatusBadgeClass(status) {
    switch(status) {
        case 'pending': return 'badge-warning';
        case 'approved': return 'badge-success';
        case 'rejected': return 'badge-danger';
        case 'cancelled': return 'badge-secondary';
        default: return 'badge-light';
    }
}

async function cancelRequest(requestId) {
    if (!confirm('Are you sure you want to cancel this request?')) {
        return;
    }
    
    const requestIndex = allRequests.findIndex(req => req.id === requestId);
    
    if (requestIndex === -1) {
        showError('Request not found');
        return;
    }
    
    // Only allow cancelling pending requests
    if (allRequests[requestIndex].status !== 'pending') {
        showError('Only pending requests can be cancelled');
        return;
    }
    
    // Check if request belongs to current user
    if (allRequests[requestIndex].fromUsername !== currentUser.username) {
        showError('You can only cancel your own requests');
        return;
    }
    
    // Update status
    allRequests[requestIndex].status = 'cancelled';
    allRequests[requestIndex].cancelledAt = new Date().toISOString();
    
    try {
        await saveAllRequests();
        loadMyRequests();
        showUserNotification('Request cancelled successfully');
    } catch (error) {
        console.error('Error cancelling request:', error);
        showError('Failed to cancel request');
    }
}

function viewSwapDetails(requestId) {
    const request = allRequests.find(req => req.id === requestId);
    
    if (!request) {
        showError('Request not found');
        return;
    }
    
    let details = `<strong>Duty Change Details:</strong><br><br>`;
    details += `<strong>Date:</strong> ${request.date}<br>`;
    details += `<strong>Your Original Duty:</strong> ${request.currentDuty}<br>`;
    details += `<strong>Swapping With:</strong> ${request.toName}<br>`;
    details += `<strong>You Will Work:</strong> ${request.requestedDuty}<br>`;
    details += `<strong>They Will Work:</strong> ${request.currentDuty}<br>`;
    details += `<strong>Reason:</strong> ${request.reason}<br>`;
    details += `<strong>Approved By:</strong> ${request.approvedBy || 'Supervisor'}<br>`;
    details += `<strong>Approved At:</strong> ${request.approvedAt ? new Date(request.approvedAt).toLocaleString() : 'N/A'}`;
    
    alert(details);
}

// VIEW MY ROSTER FUNCTIONS
function loadMyRoster() {
    const monthInput = document.getElementById('myRosterMonth').value;
    if (!monthInput) return;
    
    const [year, month] = monthInput.split('-').map(Number);
    const startDate = new Date(year, month - 1, 1);
    const endDate = new Date(year, month, 0); // Last day of month
    
    const container = document.getElementById('myRosterContainer');
    if (!container) return;
    
    // Create table
    let html = `<h4 class="text-center mb-3">${getMonthName(month)} ${year}</h4>`;
    
    html += '<div class="table-responsive"><table class="table table-bordered table-striped">';
    html += '<thead class="thead-dark"><tr>';
    html += '<th>Date</th>';
    html += '<th>Day</th>';
    html += '<th>Duty Time</th>';
    html += '<th>Status</th>';
    html += '</tr></thead><tbody>';
    
    const today = new Date().toISOString().split('T')[0];
    
    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
        const dateStr = d.toISOString().split('T')[0];
        const dayName = d.toLocaleDateString('en-US', { weekday: 'short' });
        const isToday = dateStr === today;
        const isPast = d < new Date(today);
        
        let dutyTime = 'Not Scheduled';
        let cellClass = '';
        let leaveIndicator = '';
        
        // Check for approved leave
        const approvedLeave = allRequests.find(req => 
            req.fromUsername === currentUser.username &&
            req.type === 'leave' &&
            req.status === 'approved' &&
            req.date === dateStr
        );
        
        if (approvedLeave) {
            dutyTime = 'Leave';
            cellClass = 'duty-leave';
            leaveIndicator = `<span class="leave-indicator">${approvedLeave.leaveType === 'Sick Leave' ? 'SL' : 'FRL'}</span>`;
        } else if (dutyRoster[dateStr] && dutyRoster[dateStr][currentUser.username]) {
            dutyTime = dutyRoster[dateStr][currentUser.username];
            cellClass = getDutyTimeClass(dutyTime);
        } else {
            cellClass = 'off-day-cell';
            dutyTime = 'Off';
        }
        
        if (isToday) {
            cellClass += ' today-cell';
        }
        
        html += `<tr ${isToday ? 'class="table-warning"' : ''}>`;
        html += `<td><strong>${dateStr}</strong>${isToday ? ' <span class="badge badge-info">Today</span>' : ''}</td>`;
        html += `<td>${dayName}</td>`;
        html += `<td class="${cellClass}">${dutyTime} ${leaveIndicator}</td>`;
        
        let statusText = '';
        if (isPast) {
            statusText = '<span class="badge badge-secondary">Completed</span>';
        } else if (isToday) {
            statusText = '<span class="badge badge-primary">Today</span>';
        } else if (approvedLeave) {
            statusText = '<span class="badge badge-success">Leave Approved</span>';
        } else if (dutyTime === 'Off') {
            statusText = '<span class="badge badge-info">Off Day</span>';
        } else {
            statusText = '<span class="badge badge-light">Scheduled</span>';
        }
        
        html += `<td>${statusText}</td>`;
        html += '</tr>';
    }
    
    html += '</tbody></table></div>';
    
    // Add duty time legend
    html += getDutyTimeLegend();
    
    container.innerHTML = html;
}

function getMonthName(month) {
    const months = [
        'January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'
    ];
    return months[month - 1];
}

// VIEW ALL ROSTER FUNCTIONS
function loadAllRoster() {
    const startDate = document.getElementById('allRosterStartDate').value;
    const endDate = document.getElementById('allRosterEndDate').value;
    
    if (!startDate || !endDate) {
        showError('Please select both start and end dates');
        return;
    }
    
    const start = new Date(startDate);
    const end = new Date(endDate);
    
    if (start > end) {
        showError('Start date must be before end date');
        return;
    }
    
    // Limit date range for mobile performance
    const maxDays = window.innerWidth <= 768 ? 14 : 31;
    const daysDiff = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
    
    if (daysDiff > maxDays) {
        if (window.innerWidth <= 768) {
            alert(`For mobile devices, maximum ${maxDays} days allowed. Showing first ${maxDays} days.`);
            end.setDate(start.getDate() + maxDays - 1);
            document.getElementById('allRosterEndDate').value = end.toISOString().split('T')[0];
        }
    }
    
    const year = start.getFullYear();
    const month = start.getMonth() + 1;
    
    const container = document.getElementById('allRosterContainer');
    container.innerHTML = displayAllRosterTable(start, end, year, month);
}

function displayAllRosterTable(startDate, endDate, year, month) {
    const today = new Date().toISOString().split('T')[0];
    let html = `<h4>${getMonthName(month)} ${year}</h4>`;
    html += `<p class="text-muted">${startDate.toISOString().split('T')[0]} to ${endDate.toISOString().split('T')[0]}</p>`;
    
    // Mobile view - simplified table
    if (window.innerWidth <= 768) {
        html += '<div class="table-container-mobile">';
        
        for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
            const dateStr = d.toISOString().split('T')[0];
            const dayName = d.toLocaleDateString('en-US', { weekday: 'short' });
            const isToday = dateStr === today;
            
            html += '<div class="roster-day-card">';
            html += `<div class="roster-day-header ${isToday ? 'today-header' : ''}">`;
            html += `<span class="roster-date">${dateStr}</span>`;
            html += `<span class="roster-day">${dayName} ${isToday ? ' (Today)' : ''}</span>`;
            html += '</div>';
            
            html += '<div class="roster-day-body">';
            
            // Show staff and duties for this day
            allUsers.forEach(user => {
                if (user.Level === 'User') {
                    let dutyTime = 'Off';
                    let cellClass = 'off-day-cell';
                    let leaveIndicator = '';
                    
                    // Check for approved leave
                    const approvedLeave = allRequests.find(req => 
                        req.fromUsername === user.username &&
                        req.type === 'leave' &&
                        req.status === 'approved' &&
                        req.date === dateStr
                    );
                    
                    if (approvedLeave) {
                        dutyTime = 'Leave';
                        cellClass = 'duty-leave';
                        leaveIndicator = `<span class="leave-indicator">${approvedLeave.leaveType === 'Sick Leave' ? 'SL' : 'FRL'}</span>`;
                    } else if (dutyRoster[dateStr] && dutyRoster[dateStr][user.username]) {
                        dutyTime = dutyRoster[dateStr][user.username];
                        cellClass = getDutyTimeClass(dutyTime);
                    }
                    
                    html += '<div class="roster-staff-row">';
                    html += `<span class="roster-staff-name">${user.name}</span>`;
                    html += `<span class="roster-duty-time ${cellClass}">${dutyTime} ${leaveIndicator}</span>`;
                    html += '</div>';
                }
            });
            
            html += '</div>';
            html += '</div>';
        }
        
        html += '</div>';
    } else {
        // Desktop view - full table
        html += '<div class="table-container"><table class="table table-bordered">';
        html += '<thead><tr><th>Date</th><th>Day</th>';
        
        // Add staff headers
        allUsers.forEach(user => {
            if (user.Level === 'User') {
                html += `<th class="staff-name">${user.name}<br><small>${user.RCNo}</small></th>`;
            }
        });
        
        html += '</tr></thead><tbody>';
        
        for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
            const dateStr = d.toISOString().split('T')[0];
            const dayName = d.toLocaleDateString('en-US', { weekday: 'short' });
            const isToday = dateStr === today;
            
            html += `<tr ${isToday ? 'class="table-warning"' : ''}>`;
            html += `<td><strong>${dateStr}</strong>${isToday ? ' <span class="badge badge-info">Today</span>' : ''}</td>`;
            html += `<td>${dayName}</td>`;
            
            // Add duty times for each staff
            allUsers.forEach(user => {
                if (user.Level === 'User') {
                    let dutyTime = 'Off';
                    let cellClass = 'off-day-cell';
                    let leaveIndicator = '';
                    
                    // Check for approved leave
                    const approvedLeave = allRequests.find(req => 
                        req.fromUsername === user.username &&
                        req.type === 'leave' &&
                        req.status === 'approved' &&
                        req.date === dateStr
                    );
                    
                    if (approvedLeave) {
                        dutyTime = 'Leave';
                        cellClass = 'duty-leave';
                        leaveIndicator = `<span class="leave-indicator">${approvedLeave.leaveType === 'Sick Leave' ? 'SL' : 'FRL'}</span>`;
                    } else if (dutyRoster[dateStr] && dutyRoster[dateStr][user.username]) {
                        dutyTime = dutyRoster[dateStr][user.username];
                        cellClass = getDutyTimeClass(dutyTime);
                    }
                    
                    if (isToday) {
                        cellClass += ' today-cell';
                    }
                    
                    html += `<td class="${cellClass}">${dutyTime} ${leaveIndicator}</td>`;
                }
            });
            
            html += '</tr>';
        }
        
        html += '</tbody></table></div>';
    }
    
    // Add duty time legend
    html += getDutyTimeLegend();
    
    return html;
}

function getDutyTimeLegend() {
    return `
        <div class="duty-legend">
            <h5>Duty Time Legend:</h5>
            <div class="legend-items">
                <span class="legend-item"><span class="color-box duty-0730-1530"></span> 0730-1530</span>
                <span class="legend-item"><span class="color-box duty-0830-1630"></span> 0830-1630</span>
                <span class="legend-item"><span class="color-box duty-1030-1830"></span> 1030-1830</span>
                <span class="legend-item"><span class="color-box duty-1530-2330"></span> 1530-2330</span>
                <span class="legend-item"><span class="color-box duty-1630-0030"></span> 1630-0030</span>
                <span class="legend-item"><span class="color-box duty-leave"></span> Leave</span>
                <span class="legend-item"><span class="color-box off-day-cell"></span> Off Day</span>
            </div>
        </div>
    `;
}

function printAllRoster() {
    const originalContent = document.getElementById('allRosterContainer').innerHTML;
    const printWindow = window.open('', '_blank');
    
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Duty Roster Report</title>
            <meta name="viewport" content="width=device-width, initial-scale=1">
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; font-size: 12px; }
                table { border-collapse: collapse; width: 100%; margin-top: 20px; font-size: 10px; }
                th, td { border: 1px solid #ddd; padding: 6px; text-align: center; }
                th { background-color: #f2f2f2; font-weight: bold; }
                .leave-indicator { background-color: #ffeaa7; padding: 1px 3px; border-radius: 2px; font-size: 8px; }
                h3 { color: #2c3e50; margin-bottom: 5px; }
                .print-header { margin-bottom: 15px; }
                .duty-0730-1530 { background-color: #a3e4d7 !important; }
                .duty-0830-1630 { background-color: #aed6f1 !important; }
                .duty-1030-1830 { background-color: #f9e79f !important; }
                .duty-1530-2330 { background-color: #d5dbdb !important; }
                .duty-1630-0030 { background-color: #f1948a !important; }
                .duty-leave { background-color: #82e0aa !important; }
                .off-day-cell { background-color: #f8f9fa !important; }
                @media print {
                    body { margin: 0; padding: 10px; }
                    table { font-size: 8px; }
                    .no-print { display: none; }
                }
            </style>
        </head>
        <body>
            <div class="print-header">
                <h3>Duty Roster Report</h3>
                <p>Generated on: ${new Date().toLocaleString()}</p>
                <p>Generated by: ${currentUser.name} (${currentUser.rcNo})</p>
            </div>
            ${originalContent}
            <div class="no-print">
                <p><em>Report generated from Duty Management System</em></p>
            </div>
        </body>
        </html>
    `);
    
    printWindow.document.close();
    
    // Wait for content to load before printing
    setTimeout(() => {
        printWindow.print();
        printWindow.close();
    }, 500);
}

// ADMIN PENDING REQUESTS
function loadPendingRequests() {
    if (currentUser.level !== 'Supervisor') {
        document.getElementById('pendingRequestsContainer').innerHTML = 
            '<div class="alert alert-danger">Access denied. Supervisor privileges required.</div>';
        return;
    }
    
    const container = document.getElementById('pendingRequestsContainer');
    if (!container) return;
    
    // Filter pending requests
    const pendingRequests = allRequests.filter(req => req.status === 'pending');
    
    if (pendingRequests.length === 0) {
        container.innerHTML = '<div class="alert alert-info">No pending requests.</div>';
        updateRequestCounts();
        return;
    }
    
    let html = '';
    
    if (window.innerWidth > 768) {
        html = '<div class="table-responsive"><table class="table table-striped">';
        html += '<thead><tr>';
        html += '<th>Date</th>';
        html += '<th>Staff</th>';
        html += '<th>Type</th>';
        html += '<th>Details</th>';
        html += '<th>Submitted</th>';
        html += '<th>Actions</th>';
        html += '</tr></thead><tbody>';
        
        pendingRequests.forEach(request => {
            html += '<tr>';
            html += `<td>${request.date}</td>`;
            html += `<td>${request.fromName} (${request.fromUsername})</td>`;
            html += `<td>${request.type === 'duty_change' ? 'Duty Change' : 'Leave'}</td>`;
            
            if (request.type === 'duty_change') {
                html += `<td>Swap ${request.currentDuty} with ${request.toName} (${request.requestedDuty})<br>`;
                html += `<small>Reason: ${request.reason}</small></td>`;
            } else {
                html += `<td>${request.leaveType}<br>`;
                html += `<small>Reason: ${request.reason}</small></td>`;
            }
            
            const requestDate = new Date(request.timestamp);
            html += `<td>${requestDate.toLocaleDateString()} ${requestDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</td>`;
            
            html += '<td>';
            html += `<button class="btn btn-sm btn-success" onclick="approveRequest('${request.id}')">Approve</button> `;
            html += `<button class="btn btn-sm btn-danger" onclick="rejectRequest('${request.id}')">Reject</button>`;
            
            if (request.type === 'leave') {
                const userBalance = leaveBalances[request.fromUsername] || {SL: 0, FRL: 0};
                const leaveTypeKey = request.leaveType === 'Sick Leave' ? 'SL' : 'FRL';
                html += `<br><small>Balance: ${userBalance[leaveTypeKey]} days</small>`;
            }
            html += '</td>';
            
            html += '</tr>';
        });
        
        html += '</tbody></table></div>';
    } else {
        // Mobile view - cards
        html = '<div class="pending-requests-mobile">';
        
        pendingRequests.forEach(request => {
            const requestDate = new Date(request.timestamp);
            const formattedDate = requestDate.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            html += '<div class="pending-request-card">';
            html += '<div class="pending-request-header">';
            html += `<span class="request-type">${request.type === 'duty_change' ? '🔀 Duty Change' : '🏖️ Leave'}</span>`;
            html += `<span class="request-date">${formattedDate}</span>`;
            html += '</div>';
            
            html += '<div class="pending-request-body">';
            html += `<p><strong>Staff:</strong> ${request.fromName}</p>`;
            html += `<p><strong>Date:</strong> ${request.date}</p>`;
            
            if (request.type === 'duty_change') {
                html += `<p><strong>Swap:</strong> ${request.currentDuty} ↔ ${request.toName}</p>`;
                html += `<p><strong>To:</strong> ${request.requestedDuty}</p>`;
            } else {
                html += `<p><strong>Type:</strong> ${request.leaveType}</p>`;
                const userBalance = leaveBalances[request.fromUsername] || {SL: 0, FRL: 0};
                const leaveTypeKey = request.leaveType === 'Sick Leave' ? 'SL' : 'FRL';
                html += `<p><strong>Balance:</strong> ${userBalance[leaveTypeKey]} days</p>`;
            }
            
            html += `<p><strong>Reason:</strong> ${request.reason}</p>`;
            html += '</div>';
            
            html += '<div class="pending-request-actions">';
            html += `<button class="btn btn-success btn-sm" onclick="approveRequest('${request.id}')">Approve</button>`;
            html += `<button class="btn btn-danger btn-sm" onclick="rejectRequest('${request.id}')">Reject</button>`;
            html += '</div>';
            
            html += '</div>';
        });
        
        html += '</div>';
    }
    
    container.innerHTML = html;
    updateRequestCounts();
}

async function approveRequest(requestId) {
    if (currentUser.level !== 'Supervisor') {
        showError('Supervisor privileges required');
        return;
    }
    
    const requestIndex = allRequests.findIndex(req => req.id === requestId);
    
    if (requestIndex === -1) {
        showError('Request not found');
        return;
    }
    
    const request = allRequests[requestIndex];
    
    // Process based on request type
    if (request.type === 'duty_change') {
        // Check if both staff are still scheduled for their respective duties
        if (!dutyRoster[request.date] || 
            !dutyRoster[request.date][request.fromUsername] ||
            !dutyRoster[request.date][request.toUsername]) {
            showError('One or both staff are not scheduled for duty on this date');
            return;
        }
        
        // Swap duties
        const tempDuty = dutyRoster[request.date][request.fromUsername];
        dutyRoster[request.date][request.fromUsername] = dutyRoster[request.date][request.toUsername];
        dutyRoster[request.date][request.toUsername] = tempDuty;
        
        try {
            await saveDutyRoster();
        } catch (error) {
            console.error('Error updating duty roster:', error);
            showError('Failed to update duty roster');
            return;
        }
        
    } else if (request.type === 'leave') {
        // Check leave balance
        const userBalance = leaveBalances[request.fromUsername] || {SL: 0, FRL: 0};
        const leaveTypeKey = request.leaveType === 'Sick Leave' ? 'SL' : 'FRL';
        
        if (userBalance[leaveTypeKey] <= 0) {
            showError('Staff has insufficient leave balance');
            return;
        }
        
        // Deduct leave balance
        userBalance[leaveTypeKey] -= 1;
        leaveBalances[request.fromUsername] = userBalance;
        
        try {
            await saveLeaveBalances();
        } catch (error) {
            console.error('Error updating leave balance:', error);
            showError('Failed to update leave balance');
            return;
        }
    }
    
    // Update request status
    allRequests[requestIndex].status = 'approved';
    allRequests[requestIndex].approvedBy = currentUser.name;
    allRequests[requestIndex].approvedAt = new Date().toISOString();
    
    try {
        await saveAllRequests();
        
        // Reload pending requests
        loadPendingRequests();
        
        // Show success message
        showUserNotification(`${request.type === 'duty_change' ? 'Duty change' : 'Leave'} approved for ${request.fromName}`);
        
        // Refresh affected sections
        if (document.getElementById('viewMyRosterSection').classList.contains('active')) {
            loadMyRoster();
        }
        if (document.getElementById('viewAllRosterSection').classList.contains('active')) {
            loadAllRoster();
        }
        
    } catch (error) {
        console.error('Error approving request:', error);
        showError('Failed to approve request');
    }
}

async function rejectRequest(requestId) {
    if (currentUser.level !== 'Supervisor') {
        showError('Supervisor privileges required');
        return;
    }
    
    const reason = prompt('Please enter reason for rejection:');
    if (!reason) return;
    
    const requestIndex = allRequests.findIndex(req => req.id === requestId);
    
    if (requestIndex === -1) {
        showError('Request not found');
        return;
    }
    
    // Update request status
    allRequests[requestIndex].status = 'rejected';
    allRequests[requestIndex].rejectedBy = currentUser.name;
    allRequests[requestIndex].rejectedAt = new Date().toISOString();
    allRequests[requestIndex].rejectionReason = reason;
    
    try {
        await saveAllRequests();
        
        // Reload pending requests
        loadPendingRequests();
        
        // Show success message
        showUserNotification(`Request rejected for ${allRequests[requestIndex].fromName}`);
        
    } catch (error) {
        console.error('Error rejecting request:', error);
        showError('Failed to reject request');
    }
}

// ADMIN ANNOUNCEMENTS
function loadAnnouncementsAdmin() {
    if (currentUser.level !== 'Supervisor') {
        document.getElementById('adminAnnouncementsContainer').innerHTML = 
            '<div class="alert alert-danger">Access denied. Supervisor privileges required.</div>';
        return;
    }
    
    const container = document.getElementById('announcementsList');
    if (!container) return;
    
    // Sort announcements by date (newest first)
    const sortedAnnouncements = announcements.sort((a, b) => 
        new Date(b.timestamp) - new Date(a.timestamp)
    );
    
    if (sortedAnnouncements.length === 0) {
        container.innerHTML = '<div class="alert alert-info">No announcements yet.</div>';
        return;
    }
    
    let html = '';
    
    sortedAnnouncements.forEach((announcement, index) => {
        const announcementDate = new Date(announcement.timestamp);
        const formattedDate = announcementDate.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        html += '<div class="announcement-item">';
        html += '<div class="announcement-item-header">';
        html += `<strong>${announcement.title}</strong>`;
        html += `<small class="text-muted">${formattedDate} - ${announcement.postedBy}</small>`;
        html += '</div>';
        html += '<div class="announcement-item-body">';
        html += announcement.message.replace(/\n/g, '<br>');
        html += '</div>';
        html += '<div class="announcement-item-actions">';
        html += `<button class="btn btn-sm btn-danger" onclick="deleteAnnouncement(${index})">Delete</button>`;
        html += '</div>';
        html += '</div>';
    });
    
    container.innerHTML = html;
}

async function createAnnouncement() {
    if (currentUser.level !== 'Supervisor') {
        showError('Supervisor privileges required');
        return;
    }
    
    const title = document.getElementById('announcementTitle').value.trim();
    const message = document.getElementById('announcementMessage').value.trim();
    
    if (!title || !message) {
        showError('Please enter both title and message');
        return;
    }
    
    const announcement = {
        id: Date.now().toString(),
        title: title,
        message: message,
        postedBy: currentUser.name,
        timestamp: new Date().toISOString()
    };
    
    announcements.unshift(announcement);
    
    try {
        await saveAnnouncements();
        
        // Clear form
        document.getElementById('announcementForm').reset();
        
        // Reload announcements
        loadAnnouncementsAdmin();
        if (document.getElementById('homeSection').classList.contains('active')) {
            loadHomeAnnouncements();
        }
        
        // Show success message
        alert('Announcement posted successfully!');
        
    } catch (error) {
        console.error('Error creating announcement:', error);
        showError('Failed to create announcement');
    }
}

async function deleteAnnouncement(index) {
    if (currentUser.level !== 'Supervisor') {
        showError('Supervisor privileges required');
        return;
    }
    
    if (!confirm('Are you sure you want to delete this announcement?')) {
        return;
    }
    
    announcements.splice(index, 1);
    
    try {
        await saveAnnouncements();
        
        // Reload announcements
        loadAnnouncementsAdmin();
        if (document.getElementById('homeSection').classList.contains('active')) {
            loadHomeAnnouncements();
        }
        
        showUserNotification('Announcement deleted');
        
    } catch (error) {
        console.error('Error deleting announcement:', error);
        showError('Failed to delete announcement');
    }
}

// ADMIN DUTY ROSTER MANAGEMENT
function loadDutyRosterAdmin() {
    if (currentUser.level !== 'Supervisor') {
        document.getElementById('adminDutyRosterContainer').innerHTML = 
            '<div class="alert alert-danger">Access denied. Supervisor privileges required.</div>';
        return;
    }
    
    const dateInput = document.getElementById('rosterDate');
    if (!dateInput.value) {
        const today = new Date().toISOString().split('T')[0];
        dateInput.value = today;
    }
    
    loadRosterForDate(dateInput.value);
}

async function loadRosterForDate(date) {
    if (!date) return;
    
    const container = document.getElementById('rosterEntryContainer');
    if (!container) return;
    
    let html = '';
    
    // Get duty times for this date
    const dateDuties = dutyRoster[date] || {};
    
    allUsers.forEach(user => {
        if (user.Level === 'User') {
            const currentDuty = dateDuties[user.username] || 'Off';
            
            html += '<div class="roster-entry-row">';
            html += `<div class="roster-entry-user">${user.name} (${user.RCNo})</div>`;
            html += '<div class="roster-entry-duty">';
            html += `<select class="form-control duty-time-select" data-username="${user.username}" data-date="${date}">`;
            
            // Add options
            const options = ['Off', '0730-1530', '0830-1630', '1030-1830', '1530-2330', '1630-0030', '1730-0130'];
            options.forEach(option => {
                const selected = option === currentDuty ? 'selected' : '';
                html += `<option value="${option}" ${selected}>${option}</option>`;
            });
            
            // Add custom duty times if present
            if (currentDuty && !options.includes(currentDuty)) {
                html += `<option value="${currentDuty}" selected>${currentDuty}</option>`;
            }
            
            html += `<option value="custom">Custom Time...</option>`;
            html += '</select>';
            html += '</div>';
            html += '</div>';
        }
    });
    
    container.innerHTML = html;
    
    // Add event listeners to selects
    document.querySelectorAll('.duty-time-select').forEach(select => {
        select.addEventListener('change', async function() {
            const username = this.getAttribute('data-username');
            const date = this.getAttribute('data-date');
            const value = this.value;
            
            if (value === 'custom') {
                const customTime = prompt('Enter custom duty time (e.g., 0900-1700):');
                if (customTime) {
                    await updateDutyRoster(date, username, customTime);
                    this.innerHTML = ''; // Will be regenerated
                    loadRosterForDate(date);
                } else {
                    this.value = 'Off';
                }
            } else {
                await updateDutyRoster(date, username, value);
            }
        });
    });
}

async function updateDutyRoster(date, username, dutyTime) {
    if (!dutyRoster[date]) {
        dutyRoster[date] = {};
    }
    
    dutyRoster[date][username] = dutyTime;
    
    try {
        await saveDutyRoster();
        showUserNotification(`Duty updated for ${username} on ${date}`);
    } catch (error) {
        console.error('Error updating duty roster:', error);
        showError('Failed to update duty roster');
    }
}

async function saveRosterDate() {
    const date = document.getElementById('rosterDate').value;
    if (!date) {
        showError('Please select a date');
        return;
    }
    
    try {
        await saveDutyRoster();
        alert('Duty roster saved successfully!');
    } catch (error) {
        console.error('Error saving duty roster:', error);
        showError('Failed to save duty roster');
    }
}

// ADMIN LEAVE BALANCE MANAGEMENT
function loadLeaveBalanceAdmin() {
    if (currentUser.level !== 'Supervisor') {
        document.getElementById('adminLeaveBalanceContainer').innerHTML = 
            '<div class="alert alert-danger">Access denied. Supervisor privileges required.</div>';
        return;
    }
    
    const container = document.getElementById('leaveBalanceContainer');
    if (!container) return;
    
    let html = '<div class="table-responsive"><table class="table table-striped">';
    html += '<thead><tr>';
    html += '<th>Staff Name</th>';
    html += '<th>RC No</th>';
    html += '<th>Sick Leave (SL)</th>';
    html += '<th>Family Responsibility Leave (FRL)</th>';
    html += '<th>Actions</th>';
    html += '</tr></thead><tbody>';
    
    allUsers.forEach(user => {
        if (user.Level === 'User') {
            const balance = leaveBalances[user.username] || {SL: 0, FRL: 0};
            
            html += '<tr>';
            html += `<td>${user.name}</td>`;
            html += `<td>${user.RCNo}</td>`;
            html += `<td><input type="number" step="0.5" min="0" max="30" class="form-control leave-balance-input" 
                     data-username="${user.username}" data-type="SL" value="${balance.SL}" 
                     onchange="updateLeaveBalance('${user.username}', 'SL', this.value)"></td>`;
            html += `<td><input type="number" step="0.5" min="0" max="30" class="form-control leave-balance-input" 
                     data-username="${user.username}" data-type="FRL" value="${balance.FRL}" 
                     onchange="updateLeaveBalance('${user.username}', 'FRL', this.value)"></td>`;
            html += '<td>';
            html += `<button class="btn btn-sm btn-info" onclick="adjustLeaveBalance('${user.username}')">Adjust</button>`;
            html += '</td>';
            html += '</tr>';
        }
    });
    
    html += '</tbody></table></div>';
    
    // Add leave history section
    html += '<div class="mt-4">';
    html += '<h5>Leave History</h5>';
    html += '<div id="leaveHistory" class="table-responsive"></div>';
    html += '</div>';
    
    container.innerHTML = html;
    
    // Load leave history
    loadLeaveHistory();
}

async function updateLeaveBalance(username, type, value) {
    const numValue = parseFloat(value);
    
    if (isNaN(numValue) || numValue < 0) {
        showError('Please enter a valid positive number');
        return;
    }
    
    if (!leaveBalances[username]) {
        leaveBalances[username] = {SL: 0, FRL: 0};
    }
    
    leaveBalances[username][type] = numValue;
    
    try {
        await saveLeaveBalances();
        showUserNotification(`${type} balance updated for ${username}`);
    } catch (error) {
        console.error('Error updating leave balance:', error);
        showError('Failed to update leave balance');
    }
}

function adjustLeaveBalance(username) {
    const user = allUsers.find(u => u.username === username);
    if (!user) return;
    
    const balance = leaveBalances[username] || {SL: 0, FRL: 0};
    
    let adjustment = prompt(`Adjust leave balance for ${user.name}:\n\nCurrent SL: ${balance.SL}\nCurrent FRL: ${balance.FRL}\n\nEnter adjustment (e.g., "+2" or "-1.5" for SL, or "FRL:+3" for FRL):`);
    
    if (!adjustment) return;
    
    let type = 'SL';
    let amount = adjustment.trim();
    
    // Check if specific type is mentioned
    if (amount.toUpperCase().includes('FRL')) {
        type = 'FRL';
        amount = amount.replace(/[^0-9.\+\-]/g, '');
    } else {
        amount = amount.replace(/[^0-9.\+\-]/g, '');
    }
    
    if (!amount.match(/^[+\-]?\d+(\.\d+)?$/)) {
        showError('Invalid adjustment format. Use "+2", "-1.5", "FRL:+3", etc.');
        return;
    }
    
    const currentBalance = balance[type] || 0;
    const newBalance = currentBalance + parseFloat(amount);
    
    if (newBalance < 0) {
        showError('Cannot set negative leave balance');
        return;
    }
    
    updateLeaveBalance(username, type, newBalance.toString());
}

function loadLeaveHistory() {
    const container = document.getElementById('leaveHistory');
    if (!container) return;
    
    // Get all approved leave requests
    const leaveRequests = allRequests.filter(req => 
        req.type === 'leave' && req.status === 'approved'
    ).sort((a, b) => new Date(b.date) - new Date(a.date));
    
    if (leaveRequests.length === 0) {
        container.innerHTML = '<div class="alert alert-info">No leave history found.</div>';
        return;
    }
    
    let html = '<table class="table table-sm">';
    html += '<thead><tr><th>Date</th><th>Staff</th><th>Type</th><th>Approved By</th><th>Balance After</th></tr></thead>';
    html += '<tbody>';
    
    leaveRequests.forEach(request => {
        const userBalance = leaveBalances[request.fromUsername] || {SL: 0, FRL: 0};
        const leaveTypeKey = request.leaveType === 'Sick Leave' ? 'SL' : 'FRL';
        
        html += '<tr>';
        html += `<td>${request.date}</td>`;
        html += `<td>${request.fromName}</td>`;
        html += `<td>${request.leaveType}</td>`;
        html += `<td>${request.approvedBy || 'N/A'}</td>`;
        html += `<td>${leaveTypeKey}: ${userBalance[leaveTypeKey]}</td>`;
        html += '</tr>';
    });
    
    html += '</tbody></table>';
    
    container.innerHTML = html;
}

// ADMIN APPROVALS HISTORY
function loadAdminApprovals() {
    if (currentUser.level !== 'Supervisor') {
        document.getElementById('adminApprovalsContainer').innerHTML = 
            '<div class="alert alert-danger">Access denied. Supervisor privileges required.</div>';
        return;
    }
    
    const container = document.getElementById('approvalsHistoryContainer');
    if (!container) return;
    
    // Get all approved/rejected requests
    const processedRequests = allRequests.filter(req => 
        req.status === 'approved' || req.status === 'rejected'
    ).sort((a, b) => {
        const dateA = a.approvedAt || a.rejectedAt || a.timestamp;
        const dateB = b.approvedAt || b.rejectedAt || b.timestamp;
        return new Date(dateB) - new Date(dateA);
    });
    
    if (processedRequests.length === 0) {
        container.innerHTML = '<div class="alert alert-info">No approval history found.</div>';
        return;
    }
    
    let html = '<div class="table-responsive"><table class="table table-striped">';
    html += '<thead><tr>';
    html += '<th>Date</th>';
    html += '<th>Staff</th>';
    html += '<th>Type</th>';
    html += '<th>Details</th>';
    html += '<th>Status</th>';
    html += '<th>Processed By</th>';
    html += '<th>Time</th>';
    html += '</tr></thead><tbody>';
    
    processedRequests.forEach(request => {
        const processedBy = request.approvedBy || request.rejectedBy || 'N/A';
        const processedAt = request.approvedAt || request.rejectedAt || request.timestamp;
        const processedDate = new Date(processedAt);
        
        html += '<tr>';
        html += `<td>${request.date}</td>`;
        html += `<td>${request.fromName}</td>`;
        html += `<td>${request.type === 'duty_change' ? 'Duty Change' : 'Leave'}</td>`;
        
        if (request.type === 'duty_change') {
            html += `<td>Swap ${request.currentDuty} with ${request.toName}</td>`;
        } else {
            html += `<td>${request.leaveType}</td>`;
        }
        
        html += `<td><span class="badge ${request.status === 'approved' ? 'badge-success' : 'badge-danger'}">${request.status}</span></td>`;
        html += `<td>${processedBy}</td>`;
        html += `<td>${processedDate.toLocaleDateString()} ${processedDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</td>`;
        html += '</tr>';
    });
    
    html += '</tbody></table></div>';
    
    container.innerHTML = html;
}

// ADMIN REQUEST HISTORY
function loadAdminRequestHistory() {
    if (currentUser.level !== 'Supervisor') {
        document.getElementById('adminRequestHistoryContainer').innerHTML = 
            '<div class="alert alert-danger">Access denied. Supervisor privileges required.</div>';
        return;
    }
    
    const container = document.getElementById('allRequestsHistoryContainer');
    if (!container) return;
    
    // Sort all requests by timestamp
    const sortedRequests = [...allRequests].sort((a, b) => 
        new Date(b.timestamp) - new Date(a.timestamp)
    );
    
    if (sortedRequests.length === 0) {
        container.innerHTML = '<div class="alert alert-info">No request history found.</div>';
        return;
    }
    
    let html = '';
    
    if (window.innerWidth > 768) {
        html = '<div class="table-responsive"><table class="table table-striped">';
        html += '<thead><tr>';
        html += '<th>Date</th>';
        html += '<th>Staff</th>';
        html += '<th>Type</th>';
        html += '<th>Details</th>';
        html += '<th>Status</th>';
        html += '<th>Submitted</th>';
        html += '<th>Processed</th>';
        html += '</tr></thead><tbody>';
        
        sortedRequests.forEach(request => {
            const requestDate = new Date(request.timestamp);
            const processedDate = request.approvedAt || request.rejectedAt || request.cancelledAt;
            
            html += '<tr>';
            html += `<td>${request.date}</td>`;
            html += `<td>${request.fromName}</td>`;
            html += `<td>${request.type === 'duty_change' ? 'Duty Change' : 'Leave'}</td>`;
            
            if (request.type === 'duty_change') {
                html += `<td>Swap ${request.currentDuty} with ${request.toName}</td>`;
            } else {
                html += `<td>${request.leaveType}: ${request.reason.substring(0, 30)}${request.reason.length > 30 ? '...' : ''}</td>`;
            }
            
            html += `<td><span class="badge ${getStatusBadgeClass(request.status)}">${request.status}</span></td>`;
            html += `<td>${requestDate.toLocaleDateString()} ${requestDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</td>`;
            
            if (processedDate) {
                const processed = new Date(processedDate);
                html += `<td>${processed.toLocaleDateString()} ${processed.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</td>`;
            } else {
                html += '<td>-</td>';
            }
            
            html += '</tr>';
        });
        
        html += '</tbody></table></div>';
    } else {
        // Mobile view - cards
        html = '<div class="requests-history-mobile">';
        
        sortedRequests.forEach(request => {
            const requestDate = new Date(request.timestamp);
            const formattedDate = requestDate.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            html += '<div class="request-history-card">';
            html += '<div class="request-history-header">';
            html += `<span class="request-type">${request.type === 'duty_change' ? '🔀' : '🏖️'} ${request.fromName}</span>`;
            html += `<span class="request-date">${request.date}</span>`;
            html += '</div>';
            
            html += '<div class="request-history-body">';
            
            if (request.type === 'duty_change') {
                html += `<p>Swap ${request.currentDuty} with ${request.toName}</p>`;
            } else {
                html += `<p>${request.leaveType}</p>`;
            }
            
            html += `<p><strong>Status:</strong> <span class="badge ${getStatusBadgeClass(request.status)}">${request.status}</span></p>`;
            html += `<p><strong>Submitted:</strong> ${formattedDate}</p>`;
            
            if (request.approvedBy || request.rejectedBy) {
                const processedBy = request.approvedBy || request.rejectedBy;
                const processedAt = request.approvedAt || request.rejectedAt;
                const processedDate = new Date(processedAt);
                html += `<p><strong>Processed by:</strong> ${processedBy} at ${processedDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>`;
            }
            
            html += '</div>';
            html += '</div>';
        });
        
        html += '</div>';
    }
    
    container.innerHTML = html;
}

// UTILITY FUNCTIONS
function updateRequestCounts() {
    if (!currentUser) return;
    
    // Pending requests count for supervisor
    if (currentUser.level === 'Supervisor') {
        const pendingCount = allRequests.filter(req => req.status === 'pending').length;
        const pendingBadge = document.getElementById('pendingRequestsBadge');
        if (pendingBadge) {
            pendingBadge.textContent = pendingCount;
            pendingBadge.style.display = pendingCount > 0 ? 'inline-block' : 'none';
        }
    }
    
    // User's pending requests count
    const userPendingCount = allRequests.filter(req => 
        req.fromUsername === currentUser.username && 
        req.status === 'pending'
    ).length;
    
    const myRequestsBadge = document.getElementById('myRequestsBadge');
    if (myRequestsBadge) {
        myRequestsBadge.textContent = userPendingCount;
        myRequestsBadge.style.display = userPendingCount > 0 ? 'inline-block' : 'none';
    }
}

function setupEventListeners() {
    // Duty Change Form
    document.getElementById('dutyChangeForm').addEventListener('submit', function(e) {
        e.preventDefault();
        submitDutyChange();
    });
    
    // Leave Application Form
    document.getElementById('leaveApplicationForm').addEventListener('submit', function(e) {
        e.preventDefault();
        submitLeaveApplication();
    });
    
    // Announcement Form
    document.getElementById('announcementForm').addEventListener('submit', function(e) {
        e.preventDefault();
        createAnnouncement();
    });
    
    // Date change handlers
    document.getElementById('changeDate')?.addEventListener('change', function() {
        loadUserDutyTimes('changeDutyTime', this.value);
    });
    
    document.getElementById('leaveDate')?.addEventListener('change', function() {
        loadUserDutyTimes('leaveDutyTime', this.value);
        updateLeaveRules();
    });
    
    document.getElementById('leaveType')?.addEventListener('change', updateLeaveRules);
    
    // Roster date change
    document.getElementById('rosterDate')?.addEventListener('change', function() {
        loadRosterForDate(this.value);
    });
    
    // View roster date change
    document.getElementById('myRosterMonth')?.addEventListener('change', loadMyRoster);
    document.getElementById('viewRosterDate')?.addEventListener('change', loadAllRoster);
    document.getElementById('allRosterStartDate')?.addEventListener('change', loadAllRoster);
    document.getElementById('allRosterEndDate')?.addEventListener('change', loadAllRoster);
    
    // Save roster button
    document.getElementById('saveRosterBtn')?.addEventListener('click', saveRosterDate);
    
    // Print button
    document.getElementById('printRosterBtn')?.addEventListener('click', printAllRoster);
    
    // Touch-friendly select elements
    const selectElements = document.querySelectorAll('select');
    selectElements.forEach(select => {
        select.addEventListener('touchstart', function() {
            if (window.innerWidth <= 768) {
                this.style.fontSize = '16px'; // Prevent zoom on iOS
            }
        });
    });
}

function updateDashboard() {
    if (!currentUser) return;
    
    // Update today's duty
    const today = new Date().toISOString().split('T')[0];
    const todayDutyElement = document.getElementById('todayDutyTime');
    
    if (todayDutyElement) {
        if (dutyRoster[today] && dutyRoster[today][currentUser.username]) {
            const duty = dutyRoster[today][currentUser.username];
            todayDutyElement.textContent = duty === 'Off' ? 'Off Duty' : duty;
        } else {
            todayDutyElement.textContent = 'Not Scheduled';
        }
    }
    
    // Find next duty
    const nextDutyElement = document.getElementById('nextDutyTime');
    if (nextDutyElement) {
        const tomorrow = new Date();
        let nextDutyFound = false;
        
        for (let i = 1; i <= 7; i++) {
            tomorrow.setDate(tomorrow.getDate() + 1);
            const dateStr = tomorrow.toISOString().split('T')[0];
            if (dutyRoster[dateStr] && dutyRoster[dateStr][currentUser.username]) {
                const duty = dutyRoster[dateStr][currentUser.username];
                if (duty !== 'Off') {
                    nextDutyElement.textContent = `${dateStr}: ${duty}`;
                    nextDutyFound = true;
                    break;
                }
            }
        }
        
        if (!nextDutyFound) {
            nextDutyElement.textContent = 'No upcoming duty';
        }
    }
    
    // Update balance display
    updateUserBalance();
    
    // Load announcements
    loadHomeAnnouncements();
    
    // Check for recent updates
    checkForUserUpdates();
}

function showUserNotification(message) {
    const notificationContainer = document.getElementById('homeNotifications');
    if (notificationContainer) {
        notificationContainer.style.display = 'block';
        notificationContainer.innerHTML = `<div class="alert alert-info alert-dismissible fade show">
            <strong>Update:</strong> ${message}
            <button type="button" class="close" data-dismiss="alert" onclick="this.parentElement.style.display='none'">
                <span>&times;</span>
            </button>
        </div>`;
        
        // Auto hide after 8 seconds on mobile, 10 on desktop
        const hideTime = window.innerWidth <= 768 ? 8000 : 10000;
        setTimeout(() => {
            if (notificationContainer.style.display !== 'none') {
                notificationContainer.style.display = 'none';
            }
        }, hideTime);
    }
}

function checkForUserUpdates() {
    // Check for any approved/rejected requests in last 5 minutes
    const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000);
    
    const recentUpdates = allRequests.filter(req => {
        const updateTime = req.approvedAt || req.rejectedAt;
        if (!updateTime) return false;
        
        const updateDate = new Date(updateTime);
        return updateDate > fiveMinutesAgo && 
               (req.fromUsername === currentUser.username || req.toUsername === currentUser.username);
    });
    
    if (recentUpdates.length > 0) {
        recentUpdates.forEach(update => {
            let message = '';
            if (update.status === 'approved') {
                if (update.type === 'duty_change') {
                    message = `Your duty change for ${update.date} has been approved`;
                } else {
                    message = `Your leave for ${update.date} has been approved`;
                }
            } else if (update.status === 'rejected') {
                message = `Your request for ${update.date} has been rejected`;
            }
            
            if (message) {
                showUserNotification(message);
            }
        });
    }
}

function getDutyTimeClass(dutyTime) {
    if (dutyTime === 'Off') return 'off-day-cell';
    if (dutyTime === 'Not Scheduled') return 'off-day-cell';
    if (dutyTime === 'Leave' || dutyTime.includes('Leave')) return 'duty-leave';
    
    const normalizedTime = dutyTime.replace(/\s/g, '').toUpperCase();
    
    if (dutyTimeColorMap[normalizedTime]) {
        return dutyTimeColorMap[normalizedTime];
    }
    
    if (normalizedTime.includes('-')) {
        const [startStr] = normalizedTime.split('-');
        const startHour = parseInt(startStr.substring(0, 2));
        const startMinute = parseInt(startStr.substring(2, 4)) || 0;
        const totalStartMinutes = startHour * 60 + startMinute;
        
        if (totalStartMinutes >= 0 && totalStartMinutes < 360) {
            return 'duty-0000-0800';
        } else if (totalStartMinutes >= 360 && totalStartMinutes < 450) {
            return 'duty-0600-1400';
        } else if (totalStartMinutes >= 450 && totalStartMinutes < 540) {
            return 'duty-0730-1530';
        } else if (totalStartMinutes >= 540 && totalStartMinutes < 630) {
            return 'duty-0830-1630';
        } else if (totalStartMinutes >= 630 && totalStartMinutes < 750) {
            return 'duty-1030-1830';
        } else if (totalStartMinutes >= 750 && totalStartMinutes < 930) {
            return 'duty-1530-2330';
        } else if (totalStartMinutes >= 930 && totalStartMinutes < 1050) {
            return 'duty-1630-0030';
        } else if (totalStartMinutes >= 1050 && totalStartMinutes < 1170) {
            return 'duty-1730-0130';
        } else {
            return 'duty-1900-0300';
        }
    }
    
    return 'duty-other';
}

// Setup real-time listeners
function setupRealtimeListeners() {
    try {
        // Listen for announcement updates
        db.collection('announcements').doc('all')
            .onSnapshot((doc) => {
                if (doc.exists) {
                    announcements = doc.data().announcements || [];
                    if (document.getElementById('homeSection')?.classList.contains('active')) {
                        loadHomeAnnouncements();
                    }
                    if (document.getElementById('adminAnnouncementsSection')?.classList.contains('active')) {
                        loadAnnouncementsAdmin();
                    }
                }
            }, handleFirebaseError);

        // Listen for request updates
        db.collection('requests').doc('all')
            .onSnapshot((doc) => {
                if (doc.exists && doc.data().requests) {
                    allRequests = doc.data().requests;
                    updateRequestCounts();
                    
                    // Refresh relevant sections
                    if (document.getElementById('myRequestsSection')?.classList.contains('active')) {
                        loadMyRequests();
                    }
                    if (document.getElementById('pendingRequestsSection')?.classList.contains('active')) {
                        loadPendingRequests();
                    }
                    if (document.getElementById('adminApprovalsSection')?.classList.contains('active')) {
                        loadAdminApprovals();
                    }
                    if (document.getElementById('adminRequestHistorySection')?.classList.contains('active')) {
                        loadAdminRequestHistory();
                    }
                }
            }, handleFirebaseError);
            
        console.log('Real-time listeners established');
    } catch (error) {
        console.error('Error setting up real-time listeners:', error);
    }
}

function handleFirebaseError(error) {
    console.error('Firebase error:', error);
    
    if (error.code === 'failed-precondition' || error.message.includes('QUIC')) {
        console.log('Retrying Firebase operation...');
        setTimeout(() => {
            initializeData();
        }, 2000);
    } else {
        alert('A connection error occurred. Please check your internet connection.');
    }
}

// Handle orientation changes
window.addEventListener('orientationchange', function() {
    // Close mobile menu on orientation change
    if (window.innerWidth > 768) {
        closeMobileMenu();
    }
    
    // Redraw any charts or complex layouts if needed
    setTimeout(updateDashboard, 300);
    
    // Refresh current section
    const activeSection = document.querySelector('.section.active');
    if (activeSection) {
        const sectionId = activeSection.id.replace('Section', '');
        loadSectionData(sectionId);
    }
});

// Prevent form submission on enter key in textareas
document.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && e.target.tagName === 'TEXTAREA' && !e.shiftKey) {
        e.preventDefault();
    }
});

// Initialize app
window.onload = function() {
    setTimeout(() => {
        if (!firebaseReady) {
            console.log('Firebase not ready, retrying...');
            initApp();
        }
    }, 2000);
};

// Call this after login
setTimeout(setupRealtimeListeners, 2000);
     </script>
     </body>
     </html> 
