<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Duty Management System</title>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <!-- SHA-256 Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js"></script>
    
    <!-- External Firebase and User files -->
    <script src="dcfire.js" defer></script>
    <script src="user.js" defer></script>
    
    <!-- Font Awesome for Mobile Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* MOBILE FIRST APPROACH */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 0;
            margin: 0;
        }

        /* Mobile Menu Toggle */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            font-size: 20px;
            color: #2c3e50;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            justify-content: center;
            align-items: center;
        }

        /* Mobile Bottom Navigation */
        .mobile-bottom-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e0e6ed;
            z-index: 1000;
            padding: 10px 0;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }

        .mobile-nav-items {
            display: flex;
            justify-content: space-around;
            list-style: none;
        }

        .mobile-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: #7f8c8d;
            font-size: 10px;
            flex: 1;
            padding: 5px;
        }

        .mobile-nav-item.active {
            color: #3498db;
        }

        .mobile-nav-item i {
            font-size: 18px;
            margin-bottom: 4px;
        }

        .mobile-nav-badge {
            position: absolute;
            top: -5px;
            right: 20%;
            background: #e74c3c;
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 10px;
            min-width: 18px;
            text-align: center;
        }

        /* Login Container Mobile */
        .login-container {
            background: white;
            border-radius: 0;
            box-shadow: none;
            width: 100%;
            min-height: 100vh;
            padding: 40px 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        @media (min-width: 768px) {
            .login-container {
                border-radius: 20px;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
                max-width: 400px;
                min-height: auto;
                margin: 20px;
            }
            body {
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 20px;
            }
        }

        .logo {
            text-align: center;
            margin-bottom: 40px;
        }

        .logo h1 {
            color: #2c3e50;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .logo p {
            color: #7f8c8d;
            font-size: 14px;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #2c3e50;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .form-control {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e6ed;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s;
            background: #f8f9fa;
        }

        .form-control:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
            background: white;
        }

        /* Button Styles */
        .btn {
            padding: 16px 24px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn i {
            font-size: 18px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #219653 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f39c12 0%, #d68910 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.3);
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(243, 156, 18, 0.4);
        }

        .btn-block {
            width: 100%;
        }

        /* Dashboard Container Mobile */
        .dashboard-container {
            display: none;
            width: 100%;
            min-height: 100vh;
            background: #f5f7fa;
            position: relative;
        }

        @media (min-width: 768px) {
            .dashboard-container {
                max-width: 1200px;
                min-height: 600px;
                border-radius: 20px;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
                overflow: hidden;
                margin: 20px;
            }
        }

        /* Mobile Header */
        .dashboard-header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        @media (min-width: 768px) {
            .dashboard-header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                padding: 20px 30px;
            }
        }

        .user-info h2 {
            font-size: 18px;
            margin-bottom: 5px;
        }

        .user-details {
            font-size: 13px;
            opacity: 0.9;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        /* Mobile Navigation */
        .dashboard-nav {
            background: #34495e;
            padding: 10px;
            display: none;
            flex-direction: column;
            gap: 5px;
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            width: 280px;
            z-index: 999;
            overflow-y: auto;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            padding-top: 70px;
        }

        .dashboard-nav.mobile-open {
            transform: translateX(0);
            display: flex;
        }

        @media (min-width: 768px) {
            .dashboard-nav {
                display: flex;
                flex-direction: row;
                position: static;
                width: auto;
                transform: none;
                padding: 12px 30px;
                flex-wrap: wrap;
                padding-top: 12px;
            }
        }

        .nav-btn {
            background: none;
            border: none;
            color: white;
            padding: 12px 15px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-btn i {
            font-size: 16px;
            width: 20px;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .nav-btn.active {
            background: #3498db;
        }

        /* Mobile Content Area */
        .dashboard-content {
            padding: 20px;
            padding-bottom: 80px; /* Space for bottom nav */
            min-height: calc(100vh - 140px);
        }

        @media (min-width: 768px) {
            .dashboard-content {
                padding: 25px;
                padding-bottom: 25px;
                min-height: 500px;
            }
        }

        .section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section.active {
            display: block;
        }

        /* Mobile Cards */
        .card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(224, 230, 237, 0.5);
        }

        .card h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 18px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card h3 i {
            color: #3498db;
        }

        /* Mobile Forms */
        .form-row {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        @media (min-width: 768px) {
            .form-row {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 15px;
            }
        }

        /* Mobile Tables */
        .table-container {
            overflow-x: auto;
            margin-top: 15px;
            border: 1px solid #e0e6ed;
            border-radius: 12px;
            -webkit-overflow-scrolling: touch;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            min-width: 600px; /* Minimum width for scrolling */
        }

        th, td {
            padding: 12px 10px;
            text-align: left;
            border-bottom: 1px solid #e0e6ed;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
            font-size: 12px;
            position: sticky;
            left: 0;
        }

        td {
            font-size: 13px;
        }

        /* Mobile Action Buttons */
        .action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 6px 10px;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        /* Mobile Balance Display */
        .balance-display {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }

        @media (min-width: 768px) {
            .balance-display {
                flex-direction: row;
                gap: 20px;
            }
        }

        .balance-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 16px;
            text-align: center;
            color: white;
            flex: 1;
        }

        .balance-value {
            font-size: 32px;
            font-weight: bold;
            margin: 10px 0;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .balance-label {
            font-size: 14px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Mobile Announcements */
        .announcement-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 16px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        .announcement-banner.priority-high {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            animation: pulse-banner 2s infinite;
        }

        .announcement-banner.priority-medium {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .announcement-banner.priority-low {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }

        /* Mobile Tabs */
        .tab-controls {
            display: flex;
            overflow-x: auto;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e6ed;
            padding-bottom: 10px;
            -webkit-overflow-scrolling: touch;
        }

        .tab-btn {
            padding: 10px 15px;
            border: none;
            background: #f0f0f0;
            border-radius: 10px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .tab-btn.active {
            background: #3498db;
            color: white;
        }

        /* Mobile Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        /* Mobile Swipe Indicators */
        .swipe-hint {
            text-align: center;
            color: #7f8c8d;
            font-size: 12px;
            padding: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .swipe-hint i {
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(5px); }
        }

        /* Mobile Calendar */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-top: 15px;
        }

        .calendar-day {
            border: 1px solid #e0e6ed;
            padding: 6px;
            min-height: 50px;
            border-radius: 8px;
            background: #f8f9fa;
            font-size: 12px;
        }

        /* Mobile Modal */
        .mobile-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1001;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .mobile-modal-content {
            background: white;
            border-radius: 20px;
            padding: 25px;
            max-width: 400px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #7f8c8d;
            cursor: pointer;
        }

        /* Mobile Status Indicators */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-pending {
            background: rgba(243, 156, 18, 0.1);
            color: #f39c12;
        }

        .status-approved {
            background: rgba(39, 174, 96, 0.1);
            color: #27ae60;
        }

        .status-rejected {
            background: rgba(231, 76, 60, 0.1);
            color: #e74c3c;
        }

        .status-off {
            background: rgba(127, 140, 141, 0.1);
            color: #7f8c8d;
        }

        /* Mobile Pull-to-Refresh */
        .pull-to-refresh {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }

        /* Touch-friendly Date Inputs */
        input[type="date"],
        input[type="time"],
        input[type="month"] {
            padding: 15px;
            font-size: 16px; /* Prevents zoom on iOS */
        }

        /* Mobile Search Bar */
        .mobile-search {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 15px;
            z-index: 1002;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .mobile-search.active {
            display: block;
        }

        .search-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e6ed;
            border-radius: 12px;
            font-size: 16px;
        }

        /* Mobile Empty States */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #7f8c8d;
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* Mobile Toast Notifications */
        .mobile-toast {
            position: fixed;
            bottom: 80px;
            left: 20px;
            right: 20px;
            background: #2c3e50;
            color: white;
            padding: 15px;
            border-radius: 12px;
            z-index: 1003;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .mobile-toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        /* Mobile Swipe Actions */
        .swipe-actions {
            display: none;
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            background: linear-gradient(to right, transparent, rgba(231, 76, 60, 0.9));
            justify-content: flex-end;
            align-items: center;
            padding-right: 20px;
            border-radius: 12px;
        }

        .swipe-item {
            position: relative;
            overflow: hidden;
        }

        .swipe-item.active .swipe-actions {
            display: flex;
        }

        /* DUTY TIME COLORS FOR MOBILE */
        .duty-0730-1530 {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%) !important;
            color: #856404 !important;
        }
        
        .duty-0830-1630 {
            background: linear-gradient(135deg, #e2d9f3 0%, #d6c6f7 100%) !important;
            color: #563d7c !important;
        }
        
        .duty-1030-1830 {
            background: linear-gradient(135deg, #fffde7 0%, #fff9c4 100%) !important;
            color: #827717 !important;
        }
        
        .duty-1530-2330 {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%) !important;
            color: #0d47a1 !important;
        }
        
        .duty-1630-0030 {
            background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%) !important;
            color: #424242 !important;
        }
        
        .duty-1730-0130 {
            background: linear-gradient(135deg, #eeeeee 0%, #bdbdbd 100%) !important;
            color: #212121 !important;
        }
        
        .duty-0030-0830 {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%) !important;
            color: #c62828 !important;
        }
        
        .duty-leave {
            background: linear-gradient(135deg, #ffd8a6 0%, #ffc078 100%) !important;
            color: #e8590c !important;
            border: 1px dashed #fd7e14 !important;
        }
        
        .off-day-cell {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%) !important;
            color: #155724 !important;
            font-weight: 500;
        }

        /* Mobile Specific Adjustments */
        @media (max-width: 767px) {
            .mobile-menu-toggle {
                display: flex;
            }
            
            .mobile-bottom-nav {
                display: block;
            }
            
            .dashboard-nav:not(.mobile-open) {
                display: none;
            }
            
            .table-container table {
                font-size: 12px;
            }
            
            th, td {
                padding: 8px 6px;
            }
            
            .card {
                padding: 15px;
            }
            
            .btn {
                padding: 14px 20px;
                font-size: 15px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .action-btn {
                width: 100%;
                justify-content: center;
            }
            
            /* Hide desktop-only elements */
            .desktop-only {
                display: none !important;
            }
            
            /* Show mobile-only elements */
            .mobile-only {
                display: block !important;
            }
        }

        @media (min-width: 768px) {
            .mobile-only {
                display: none !important;
            }
            
            .mobile-menu-toggle,
            .mobile-bottom-nav,
            .mobile-modal {
                display: none !important;
            }
            
            .dashboard-nav {
                display: flex !important;
            }
        }

        /* Dark Mode Support */
        @media (prefers-color-scheme: dark) {
            body {
                background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            }
            
            .login-container,
            .dashboard-container,
            .card,
            .mobile-modal-content {
                background: #1a1a1a;
                color: #ffffff;
            }
            
            .form-control {
                background: #2c3e50;
                border-color: #34495e;
                color: #ffffff;
            }
            
            .card h3 {
                color: #ffffff;
            }
            
            table {
                background: #2c3e50;
                color: #ffffff;
            }
            
            th {
                background: #34495e;
                color: #ffffff;
            }
            
            td {
                border-color: #34495e;
            }
            
            .balance-box {
                background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
            }
        }

        /* Print Styles */
        @media print {
            .mobile-menu-toggle,
            .mobile-bottom-nav,
            .dashboard-nav,
            .btn {
                display: none !important;
            }
            
            .dashboard-content {
                padding: 0;
            }
            
            .card {
                box-shadow: none;
                border: 1px solid #000;
            }
        }
    </style>
</head>
<body>
    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle" id="mobileMenuToggle">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Mobile Search Bar -->
    <div class="mobile-search" id="mobileSearch">
        <input type="text" class="search-input" placeholder="Search..." id="searchInput">
    </div>

    <!-- Login Container -->
    <div class="login-container" id="loginContainer">
        <div class="logo">
            <i class="fas fa-calendar-alt" style="font-size: 48px; color: #3498db; margin-bottom: 15px;"></i>
            <h1>Duty Management</h1>
            <p>Secure Mobile Access</p>
        </div>
        
        <form id="loginForm">
            <div class="form-group">
                <label for="username"><i class="fas fa-user"></i> Username</label>
                <input type="text" id="username" class="form-control" placeholder="Enter username" required autofocus>
            </div>
            
            <div class="form-group">
                <label for="password"><i class="fas fa-lock"></i> Password</label>
                <input type="password" id="password" class="form-control" placeholder="Enter password" required>
            </div>
            
            <button type="submit" class="btn btn-primary btn-block" id="loginBtn">
                <i class="fas fa-sign-in-alt"></i> Login
            </button>
            
            <div class="error-message" id="errorMessage">
                <i class="fas fa-exclamation-circle"></i> Invalid username or password
            </div>
            
            <div class="swipe-hint mobile-only" style="margin-top: 20px;">
                <i class="fas fa-fingerprint"></i> Swipe or tap to navigate
            </div>
        </form>
    </div>
    
    <!-- Dashboard Container -->
    <div class="dashboard-container" id="dashboardContainer">
        <!-- Header -->
        <div class="dashboard-header">
            <div class="user-info">
                <h2 id="userName"><i class="fas fa-user-circle"></i> User Name</h2>
                <div class="user-details">
                    <span><i class="fas fa-id-card"></i> RC: <span id="userRC">000</span></span>
                    <span><i class="fas fa-user-tag"></i> Level: <span id="userLevel">User</span></span>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn btn-danger" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
                <button class="btn btn-primary mobile-only" id="mobileSearchToggle">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
        
        <!-- Navigation -->
        <div class="dashboard-nav" id="dashboardNav">
            <button class="nav-btn active" data-section="home">
                <i class="fas fa-home"></i> Dashboard
            </button>
            <button class="nav-btn" data-section="dutyChange">
                <i class="fas fa-exchange-alt"></i> Duty Change
            </button>
            <button class="nav-btn" data-section="leaveApplication">
                <i class="fas fa-calendar-times"></i> Apply Leave
            </button>
            <button class="nav-btn" data-section="myRequests">
                <i class="fas fa-list-alt"></i> My Requests
            </button>
            <button class="nav-btn" data-section="viewMyRoster">
                <i class="fas fa-calendar-check"></i> My Roster
            </button>
            <button class="nav-btn" data-section="viewAllRoster" id="viewAllRosterBtn">
                <i class="fas fa-calendar-alt"></i> View All Roster
            </button>
            <button class="nav-btn" data-section="pendingRequests" id="pendingRequestsBtn" style="display:none;">
                <i class="fas fa-clock"></i> Pending 
                <span id="pendingCount" class="notification-badge">0</span>
            </button>
            <!-- Admin Only -->
            <button class="nav-btn" data-section="adminDutyRoster" id="adminDutyRosterBtn" style="display:none;">
                <i class="fas fa-edit"></i> Duty Roster
            </button>
            <button class="nav-btn" data-section="adminLeaveBalance" id="adminLeaveBalanceBtn" style="display:none;">
                <i class="fas fa-balance-scale"></i> Leave Balance
            </button>
            <button class="nav-btn" data-section="adminApprovals" id="adminApprovalsBtn" style="display:none;">
                <i class="fas fa-check-circle"></i> Approvals
            </button>
            <button class="nav-btn" data-section="adminRequestHistory" id="adminRequestHistoryBtn" style="display:none;">
                <i class="fas fa-history"></i> Request History
                <span id="historyNotification" class="notification-dot" style="display:none;"></span>
            </button>
            <button class="nav-btn" data-section="adminAnnouncements" id="adminAnnouncementsBtn" style="display:none;">
                <i class="fas fa-bullhorn"></i> Announcements
            </button>
        </div>
        
        <!-- Content Area -->
        <div class="dashboard-content">
            <!-- All existing sections remain here with mobile icons -->
            <!-- Dashboard -->
            <div class="section active" id="homeSection">
                <div class="pull-to-refresh" id="pullToRefresh">
                    <i class="fas fa-arrow-down"></i> Pull to refresh
                </div>
                
                <div id="homeAnnouncements">
                    <!-- Announcements will be loaded here -->
                </div>
                
                <div class="card">
                    <h3><i class="fas fa-user"></i> Welcome, <span id="welcomeName">User</span>!</h3>
                    
                    <div class="balance-display">
                        <div class="balance-box">
                            <div class="balance-label">Sick Leave Balance</div>
                            <div class="balance-value" id="slBalance">0</div>
                            <div class="balance-label">Days</div>
                        </div>
                        <div class="balance-box">
                            <div class="balance-label">FRL Balance</div>
                            <div class="balance-value" id="frlBalance">0</div>
                            <div class="balance-label">Days</div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <p><strong><i class="fas fa-calendar-day"></i> Today's Duty:</strong> <span id="todayDutyTime">Not Scheduled</span></p>
                        <p><strong><i class="fas fa-calendar-week"></i> Next Duty:</strong> <span id="nextDutyTime">No upcoming duty</span></p>
                        <div id="homeNotifications" style="margin-top: 10px; display: none;">
                            <!-- Notifications will appear here -->
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <button class="btn btn-primary" onclick="updateDashboard()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button class="btn btn-warning" onclick="showSection('dutyChange')">
                            <i class="fas fa-exchange-alt"></i> Request Change
                        </button>
                        <button class="btn btn-success" onclick="showSection('leaveApplication')">
                            <i class="fas fa-calendar-times"></i> Apply Leave
                        </button>
                        <button class="btn btn-primary" onclick="showSection('myRequests')">
                            <i class="fas fa-list-alt"></i> My Requests
                        </button>
                        <button class="btn btn-primary" onclick="showSection('viewMyRoster')">
                            <i class="fas fa-calendar-check"></i> My Roster
                        </button>
                        <button class="btn btn-primary" onclick="showSection('viewAllRoster')">
                            <i class="fas fa-calendar-alt"></i> All Roster
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- All other sections remain the same but with mobile-friendly adjustments -->
            <!-- ... (other sections remain unchanged) ... -->
            
        </div>
        
        <!-- Mobile Bottom Navigation -->
        <div class="mobile-bottom-nav">
            <ul class="mobile-nav-items">
                <li>
                    <a href="#" class="mobile-nav-item active" data-section="home" onclick="showMobileSection('home')">
                        <i class="fas fa-home"></i>
                        <span>Home</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="mobile-nav-item" data-section="dutyChange" onclick="showMobileSection('dutyChange')">
                        <i class="fas fa-exchange-alt"></i>
                        <span>Change</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="mobile-nav-item" data-section="leaveApplication" onclick="showMobileSection('leaveApplication')">
                        <i class="fas fa-calendar-times"></i>
                        <span>Leave</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="mobile-nav-item" data-section="myRequests" onclick="showMobileSection('myRequests')">
                        <i class="fas fa-list-alt"></i>
                        <span>Requests</span>
                        <span class="mobile-nav-badge" id="mobileRequestBadge" style="display: none;">0</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="mobile-nav-item" data-section="viewAllRoster" onclick="showMobileSection('viewAllRoster')">
                        <i class="fas fa-calendar-alt"></i>
                        <span>Roster</span>
                    </a>
                </li>
            </ul>
        </div>
    </div>
    
    <!-- Mobile Modals -->
    <div class="mobile-modal" id="mobileModal">
        <div class="mobile-modal-content" id="modalContent">
            <!-- Modal content will be loaded here -->
        </div>
    </div>
    
    <!-- Mobile Toast -->
    <div class="mobile-toast" id="mobileToast">
        <div id="toastMessage"></div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let allUsers = [];
        let dutyRoster = {};
        let leaveBalances = {};
        let allRequests = [];
        let announcements = [];
        let userDisplayNameMap = {};
        let firebaseReady = false;
        let isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        let touchStartX = 0;
        let touchStartY = 0;
        let lastScrollTop = 0;

        // Initialize on DOM load
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize mobile features
            initMobileFeatures();
            
            // Wait for Firebase
            setTimeout(() => {
                if (typeof db !== 'undefined' && typeof users !== 'undefined') {
                    firebaseReady = true;
                    console.log('Mobile app ready');
                    initApp();
                }
            }, 1000);
        });

        function initMobileFeatures() {
            // Mobile menu toggle
            document.getElementById('mobileMenuToggle').addEventListener('click', toggleMobileMenu);
            
            // Mobile search toggle
            document.getElementById('mobileSearchToggle')?.addEventListener('click', toggleMobileSearch);
            
            // Close mobile menu when clicking outside
            document.addEventListener('click', function(event) {
                const nav = document.getElementById('dashboardNav');
                const menuToggle = document.getElementById('mobileMenuToggle');
                if (nav.classList.contains('mobile-open') && 
                    !nav.contains(event.target) && 
                    !menuToggle.contains(event.target)) {
                    closeMobileMenu();
                }
            });
            
            // Touch gestures for swipe actions
            setupTouchGestures();
            
            // Pull to refresh
            setupPullToRefresh();
            
            // Handle back button on mobile
            window.addEventListener('popstate', function() {
                showSection('home');
            });
            
            // Handle keyboard visibility
            setupKeyboardHandling();
        }

        function toggleMobileMenu() {
            const nav = document.getElementById('dashboardNav');
            nav.classList.toggle('mobile-open');
            const icon = document.querySelector('#mobileMenuToggle i');
            icon.className = nav.classList.contains('mobile-open') ? 'fas fa-times' : 'fas fa-bars';
        }

        function closeMobileMenu() {
            const nav = document.getElementById('dashboardNav');
            nav.classList.remove('mobile-open');
            document.querySelector('#mobileMenuToggle i').className = 'fas fa-bars';
        }

        function toggleMobileSearch() {
            const searchBar = document.getElementById('mobileSearch');
            searchBar.classList.toggle('active');
            if (searchBar.classList.contains('active')) {
                document.getElementById('searchInput').focus();
            }
        }

        function showMobileSection(sectionId) {
            closeMobileMenu();
            showSection(sectionId);
            
            // Update mobile nav active state
            document.querySelectorAll('.mobile-nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.section === sectionId) {
                    item.classList.add('active');
                }
            });
            
            // Add to browser history for back button
            history.pushState({section: sectionId}, '', `#${sectionId}`);
        }

        function setupTouchGestures() {
            let touchStartX, touchStartY;
            
            document.addEventListener('touchstart', function(e) {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
            }, {passive: true});
            
            document.addEventListener('touchend', function(e) {
                if (!touchStartX || !touchStartY) return;
                
                const touchEndX = e.changedTouches[0].clientX;
                const touchEndY = e.changedTouches[0].clientY;
                
                const diffX = touchStartX - touchEndX;
                const diffY = touchStartY - touchEndY;
                
                // Swipe left/right (minimal vertical movement)
                if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffY) < 50) {
                    if (diffX > 50) {
                        // Swipe left - next section
                        navigateSections('next');
                    } else if (diffX < -50) {
                        // Swipe right - previous section
                        navigateSections('prev');
                    }
                }
            }, {passive: true});
            
            // Add swipe actions to table rows
            document.addEventListener('click', function(e) {
                const row = e.target.closest('.swipe-item');
                if (row) {
                    document.querySelectorAll('.swipe-item').forEach(item => {
                        if (item !== row) item.classList.remove('active');
                    });
                    row.classList.toggle('active');
                }
            });
        }

        function navigateSections(direction) {
            const sections = ['home', 'dutyChange', 'leaveApplication', 'myRequests', 'viewAllRoster'];
            const currentSection = getCurrentSection();
            const currentIndex = sections.indexOf(currentSection);
            
            if (currentIndex === -1) return;
            
            let nextIndex;
            if (direction === 'next') {
                nextIndex = (currentIndex + 1) % sections.length;
            } else {
                nextIndex = (currentIndex - 1 + sections.length) % sections.length;
            }
            
            showMobileSection(sections[nextIndex]);
        }

        function getCurrentSection() {
            const activeSection = document.querySelector('.section.active');
            if (activeSection) {
                return activeSection.id.replace('Section', '');
            }
            return 'home';
        }

        function setupPullToRefresh() {
            let startY;
            const pullToRefresh = document.getElementById('pullToRefresh');
            
            if (!pullToRefresh) return;
            
            document.addEventListener('touchstart', function(e) {
                if (window.scrollY === 0) {
                    startY = e.touches[0].pageY;
                }
            }, {passive: true});
            
            document.addEventListener('touchmove', function(e) {
                if (!startY) return;
                
                const currentY = e.touches[0].pageY;
                const diff = currentY - startY;
                
                if (diff > 0 && window.scrollY === 0) {
                    e.preventDefault();
                    pullToRefresh.style.transform = `translateY(${Math.min(diff, 100)}px)`;
                    
                    if (diff > 100) {
                        pullToRefresh.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> Release to refresh';
                    }
                }
            }, {passive: false});
            
            document.addEventListener('touchend', function(e) {
                if (!startY) return;
                
                const currentY = e.changedTouches[0].pageY;
                const diff = currentY - startY;
                
                if (diff > 100) {
                    updateDashboard();
                    showToast('Dashboard refreshed');
                }
                
                pullToRefresh.style.transform = 'translateY(0)';
                pullToRefresh.innerHTML = '<i class="fas fa-arrow-down"></i> Pull to refresh';
                startY = null;
            }, {passive: true});
        }

        function setupKeyboardHandling() {
            // Scroll to focused input on mobile
            const inputs = document.querySelectorAll('input, textarea, select');
            inputs.forEach(input => {
                input.addEventListener('focus', function() {
                    setTimeout(() => {
                        this.scrollIntoView({behavior: 'smooth', block: 'center'});
                    }, 300);
                });
            });
            
            // Close keyboard on form submit
            document.addEventListener('submit', function() {
                if (isMobile) {
                    document.activeElement.blur();
                }
            });
        }

        function showModal(content) {
            const modal = document.getElementById('mobileModal');
            const modalContent = document.getElementById('modalContent');
            
            modalContent.innerHTML = content;
            modal.style.display = 'flex';
            
            // Close modal when clicking outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeModal();
                }
            });
        }

        function closeModal() {
            document.getElementById('mobileModal').style.display = 'none';
        }

        function showToast(message, duration = 3000) {
            const toast = document.getElementById('mobileToast');
            const toastMessage = document.getElementById('toastMessage');
            
            toastMessage.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }

        // Update all existing functions to be mobile-friendly
        function showSection(sectionId) {
            // Mobile-specific handling
            if (isMobile) {
                showMobileSection(sectionId);
            } else {
                // Desktop version
                document.querySelectorAll('.section').forEach(section => {
                    section.classList.remove('active');
                });
                
                const section = document.getElementById(sectionId + 'Section');
                if (section) {
                    section.classList.add('active');
                    
                    // Update desktop nav
                    document.querySelectorAll('.nav-btn').forEach(btn => {
                        btn.classList.remove('active');
                        if (btn.dataset.section === sectionId) {
                            btn.classList.add('active');
                        }
                    });
                }
            }
            
            // Load section data
            loadSectionData(sectionId);
        }

        function loadSectionData(sectionId) {
            // Close mobile menu if open
            closeMobileMenu();
            
            // Scroll to top
            window.scrollTo(0, 0);
            
            // Load appropriate data
            switch(sectionId) {
                case 'home':
                    loadHomeAnnouncements();
                    break;
                case 'dutyChange':
                    loadDutyChangeForm();
                    break;
                case 'leaveApplication':
                    loadLeaveForm();
                    break;
                case 'myRequests':
                    loadMyRequests();
                    break;
                case 'viewMyRoster':
                    loadMyRoster();
                    break;
                case 'viewAllRoster':
                    loadAllRoster();
                    break;
                case 'pendingRequests':
                    loadPendingRequests();
                    break;
                case 'adminAnnouncements':
                    loadAnnouncementsAdmin();
                    break;
                case 'adminDutyRoster':
                    loadDutyRosterAdmin();
                    break;
                case 'adminLeaveBalance':
                    loadLeaveBalanceAdmin();
                    break;
                case 'adminApprovals':
                    loadAdminApprovals();
                    break;
                case 'adminRequestHistory':
                    loadAdminRequestHistory();
                    break;
            }
        }

        // Update form submissions for mobile
        function setupMobileForms() {
            // Add mobile-specific form enhancements
            document.querySelectorAll('form').forEach(form => {
                form.addEventListener('submit', function(e) {
                    if (isMobile) {
                        // Show loading state
                        const submitBtn = this.querySelector('button[type="submit"]');
                        if (submitBtn) {
                            const originalText = submitBtn.innerHTML;
                            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
                            submitBtn.disabled = true;
                            
                            // Restore button after submission
                            setTimeout(() => {
                                submitBtn.innerHTML = originalText;
                                submitBtn.disabled = false;
                            }, 2000);
                        }
                    }
                });
            });
            
            // Add clear buttons to inputs
            document.querySelectorAll('.form-control').forEach(input => {
                if (isMobile && input.type !== 'password') {
                    input.style.paddingRight = '40px';
                    input.parentElement.style.position = 'relative';
                    
                    const clearBtn = document.createElement('button');
                    clearBtn.type = 'button';
                    clearBtn.innerHTML = '<i class="fas fa-times"></i>';
                    clearBtn.style.cssText = `
                        position: absolute;
                        right: 10px;
                        top: 50%;
                        transform: translateY(-50%);
                        background: none;
                        border: none;
                        color: #7f8c8d;
                        font-size: 16px;
                        cursor: pointer;
                        display: none;
                    `;
                    
                    input.parentElement.appendChild(clearBtn);
                    
                    input.addEventListener('input', function() {
                        clearBtn.style.display = this.value ? 'block' : 'none';
                    });
                    
                    clearBtn.addEventListener('click', function() {
                        input.value = '';
                        input.focus();
                        clearBtn.style.display = 'none';
                    });
                }
            });
        }

        // Update table display for mobile
        function makeTablesResponsive() {
            document.querySelectorAll('.table-container').forEach(container => {
                if (isMobile) {
                    container.style.overflowX = 'auto';
                    container.style.webkitOverflowScrolling = 'touch';
                    
                    // Add scroll indicator for horizontal tables
                    const table = container.querySelector('table');
                    if (table.scrollWidth > container.clientWidth) {
                        const hint = document.createElement('div');
                        hint.className = 'swipe-hint';
                        hint.innerHTML = '<i class="fas fa-arrow-right"></i> Swipe to view more';
                        container.parentNode.insertBefore(hint, container.nextSibling);
                    }
                }
            });
        }

        // Update all existing Firebase functions with mobile optimizations
        async function initializeData() {
            if (!firebaseReady) return;
            
            try {
                // Show loading state on mobile
                if (isMobile) {
                    showToast('Loading data...');
                }
                
                await Promise.all([
                    loadDutyRoster(),
                    loadLeaveBalances(),
                    loadAllRequests(),
                    loadAnnouncements()
                ]);
                
                updateUserBalance();
                
                if (isMobile) {
                    showToast('Data loaded successfully');
                }
                
            } catch (error) {
                console.error('Error initializing data:', error);
                showToast('Failed to load data', 5000);
            }
        }

        // Update dashboard with mobile notifications
        function updateDashboard() {
            // ... existing dashboard code ...
            
            // Add mobile notification badge
            const pendingReqs = allRequests.filter(req => 
                req.status === 'pending' && 
                req.fromUsername === currentUser.username
            ).length;
            
            const badge = document.getElementById('mobileRequestBadge');
            if (pendingReqs > 0) {
                badge.textContent = pendingReqs;
                badge.style.display = 'block';
            } else {
                badge.style.display = 'none';
            }
            
            if (isMobile) {
                showToast('Dashboard updated');
            }
        }

        // Mobile-specific login enhancements
        function handleLogin() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            
            if (!username || !password) {
                showError('Please enter both username and password');
                return;
            }
            
            // Show loading state on mobile
            if (isMobile) {
                const loginBtn = document.getElementById('loginBtn');
                const originalHtml = loginBtn.innerHTML;
                loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Authenticating...';
                loginBtn.disabled = true;
            }
            
            // ... existing login logic ...
            
            // Restore button state
            if (isMobile) {
                setTimeout(() => {
                    const loginBtn = document.getElementById('loginBtn');
                    loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Login';
                    loginBtn.disabled = false;
                }, 1000);
            }
        }

        // Initialize mobile-specific features after login
        function loginUser(userData) {
            currentUser = userData;
            
            // ... existing login logic ...
            
            // Initialize mobile features
            if (isMobile) {
                setupMobileForms();
                makeTablesResponsive();
                
                // Add vibration feedback for important actions (if supported)
                if ('vibrate' in navigator) {
                    setupVibrationFeedback();
                }
                
                // Setup offline detection
                setupOfflineDetection();
            }
        }

        function setupVibrationFeedback() {
            // Vibrate on successful actions
            document.querySelectorAll('.btn-success').forEach(btn => {
                btn.addEventListener('click', function() {
                    navigator.vibrate(50);
                });
            });
            
            // Vibrate on errors
            document.querySelectorAll('.btn-danger').forEach(btn => {
                btn.addEventListener('click', function() {
                    navigator.vibrate([50, 50, 50]);
                });
            });
        }

        function setupOfflineDetection() {
            window.addEventListener('online', function() {
                showToast('Back online. Syncing data...');
                initializeData();
            });
            
            window.addEventListener('offline', function() {
                showToast('You are offline. Some features may be limited.', 5000);
            });
        }

        // Update all existing functions to use mobile notifications
        function showUserNotification(message) {
            if (isMobile) {
                showToast(message);
            } else {
                // Desktop notification
                const notificationContainer = document.getElementById('homeNotifications');
                if (notificationContainer) {
                    notificationContainer.style.display = 'block';
                    notificationContainer.innerHTML = `<div class="alert alert-info">
                        <strong>Update:</strong> ${message}
                    </div>`;
                    
                    setTimeout(() => {
                        notificationContainer.style.display = 'none';
                    }, 10000);
                }
            }
        }

        // Mobile-specific date picker enhancement
        function setupMobileDatePickers() {
            if (isMobile) {
                document.querySelectorAll('input[type="date"]').forEach(input => {
                    input.addEventListener('focus', function() {
                        // Set minimum date to today
                        const today = new Date().toISOString().split('T')[0];
                        this.min = today;
                        
                        // For iOS, we need to ensure proper display
                        if (/(iPad|iPhone|iPod)/g.test(navigator.userAgent)) {
                            this.type = 'text';
                            setTimeout(() => {
                                this.type = 'date';
                            }, 100);
                        }
                    });
                });
            }
        }

        // Add this to your initApp function
        function initApp() {
            // ... existing init code ...
            
            if (isMobile) {
                setupMobileDatePickers();
                
                // Prevent zoom on double tap
                document.addEventListener('dblclick', function(e) {
                    e.preventDefault();
                }, { passive: false });
                
                // Better touch handling for buttons
                document.querySelectorAll('.btn, .action-btn, .nav-btn').forEach(btn => {
                    btn.style.cursor = 'pointer';
                    btn.addEventListener('touchstart', function() {
                        this.style.opacity = '0.8';
                    });
                    btn.addEventListener('touchend', function() {
                        this.style.opacity = '1';
                    });
                });
            }
            
            // ... rest of init code ...
        }

        // Mobile-optimized roster display
        function displayAllRosterTable(startDate, endDate, year, month) {
            const today = new Date().toISOString().split('T')[0];
            let html = `<h4><i class="fas fa-calendar-alt"></i> Roster for ${month}/${year}</h4>`;
            
            // Mobile: Show date selector
            if (isMobile) {
                html += `
                    <div class="form-row">
                        <input type="date" class="form-control" id="mobileRosterDate" value="${today}">
                        <button class="btn btn-primary" onclick="loadRosterForDate()">
                            <i class="fas fa-search"></i> Go
                        </button>
                    </div>
                `;
            }
            
            html += '<div class="table-container"><table><thead><tr><th>Date</th><th>Day</th>';
            
            // Limit displayed staff on mobile
            const displayStaff = isMobile ? allUsers.filter(u => u.Level === 'User').slice(0, 3) : allUsers.filter(u => u.Level === 'User');
            
            displayStaff.forEach(user => {
                html += `<th class="staff-name">${user.name.substring(0, 8)}<br><small>${user.RCNo}</small></th>`;
            });
            
            if (isMobile && allUsers.filter(u => u.Level === 'User').length > 3) {
                html += `<th><i class="fas fa-ellipsis-h"></i></th>`;
            }
            
            html += '</tr></thead><tbody>';
            
            // Display only next 7 days on mobile
            const displayDays = isMobile ? 7 : Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
            
            for (let i = 0; i < displayDays; i++) {
                const d = new Date(startDate);
                d.setDate(d.getDate() + i);
                const dateStr = d.toISOString().split('T')[0];
                const dayName = d.toLocaleDateString('en-US', { weekday: 'short' });
                const isToday = dateStr === today;
                
                html += `<tr ${isToday ? 'style="background-color: #fff3cd;"' : ''}>`;
                html += `<td>${dateStr.substring(5)}${isToday ? ' <strong>(T)</strong>' : ''}</td>`;
                html += `<td>${dayName}</td>`;
                
                displayStaff.forEach(user => {
                    let dutyTime = 'Off';
                    let cellClass = 'off-day-cell';
                    let leaveIndicator = '';
                    
                    const approvedLeave = allRequests.find(req => 
                        req.fromUsername === user.username &&
                        req.type === 'leave' &&
                        req.status === 'approved' &&
                        req.date === dateStr
                    );
                    
                    if (approvedLeave) {
                        dutyTime = 'L';
                        cellClass = 'duty-leave';
                        leaveIndicator = `<span class="leave-indicator">${approvedLeave.leaveType === 'Sick Leave' ? 'SL' : 'FRL'}</span>`;
                    } else if (dutyRoster[dateStr] && dutyRoster[dateStr][user.username]) {
                        dutyTime = dutyRoster[dateStr][user.username];
                        cellClass = getDutyTimeClass(dutyTime);
                        
                        // Shorten time for mobile
                        if (dutyTime !== 'Off') {
                            const timeParts = dutyTime.split('-');
                            if (timeParts.length === 2) {
                                dutyTime = timeParts[0].substring(0, 5);
                            }
                        }
                    }
                    
                    if (isToday) {
                        cellClass += ' today-cell';
                    }
                    
                    html += `<td class="${cellClass}" title="${dutyRoster[dateStr] && dutyRoster[dateStr][user.username] || 'Off'}">${dutyTime} ${leaveIndicator}</td>`;
                });
                
                if (isMobile && allUsers.filter(u => u.Level === 'User').length > 3) {
                    html += `<td><i class="fas fa-ellipsis-h"></i></td>`;
                }
                
                html += '</tr>';
            }
            
            html += '</tbody></table></div>';
            
            if (isMobile) {
                html += `
                    <div class="form-row" style="margin-top: 15px;">
                        <button class="btn btn-primary" onclick="showModal('<h3>Full Roster</h3><p>Use desktop version for full view or swipe left/right on table.</p>')">
                            <i class="fas fa-expand-alt"></i> View Full
                        </button>
                    </div>
                `;
            }
            
            return html;
        }

        function loadRosterForDate() {
            const date = document.getElementById('mobileRosterDate').value;
            if (!date) return;
            
            // Display roster for specific date in modal
            let content = `<h3><i class="fas fa-calendar-day"></i> Duty for ${date}</h3>`;
            
            if (dutyRoster[date]) {
                content += '<div class="table-container"><table><thead><tr><th>Staff</th><th>Duty Time</th></tr></thead><tbody>';
                
                for (const [username, dutyTime] of Object.entries(dutyRoster[date])) {
                    const user = allUsers.find(u => u.username === username);
                    if (user) {
                        const cellClass = getDutyTimeClass(dutyTime);
                        content += `<tr>
                            <td>${user.name}</td>
                            <td class="${cellClass}">${dutyTime}</td>
                        </tr>`;
                    }
                }
                
                content += '</tbody></table></div>';
            } else {
                content += '<p>No duties scheduled for this date.</p>';
            }
            
            showModal(content);
        }

        // Mobile-optimized functions continuation

// Initialize the app after Firebase is ready
function initApp() {
    // Setup event listeners
    setupEventListeners();
    
    // Setup mobile-specific features
    if (isMobile) {
        setupMobileDatePickers();
        setupMobileForms();
        setupTouchGestures();
        
        // Prevent zoom on double tap
        document.addEventListener('dblclick', function(e) {
            e.preventDefault();
        }, { passive: false });
        
        // Better touch handling for buttons
        document.querySelectorAll('.btn, .action-btn, .nav-btn').forEach(btn => {
            btn.style.cursor = 'pointer';
            btn.addEventListener('touchstart', function() {
                this.style.opacity = '0.8';
            });
            btn.addEventListener('touchend', function() {
                this.style.opacity = '1';
            });
        });
    }
    
    // Check if user is already logged in (from localStorage)
    const savedUser = localStorage.getItem('dutyUser');
    if (savedUser) {
        try {
            const userData = JSON.parse(savedUser);
            loginUser(userData);
        } catch (e) {
            localStorage.removeItem('dutyUser');
        }
    }
}

// Setup event listeners
function setupEventListeners() {
    // Login form
    document.getElementById('loginForm').addEventListener('submit', function(e) {
        e.preventDefault();
        handleLogin();
    });
    
    // Logout button
    document.getElementById('logoutBtn').addEventListener('click', handleLogout);
    
    // Navigation buttons
    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const section = this.dataset.section;
            showSection(section);
        });
    });
    
    // Mobile nav items
    document.querySelectorAll('.mobile-nav-item').forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const section = this.dataset.section;
            showMobileSection(section);
        });
    });
    
    // Search input
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            handleSearch(this.value);
        });
    }
}

// Handle login
async function handleLogin() {
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value.trim();
    
    if (!username || !password) {
        showError('Please enter both username and password');
        return;
    }
    
    // Show loading state on mobile
    if (isMobile) {
        const loginBtn = document.getElementById('loginBtn');
        const originalHtml = loginBtn.innerHTML;
        loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Authenticating...';
        loginBtn.disabled = true;
    }
    
    try {
        // Hash the password for comparison
        const hashedPassword = sha256(password);
        
        // Find user in the users array
        const user = users.find(u => u.username === username && u.password === hashedPassword);
        
        if (!user) {
            showError('Invalid username or password');
            return;
        }
        
        // Login successful
        loginUser(user);
        
    } catch (error) {
        console.error('Login error:', error);
        showError('Login failed. Please try again.');
    } finally {
        // Restore button state
        if (isMobile) {
            setTimeout(() => {
                const loginBtn = document.getElementById('loginBtn');
                loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Login';
                loginBtn.disabled = false;
            }, 1000);
        }
    }
}

// Show error message
function showError(message) {
    const errorDiv = document.getElementById('errorMessage');
    errorDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
    errorDiv.style.display = 'block';
    
    // Vibrate on mobile if supported
    if (isMobile && 'vibrate' in navigator) {
        navigator.vibrate([100, 50, 100]);
    }
}

// Clear error message
function clearError() {
    document.getElementById('errorMessage').style.display = 'none';
}

// Login user
function loginUser(userData) {
    currentUser = userData;
    
    // Save user to localStorage
    localStorage.setItem('dutyUser', JSON.stringify(userData));
    
    // Update UI
    document.getElementById('userName').textContent = userData.name;
    document.getElementById('userRC').textContent = userData.RCNo;
    document.getElementById('userLevel').textContent = userData.Level;
    document.getElementById('welcomeName').textContent = userData.name.split(' ')[0];
    
    // Show dashboard
    document.getElementById('loginContainer').style.display = 'none';
    document.getElementById('dashboardContainer').style.display = 'block';
    
    // Clear login form
    document.getElementById('username').value = '';
    document.getElementById('password').value = '';
    clearError();
    
    // Initialize data
    initializeData();
    
    // Show admin buttons if user is admin
    if (userData.Level === 'Admin') {
        document.querySelectorAll('[id$="Btn"]').forEach(btn => {
            btn.style.display = 'inline-block';
        });
    }
    
    // Show success message
    showToast(`Welcome back, ${userData.name.split(' ')[0]}!`);
}

// Handle logout
function handleLogout() {
    // Confirm logout on mobile
    if (isMobile) {
        showModal(`
            <div class="modal-header">
                <h3><i class="fas fa-sign-out-alt"></i> Confirm Logout</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <p>Are you sure you want to logout?</p>
            <div class="form-row" style="margin-top: 20px;">
                <button class="btn btn-danger" onclick="confirmLogout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
                <button class="btn btn-secondary" onclick="closeModal()">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        `);
    } else {
        confirmLogout();
    }
}

// Confirm logout
function confirmLogout() {
    currentUser = null;
    localStorage.removeItem('dutyUser');
    
    document.getElementById('loginContainer').style.display = 'block';
    document.getElementById('dashboardContainer').style.display = 'none';
    
    closeModal();
    showToast('Logged out successfully');
}

// Initialize all data
async function initializeData() {
    if (!firebaseReady) {
        showToast('Firebase not ready. Please refresh.');
        return;
    }
    
    try {
        // Show loading state on mobile
        if (isMobile) {
            showToast('Loading data...');
        }
        
        await Promise.all([
            loadAllUsers(),
            loadDutyRoster(),
            loadLeaveBalances(),
            loadAllRequests(),
            loadAnnouncements()
        ]);
        
        updateUserBalance();
        updatePendingCount();
        loadHomeAnnouncements();
        
        if (isMobile) {
            showToast('Data loaded successfully');
        }
        
    } catch (error) {
        console.error('Error initializing data:', error);
        showToast('Failed to load data. Please refresh.', 5000);
    }
}

// Load all users
async function loadAllUsers() {
    try {
        // If users array is already loaded from user.js, use it
        if (users && users.length > 0) {
            allUsers = users;
            
            // Create display name map
            userDisplayNameMap = {};
            users.forEach(user => {
                userDisplayNameMap[user.username] = user.name;
            });
            
            return;
        }
        
        // Fallback: Try to load from Firestore
        const snapshot = await db.collection('users').get();
        allUsers = [];
        snapshot.forEach(doc => {
            const user = doc.data();
            user.id = doc.id;
            allUsers.push(user);
            userDisplayNameMap[user.username] = user.name;
        });
        
    } catch (error) {
        console.error('Error loading users:', error);
        showToast('Error loading user data');
    }
}

// Load duty roster
async function loadDutyRoster() {
    try {
        const snapshot = await db.collection('dutyRoster').orderBy('date').get();
        dutyRoster = {};
        snapshot.forEach(doc => {
            const data = doc.data();
            dutyRoster[data.date] = data.roster || {};
        });
        
        // Update today's duty and next duty
        updateTodaysDuty();
        
    } catch (error) {
        console.error('Error loading duty roster:', error);
        showToast('Error loading duty roster');
    }
}

// Load leave balances
async function loadLeaveBalances() {
    try {
        const snapshot = await db.collection('leaveBalances').get();
        leaveBalances = {};
        snapshot.forEach(doc => {
            const data = doc.data();
            leaveBalances[data.username] = {
                sickLeave: data.sickLeave || 0,
                frl: data.frl || 0
            };
        });
        
    } catch (error) {
        console.error('Error loading leave balances:', error);
        showToast('Error loading leave balances');
    }
}

// Load all requests
async function loadAllRequests() {
    try {
        const snapshot = await db.collection('requests').orderBy('timestamp', 'desc').get();
        allRequests = [];
        snapshot.forEach(doc => {
            const data = doc.data();
            data.id = doc.id;
            allRequests.push(data);
        });
        
        updatePendingCount();
        
    } catch (error) {
        console.error('Error loading requests:', error);
        showToast('Error loading requests');
    }
}

// Load announcements
async function loadAnnouncements() {
    try {
        const snapshot = await db.collection('announcements')
            .orderBy('timestamp', 'desc')
            .limit(10)
            .get();
        
        announcements = [];
        snapshot.forEach(doc => {
            const data = doc.data();
            data.id = doc.id;
            announcements.push(data);
        });
        
    } catch (error) {
        console.error('Error loading announcements:', error);
        showToast('Error loading announcements');
    }
}

// Update user balance display
function updateUserBalance() {
    if (!currentUser || !leaveBalances[currentUser.username]) return;
    
    const balance = leaveBalances[currentUser.username];
    document.getElementById('slBalance').textContent = balance.sickLeave;
    document.getElementById('frlBalance').textContent = balance.frl;
}

// Update today's duty display
function updateTodaysDuty() {
    if (!currentUser || !dutyRoster) return;
    
    const today = new Date().toISOString().split('T')[0];
    const todayDuty = dutyRoster[today] ? dutyRoster[today][currentUser.username] : null;
    
    document.getElementById('todayDutyTime').textContent = todayDuty || 'Off';
    if (todayDuty && todayDuty !== 'Off') {
        document.getElementById('todayDutyTime').className = getDutyTimeClass(todayDuty);
    }
    
    // Find next duty
    let nextDutyDate = null;
    let nextDutyTime = null;
    
    for (const date in dutyRoster) {
        if (date > today && dutyRoster[date][currentUser.username] && dutyRoster[date][currentUser.username] !== 'Off') {
            nextDutyDate = date;
            nextDutyTime = dutyRoster[date][currentUser.username];
            break;
        }
    }
    
    if (nextDutyDate && nextDutyTime) {
        const nextDate = new Date(nextDutyDate);
        const formattedDate = nextDate.toLocaleDateString('en-US', { 
            weekday: 'short', 
            month: 'short', 
            day: 'numeric' 
        });
        document.getElementById('nextDutyTime').textContent = `${nextDutyTime} on ${formattedDate}`;
        document.getElementById('nextDutyTime').className = getDutyTimeClass(nextDutyTime);
    } else {
        document.getElementById('nextDutyTime').textContent = 'No upcoming duty';
    }
}

// Get duty time CSS class
function getDutyTimeClass(dutyTime) {
    if (!dutyTime || dutyTime === 'Off') return 'off-duty';
    
    const baseClass = 'duty-';
    const timeMap = {
        '0730-1530': '0730-1530',
        '0830-1630': '0830-1630',
        '1030-1830': '1030-1830',
        '1530-2330': '1530-2330',
        '1630-0030': '1630-0030',
        '1730-0130': '1730-0130',
        '0030-0830': '0030-0830'
    };
    
    return baseClass + (timeMap[dutyTime] || dutyTime.replace(/[^a-zA-Z0-9]/g, '-'));
}

// Update pending count
function updatePendingCount() {
    if (!currentUser) return;
    
    let pendingCount = 0;
    let historyNotification = false;
    
    if (currentUser.Level === 'Admin') {
        pendingCount = allRequests.filter(req => req.status === 'pending').length;
        
        // Check for new requests in last 24 hours
        const twentyFourHoursAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
        historyNotification = allRequests.some(req => 
            req.status !== 'pending' && 
            new Date(req.timestamp) > twentyFourHoursAgo
        );
    } else {
        pendingCount = allRequests.filter(req => 
            req.fromUsername === currentUser.username && 
            req.status === 'pending'
        ).length;
    }
    
    // Update pending count badge
    const pendingElement = document.getElementById('pendingCount');
    if (pendingElement) {
        pendingElement.textContent = pendingCount;
        pendingElement.style.display = pendingCount > 0 ? 'inline' : 'none';
    }
    
    // Update mobile badge
    const mobileBadge = document.getElementById('mobileRequestBadge');
    if (mobileBadge) {
        if (pendingCount > 0) {
            mobileBadge.textContent = pendingCount;
            mobileBadge.style.display = 'block';
        } else {
            mobileBadge.style.display = 'none';
        }
    }
    
    // Update history notification dot
    const historyDot = document.getElementById('historyNotification');
    if (historyDot) {
        historyDot.style.display = historyNotification ? 'inline' : 'none';
    }
}

// Load home announcements
function loadHomeAnnouncements() {
    const container = document.getElementById('homeAnnouncements');
    if (!container) return;
    
    container.innerHTML = '';
    
    // Show only recent announcements (last 3)
    const recentAnnouncements = announcements.slice(0, 3);
    
    if (recentAnnouncements.length === 0) {
        container.innerHTML = `
            <div class="announcement-banner priority-low">
                <h4><i class="fas fa-bullhorn"></i> No Announcements</h4>
                <p>Check back later for updates.</p>
            </div>
        `;
        return;
    }
    
    recentAnnouncements.forEach(announcement => {
        const banner = document.createElement('div');
        banner.className = `announcement-banner priority-${announcement.priority || 'medium'}`;
        
        const timeAgo = getTimeAgo(announcement.timestamp);
        
        banner.innerHTML = `
            <h4><i class="fas fa-${announcement.priority === 'high' ? 'exclamation-triangle' : 'bullhorn'}"></i> 
                ${announcement.title}
            </h4>
            <p>${announcement.message}</p>
            <small><i class="far fa-clock"></i> ${timeAgo} by ${announcement.postedBy || 'Admin'}</small>
        `;
        
        container.appendChild(banner);
    });
}

// Get time ago string
function getTimeAgo(timestamp) {
    if (!timestamp) return 'Recently';
    
    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
    const now = new Date();
    const seconds = Math.floor((now - date) / 1000);
    
    if (seconds < 60) return 'Just now';
    
    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return `${minutes}m ago`;
    
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return `${hours}h ago`;
    
    const days = Math.floor(hours / 24);
    if (days < 30) return `${days}d ago`;
    
    return date.toLocaleDateString();
}

// Load section data
function loadSectionData(sectionId) {
    // Close mobile menu if open
    closeMobileMenu();
    
    // Scroll to top
    window.scrollTo(0, 0);
    
    // Load appropriate data
    switch(sectionId) {
        case 'home':
            loadHomeAnnouncements();
            updateTodaysDuty();
            break;
        case 'dutyChange':
            loadDutyChangeForm();
            break;
        case 'leaveApplication':
            loadLeaveForm();
            break;
        case 'myRequests':
            loadMyRequests();
            break;
        case 'viewMyRoster':
            loadMyRoster();
            break;
        case 'viewAllRoster':
            loadAllRoster();
            break;
        case 'pendingRequests':
            loadPendingRequests();
            break;
        case 'adminAnnouncements':
            loadAnnouncementsAdmin();
            break;
        case 'adminDutyRoster':
            loadDutyRosterAdmin();
            break;
        case 'adminLeaveBalance':
            loadLeaveBalanceAdmin();
            break;
        case 'adminApprovals':
            loadAdminApprovals();
            break;
        case 'adminRequestHistory':
            loadAdminRequestHistory();
            break;
    }
}

// Load duty change form
function loadDutyChangeForm() {
    const container = document.getElementById('dutyChangeSection');
    if (!container) return;
    
    const today = new Date().toISOString().split('T')[0];
    
    // Get user's upcoming duties
    const userDuties = [];
    for (const date in dutyRoster) {
        if (date >= today && dutyRoster[date][currentUser.username] && dutyRoster[date][currentUser.username] !== 'Off') {
            userDuties.push({
                date: date,
                duty: dutyRoster[date][currentUser.username]
            });
        }
    }
    
    // Sort by date
    userDuties.sort((a, b) => a.date.localeCompare(b.date));
    
    let dutyOptions = '';
    userDuties.forEach(duty => {
        const formattedDate = new Date(duty.date).toLocaleDateString('en-US', { 
            weekday: 'short', 
            month: 'short', 
            day: 'numeric' 
        });
        dutyOptions += `<option value="${duty.date}">${formattedDate} - ${duty.duty}</option>`;
    });
    
    // Get other users for exchange
    let userOptions = '<option value="">Select user</option>';
    allUsers.forEach(user => {
        if (user.username !== currentUser.username && user.Level === 'User') {
            userOptions += `<option value="${user.username}">${user.name} (RC: ${user.RCNo})</option>`;
        }
    });
    
    container.innerHTML = `
        <div class="card">
            <h3><i class="fas fa-exchange-alt"></i> Request Duty Change</h3>
            <form id="dutyChangeForm" onsubmit="submitDutyChange(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label for="changeDate"><i class="far fa-calendar-alt"></i> Select Your Duty Date</label>
                        <select id="changeDate" class="form-control" required>
                            <option value="">Select date</option>
                            ${dutyOptions}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="exchangeWith"><i class="fas fa-user-friends"></i> Exchange With</label>
                        <select id="exchangeWith" class="form-control" required>
                            ${userOptions}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="exchangeDate"><i class="far fa-calendar-alt"></i> Select Their Duty Date</label>
                        <select id="exchangeDate" class="form-control" disabled>
                            <option value="">Select user first</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="changeReason"><i class="fas fa-comment-alt"></i> Reason for Change</label>
                    <textarea id="changeReason" class="form-control" rows="3" placeholder="Enter reason for duty change..." required></textarea>
                </div>
                
                <div class="form-row">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane"></i> Submit Request
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="showSection('home')">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </form>
            
            <div class="alert alert-info" style="margin-top: 20px;">
                <h4><i class="fas fa-info-circle"></i> Instructions</h4>
                <ul>
                    <li>Select your duty date from the list of upcoming duties</li>
                    <li>Choose the person you want to exchange with</li>
                    <li>Select one of their duty dates</li>
                    <li>Provide a reason for the change</li>
                    <li>Submit for approval</li>
                </ul>
            </div>
        </div>
    `;
    
    // Setup event listeners for the form
    document.getElementById('exchangeWith').addEventListener('change', function() {
        updateExchangeDateOptions(this.value);
    });
}

// Update exchange date options
function updateExchangeDateOptions(username) {
    if (!username) return;
    
    const select = document.getElementById('exchangeDate');
    select.disabled = false;
    
    const today = new Date().toISOString().split('T')[0];
    const userDuties = [];
    
    for (const date in dutyRoster) {
        if (date >= today && dutyRoster[date][username] && dutyRoster[date][username] !== 'Off') {
            userDuties.push({
                date: date,
                duty: dutyRoster[date][username]
            });
        }
    }
    
    // Sort by date
    userDuties.sort((a, b) => a.date.localeCompare(b.date));
    
    let options = '<option value="">Select date</option>';
    userDuties.forEach(duty => {
        const formattedDate = new Date(duty.date).toLocaleDateString('en-US', { 
            weekday: 'short', 
            month: 'short', 
            day: 'numeric' 
        });
        options += `<option value="${duty.date}">${formattedDate} - ${duty.duty}</option>`;
    });
    
    select.innerHTML = options;
}

// Submit duty change request
async function submitDutyChange(event) {
    event.preventDefault();
    
    if (!currentUser) return;
    
    const changeDate = document.getElementById('changeDate').value;
    const exchangeWith = document.getElementById('exchangeWith').value;
    const exchangeDate = document.getElementById('exchangeDate').value;
    const reason = document.getElementById('changeReason').value.trim();
    
    if (!changeDate || !exchangeWith || !exchangeDate || !reason) {
        showToast('Please fill in all fields');
        return;
    }
    
    // Check if dates are different
    if (changeDate === exchangeDate) {
        showToast('Cannot exchange duty on the same date');
        return;
    }
    
    // Check if exchange partner has duty on the selected date
    if (!dutyRoster[exchangeDate] || !dutyRoster[exchangeDate][exchangeWith]) {
        showToast('Selected user does not have duty on that date');
        return;
    }
    
    // Check if exchange partner has duty on the current user's date
    if (!dutyRoster[changeDate] || !dutyRoster[changeDate][currentUser.username]) {
        showToast('You do not have duty on the selected date');
        return;
    }
    
    // Create request object
    const request = {
        type: 'dutyChange',
        fromUsername: currentUser.username,
        fromName: currentUser.name,
        toUsername: exchangeWith,
        toName: userDisplayNameMap[exchangeWith],
        changeDate: changeDate,
        exchangeDate: exchangeDate,
        currentDuty: dutyRoster[changeDate][currentUser.username],
        requestedDuty: dutyRoster[exchangeDate][exchangeWith],
        reason: reason,
        status: 'pending',
        timestamp: new Date(),
        adminAction: null,
        adminName: null,
        adminTimestamp: null
    };
    
    // Show loading on mobile
    if (isMobile) {
        const submitBtn = event.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
        submitBtn.disabled = true;
    }
    
    try {
        // Save to Firestore
        await db.collection('requests').add(request);
        
        // Refresh requests
        await loadAllRequests();
        
        // Show success
        showToast('Duty change request submitted successfully!');
        
        // Clear form
        event.target.reset();
        document.getElementById('exchangeDate').disabled = true;
        document.getElementById('exchangeDate').innerHTML = '<option value="">Select user first</option>';
        
        // Navigate to my requests
        showSection('myRequests');
        
    } catch (error) {
        console.error('Error submitting request:', error);
        showToast('Failed to submit request. Please try again.');
    } finally {
        // Restore button
        if (isMobile) {
            const submitBtn = event.target.querySelector('button[type="submit"]');
            submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Request';
            submitBtn.disabled = false;
        }
    }
}

// Load leave application form
function loadLeaveForm() {
    const container = document.getElementById('leaveApplicationSection');
    if (!container || !currentUser) return;
    
    const balance = leaveBalances[currentUser.username] || { sickLeave: 0, frl: 0 };
    
    container.innerHTML = `
        <div class="card">
            <h3><i class="fas fa-calendar-times"></i> Apply for Leave</h3>
            
            <div class="balance-display" style="margin-bottom: 20px;">
                <div class="balance-box">
                    <div class="balance-label">Available Sick Leave</div>
                    <div class="balance-value">${balance.sickLeave}</div>
                    <div class="balance-label">Days</div>
                </div>
                <div class="balance-box">
                    <div class="balance-label">Available FRL</div>
                    <div class="balance-value">${balance.frl}</div>
                    <div class="balance-label">Days</div>
                </div>
            </div>
            
            <form id="leaveForm" onsubmit="submitLeaveApplication(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label for="leaveType"><i class="fas fa-file-medical-alt"></i> Leave Type</label>
                        <select id="leaveType" class="form-control" required>
                            <option value="">Select type</option>
                            <option value="Sick Leave">Sick Leave</option>
                            <option value="FRL">Flexible Rest Leave (FRL)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="leaveDate"><i class="far fa-calendar-alt"></i> Leave Date</label>
                        <input type="date" id="leaveDate" class="form-control" required 
                               min="${new Date().toISOString().split('T')[0]}">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="leaveReason"><i class="fas fa-comment-alt"></i> Reason for Leave</label>
                    <textarea id="leaveReason" class="form-control" rows="3" placeholder="Enter reason for leave..." required></textarea>
                </div>
                
                <div class="form-group" id="medicalCertSection" style="display: none;">
                    <label for="medicalCert"><i class="fas fa-file-medical"></i> Medical Certificate</label>
                    <div class="form-check">
                        <input type="checkbox" id="medicalCert" class="form-check-input">
                        <label class="form-check-label" for="medicalCert">
                            I have a medical certificate (required for sick leave exceeding 2 days)
                        </label>
                    </div>
                </div>
                
                <div class="form-row">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane"></i> Submit Application
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="showSection('home')">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </form>
            
            <div class="alert alert-info" style="margin-top: 20px;">
                <h4><i class="fas fa-info-circle"></i> Leave Policy</h4>
                <ul>
                    <li><strong>Sick Leave:</strong> Requires medical certificate for leaves exceeding 2 consecutive days</li>
                    <li><strong>FRL:</strong> Flexible rest leave - apply at least 3 days in advance</li>
                    <li>All leaves require supervisor approval</li>
                    <li>Check your balance before applying</li>
                </ul>
            </div>
        </div>
    `;
    
    // Show/hide medical cert section based on leave type
    document.getElementById('leaveType').addEventListener('change', function() {
        const medicalCertSection = document.getElementById('medicalCertSection');
        medicalCertSection.style.display = this.value === 'Sick Leave' ? 'block' : 'none';
    });
}

// Submit leave application
async function submitLeaveApplication(event) {
    event.preventDefault();
    
    if (!currentUser) return;
    
    const leaveType = document.getElementById('leaveType').value;
    const leaveDate = document.getElementById('leaveDate').value;
    const reason = document.getElementById('leaveReason').value.trim();
    const hasMedicalCert = document.getElementById('medicalCert') ? document.getElementById('medicalCert').checked : false;
    
    if (!leaveType || !leaveDate || !reason) {
        showToast('Please fill in all required fields');
        return;
    }
    
    // Check if date is in the future
    const today = new Date().toISOString().split('T')[0];
    if (leaveDate < today) {
        showToast('Leave date must be in the future');
        return;
    }
    
    // Check leave balance
    const balance = leaveBalances[currentUser.username] || { sickLeave: 0, frl: 0 };
    if (leaveType === 'Sick Leave' && balance.sickLeave <= 0) {
        showToast('Insufficient sick leave balance');
        return;
    }
    if (leaveType === 'FRL' && balance.frl <= 0) {
        showToast('Insufficient FRL balance');
        return;
    }
    
    // Check if already has duty on that date
    if (dutyRoster[leaveDate] && dutyRoster[leaveDate][currentUser.username] && dutyRoster[leaveDate][currentUser.username] !== 'Off') {
        showToast('You have duty on the selected date. Please request duty change first.');
        return;
    }
    
    // Check if leave already applied for this date
    const existingLeave = allRequests.find(req => 
        req.fromUsername === currentUser.username &&
        req.type === 'leave' &&
        req.date === leaveDate &&
        req.status === 'pending'
    );
    
    if (existingLeave) {
        showToast('You already have a pending leave request for this date');
        return;
    }
    
    // Create request object
    const request = {
        type: 'leave',
        leaveType: leaveType,
        fromUsername: currentUser.username,
        fromName: currentUser.name,
        date: leaveDate,
        reason: reason,
        hasMedicalCert: hasMedicalCert,
        status: 'pending',
        timestamp: new Date(),
        adminAction: null,
        adminName: null,
        adminTimestamp: null
    };
    
    // Show loading on mobile
    if (isMobile) {
        const submitBtn = event.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
        submitBtn.disabled = true;
    }
    
    try {
        // Save to Firestore
        await db.collection('requests').add(request);
        
        // Refresh requests
        await loadAllRequests();
        
        // Show success
        showToast('Leave application submitted successfully!');
        
        // Clear form
        event.target.reset();
        document.getElementById('medicalCertSection').style.display = 'none';
        
        // Navigate to my requests
        showSection('myRequests');
        
    } catch (error) {
        console.error('Error submitting leave application:', error);
        showToast('Failed to submit application. Please try again.');
    } finally {
        // Restore button
        if (isMobile) {
            const submitBtn = event.target.querySelector('button[type="submit"]');
            submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Application';
            submitBtn.disabled = false;
        }
    }
}

// Load my requests
function loadMyRequests() {
    const container = document.getElementById('myRequestsSection');
    if (!container || !currentUser) return;
    
    const userRequests = allRequests.filter(req => req.fromUsername === currentUser.username);
    
    if (userRequests.length === 0) {
        container.innerHTML = `
            <div class="card">
                <h3><i class="fas fa-list-alt"></i> My Requests</h3>
                <div class="empty-state">
                    <i class="far fa-folder-open"></i>
                    <h4>No Requests Found</h4>
                    <p>You haven't submitted any requests yet.</p>
                    <button class="btn btn-primary" onclick="showSection('dutyChange')">
                        <i class="fas fa-exchange-alt"></i> Request Duty Change
                    </button>
                    <button class="btn btn-success" onclick="showSection('leaveApplication')" style="margin-left: 10px;">
                        <i class="fas fa-calendar-times"></i> Apply for Leave
                    </button>
                </div>
            </div>
        `;
        return;
    }
    
    let html = `
        <div class="card">
            <h3><i class="fas fa-list-alt"></i> My Requests</h3>
            
            <div class="tab-controls">
                <button class="tab-btn active" onclick="filterMyRequests('all')">All (${userRequests.length})</button>
                <button class="tab-btn" onclick="filterMyRequests('pending')">Pending (${userRequests.filter(r => r.status === 'pending').length})</button>
                <button class="tab-btn" onclick="filterMyRequests('approved')">Approved (${userRequests.filter(r => r.status === 'approved').length})</button>
                <button class="tab-btn" onclick="filterMyRequests('rejected')">Rejected (${userRequests.filter(r => r.status === 'rejected').length})</button>
            </div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Details</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="myRequestsTable">
    `;
    
    // Sort by timestamp (newest first)
    userRequests.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    
    userRequests.forEach(request => {
        const date = new Date(request.timestamp).toLocaleDateString();
        const time = new Date(request.timestamp).toLocaleTimeString();
        
        let details = '';
        if (request.type === 'dutyChange') {
            details = `Exchange ${request.changeDate} (${request.currentDuty}) with ${request.toName} on ${request.exchangeDate} (${request.requestedDuty})`;
        } else if (request.type === 'leave') {
            details = `${request.leaveType} on ${request.date}: ${request.reason}`;
        }
        
        let statusClass = 'status-' + request.status;
        let statusText = request.status.charAt(0).toUpperCase() + request.status.slice(1);
        
        if (request.status === 'approved' || request.status === 'rejected') {
            statusText += ` by ${request.adminName}`;
        }
        
        html += `
            <tr class="swipe-item">
                <td>${date}<br><small>${time}</small></td>
                <td>${request.type === 'dutyChange' ? 'Duty Change' : 'Leave'}</td>
                <td>${details}</td>
                <td><span class="status-indicator ${statusClass}">${statusText}</span></td>
                <td class="action-buttons">
                    <button class="action-btn btn-danger" onclick="deleteRequest('${request.id}')" ${request.status !== 'pending' ? 'disabled' : ''}>
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </td>
            </tr>
        `;
    });
    
    html += `
                    </tbody>
                </table>
            </div>
            
            <div class="swipe-hint mobile-only">
                <i class="fas fa-hand-point-left"></i> Swipe left on requests for actions
            </div>
        </div>
    `;
    
    container.innerHTML = html;
    makeTablesResponsive();
}

// Filter my requests
function filterMyRequests(filter) {
    const rows = document.querySelectorAll('#myRequestsTable tr');
    const tabs = document.querySelectorAll('.tab-btn');
    
    // Update active tab
    tabs.forEach(tab => tab.classList.remove('active'));
    event.target.classList.add('active');
    
    rows.forEach(row => {
        const statusCell = row.querySelector('.status-indicator');
        if (!statusCell) return;
        
        const status = statusCell.className.includes('pending') ? 'pending' :
                      statusCell.className.includes('approved') ? 'approved' :
                      statusCell.className.includes('rejected') ? 'rejected' : '';
        
        if (filter === 'all' || status === filter) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

// Delete request
async function deleteRequest(requestId) {
    // Confirm deletion on mobile
    if (isMobile) {
        showModal(`
            <div class="modal-header">
                <h3><i class="fas fa-trash-alt"></i> Confirm Delete</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <p>Are you sure you want to delete this request?</p>
            <p><small>This action cannot be undone.</small></p>
            <div class="form-row" style="margin-top: 20px;">
                <button class="btn btn-danger" onclick="confirmDeleteRequest('${requestId}')">
                    <i class="fas fa-trash"></i> Delete
                </button>
                <button class="btn btn-secondary" onclick="closeModal()">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        `);
    } else {
        if (confirm('Are you sure you want to delete this request?')) {
            confirmDeleteRequest(requestId);
        }
    }
}

async function confirmDeleteRequest(requestId) {
    try {
        await db.collection('requests').doc(requestId).delete();
        
        // Refresh requests
        await loadAllRequests();
        
        // Reload my requests display
        loadMyRequests();
        
        closeModal();
        showToast('Request deleted successfully');
        
    } catch (error) {
        console.error('Error deleting request:', error);
        showToast('Failed to delete request');
    }
}

// Load my roster
function loadMyRoster() {
    const container = document.getElementById('viewMyRosterSection');
    if (!container || !currentUser) return;
    
    const today = new Date().toISOString().split('T')[0];
    const next30Days = new Date();
    next30Days.setDate(next30Days.getDate() + 30);
    const endDate = next30Days.toISOString().split('T')[0];
    
    // Get user's duties for next 30 days
    const userDuties = [];
    for (const date in dutyRoster) {
        if (date >= today && date <= endDate && dutyRoster[date][currentUser.username]) {
            userDuties.push({
                date: date,
                duty: dutyRoster[date][currentUser.username],
                isLeave: isLeaveDate(date, currentUser.username)
            });
        }
    }
    
    // Sort by date
    userDuties.sort((a, b) => a.date.localeCompare(b.date));
    
    if (userDuties.length === 0) {
        container.innerHTML = `
            <div class="card">
                <h3><i class="fas fa-calendar-check"></i> My Roster</h3>
                <div class="empty-state">
                    <i class="far fa-calendar"></i>
                    <h4>No Duties Scheduled</h4>
                    <p>You don't have any duties scheduled for the next 30 days.</p>
                </div>
            </div>
        `;
        return;
    }
    
    let html = `
        <div class="card">
            <h3><i class="fas fa-calendar-check"></i> My Roster (Next 30 Days)</h3>
            
            <div class="form-row">
                <input type="date" class="form-control" id="rosterSearchDate" 
                       value="${today}" min="${today}" max="${endDate}">
                <button class="btn btn-primary" onclick="searchRosterByDate()">
                    <i class="fas fa-search"></i> Search Date
                </button>
            </div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Day</th>
                            <th>Duty Time</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
    `;
    
    userDuties.forEach(duty => {
        const date = new Date(duty.date);
        const dayName = date.toLocaleDateString('en-US', { weekday: 'long' });
        const formattedDate = date.toLocaleDateString('en-US', { 
            month: 'short', 
            day: 'numeric',
            year: 'numeric'
        });
        
        const isToday = duty.date === today;
        const cellClass = duty.isLeave ? 'duty-leave' : getDutyTimeClass(duty.duty);
        
        let status = duty.isLeave ? 'On Leave' : (duty.duty === 'Off' ? 'Off Day' : 'Scheduled');
        let statusClass = duty.isLeave ? 'status-rejected' : 
                         (duty.duty === 'Off' ? 'status-off' : 'status-approved');
        
        html += `
            <tr ${isToday ? 'style="background-color: #fff3cd;"' : ''}>
                <td>${formattedDate}${isToday ? ' <strong>(Today)</strong>' : ''}</td>
                <td>${dayName}</td>
                <td class="${cellClass}">${duty.isLeave ? 'Leave' : duty.duty}</td>
                <td><span class="status-indicator ${statusClass}">${status}</span></td>
                <td class="action-buttons">
                    ${duty.duty !== 'Off' && !duty.isLeave ? `
                        <button class="action-btn btn-warning" onclick="requestChangeForDate('${duty.date}')">
                            <i class="fas fa-exchange-alt"></i> Change
                        </button>
                        <button class="action-btn btn-success" onclick="applyLeaveForDate('${duty.date}')">
                            <i class="fas fa-calendar-times"></i> Leave
                        </button>
                    ` : ''}
                </td>
            </tr>
        `;
    });
    
    html += `
                    </tbody>
                </table>
            </div>
            
            <div style="margin-top: 20px; text-align: center;">
                <button class="btn btn-primary" onclick="downloadMyRoster()">
                    <i class="fas fa-download"></i> Download as PDF
                </button>
                <button class="btn btn-secondary" onclick="printMyRoster()" style="margin-left: 10px;">
                    <i class="fas fa-print"></i> Print
                </button>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
    makeTablesResponsive();
}

// Check if date is a leave day for user
function isLeaveDate(date, username) {
    return allRequests.some(req => 
        req.fromUsername === username &&
        req.type === 'leave' &&
        req.date === date &&
        req.status === 'approved'
    );
}

// Request change for specific date
function requestChangeForDate(date) {
    // Navigate to duty change form and pre-select the date
    showSection('dutyChange');
    
    // Give time for form to load
    setTimeout(() => {
        const dateSelect = document.getElementById('changeDate');
        if (dateSelect) {
            dateSelect.value = date;
        }
    }, 500);
}

// Apply leave for specific date
function applyLeaveForDate(date) {
    // Navigate to leave form and pre-select the date
    showSection('leaveApplication');
    
    // Give time for form to load
    setTimeout(() => {
        const dateInput = document.getElementById('leaveDate');
        if (dateInput) {
            dateInput.value = date;
        }
    }, 500);
}

// Search roster by date
function searchRosterByDate() {
    const searchDate = document.getElementById('rosterSearchDate').value;
    if (!searchDate) return;
    
    const duty = dutyRoster[searchDate] ? dutyRoster[searchDate][currentUser.username] : null;
    const isLeave = isLeaveDate(searchDate, currentUser.username);
    
    const date = new Date(searchDate);
    const formattedDate = date.toLocaleDateString('en-US', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    });
    
    let content = `
        <div class="modal-header">
            <h3><i class="fas fa-calendar-day"></i> Duty for ${formattedDate}</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
    `;
    
    if (isLeave) {
        const leaveRequest = allRequests.find(req => 
            req.fromUsername === currentUser.username &&
            req.type === 'leave' &&
            req.date === searchDate &&
            req.status === 'approved'
        );
        
        content += `
            <div class="alert alert-success">
                <h4><i class="fas fa-umbrella-beach"></i> On Approved Leave</h4>
                <p><strong>Leave Type:</strong> ${leaveRequest.leaveType}</p>
                <p><strong>Reason:</strong> ${leaveRequest.reason}</p>
                <p><strong>Approved by:</strong> ${leaveRequest.adminName}</p>
            </div>
        `;
    } else if (duty && duty !== 'Off') {
        content += `
            <div class="alert alert-info">
                <h4><i class="fas fa-clock"></i> Scheduled Duty</h4>
                <p><strong>Duty Time:</strong> <span class="${getDutyTimeClass(duty)}">${duty}</span></p>
                <p>Please report 15 minutes before duty starts.</p>
            </div>
            
            <div class="form-row">
                <button class="btn btn-warning" onclick="requestChangeForDate('${searchDate}'); closeModal();">
                    <i class="fas fa-exchange-alt"></i> Request Change
                </button>
                <button class="btn btn-success" onclick="applyLeaveForDate('${searchDate}'); closeModal();">
                    <i class="fas fa-calendar-times"></i> Apply for Leave
                </button>
            </div>
        `;
    } else {
        content += `
            <div class="alert alert-success">
                <h4><i class="fas fa-bed"></i> Off Day</h4>
                <p>You are off duty on this date.</p>
                <p>Enjoy your rest day!</p>
            </div>
        `;
    }
    
    showModal(content);
}

// Download my roster as PDF
function downloadMyRoster() {
    showToast('PDF download feature coming soon!');
    // Implement PDF generation here
}

// Print my roster
function printMyRoster() {
    window.print();
}

// Load all roster view
function loadAllRoster() {
    const container = document.getElementById('viewAllRosterSection');
    if (!container) return;
    
    const today = new Date();
    const year = today.getFullYear();
    const month = today.getMonth() + 1;
    
    // Get start and end of current month
    const startDate = new Date(year, month - 1, 1);
    const endDate = new Date(year, month, 0);
    
    container.innerHTML = `
        <div class="card">
            <h3><i class="fas fa-calendar-alt"></i> All Staff Roster</h3>
            
            <div class="form-row">
                <input type="month" id="rosterMonth" class="form-control" 
                       value="${year}-${month.toString().padStart(2, '0')}">
                <button class="btn btn-primary" onclick="changeRosterMonth()">
                    <i class="fas fa-calendar"></i> View Month
                </button>
                <button class="btn btn-success" onclick="downloadFullRoster()">
                    <i class="fas fa-download"></i> Export
                </button>
            </div>
            
            <div id="rosterTableContainer">
                ${displayAllRosterTable(startDate, endDate, year, month)}
            </div>
            
            <div class="swipe-hint mobile-only">
                <i class="fas fa-hand-point-left"></i> Swipe left to view more staff
            </div>
        </div>
    `;
    
    makeTablesResponsive();
}

// Display all roster table
function displayAllRosterTable(startDate, endDate, year, month) {
    const today = new Date().toISOString().split('T')[0];
    const monthNames = ["January", "February", "March", "April", "May", "June",
                       "July", "August", "September", "October", "November", "December"];
    
    let html = `<h4><i class="fas fa-calendar-alt"></i> ${monthNames[month-1]} ${year} Roster</h4>`;
    
    // Mobile: Show date selector
    if (isMobile) {
        html += `
            <div class="form-row">
                <input type="date" class="form-control" id="mobileRosterDate" value="${today}">
                <button class="btn btn-primary" onclick="loadRosterForDate()">
                    <i class="fas fa-search"></i> Go
                </button>
            </div>
        `;
    }
    
    html += '<div class="table-container"><table><thead><tr><th>Date</th><th>Day</th>';
    
    // Get regular users only
    const regularUsers = allUsers.filter(u => u.Level === 'User');
    
    // Limit displayed staff on mobile
    const displayStaff = isMobile ? regularUsers.slice(0, 3) : regularUsers;
    
    displayStaff.forEach(user => {
        html += `<th class="staff-name">${user.name.substring(0, 8)}<br><small>${user.RCNo}</small></th>`;
    });
    
    if (isMobile && regularUsers.length > 3) {
        html += `<th><i class="fas fa-ellipsis-h"></i></th>`;
    }
    
    html += '</tr></thead><tbody>';
    
    // Display only next 14 days on mobile, full month on desktop
    const displayDays = isMobile ? 14 : Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
    
    for (let i = 0; i < displayDays; i++) {
        const d = new Date(startDate);
        d.setDate(d.getDate() + i);
        const dateStr = d.toISOString().split('T')[0];
        const dayName = d.toLocaleDateString('en-US', { weekday: 'short' });
        const isToday = dateStr === today;
        const isWeekend = d.getDay() === 0 || d.getDay() === 6;
        
        html += `<tr ${isToday ? 'style="background-color: #fff3cd;"' : ''} ${isWeekend ? 'class="weekend-row"' : ''}>`;
        html += `<td>${dateStr.substring(5)}${isToday ? ' <strong>(T)</strong>' : ''}</td>`;
        html += `<td>${dayName}</td>`;
        
        displayStaff.forEach(user => {
            let dutyTime = 'Off';
            let cellClass = 'off-day-cell';
            let leaveIndicator = '';
            
            // Check for approved leave
            const approvedLeave = allRequests.find(req => 
                req.fromUsername === user.username &&
                req.type === 'leave' &&
                req.status === 'approved' &&
                req.date === dateStr
            );
            
            if (approvedLeave) {
                dutyTime = 'L';
                cellClass = 'duty-leave';
                leaveIndicator = `<span class="leave-indicator">${approvedLeave.leaveType === 'Sick Leave' ? 'SL' : 'FRL'}</span>`;
            } else if (dutyRoster[dateStr] && dutyRoster[dateStr][user.username]) {
                dutyTime = dutyRoster[dateStr][user.username];
                cellClass = getDutyTimeClass(dutyTime);
                
                // Shorten time for mobile
                if (dutyTime !== 'Off' && isMobile) {
                    const timeParts = dutyTime.split('-');
                    if (timeParts.length === 2) {
                        dutyTime = timeParts[0].substring(0, 5);
                    }
                }
            }
            
            if (isToday) {
                cellClass += ' today-cell';
            }
            
            html += `<td class="${cellClass}" title="${dutyRoster[dateStr] && dutyRoster[dateStr][user.username] || 'Off'}">
                ${dutyTime} ${leaveIndicator}
            </td>`;
        });
        
        if (isMobile && regularUsers.length > 3) {
            html += `<td><i class="fas fa-ellipsis-h"></i></td>`;
        }
        
        html += '</tr>';
    }
    
    html += '</tbody></table></div>';
    
    if (isMobile) {
        html += `
            <div class="form-row" style="margin-top: 15px;">
                <button class="btn btn-primary" onclick="showFullRosterModal('${year}', '${month}')">
                    <i class="fas fa-expand-alt"></i> View Full Roster
                </button>
                <button class="btn btn-secondary" onclick="showSection('viewMyRoster')">
                    <i class="fas fa-user"></i> My Roster Only
                </button>
            </div>
        `;
    }
    
    return html;
}

// Change roster month
function changeRosterMonth() {
    const monthInput = document.getElementById('rosterMonth').value;
    if (!monthInput) return;
    
    const [year, month] = monthInput.split('-').map(Number);
    const startDate = new Date(year, month - 1, 1);
    const endDate = new Date(year, month, 0);
    
    const container = document.getElementById('rosterTableContainer');
    container.innerHTML = displayAllRosterTable(startDate, endDate, year, month);
    
    makeTablesResponsive();
}

// Show full roster in modal (mobile)
function showFullRosterModal(year, month) {
    const startDate = new Date(year, month - 1, 1);
    const endDate = new Date(year, month, 0);
    
    let content = `<div style="max-width: 100%; overflow-x: auto;">`;
    content += displayAllRosterTable(startDate, endDate, year, month);
    content += `</div>`;
    
    showModal(content);
}

// Load roster for specific date
function loadRosterForDate() {
    const date = document.getElementById('mobileRosterDate').value;
    if (!date) return;
    
    const d = new Date(date);
    const formattedDate = d.toLocaleDateString('en-US', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    });
    
    let content = `<h3><i class="fas fa-calendar-day"></i> Duty for ${formattedDate}</h3>`;
    
    if (dutyRoster[date]) {
        content += '<div class="table-container"><table><thead><tr><th>Staff</th><th>RC</th><th>Duty Time</th></tr></thead><tbody>';
        
        // Get all users with duties on this date
        const usersWithDuty = [];
        for (const username in dutyRoster[date]) {
            const user = allUsers.find(u => u.username === username);
            if (user) {
                usersWithDuty.push({
                    name: user.name,
                    rc: user.RCNo,
                    duty: dutyRoster[date][username]
                });
            }
        }
        
        // Sort by RC number
        usersWithDuty.sort((a, b) => a.rc.localeCompare(b.rc));
        
        usersWithDuty.forEach(user => {
            const cellClass = getDutyTimeClass(user.duty);
            const isLeave = isLeaveDate(date, allUsers.find(u => u.RCNo === user.rc)?.username);
            
            content += `<tr>
                <td>${user.name}</td>
                <td>${user.rc}</td>
                <td class="${cellClass}">${isLeave ? 'On Leave' : user.duty}</td>
            </tr>`;
        });
        
        content += '</tbody></table></div>';
    } else {
        content += '<p>No duties scheduled for this date.</p>';
    }
    
    showModal(content);
}

// Download full roster
function downloadFullRoster() {
    showToast('Export feature coming soon!');
    // Implement export functionality here
}

// Handle search
function handleSearch(query) {
    if (!query) return;
    
    // Search in announcements
    const announcementResults = announcements.filter(ann => 
        ann.title.toLowerCase().includes(query.toLowerCase()) ||
        ann.message.toLowerCase().includes(query.toLowerCase())
    );
    
    // Search in duty roster (simplified for mobile)
    const dateResults = [];
    const today = new Date().toISOString().split('T')[0];
    
    for (const date in dutyRoster) {
        if (date >= today && dutyRoster[date][currentUser.username]) {
            const duty = dutyRoster[date][currentUser.username];
            if (duty.toLowerCase().includes(query.toLowerCase()) || 
                date.includes(query)) {
                dateResults.push({ date, duty });
            }
        }
    }
    
    // Show results in modal
    let content = `<h3><i class="fas fa-search"></i> Search Results for "${query}"</h3>`;
    
    if (announcementResults.length > 0) {
        content += `<h4><i class="fas fa-bullhorn"></i> Announcements (${announcementResults.length})</h4>`;
        announcementResults.forEach(ann => {
            content += `
                <div class="announcement-banner priority-${ann.priority || 'medium'}" style="margin-bottom: 10px;">
                    <h5>${ann.title}</h5>
                    <p>${ann.message.substring(0, 100)}...</p>
                    <small>Posted: ${getTimeAgo(ann.timestamp)}</small>
                </div>
            `;
        });
    }
    
    if (dateResults.length > 0) {
        content += `<h4><i class="fas fa-calendar-alt"></i> Your Duties (${dateResults.length})</h4>`;
        content += '<div class="table-container"><table><thead><tr><th>Date</th><th>Duty</th></tr></thead><tbody>';
        
        dateResults.forEach(result => {
            const cellClass = getDutyTimeClass(result.duty);
            content += `<tr>
                <td>${result.date}</td>
                <td class="${cellClass}">${result.duty}</td>
            </tr>`;
        });
        
        content += '</tbody></table></div>';
    }
    
    if (announcementResults.length === 0 && dateResults.length === 0) {
        content += '<div class="empty-state"><i class="fas fa-search"></i><p>No results found</p></div>';
    }
    
    showModal(content);
}

// ADMIN FUNCTIONS (Mobile-optimized)

// Load pending requests (admin)
function loadPendingRequests() {
    if (!currentUser || currentUser.Level !== 'Admin') return;
    
    const container = document.getElementById('pendingRequestsSection');
    if (!container) return;
    
    const pendingRequests = allRequests.filter(req => req.status === 'pending');
    
    if (pendingRequests.length === 0) {
        container.innerHTML = `
            <div class="card">
                <h3><i class="fas fa-clock"></i> Pending Requests</h3>
                <div class="empty-state">
                    <i class="far fa-check-circle"></i>
                    <h4>All Caught Up!</h4>
                    <p>No pending requests to review.</p>
                </div>
            </div>
        `;
        return;
    }
    
    let html = `
        <div class="card">
            <h3><i class="fas fa-clock"></i> Pending Requests (${pendingRequests.length})</h3>
            
            <div class="tab-controls">
                <button class="tab-btn active" onclick="filterPendingRequests('all')">All (${pendingRequests.length})</button>
                <button class="tab-btn" onclick="filterPendingRequests('dutyChange')">Duty Changes (${pendingRequests.filter(r => r.type === 'dutyChange').length})</button>
                <button class="tab-btn" onclick="filterPendingRequests('leave')">Leaves (${pendingRequests.filter(r => r.type === 'leave').length})</button>
            </div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>From</th>
                            <th>Details</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="pendingRequestsTable">
    `;
    
    // Sort by timestamp (oldest first)
    pendingRequests.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
    
    pendingRequests.forEach(request => {
        const date = new Date(request.timestamp).toLocaleDateString();
        
        let details = '';
        if (request.type === 'dutyChange') {
            details = `Wants to exchange ${request.changeDate} (${request.currentDuty}) with ${request.toName} on ${request.exchangeDate} (${request.requestedDuty})`;
        } else if (request.type === 'leave') {
            details = `${request.leaveType} on ${request.date}: ${request.reason}`;
            if (request.hasMedicalCert) {
                details += ' <span class="badge badge-info">Medical Cert</span>';
            }
        }
        
        html += `
            <tr>
                <td>${date}</td>
                <td>${request.type === 'dutyChange' ? 'Duty Change' : 'Leave'}</td>
                <td>${request.fromName}</td>
                <td>${details}</td>
                <td class="action-buttons">
                    <button class="action-btn btn-success" onclick="approveRequest('${request.id}')">
                        <i class="fas fa-check"></i> Approve
                    </button>
                    <button class="action-btn btn-danger" onclick="rejectRequest('${request.id}')">
                        <i class="fas fa-times"></i> Reject
                    </button>
                    <button class="action-btn btn-info" onclick="viewRequestDetails('${request.id}')">
                        <i class="fas fa-eye"></i> View
                    </button>
                </td>
            </tr>
        `;
    });
    
    html += `
                    </tbody>
                </table>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
    makeTablesResponsive();
}

// Filter pending requests
function filterPendingRequests(filter) {
    const rows = document.querySelectorAll('#pendingRequestsTable tr');
    const tabs = document.querySelectorAll('.tab-btn');
    
    // Update active tab
    tabs.forEach(tab => tab.classList.remove('active'));
    event.target.classList.add('active');
    
    rows.forEach(row => {
        const typeCell = row.cells[1];
        if (!typeCell) return;
        
        const type = typeCell.textContent.includes('Duty Change') ? 'dutyChange' : 'leave';
        
        if (filter === 'all' || type === filter) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

// View request details
function viewRequestDetails(requestId) {
    const request = allRequests.find(r => r.id === requestId);
    if (!request) return;
    
    const requestDate = new Date(request.timestamp).toLocaleDateString('en-US', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
    
    let details = '';
    if (request.type === 'dutyChange') {
        details = `
            <p><strong>Current Duty:</strong> ${request.changeDate} (${request.currentDuty})</p>
            <p><strong>Exchange With:</strong> ${request.toName} (RC: ${allUsers.find(u => u.username === request.toUsername)?.RCNo || 'N/A'})</p>
            <p><strong>Requested Duty:</strong> ${request.exchangeDate} (${request.requestedDuty})</p>
            <p><strong>Reason:</strong> ${request.reason}</p>
        `;
    } else if (request.type === 'leave') {
        details = `
            <p><strong>Leave Type:</strong> ${request.leaveType}</p>
            <p><strong>Date:</strong> ${request.date}</p>
            <p><strong>Reason:</strong> ${request.reason}</p>
            <p><strong>Medical Certificate:</strong> ${request.hasMedicalCert ? 'Yes' : 'No'}</p>
        `;
    }
    
    const content = `
        <div class="modal-header">
            <h3><i class="fas fa-file-alt"></i> Request Details</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        
        <div class="request-details">
            <p><strong>Requested by:</strong> ${request.fromName} (RC: ${allUsers.find(u => u.username === request.fromUsername)?.RCNo || 'N/A'})</p>
            <p><strong>Submitted on:</strong> ${requestDate}</p>
            <p><strong>Type:</strong> ${request.type === 'dutyChange' ? 'Duty Change' : 'Leave Application'}</p>
            
            <hr>
            
            ${details}
            
            <hr>
            
            <div class="form-row">
                <button class="btn btn-success" onclick="approveRequest('${request.id}'); closeModal();">
                    <i class="fas fa-check"></i> Approve
                </button>
                <button class="btn btn-danger" onclick="rejectRequest('${request.id}'); closeModal();">
                    <i class="fas fa-times"></i> Reject
                </button>
                <button class="btn btn-secondary" onclick="closeModal()">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
    `;
    
    showModal(content);
}

// Approve request
async function approveRequest(requestId) {
    const request = allRequests.find(r => r.id === requestId);
    if (!request) return;
    
    // Confirm approval on mobile
    if (isMobile) {
        showModal(`
            <div class="modal-header">
                <h3><i class="fas fa-check-circle"></i> Confirm Approval</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <p>Are you sure you want to approve this request?</p>
            <div class="form-row" style="margin-top: 20px;">
                <button class="btn btn-success" onclick="confirmApproveRequest('${requestId}')">
                    <i class="fas fa-check"></i> Yes, Approve
                </button>
                <button class="btn btn-secondary" onclick="closeModal()">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        `);
    } else {
        if (confirm('Are you sure you want to approve this request?')) {
            confirmApproveRequest(requestId);
        }
    }
}

async function confirmApproveRequest(requestId) {
    const request = allRequests.find(r => r.id === requestId);
    if (!request || !currentUser) return;
    
    try {
        // Update request status
        await db.collection('requests').doc(requestId).update({
            status: 'approved',
            adminAction: 'approved',
            adminName: currentUser.name,
            adminTimestamp: new Date()
        });
        
        // Handle based on request type
        if (request.type === 'dutyChange') {
            // Swap duties in roster
            const batch = db.batch();
            
            // Get current duty roster documents
            const changeDateDoc = await db.collection('dutyRoster').where('date', '==', request.changeDate).get();
            const exchangeDateDoc = await db.collection('dutyRoster').where('date', '==', request.exchangeDate).get();
            
            if (!changeDateDoc.empty && !exchangeDateDoc.empty) {
                const changeDateId = changeDateDoc.docs[0].id;
                const exchangeDateId = exchangeDateDoc.docs[0].id;
                
                const changeDateData = changeDateDoc.docs[0].data();
                const exchangeDateData = exchangeDateDoc.docs[0].data();
                
                // Swap duties
                const tempDuty = changeDateData.roster[request.fromUsername];
                changeDateData.roster[request.fromUsername] = exchangeDateData.roster[request.toUsername];
                exchangeDateData.roster[request.toUsername] = tempDuty;
                
                // Update both documents
                batch.update(db.collection('dutyRoster').doc(changeDateId), {
                    roster: changeDateData.roster
                });
                
                batch.update(db.collection('dutyRoster').doc(exchangeDateId), {
                    roster: exchangeDateData.roster
                });
                
                await batch.commit();
            }
            
        } else if (request.type === 'leave') {
            // Update leave balance if approved
            const userBalanceRef = db.collection('leaveBalances').where('username', '==', request.fromUsername);
            const balanceSnapshot = await userBalanceRef.get();
            
            if (!balanceSnapshot.empty) {
                const balanceDoc = balanceSnapshot.docs[0];
                const currentBalance = balanceDoc.data();
                
                let newBalance = { ...currentBalance };
                
                if (request.leaveType === 'Sick Leave') {
                    newBalance.sickLeave = Math.max(0, (currentBalance.sickLeave || 0) - 1);
                } else if (request.leaveType === 'FRL') {
                    newBalance.frl = Math.max(0, (currentBalance.frl || 0) - 1);
                }
                
                await db.collection('leaveBalances').doc(balanceDoc.id).update(newBalance);
            }
        }
        
        // Refresh all data
        await Promise.all([
            loadDutyRoster(),
            loadLeaveBalances(),
            loadAllRequests()
        ]);
        
        // Reload the current section
        if (document.querySelector('.section.active').id === 'pendingRequestsSection') {
            loadPendingRequests();
        }
        
        closeModal();
        showToast('Request approved successfully!');
        
    } catch (error) {
        console.error('Error approving request:', error);
        showToast('Failed to approve request');
    }
}

// Reject request
async function rejectRequest(requestId) {
    const request = allRequests.find(r => r.id === requestId);
    if (!request) return;
    
    // Get rejection reason on mobile
    if (isMobile) {
        showModal(`
            <div class="modal-header">
                <h3><i class="fas fa-times-circle"></i> Reject Request</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="form-group">
                <label for="rejectionReason">Reason for Rejection</label>
                <textarea id="rejectionReason" class="form-control" rows="3" placeholder="Enter reason for rejection..."></textarea>
            </div>
            <div class="form-row" style="margin-top: 20px;">
                <button class="btn btn-danger" onclick="confirmRejectRequest('${requestId}')">
                    <i class="fas fa-times"></i> Reject
                </button>
                <button class="btn btn-secondary" onclick="closeModal()">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        `);
    } else {
        const reason = prompt('Enter reason for rejection:');
        if (reason !== null) {
            confirmRejectRequest(requestId, reason);
        }
    }
}

async function confirmRejectRequest(requestId, reason = '') {
    if (!currentUser) return;
    
    if (isMobile && !reason) {
        reason = document.getElementById('rejectionReason').value;
    }
    
    try {
        await db.collection('requests').doc(requestId).update({
            status: 'rejected',
            adminAction: 'rejected',
            adminName: currentUser.name,
            adminTimestamp: new Date(),
            rejectionReason: reason
        });
        
        // Refresh requests
        await loadAllRequests();
        
        // Reload the current section
        if (document.querySelector('.section.active').id === 'pendingRequestsSection') {
            loadPendingRequests();
        }
        
        closeModal();
        showToast('Request rejected');
        
    } catch (error) {
        console.error('Error rejecting request:', error);
        showToast('Failed to reject request');
    }
}

// Load admin announcements
function loadAnnouncementsAdmin() {
    if (!currentUser || currentUser.Level !== 'Admin') return;
    
    const container = document.getElementById('adminAnnouncementsSection');
    if (!container) return;
    
    container.innerHTML = `
        <div class="card">
            <h3><i class="fas fa-bullhorn"></i> Manage Announcements</h3>
            
            <div class="form-row">
                <button class="btn btn-primary" onclick="showNewAnnouncementForm()">
                    <i class="fas fa-plus"></i> New Announcement
                </button>
            </div>
            
            <div id="announcementsList">
                ${displayAnnouncementsList()}
            </div>
        </div>
    `;
}

// Display announcements list
function displayAnnouncementsList() {
    if (announcements.length === 0) {
        return '<div class="empty-state"><i class="far fa-newspaper"></i><p>No announcements yet</p></div>';
    }
    
    let html = '<div class="table-container"><table><thead><tr><th>Title</th><th>Priority</th><th>Posted</th><th>Actions</th></tr></thead><tbody>';
    
    announcements.forEach(ann => {
        const date = new Date(ann.timestamp).toLocaleDateString();
        const priorityClass = `priority-${ann.priority}`;
        
        html += `
            <tr>
                <td>${ann.title}</td>
                <td><span class="status-indicator ${priorityClass}">${ann.priority}</span></td>
                <td>${date}</td>
                <td class="action-buttons">
                    <button class="action-btn btn-danger" onclick="deleteAnnouncement('${ann.id}')">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    return html;
}

// Show new announcement form
function showNewAnnouncementForm() {
    const content = `
        <div class="modal-header">
            <h3><i class="fas fa-bullhorn"></i> New Announcement</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        
        <form onsubmit="submitAnnouncement(event)">
            <div class="form-group">
                <label for="annTitle">Title</label>
                <input type="text" id="annTitle" class="form-control" placeholder="Enter announcement title" required>
            </div>
            
            <div class="form-group">
                <label for="annMessage">Message</label>
                <textarea id="annMessage" class="form-control" rows="4" placeholder="Enter announcement message..." required></textarea>
            </div>
            
            <div class="form-group">
                <label for="annPriority">Priority</label>
                <select id="annPriority" class="form-control" required>
                    <option value="low">Low</option>
                    <option value="medium" selected>Medium</option>
                    <option value="high">High</option>
                </select>
            </div>
            
            <div class="form-row">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-paper-plane"></i> Post Announcement
                </button>
                <button type="button" class="btn btn-secondary" onclick="closeModal()">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </form>
    `;
    
    showModal(content);
}

// Submit announcement
async function submitAnnouncement(event) {
    event.preventDefault();
    
    if (!currentUser) return;
    
    const title = document.getElementById('annTitle').value.trim();
    const message = document.getElementById('annMessage').value.trim();
    const priority = document.getElementById('annPriority').value;
    
    if (!title || !message) {
        showToast('Please fill in all fields');
        return;
    }
    
    const announcement = {
        title: title,
        message: message,
        priority: priority,
        postedBy: currentUser.name,
        timestamp: new Date()
    };
    
    // Show loading on mobile
    if (isMobile) {
        const submitBtn = event.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Posting...';
        submitBtn.disabled = true;
    }
    
    try {
        await db.collection('announcements').add(announcement);
        
        // Refresh announcements
        await loadAnnouncements();
        
        // Reload admin announcements
        loadAnnouncementsAdmin();
        
        closeModal();
        showToast('Announcement posted successfully!');
        
    } catch (error) {
        console.error('Error posting announcement:', error);
        showToast('Failed to post announcement');
    } finally {
        // Restore button
        if (isMobile) {
            const submitBtn = event.target.querySelector('button[type="submit"]');
            submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Post Announcement';
            submitBtn.disabled = false;
        }
    }
}

// Delete announcement
async function deleteAnnouncement(announcementId) {
    // Confirm deletion on mobile
    if (isMobile) {
        showModal(`
            <div class="modal-header">
                <h3><i class="fas fa-trash-alt"></i> Confirm Delete</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <p>Are you sure you want to delete this announcement?</p>
            <div class="form-row" style="margin-top: 20px;">
                <button class="btn btn-danger" onclick="confirmDeleteAnnouncement('${announcementId}')">
                    <i class="fas fa-trash"></i> Delete
                </button>
                <button class="btn btn-secondary" onclick="closeModal()">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        `);
    } else {
        if (confirm('Are you sure you want to delete this announcement?')) {
            confirmDeleteAnnouncement(announcementId);
        }
    }
}

async function confirmDeleteAnnouncement(announcementId) {
    try {
        await db.collection('announcements').doc(announcementId).delete();
        
        // Refresh announcements
        await loadAnnouncements();
        
        // Reload admin announcements
        loadAnnouncementsAdmin();
        
        closeModal();
        showToast('Announcement deleted');
        
    } catch (error) {
        console.error('Error deleting announcement:', error);
        showToast('Failed to delete announcement');
    }
}

// Load duty roster admin
function loadDutyRosterAdmin() {
    if (!currentUser || currentUser.Level !== 'Admin') return;
    
    const container = document.getElementById('adminDutyRosterSection');
    if (!container) return;
    
    const today = new Date().toISOString().split('T')[0];
    
    container.innerHTML = `
        <div class="card">
            <h3><i class="fas fa-edit"></i> Manage Duty Roster</h3>
            
            <div class="form-row">
                <input type="date" id="adminRosterDate" class="form-control" value="${today}" min="${today}">
                <button class="btn btn-primary" onclick="loadRosterForAdminDate()">
                    <i class="fas fa-calendar"></i> Load Date
                </button>
                <button class="btn btn-success" onclick="showBulkUpdateForm()">
                    <i class="fas fa-upload"></i> Bulk Update
                </button>
            </div>
            
            <div id="adminRosterContainer">
                <!-- Roster for selected date will be loaded here -->
            </div>
        </div>
    `;
    
    // Load today's roster by default
    loadRosterForAdminDate();
}

// Load roster for admin date
async function loadRosterForAdminDate() {
    const date = document.getElementById('adminRosterDate').value;
    if (!date) return;
    
    const container = document.getElementById('adminRosterContainer');
    
    // Get roster for this date
    let roster = dutyRoster[date] || {};
    
    // Create form for editing
    let html = `
        <h4 style="margin-top: 20px;">Roster for ${date}</h4>
        <form id="editRosterForm" onsubmit="saveRosterChanges(event, '${date}')">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Staff</th>
                            <th>RC</th>
                            <th>Duty Time</th>
                        </tr>
                    </thead>
                    <tbody>
    `;
    
    // Get regular users only
    const regularUsers = allUsers.filter(u => u.Level === 'User');
    
    regularUsers.forEach(user => {
        const currentDuty = roster[user.username] || 'Off';
        
        html += `
            <tr>
                <td>${user.name}</td>
                <td>${user.RCNo}</td>
                <td>
                    <select name="duty_${user.username}" class="form-control" style="width: 150px;">
                        <option value="Off" ${currentDuty === 'Off' ? 'selected' : ''}>Off</option>
                        <option value="0730-1530" ${currentDuty === '0730-1530' ? 'selected' : ''}>07:30-15:30</option>
                        <option value="0830-1630" ${currentDuty === '0830-1630' ? 'selected' : ''}>08:30-16:30</option>
                        <option value="1030-1830" ${currentDuty === '1030-1830' ? 'selected' : ''}>10:30-18:30</option>
                        <option value="1530-2330" ${currentDuty === '1530-2330' ? 'selected' : ''}>15:30-23:30</option>
                        <option value="1630-0030" ${currentDuty === '1630-0030' ? 'selected' : ''}>16:30-00:30</option>
                        <option value="1730-0130" ${currentDuty === '1730-0130' ? 'selected' : ''}>17:30-01:30</option>
                        <option value="0030-0830" ${currentDuty === '0030-0830' ? 'selected' : ''}>00:30-08:30</option>
                    </select>
                </td>
            </tr>
        `;
    });
    
    html += `
                    </tbody>
                </table>
            </div>
            
            <div class="form-row" style="margin-top: 20px;">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Save Changes
                </button>
                <button type="button" class="btn btn-secondary" onclick="loadRosterForAdminDate()">
                    <i class="fas fa-undo"></i> Reset
                </button>
            </div>
        </form>
    `;
    
    container.innerHTML = html;
    makeTablesResponsive();
}

// Save roster changes
async function saveRosterChanges(event, date) {
    event.preventDefault();
    
    if (!currentUser || currentUser.Level !== 'Admin') return;
    
    const form = event.target;
    const formData = new FormData(form);
    
    // Build roster object
    const roster = {};
    allUsers.forEach(user => {
        if (user.Level === 'User') {
            const dutyTime = formData.get(`duty_${user.username}`) || 'Off';
            roster[user.username] = dutyTime;
        }
    });
    
    // Show loading on mobile
    if (isMobile) {
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        submitBtn.disabled = true;
    }
    
    try {
        // Check if roster for this date already exists
        const existingDoc = await db.collection('dutyRoster').where('date', '==', date).get();
        
        if (!existingDoc.empty) {
            // Update existing
            await db.collection('dutyRoster').doc(existingDoc.docs[0].id).update({
                roster: roster
            });
        } else {
            // Create new
            await db.collection('dutyRoster').add({
                date: date,
                roster: roster,
                updatedBy: currentUser.name,
                updatedAt: new Date()
            });
        }
        
        // Refresh duty roster
        await loadDutyRoster();
        
        showToast('Roster updated successfully!');
        
    } catch (error) {
        console.error('Error saving roster:', error);
        showToast('Failed to update roster');
    } finally {
        // Restore button
        if (isMobile) {
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
            submitBtn.disabled = false;
        }
    }
}

// Show bulk update form
function showBulkUpdateForm() {
    const content = `
        <div class="modal-header">
            <h3><i class="fas fa-upload"></i> Bulk Roster Update</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        
        <div class="alert alert-info">
            <h4><i class="fas fa-info-circle"></i> Instructions</h4>
            <p>Upload a CSV file with the following columns:</p>
            <ul>
                <li><code>date</code> (YYYY-MM-DD)</li>
                <li><code>username</code></li>
                <li><code>duty_time</code> (e.g., 0730-1530 or Off)</li>
            </ul>
            <p>Each row should represent one staff member's duty for one date.</p>
        </div>
        
        <form onsubmit="handleBulkUpload(event)">
            <div class="form-group">
                <label for="csvFile">CSV File</label>
                <input type="file" id="csvFile" class="form-control" accept=".csv" required>
            </div>
            
            <div class="form-group">
                <div class="form-check">
                    <input type="checkbox" id="overwriteExisting" class="form-check-input">
                    <label class="form-check-label" for="overwriteExisting">
                        Overwrite existing entries
                    </label>
                </div>
            </div>
            
            <div class="form-row">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-upload"></i> Upload & Process
                </button>
                <button type="button" class="btn btn-secondary" onclick="closeModal()">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </form>
        
        <div style="margin-top: 20px;">
            <a href="#" onclick="downloadTemplate()" class="btn btn-outline-primary btn-sm">
                <i class="fas fa-download"></i> Download Template
            </a>
        </div>
    `;
    
    showModal(content);
}

// Handle bulk upload
async function handleBulkUpload(event) {
    event.preventDefault();
    
    // This is a simplified version - in production, you'd parse CSV and update Firestore
    showToast('Bulk upload feature coming soon!');
    closeModal();
}

// Download template
function downloadTemplate() {
    showToast('Template download coming soon!');
}

// Load leave balance admin
function loadLeaveBalanceAdmin() {
    if (!currentUser || currentUser.Level !== 'Admin') return;
    
    const container = document.getElementById('adminLeaveBalanceSection');
    if (!container) return;
    
    container.innerHTML = `
        <div class="card">
            <h3><i class="fas fa-balance-scale"></i> Manage Leave Balances</h3>
            
            <div class="form-row">
                <button class="btn btn-primary" onclick="showAdjustBalanceForm()">
                    <i class="fas fa-edit"></i> Adjust Balance
                </button>
                <button class="btn btn-success" onclick="showBulkLeaveUpdateForm()">
                    <i class="fas fa-upload"></i> Bulk Update
                </button>
                <button class="btn btn-info" onclick="exportLeaveBalances()">
                    <i class="fas fa-download"></i> Export
                </button>
            </div>
            
            <div id="leaveBalancesTable" style="margin-top: 20px;">
                ${displayLeaveBalancesTable()}
            </div>
        </div>
    `;
}

// Display leave balances table
function displayLeaveBalancesTable() {
    // Get all users with their leave balances
    const userBalances = allUsers.map(user => {
        const balance = leaveBalances[user.username] || { sickLeave: 0, frl: 0 };
        return {
            name: user.name,
            rc: user.RCNo,
            username: user.username,
            sickLeave: balance.sickLeave,
            frl: balance.frl
        };
    });
    
    // Sort by name
    userBalances.sort((a, b) => a.name.localeCompare(b.name));
    
    if (userBalances.length === 0) {
        return '<div class="empty-state"><i class="fas fa-balance-scale"></i><p>No user data found</p></div>';
    }
    
    let html = '<div class="table-container"><table><thead><tr><th>Staff</th><th>RC</th><th>Sick Leave</th><th>FRL</th><th>Actions</th></tr></thead><tbody>';
    
    userBalances.forEach(balance => {
        html += `
            <tr>
                <td>${balance.name}</td>
                <td>${balance.rc}</td>
                <td>${balance.sickLeave}</td>
                <td>${balance.frl}</td>
                <td class="action-buttons">
                    <button class="action-btn btn-warning" onclick="adjustUserBalance('${balance.username}')">
                        <i class="fas fa-edit"></i> Adjust
                    </button>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    return html;
}

// Show adjust balance form
function showAdjustBalanceForm(username = null) {
    let userSelect = '<option value="">Select user</option>';
    allUsers.forEach(user => {
        if (user.Level === 'User') {
            const selected = username === user.username ? 'selected' : '';
            userSelect += `<option value="${user.username}" ${selected}>${user.name} (RC: ${user.RCNo})</option>`;
        }
    });
    
    const content = `
        <div class="modal-header">
            <h3><i class="fas fa-edit"></i> Adjust Leave Balance</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        
        <form onsubmit="saveBalanceAdjustment(event)">
            <div class="form-group">
                <label for="adjustUser">Staff Member</label>
                <select id="adjustUser" class="form-control" required>
                    ${userSelect}
                </select>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="adjustSL">Sick Leave</label>
                    <input type="number" id="adjustSL" class="form-control" min="0" step="0.5" placeholder="Days" required>
                </div>
                
                <div class="form-group">
                    <label for="adjustFRL">FRL</label>
                    <input type="number" id="adjustFRL" class="form-control" min="0" step="0.5" placeholder="Days" required>
                </div>
            </div>
            
            <div class="form-group">
                <label for="adjustReason">Reason for Adjustment</label>
                <textarea id="adjustReason" class="form-control" rows="2" placeholder="Enter reason..." required></textarea>
            </div>
            
            <div class="form-row">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Save Changes
                </button>
                <button type="button" class="btn btn-secondary" onclick="closeModal()">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </form>
    `;
    
    showModal(content);
    
    // If username provided, load current balance
    if (username) {
        const balance = leaveBalances[username] || { sickLeave: 0, frl: 0 };
        document.getElementById('adjustSL').value = balance.sickLeave;
        document.getElementById('adjustFRL').value = balance.frl;
    }
}

// Save balance adjustment
async function saveBalanceAdjustment(event) {
    event.preventDefault();
    
    if (!currentUser || currentUser.Level !== 'Admin') return;
    
    const username = document.getElementById('adjustUser').value;
    const sickLeave = parseFloat(document.getElementById('adjustSL').value);
    const frl = parseFloat(document.getElementById('adjustFRL').value);
    const reason = document.getElementById('adjustReason').value.trim();
    
    if (!username || isNaN(sickLeave) || isNaN(frl) || !reason) {
        showToast('Please fill in all fields');
        return;
    }
    
    // Show loading on mobile
    if (isMobile) {
        const submitBtn = event.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        submitBtn.disabled = true;
    }
    
    try {
        // Check if user already has a balance record
        const existingDoc = await db.collection('leaveBalances').where('username', '==', username).get();
        
        if (!existingDoc.empty) {
            // Update existing
            await db.collection('leaveBalances').doc(existingDoc.docs[0].id).update({
                sickLeave: sickLeave,
                frl: frl,
                lastUpdated: new Date(),
                updatedBy: currentUser.name,
                updateReason: reason
            });
        } else {
            // Create new
            await db.collection('leaveBalances').add({
                username: username,
                sickLeave: sickLeave,
                frl: frl,
                created: new Date(),
                updatedBy: currentUser.name,
                updateReason: reason
            });
        }
        
        // Refresh leave balances
        await loadLeaveBalances();
        
        // Reload leave balance admin
        loadLeaveBalanceAdmin();
        
        closeModal();
        showToast('Leave balance updated successfully!');
        
    } catch (error) {
        console.error('Error updating leave balance:', error);
        showToast('Failed to update leave balance');
    } finally {
        // Restore button
        if (isMobile) {
            const submitBtn = event.target.querySelector('button[type="submit"]');
            submitBtn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
            submitBtn.disabled = false;
        }
    }
}

// Adjust specific user balance
function adjustUserBalance(username) {
    showAdjustBalanceForm(username);
}

// Show bulk leave update form
function showBulkLeaveUpdateForm() {
    showToast('Bulk leave update coming soon!');
}

// Export leave balances
function exportLeaveBalances() {
    showToast('Export feature coming soon!');
}

// Load admin approvals
function loadAdminApprovals() {
    if (!currentUser || currentUser.Level !== 'Admin') return;
    
    const container = document.getElementById('adminApprovalsSection');
    if (!container) return;
    
    // Get recent approvals (last 30 days)
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
    
    const recentApprovals = allRequests.filter(req => 
        req.status !== 'pending' && 
        new Date(req.timestamp) > thirtyDaysAgo
    );
    
    container.innerHTML = `
        <div class="card">
            <h3><i class="fas fa-check-circle"></i> Recent Approvals/Rejections</h3>
            
            <div class="form-row">
                <input type="date" id="approvalStartDate" class="form-control" 
                       value="${thirtyDaysAgo.toISOString().split('T')[0]}">
                <input type="date" id="approvalEndDate" class="form-control" 
                       value="${new Date().toISOString().split('T')[0]}">
                <button class="btn btn-primary" onclick="filterApprovals()">
                    <i class="fas fa-filter"></i> Filter
                </button>
            </div>
            
            <div id="approvalsTable">
                ${displayApprovalsTable(recentApprovals)}
            </div>
        </div>
    `;
}

// Display approvals table
function displayApprovalsTable(approvals) {
    if (approvals.length === 0) {
        return '<div class="empty-state"><i class="far fa-check-circle"></i><p>No approvals found</p></div>';
    }
    
    // Sort by admin timestamp (newest first)
    approvals.sort((a, b) => new Date(b.adminTimestamp) - new Date(a.adminTimestamp));
    
    let html = '<div class="table-container"><table><thead><tr><th>Date</th><th>Staff</th><th>Type</th><th>Action</th><th>By</th><th>Details</th></tr></thead><tbody>';
    
    approvals.forEach(req => {
        const date = new Date(req.adminTimestamp).toLocaleDateString();
        const time = new Date(req.adminTimestamp).toLocaleTimeString();
        
        let details = '';
        if (req.type === 'dutyChange') {
            details = `Exchange ${req.changeDate} with ${req.toName}`;
        } else if (req.type === 'leave') {
            details = `${req.leaveType} on ${req.date}`;
        }
        
        const statusClass = req.status === 'approved' ? 'status-approved' : 'status-rejected';
        
        html += `
            <tr>
                <td>${date}<br><small>${time}</small></td>
                <td>${req.fromName}</td>
                <td>${req.type === 'dutyChange' ? 'Duty Change' : 'Leave'}</td>
                <td><span class="status-indicator ${statusClass}">${req.status}</span></td>
                <td>${req.adminName}</td>
                <td>${details}</td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    return html;
}

// Filter approvals
function filterApprovals() {
    const startDate = document.getElementById('approvalStartDate').value;
    const endDate = document.getElementById('approvalEndDate').value;
    
    if (!startDate || !endDate) return;
    
    const filtered = allRequests.filter(req => 
        req.status !== 'pending' && 
        req.adminTimestamp &&
        new Date(req.adminTimestamp) >= new Date(startDate) &&
        new Date(req.adminTimestamp) <= new Date(endDate)
    );
    
    document.getElementById('approvalsTable').innerHTML = displayApprovalsTable(filtered);
}

// Load admin request history
function loadAdminRequestHistory() {
    if (!currentUser || currentUser.Level !== 'Admin') return;
    
    const container = document.getElementById('adminRequestHistorySection');
    if (!container) return;
    
    container.innerHTML = `
        <div class="card">
            <h3><i class="fas fa-history"></i> Request History</h3>
            
            <div class="form-row">
                <input type="text" id="historySearch" class="form-control" placeholder="Search by staff name or RC...">
                <button class="btn btn-primary" onclick="searchHistory()">
                    <i class="fas fa-search"></i> Search
                </button>
            </div>
            
            <div class="tab-controls">
                <button class="tab-btn active" onclick="filterHistory('all')">All</button>
                <button class="tab-btn" onclick="filterHistory('dutyChange')">Duty Changes</button>
                <button class="tab-btn" onclick="filterHistory('leave')">Leaves</button>
                <button class="tab-btn" onclick="filterHistory('pending')">Pending</button>
                <button class="tab-btn" onclick="filterHistory('approved')">Approved</button>
                <button class="tab-btn" onclick="filterHistory('rejected')">Rejected</button>
            </div>
            
            <div id="historyTable">
                ${displayHistoryTable(allRequests)}
            </div>
        </div>
    `;
}

// Display history table
function displayHistoryTable(requests) {
    if (requests.length === 0) {
        return '<div class="empty-state"><i class="fas fa-history"></i><p>No requests found</p></div>';
    }
    
    // Sort by timestamp (newest first)
    requests.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    
    let html = '<div class="table-container"><table><thead><tr><th>Date</th><th>Staff</th><th>Type</th><th>Status</th><th>Details</th><th>Actions</th></tr></thead><tbody>';
    
    requests.forEach(req => {
        const date = new Date(req.timestamp).toLocaleDateString();
        
        let details = '';
        if (req.type === 'dutyChange') {
            details = `Exchange ${req.changeDate} with ${req.toName}`;
        } else if (req.type === 'leave') {
            details = `${req.leaveType} on ${req.date}`;
        }
        
        const statusClass = `status-${req.status}`;
        
        html += `
            <tr>
                <td>${date}</td>
                <td>${req.fromName}</td>
                <td>${req.type === 'dutyChange' ? 'Duty Change' : 'Leave'}</td>
                <td><span class="status-indicator ${statusClass}">${req.status}</span></td>
                <td>${details}</td>
                <td class="action-buttons">
                    <button class="action-btn btn-info" onclick="viewRequestDetails('${req.id}')">
                        <i class="fas fa-eye"></i> View
                    </button>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    return html;
}

// Search history
function searchHistory() {
    const query = document.getElementById('historySearch').value.toLowerCase();
    
    if (!query) {
        document.getElementById('historyTable').innerHTML = displayHistoryTable(allRequests);
        return;
    }
    
    const filtered = allRequests.filter(req => 
        req.fromName.toLowerCase().includes(query) ||
        req.toName?.toLowerCase().includes(query) ||
        allUsers.find(u => u.username === req.fromUsername)?.RCNo?.toLowerCase().includes(query)
    );
    
    document.getElementById('historyTable').innerHTML = displayHistoryTable(filtered);
}

// Filter history
function filterHistory(filter) {
    const tabs = document.querySelectorAll('.tab-btn');
    tabs.forEach(tab => tab.classList.remove('active'));
    event.target.classList.add('active');
    
    let filtered = [];
    
    if (filter === 'all') {
        filtered = allRequests;
    } else if (filter === 'dutyChange' || filter === 'leave') {
        filtered = allRequests.filter(req => req.type === filter);
    } else {
        filtered = allRequests.filter(req => req.status === filter);
    }
    
    document.getElementById('historyTable').innerHTML = displayHistoryTable(filtered);
}

// Initialize the application
window.addEventListener('load', function() {
    // Check if device is mobile
    if (isMobile) {
        document.body.classList.add('mobile-device');
        
        // Add install prompt for PWA
        setupPWA();
    }
    
    // Set viewport height for mobile browsers
    function setViewportHeight() {
        let vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', `${vh}px`);
    }
    
    setViewportHeight();
    window.addEventListener('resize', setViewportHeight);
    
    // Initialize app when Firebase is ready
    const checkFirebase = setInterval(() => {
        if (typeof db !== 'undefined' && typeof users !== 'undefined') {
            firebaseReady = true;
            clearInterval(checkFirebase);
            initApp();
        }
    }, 100);
});

// Setup PWA
function setupPWA() {
    let deferredPrompt;
    
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        
        // Show install button after 5 seconds
        setTimeout(showInstallButton, 5000);
    });
    
    function showInstallButton() {
        if (!deferredPrompt) return;
        
        const installBtn = document.createElement('button');
        installBtn.className = 'btn btn-success mobile-only';
        installBtn.innerHTML = '<i class="fas fa-download"></i> Install App';
        installBtn.style.cssText = `
            position: fixed;
            bottom: 100px;
            right: 20px;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            animation: pulse 2s infinite;
        `;
        
        installBtn.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    installBtn.remove();
                }
                deferredPrompt = null;
            }
        });
        
        document.body.appendChild(installBtn);
        
        // Auto-hide after 10 seconds
        setTimeout(() => {
            if (installBtn.parentNode) {
                installBtn.remove();
            }
        }, 10000);
    }
}

// Make functions available globally
window.showSection = showSection;
window.showMobileSection = showMobileSection;
window.updateDashboard = initializeData;
window.closeModal = closeModal;
window.showModal = showModal;
window.showToast = showToast;
window.filterMyRequests = filterMyRequests;
window.deleteRequest = deleteRequest;
window.requestChangeForDate = requestChangeForDate;
window.applyLeaveForDate = applyLeaveForDate;
window.searchRosterByDate = searchRosterByDate;
window.downloadMyRoster = downloadMyRoster;
window.printMyRoster = printMyRoster;
window.changeRosterMonth = changeRosterMonth;
window.loadRosterForDate = loadRosterForDate;
window.showFullRosterModal = showFullRosterModal;
window.downloadFullRoster = downloadFullRoster;
window.filterPendingRequests = filterPendingRequests;
window.approveRequest = approveRequest;
window.rejectRequest = rejectRequest;
window.viewRequestDetails = viewRequestDetails;
window.showNewAnnouncementForm = showNewAnnouncementForm;
window.submitAnnouncement = submitAnnouncement;
window.deleteAnnouncement = deleteAnnouncement;
window.loadRosterForAdminDate = loadRosterForAdminDate;
window.saveRosterChanges = saveRosterChanges;
window.showBulkUpdateForm = showBulkUpdateForm;
window.showAdjustBalanceForm = showAdjustBalanceForm;
window.adjustUserBalance = adjustUserBalance;
window.showBulkLeaveUpdateForm = showBulkLeaveUpdateForm;
window.exportLeaveBalances = exportLeaveBalances;
window.filterApprovals = filterApprovals;
window.searchHistory = searchHistory;
window.filterHistory = filterHistory;
window.submitDutyChange = submitDutyChange;
window.submitLeaveApplication = submitLeaveApplication;
window.confirmLogout = confirmLogout;
window.confirmDeleteRequest = confirmDeleteRequest;
window.confirmDeleteAnnouncement = confirmDeleteAnnouncement;
window.confirmApproveRequest = confirmApproveRequest;
window.confirmRejectRequest = confirmRejectRequest;
        // Initialize everything
        window.addEventListener('load', function() {
            // Check if device is mobile
            if (isMobile) {
                document.body.classList.add('mobile-device');
                
                // Add install prompt for PWA
                setupPWA();
            }
            
            // Set viewport height for mobile browsers
            function setViewportHeight() {
                let vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', `${vh}px`);
            }
            
            setViewportHeight();
            window.addEventListener('resize', setViewportHeight);
        });

        function setupPWA() {
            // Check if PWA is installable
            let deferredPrompt;
            
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                
                // Show install button
                showInstallButton();
            });
            
            function showInstallButton() {
                const installBtn = document.createElement('button');
                installBtn.className = 'btn btn-success mobile-only';
                installBtn.innerHTML = '<i class="fas fa-download"></i> Install App';
                installBtn.style.cssText = 'position: fixed; bottom: 100px; right: 20px; z-index: 1000;';
                
                installBtn.addEventListener('click', async () => {
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                        const { outcome } = await deferredPrompt.userChoice;
                        if (outcome === 'accepted') {
                            installBtn.remove();
                        }
                        deferredPrompt = null;
                    }
                });
                
                document.body.appendChild(installBtn);
                
                // Auto-hide after 10 seconds
                setTimeout(() => {
                    if (installBtn.parentNode) {
                        installBtn.remove();
                    }
                }, 10000);
            }
        }

        // Export functions for global use
        window.showSection = showSection;
        window.updateDashboard = updateDashboard;
        window.showMobileSection = showMobileSection;
        window.closeModal = closeModal;
        window.showModal = showModal;
        window.showToast = showToast;
    </script>
</body>
</html>
