<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duty Management System</title>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <!-- SHA-256 Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js"></script>
    
    <!-- External Firebase and User files -->
    <script src="dcfire.js" defer></script>
    <script src="user.js" defer></script>
    
    <style>
        /* All CSS styles remain the same as before */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        body {
            background: #f5f7fa;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        /* Login Page */
        .login-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            padding: 40px;
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo h1 {
            color: #2c3e50;
            font-size: 28px;
            margin-bottom: 5px;
        }

        .logo p {
            color: #7f8c8d;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #2c3e50;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e6ed;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #219653;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #d68910;
        }

        .btn-block {
            width: 100%;
        }

        .error-message {
            background: #ffeaea;
            color: #e74c3c;
            padding: 12px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
            font-size: 14px;
        }

        /* Dashboard */
        .dashboard-container {
            display: none;
            width: 100%;
            max-width: 1200px;
            min-height: 600px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        /* Header */
        .dashboard-header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info h2 {
            font-size: 18px;
            margin-bottom: 5px;
        }

        .user-details {
            font-size: 13px;
            opacity: 0.9;
            display: flex;
            gap: 15px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        /* Navigation */
        .dashboard-nav {
            background: #34495e;
            padding: 12px 30px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .nav-btn {
            background: none;
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .nav-btn.active {
            background: #3498db;
        }

        .notification-badge {
            background: #e74c3c;
            color: white;
            border-radius: 10px;
            padding: 2px 8px;
            font-size: 12px;
            margin-left: 5px;
        }

        .notification-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #e74c3c;
            border-radius: 50%;
            margin-left: 5px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }

        /* Content Area */
        .dashboard-content {
            padding: 25px;
            min-height: 500px;
        }

        .section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .section.active {
            display: block;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border: 1px solid #e0e6ed;
        }

        .card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 16px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
        }

        /* Announcement Banner */
        .announcement-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        .announcement-banner.priority-high {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            animation: pulse-banner 2s infinite;
        }

        .announcement-banner.priority-medium {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .announcement-banner.priority-low {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }

        @keyframes pulse-banner {
            0% { box-shadow: 0 0 0 0 rgba(245, 87, 108, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(245, 87, 108, 0); }
            100% { box-shadow: 0 0 0 0 rgba(245, 87, 108, 0); }
        }

        .announcement-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .announcement-icon {
            font-size: 20px;
        }

        .announcement-content {
            font-size: 14px;
            opacity: 0.95;
            margin-bottom: 10px;
        }

        .announcement-meta {
            font-size: 11px;
            opacity: 0.8;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }

        .announcement-target {
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
        }

        .announcement-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
        }

        .announcement-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.3s;
        }

        .announcement-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Forms */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group-inline {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        textarea.form-control {
            min-height: 80px;
            resize: vertical;
            font-family: monospace;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            margin-top: 15px;
            border: 1px solid #e0e6ed;
            border-radius: 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e6ed;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
            font-size: 13px;
        }

        td {
            font-size: 13px;
        }

        tr:hover {
            background: #f8f9fa;
        }

        /* Excel-like table */
        .excel-table {
            font-family: monospace;
            font-size: 13px;
        }

        .excel-table td {
            padding: 8px;
            border: 1px solid #ddd;
            white-space: nowrap;
        }

        .excel-table th {
            background: #f0f0f0;
            border: 1px solid #ddd;
        }

        .excel-input {
            width: 100%;
            border: none;
            background: transparent;
            font-family: monospace;
            font-size: 13px;
            padding: 4px;
        }

        .excel-input:focus {
            outline: 2px solid #3498db;
            background: white;
        }

        /* Status */
        .status-pending {
            color: #f39c12;
            font-weight: 500;
        }

        .status-approved {
            color: #27ae60;
            font-weight: 500;
        }

        .status-rejected {
            color: #e74c3c;
            font-weight: 500;
        }
        
        .status-off {
            color: #7f8c8d;
            font-weight: 500;
        }

        .status-completed {
            color: #3498db;
            font-weight: 500;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-btn.approve {
            background: #d4edda;
            color: #155724;
        }

        .action-btn.reject {
            background: #f8d7da;
            color: #721c24;
        }

        .action-btn.view {
            background: #d1ecf1;
            color: #0c5460;
        }

        .action-btn.apply {
            background: #cce5ff;
            color: #004085;
        }

        .action-btn.delete {
            background: #f8d7da;
            color: #721c24;
        }

        .action-btn.edit {
            background: #fff3cd;
            color: #856404;
        }

        /* Alerts */
        .alert {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid;
            font-size: 13px;
        }

        .alert-info {
            background: #e8f4fc;
            border-color: #3498db;
            color: #2c3e50;
        }

        .alert-success {
            background: #d4edda;
            border-color: #27ae60;
            color: #155724;
        }

        .alert-warning {
            background: #fff3cd;
            border-color: #f39c12;
            color: #856404;
        }

        .alert-danger {
            background: #f8d7da;
            border-color: #e74c3c;
            color: #721c24;
        }

        /* Balance Display */
        .balance-display {
            display: flex;
            gap: 20px;
            margin-top: 15px;
        }

        .balance-box {
            flex: 1;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #e0e6ed;
        }

        .balance-value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
            margin: 5px 0;
        }

        .balance-label {
            font-size: 12px;
            color: #7f8c8d;
            text-transform: uppercase;
        }

        /* Excel Import Area */
        .excel-import-area {
            background: #f8f9fa;
            border: 2px dashed #3498db;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
        }

        .excel-import-area:hover {
            background: #e8f4fc;
        }

        .excel-paste-box {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }

        /* Tab Controls */
        .tab-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            border-bottom: 2px solid #e0e6ed;
            padding-bottom: 10px;
        }

        .tab-btn {
            padding: 8px 16px;
            border: none;
            background: #f0f0f0;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }

        .tab-btn.active {
            background: #3498db;
            color: white;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 30px;
            color: #7f8c8d;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .dashboard-nav {
                flex-direction: column;
                gap: 8px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .balance-display {
                flex-direction: column;
                gap: 10px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }

        /* Tooltip */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        /* Calendar View */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-top: 15px;
        }
        
        .calendar-day {
            border: 1px solid #e0e6ed;
            padding: 8px;
            min-height: 60px;
            border-radius: 4px;
            background: #f8f9fa;
        }
        
        .calendar-day.off-day {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        }
        
        .calendar-day.duty-day {
            background: linear-gradient(135deg, #cce5ff 0%, #b8daff 100%);
        }
        
        .calendar-day.today {
            border: 2px solid #3498db;
            background: linear-gradient(135deg, #e8f4fc 0%, #d1ecf1 100%);
        }
        
        .day-header {
            font-weight: bold;
            font-size: 12px;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .duty-time {
            font-size: 11px;
            color: #155724;
        }
        
        .off-time {
            font-size: 11px;
            color: #721c24;
        }
        
        /* Request History */
        .request-history-table {
            font-size: 12px;
        }
        
        .request-history-table td {
            padding: 8px;
            vertical-align: top;
        }
        
        .request-details {
            background: #f8f9fa;
            padding: 5px;
            border-radius: 4px;
            margin: 2px 0;
            font-size: 11px;
        }
        
        .status-update {
            font-style: italic;
            color: #666;
            font-size: 11px;
        }
        
        .timestamp {
            font-size: 11px;
            color: #888;
        }
        
        /* View All Roster Styles */
        .roster-all-view {
            overflow-x: auto;
        }
        
        .roster-all-view table {
            min-width: 800px;
        }
        
        .staff-name {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .leave-indicator {
            background: linear-gradient(135deg, #ffd6a5 0%, #ffc677 100%);
            border: 1px solid #ffb142;
            border-radius: 3px;
            padding: 2px 5px;
            font-size: 10px;
            margin-left: 5px;
            color: #cc8e35;
            font-weight: bold;
        }
        
        .off-day-cell {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%) !important;
            color: #155724 !important;
            font-weight: 500;
        }
        
        /* UPDATED DUTY TIME COLORS WITH GRADIENTS */
        /* 07:30 - Yellow Gradient */
        .duty-0730-1530 {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%) !important;
            color: #856404 !important;
        }
        
        /* 08:30 - Purple Gradient */
        .duty-0830-1630 {
            background: linear-gradient(135deg, #e2d9f3 0%, #d6c6f7 100%) !important;
            color: #563d7c !important;
        }
        
        /* 10:30 - Light Yellow Gradient */
        .duty-1030-1830 {
            background: linear-gradient(135deg, #fffde7 0%, #fff9c4 100%) !important;
            color: #827717 !important;
        }
        
        /* 15:30 - Light Blue Gradient */
        .duty-1530-2330 {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%) !important;
            color: #0d47a1 !important;
        }
        
        /* 16:30 - Gray Gradient */
        .duty-1630-0030 {
            background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%) !important;
            color: #424242 !important;
        }
        
        /* 17:30 - Dark Gray Gradient */
        .duty-1730-0130 {
            background: linear-gradient(135deg, #eeeeee 0%, #bdbdbd 100%) !important;
            color: #212121 !important;
        }
        
        /* 00:30 - Red Gradient */
        .duty-0030-0830 {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%) !important;
            color: #c62828 !important;
        }
        
        /* Leave (A-Leave) - Orange Gradient */
        .duty-leave {
            background: linear-gradient(135deg, #ffd8a6 0%, #ffc078 100%) !important;
            color: #e8590c !important;
            border: 1px dashed #fd7e14 !important;
        }
        
        /* Other duty times - Fallback gradients */
        .duty-0000-0800 {
            background: linear-gradient(135deg, #e8f4fc 0%, #d1ecf1 100%) !important;
            color: #0c5460 !important;
        }
        
        .duty-0100-0900 {
            background: linear-gradient(135deg, #e8f4fc 0%, #d1ecf1 100%) !important;
            color: #0c5460 !important;
        }
        
        .duty-0200-1000 {
            background: linear-gradient(135deg, #e8f4fc 0%, #d1ecf1 100%) !important;
            color: #0c5460 !important;
        }
        
        .duty-0300-1100 {
            background: linear-gradient(135deg, #e8f4fc 0%, #d1ecf1 100%) !important;
            color: #0c5460 !important;
        }
        
        .duty-0400-1200 {
            background: linear-gradient(135deg, #e8f4fc 0%, #d1ecf1 100%) !important;
            color: #0c5460 !important;
        }
        
        .duty-0500-1300 {
            background: linear-gradient(135deg, #e8f4fc 0%, #d1ecf1 100%) !important;
            color: #0c5460 !important;
        }
        
        .duty-0600-1400 {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%) !important;
            color: #155724 !important;
        }
        
        .duty-0630-1430 {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%) !important;
            color: #155724 !important;
        }
        
        .duty-0700-1500 {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%) !important;
            color: #856404 !important;
        }
        
        .duty-0800-1600 {
            background: linear-gradient(135deg, #e2d9f3 0%, #d6c6f7 100%) !important;
            color: #563d7c !important;
        }
        
        .duty-1000-1800 {
            background: linear-gradient(135deg, #fffde7 0%, #fff9c4 100%) !important;
            color: #827717 !important;
        }
        
        .duty-1100-1900 {
            background: linear-gradient(135deg, #fffde7 0%, #fff9c4 100%) !important;
            color: #827717 !important;
        }
        
        .duty-1130-1930 {
            background: linear-gradient(135deg, #fffde7 0%, #fff9c4 100%) !important;
            color: #827717 !important;
        }
        
        .duty-1200-2000 {
            background: linear-gradient(135deg, #c7e5d4 0%, #a5d6a7 100%) !important;
            color: #1b5e20 !important;
        }
        
        .duty-1230-2030 {
            background: linear-gradient(135deg, #c7e5d4 0%, #a5d6a7 100%) !important;
            color: #1b5e20 !important;
        }
        
        .duty-1300-2100 {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%) !important;
            color: #0d47a1 !important;
        }
        
        .duty-1330-2130 {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%) !important;
            color: #0d47a1 !important;
        }
        
        .duty-1400-2200 {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%) !important;
            color: #0d47a1 !important;
        }
        
        .duty-1430-2230 {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%) !important;
            color: #0d47a1 !important;
        }
        
        .duty-1500-2300 {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%) !important;
            color: #0d47a1 !important;
        }
        
        .duty-1600-0000 {
            background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%) !important;
            color: #424242 !important;
        }
        
        .duty-1800-0200 {
            background: linear-gradient(135deg, #eeeeee 0%, #bdbdbd 100%) !important;
            color: #212121 !important;
        }
        
        .duty-1830-0230 {
            background: linear-gradient(135deg, #eeeeee 0%, #bdbdbd 100%) !important;
            color: #212121 !important;
        }
        
        .duty-1900-0300 {
            background: linear-gradient(135deg, #e0e0e0 0%, #9e9e9e 100%) !important;
            color: #000 !important;
        }
        
        .duty-1930-0330 {
            background: linear-gradient(135deg, #e0e0e0 0%, #9e9e9e 100%) !important;
            color: #000 !important;
        }
        
        .duty-2000-0400 {
            background: linear-gradient(135deg, #e0e0e0 0%, #9e9e9e 100%) !important;
            color: #000 !important;
        }
        
        .duty-2030-0430 {
            background: linear-gradient(135deg, #e0e0e0 0%, #9e9e9e 100%) !important;
            color: #000 !important;
        }
        
        .duty-2100-0500 {
            background: linear-gradient(135deg, #bdbdbd 0%, #757575 100%) !important;
            color: #fff !important;
        }
        
        .duty-2130-0530 {
            background: linear-gradient(135deg, #bdbdbd 0%, #757575 100%) !important;
            color: #fff !important;
        }
        
        .duty-2200-0600 {
            background: linear-gradient(135deg, #bdbdbd 0%, #757575 100%) !important;
            color: #fff !important;
        }
        
        .duty-2230-0630 {
            background: linear-gradient(135deg, #bdbdbd 0%, #757575 100%) !important;
            color: #fff !important;
        }
        
        .duty-2300-0700 {
            background: linear-gradient(135deg, #9e9e9e 0%, #616161 100%) !important;
            color: #fff !important;
        }
        
        .duty-2330-0730 {
            background: linear-gradient(135deg, #9e9e9e 0%, #616161 100%) !important;
            color: #fff !important;
        }
        
        /* Mixed/Other shifts */
        .duty-mixed {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%) !important;
            color: #856404 !important;
            border: 1px dashed #f39c12 !important;
        }
        
        .duty-special {
            background: linear-gradient(135deg, #e2d9f3 0%, #d6c6f7 100%) !important;
            color: #563d7c !important;
            border: 1px dashed #9c27b0 !important;
        }
        
        .duty-other {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%) !important;
            color: #495057 !important;
            border: 1px dashed #6c757d !important;
        }
        
        .today-cell {
            border: 2px solid #3498db !important;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.3) !important;
        }
        
        /* Date Navigation */
        .date-navigation {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .date-nav-btn {
            background: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s;
        }
        
        .date-nav-btn:hover {
            background: #2980b9;
        }
        
        .current-date-display {
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }
        
        /* Legend */
        .legend {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e0e6ed;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 11px;
        }
        
        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 3px;
            border: 1px solid rgba(0,0,0,0.1);
        }

        /* Announcement Admin Styles */
        .announcement-form-card {
            margin-bottom: 20px;
        }

        .priority-options {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .priority-btn {
            flex: 1;
            padding: 8px;
            border: 2px solid #e0e6ed;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }

        .priority-btn:hover {
            transform: translateY(-2px);
        }

        .priority-btn.active {
            border-color: #3498db;
            background: #e8f4fc;
        }

        .priority-btn.high {
            border-left-color: #e74c3c;
        }

        .priority-btn.medium {
            border-left-color: #f39c12;
        }

        .priority-btn.low {
            border-left-color: #27ae60;
        }

        .target-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .target-option {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .no-announcements {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px dashed #e0e6ed;
        }

        .no-announcements .icon {
            font-size: 48px;
            margin-bottom: 10px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <!-- Login Container -->
    <div class="login-container" id="loginContainer">
        <div class="logo">
            <h1>Duty Management</h1>
            <p>Secure Login System</p>
        </div>
        
        <form id="loginForm">
            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" class="form-control" placeholder="Enter username" required autofocus>
            </div>
            
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" class="form-control" placeholder="Enter password" required>
            </div>
            
            <button type="submit" class="btn btn-primary btn-block" id="loginBtn">Login</button>
            
            <div class="error-message" id="errorMessage">
                Invalid username or password
            </div>
        </form>
    </div>
    
    <!-- Dashboard Container -->
    <div class="dashboard-container" id="dashboardContainer">
        <!-- Header -->
        <div class="dashboard-header">
            <div class="user-info">
                <h2 id="userName">User Name</h2>
                <div class="user-details">
                    <span>RC: <span id="userRC">000</span></span>
                    <span>Level: <span id="userLevel">User</span></span>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn btn-danger" id="logoutBtn">Logout</button>
            </div>
        </div>
        
        <!-- Navigation -->
        <div class="dashboard-nav">
            <button class="nav-btn active" data-section="home">Dashboard</button>
            <button class="nav-btn" data-section="dutyChange">Duty Change</button>
            <button class="nav-btn" data-section="leaveApplication">Apply Leave</button>
            <button class="nav-btn" data-section="myRequests">My Requests</button>
            <button class="nav-btn" data-section="viewMyRoster">My Roster</button>
            <button class="nav-btn" data-section="viewAllRoster" id="viewAllRosterBtn">View All Roster</button>
            <button class="nav-btn" data-section="pendingRequests" id="pendingRequestsBtn" style="display:none;">
                Pending <span id="pendingCount" class="notification-badge">0</span>
            </button>
            <!-- Admin Only -->
            <button class="nav-btn" data-section="adminDutyRoster" id="adminDutyRosterBtn" style="display:none;">
                Duty Roster
            </button>
            <button class="nav-btn" data-section="adminLeaveBalance" id="adminLeaveBalanceBtn" style="display:none;">
                Leave Balance
            </button>
            <button class="nav-btn" data-section="adminApprovals" id="adminApprovalsBtn" style="display:none;">
                Approvals
            </button>
            <button class="nav-btn" data-section="adminRequestHistory" id="adminRequestHistoryBtn" style="display:none;">
                Request History <span id="historyNotification" class="notification-dot" style="display:none;"></span>
            </button>
            <button class="nav-btn" data-section="adminAnnouncements" id="adminAnnouncementsBtn" style="display:none;">
                Announcements
            </button>
        </div>
        
        <!-- Content Area -->
        <div class="dashboard-content">
            <!-- Dashboard -->
            <div class="section active" id="homeSection">
                <div id="homeAnnouncements">
                    <!-- Announcements will be loaded here -->
                </div>
                
                <div class="card">
                    <h3>Welcome, <span id="welcomeName">User</span>!</h3>
                    
                    <div class="balance-display">
                        <div class="balance-box">
                            <div class="balance-label">Sick Leave Balance</div>
                            <div class="balance-value" id="slBalance">0</div>
                            <div class="balance-label">Days</div>
                        </div>
                        <div class="balance-box">
                            <div class="balance-label">FRL Balance</div>
                            <div class="balance-value" id="frlBalance">0</div>
                            <div class="balance-label">Days</div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <p><strong>Today's Duty:</strong> <span id="todayDutyTime">Not Scheduled</span></p>
                        <p><strong>Next Duty:</strong> <span id="nextDutyTime">No upcoming duty</span></p>
                        <div id="homeNotifications" style="margin-top: 10px; display: none;">
                            <!-- Notifications will appear here -->
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <button class="btn btn-primary" onclick="updateDashboard()">Refresh Dashboard</button>
                        <button class="btn btn-warning" onclick="showSection('dutyChange')">Request Duty Change</button>
                        <button class="btn btn-success" onclick="showSection('leaveApplication')">Apply Leave</button>
                        <button class="btn btn-primary" onclick="showSection('myRequests')">My Requests</button>
                        <button class="btn btn-primary" onclick="showSection('viewMyRoster')">View My Roster</button>
                        <button class="btn btn-primary" onclick="showSection('viewAllRoster')">View All Roster</button>
                    </div>
                </div>
            </div>
            
            <!-- Duty Change Request -->
            <div class="section" id="dutyChangeSection">
                <div class="card">
                    <h3>Duty Change Request</h3>
                    
                    <div class="alert alert-warning">
                        <strong>Note:</strong> Requests must be made at least 24 hours in advance. No back dates allowed.
                    </div>
                    
                    <form id="dutyChangeForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="changeDate">Change Date *</label>
                                <input type="date" id="changeDate" class="form-control" required min="">
                            </div>
                            <div class="form-group">
                                <label for="changeDutyTime">Your Duty Time *</label>
                                <select id="changeDutyTime" class="form-control" required>
                                    <option value="">Select duty time</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="requestToStaff">Request To Staff *</label>
                                <select id="requestToStaff" class="form-control" required>
                                    <option value="">Select staff member</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="requestToRcNo">Staff RC No</label>
                                <input type="text" id="requestToRcNo" class="form-control" readonly>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="requestToDutyTime">Staff's Duty Time *</label>
                                <select id="requestToDutyTime" class="form-control" required>
                                    <option value="">Select duty time</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="changeReason">Reason (Optional)</label>
                                <textarea id="changeReason" class="form-control" rows="2" placeholder="Brief reason for duty change"></textarea>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <button type="submit" class="btn btn-success">Submit Request</button>
                            <button type="button" class="btn btn-danger" onclick="showSection('home')">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Leave Application -->
            <div class="section" id="leaveApplicationSection">
                <div class="card">
                    <h3>Leave Application</h3>
                    
                    <div class="alert alert-info">
                        <p><strong>Application Rules:</strong></p>
                        <p>• Sick Leave: Minimum 2 hours before duty time</p>
                        <p>• FRL: Minimum 1 hour before duty time</p>
                        <p>• No back dated applications allowed</p>
                    </div>
                    
                    <form id="leaveApplicationForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="leaveType">Leave Type *</label>
                                <select id="leaveType" class="form-control" required>
                                    <option value="">Select leave type</option>
                                    <option value="Sick Leave">Sick Leave</option>
                                    <option value="FRL">FRL</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="leaveDate">Leave Date *</label>
                                <input type="date" id="leaveDate" class="form-control" required min="">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="leaveDutyTime">Duty Time *</label>
                                <select id="leaveDutyTime" class="form-control" required>
                                    <option value="">Select duty time</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="leaveDuration">Duration *</label>
                                <select id="leaveDuration" class="form-control" required>
                                    <option value="1">1 Day</option>
                                    <option value="0.5">Half Day</option>
                                    <option value="2">2 Days</option>
                                    <option value="3">3 Days</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="leaveReason">Reason *</label>
                                <textarea id="leaveReason" class="form-control" rows="3" placeholder="Please provide reason for leave" required></textarea>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="alert" id="leaveRulesAlert">
                                Select leave type, date and duty time to see rules
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <button type="submit" class="btn btn-success" id="submitLeaveBtn">Submit Application</button>
                            <button type="button" class="btn btn-danger" onclick="showSection('home')">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- My Requests -->
            <div class="section" id="myRequestsSection">
                <div class="card">
                    <h3>My Requests</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Date</th>
                                    <th>Details</th>
                                    <th>Status</th>
                                    <th>Updated</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="myRequestsTable">
                                <!-- Filled by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- My Roster (User View) -->
            <div class="section" id="viewMyRosterSection">
                <div class="card">
                    <h3>My Duty Roster</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="myRosterMonth">View Month</label>
                            <input type="month" id="myRosterMonth" class="form-control" value="">
                        </div>
                        <div class="form-group">
                            <label for="myRosterViewType">View Type</label>
                            <select id="myRosterViewType" class="form-control">
                                <option value="table">Table View</option>
                                <option value="calendar">Calendar View</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <button class="btn btn-primary" onclick="loadMyRoster()" style="margin-top: 25px;">Load Roster</button>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        This shows your scheduled duties. Changes must be requested via Duty Change.
                    </div>
                    
                    <div id="myRosterContainer" style="margin-top: 20px;">
                        <!-- Roster will be displayed here -->
                    </div>
                </div>
            </div>
            
            <!-- Pending Requests -->
            <div class="section" id="pendingRequestsSection">
                <div class="card">
                    <h3>Pending Requests For You</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>From</th>
                                    <th>Date</th>
                                    <th>Details</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="pendingRequestsTable">
                                <!-- Filled by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- View All Roster (Accessible to All Users) -->
            <div class="section" id="viewAllRosterSection">
                <div class="card">
                    <h3>Complete Duty Roster - All Staff</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="allRosterStartDate">From Date</label>
                            <input type="date" id="allRosterStartDate" class="form-control" value="">
                        </div>
                        <div class="form-group">
                            <label for="allRosterEndDate">To Date</label>
                            <input type="date" id="allRosterEndDate" class="form-control" value="">
                        </div>
                        <div class="form-group">
                            <label for="allRosterViewType">View Type</label>
                            <select id="allRosterViewType" class="form-control">
                                <option value="table">Daily Table</option>
                                <option value="staff">Staff View</option>
                                <option value="calendar">Calendar View</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <button class="btn btn-primary" onclick="loadAllRoster()" style="margin-top: 25px;">Load Roster</button>
                        <button class="btn btn-secondary" onclick="printAllRoster()" style="margin-top: 25px;">Print</button>
                    </div>
                    
                    <div class="alert alert-info">
                        This shows the complete duty roster for all staff members. Different shift timings are color-coded for easy identification.
                    </div>
                    
                    <div id="allRosterContainer" style="margin-top: 20px;">
                        <!-- Complete roster will be displayed here -->
                    </div>
                </div>
            </div>
            
            <!-- Admin: Announcement Management -->
            <div class="section" id="adminAnnouncementsSection">
                <div class="card announcement-form-card">
                    <h3>Create Announcement</h3>
                    
                    <form id="announcementForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="announcementTitle">Title *</label>
                                <input type="text" id="announcementTitle" class="form-control" placeholder="Enter announcement title" required maxlength="100">
                            </div>
                            <div class="form-group">
                                <label for="announcementPriority">Priority *</label>
                                <div class="priority-options">
                                    <div class="priority-btn high" data-priority="high" onclick="selectPriority('high')">
                                        High<br>
                                        <small style="font-size: 10px; color: #e74c3c;">Urgent</small>
                                    </div>
                                    <div class="priority-btn medium active" data-priority="medium" onclick="selectPriority('medium')">
                                        Medium<br>
                                        <small style="font-size: 10px; color: #f39c12;">Important</small>
                                    </div>
                                    <div class="priority-btn low" data-priority="low" onclick="selectPriority('low')">
                                        Low<br>
                                        <small style="font-size: 10px; color: #27ae60;">Notice</small>
                                    </div>
                                </div>
                                <input type="hidden" id="announcementPriority" value="medium" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="announcementContent">Content *</label>
                                <textarea id="announcementContent" class="form-control" rows="4" placeholder="Enter announcement details..." required maxlength="500"></textarea>
                                <small style="color: #666; font-size: 11px;">Maximum 500 characters</small>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Target Audience *</label>
                                <div class="target-options">
                                    <label class="target-option">
                                        <input type="radio" name="target" value="all" checked onchange="updateTargetSelection()">
                                        All Staff
                                    </label>
                                    <label class="target-option">
                                        <input type="radio" name="target" value="specific" onchange="updateTargetSelection()">
                                        Specific Staff
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-row" id="specificStaffSection" style="display: none;">
                            <div class="form-group">
                                <label for="announcementStaff">Select Staff</label>
                                <select id="announcementStaff" class="form-control" multiple style="height: 120px;">
                                    <!-- Staff options will be loaded -->
                                </select>
                                <small style="color: #666; font-size: 11px;">Hold Ctrl/Cmd to select multiple staff</small>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="announcementExpiry">Expiry Date</label>
                                <input type="date" id="announcementExpiry" class="form-control">
                                <small style="color: #666; font-size: 11px;">Leave empty for no expiry</small>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <button type="submit" class="btn btn-success" id="createAnnouncementBtn">Create Announcement</button>
                            <button type="button" class="btn btn-danger" onclick="clearAnnouncementForm()">Clear Form</button>
                        </div>
                    </form>
                </div>
                
                <div class="card">
                    <h3>Active Announcements</h3>
                    <div id="activeAnnouncementsList">
                        <!-- Active announcements will be loaded here -->
                    </div>
                </div>
                
                <div class="card">
                    <h3>Expired Announcements</h3>
                    <div id="expiredAnnouncementsList">
                        <!-- Expired announcements will be loaded here -->
                    </div>
                </div>
            </div>
            
            <!-- Admin: Duty Roster Management -->
            <div class="section" id="adminDutyRosterSection">
                <div class="card">
                    <h3>Duty Roster Management</h3>
                    
                    <div class="tab-controls">
                        <button class="tab-btn active" onclick="showRosterTab('excelImport')">Excel Import</button>
                        <button class="tab-btn" onclick="showRosterTab('manualEntry')">Manual Entry</button>
                        <button class="tab-btn" onclick="showRosterTab('viewRoster')">View Roster</button>
                    </div>
                    
                    <!-- Excel Import Tab -->
                    <div id="excelImportTab" class="roster-tab active">
                        <div class="alert alert-info">
                            <strong>Instructions:</strong> Copy your Excel data and paste below. Format: Date in first column, then staff names as columns, duty times as rows.
                        </div>
                        
                        <div class="excel-import-area" onclick="document.getElementById('excelPasteBox').focus()">
                            <p>📋 <strong>Click here and paste Excel data</strong></p>
                            <p style="font-size: 12px; color: #666;">Format: Tab-separated values from Excel</p>
                        </div>
                        
                        <textarea id="excelPasteBox" class="excel-paste-box" placeholder="Paste Excel data here (Ctrl+V)...
Example:
Date	Irufan	Hussain	Mohamed
2024-01-01	08:00-16:00	16:00-00:00	00:00-08:00
2024-01-02	16:00-00:00	08:00-16:00	Off"></textarea>
                        
                        <div class="form-row" style="margin-top: 15px;">
                            <button class="btn btn-success" onclick="processExcelPaste()">Process Data</button>
                            <button class="btn btn-primary" onclick="loadSampleData()">Load Sample</button>
                            <button class="btn btn-danger" onclick="clearExcelPaste()">Clear</button>
                        </div>
                        
                        <div id="excelPreview" style="margin-top: 20px; display: none;">
                            <h4>Preview</h4>
                            <div class="table-container">
                                <table class="excel-table" id="excelPreviewTable">
                                    <!-- Preview will be shown here -->
                                </table>
                            </div>
                            <button class="btn btn-success" onclick="saveExcelData()" style="margin-top: 10px;">Save to Roster</button>
                        </div>
                    </div>
                    
                    <!-- Manual Entry Tab -->
                    <div id="manualEntryTab" class="roster-tab">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="rosterDate">Date</label>
                                <input type="date" id="rosterDate" class="form-control" value="">
                            </div>
                            <div class="form-group">
                                <label for="rosterStaffSingle">Staff</label>
                                <select id="rosterStaffSingle" class="form-control">
                                    <option value="">Select staff</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="rosterDutyTime">Duty Time</label>
                                <input type="text" id="rosterDutyTime" class="form-control" placeholder="e.g., 08:00-16:00 or Off">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <button class="btn btn-success" onclick="addRosterEntry()">Add Entry</button>
                            <button class="btn btn-primary" onclick="clearRosterForm()">Clear</button>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <h4>Today's Entries</h4>
                            <div class="table-container">
                                <table id="todayRosterTable">
                                    <thead>
                                        <tr>
                                            <th>Staff</th>
                                            <th>Duty Time</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Filled by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- View Roster Tab -->
                    <div id="viewRosterTab" class="roster-tab">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="viewRosterDate">View Date</label>
                                <input type="date" id="viewRosterDate" class="form-control" value="">
                            </div>
                            <div class="form-group">
                                <label for="viewRosterStaff">Staff Filter</label>
                                <select id="viewRosterStaff" class="form-control">
                                    <option value="">All Staff</option>
                                </select>
                            </div>
                        </div>
                        
                        <button class="btn btn-primary" onclick="loadRosterView()">Load Roster</button>
                        
                        <div id="rosterViewContainer" style="margin-top: 20px;">
                            <!-- Roster will be displayed here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Admin: Leave Balance Management -->
            <div class="section" id="adminLeaveBalanceSection">
                <div class="card">
                    <h3>Leave Balance Management</h3>
                    
                    <div class="tab-controls">
                        <button class="tab-btn active" onclick="showBalanceTab('bulkUpdate')">Bulk Update</button>
                        <button class="tab-btn" onclick="showBalanceTab('individual')">Individual</button>
                    </div>
                    
                    <!-- Bulk Update Tab -->
                    <div id="bulkUpdateTab" class="balance-tab active">
                        <div class="alert alert-info">
                            <strong>Instructions:</strong> Enter SL and FRL balances in days (e.g., 12.5 for 12 days and half day)
                        </div>
                        
                        <div class="table-container">
                            <table class="excel-table">
                                <thead>
                                    <tr>
                                        <th>Staff</th>
                                        <th>RC No</th>
                                        <th>SL Balance (Days)</th>
                                        <th>FRL Balance (Days)</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="bulkBalanceTable">
                                    <!-- Filled by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="form-row" style="margin-top: 15px;">
                            <button class="btn btn-success" onclick="saveAllBalances()">Save All Changes</button>
                            <button class="btn btn-primary" onclick="resetAllBalances()">Reset All to Default</button>
                        </div>
                    </div>
                    
                    <!-- Individual Tab -->
                    <div id="individualTab" class="balance-tab">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="balanceStaff">Select Staff</label>
                                <select id="balanceStaff" class="form-control">
                                    <option value="">Select staff</option>
                                </select>
                            </div>
                        </div>
                        
                        <div id="individualBalanceForm" style="display: none;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="individualSL">Sick Leave (Days)</label>
                                    <input type="number" id="individualSL" class="form-control" step="0.5" min="0">
                                </div>
                                <div class="form-group">
                                    <label for="individualFRL">FRL (Days)</label>
                                    <input type="number" id="individualFRL" class="form-control" step="0.5" min="0">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <button class="btn btn-success" onclick="saveIndividualBalance()">Save Balance</button>
                                <button class="btn btn-primary" onclick="resetIndividualBalance()">Reset to Default</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Admin: Approve Requests -->
            <div class="section" id="adminApprovalsSection">
                <div class="card">
                    <h3>Approve/Reject Requests</h3>
                    
                    <div class="tab-controls">
                        <button class="tab-btn active" onclick="showApprovalsTab('pending')">Pending</button>
                        <button class="tab-btn" onclick="showApprovalsTab('approved')">Approved</button>
                        <button class="tab-btn" onclick="showApprovalsTab('rejected')">Rejected</button>
                    </div>
                    
                    <div id="pendingApprovalsTab" class="approvals-tab active">
                        <div class="table-container">
                            <table class="request-history-table">
                                <thead>
                                    <tr>
                                        <th>Staff</th>
                                        <th>Type</th>
                                        <th>Date</th>
                                        <th>Details</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="adminApprovalsTable">
                                    <!-- Filled by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div id="approvedApprovalsTab" class="approvals-tab">
                        <div class="table-container">
                            <table class="request-history-table">
                                <thead>
                                    <tr>
                                        <th>Staff</th>
                                        <th>Type</th>
                                        <th>Date</th>
                                        <th>Details</th>
                                        <th>Status</th>
                                        <th>Applied By</th>
                                        <th>Applied At</th>
                                    </tr>
                                </thead>
                                <tbody id="approvedRequestsTable">
                                    <!-- Filled by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div id="rejectedApprovalsTab" class="approvals-tab">
                        <div class="table-container">
                            <table class="request-history-table">
                                <thead>
                                    <tr>
                                        <th>Staff</th>
                                        <th>Type</th>
                                        <th>Date</th>
                                        <th>Details</th>
                                        <th>Status</th>
                                        <th>Rejected By</th>
                                        <th>Rejected At</th>
                                    </tr>
                                </thead>
                                <tbody id="rejectedRequestsTable">
                                    <!-- Filled by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Admin: Request History -->
            <div class="section" id="adminRequestHistorySection">
                <div class="card">
                    <h3>All Requests History</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="historyFilterStaff">Filter by Staff</label>
                            <select id="historyFilterStaff" class="form-control">
                                <option value="">All Staff</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="historyFilterType">Filter by Type</label>
                            <select id="historyFilterType" class="form-control">
                                <option value="">All Types</option>
                                <option value="dutyChange">Duty Change</option>
                                <option value="leave">Leave</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="historyFilterStatus">Filter by Status</label>
                            <select id="historyFilterStatus" class="form-control">
                                <option value="">All Status</option>
                                <option value="pending">Pending</option>
                                <option value="approved">Approved</option>
                                <option value="rejected">Rejected</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="historyStartDate">From Date</label>
                            <input type="date" id="historyStartDate" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="historyEndDate">To Date</label>
                            <input type="date" id="historyEndDate" class="form-control">
                        </div>
                        <div class="form-group">
                            <button class="btn btn-primary" onclick="loadRequestHistory()" style="margin-top: 25px;">Filter</button>
                            <button class="btn btn-secondary" onclick="clearHistoryFilters()" style="margin-top: 25px;">Clear Filters</button>
                        </div>
                    </div>
                    
                    <div class="table-container" style="margin-top: 20px;">
                        <table class="request-history-table">
                            <thead>
                                <tr>
                                    <th>Staff</th>
                                    <th>Type</th>
                                    <th>Date</th>
                                    <th>Details</th>
                                    <th>Status</th>
                                    <th>Timeline</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="requestHistoryTable">
                                <!-- Filled by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
       // Complete JavaScript for Mobile-Responsive Duty Management System
let currentUser = null;
let allUsers = [];
let dutyRoster = {};
let leaveBalances = {};
let allRequests = [];
let announcements = [];
let userDisplayNameMap = {};
let firebaseReady = false;
let isMobile = false;
let touchStartY = 0;
let currentToastId = 0;

// Mobile detection
function detectMobile() {
    isMobile = window.innerWidth <= 768;
    document.body.classList.toggle('mobile', isMobile);
    return isMobile;
}

// Utility Functions
function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric' 
    });
}

function formatDateTime(timestamp) {
    const date = new Date(timestamp);
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
}

function formatTimeAgo(timestamp) {
    const now = new Date();
    const past = new Date(timestamp);
    const diffMs = now - past;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMins / 60);
    const diffDays = Math.floor(diffHours / 24);
    
    if (diffMins < 1) return 'just now';
    if (diffMins < 60) return `${diffMins} minute${diffMins !== 1 ? 's' : ''} ago`;
    if (diffHours < 24) return `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
    if (diffDays < 7) return `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;
    
    return formatDate(timestamp);
}

function getDateAfterDays(startDate, days) {
    const date = new Date(startDate);
    date.setDate(date.getDate() + days);
    return date.toISOString().split('T')[0];
}

function isValidDate(dateString) {
    const regex = /^\d{4}-\d{2}-\d{2}$/;
    if (!dateString.match(regex)) return false;
    const date = new Date(dateString);
    return date instanceof Date && !isNaN(date);
}

// UI Helper Functions
function showLoading(show) {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) {
        if (show) {
            overlay.classList.add('active');
        } else {
            overlay.classList.remove('active');
        }
    }
}

function showToast(message, type = 'info', duration = 5000) {
    const container = document.getElementById('toastContainer');
    if (!container) return;
    
    const toastId = 'toast-' + (++currentToastId);
    const toast = document.createElement('div');
    toast.id = toastId;
    toast.className = `toast ${type}`;
    toast.innerHTML = `
        <span class="toast-icon">
            ${type === 'success' ? '✅' : 
              type === 'error' ? '❌' : 
              type === 'warning' ? '⚠️' : 'ℹ️'}
        </span>
        <span>${message}</span>
    `;
    
    container.appendChild(toast);
    
    // Auto remove after duration
    setTimeout(() => {
        const toastElem = document.getElementById(toastId);
        if (toastElem) {
            toastElem.style.animation = 'slideInRight 0.3s ease reverse';
            setTimeout(() => {
                if (toastElem.parentNode) {
                    toastElem.parentNode.removeChild(toastElem);
                }
            }, 300);
        }
    }, duration);
    
    return toastId;
}

function showError(message, elementId = 'errorMessage') {
    const errorMsg = document.getElementById(elementId);
    if (!errorMsg) return;
    
    errorMsg.textContent = message;
    errorMsg.style.display = 'block';
    
    // Auto hide after 5 seconds
    setTimeout(() => {
        errorMsg.style.display = 'none';
    }, 5000);
    
    // Shake animation
    errorMsg.style.animation = 'none';
    setTimeout(() => {
        errorMsg.style.animation = 'shake 0.5s ease';
    }, 10);
}

// Mobile Gestures
function setupMobileGestures() {
    const content = document.getElementById('dashboardContent');
    if (!content) return;
    
    let touchStart = 0;
    
    content.addEventListener('touchstart', function(e) {
        touchStart = e.touches[0].clientY;
        touchStartY = touchStart;
    });
    
    content.addEventListener('touchmove', function(e) {
        if (touchStart === 0) return;
        
        const touchEnd = e.touches[0].clientY;
        const diff = touchStart - touchEnd;
        
        // Pull to refresh
        if (diff < -50 && window.scrollY === 0) {
            updateDashboard();
            touchStart = 0;
        }
    });
    
    content.addEventListener('touchend', function() {
        touchStart = 0;
    });
}

function setupMobileNavigation() {
    const menuToggle = document.getElementById('menuToggle');
    const menuOverlay = document.getElementById('menuOverlay');
    const dashboardNav = document.getElementById('dashboardNav');
    
    if (!menuToggle || !menuOverlay || !dashboardNav) return;
    
    menuToggle.addEventListener('click', function(e) {
        e.stopPropagation();
        dashboardNav.classList.add('active');
        menuOverlay.classList.add('active');
        document.body.style.overflow = 'hidden';
    });
    
    menuOverlay.addEventListener('click', function() {
        dashboardNav.classList.remove('active');
        menuOverlay.classList.remove('active');
        document.body.style.overflow = '';
    });
    
    // Close menu when clicking a nav item
    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            if (isMobile) {
                dashboardNav.classList.remove('active');
                menuOverlay.classList.remove('active');
                document.body.style.overflow = '';
            }
        });
    });
    
    // Swipe to close menu
    let startX = 0;
    dashboardNav.addEventListener('touchstart', function(e) {
        startX = e.touches[0].clientX;
    });
    
    dashboardNav.addEventListener('touchmove', function(e) {
        const currentX = e.touches[0].clientX;
        const diff = startX - currentX;
        
        if (diff > 50) { // Swipe left to close
            dashboardNav.classList.remove('active');
            menuOverlay.classList.remove('active');
            document.body.style.overflow = '';
        }
    });
}

function setupMobileForms() {
    // Add touch feedback to buttons
    document.querySelectorAll('.btn, .action-btn, .tab-btn, .nav-btn').forEach(btn => {
        btn.addEventListener('touchstart', function() {
            this.style.transform = 'scale(0.98)';
            this.style.opacity = '0.9';
        });
        
        btn.addEventListener('touchend', function() {
            this.style.transform = '';
            this.style.opacity = '';
        });
    });
    
    // Improve date input for mobile
    document.querySelectorAll('input[type="date"]').forEach(input => {
        input.addEventListener('focus', function() {
            if (isMobile) {
                this.type = 'text';
                setTimeout(() => {
                    this.type = 'date';
                    this.click();
                }, 100);
            }
        });
        
        // Add clear button for mobile
        if (isMobile) {
            const clearBtn = document.createElement('button');
            clearBtn.type = 'button';
            clearBtn.innerHTML = '🗑️';
            clearBtn.style.cssText = `
                position: absolute;
                right: 8px;
                top: 50%;
                transform: translateY(-50%);
                background: none;
                border: none;
                font-size: 16px;
                padding: 4px;
                z-index: 2;
            `;
            clearBtn.addEventListener('click', function() {
                input.value = '';
                input.dispatchEvent(new Event('change'));
            });
            
            const wrapper = document.createElement('div');
            wrapper.style.position = 'relative';
            input.parentNode.insertBefore(wrapper, input);
            wrapper.appendChild(input);
            wrapper.appendChild(clearBtn);
        }
    });
    
    // Handle keyboard on mobile
    let originalHeight = window.innerHeight;
    window.addEventListener('resize', function() {
        if (isMobile) {
            const newHeight = window.innerHeight;
            if (newHeight < originalHeight) { // Keyboard shown
                const activeElement = document.activeElement;
                if (activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA' || activeElement.tagName === 'SELECT')) {
                    setTimeout(() => {
                        activeElement.scrollIntoView({behavior: 'smooth', block: 'center'});
                    }, 300);
                }
            }
            originalHeight = newHeight;
        }
    });
}

function updateBottomNav() {
    const currentSection = document.querySelector('.section.active');
    if (!currentSection) return;
    
    const sectionId = currentSection.id.replace('Section', '');
    document.querySelectorAll('.bottom-nav-btn').forEach(btn => {
        btn.classList.remove('active');
        const btnText = btn.textContent.toLowerCase().trim();
        const sectionText = sectionId.toLowerCase().replace('my', '').replace('admin', '');
        
        if (btnText.includes(sectionText) || (sectionId === 'home' && btnText.includes('home'))) {
            btn.classList.add('active');
        }
    });
}

// Core Application Functions
function initApp() {
    detectMobile();
    window.addEventListener('resize', detectMobile);
    
    // Check Firebase
    if (typeof db === 'undefined') {
        showToast('Firebase is not initialized. Please check your configuration.', 'error');
        console.error('Firebase not initialized');
        return;
    }
    
    // Wait for user data
    const checkUserData = setInterval(() => {
        if (typeof users !== 'undefined') {
            clearInterval(checkUserData);
            firebaseReady = true;
            console.log('System initialized successfully');
            setupApplication();
        }
    }, 500);
    
    // Timeout after 10 seconds
    setTimeout(() => {
        if (!firebaseReady) {
            clearInterval(checkUserData);
            showToast('Failed to load user data. Please refresh the page.', 'error');
        }
    }, 10000);
}

function setupApplication() {
    if (!firebaseReady) {
        console.log('Waiting for Firebase...');
        setTimeout(setupApplication, 500);
        return;
    }
    
    console.log('Setting up application...');
    
    // Setup login
    const loginForm = document.getElementById('loginForm');
    if (loginForm) {
        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            handleLogin();
        });
    }
    
    // Setup mobile features
    setupMobileGestures();
    setupMobileNavigation();
    setupMobileForms();
    
    // Set minimum dates
    const today = new Date().toISOString().split('T')[0];
    const dateElements = [
        'changeDate', 'leaveDate', 'rosterDate', 'viewRosterDate',
        'allRosterStartDate', 'allRosterEndDate', 'historyStartDate', 'historyEndDate'
    ];
    
    dateElements.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            if (id === 'changeDate' || id === 'leaveDate') {
                element.min = today;
            }
            if (id === 'rosterDate' || id === 'viewRosterDate') {
                element.value = today;
            }
            if (id === 'allRosterStartDate') {
                element.value = today;
            }
            if (id === 'allRosterEndDate') {
                element.value = getDateAfterDays(today, 7);
            }
        }
    });
    
    // Set month input
    const myRosterMonth = document.getElementById('myRosterMonth');
    if (myRosterMonth) {
        myRosterMonth.value = today.substring(0, 7);
    }
    
    // Setup logout
    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', function() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('dutySystemSession');
                showToast('Logged out successfully', 'success');
                setTimeout(() => {
                    location.reload();
                }, 1000);
            }
        });
    }
    
    // Setup bottom navigation
    document.querySelectorAll('.bottom-nav-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const target = this.textContent.toLowerCase().trim();
            let section = 'home';
            
            if (target.includes('change')) section = 'dutyChange';
            else if (target.includes('leave')) section = 'leaveApplication';
            else if (target.includes('request')) section = 'myRequests';
            else if (target.includes('roster')) section = 'viewAllRoster';
            
            showSection(section);
        });
    });
    
    // Check session
    checkSession();
    
    // Prevent zoom on double tap
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function(event) {
        const now = Date.now();
        if (now - lastTouchEnd <= 300) {
            event.preventDefault();
        }
        lastTouchEnd = now;
    }, false);
    
    // Keep screen awake
    if ('wakeLock' in navigator && isMobile) {
        requestWakeLock();
    }
}

async function requestWakeLock() {
    try {
        const wakeLock = await navigator.wakeLock.request('screen');
        console.log('Wake Lock is active');
        
        // Handle release
        document.addEventListener('visibilitychange', async () => {
            if (document.visibilityState === 'visible' && currentUser) {
                await wakeLock.request('screen');
            }
        });
    } catch (err) {
        console.log('Wake Lock error:', err);
    }
}

function checkSession() {
    const session = localStorage.getItem('dutySystemSession');
    if (session) {
        try {
            const user = JSON.parse(session);
            if (user.expiry > Date.now()) {
                loginUser(user);
            } else {
                localStorage.removeItem('dutySystemSession');
                showToast('Session expired. Please login again.', 'warning');
            }
        } catch (e) {
            localStorage.removeItem('dutySystemSession');
            console.error('Session parse error:', e);
        }
    }
}

function handleLogin() {
    showLoading(true);
    
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value.trim();
    
    if (!username || !password) {
        showError('Please enter both username and password');
        showLoading(false);
        return;
    }
    
    if (!users || !Array.isArray(users)) {
        showError('User database not loaded');
        showLoading(false);
        return;
    }
    
    const user = users.find(u => u.username === username);
    
    if (!user) {
        showError('Invalid username or password');
        showLoading(false);
        return;
    }
    
    // Hash and check password
    const hashedPassword = sha256(password);
    
    if (hashedPassword === user.passwordHash) {
        const sessionData = {
            username: user.username,
            name: user.name,
            rcNo: user.RCNo,
            level: user.Level,
            expiry: Date.now() + (8 * 60 * 60 * 1000) // 8 hours
        };
        
        localStorage.setItem('dutySystemSession', JSON.stringify(sessionData));
        loginUser(sessionData);
        showLoading(false);
    } else {
        showError('Invalid username or password');
        showLoading(false);
    }
}

function loginUser(userData) {
    currentUser = userData;
    allUsers = users || [];
    
    console.log('User logged in:', currentUser);
    
    // Initialize user display name map
    initializeUserDisplayMap();
    
    // Update UI
    document.getElementById('loginContainer').style.display = 'none';
    document.getElementById('dashboardContainer').style.display = 'block';
    
    document.getElementById('userName').textContent = userData.name;
    document.getElementById('userRC').textContent = userData.rcNo;
    document.getElementById('userLevel').textContent = userData.level;
    document.getElementById('welcomeName').textContent = userData.name;
    
    // Show/hide admin sections
    const adminSections = [
        'adminDutyRosterBtn',
        'adminLeaveBalanceBtn',
        'adminApprovalsBtn',
        'adminRequestHistoryBtn',
        'adminAnnouncementsBtn'
    ];
    
    adminSections.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.style.display = userData.level === 'Supervisor' ? 'flex' : 'none';
        }
    });
    
    // Always show "View All Roster" button
    const viewAllRosterBtn = document.getElementById('viewAllRosterBtn');
    if (viewAllRosterBtn) {
        viewAllRosterBtn.style.display = 'flex';
    }
    
    // Initialize data and UI
    initializeData();
    setupEventListeners();
    updateDashboard();
    
    // Update bottom nav
    updateBottomNav();
    
    // Setup real-time listeners
    setTimeout(setupRealtimeListeners, 2000);
    
    // Show welcome message
    showToast(`Welcome back, ${userData.name}!`, 'success');
}

function initializeUserDisplayMap() {
    userDisplayNameMap = {};
    allUsers.forEach(user => {
        // Map common display names to usernames
        userDisplayNameMap[user.name] = user.username;
        userDisplayNameMap[user.RCNo] = user.username;
        userDisplayNameMap[user.username] = user.username;
        
        // For names with numbers like "Irufan1"
        if (user.name.includes('Irufan')) {
            const match = user.name.match(/Irufan\s*(\d*)/i);
            if (match && match[1]) {
                userDisplayNameMap[`Irufan${match[1]}`] = user.username;
            }
        }
        
        // Map lowercase variations
        const nameLower = user.name.toLowerCase();
        const usernameLower = user.username.toLowerCase();
        userDisplayNameMap[nameLower] = user.username;
        userDisplayNameMap[usernameLower] = user.username;
    });
    
    console.log('User display map initialized:', Object.keys(userDisplayNameMap).length, 'entries');
}

// Firebase Functions
async function loadDutyRoster() {
    try {
        console.log('Loading duty roster from Firebase...');
        const doc = await db.collection('dutyRoster').doc('current').get();
        
        if (doc.exists) {
            dutyRoster = doc.data() || {};
            console.log('Duty roster loaded:', Object.keys(dutyRoster).length, 'dates');
        } else {
            dutyRoster = {};
            await saveDutyRoster();
        }
        return dutyRoster;
    } catch (error) {
        console.error('Error loading duty roster:', error);
        showToast('Failed to load duty roster', 'error');
        dutyRoster = {};
        return dutyRoster;
    }
}

async function saveDutyRoster() {
    try {
        console.log('Saving duty roster to Firebase...');
        await db.collection('dutyRoster').doc('current').set(dutyRoster);
        console.log('Duty roster saved successfully');
        return true;
    } catch (error) {
        console.error('Error saving duty roster:', error);
        showToast('Failed to save duty roster', 'error');
        return false;
    }
}

async function loadLeaveBalances() {
    try {
        console.log('Loading leave balances from Firebase...');
        const doc = await db.collection('leaveBalances').doc('current').get();
        
        if (doc.exists) {
            leaveBalances = doc.data() || {};
            console.log('Leave balances loaded:', Object.keys(leaveBalances).length, 'users');
        } else {
            // Initialize with default balances
            leaveBalances = {};
            allUsers.forEach(user => {
                leaveBalances[user.username] = {
                    SL: 12,
                    FRL: 6
                };
            });
            await saveLeaveBalances();
        }
        return leaveBalances;
    } catch (error) {
        console.error('Error loading leave balances:', error);
        showToast('Failed to load leave balances', 'error');
        leaveBalances = {};
        return leaveBalances;
    }
}

async function saveLeaveBalances() {
    try {
        console.log('Saving leave balances to Firebase...');
        await db.collection('leaveBalances').doc('current').set(leaveBalances);
        console.log('Leave balances saved successfully');
        return true;
    } catch (error) {
        console.error('Error saving leave balances:', error);
        showToast('Failed to save leave balances', 'error');
        return false;
    }
}

async function loadAllRequests() {
    try {
        console.log('Loading all requests from Firebase...');
        const doc = await db.collection('requests').doc('all').get();
        
        if (doc.exists && doc.data().requests) {
            allRequests = doc.data().requests;
            console.log('Requests loaded:', allRequests.length, 'requests');
        } else {
            allRequests = [];
        }
        updateRequestCounts();
        return allRequests;
    } catch (error) {
        console.error('Error loading requests:', error);
        showToast('Failed to load requests', 'error');
        allRequests = [];
        return allRequests;
    }
}

async function saveAllRequests() {
    try {
        console.log('Saving all requests to Firebase...');
        await db.collection('requests').doc('all').set({ requests: allRequests });
        console.log('Requests saved successfully');
        return true;
    } catch (error) {
        console.error('Error saving requests:', error);
        showToast('Failed to save requests', 'error');
        return false;
    }
}

async function loadAnnouncements() {
    try {
        console.log('Loading announcements from Firebase...');
        const doc = await db.collection('announcements').doc('all').get();
        
        if (doc.exists && doc.data().announcements) {
            announcements = doc.data().announcements;
            console.log('Announcements loaded:', announcements.length, 'announcements');
        } else {
            announcements = [];
            await saveAnnouncements();
        }
        return announcements;
    } catch (error) {
        console.error('Error loading announcements:', error);
        showToast('Failed to load announcements', 'error');
        announcements = [];
        return announcements;
    }
}

async function saveAnnouncements() {
    try {
        console.log('Saving announcements to Firebase...');
        await db.collection('announcements').doc('all').set({ announcements: announcements });
        console.log('Announcements saved successfully');
        return true;
    } catch (error) {
        console.error('Error saving announcements:', error);
        showToast('Failed to save announcements', 'error');
        return false;
    }
}

async function initializeData() {
    showLoading(true);
    
    try {
        console.log('Initializing all data from Firebase...');
        
        await Promise.all([
            loadDutyRoster(),
            loadLeaveBalances(),
            loadAllRequests(),
            loadAnnouncements()
        ]);
        
        console.log('All data loaded successfully');
        
        // Update user's balance display
        updateUserBalance();
        
        // Check if today is loaded in dashboard
        if (document.getElementById('homeSection').classList.contains('active')) {
            loadHomeAnnouncements();
        }
        
        showLoading(false);
        return true;
    } catch (error) {
        console.error('Error initializing data:', error);
        showToast('Failed to load data. Please refresh.', 'error');
        showLoading(false);
        return false;
    }
}

function updateUserBalance() {
    if (!currentUser) return;
    
    const balance = leaveBalances[currentUser.username] || {SL: 0, FRL: 0};
    document.getElementById('slBalance').textContent = balance.SL.toFixed(1);
    document.getElementById('frlBalance').textContent = balance.FRL.toFixed(1);
}

function updateRequestCounts() {
    if (!currentUser) return;
    
    // Count pending requests for current user
    const pendingForUser = allRequests.filter(req => 
        req.status === 'pending' && 
        req.type === 'dutyChange' && 
        req.toUsername === currentUser.username
    ).length;
    
    const pendingBtn = document.getElementById('pendingRequestsBtn');
    const countSpan = document.getElementById('pendingCount');
    
    if (pendingForUser > 0) {
        pendingBtn.style.display = 'flex';
        countSpan.textContent = pendingForUser;
    } else {
        pendingBtn.style.display = 'none';
    }
    
    // Count my requests
    const myRequestsCount = allRequests.filter(req => 
        req.fromUsername === currentUser.username && 
        req.status === 'pending'
    ).length;
    
    const myRequestsCountSpan = document.getElementById('myRequestsCount');
    if (myRequestsCount > 0) {
        myRequestsCountSpan.textContent = myRequestsCount;
        myRequestsCountSpan.style.display = 'inline';
    } else {
        myRequestsCountSpan.style.display = 'none';
    }
    
    // Update notification dot for supervisor
    if (currentUser.level === 'Supervisor') {
        const pendingRequests = allRequests.filter(req => 
            req.status === 'pending' && 
            (req.type === 'leave' || req.type === 'dutyChange')
        ).length;
        
        const notificationDot = document.getElementById('historyNotification');
        if (pendingRequests > 0) {
            notificationDot.style.display = 'inline-block';
        } else {
            notificationDot.style.display = 'none';
        }
    }
}

// Navigation Functions
function showSection(sectionId) {
    // Hide all sections
    document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
    });
    
    // Update navigation buttons
    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.getAttribute('data-section') === sectionId) {
            btn.classList.add('active');
        }
    });
    
    // Show selected section
    const section = document.getElementById(sectionId + 'Section');
    if (section) {
        section.classList.add('active');
        
        // Update bottom nav
        updateBottomNav();
        
        // Load section data
        loadSectionData(sectionId);
        
        // Scroll to top on mobile
        if (isMobile) {
            const content = document.getElementById('dashboardContent');
            if (content) {
                content.scrollTop = 0;
            }
        }
    }
}

function loadSectionData(sectionId) {
    switch(sectionId) {
        case 'home':
            loadHomeAnnouncements();
            updateDashboard();
            break;
        case 'dutyChange':
            loadDutyChangeForm();
            break;
        case 'leaveApplication':
            loadLeaveForm();
            break;
        case 'myRequests':
            loadMyRequests();
            break;
        case 'viewMyRoster':
            loadMyRoster();
            break;
        case 'viewAllRoster':
            loadAllRoster();
            break;
        case 'pendingRequests':
            loadPendingRequests();
            break;
        case 'adminAnnouncements':
            loadAnnouncementsAdmin();
            break;
        case 'adminDutyRoster':
            loadDutyRosterAdmin();
            break;
        case 'adminLeaveBalance':
            loadLeaveBalanceAdmin();
            break;
        case 'adminApprovals':
            loadAdminApprovals();
            break;
        case 'adminRequestHistory':
            loadAdminRequestHistory();
            break;
    }
}

// Dashboard Functions
function updateDashboard() {
    showLoading(true);
    
    // Update today's duty
    const today = new Date().toISOString().split('T')[0];
    const todayDutyTime = document.getElementById('todayDutyTime');
    if (todayDutyTime) {
        if (dutyRoster[today] && dutyRoster[today][currentUser.username]) {
            const duty = dutyRoster[today][currentUser.username];
            todayDutyTime.textContent = duty === 'Off' ? 'Off Duty' : duty;
            todayDutyTime.className = duty === 'Off' ? 'status-off' : 'status-pending';
        } else {
            todayDutyTime.textContent = 'Not Scheduled';
            todayDutyTime.className = 'status-off';
        }
    }
    
    // Find next duty
    const nextDutyTime = document.getElementById('nextDutyTime');
    if (nextDutyTime) {
        const tomorrow = new Date();
        let nextDutyFound = false;
        
        for (let i = 1; i <= 7; i++) {
            tomorrow.setDate(tomorrow.getDate() + 1);
            const dateStr = tomorrow.toISOString().split('T')[0];
            if (dutyRoster[dateStr] && dutyRoster[dateStr][currentUser.username]) {
                const duty = dutyRoster[dateStr][currentUser.username];
                if (duty !== 'Off') {
                    nextDutyTime.textContent = `${formatDate(dateStr)}: ${duty}`;
                    nextDutyTime.className = 'status-pending';
                    nextDutyFound = true;
                    break;
                }
            }
        }
        
        if (!nextDutyFound) {
            nextDutyTime.textContent = 'No upcoming duty';
            nextDutyTime.className = 'status-off';
        }
    }
    
    // Update balance
    updateUserBalance();
    
    // Load announcements
    loadHomeAnnouncements();
    
    // Check for recent activity
    checkForUserUpdates();
    
    // Show completion
    setTimeout(() => {
        showLoading(false);
        if (isMobile) {
            showToast('Dashboard updated', 'success', 2000);
        }
    }, 500);
}

function loadHomeAnnouncements() {
    const container = document.getElementById('homeAnnouncements');
    if (!container) return;
    
    container.innerHTML = '';
    
    const now = new Date();
    const activeAnnouncements = announcements.filter(ann => {
        if (ann.status === 'expired' || ann.status === 'archived') return false;
        if (ann.expiry && new Date(ann.expiry) < now) return false;
        
        // Check if announcement is for current user
        if (ann.target === 'all') return true;
        if (ann.target === 'specific' && ann.targetUsers && ann.targetUsers.includes(currentUser.username)) return true;
        return false;
    });
    
    if (activeAnnouncements.length === 0) {
        const emptyState = document.createElement('div');
        emptyState.className = 'empty-state';
        emptyState.innerHTML = `
            <div class="empty-state-icon">📢</div>
            <div class="empty-state-title">No Announcements</div>
            <div class="empty-state-description">Check back later for updates</div>
        `;
        container.appendChild(emptyState);
        return;
    }
    
    // Sort by priority and date
    activeAnnouncements.sort((a, b) => {
        const priorityOrder = {high: 0, medium: 1, low: 2};
        if (priorityOrder[a.priority] !== priorityOrder[b.priority]) {
            return priorityOrder[a.priority] - priorityOrder[b.priority];
        }
        return new Date(b.createdAt) - new Date(a.createdAt);
    });
    
    // Limit to 3 announcements on mobile
    const displayAnnouncements = isMobile ? activeAnnouncements.slice(0, 3) : activeAnnouncements;
    
    displayAnnouncements.forEach(ann => {
        const announcementDiv = document.createElement('div');
        announcementDiv.className = `announcement-banner priority-${ann.priority}`;
        
        let targetText = '';
        if (ann.target === 'all') {
            targetText = 'All Staff';
        } else {
            const targetNames = ann.targetUsers.map(username => {
                const user = allUsers.find(u => u.username === username);
                return user ? user.name : username;
            }).join(', ');
            targetText = `For: ${targetNames}`;
        }
        
        announcementDiv.innerHTML = `
            <div class="announcement-title">
                <span class="announcement-icon">📢</span>
                ${ann.title}
            </div>
            <div class="announcement-content">${ann.content}</div>
            <div class="announcement-meta">
                <div>
                    By: ${ann.createdBy} • ${formatTimeAgo(ann.createdAt)}
                    ${ann.expiry ? `<br>Expires: ${formatDate(ann.expiry)}` : ''}
                </div>
                <div class="announcement-target">${targetText}</div>
            </div>
        `;
        
        container.appendChild(announcementDiv);
    });
    
    // Show "show more" on mobile if there are more announcements
    if (isMobile && activeAnnouncements.length > 3) {
        const showMoreBtn = document.createElement('button');
        showMoreBtn.className = 'btn btn-primary btn-block';
        showMoreBtn.style.marginTop = '10px';
        showMoreBtn.innerHTML = '<span>📋</span> Show All Announcements';
        showMoreBtn.onclick = function() {
            showSection('adminAnnouncements');
        };
        container.appendChild(showMoreBtn);
    }
}

function checkForUserUpdates() {
    if (!currentUser) return;
    
    const userReqs = allRequests.filter(req => 
        req.fromUsername === currentUser.username && 
        req.status !== 'pending' &&
        req.history && req.history.length > 0
    );
    
    // Find requests updated in the last 24 hours
    const twentyFourHoursAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
    const recentUpdates = userReqs.filter(req => {
        const lastUpdate = new Date(req.history[req.history.length - 1].timestamp);
        return lastUpdate > twentyFourHoursAgo;
    });
    
    if (recentUpdates.length > 0) {
        showUserUpdates(recentUpdates);
    }
}

function showUserUpdates(updates) {
    const notificationContainer = document.getElementById('homeNotifications');
    if (!notificationContainer) return;
    
    let html = '<strong>Recent Updates:</strong><br>';
    
    updates.forEach(req => {
        const lastEvent = req.history[req.history.length - 1];
        const timeAgo = formatTimeAgo(lastEvent.timestamp);
        
        if (req.type === 'dutyChange') {
            html += `• Duty change ${req.status} ${timeAgo}<br>`;
        } else {
            html += `• Leave ${req.status} ${timeAgo}<br>`;
        }
    });
    
    notificationContainer.innerHTML = `<div class="alert alert-info">${html}</div>`;
    notificationContainer.style.display = 'block';
    
    // Auto hide after 10 seconds
    setTimeout(() => {
        notificationContainer.style.display = 'none';
    }, 10000);
}

// Duty Change Functions
function loadDutyChangeForm() {
    // Set default date to tomorrow
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    document.getElementById('changeDate').value = tomorrow.toISOString().split('T')[0];
    
    // Populate staff dropdown (exclude current user)
    const staffSelect = document.getElementById('requestToStaff');
    if (staffSelect) {
        staffSelect.innerHTML = '<option value="">Select staff member</option>';
        
        allUsers.forEach(user => {
            if (user.username !== currentUser.username && user.Level === 'User') {
                const option = document.createElement('option');
                option.value = user.username;
                option.textContent = `${user.name} (RC: ${user.RCNo})`;
                staffSelect.appendChild(option);
            }
        });
    }
    
    // Load duty times
    loadUserDutyTimes('changeDutyTime', tomorrow.toISOString().split('T')[0]);
}

function loadUserDutyTimes(selectId, date) {
    const select = document.getElementById(selectId);
    if (!select) return;
    
    select.innerHTML = '<option value="">Select duty time</option>';
    
    if (!date || !currentUser) return;
    
    const dutyTime = dutyRoster[date] && dutyRoster[date][currentUser.username];
    if (dutyTime) {
        const option = document.createElement('option');
        option.value = dutyTime;
        option.textContent = dutyTime === 'Off' ? 'Off Duty' : dutyTime;
        select.appendChild(option);
    } else {
        const option = document.createElement('option');
        option.value = 'No Duty';
        option.textContent = 'No duty scheduled';
        select.appendChild(option);
    }
}

function loadStaffDutyTimes(selectId, date, username) {
    const select = document.getElementById(selectId);
    if (!select) return;
    
    select.innerHTML = '<option value="">Select duty time</option>';
    
    if (!date || !username) return;
    
    const dutyTime = dutyRoster[date] && dutyRoster[date][username];
    if (dutyTime) {
        const option = document.createElement('option');
        option.value = dutyTime;
        option.textContent = dutyTime === 'Off' ? 'Off Duty' : dutyTime;
        select.appendChild(option);
    } else {
        const option = document.createElement('option');
        option.value = 'No Duty';
        option.textContent = 'No duty scheduled';
        select.appendChild(option);
    }
}

async function submitDutyChange() {
    const date = document.getElementById('changeDate').value;
    const dutyTime = document.getElementById('changeDutyTime').value;
    const toStaff = document.getElementById('requestToStaff').value;
    const toRcNo = document.getElementById('requestToRcNo').value;
    const toDutyTime = document.getElementById('requestToDutyTime').value;
    const reason = document.getElementById('changeReason').value;
    
    if (!date || !dutyTime || !toStaff || !toDutyTime) {
        showToast('Please fill all required fields', 'warning');
        return;
    }
    
    if (dutyTime === 'No Duty' || toDutyTime === 'No Duty') {
        showToast('Cannot request duty change when no duty is scheduled', 'warning');
        return;
    }
    
    const toUser = allUsers.find(u => u.username === toStaff);
    if (!toUser) {
        showToast('Selected staff not found', 'error');
        return;
    }
    
    // Check if date is at least 24 hours from now
    const requestDate = new Date(date);
    const now = new Date();
    const hoursDiff = (requestDate - now) / (1000 * 60 * 60);
    
    if (hoursDiff < 24) {
        showToast('Duty changes must be requested at least 24 hours in advance', 'warning');
        return;
    }
    
    const request = {
        id: 'req_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
        type: 'dutyChange',
        fromUsername: currentUser.username,
        fromName: currentUser.name,
        fromRcNo: currentUser.rcNo,
        date: date,
        dutyTime: dutyTime,
        toUsername: toStaff,
        toName: toUser.name,
        toRcNo: toRcNo,
        toDutyTime: toDutyTime,
        reason: reason,
        status: 'pending',
        timestamp: new Date().toISOString(),
        history: [{
            action: 'created',
            by: currentUser.name,
            timestamp: new Date().toISOString()
        }]
    };
    
    allRequests.push(request);
    
    // Save to Firebase
    const success = await saveAllRequests();
    if (success) {
        updateRequestCounts();
        showToast('Duty change request submitted!', 'success');
        showSection('home');
        document.getElementById('dutyChangeForm').reset();
    }
}

// Leave Application Functions
function loadLeaveForm() {
    // Set default date to tomorrow
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    document.getElementById('leaveDate').value = tomorrow.toISOString().split('T')[0];
    
    // Load duty times
    loadUserDutyTimes('leaveDutyTime', tomorrow.toISOString().split('T')[0]);
    
    updateLeaveRules();
}

function updateLeaveRules() {
    const leaveType = document.getElementById('leaveType').value;
    const leaveDate = document.getElementById('leaveDate').value;
    const dutyTime = document.getElementById('leaveDutyTime').value;
    const alertDiv = document.getElementById('leaveRulesAlert');
    const submitBtn = document.getElementById('submitLeaveBtn');
    
    if (!alertDiv || !submitBtn) return;
    
    if (!leaveType || !leaveDate || !dutyTime || dutyTime === 'No Duty') {
        alertDiv.className = 'alert alert-warning';
        alertDiv.textContent = 'Please select leave type, date and duty time';
        submitBtn.disabled = true;
        return;
    }
    
    if (dutyTime === 'Off') {
        alertDiv.className = 'alert alert-warning';
        alertDiv.textContent = 'You are off duty on this date. No leave needed.';
        submitBtn.disabled = true;
        return;
    }
    
    const dutyStart = dutyTime.split('-')[0];
    const dutyDateTime = new Date(leaveDate + 'T' + dutyStart + ':00');
    const now = new Date();
    const hoursBeforeDuty = (dutyDateTime - now) / (1000 * 60 * 60);
    
    let canApply = false;
    let message = '';
    
    if (leaveType === 'Sick Leave') {
        canApply = hoursBeforeDuty >= 2;
        message = canApply 
            ? '✅ You can apply for Sick Leave (2+ hours before duty)'
            : `❌ Sick Leave must be applied at least 2 hours before duty (${Math.ceil(2 - hoursBeforeDuty)} more hours needed)`;
    } else if (leaveType === 'FRL') {
        canApply = hoursBeforeDuty >= 1;
        message = canApply
            ? '✅ You can apply for FRL (1+ hour before duty)'
            : `❌ FRL must be applied at least 1 hour before duty (${Math.ceil(1 - hoursBeforeDuty)} more hours needed)`;
    }
    
    alertDiv.className = canApply ? 'alert alert-success' : 'alert alert-danger';
    alertDiv.innerHTML = `<strong>${leaveType} Rules:</strong><br>${message}`;
    submitBtn.disabled = !canApply;
}

async function submitLeaveApplication() {
    const leaveType = document.getElementById('leaveType').value;
    const date = document.getElementById('leaveDate').value;
    const dutyTime = document.getElementById('leaveDutyTime').value;
    const duration = parseFloat(document.getElementById('leaveDuration').value);
    const reason = document.getElementById('leaveReason').value;
    
    if (!leaveType || !date || !dutyTime || !reason) {
        showToast('Please fill all required fields', 'warning');
        return;
    }
    
    if (dutyTime === 'No Duty' || dutyTime === 'Off') {
        showToast('You are off duty on this date. No leave needed.', 'warning');
        return;
    }
    
    // Check balance
    const userBalance = leaveBalances[currentUser.username];
    if (!userBalance) {
        showToast('Error: User balance not found', 'error');
        return;
    }
    
    // Validate sufficient balance
    if (leaveType === 'Sick Leave' && userBalance.SL < duration) {
        showToast(`Insufficient Sick Leave balance. Available: ${userBalance.SL.toFixed(1)} days, Requested: ${duration} days`, 'warning');
        return;
    }
    
    if (leaveType === 'FRL' && userBalance.FRL < duration) {
        showToast(`Insufficient FRL balance. Available: ${userBalance.FRL.toFixed(1)} days, Requested: ${duration} days`, 'warning');
        return;
    }
    
    const request = {
        id: 'req_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
        type: 'leave',
        leaveType: leaveType,
        fromUsername: currentUser.username,
        fromName: currentUser.name,
        fromRcNo: currentUser.rcNo,
        date: date,
        dutyTime: dutyTime,
        duration: duration,
        reason: reason,
        status: 'pending',
        timestamp: new Date().toISOString(),
        history: [{
            action: 'created',
            by: currentUser.name,
            timestamp: new Date().toISOString()
        }]
    };
    
    allRequests.push(request);
    
    // Save to Firebase
    const success = await saveAllRequests();
    if (success) {
        updateRequestCounts();
        showToast('Leave application submitted! It will be processed after supervisor approval.', 'success');
        showSection('home');
        document.getElementById('leaveApplicationForm').reset();
        
        // Force dashboard update
        updateDashboard();
        updateUserBalance();
    }
}

// My Requests Functions
function loadMyRequests() {
    const tbody = document.getElementById('myRequestsTable');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    const myReqs = allRequests.filter(req => req.fromUsername === currentUser.username);
    
    if (myReqs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px;">No requests found</td></tr>';
        return;
    }
    
    // Sort by timestamp descending (newest first)
    myReqs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    
    myReqs.forEach(req => {
        const tr = document.createElement('tr');
        
        let details = '';
        if (req.type === 'dutyChange') {
            details = `Swap with ${req.toName} (${req.toDutyTime})`;
            if (req.reason) details += `<br><small style="color: #666;">Reason: ${req.reason}</small>`;
        } else {
            details = `${req.leaveType} - ${req.duration} day(s)`;
            if (req.reason) details += `<br><small style="color: #666;">Reason: ${req.reason}</small>`;
        }
        
        let statusClass = 'status-' + req.status;
        let statusText = req.status.charAt(0).toUpperCase() + req.status.slice(1);
        
        // Get last update time
        let lastUpdate = 'Just now';
        if (req.history && req.history.length > 0) {
            const lastAction = req.history[req.history.length - 1];
            lastUpdate = formatTimeAgo(lastAction.timestamp);
        }
        
        tr.innerHTML = `
            <td>${req.type === 'dutyChange' ? 'Duty Change' : 'Leave'}</td>
            <td>${req.date}</td>
            <td>${details}</td>
            <td class="${statusClass}">${statusText}</td>
            <td class="timestamp">${lastUpdate}</td>
            <td>
                ${req.status === 'pending' ? 
                    `<button class="action-btn view" onclick="cancelRequest('${req.id}')">Cancel</button>` : ''}
                ${req.status === 'approved' ? 
                    `<span class="status-approved">✓ Applied</span>` : ''}
            </td>
        `;
        
        tbody.appendChild(tr);
    });
}

async function cancelRequest(requestId) {
    if (!confirm('Are you sure you want to cancel this request?')) return;
    
    const request = allRequests.find(req => req.id === requestId);
    if (!request) {
        showToast('Request not found', 'error');
        return;
    }
    
    if (request.status !== 'pending') {
        showToast('Only pending requests can be cancelled', 'warning');
        return;
    }
    
    request.status = 'cancelled';
    request.history.push({
        action: 'cancelled',
        by: currentUser.name,
        timestamp: new Date().toISOString()
    });
    
    const success = await saveAllRequests();
    if (success) {
        loadMyRequests();
        updateRequestCounts();
        showToast('Request cancelled successfully', 'success');
    }
}

// My Roster Functions
function loadMyRoster() {
    const container = document.getElementById('myRosterContainer');
    if (!container) return;
    
    const monthInput = document.getElementById('myRosterMonth').value;
    const viewType = document.getElementById('myRosterViewType').value;
    
    if (!monthInput) {
        container.innerHTML = '<div class="alert alert-warning">Please select a month</div>';
        return;
    }
    
    const [year, month] = monthInput.split('-');
    const startDate = new Date(year, month - 1, 1);
    const endDate = new Date(year, month, 0);
    
    if (viewType === 'calendar') {
        displayCalendarView(container, startDate, endDate, year, month, true);
    } else {
        displayTableView(container, startDate, endDate, year, month, true);
    }
}

function displayTableView(container, startDate, endDate, year, month, isMyRoster = false) {
    let html = `<h4 style="margin-bottom: 15px;">${isMyRoster ? 'Your Roster' : 'Staff Roster'} for ${month}/${year}</h4>`;
    
    if (isMyRoster) {
        html += '<div class="table-container"><table><thead><tr><th>Date</th><th>Day</th><th>Duty Time</th><th>Status</th></tr></thead><tbody>';
        
        const today = new Date().toISOString().split('T')[0];
        let dutyCount = 0;
        let offCount = 0;
        
        for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
            const dateStr = d.toISOString().split('T')[0];
            const dayName = d.toLocaleDateString('en-US', { weekday: 'short' });
            
            let dutyTime = 'Not Scheduled';
            let statusClass = '';
            let statusText = '';
            
            // Check for approved leave
            const approvedLeave = allRequests.find(req => 
                req.fromUsername === currentUser.username &&
                req.type === 'leave' &&
                req.status === 'approved' &&
                req.date === dateStr
            );
            
            if (approvedLeave) {
                dutyTime = `${approvedLeave.leaveType} - ${approvedLeave.duration} day(s)`;
                statusClass = 'status-approved';
                statusText = 'On Leave';
            } else if (dutyRoster[dateStr] && dutyRoster[dateStr][currentUser.username]) {
                dutyTime = dutyRoster[dateStr][currentUser.username];
                if (dutyTime === 'Off') {
                    statusClass = 'status-off';
                    statusText = 'Off Duty';
                    offCount++;
                } else {
                    statusClass = dateStr < today ? 'status-completed' : 'status-pending';
                    statusText = dateStr < today ? 'Completed' : 'Scheduled';
                    dutyCount++;
                }
            } else {
                statusClass = 'status-pending';
                statusText = 'Not Scheduled';
            }
            
            const isToday = dateStr === today;
            const rowClass = isToday ? 'style="background-color: rgba(67, 97, 238, 0.1);"' : '';
            
            html += `<tr ${rowClass}>
                <td>${dateStr}${isToday ? ' <span style="color: var(--primary); font-weight: bold;">(Today)</span>' : ''}</td>
                <td>${dayName}</td>
                <td>${dutyTime}</td>
                <td class="${statusClass}">${statusText}</td>
            </tr>`;
        }
        
        html += '</tbody></table></div>';
        
        // Add summary
        html += `<div class="alert alert-info" style="margin-top: 15px;">
            <strong>Summary:</strong> ${dutyCount} duty days, ${offCount} off days
        </div>`;
    } else {
        // Display all staff roster
        html += displayAllRosterTable(startDate, endDate, year, month);
    }
    
    container.innerHTML = html;
}

// Duty Time Color Mapping
function getDutyTimeClass(dutyTime) {
    if (!dutyTime || dutyTime === 'Off' || dutyTime === 'Not Scheduled') {
        return 'off-day-cell';
    }
    
    if (dutyTime === 'Leave' || dutyTime.includes('Leave')) {
        return 'duty-leave';
    }
    
    // Normalize the duty time format
    const normalizedTime = dutyTime.replace(/\s/g, '').toUpperCase();
    
    // Common duty times mapping
    const timeMappings = {
        '0730-1530': 'duty-0730-1530',
        '0830-1630': 'duty-0830-1630',
        '1030-1830': 'duty-1030-1830',
        '1530-2330': 'duty-1530-2330',
        '1630-0030': 'duty-1630-0030',
        '1730-0130': 'duty-1730-0130',
        '0030-0830': 'duty-0030-0830',
        '0800-1600': 'duty-0830-1630',
        '0700-1500': 'duty-0730-1530',
        '1600-0000': 'duty-1630-0030',
        '0000-0800': 'duty-0030-0830',
        '0900-1700': 'duty-0830-1630',
        '1000-1800': 'duty-1030-1830'
    };
    
    // Try exact match
    if (timeMappings[normalizedTime]) {
        return timeMappings[normalizedTime];
    }
    
    // Try to extract start time
    if (normalizedTime.includes('-')) {
        const [startStr] = normalizedTime.split('-');
        const startHour = startStr.substring(0, 2);
        
        // Map by start hour
        if (startHour === '07') return 'duty-0730-1530';
        if (startHour === '08') return 'duty-0830-1630';
        if (startHour === '10') return 'duty-1030-1830';
        if (startHour === '15') return 'duty-1530-2330';
        if (startHour === '16') return 'duty-1630-0030';
        if (startHour === '17') return 'duty-1730-0130';
        if (startHour === '00') return 'duty-0030-0830';
    }
    
    return 'duty-other';
}

function displayAllRosterTable(startDate, endDate, year, month) {
    const today = new Date().toISOString().split('T')[0];
    let html = `<div class="roster-all-view"><table><thead><tr><th>Date</th><th>Day</th>`;
    
    // Add staff headers
    allUsers.forEach(user => {
        if (user.Level === 'User') {
            html += `<th class="staff-name">${user.name}<br><small>${user.RCNo}</small></th>`;
        }
    });
    
    html += '</tr></thead><tbody>';
    
    // Add rows for each date
    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
        const dateStr = d.toISOString().split('T')[0];
        const dayName = d.toLocaleDateString('en-US', { weekday: 'short' });
        const isToday = dateStr === today;
        
        html += `<tr ${isToday ? 'style="background-color: rgba(67, 97, 238, 0.1);"' : ''}>`;
        html += `<td>${dateStr}${isToday ? ' <span style="color: var(--primary); font-weight: bold;">(Today)</span>' : ''}</td>`;
        html += `<td>${dayName}</td>`;
        
        // Add duty times for each staff
        allUsers.forEach(user => {
            if (user.Level === 'User') {
                let dutyTime = 'Not Scheduled';
                let cellClass = '';
                let leaveIndicator = '';
                
                // Check for approved leave
                const approvedLeave = allRequests.find(req => 
                    req.fromUsername === user.username &&
                    req.type === 'leave' &&
                    req.status === 'approved' &&
                    req.date === dateStr
                );
                
                if (approvedLeave) {
                    dutyTime = 'Leave';
                    cellClass = 'duty-leave';
                    leaveIndicator = `<span class="leave-indicator" title="${approvedLeave.leaveType} - ${approvedLeave.duration} day(s)">${approvedLeave.leaveType === 'Sick Leave' ? 'SL' : 'FRL'}</span>`;
                } else if (dutyRoster[dateStr] && dutyRoster[dateStr][user.username]) {
                    dutyTime = dutyRoster[dateStr][user.username];
                    cellClass = getDutyTimeClass(dutyTime);
                } else {
                    cellClass = 'off-day-cell';
                    dutyTime = 'Off';
                }
                
                if (isToday) {
                    cellClass += ' today-cell';
                }
                
                html += `<td class="${cellClass}">${dutyTime} ${leaveIndicator}</td>`;
            }
        });
        
        html += '</tr>';
    }
    
    html += '</tbody></table></div>';
    
    // Add legend
    html += createRosterLegend();
    
    return html;
}

function displayCalendarView(container, startDate, endDate, year, month, isMyRoster = false) {
    let html = `<h4 style="margin-bottom: 15px;">${isMyRoster ? 'Your Roster' : 'Staff Roster'} for ${month}/${year} - Calendar View</h4>`;
    html += '<div class="calendar-grid">';
    
    // Add day headers
    const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    days.forEach(day => {
        html += `<div class="calendar-day" style="text-align: center; font-weight: bold; background: var(--gray-light);">${day}</div>`;
    });
    
    // Get first day of month
    const firstDay = startDate.getDay();
    
    // Add empty cells for days before the first day of month
    for (let i = 0; i < firstDay; i++) {
        html += '<div class="calendar-day"></div>';
    }
    
    const today = new Date().toISOString().split('T')[0];
    
    // Add calendar days
    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
        const dateStr = d.toISOString().split('T')[0];
        const dayNum = d.getDate();
        const isToday = dateStr === today;
        
        let dayClass = 'calendar-day';
        let timeText = '';
        
        if (isMyRoster) {
            // Check for approved leave
            const approvedLeave = allRequests.find(req => 
                req.fromUsername === currentUser.username &&
                req.type === 'leave' &&
                req.status === 'approved' &&
                req.date === dateStr
            );
            
            if (approvedLeave) {
                dayClass += ' off-day';
                timeText = `${approvedLeave.leaveType === 'Sick Leave' ? 'SL' : 'FRL'}`;
            } else if (dutyRoster[dateStr] && dutyRoster[dateStr][currentUser.username]) {
                const dutyTime = dutyRoster[dateStr][currentUser.username];
                if (dutyTime === 'Off') {
                    dayClass += ' off-day';
                    timeText = 'Off';
                } else {
                    dayClass += ' duty-day';
                    timeText = dutyTime.split('-')[0]; // Show start time only
                }
            }
        }
        
        if (isToday) {
            dayClass += ' today';
        }
        
        html += `<div class="${dayClass}">
            <div class="day-header">${dayNum}</div>
            ${timeText ? `<div class="duty-time">${timeText}</div>` : ''}
        </div>`;
    }
    
    html += '</div>';
    
    // Add legend
    html += createCalendarLegend();
    
    container.innerHTML = html;
}

function createRosterLegend() {
    return `
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background: linear-gradient(135deg, rgba(255, 241, 118, 0.2), rgba(255, 224, 102, 0.3)); border-left: 4px solid #ffd700;"></div>
                <span>07:30 Shift</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: linear-gradient(135deg, rgba(220, 180, 252, 0.2), rgba(200, 160, 255, 0.3)); border-left: 4px solid #8b5cf6;"></div>
                <span>08:30 Shift</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: linear-gradient(135deg, rgba(253, 230, 138, 0.2), rgba(252, 211, 77, 0.3)); border-left: 4px solid #fbbf24;"></div>
                <span>10:30 Shift</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: linear-gradient(135deg, rgba(147, 197, 253, 0.2), rgba(96, 165, 250, 0.3)); border-left: 4px solid #3b82f6;"></div>
                <span>15:30 Shift</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: linear-gradient(135deg, rgba(209, 250, 229, 0.2), rgba(167, 243, 208, 0.3)); border-left: 4px solid #10b981;"></div>
                <span>Off Day</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: linear-gradient(135deg, rgba(253, 186, 116, 0.2), rgba(251, 146, 60, 0.3)); border-left: 4px solid #f97316;"></div>
                <span>Leave</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="border: 2px solid var(--primary); background: rgba(67, 97, 238, 0.1);"></div>
                <span>Today</span>
            </div>
        </div>
    `;
}

function createCalendarLegend() {
    return `
        <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
            <div style="display: flex; align-items: center; gap: 5px;">
                <div style="width: 15px; height: 15px; background: linear-gradient(135deg, rgba(255, 241, 118, 0.2), rgba(255, 224, 102, 0.3)); border: 1px solid #ffd54f;"></div>
                <span style="font-size: 12px;">07:30 Shift</span>
            </div>
            <div style="display: flex; align-items: center; gap: 5px;">
                <div style="width: 15px; height: 15px; background: linear-gradient(135deg, rgba(209, 250, 229, 0.2), rgba(167, 243, 208, 0.3)); border: 1px solid #81c784;"></div>
                <span style="font-size: 12px;">Off Day</span>
            </div>
            <div style="display: flex; align-items: center; gap: 5px;">
                <div style="width: 15px; height: 15px; background: linear-gradient(135deg, rgba(67, 97, 238, 0.15), rgba(67, 97, 238, 0.25)); border: 2px solid var(--primary);"></div>
                <span style="font-size: 12px;">Today</span>
            </div>
        </div>
    `;
}

// All Roster Functions
function loadAllRoster() {
    const container = document.getElementById('allRosterContainer');
    if (!container) return;
    
    const startDate = document.getElementById('allRosterStartDate').value;
    const endDate = document.getElementById('allRosterEndDate').value;
    const viewType = document.getElementById('allRosterViewType').value;
    
    if (!startDate || !endDate) {
        container.innerHTML = '<div class="alert alert-warning">Please select start and end dates</div>';
        return;
    }
    
    const start = new Date(startDate);
    const end = new Date(endDate);
    
    if (start > end) {
        container.innerHTML = '<div class="alert alert-warning">Start date must be before end date</div>';
        return;
    }
    
    if (viewType === 'calendar') {
        displayAllRosterCalendar(container, start, end);
    } else if (viewType === 'staff') {
        displayAllRosterByStaff(container, start, end);
    } else {
        displayAllRosterDaily(container, start, end);
    }
}

function displayAllRosterDaily(container, startDate, endDate) {
    let html = `<h4 style="margin-bottom: 15px;">Complete Duty Roster (${formatDate(startDate)} to ${formatDate(endDate)})</h4>`;
    
    // Create date navigation
    const prevStart = new Date(startDate);
    prevStart.setDate(prevStart.getDate() - 7);
    const prevEnd = new Date(endDate);
    prevEnd.setDate(prevEnd.getDate() - 7);
    const nextStart = new Date(startDate);
    nextStart.setDate(nextStart.getDate() + 7);
    const nextEnd = new Date(endDate);
    nextEnd.setDate(nextEnd.getDate() + 7);
    
    html += `<div class="date-navigation">
        <button class="date-nav-btn" onclick="navigateAllRoster('${prevStart.toISOString().split('T')[0]}', '${prevEnd.toISOString().split('T')[0]}')">
            <span>←</span> Previous Week
        </button>
        <span class="current-date-display">${formatDate(startDate)} - ${formatDate(endDate)}</span>
        <button class="date-nav-btn" onclick="navigateAllRoster('${nextStart.toISOString().split('T')[0]}', '${nextEnd.toISOString().split('T')[0]}')">
            Next Week <span>→</span>
        </button>
    </div>`;
    
    // Create table
    html += displayAllRosterTable(startDate, endDate);
    
    // Add summary
    html += generateRosterSummary(startDate, endDate);
    
    container.innerHTML = html;
}

function displayAllRosterByStaff(container, startDate, endDate) {
    let html = `<h4 style="margin-bottom: 15px;">Staff Duty Summary (${formatDate(startDate)} to ${formatDate(endDate)})</h4>`;
    
    html += '<div class="table-container"><table><thead><tr><th>Staff</th><th>RC No</th><th>Duty Days</th><th>Off Days</th><th>Leave Days</th><th>Details</th></tr></thead><tbody>';
    
    allUsers.forEach(user => {
        if (user.Level === 'User') {
            let dutyDays = 0;
            let offDays = 0;
            let leaveDays = 0;
            let details = [];
            
            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                const dateStr = d.toISOString().split('T')[0];
                
                // Check for approved leave
                const approvedLeave = allRequests.find(req => 
                    req.fromUsername === user.username &&
                    req.type === 'leave' &&
                    req.status === 'approved' &&
                    req.date === dateStr
                );
                
                if (approvedLeave) {
                    leaveDays += approvedLeave.duration;
                    details.push(`${dateStr}: ${approvedLeave.leaveType} (${approvedLeave.duration} day)`);
                } else if (dutyRoster[dateStr] && dutyRoster[dateStr][user.username]) {
                    if (dutyRoster[dateStr][user.username] === 'Off') {
                        offDays++;
                    } else {
                        dutyDays++;
                        details.push(`${dateStr}: ${dutyRoster[dateStr][user.username]}`);
                    }
                }
            }
            
            html += `<tr>
                <td class="staff-name">${user.name}</td>
                <td>${user.RCNo}</td>
                <td>${dutyDays}</td>
                <td>${offDays}</td>
                <td>${leaveDays.toFixed(1)}</td>
                <td><small>${details.slice(0, 3).join('<br>')}${details.length > 3 ? '<br>...' : ''}</small></td>
            </tr>`;
        }
    });
    
    html += '</tbody></table></div>';
    
    container.innerHTML = html;
}

function displayAllRosterCalendar(container, startDate, endDate) {
    let html = `<h4 style="margin-bottom: 15px;">Calendar View (${formatDate(startDate)} to ${formatDate(endDate)})</h4>`;
    
    // Group by week
    const weeks = [];
    let currentWeek = [];
    let currentDate = new Date(startDate);
    
    while (currentDate <= endDate) {
        currentWeek.push(new Date(currentDate));
        if (currentWeek.length === 7 || currentDate.getTime() === endDate.getTime()) {
            weeks.push([...currentWeek]);
            currentWeek = [];
        }
        currentDate.setDate(currentDate.getDate() + 1);
    }
    
    // Display each week
    weeks.forEach((week, weekIndex) => {
        html += `<h5 style="margin: 15px 0 10px 0;">Week ${weekIndex + 1}</h5>`;
        html += '<div class="calendar-grid">';
        
        // Day headers
        const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        days.forEach(day => {
            html += `<div class="calendar-day" style="text-align: center; font-weight: bold; background: var(--gray-light);">${day}</div>`;
        });
        
        // Calendar cells
        week.forEach(day => {
            const dateStr = day.toISOString().split('T')[0];
            const dayNum = day.getDate();
            const isToday = dateStr === new Date().toISOString().split('T')[0];
            
            let dayClass = 'calendar-day';
            let dayContent = `<div class="day-header">${dayNum}</div>`;
            let staffCount = 0;
            
            // Add staff duties for this day
            allUsers.forEach(user => {
                if (user.Level === 'User' && staffCount < 3) { // Limit to 3 staff per cell
                    let dutyInfo = '';
                    
                    // Check for approved leave
                    const approvedLeave = allRequests.find(req => 
                        req.fromUsername === user.username &&
                        req.type === 'leave' &&
                        req.status === 'approved' &&
                        req.date === dateStr
                    );
                    
                    if (approvedLeave) {
                        dutyInfo = `${user.name.substring(0, 3)}: ${approvedLeave.leaveType === 'Sick Leave' ? 'SL' : 'FRL'}`;
                        staffCount++;
                    } else if (dutyRoster[dateStr] && dutyRoster[dateStr][user.username]) {
                        const dutyTime = dutyRoster[dateStr][user.username];
                        if (dutyTime !== 'Off') {
                            dutyInfo = `${user.name.substring(0, 3)}: ${dutyTime.substring(0, 5)}`;
                            staffCount++;
                        }
                    }
                    
                    if (dutyInfo) {
                        dayContent += `<div style="font-size: 10px; line-height: 1.2;">${dutyInfo}</div>`;
                    }
                }
            });
            
            if (staffCount < allUsers.filter(u => u.Level === 'User').length - 3) {
                dayContent += `<div style="font-size: 9px; color: var(--gray);">+${allUsers.filter(u => u.Level === 'User').length - staffCount} more</div>`;
            }
            
            if (isToday) {
                dayClass += ' today';
            }
            
            html += `<div class="${dayClass}" style="min-height: 80px; overflow-y: auto;">${dayContent}</div>`;
        });
        
        html += '</div>';
    });
    
    container.innerHTML = html;
}

function navigateAllRoster(startDate, endDate) {
    document.getElementById('allRosterStartDate').value = startDate;
    document.getElementById('allRosterEndDate').value = endDate;
    loadAllRoster();
}

function generateRosterSummary(startDate, endDate) {
    const totalStaff = allUsers.filter(u => u.Level === 'User').length;
    const totalDays = Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
    
    let totalDutySlots = 0;
    let totalOffSlots = 0;
    let totalLeaveSlots = 0;
    
    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
        const dateStr = d.toISOString().split('T')[0];
        
        allUsers.forEach(user => {
            if (user.Level === 'User') {
                // Check for approved leave
                const approvedLeave = allRequests.find(req => 
                    req.fromUsername === user.username &&
                    req.type === 'leave' &&
                    req.status === 'approved' &&
                    req.date === dateStr
                );
                
                if (approvedLeave) {
                    totalLeaveSlots += approvedLeave.duration;
                } else if (dutyRoster[dateStr] && dutyRoster[dateStr][user.username]) {
                    if (dutyRoster[dateStr][user.username] === 'Off') {
                        totalOffSlots++;
                    } else {
                        totalDutySlots++;
                    }
                }
            }
        });
    }
    
    return `
        <div class="alert alert-info" style="margin-top: 15px;">
            <strong>📊 Summary Statistics:</strong><br>
            • ${totalStaff} staff members<br>
            • ${totalDays} days in period<br>
            • ${totalDutySlots} duty assignments<br>
            • ${totalOffSlots} off days<br>
            • ${totalLeaveSlots.toFixed(1)} leave days
        </div>
    `;
}

function printAllRoster() {
    const container = document.getElementById('allRosterContainer');
    if (!container) return;
    
    const printContent = container.innerHTML;
    const originalContent = document.body.innerHTML;
    
    document.body.innerHTML = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Duty Roster Report</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                table { border-collapse: collapse; width: 100%; margin-top: 20px; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                th { background-color: #f2f2f2; }
                .leave-indicator { background-color: #ffeaa7; padding: 2px 5px; border-radius: 3px; font-size: 10px; }
                .duty-0730-1530 { background: #fff3cd; color: #856404; }
                .duty-0830-1630 { background: #e2d9f3; color: #563d7c; }
                .duty-1030-1830 { background: #fffde7; color: #827717; }
                .duty-1530-2330 { background: #e3f2fd; color: #0d47a1; }
                .duty-1630-0030 { background: #f5f5f5; color: #424242; }
                .duty-1730-0130 { background: #eeeeee; color: #212121; }
                .duty-0030-0830 { background: #ffebee; color: #c62828; }
                .duty-leave { background: #ffd8a6; color: #e8590c; border: 1px dashed #fd7e14; }
                .off-day-cell { background: #d4edda; color: #155724; }
                h3 { color: #2c3e50; }
                @media print {
                    .no-print { display: none; }
                }
            </style>
        </head>
        <body>
            <div class="no-print" style="margin-bottom: 20px;">
                <button onclick="window.print()" style="padding: 10px 20px; background: #4361ee; color: white; border: none; border-radius: 5px; cursor: pointer;">Print</button>
                <button onclick="window.close()" style="padding: 10px 20px; background: #e71d36; color: white; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px;">Close</button>
            </div>
            <h3>Duty Roster Report</h3>
            <p><strong>Generated on:</strong> ${new Date().toLocaleString()}</p>
            <p><strong>Generated by:</strong> ${currentUser.name}</p>
            ${printContent}
        </body>
        </html>
    `;
    
    window.print();
    document.body.innerHTML = originalContent;
    location.reload();
}

// Pending Requests Functions
function loadPendingRequests() {
    const tbody = document.getElementById('pendingRequestsTable');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    const pendingReqs = allRequests.filter(req => 
        req.status === 'pending' && 
        req.type === 'dutyChange' && 
        req.toUsername === currentUser.username
    );
    
    if (pendingReqs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 40px;">No pending requests</td></tr>';
        return;
    }
    
    pendingReqs.forEach(req => {
        const tr = document.createElement('tr');
        
        tr.innerHTML = `
            <td>${req.fromName}</td>
            <td>${req.date}</td>
            <td>Swap ${req.dutyTime} with ${req.toDutyTime}<br>
                <small style="color: #666;">${req.reason || 'No reason provided'}</small>
            </td>
            <td class="action-buttons">
                <button class="action-btn approve" onclick="respondToRequest('${req.id}', 'approved')">Accept</button>
                <button class="action-btn reject" onclick="respondToRequest('${req.id}', 'rejected')">Reject</button>
            </td>
        `;
        
        tbody.appendChild(tr);
    });
}

async function respondToRequest(requestId, response) {
    const request = allRequests.find(req => req.id === requestId);
    if (!request) {
        showToast('Request not found', 'error');
        return;
    }
    
    if (response === 'approved') {
        // Swap duty times in roster
        const date = request.date;
        if (dutyRoster[date]) {
            const fromDuty = dutyRoster[date][request.fromUsername];
            const toDuty = dutyRoster[date][request.toUsername];
            
            dutyRoster[date][request.fromUsername] = toDuty;
            dutyRoster[date][request.toUsername] = fromDuty;
            
            await saveDutyRoster();
        }
    }
    
    request.status = response;
    request.respondedAt = new Date().toISOString();
    request.history.push({
        action: response,
        by: currentUser.name,
        timestamp: new Date().toISOString()
    });
    
    const success = await saveAllRequests();
    if (success) {
        showToast(`Request ${response} successfully!`, 'success');
        showUserNotification(`Your duty change request for ${request.date} was ${response} by ${currentUser.name}`);
        showSection('home');
        updateRequestCounts();
    }
}

function showUserNotification(message) {
    const notificationContainer = document.getElementById('homeNotifications');
    if (notificationContainer) {
        notificationContainer.style.display = 'block';
        notificationContainer.innerHTML = `<div class="alert alert-info">
            <strong>📢 Update:</strong> ${message}
        </div>`;
        
        // Auto hide after 10 seconds
        setTimeout(() => {
            notificationContainer.style.display = 'none';
        }, 10000);
    }
}

// Announcement Admin Functions
function loadAnnouncementsAdmin() {
    setupAnnouncementForm();
    loadActiveAnnouncements();
    loadExpiredAnnouncements();
}

function setupAnnouncementForm() {
    // Populate staff dropdown
    const staffSelect = document.getElementById('announcementStaff');
    if (staffSelect) {
        staffSelect.innerHTML = '';
        
        allUsers.forEach(user => {
            if (user.Level === 'User') {
                const option = document.createElement('option');
                option.value = user.username;
                option.textContent = `${user.name} (${user.RCNo})`;
                staffSelect.appendChild(option);
            }
        });
    }
    
    // Setup form submission
    const form = document.getElementById('announcementForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            createAnnouncement();
        });
    }
}

function selectPriority(priority) {
    // Update UI
    document.querySelectorAll('.priority-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    const selectedBtn = document.querySelector(`.priority-btn[data-priority="${priority}"]`);
    if (selectedBtn) {
        selectedBtn.classList.add('active');
    }
    
    // Update hidden input
    const priorityInput = document.getElementById('announcementPriority');
    if (priorityInput) {
        priorityInput.value = priority;
    }
}

function updateTargetSelection() {
    const specificSection = document.getElementById('specificStaffSection');
    if (!specificSection) return;
    
    const targetAll = document.querySelector('input[name="target"][value="all"]:checked');
    
    if (targetAll) {
        specificSection.style.display = 'none';
    } else {
        specificSection.style.display = 'block';
    }
}

async function createAnnouncement() {
    const titleInput = document.getElementById('announcementTitle');
    const contentInput = document.getElementById('announcementContent');
    const priorityInput = document.getElementById('announcementPriority');
    const expiryInput = document.getElementById('announcementExpiry');
    
    if (!titleInput || !contentInput || !priorityInput) {
        showToast('Form elements not found', 'error');
        return;
    }
    
    const title = titleInput.value.trim();
    const content = contentInput.value.trim();
    const priority = priorityInput.value;
    const target = document.querySelector('input[name="target"]:checked')?.value || 'all';
    const expiry = expiryInput?.value || null;
    let targetUsers = [];
    
    if (target === 'specific') {
        const staffSelect = document.getElementById('announcementStaff');
        if (staffSelect) {
            targetUsers = Array.from(staffSelect.selectedOptions).map(option => option.value);
            
            if (targetUsers.length === 0) {
                showToast('Please select at least one staff member for specific announcement', 'warning');
                return;
            }
        }
    }
    
    if (!title || !content) {
        showToast('Please fill in title and content', 'warning');
        return;
    }
    
    const announcement = {
        id: 'ann_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
        title: title,
        content: content,
        priority: priority,
        target: target,
        targetUsers: targetUsers,
        createdBy: currentUser.name,
        createdByUsername: currentUser.username,
        createdAt: new Date().toISOString(),
        expiry: expiry,
        status: 'active'
    };
    
    announcements.push(announcement);
    
    const success = await saveAnnouncements();
    if (success) {
        showToast('Announcement created successfully!', 'success');
        clearAnnouncementForm();
        loadActiveAnnouncements();
        loadExpiredAnnouncements();
    }
}

function clearAnnouncementForm() {
    const form = document.getElementById('announcementForm');
    if (form) {
        form.reset();
        selectPriority('medium');
        document.getElementById('specificStaffSection').style.display = 'none';
    }
}

function loadActiveAnnouncements() {
    const container = document.getElementById('activeAnnouncementsList');
    if (!container) return;
    
    container.innerHTML = '';
    
    const now = new Date();
    const activeAnnouncements = announcements.filter(ann => {
        if (ann.status === 'expired' || ann.status === 'archived') return false;
        if (ann.expiry && new Date(ann.expiry) < now) {
            ann.status = 'expired';
            return false;
        }
        return true;
    });
    
    if (activeAnnouncements.length === 0) {
        container.innerHTML = `
            <div class="no-announcements">
                <div class="icon">📢</div>
                <p>No active announcements</p>
                <p style="font-size: 12px;">Create your first announcement above</p>
            </div>
        `;
        return;
    }
    
    // Sort by priority and date
    activeAnnouncements.sort((a, b) => {
        const priorityOrder = {high: 0, medium: 1, low: 2};
        if (priorityOrder[a.priority] !== priorityOrder[b.priority]) {
            return priorityOrder[a.priority] - priorityOrder[b.priority];
        }
        return new Date(b.createdAt) - new Date(a.createdAt);
    });
    
    activeAnnouncements.forEach(ann => {
        const announcementDiv = document.createElement('div');
        announcementDiv.className = `announcement-banner priority-${ann.priority}`;
        
        let targetText = '';
        if (ann.target === 'all') {
            targetText = 'All Staff';
        } else {
            const targetNames = ann.targetUsers.map(username => {
                const user = allUsers.find(u => u.username === username);
                return user ? user.name : username;
            }).join(', ');
            targetText = `For: ${targetNames}`;
        }
        
        announcementDiv.innerHTML = `
            <div class="announcement-actions">
                <button class="announcement-btn" onclick="editAnnouncement('${ann.id}')" title="Edit">✏️</button>
                <button class="announcement-btn" onclick="archiveAnnouncement('${ann.id}')" title="Archive">📁</button>
                <button class="announcement-btn" onclick="deleteAnnouncement('${ann.id}')" title="Delete">🗑️</button>
            </div>
            <div class="announcement-title">
                <span class="announcement-icon">📢</span>
                ${ann.title}
            </div>
            <div class="announcement-content">${ann.content}</div>
            <div class="announcement-meta">
                <div>
                    By: ${ann.createdBy} • ${formatTimeAgo(ann.createdAt)}
                    ${ann.expiry ? `<br>Expires: ${formatDate(ann.expiry)}` : ''}
                </div>
                <div class="announcement-target">${targetText}</div>
            </div>
        `;
        
        container.appendChild(announcementDiv);
    });
}

function loadExpiredAnnouncements() {
    const container = document.getElementById('expiredAnnouncementsList');
    if (!container) return;
    
    container.innerHTML = '';
    
    const now = new Date();
    const expiredAnnouncements = announcements.filter(ann => {
        if (ann.status === 'expired') return true;
        if (ann.expiry && new Date(ann.expiry) < now) {
            ann.status = 'expired';
            return true;
        }
        return false;
    });
    
    if (expiredAnnouncements.length === 0) {
        container.innerHTML = `
            <div class="no-announcements">
                <div class="icon">📅</div>
                <p>No expired announcements</p>
            </div>
        `;
        return;
    }
    
    // Sort by expiry date
    expiredAnnouncements.sort((a, b) => new Date(b.expiry || b.createdAt) - new Date(a.expiry || a.createdAt));
    
    expiredAnnouncements.forEach(ann => {
        const announcementDiv = document.createElement('div');
        announcementDiv.className = 'announcement-banner';
        announcementDiv.style.background = 'linear-gradient(135deg, #868f96 0%, #596164 100%)';
        announcementDiv.style.opacity = '0.8';
        
        let targetText = '';
        if (ann.target === 'all') {
            targetText = 'All Staff';
        } else {
            const targetNames = ann.targetUsers.map(username => {
                const user = allUsers.find(u => u.username === username);
                return user ? user.name : username;
            }).join(', ');
            targetText = `For: ${targetNames}`;
        }
        
        announcementDiv.innerHTML = `
            <div class="announcement-actions">
                <button class="announcement-btn" onclick="restoreAnnouncement('${ann.id}')" title="Restore">↻</button>
                <button class="announcement-btn" onclick="deleteAnnouncement('${ann.id}')" title="Delete">🗑️</button>
            </div>
            <div class="announcement-title">
                <span class="announcement-icon">📅</span>
                ${ann.title}
            </div>
            <div class="announcement-content">${ann.content}</div>
            <div class="announcement-meta">
                <div>
                    By: ${ann.createdBy} • ${formatTimeAgo(ann.createdAt)}
                    <br>Expired: ${formatDate(ann.expiry || ann.createdAt)}
                </div>
                <div class="announcement-target">${targetText}</div>
            </div>
        `;
        
        container.appendChild(announcementDiv);
    });
}

function editAnnouncement(announcementId) {
    const announcement = announcements.find(ann => ann.id === announcementId);
    if (!announcement) {
        showToast('Announcement not found', 'error');
        return;
    }
    
    // Fill form
    document.getElementById('announcementTitle').value = announcement.title;
    document.getElementById('announcementContent').value = announcement.content;
    selectPriority(announcement.priority);
    
    // Set target
    if (announcement.target === 'all') {
        document.querySelector('input[name="target"][value="all"]').checked = true;
    } else {
        document.querySelector('input[name="target"][value="specific"]').checked = true;
        updateTargetSelection();
        
        // Select staff members
        const staffSelect = document.getElementById('announcementStaff');
        if (staffSelect) {
            Array.from(staffSelect.options).forEach(option => {
                option.selected = announcement.targetUsers.includes(option.value);
            });
        }
    }
    
    // Set expiry
    const expiryInput = document.getElementById('announcementExpiry');
    if (expiryInput) {
        expiryInput.value = announcement.expiry || '';
    }
    
    // Change button
    const submitBtn = document.getElementById('createAnnouncementBtn');
    if (submitBtn) {
        submitBtn.textContent = 'Update Announcement';
        submitBtn.onclick = function() {
            updateAnnouncement(announcementId);
            return false;
        };
    }
    
    // Scroll to form
    const formCard = document.querySelector('.announcement-form-card');
    if (formCard) {
        formCard.scrollIntoView({behavior: 'smooth'});
    }
}

async function updateAnnouncement(announcementId) {
    const index = announcements.findIndex(ann => ann.id === announcementId);
    if (index === -1) {
        showToast('Announcement not found', 'error');
        return;
    }
    
    const title = document.getElementById('announcementTitle').value.trim();
    const content = document.getElementById('announcementContent').value.trim();
    const priority = document.getElementById('announcementPriority').value;
    const target = document.querySelector('input[name="target"]:checked')?.value || 'all';
    const expiry = document.getElementById('announcementExpiry')?.value || null;
    let targetUsers = [];
    
    if (target === 'specific') {
        const staffSelect = document.getElementById('announcementStaff');
        if (staffSelect) {
            targetUsers = Array.from(staffSelect.selectedOptions).map(option => option.value);
            
            if (targetUsers.length === 0) {
                showToast('Please select at least one staff member for specific announcement', 'warning');
                return;
            }
        }
    }
    
    if (!title || !content) {
        showToast('Please fill in title and content', 'warning');
        return;
    }
    
    // Update announcement
    announcements[index] = {
        ...announcements[index],
        title: title,
        content: content,
        priority: priority,
        target: target,
        targetUsers: targetUsers,
        expiry: expiry,
        updatedAt: new Date().toISOString(),
        updatedBy: currentUser.name
    };
    
    const success = await saveAnnouncements();
    if (success) {
        showToast('Announcement updated successfully!', 'success');
        clearAnnouncementForm();
        
        // Reset button
        const submitBtn = document.getElementById('createAnnouncementBtn');
        if (submitBtn) {
            submitBtn.textContent = 'Create Announcement';
            submitBtn.onclick = null;
        }
        
        // Reload
        loadActiveAnnouncements();
        loadExpiredAnnouncements();
    }
}

async function archiveAnnouncement(announcementId) {
    if (!confirm('Are you sure you want to archive this announcement?')) return;
    
    const index = announcements.findIndex(ann => ann.id === announcementId);
    if (index !== -1) {
        announcements[index].status = 'archived';
        const success = await saveAnnouncements();
        if (success) {
            loadActiveAnnouncements();
            showToast('Announcement archived!', 'success');
        }
    }
}

async function deleteAnnouncement(announcementId) {
    if (!confirm('Are you sure you want to delete this announcement? This action cannot be undone.')) return;
    
    const index = announcements.findIndex(ann => ann.id === announcementId);
    if (index !== -1) {
        announcements.splice(index, 1);
        const success = await saveAnnouncements();
        if (success) {
            loadActiveAnnouncements();
            loadExpiredAnnouncements();
            showToast('Announcement deleted!', 'success');
        }
    }
}

async function restoreAnnouncement(announcementId) {
    const index = announcements.findIndex(ann => ann.id === announcementId);
    if (index !== -1) {
        announcements[index].status = 'active';
        announcements[index].expiry = null;
        const success = await saveAnnouncements();
        if (success) {
            loadActiveAnnouncements();
            loadExpiredAnnouncements();
            showToast('Announcement restored!', 'success');
        }
    }
}

// Admin Duty Roster Functions
function loadDutyRosterAdmin() {
    showRosterTab('excelImport');
    populateStaffDropdowns();
    loadTodayRoster();
}

function showRosterTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.roster-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remove active from tab buttons
    document.querySelectorAll('#adminDutyRosterSection .tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab
    const tab = document.getElementById(tabName + 'Tab');
    if (tab) {
        tab.classList.add('active');
    }
    
    // Activate button
    document.querySelectorAll('#adminDutyRosterSection .tab-btn').forEach(btn => {
        if (btn.textContent.includes(tabName === 'excelImport' ? 'Excel' : 
                                     tabName === 'manualEntry' ? 'Manual' : 'View')) {
            btn.classList.add('active');
        }
    });
    
    if (tabName === 'viewRoster') {
        loadRosterView();
    }
}

function populateStaffDropdowns() {
    const staffSelects = [
        'rosterStaffSingle',
        'viewRosterStaff',
        'balanceStaff',
        'historyFilterStaff'
    ];
    
    staffSelects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (select) {
            select.innerHTML = selectId === 'viewRosterStaff' || selectId === 'historyFilterStaff' 
                ? '<option value="">All Staff</option>' 
                : '<option value="">Select staff</option>';
            
            allUsers.forEach(user => {
                const option = document.createElement('option');
                option.value = user.username;
                option.textContent = `${user.name} (${user.RCNo})`;
                select.appendChild(option);
            });
        }
    });
}

function processExcelPaste() {
    const pasteBox = document.getElementById('excelPasteBox');
    if (!pasteBox) return;
    
    const pasteText = pasteBox.value.trim();
    if (!pasteText) {
        showToast('Please paste Excel data first', 'warning');
        return;
    }
    
    const lines = pasteText.split('\n').filter(line => line.trim());
    if (lines.length < 2) {
        showToast('Invalid data format. Need at least header row and one data row.', 'warning');
        return;
    }
    
    // Parse header
    const headers = lines[0].split('\t');
    if (headers.length < 2) {
        showToast('Invalid format. First column should be Date, then staff names.', 'warning');
        return;
    }
    
    // Create preview table
    const previewTable = document.getElementById('excelPreviewTable');
    if (!previewTable) return;
    
    previewTable.innerHTML = '';
    
    // Add header row
    let headerRow = '<tr>';
    headers.forEach(header => {
        headerRow += `<th>${header}</th>`;
    });
    headerRow += '</tr>';
    previewTable.innerHTML = headerRow;
    
    // Add data rows
    for (let i = 1; i < lines.length; i++) {
        const cells = lines[i].split('\t');
        let row = '<tr>';
        cells.forEach(cell => {
            row += `<td>${cell}</td>`;
        });
        row += '</tr>';
        previewTable.innerHTML += row;
    }
    
    // Show preview
    const preview = document.getElementById('excelPreview');
    if (preview) {
        preview.style.display = 'block';
    }
}

async function saveExcelData() {
    const pasteBox = document.getElementById('excelPasteBox');
    if (!pasteBox) return;
    
    const pasteText = pasteBox.value.trim();
    const lines = pasteText.split('\n').filter(line => line.trim());
    
    if (lines.length < 2) {
        showToast('No data to save', 'warning');
        return;
    }
    
    const headers = lines[0].split('\t');
    let successCount = 0;
    let errorCount = 0;
    
    for (let i = 1; i < lines.length; i++) {
        const cells = lines[i].split('\t');
        const date = cells[0];
        
        // Validate date
        if (!isValidDate(date)) {
            console.log(`Skipping invalid date: ${date}`);
            errorCount++;
            continue;
        }
        
        if (!dutyRoster[date]) {
            dutyRoster[date] = {};
        }
        
        for (let j = 1; j < headers.length && j < cells.length; j++) {
            const displayName = headers[j];
            const dutyTime = cells[j] || 'Off';
            
            // Find username
            const username = findUsernameFromDisplayName(displayName);
            
            if (username) {
                dutyRoster[date][username] = dutyTime;
                successCount++;
            } else {
                console.log(`User not found: ${displayName}`);
                errorCount++;
            }
        }
    }
    
    const success = await saveDutyRoster();
    if (success) {
        showToast(`Roster saved! ${successCount} entries updated. ${errorCount > 0 ? errorCount + ' errors.' : ''}`, 'success');
        const preview = document.getElementById('excelPreview');
        if (preview) {
            preview.style.display = 'none';
        }
        pasteBox.value = '';
    }
}

function findUsernameFromDisplayName(displayName) {
    // Direct mapping
    if (userDisplayNameMap[displayName]) {
        return userDisplayNameMap[displayName];
    }
    
    // Case-insensitive
    const displayLower = displayName.toLowerCase();
    for (const key in userDisplayNameMap) {
        if (key.toLowerCase() === displayLower) {
            return userDisplayNameMap[key];
        }
    }
    
    // Try to find by RC number pattern
    const rcMatch = displayName.match(/RC[:\s]*(\d+)/i);
    if (rcMatch) {
        const rcNo = rcMatch[1];
        const user = allUsers.find(u => u.RCNo === rcNo);
        if (user) return user.username;
    }
    
    return null;
}

function loadSampleData() {
    const today = new Date();
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);
    const dayAfter = new Date(today);
    dayAfter.setDate(dayAfter.getDate() + 2);
    
    const sampleData = `Date\tIrufan1\tIrufan2\tHussain\tMohamed
${today.toISOString().split('T')[0]}\t07:30-15:30\t15:30-23:30\t08:00-16:00\tOff
${tomorrow.toISOString().split('T')[0]}\t15:30-23:30\t07:30-15:30\tOff\t00:30-08:30
${dayAfter.toISOString().split('T')[0]}\tOff\t16:30-00:30\t17:30-01:30\t10:30-18:30`;
    
    const pasteBox = document.getElementById('excelPasteBox');
    if (pasteBox) {
        pasteBox.value = sampleData;
        processExcelPaste();
    }
}

function clearExcelPaste() {
    const pasteBox = document.getElementById('excelPasteBox');
    if (pasteBox) {
        pasteBox.value = '';
    }
    const preview = document.getElementById('excelPreview');
    if (preview) {
        preview.style.display = 'none';
    }
}

function loadTodayRoster() {
    const tbody = document.querySelector('#todayRosterTable tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    const today = document.getElementById('rosterDate').value;
    if (!dutyRoster[today]) return;
    
    for (const [username, dutyTime] of Object.entries(dutyRoster[today])) {
        const user = allUsers.find(u => u.username === username);
        if (user) {
            const tr = document.createElement('tr');
            const dutyClass = getDutyTimeClass(dutyTime);
            tr.innerHTML = `
                <td>${user.name} (${user.RCNo})</td>
                <td class="${dutyClass}">${dutyTime}</td>
                <td>
                    <button class="action-btn view" onclick="editRosterEntry('${today}', '${username}')">Edit</button>
                    <button class="action-btn reject" onclick="deleteRosterEntry('${today}', '${username}')">Delete</button>
                </td>
            `;
            tbody.appendChild(tr);
        }
    }
}

async function addRosterEntry() {
    const date = document.getElementById('rosterDate').value;
    const staff = document.getElementById('rosterStaffSingle').value;
    const dutyTime = document.getElementById('rosterDutyTime').value.trim();
    
    if (!date || !staff || !dutyTime) {
        showToast('Please fill all fields', 'warning');
        return;
    }
    
    if (!dutyRoster[date]) {
        dutyRoster[date] = {};
    }
    
    dutyRoster[date][staff] = dutyTime;
    
    const success = await saveDutyRoster();
    if (success) {
        showToast('Entry added successfully!', 'success');
        clearRosterForm();
        loadTodayRoster();
    }
}

function clearRosterForm() {
    const dutyTimeInput = document.getElementById('rosterDutyTime');
    if (dutyTimeInput) {
        dutyTimeInput.value = '';
    }
}

async function editRosterEntry(date, username) {
    const currentTime = dutyRoster[date][username];
    const newTime = prompt('Enter new duty time:', currentTime);
    if (newTime !== null) {
        dutyRoster[date][username] = newTime;
        const success = await saveDutyRoster();
        if (success) {
            loadTodayRoster();
            showToast('Entry updated', 'success');
        }
    }
}

async function deleteRosterEntry(date, username) {
    if (!confirm('Are you sure you want to delete this entry?')) return;
    
    delete dutyRoster[date][username];
    const success = await saveDutyRoster();
    if (success) {
        loadTodayRoster();
        showToast('Entry deleted', 'success');
    }
}

function loadRosterView() {
    const container = document.getElementById('rosterViewContainer');
    if (!container) return;
    
    const date = document.getElementById('viewRosterDate').value;
    const staffFilter = document.getElementById('viewRosterStaff').value;
    
    if (!date) {
        container.innerHTML = '<div class="alert alert-warning">Please select a date</div>';
        return;
    }
    
    let html = '<h4>Roster for ' + date + '</h4>';
    
    if (!dutyRoster[date] || Object.keys(dutyRoster[date]).length === 0) {
        html += '<div class="alert alert-warning">No roster entries for this date</div>';
        container.innerHTML = html;
        return;
    }
    
    html += '<div class="table-container"><table><thead><tr><th>Staff</th><th>RC No</th><th>Duty Time</th></tr></thead><tbody>';
    
    for (const [username, dutyTime] of Object.entries(dutyRoster[date])) {
        const user = allUsers.find(u => u.username === username);
        if (user && (!staffFilter || user.username === staffFilter)) {
            const dutyClass = getDutyTimeClass(dutyTime);
            html += `<tr>
                <td>${user.name}</td>
                <td>${user.RCNo}</td>
                <td class="${dutyClass}">${dutyTime}</td>
            </tr>`;
        }
    }
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
}

// Admin Leave Balance Functions
function loadLeaveBalanceAdmin() {
    showBalanceTab('bulkUpdate');
    loadBulkBalanceTable();
}

function showBalanceTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.balance-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remove active from buttons
    document.querySelectorAll('#adminLeaveBalanceSection .tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab
    const tab = document.getElementById(tabName + 'Tab');
    if (tab) {
        tab.classList.add('active');
    }
    
    // Activate button
    document.querySelectorAll('#adminLeaveBalanceSection .tab-btn').forEach(btn => {
        if (btn.textContent.includes(tabName === 'bulkUpdate' ? 'Bulk' : 'Individual')) {
            btn.classList.add('active');
        }
    });
    
    if (tabName === 'individual') {
        const staffSelect = document.getElementById('balanceStaff');
        if (staffSelect) {
            staffSelect.addEventListener('change', function() {
                const form = document.getElementById('individualBalanceForm');
                if (this.value) {
                    const balance = leaveBalances[this.value] || {SL: 0, FRL: 0};
                    document.getElementById('individualSL').value = balance.SL;
                    document.getElementById('individualFRL').value = balance.FRL;
                    form.style.display = 'block';
                } else {
                    form.style.display = 'none';
                }
            });
        }
    }
}

function loadBulkBalanceTable() {
    const tbody = document.getElementById('bulkBalanceTable');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    allUsers.forEach(user => {
        const balance = leaveBalances[user.username] || {SL: 0, FRL: 0};
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${user.name}</td>
            <td>${user.RCNo}</td>
            <td>
                <input type="number" class="excel-input" 
                       value="${balance.SL}" 
                       step="0.5" 
                       min="0"
                       onchange="updateTempBalance('${user.username}', 'SL', this.value)">
            </td>
            <td>
                <input type="number" class="excel-input" 
                       value="${balance.FRL}" 
                       step="0.5" 
                       min="0"
                       onchange="updateTempBalance('${user.username}', 'FRL', this.value)">
            </td>
            <td>
                <button class="action-btn view" onclick="resetUserBalance('${user.username}')">Reset</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

function updateTempBalance(username, type, value) {
    if (!leaveBalances[username]) {
        leaveBalances[username] = {SL: 0, FRL: 0};
    }
    leaveBalances[username][type] = parseFloat(value) || 0;
}

async function saveAllBalances() {
    const success = await saveLeaveBalances();
    if (success) {
        showToast('All balances saved successfully!', 'success');
        loadBulkBalanceTable();
        updateUserBalance();
    }
}

async function resetAllBalances() {
    if (!confirm('Reset ALL balances to default (12 days SL, 6 days FRL)?')) return;
    
    allUsers.forEach(user => {
        leaveBalances[user.username] = {SL: 12, FRL: 6};
    });
    
    const success = await saveLeaveBalances();
    if (success) {
        loadBulkBalanceTable();
        updateUserBalance();
        showToast('All balances reset to default', 'success');
    }
}

async function resetUserBalance(username) {
    if (!confirm(`Reset balance for this user to default?`)) return;
    
    leaveBalances[username] = {SL: 12, FRL: 6};
    
    const success = await saveLeaveBalances();
    if (success) {
        loadBulkBalanceTable();
        if (username === currentUser.username) {
            updateUserBalance();
        }
        showToast('Balance reset to default', 'success');
    }
}

async function saveIndividualBalance() {
    const staff = document.getElementById('balanceStaff').value;
    const sl = parseFloat(document.getElementById('individualSL').value) || 0;
    const frl = parseFloat(document.getElementById('individualFRL').value) || 0;
    
    if (!staff) {
        showToast('Please select a staff member', 'warning');
        return;
    }
    
    if (!leaveBalances[staff]) {
        leaveBalances[staff] = {SL: 0, FRL: 0};
    }
    
    leaveBalances[staff].SL = sl;
    leaveBalances[staff].FRL = frl;
    
    const success = await saveLeaveBalances();
    if (success) {
        showToast('Balance saved successfully!', 'success');
        loadBulkBalanceTable();
        
        if (staff === currentUser.username) {
            updateUserBalance();
        }
    }
}

async function resetIndividualBalance() {
    const staff = document.getElementById('balanceStaff').value;
    if (!staff) {
        showToast('Please select a staff member', 'warning');
        return;
    }
    
    if (!confirm(`Reset balance for this staff to default (12 days SL, 6 days FRL)?`)) return;
    
    leaveBalances[staff] = {SL: 12, FRL: 6};
    document.getElementById('individualSL').value = 12;
    document.getElementById('individualFRL').value = 6;
    
    const success = await saveLeaveBalances();
    if (success) {
        loadBulkBalanceTable();
        
        if (staff === currentUser.username) {
            updateUserBalance();
        }
        
        showToast('Balance reset to default', 'success');
    }
}

// Admin Approvals Functions
function loadAdminApprovals() {
    showApprovalsTab('pending');
}

function showApprovalsTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.approvals-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remove active from buttons
    document.querySelectorAll('#adminApprovalsSection .tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab
    const tab = document.getElementById(tabName + 'ApprovalsTab');
    if (tab) {
        tab.classList.add('active');
    }
    
    // Activate button
    document.querySelectorAll('#adminApprovalsSection .tab-btn').forEach(btn => {
        if (btn.textContent.includes(tabName)) {
            btn.classList.add('active');
        }
    });
    
    // Load data
    if (tabName === 'pending') {
        loadPendingApprovals();
    } else if (tabName === 'approved') {
        loadApprovedRequests();
    } else if (tabName === 'rejected') {
        loadRejectedRequests();
    }
}

function loadPendingApprovals() {
    const tbody = document.getElementById('adminApprovalsTable');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    const pendingRequests = allRequests.filter(req => req.status === 'pending');
    
    if (pendingRequests.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px;">No pending requests</td></tr>';
        return;
    }
    
    // Sort by timestamp
    pendingRequests.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
    
    pendingRequests.forEach(req => {
        const tr = document.createElement('tr');
        
        let details = '';
        if (req.type === 'dutyChange') {
            details = `
                <div class="request-details">
                    <strong>Swap Request:</strong><br>
                    ${req.fromName} (${req.dutyTime}) ↔ ${req.toName} (${req.toDutyTime})
                    ${req.reason ? `<br><em>${req.reason}</em>` : ''}
                </div>
            `;
        } else {
            details = `
                <div class="request-details">
                    <strong>${req.leaveType}:</strong> ${req.duration} day(s)<br>
                    <em>${req.reason}</em>
                </div>
            `;
        }
        
        tr.innerHTML = `
            <td>${req.fromName} (${req.fromRcNo})</td>
            <td>${req.type === 'dutyChange' ? 'Duty Change' : 'Leave'}</td>
            <td>${req.date}</td>
            <td>${details}</td>
            <td class="status-pending">Pending</td>
            <td class="action-buttons">
                <button class="action-btn approve" onclick="adminApprove('${req.id}')">Approve</button>
                <button class="action-btn reject" onclick="adminReject('${req.id}')">Reject</button>
                ${req.type === 'dutyChange' ? 
                    `<button class="action-btn apply" onclick="adminApplyDutyChange('${req.id}')">Apply & Approve</button>` : ''}
            </td>
        `;
        
        tbody.appendChild(tr);
    });
}

function loadApprovedRequests() {
    const tbody = document.getElementById('approvedRequestsTable');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    const approvedRequests = allRequests.filter(req => req.status === 'approved');
    
    if (approvedRequests.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px;">No approved requests</td></tr>';
        return;
    }
    
    approvedRequests.sort((a, b) => {
        const aDate = a.approvedAt ? new Date(a.approvedAt) : new Date(0);
        const bDate = b.approvedAt ? new Date(b.approvedAt) : new Date(0);
        return bDate - aDate;
    });
    
    approvedRequests.forEach(req => {
        const tr = document.createElement('tr');
        
        let details = '';
        if (req.type === 'dutyChange') {
            details = `Swap with ${req.toName} (${req.toDutyTime})`;
            if (req.reason) details += `<br><small style="color: #666;">Reason: ${req.reason}</small>`;
        } else {
            details = `${req.leaveType}: ${req.duration} day(s)`;
            if (req.reason) details += `<br><small style="color: #666;">Reason: ${req.reason}</small>`;
        }
        
        const appliedBy = req.appliedBy || req.approvedBy || 'System';
        const appliedAt = req.appliedAt || req.approvedAt || req.timestamp;
        
        tr.innerHTML = `
            <td>${req.fromName} (${req.fromRcNo})</td>
            <td>${req.type === 'dutyChange' ? 'Duty Change' : 'Leave'}</td>
            <td>${req.date}</td>
            <td>${details}</td>
            <td class="status-approved">Approved</td>
            <td>${appliedBy}</td>
            <td class="timestamp">${formatDateTime(appliedAt)}</td>
        `;
        
        tbody.appendChild(tr);
    });
}

function loadRejectedRequests() {
    const tbody = document.getElementById('rejectedRequestsTable');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    const rejectedRequests = allRequests.filter(req => req.status === 'rejected');
    
    if (rejectedRequests.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px;">No rejected requests</td></tr>';
        return;
    }
    
    rejectedRequests.forEach(req => {
        const tr = document.createElement('tr');
        
        let details = '';
        if (req.type === 'dutyChange') {
            details = `Swap with ${req.toName} (${req.toDutyTime})`;
            if (req.reason) details += `<br><small style="color: #666;">Reason: ${req.reason}</small>`;
        } else {
            details = `${req.leaveType}: ${req.duration} day(s)`;
            if (req.reason) details += `<br><small style="color: #666;">Reason: ${req.reason}</small>`;
        }
        
        const rejectedBy = req.rejectedBy || 'System';
        const rejectedAt = req.rejectedAt || req.timestamp;
        
        tr.innerHTML = `
            <td>${req.fromName} (${req.fromRcNo})</td>
            <td>${req.type === 'dutyChange' ? 'Duty Change' : 'Leave'}</td>
            <td>${req.date}</td>
            <td>${details}</td>
            <td class="status-rejected">Rejected</td>
            <td>${rejectedBy}</td>
            <td class="timestamp">${formatDateTime(rejectedAt)}</td>
        `;
        
        tbody.appendChild(tr);
    });
}

async function adminApprove(requestId) {
    const request = allRequests.find(req => req.id === requestId);
    if (!request) {
        showToast('Request not found', 'error');
        return;
    }
    
    if (request.type === 'leave') {
        // Check balance
        const userBalance = leaveBalances[request.fromUsername];
        if (!userBalance) {
            showToast('Error: User balance not found', 'error');
            return;
        }
        
        // Check if already approved
        if (request.status === 'approved') {
            showToast('This leave request is already approved!', 'warning');
            return;
        }
        
        // Check balance
        if (request.leaveType === 'Sick Leave' && userBalance.SL < request.duration) {
            showToast(`Cannot approve: Insufficient Sick Leave balance. Available: ${userBalance.SL.toFixed(1)} days, Requested: ${request.duration} days`, 'warning');
            return;
        }
        
        if (request.leaveType === 'FRL' && userBalance.FRL < request.duration) {
            showToast(`Cannot approve: Insufficient FRL balance. Available: ${userBalance.FRL.toFixed(1)} days, Requested: ${request.duration} days`, 'warning');
            return;
        }
        
        // Deduct from balance
        if (request.leaveType === 'Sick Leave') {
            userBalance.SL -= request.duration;
            userBalance.SL = Math.max(0, userBalance.SL);
        } else if (request.leaveType === 'FRL') {
            userBalance.FRL -= request.duration;
            userBalance.FRL = Math.max(0, userBalance.FRL);
        }
        
        await saveLeaveBalances();
    }
    
    request.status = 'approved';
    request.approvedBy = currentUser.name;
    request.approvedAt = new Date().toISOString();
    request.history.push({
        action: 'approved',
        by: currentUser.name,
        timestamp: new Date().toISOString()
    });
    
    const success = await saveAllRequests();
    if (success) {
        showToast('Request approved successfully!', 'success');
        showApprovalsTab('approved');
        updateRequestCounts();
        
        if (request.fromUsername === currentUser.username) {
            updateUserBalance();
        }
    }
}

async function adminApplyDutyChange(requestId) {
    const request = allRequests.find(req => req.id === requestId);
    if (!request) {
        showToast('Request not found', 'error');
        return;
    }
    
    // Apply the duty change
    const date = request.date;
    if (dutyRoster[date]) {
        const temp = dutyRoster[date][request.fromUsername];
        dutyRoster[date][request.fromUsername] = dutyRoster[date][request.toUsername];
        dutyRoster[date][request.toUsername] = temp;
        await saveDutyRoster();
    }
    
    // Mark as approved
    request.status = 'approved';
    request.approvedBy = currentUser.name;
    request.appliedBy = currentUser.name;
    request.approvedAt = new Date().toISOString();
    request.appliedAt = new Date().toISOString();
    request.history.push({
        action: 'applied_and_approved',
        by: currentUser.name,
        timestamp: new Date().toISOString()
    });
    
    const success = await saveAllRequests();
    if (success) {
        showToast('Duty change applied and approved! Roster updated.', 'success');
        showApprovalsTab('approved');
        updateRequestCounts();
    }
}

async function adminReject(requestId) {
    if (!confirm('Are you sure you want to reject this request?')) return;
    
    const request = allRequests.find(req => req.id === requestId);
    if (!request) {
        showToast('Request not found', 'error');
        return;
    }
    
    request.status = 'rejected';
    request.rejectedBy = currentUser.name;
    request.rejectedAt = new Date().toISOString();
    request.history.push({
        action: 'rejected',
        by: currentUser.name,
        timestamp: new Date().toISOString()
    });
    
    const success = await saveAllRequests();
    if (success) {
        showToast('Request rejected!', 'success');
        showApprovalsTab('rejected');
        updateRequestCounts();
    }
}

// Admin Request History Functions
function loadAdminRequestHistory() {
    loadRequestHistory();
}

function loadRequestHistory() {
    const tbody = document.getElementById('requestHistoryTable');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    // Get filters
    const staffFilter = document.getElementById('historyFilterStaff')?.value;
    const typeFilter = document.getElementById('historyFilterType')?.value;
    const statusFilter = document.getElementById('historyFilterStatus')?.value;
    const startDate = document.getElementById('historyStartDate')?.value;
    const endDate = document.getElementById('historyEndDate')?.value;
    
    // Filter requests
    let filteredRequests = allRequests;
    
    if (staffFilter) {
        filteredRequests = filteredRequests.filter(req => req.fromUsername === staffFilter);
    }
    
    if (typeFilter) {
        filteredRequests = filteredRequests.filter(req => req.type === typeFilter);
    }
    
    if (statusFilter) {
        filteredRequests = filteredRequests.filter(req => req.status === statusFilter);
    }
    
    if (startDate) {
        filteredRequests = filteredRequests.filter(req => req.date >= startDate);
    }
    
    if (endDate) {
        filteredRequests = filteredRequests.filter(req => req.date <= endDate);
    }
    
    if (filteredRequests.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px;">No requests found</td></tr>';
        return;
    }
    
    // Sort by timestamp
    filteredRequests.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    
    filteredRequests.forEach(req => {
        const tr = document.createElement('tr');
        
        let details = '';
        if (req.type === 'dutyChange') {
            details = `
                <div class="request-details">
                    <strong>Swap with:</strong> ${req.toName}<br>
                    <strong>From:</strong> ${req.dutyTime} → <strong>To:</strong> ${req.toDutyTime}<br>
                    ${req.reason ? `<em>${req.reason}</em>` : ''}
                </div>
            `;
        } else {
            details = `
                <div class="request-details">
                    <strong>${req.leaveType}:</strong> ${req.duration} day(s)<br>
                    <em>${req.reason}</em>
                </div>
            `;
        }
        
        let statusClass = 'status-' + req.status;
        let statusText = req.status.charAt(0).toUpperCase() + req.status.slice(1);
        
        // Timeline
        let timeline = '';
        if (req.history && req.history.length > 0) {
            req.history.forEach((event, index) => {
                timeline += `<div class="status-update">${event.action} by ${event.by}<br>
                             <small>${formatTimeAgo(event.timestamp)}</small></div>`;
            });
        }
        
        tr.innerHTML = `
            <td>${req.fromName} (${req.fromRcNo})</td>
            <td>${req.type === 'dutyChange' ? 'Duty Change' : 'Leave'}</td>
            <td>${req.date}</td>
            <td>${details}</td>
            <td class="${statusClass}">${statusText}</td>
            <td>${timeline}</td>
            <td class="action-buttons">
                ${req.status === 'pending' ? 
                    `<button class="action-btn approve" onclick="adminApprove('${req.id}')">Approve</button>
                     <button class="action-btn reject" onclick="adminReject('${req.id}')">Reject</button>` : ''}
                ${req.type === 'dutyChange' && req.status === 'pending' ? 
                    `<button class="action-btn apply" onclick="adminApplyDutyChange('${req.id}')">Apply</button>` : ''}
            </td>
        `;
        
        tbody.appendChild(tr);
    });
}

function clearHistoryFilters() {
    const elements = [
        'historyFilterStaff',
        'historyFilterType',
        'historyFilterStatus',
        'historyStartDate',
        'historyEndDate'
    ];
    
    elements.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.value = '';
        }
    });
    
    loadRequestHistory();
}

// Event Listeners Setup
function setupEventListeners() {
    // Duty Change Form
    const dutyChangeForm = document.getElementById('dutyChangeForm');
    if (dutyChangeForm) {
        dutyChangeForm.addEventListener('submit', function(e) {
            e.preventDefault();
            submitDutyChange();
        });
    }
    
    // Leave Application Form
    const leaveApplicationForm = document.getElementById('leaveApplicationForm');
    if (leaveApplicationForm) {
        leaveApplicationForm.addEventListener('submit', function(e) {
            e.preventDefault();
            submitLeaveApplication();
        });
    }
    
    // Date change handlers
    const changeDate = document.getElementById('changeDate');
    if (changeDate) {
        changeDate.addEventListener('change', function() {
            loadUserDutyTimes('changeDutyTime', this.value);
        });
    }
    
    const requestToStaff = document.getElementById('requestToStaff');
    if (requestToStaff) {
        requestToStaff.addEventListener('change', function() {
            const user = allUsers.find(u => u.username === this.value);
            if (user) {
                const rcNoInput = document.getElementById('requestToRcNo');
                if (rcNoInput) {
                    rcNoInput.value = user.RCNo;
                }
                const dateInput = document.getElementById('changeDate');
                if (dateInput && dateInput.value) {
                    loadStaffDutyTimes('requestToDutyTime', dateInput.value, user.username);
                }
            }
        });
    }
    
    const leaveDate = document.getElementById('leaveDate');
    if (leaveDate) {
        leaveDate.addEventListener('change', function() {
            loadUserDutyTimes('leaveDutyTime', this.value);
            updateLeaveRules();
        });
    }
    
    const leaveType = document.getElementById('leaveType');
    if (leaveType) {
        leaveType.addEventListener('change', updateLeaveRules);
    }
    
    const leaveDutyTime = document.getElementById('leaveDutyTime');
    if (leaveDutyTime) {
        leaveDutyTime.addEventListener('change', updateLeaveRules);
    }
    
    // Roster view type change
    const myRosterViewType = document.getElementById('myRosterViewType');
    if (myRosterViewType) {
        myRosterViewType.addEventListener('change', function() {
            loadMyRoster();
        });
    }
    
    // Target audience radio buttons
    document.querySelectorAll('input[name="target"]').forEach(radio => {
        radio.addEventListener('change', updateTargetSelection);
    });
    
    // Setup navigation buttons
    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            // Update active state
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            const sectionId = this.getAttribute('data-section');
            showSection(sectionId);
        });
    });
}

// Real-time Listeners
function setupRealtimeListeners() {
    try {
        // Announcements
        db.collection('announcements').doc('all')
            .onSnapshot((doc) => {
                if (doc.exists) {
                    announcements = doc.data().announcements || [];
                    if (document.getElementById('homeSection')?.classList.contains('active')) {
                        loadHomeAnnouncements();
                    }
                    if (document.getElementById('adminAnnouncementsSection')?.classList.contains('active')) {
                        loadAnnouncementsAdmin();
                    }
                }
            }, (error) => {
                console.error('Announcements listener error:', error);
            });
        
        // Requests
        db.collection('requests').doc('all')
            .onSnapshot((doc) => {
                if (doc.exists && doc.data().requests) {
                    allRequests = doc.data().requests;
                    updateRequestCounts();
                    
                    // Update current section if active
                    const activeSection = document.querySelector('.section.active')?.id;
                    if (activeSection === 'myRequestsSection') {
                        loadMyRequests();
                    } else if (activeSection === 'pendingRequestsSection') {
                        loadPendingRequests();
                    } else if (activeSection === 'adminApprovalsSection') {
                        loadAdminApprovals();
                    } else if (activeSection === 'adminRequestHistorySection') {
                        loadRequestHistory();
                    }
                }
            }, (error) => {
                console.error('Requests listener error:', error);
            });
        
        console.log('Real-time listeners established');
    } catch (error) {
        console.error('Error setting up real-time listeners:', error);
    }
}

// Initialize on load
document.addEventListener('DOMContentLoaded', function() {
    // Check if we're in a mobile environment
    if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
        document.body.classList.add('mobile-device');
    }
    
    // Initialize the app
    initApp();
});
    </script>
</body>
</html>
