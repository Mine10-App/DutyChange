<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Duty Management</title>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <!-- SHA-256 Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js"></script>
    
    <!-- External Firebase and User files -->
    <script src="dcfire.js" defer></script>
    <script src="user.js" defer></script>
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* MOBILE FIRST CSS - Optimized for mobile screens */
        :root {
            --primary-color: #3498db;
            --primary-dark: #2980b9;
            --secondary-color: #2c3e50;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --gray-color: #7f8c8d;
            --border-color: #e0e6ed;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            --radius: 12px;
            --radius-sm: 8px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        html {
            height: 100%;
            font-size: 16px;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.5;
            height: 100%;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Login Container - Mobile Optimized */
        .login-container {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 400px;
            padding: 30px 25px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            margin: 0;
        }
        
        .logo {
            text-align: center;
            margin-bottom: 25px;
        }
        
        .logo h1 {
            color: var(--secondary-color);
            font-size: 24px;
            margin-bottom: 5px;
            font-weight: 700;
        }
        
        .logo p {
            color: var(--gray-color);
            font-size: 14px;
        }
        
        .form-group {
            margin-bottom: 18px;
        }
        
        .form-group label {
            display: block;
            color: var(--secondary-color);
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .form-control {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 16px;
            transition: all 0.3s;
            background: white;
            -webkit-appearance: none;
            appearance: none;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        /* Buttons - Mobile Friendly */
        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            height: 50px;
            touch-action: manipulation;
        }
        
        .btn:active {
            transform: translateY(2px);
        }
        
        .btn-primary {
            background: var(--primary-color);
            color: white;
        }
        
        .btn-primary:active {
            background: var(--primary-dark);
        }
        
        .btn-success {
            background: var(--success-color);
            color: white;
        }
        
        .btn-danger {
            background: var(--danger-color);
            color: white;
        }
        
        .btn-warning {
            background: var(--warning-color);
            color: white;
        }
        
        .btn-secondary {
            background: var(--gray-color);
            color: white;
        }
        
        .btn-icon {
            width: 44px;
            height: 44px;
            padding: 0;
            border-radius: 50%;
            justify-content: center;
        }
        
        .btn-block {
            width: 100%;
        }
        
        /* Dashboard Container */
        .dashboard-container {
            display: none;
            width: 100%;
            min-height: 100vh;
            background: white;
            flex-direction: column;
        }
        
        /* Mobile Header */
        .dashboard-header {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            color: white;
            padding: 16px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .user-info h2 {
            font-size: 18px;
            margin-bottom: 4px;
            font-weight: 600;
        }
        
        .user-details {
            font-size: 12px;
            opacity: 0.9;
            display: flex;
            gap: 12px;
        }
        
        .menu-toggle {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            padding: 8px;
            cursor: pointer;
        }
        
        /* Mobile Navigation Drawer */
        .mobile-nav {
            position: fixed;
            top: 0;
            left: -280px;
            width: 280px;
            height: 100vh;
            background: white;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            transition: left 0.3s ease;
            overflow-y: auto;
            padding-top: 60px;
        }
        
        .mobile-nav.active {
            left: 0;
        }
        
        .nav-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }
        
        .nav-overlay.active {
            display: block;
        }
        
        .mobile-nav-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 10px;
        }
        
        .mobile-nav-header h3 {
            color: var(--secondary-color);
            font-size: 18px;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            text-decoration: none;
            color: var(--dark-color);
            transition: background 0.3s;
        }
        
        .nav-item:active {
            background: var(--light-color);
        }
        
        .nav-item i {
            width: 24px;
            margin-right: 12px;
            font-size: 18px;
            color: var(--primary-color);
        }
        
        .nav-item span {
            flex: 1;
            font-size: 16px;
        }
        
        .notification-badge {
            background: var(--danger-color);
            color: white;
            border-radius: 10px;
            padding: 2px 8px;
            font-size: 12px;
            min-width: 20px;
            text-align: center;
        }
        
        /* Bottom Navigation for Mobile */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }
        
        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px;
            text-decoration: none;
            color: var(--gray-color);
            flex: 1;
        }
        
        .bottom-nav-item.active {
            color: var(--primary-color);
        }
        
        .bottom-nav-item i {
            font-size: 20px;
            margin-bottom: 4px;
        }
        
        .bottom-nav-item span {
            font-size: 11px;
            text-align: center;
        }
        
        /* Content Area */
        .dashboard-content {
            flex: 1;
            padding: 20px 16px;
            padding-bottom: 70px; /* Space for bottom nav */
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .section {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .section.active {
            display: block;
        }
        
        /* Cards */
        .card {
            background: white;
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }
        
        .card h3 {
            color: var(--secondary-color);
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .card h3 i {
            font-size: 20px;
        }
        
        /* Quick Actions Grid */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 15px;
        }
        
        .action-card {
            background: white;
            border-radius: var(--radius-sm);
            padding: 16px;
            text-align: center;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            text-decoration: none;
            color: var(--dark-color);
            transition: transform 0.2s;
        }
        
        .action-card:active {
            transform: translateY(2px);
        }
        
        .action-card i {
            font-size: 24px;
            margin-bottom: 8px;
            color: var(--primary-color);
        }
        
        .action-card h4 {
            font-size: 14px;
            margin-bottom: 4px;
        }
        
        .action-card p {
            font-size: 12px;
            color: var(--gray-color);
        }
        
        /* Balance Display - Mobile */
        .balance-display {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin: 15px 0;
        }
        
        .balance-box {
            background: var(--light-color);
            padding: 16px;
            border-radius: var(--radius-sm);
            text-align: center;
            border: 2px solid var(--border-color);
        }
        
        .balance-value {
            font-size: 28px;
            font-weight: bold;
            color: var(--secondary-color);
            margin: 5px 0;
        }
        
        .balance-label {
            font-size: 12px;
            color: var(--gray-color);
            text-transform: uppercase;
        }
        
        /* Mobile Forms */
        .form-row {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-group-inline {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        select.form-control {
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 40px;
        }
        
        /* Mobile Tables */
        .table-container {
            overflow-x: auto;
            margin-top: 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            -webkit-overflow-scrolling: touch;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            min-width: 600px;
        }
        
        th, td {
            padding: 12px 10px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            font-size: 14px;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: var(--secondary-color);
            font-size: 13px;
            position: sticky;
            left: 0;
        }
        
        /* Mobile List Views */
        .list-view {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .list-item {
            background: white;
            border-radius: var(--radius-sm);
            padding: 16px;
            border: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .list-item-content {
            flex: 1;
        }
        
        .list-item-title {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .list-item-subtitle {
            font-size: 13px;
            color: var(--gray-color);
        }
        
        .list-item-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        /* Alerts */
        .alert {
            padding: 14px;
            border-radius: var(--radius-sm);
            margin-bottom: 15px;
            border-left: 4px solid;
            font-size: 14px;
        }
        
        .alert-info {
            background: #e8f4fc;
            border-color: var(--primary-color);
            color: var(--secondary-color);
        }
        
        .alert-success {
            background: #d4edda;
            border-color: var(--success-color);
            color: #155724;
        }
        
        .alert-warning {
            background: #fff3cd;
            border-color: var(--warning-color);
            color: #856404;
        }
        
        .alert-danger {
            background: #f8d7da;
            border-color: var(--danger-color);
            color: #721c24;
        }
        
        /* Mobile Tabs */
        .tab-controls {
            display: flex;
            overflow-x: auto;
            margin-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
            -webkit-overflow-scrolling: touch;
            gap: 5px;
        }
        
        .tab-btn {
            padding: 10px 16px;
            border: none;
            background: #f0f0f0;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .tab-btn.active {
            background: var(--primary-color);
            color: white;
        }
        
        /* Mobile Roster View */
        .roster-day {
            background: white;
            border-radius: var(--radius-sm);
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid var(--border-color);
        }
        
        .roster-day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .roster-date {
            font-weight: 600;
            color: var(--secondary-color);
        }
        
        .roster-duty {
            font-size: 14px;
            padding: 4px 10px;
            border-radius: 20px;
            background: var(--light-color);
        }
        
        /* Swipeable Content */
        .swipe-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scroll-snap-type: x mandatory;
        }
        
        .swipe-item {
            scroll-snap-align: start;
            min-width: 100%;
        }
        
        /* Loading States */
        .loading {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray-color);
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Pull to Refresh */
        .pull-to-refresh {
            position: absolute;
            top: -60px;
            left: 0;
            right: 0;
            text-align: center;
            padding: 20px;
            color: var(--gray-color);
        }
        
        /* Mobile Date Pickers */
        input[type="date"],
        input[type="month"] {
            min-height: 50px;
        }
        
        /* Announcements */
        .announcement-card {
            background: white;
            border-radius: var(--radius);
            padding: 18px;
            margin-bottom: 16px;
            border-left: 4px solid;
            box-shadow: var(--shadow);
        }
        
        .announcement-card.high {
            border-left-color: var(--danger-color);
            background: linear-gradient(135deg, #fff5f5, white);
        }
        
        .announcement-card.medium {
            border-left-color: var(--warning-color);
            background: linear-gradient(135deg, #fff9e6, white);
        }
        
        .announcement-card.low {
            border-left-color: var(--success-color);
            background: linear-gradient(135deg, #f0fff4, white);
        }
        
        .announcement-title {
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .announcement-content {
            font-size: 14px;
            margin-bottom: 12px;
            line-height: 1.5;
        }
        
        .announcement-meta {
            font-size: 12px;
            color: var(--gray-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* Status Badges */
        .status-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-approved {
            background: #d4edda;
            color: #155724;
        }
        
        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 8px 12px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .action-btn:active {
            transform: translateY(2px);
        }
        
        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray-color);
        }
        
        .empty-state i {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        /* Switches and Toggles */
        .switch {
            position: relative;
            display: inline-block;
            width: 52px;
            height: 26px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: var(--primary-color);
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        /* Search Bar */
        .search-bar {
            position: relative;
            margin-bottom: 16px;
        }
        
        .search-bar input {
            width: 100%;
            padding: 14px 16px 14px 44px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 16px;
        }
        
        .search-bar i {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-color);
        }
        
        /* Modal Overlay */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        
        .modal.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: white;
            border-radius: var(--radius);
            padding: 24px;
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            transform: translateY(20px);
            transition: transform 0.3s;
        }
        
        .modal.active .modal-content {
            transform: translateY(0);
        }
        
        /* Responsive Adjustments */
        @media (min-width: 768px) {
            .login-container {
                padding: 40px;
            }
            
            .quick-actions {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .form-row {
                flex-direction: row;
                flex-wrap: wrap;
            }
            
            .form-row .form-group {
                flex: 1;
                min-width: 200px;
            }
            
            .mobile-nav {
                display: none;
            }
            
            .bottom-nav {
                display: none;
            }
            
            .dashboard-content {
                padding-bottom: 20px;
            }
        }
        
        /* Print Styles */
        @media print {
            .bottom-nav,
            .dashboard-header,
            .btn {
                display: none !important;
            }
            
            .dashboard-content {
                padding: 0;
            }
            
            .card {
                box-shadow: none;
                border: 1px solid #000;
            }
        }
        
        /* High Contrast Mode */
        @media (prefers-contrast: high) {
            .btn {
                border: 2px solid currentColor;
            }
            
            .card {
                border: 2px solid currentColor;
            }
        }
        
        /* Reduced Motion */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <!-- Login Container -->
    <div class="login-container" id="loginContainer">
        <div class="logo">
            <h1>Duty Management</h1>
            <p>Secure Login System</p>
        </div>
        
        <form id="loginForm">
            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" class="form-control" placeholder="Enter username" required autofocus>
            </div>
            
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" class="form-control" placeholder="Enter password" required>
            </div>
            
            <button type="submit" class="btn btn-primary" id="loginBtn">
                <i class="fas fa-sign-in-alt"></i> Login
            </button>
            
            <div class="error-message" id="errorMessage">
                Invalid username or password
            </div>
        </form>
    </div>
    
    <!-- Dashboard Container -->
    <div class="dashboard-container" id="dashboardContainer">
        <!-- Mobile Header -->
        <div class="dashboard-header">
            <div class="header-top">
                <div class="user-info">
                    <h2 id="userName">User Name</h2>
                    <div class="user-details">
                        <span>RC: <span id="userRC">000</span></span>
                        <span>Level: <span id="userLevel">User</span></span>
                    </div>
                </div>
                <button class="menu-toggle" id="menuToggle">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </div>
        
        <!-- Mobile Navigation Drawer -->
        <div class="mobile-nav" id="mobileNav">
            <div class="mobile-nav-header">
                <h3>Navigation Menu</h3>
            </div>
            <a href="#" class="nav-item" data-section="home" onclick="showSection('home')">
                <i class="fas fa-home"></i>
                <span>Dashboard</span>
            </a>
            <a href="#" class="nav-item" data-section="dutyChange" onclick="showSection('dutyChange')">
                <i class="fas fa-exchange-alt"></i>
                <span>Duty Change</span>
            </a>
            <a href="#" class="nav-item" data-section="leaveApplication" onclick="showSection('leaveApplication')">
                <i class="fas fa-calendar-minus"></i>
                <span>Apply Leave</span>
            </a>
            <a href="#" class="nav-item" data-section="myRequests" onclick="showSection('myRequests')">
                <i class="fas fa-list"></i>
                <span>My Requests</span>
                <span class="notification-badge" id="mobileRequestCount">0</span>
            </a>
            <a href="#" class="nav-item" data-section="viewMyRoster" onclick="showSection('viewMyRoster')">
                <i class="fas fa-calendar-alt"></i>
                <span>My Roster</span>
            </a>
            <a href="#" class="nav-item" data-section="viewAllRoster" onclick="showSection('viewAllRoster')">
                <i class="fas fa-calendar-week"></i>
                <span>All Roster</span>
            </a>
            
            <!-- Admin Sections -->
            <div class="mobile-nav-header" id="adminNavHeader" style="display: none;">
                <h3>Admin</h3>
            </div>
            <a href="#" class="nav-item" data-section="pendingRequests" id="mobilePendingRequests" onclick="showSection('pendingRequests')" style="display: none;">
                <i class="fas fa-clock"></i>
                <span>Pending Requests</span>
                <span class="notification-badge" id="mobilePendingCount">0</span>
            </a>
            <a href="#" class="nav-item" data-section="adminAnnouncements" id="mobileAnnouncements" onclick="showSection('adminAnnouncements')" style="display: none;">
                <i class="fas fa-bullhorn"></i>
                <span>Announcements</span>
            </a>
            <a href="#" class="nav-item" data-section="adminDutyRoster" id="mobileDutyRoster" onclick="showSection('adminDutyRoster')" style="display: none;">
                <i class="fas fa-edit"></i>
                <span>Duty Roster</span>
            </a>
            <a href="#" class="nav-item" data-section="adminLeaveBalance" id="mobileLeaveBalance" onclick="showSection('adminLeaveBalance')" style="display: none;">
                <i class="fas fa-balance-scale"></i>
                <span>Leave Balance</span>
            </a>
            <a href="#" class="nav-item" data-section="adminApprovals" id="mobileApprovals" onclick="showSection('adminApprovals')" style="display: none;">
                <i class="fas fa-check-circle"></i>
                <span>Approvals</span>
            </a>
            
            <!-- Logout Button -->
            <div style="padding: 20px; border-top: 1px solid var(--border-color); margin-top: 20px;">
                <button class="btn btn-danger btn-block" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>
        
        <!-- Navigation Overlay -->
        <div class="nav-overlay" id="navOverlay"></div>
        
        <!-- Content Area -->
        <div class="dashboard-content">
            <!-- Dashboard -->
            <div class="section active" id="homeSection">
                <div id="homeAnnouncements">
                    <!-- Announcements will be loaded here -->
                </div>
                
                <div class="card">
                    <h3><i class="fas fa-tachometer-alt"></i> Dashboard</h3>
                    
                    <div class="balance-display">
                        <div class="balance-box">
                            <div class="balance-label">Sick Leave</div>
                            <div class="balance-value" id="slBalance">0</div>
                            <div class="balance-label">Days</div>
                        </div>
                        <div class="balance-box">
                            <div class="balance-label">FRL Balance</div>
                            <div class="balance-value" id="frlBalance">0</div>
                            <div class="balance-label">Days</div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <p><strong>Today's Duty:</strong> <span id="todayDutyTime">Not Scheduled</span></p>
                        <p><strong>Next Duty:</strong> <span id="nextDutyTime">No upcoming duty</span></p>
                        <div id="homeNotifications" style="margin-top: 10px; display: none;">
                            <!-- Notifications will appear here -->
                        </div>
                    </div>
                    
                    <h4 style="margin: 20px 0 10px 0;">Quick Actions</h4>
                    <div class="quick-actions">
                        <a href="#" class="action-card" onclick="showSection('dutyChange')">
                            <i class="fas fa-exchange-alt"></i>
                            <h4>Duty Change</h4>
                            <p>Request swap</p>
                        </a>
                        <a href="#" class="action-card" onclick="showSection('leaveApplication')">
                            <i class="fas fa-calendar-minus"></i>
                            <h4>Apply Leave</h4>
                            <p>Sick/FRL</p>
                        </a>
                        <a href="#" class="action-card" onclick="showSection('myRequests')">
                            <i class="fas fa-list"></i>
                            <h4>My Requests</h4>
                            <p>View status</p>
                        </a>
                        <a href="#" class="action-card" onclick="showSection('viewMyRoster')">
                            <i class="fas fa-calendar-alt"></i>
                            <h4>My Roster</h4>
                            <p>View schedule</p>
                        </a>
                        <a href="#" class="action-card" onclick="showSection('viewAllRoster')">
                            <i class="fas fa-calendar-week"></i>
                            <h4>All Roster</h4>
                            <p>Team schedule</p>
                        </a>
                        <a href="#" class="action-card" onclick="updateDashboard()">
                            <i class="fas fa-sync-alt"></i>
                            <h4>Refresh</h4>
                            <p>Update data</p>
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Duty Change Request -->
            <div class="section" id="dutyChangeSection">
                <div class="card">
                    <h3><i class="fas fa-exchange-alt"></i> Duty Change Request</h3>
                    
                    <div class="alert alert-warning">
                        <strong>Note:</strong> Requests must be made at least 24 hours in advance.
                    </div>
                    
                    <form id="dutyChangeForm">
                        <div class="form-group">
                            <label for="changeDate">Change Date *</label>
                            <input type="date" id="changeDate" class="form-control" required min="">
                        </div>
                        
                        <div class="form-group">
                            <label for="changeDutyTime">Your Duty Time *</label>
                            <select id="changeDutyTime" class="form-control" required>
                                <option value="">Select duty time</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="requestToStaff">Request To Staff *</label>
                            <select id="requestToStaff" class="form-control" required>
                                <option value="">Select staff member</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="requestToDutyTime">Staff's Duty Time *</label>
                            <select id="requestToDutyTime" class="form-control" required>
                                <option value="">Select duty time</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="changeReason">Reason (Optional)</label>
                            <textarea id="changeReason" class="form-control" rows="2" placeholder="Brief reason for duty change"></textarea>
                        </div>
                        
                        <div class="form-row" style="flex-direction: row; gap: 10px; margin-top: 20px;">
                            <button type="submit" class="btn btn-success" style="flex: 1;">
                                <i class="fas fa-paper-plane"></i> Submit
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="showSection('home')" style="flex: 1;">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Leave Application -->
            <div class="section" id="leaveApplicationSection">
                <div class="card">
                    <h3><i class="fas fa-calendar-minus"></i> Apply Leave</h3>
                    
                    <div class="alert alert-info">
                        <p><strong>Application Rules:</strong></p>
                        <p>• Sick Leave: 2+ hours before duty</p>
                        <p>• FRL: 1+ hour before duty</p>
                        <p>• No backdated applications</p>
                    </div>
                    
                    <form id="leaveApplicationForm">
                        <div class="form-group">
                            <label for="leaveType">Leave Type *</label>
                            <select id="leaveType" class="form-control" required>
                                <option value="">Select leave type</option>
                                <option value="Sick Leave">Sick Leave</option>
                                <option value="FRL">FRL</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="leaveDate">Leave Date *</label>
                            <input type="date" id="leaveDate" class="form-control" required min="">
                        </div>
                        
                        <div class="form-group">
                            <label for="leaveDutyTime">Duty Time *</label>
                            <select id="leaveDutyTime" class="form-control" required>
                                <option value="">Select duty time</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="leaveDuration">Duration *</label>
                            <select id="leaveDuration" class="form-control" required>
                                <option value="1">1 Day</option>
                                <option value="0.5">Half Day</option>
                                <option value="2">2 Days</option>
                                <option value="3">3 Days</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="leaveReason">Reason *</label>
                            <textarea id="leaveReason" class="form-control" rows="3" placeholder="Please provide reason for leave" required></textarea>
                        </div>
                        
                        <div class="alert" id="leaveRulesAlert">
                            Select leave type, date and duty time to see rules
                        </div>
                        
                        <div class="form-row" style="flex-direction: row; gap: 10px; margin-top: 20px;">
                            <button type="submit" class="btn btn-success" id="submitLeaveBtn" style="flex: 1;">
                                <i class="fas fa-paper-plane"></i> Submit
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="showSection('home')" style="flex: 1;">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- My Requests - Mobile Optimized -->
            <div class="section" id="myRequestsSection">
                <div class="card">
                    <h3><i class="fas fa-list"></i> My Requests</h3>
                    
                    <div class="search-bar">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchRequests" placeholder="Search requests...">
                    </div>
                    
                    <div class="list-view" id="myRequestsList">
                        <!-- Requests will be loaded here -->
                    </div>
                </div>
            </div>
            
            <!-- My Roster - Mobile View -->
            <div class="section" id="viewMyRosterSection">
                <div class="card">
                    <h3><i class="fas fa-calendar-alt"></i> My Roster</h3>
                    
                    <div class="form-row" style="flex-direction: row;">
                        <div class="form-group" style="flex: 2;">
                            <label for="myRosterMonth">Month</label>
                            <input type="month" id="myRosterMonth" class="form-control" value="">
                        </div>
                        <div class="form-group" style="flex: 1; margin-top: 25px;">
                            <button class="btn btn-primary" onclick="loadMyRoster()">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        Shows your scheduled duties. Changes via Duty Change.
                    </div>
                    
                    <div id="myRosterContainer" style="margin-top: 20px;">
                        <!-- Roster will be displayed here -->
                    </div>
                </div>
            </div>
            
            <!-- View All Roster - Mobile Optimized -->
            <div class="section" id="viewAllRosterSection">
                <div class="card">
                    <h3><i class="fas fa-calendar-week"></i> All Roster</h3>
                    
                    <div class="form-group">
                        <label for="allRosterStartDate">From Date</label>
                        <input type="date" id="allRosterStartDate" class="form-control" value="">
                    </div>
                    
                    <div class="form-group">
                        <label for="allRosterEndDate">To Date</label>
                        <input type="date" id="allRosterEndDate" class="form-control" value="">
                    </div>
                    
                    <div class="form-row" style="flex-direction: row; gap: 10px; margin-top: 10px;">
                        <button class="btn btn-primary" onclick="loadAllRoster()" style="flex: 1;">
                            <i class="fas fa-eye"></i> View
                        </button>
                        <button class="btn btn-secondary" onclick="printAllRoster()" style="flex: 1;">
                            <i class="fas fa-print"></i> Print
                        </button>
                    </div>
                    
                    <div class="alert alert-info">
                        Complete duty roster for all staff members.
                    </div>
                    
                    <div id="allRosterContainer" style="margin-top: 20px;">
                        <!-- Roster will be displayed here -->
                    </div>
                </div>
            </div>
            
            <!-- Pending Requests (Admin/User) -->
            <div class="section" id="pendingRequestsSection">
                <div class="card">
                    <h3><i class="fas fa-clock"></i> Pending Requests</h3>
                    
                    <div class="list-view" id="pendingRequestsList">
                        <!-- Pending requests will be loaded here -->
                    </div>
                </div>
            </div>
            
            <!-- Admin: Announcement Management -->
            <div class="section" id="adminAnnouncementsSection">
                <div class="card">
                    <h3><i class="fas fa-bullhorn"></i> Create Announcement</h3>
                    
                    <form id="announcementForm">
                        <div class="form-group">
                            <label for="announcementTitle">Title *</label>
                            <input type="text" id="announcementTitle" class="form-control" placeholder="Enter title" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="announcementContent">Content *</label>
                            <textarea id="announcementContent" class="form-control" rows="4" placeholder="Enter announcement details..." required></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>Priority *</label>
                            <div class="form-row" style="flex-direction: row;">
                                <button type="button" class="btn btn-danger" onclick="selectPriority('high')" style="flex: 1; margin: 2px;">High</button>
                                <button type="button" class="btn btn-warning" onclick="selectPriority('medium')" style="flex: 1; margin: 2px;">Medium</button>
                                <button type="button" class="btn btn-success" onclick="selectPriority('low')" style="flex: 1; margin: 2px;">Low</button>
                            </div>
                            <input type="hidden" id="announcementPriority" value="medium">
                        </div>
                        
                        <div class="form-group">
                            <label>Target Audience *</label>
                            <select id="announcementTarget" class="form-control" onchange="toggleStaffSelection()">
                                <option value="all">All Staff</option>
                                <option value="specific">Specific Staff</option>
                            </select>
                        </div>
                        
                        <div class="form-group" id="specificStaffGroup" style="display: none;">
                            <label for="announcementStaff">Select Staff</label>
                            <select id="announcementStaff" class="form-control" multiple style="height: 120px;">
                                <!-- Staff options will be loaded -->
                            </select>
                        </div>
                        
                        <div class="form-row" style="flex-direction: row; gap: 10px; margin-top: 20px;">
                            <button type="submit" class="btn btn-success" style="flex: 1;">
                                <i class="fas fa-plus"></i> Create
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="clearAnnouncementForm()" style="flex: 1;">
                                <i class="fas fa-times"></i> Clear
                            </button>
                        </div>
                    </form>
                </div>
                
                <div class="card">
                    <h3><i class="fas fa-bullhorn"></i> Active Announcements</h3>
                    <div id="activeAnnouncementsList">
                        <!-- Active announcements will be loaded here -->
                    </div>
                </div>
            </div>
            
            <!-- Other Admin Sections would follow similar mobile-optimized patterns -->
        </div>
        
        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <a href="#" class="bottom-nav-item active" onclick="showSection('home')">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </a>
            <a href="#" class="bottom-nav-item" onclick="showSection('dutyChange')">
                <i class="fas fa-exchange-alt"></i>
                <span>Change</span>
            </a>
            <a href="#" class="bottom-nav-item" onclick="showSection('leaveApplication')">
                <i class="fas fa-calendar-minus"></i>
                <span>Leave</span>
            </a>
            <a href="#" class="bottom-nav-item" onclick="showSection('myRequests')">
                <i class="fas fa-list"></i>
                <span>Requests</span>
                <span class="notification-badge" id="bottomRequestCount" style="position: absolute; top: 4px; right: 20px; font-size: 10px; padding: 1px 4px;">0</span>
            </a>
            <a href="#" class="bottom-nav-item" onclick="showSection('viewMyRoster')">
                <i class="fas fa-calendar-alt"></i>
                <span>Roster</span>
            </a>
        </div>
    </div>

    <!-- Modal for details -->
    <div class="modal" id="detailsModal">
        <div class="modal-content">
            <h3 id="modalTitle"></h3>
            <div id="modalContent"></div>
            <button class="btn btn-secondary btn-block" onclick="closeModal()" style="margin-top: 20px;">
                <i class="fas fa-times"></i> Close
            </button>
        </div>
    </div>

    <script>
      // Mobile Duty Management System
// Complete JavaScript Implementation

// Global variables
let currentUser = null;
let allUsers = [];
let dutyRoster = {};
let leaveBalances = {};
let allRequests = [];
let announcements = [];
let userDisplayNameMap = {};
let firebaseReady = false;
let refreshTimer = null;

// Color mapping for duty times (optimized for mobile)
const dutyTimeColorMap = {
    // Common shift times
    '07:30-15:30': 'duty-0730',
    '08:30-16:30': 'duty-0830',
    '10:30-18:30': 'duty-1030',
    '15:30-23:30': 'duty-1530',
    '16:30-00:30': 'duty-1630',
    '17:30-01:30': 'duty-1730',
    '00:30-08:30': 'duty-0030',
    
    // Off duty
    'Off': 'off-day',
    'Not Scheduled': 'off-day',
    
    // Leave
    'Leave': 'duty-leave',
    'Sick Leave': 'duty-leave',
    'FRL': 'duty-leave'
};

// Mobile-specific initialization
document.addEventListener('DOMContentLoaded', function() {
    console.log('Mobile Duty Management System Initializing...');
    
    // Check for service worker for PWA capabilities
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js').then(function(registration) {
            console.log('Service Worker registered with scope:', registration.scope);
        }).catch(function(error) {
            console.log('Service Worker registration failed:', error);
        });
    }
    
    // Check if Firebase is available
    if (typeof db === 'undefined') {
        showMobileError('Firebase is not initialized. Make sure dcfire.js is loaded.');
        return;
    }
    
    // Wait for user data to load
    setTimeout(() => {
        if (typeof users === 'undefined') {
            showMobileError('User data not loaded. Please check user.js file.');
            return;
        }
        
        firebaseReady = true;
        console.log('Mobile app initialized successfully');
        initMobileApp();
    }, 1000);
    
    // Setup mobile-specific event listeners
    setupMobileEvents();
    
    // Handle back button on mobile
    window.addEventListener('popstate', function(e) {
        if (currentUser) {
            showSection('home');
        }
    });
});

function initMobileApp() {
    if (!firebaseReady) {
        setTimeout(initMobileApp, 500);
        return;
    }
    
    // Setup login
    document.getElementById('loginForm').addEventListener('submit', function(e) {
        e.preventDefault();
        handleMobileLogin();
    });
    
    // Set minimum dates for forms
    const today = new Date().toISOString().split('T')[0];
    setMinDates(today);
    
    // Check session
    checkMobileSession();
}

function setupMobileEvents() {
    // Menu toggle
    document.getElementById('menuToggle').addEventListener('click', toggleMobileMenu);
    
    // Bottom nav clicks
    document.querySelectorAll('.bottom-nav-item').forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const section = this.getAttribute('onclick').match(/showSection\('([^']+)'\)/)[1];
            showSection(section);
        });
    });
    
    // Nav drawer items
    document.querySelectorAll('.mobile-nav .nav-item').forEach(item => {
        item.addEventListener('click', function(e) {
            closeMobileMenu();
        });
    });
    
    // Logout button
    document.getElementById('logoutBtn').addEventListener('click', function() {
        localStorage.removeItem('dutySystemSession');
        clearInterval(refreshTimer);
        location.reload();
    });
    
    // Form submissions
    document.getElementById('dutyChangeForm')?.addEventListener('submit', submitDutyChange);
    document.getElementById('leaveApplicationForm')?.addEventListener('submit', submitLeaveApplication);
    document.getElementById('announcementForm')?.addEventListener('submit', createAnnouncement);
    
    // Search functionality
    const searchInput = document.getElementById('searchRequests');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            filterMobileRequests(this.value);
        });
    }
    
    // Date input changes
    document.getElementById('changeDate')?.addEventListener('change', function() {
        loadUserDutyTimes('changeDutyTime', this.value);
    });
    
    document.getElementById('requestToStaff')?.addEventListener('change', function() {
        const user = allUsers.find(u => u.username === this.value);
        if (user) {
            const date = document.getElementById('changeDate').value;
            if (date) {
                loadStaffDutyTimes('requestToDutyTime', date, user.username);
            }
        }
    });
    
    document.getElementById('leaveDate')?.addEventListener('change', function() {
        loadUserDutyTimes('leaveDutyTime', this.value);
        updateLeaveRules();
    });
    
    document.getElementById('leaveType')?.addEventListener('change', updateLeaveRules);
    document.getElementById('leaveDutyTime')?.addEventListener('change', updateLeaveRules);
    
    // Handle offline/online status
    window.addEventListener('online', handleOnlineStatus);
    window.addEventListener('offline', handleOfflineStatus);
    
    // Handle app visibility
    document.addEventListener('visibilitychange', handleVisibilityChange);
}

function handleMobileLogin() {
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value.trim();
    
    if (!username || !password) {
        showMobileToast('Please enter both username and password', 'warning');
        return;
    }
    
    if (!users || !Array.isArray(users)) {
        showMobileToast('User database not loaded', 'danger');
        return;
    }
    
    const user = users.find(u => u.username === username);
    
    if (!user) {
        showMobileToast('Invalid username or password', 'danger');
        return;
    }
    
    // Hash and check password
    const hashedPassword = sha256(password);
    
    if (hashedPassword === user.passwordHash) {
        const sessionData = {
            username: user.username,
            name: user.name,
            rcNo: user.RCNo,
            level: user.Level,
            expiry: Date.now() + (8 * 60 * 60 * 1000)
        };
        
        localStorage.setItem('dutySystemSession', JSON.stringify(sessionData));
        loginMobileUser(sessionData);
    } else {
        showMobileToast('Invalid username or password', 'danger');
    }
}

function checkMobileSession() {
    const session = localStorage.getItem('dutySystemSession');
    if (session) {
        try {
            const user = JSON.parse(session);
            if (user.expiry > Date.now()) {
                loginMobileUser(user);
            } else {
                localStorage.removeItem('dutySystemSession');
                showMobileToast('Session expired. Please login again.', 'info');
            }
        } catch (e) {
            localStorage.removeItem('dutySystemSession');
        }
    }
}

function loginMobileUser(userData) {
    currentUser = userData;
    allUsers = users || [];
    
    console.log('Mobile user logged in:', currentUser);
    
    // Initialize user display name map
    initializeUserDisplayMap();
    
    // Update UI
    document.getElementById('loginContainer').style.display = 'none';
    document.getElementById('dashboardContainer').style.display = 'flex';
    
    // Update user info
    document.getElementById('userName').textContent = userData.name;
    document.getElementById('userRC').textContent = userData.rcNo;
    document.getElementById('userLevel').textContent = userData.level;
    
    // Show/hide admin sections
    if (userData.level === 'Supervisor') {
        showAdminSections(true);
    }
    
    // Initialize data and UI
    initializeMobileData();
    updateMobileDashboard();
    
    // Start auto-refresh timer
    startAutoRefresh();
}

function initializeUserDisplayMap() {
    userDisplayNameMap = {};
    allUsers.forEach(user => {
        // Map common display names to usernames
        userDisplayNameMap[user.name] = user.username;
        userDisplayNameMap[user.RCNo] = user.username;
        userDisplayNameMap[user.username] = user.username;
        
        // For names like "Irufan1", "Irufan2"
        if (user.name.includes('Irufan')) {
            const match = user.name.match(/Irufan\s*(\d*)/i);
            if (match && match[1]) {
                userDisplayNameMap[`Irufan${match[1]}`] = user.username;
            }
        }
        
        // Map common variations
        const nameLower = user.name.toLowerCase();
        const usernameLower = user.username.toLowerCase();
        userDisplayNameMap[nameLower] = user.username;
        userDisplayNameMap[usernameLower] = user.username;
    });
    
    console.log('User display map initialized:', Object.keys(userDisplayNameMap).length, 'entries');
}

async function initializeMobileData() {
    console.log('Initializing mobile data from Firebase...');
    
    try {
        // Load all data from Firebase
        await Promise.all([
            loadDutyRoster(),
            loadLeaveBalances(),
            loadAllRequests(),
            loadAnnouncements()
        ]);
        
        console.log('Mobile data loaded successfully');
        
        // Update user's balance display
        updateUserBalance();
        
        // Setup real-time listeners
        setupRealtimeListeners();
        
    } catch (error) {
        console.error('Error initializing mobile data:', error);
        showMobileToast('Failed to load data. Please check connection.', 'danger');
    }
}

// Firebase Functions
async function loadDutyRoster() {
    try {
        const doc = await db.collection('dutyRoster').doc('current').get();
        if (doc.exists) {
            dutyRoster = doc.data() || {};
            console.log('Duty roster loaded:', Object.keys(dutyRoster).length, 'dates');
        } else {
            dutyRoster = {};
            await saveDutyRoster();
        }
    } catch (error) {
        console.error('Error loading duty roster:', error);
        dutyRoster = {};
        showMobileToast('Error loading roster', 'danger');
    }
}

async function saveDutyRoster() {
    try {
        await db.collection('dutyRoster').doc('current').set(dutyRoster);
        console.log('Duty roster saved');
    } catch (error) {
        console.error('Error saving duty roster:', error);
        showMobileToast('Failed to save roster', 'danger');
    }
}

async function loadLeaveBalances() {
    try {
        const doc = await db.collection('leaveBalances').doc('current').get();
        if (doc.exists) {
            leaveBalances = doc.data() || {};
            console.log('Leave balances loaded:', Object.keys(leaveBalances).length, 'users');
        } else {
            leaveBalances = {};
            allUsers.forEach(user => {
                leaveBalances[user.username] = { SL: 12, FRL: 6 };
            });
            await saveLeaveBalances();
        }
    } catch (error) {
        console.error('Error loading leave balances:', error);
        leaveBalances = {};
        showMobileToast('Error loading balances', 'danger');
    }
}

async function saveLeaveBalances() {
    try {
        await db.collection('leaveBalances').doc('current').set(leaveBalances);
        console.log('Leave balances saved');
    } catch (error) {
        console.error('Error saving leave balances:', error);
        showMobileToast('Failed to save balances', 'danger');
    }
}

async function loadAllRequests() {
    try {
        const doc = await db.collection('requests').doc('all').get();
        if (doc.exists && doc.data().requests) {
            allRequests = doc.data().requests;
            console.log('Requests loaded:', allRequests.length, 'requests');
        } else {
            allRequests = [];
        }
        updateRequestCounts();
    } catch (error) {
        console.error('Error loading requests:', error);
        allRequests = [];
        showMobileToast('Error loading requests', 'danger');
    }
}

async function saveAllRequests() {
    try {
        await db.collection('requests').doc('all').set({ requests: allRequests });
        console.log('Requests saved');
    } catch (error) {
        console.error('Error saving requests:', error);
        showMobileToast('Failed to save requests', 'danger');
    }
}

async function loadAnnouncements() {
    try {
        const doc = await db.collection('announcements').doc('all').get();
        if (doc.exists && doc.data().announcements) {
            announcements = doc.data().announcements;
            console.log('Announcements loaded:', announcements.length, 'announcements');
        } else {
            announcements = [];
            await saveAnnouncements();
        }
    } catch (error) {
        console.error('Error loading announcements:', error);
        announcements = [];
        showMobileToast('Error loading announcements', 'danger');
    }
}

async function saveAnnouncements() {
    try {
        await db.collection('announcements').doc('all').set({ announcements: announcements });
        console.log('Announcements saved');
    } catch (error) {
        console.error('Error saving announcements:', error);
        showMobileToast('Failed to save announcements', 'danger');
    }
}

// UI Functions
function showSection(sectionId) {
    // Close mobile menu if open
    closeMobileMenu();
    
    // Update bottom nav active state
    document.querySelectorAll('.bottom-nav-item').forEach(item => {
        item.classList.remove('active');
    });
    
    // Map section to bottom nav item
    const navMap = {
        'home': 0,
        'dutyChange': 1,
        'leaveApplication': 2,
        'myRequests': 3,
        'viewMyRoster': 4
    };
    
    if (navMap[sectionId] !== undefined) {
        document.querySelectorAll('.bottom-nav-item')[navMap[sectionId]].classList.add('active');
    }
    
    // Hide all sections
    document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
    });
    
    // Show selected section
    const section = document.getElementById(sectionId + 'Section');
    if (section) {
        section.classList.add('active');
        
        // Scroll to top of content
        setTimeout(() => {
            section.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 100);
        
        // Load section data
        loadSectionData(sectionId);
    }
    
    // Update browser history for back button
    history.pushState({ section: sectionId }, '', `#${sectionId}`);
}

function loadSectionData(sectionId) {
    switch(sectionId) {
        case 'home':
            loadHomeAnnouncements();
            updateMobileDashboard();
            break;
        case 'dutyChange':
            loadDutyChangeForm();
            break;
        case 'leaveApplication':
            loadLeaveForm();
            break;
        case 'myRequests':
            loadMyRequests();
            break;
        case 'viewMyRoster':
            loadMyRoster();
            break;
        case 'viewAllRoster':
            loadAllRoster();
            break;
        case 'pendingRequests':
            loadPendingRequests();
            break;
        case 'adminAnnouncements':
            loadAnnouncementsAdmin();
            break;
        case 'adminDutyRoster':
            loadDutyRosterAdmin();
            break;
        case 'adminLeaveBalance':
            loadLeaveBalanceAdmin();
            break;
        case 'adminApprovals':
            loadAdminApprovals();
            break;
        case 'adminRequestHistory':
            loadAdminRequestHistory();
            break;
    }
}

function updateMobileDashboard() {
    if (!currentUser) return;
    
    // Update today's duty
    const today = new Date().toISOString().split('T')[0];
    if (dutyRoster[today] && dutyRoster[today][currentUser.username]) {
        const duty = dutyRoster[today][currentUser.username];
        document.getElementById('todayDutyTime').textContent = duty === 'Off' ? 'Off Duty' : duty;
    } else {
        document.getElementById('todayDutyTime').textContent = 'Not Scheduled';
    }
    
    // Find next duty (next 7 days)
    const tomorrow = new Date();
    for (let i = 1; i <= 7; i++) {
        tomorrow.setDate(tomorrow.getDate() + 1);
        const dateStr = tomorrow.toISOString().split('T')[0];
        if (dutyRoster[dateStr] && dutyRoster[dateStr][currentUser.username]) {
            const duty = dutyRoster[dateStr][currentUser.username];
            if (duty !== 'Off') {
                document.getElementById('nextDutyTime').textContent = `${formatMobileDate(dateStr)}: ${duty}`;
                break;
            }
        }
    }
    
    // Update balance display
    updateUserBalance();
    
    // Load announcements
    loadHomeAnnouncements();
    
    // Show refresh timestamp
    const now = new Date();
    document.getElementById('refreshTime')?.textContent = `Last updated: ${formatTime(now)}`;
}

function updateUserBalance() {
    if (!currentUser) return;
    
    const balance = leaveBalances[currentUser.username] || {SL: 0, FRL: 0};
    document.getElementById('slBalance').textContent = balance.SL.toFixed(1);
    document.getElementById('frlBalance').textContent = balance.FRL.toFixed(1);
}

function loadHomeAnnouncements() {
    const container = document.getElementById('homeAnnouncements');
    if (!container) return;
    
    container.innerHTML = '';
    
    const now = new Date();
    const activeAnnouncements = announcements.filter(ann => {
        if (ann.status === 'expired' || ann.status === 'archived') return false;
        if (ann.expiry && new Date(ann.expiry) < now) return false;
        
        // Check if announcement is for current user
        if (ann.target === 'all') return true;
        if (ann.target === 'specific' && ann.targetUsers && ann.targetUsers.includes(currentUser.username)) return true;
        return false;
    });
    
    if (activeAnnouncements.length === 0) return;
    
    // Sort by priority (high to low) and date (newest first)
    activeAnnouncements.sort((a, b) => {
        const priorityOrder = {high: 0, medium: 1, low: 2};
        if (priorityOrder[a.priority] !== priorityOrder[b.priority]) {
            return priorityOrder[a.priority] - priorityOrder[b.priority];
        }
        return new Date(b.createdAt) - new Date(a.createdAt);
    });
    
    // Show only latest 3 announcements on home
    const displayAnnouncements = activeAnnouncements.slice(0, 3);
    
    displayAnnouncements.forEach(ann => {
        const announcementDiv = document.createElement('div');
        announcementDiv.className = `announcement-card ${ann.priority}`;
        
        announcementDiv.innerHTML = `
            <div class="announcement-title">
                <i class="fas fa-bullhorn"></i> ${ann.title}
            </div>
            <div class="announcement-content">${ann.content}</div>
            <div class="announcement-meta">
                <div>${formatTimeAgo(ann.createdAt)}</div>
                <div>${ann.target === 'all' ? 'All Staff' : 'Specific'}</div>
            </div>
        `;
        
        container.appendChild(announcementDiv);
    });
}

// Form Handling
function loadDutyChangeForm() {
    // Set default date to tomorrow
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    const tomorrowStr = tomorrow.toISOString().split('T')[0];
    
    document.getElementById('changeDate').value = tomorrowStr;
    document.getElementById('changeDate').min = tomorrowStr;
    
    // Populate staff dropdown
    const staffSelect = document.getElementById('requestToStaff');
    staffSelect.innerHTML = '<option value="">Select staff member</option>';
    
    allUsers.forEach(user => {
        if (user.username !== currentUser.username && user.Level === 'User') {
            const option = document.createElement('option');
            option.value = user.username;
            option.textContent = `${user.name} (RC: ${user.RCNo})`;
            staffSelect.appendChild(option);
        }
    });
    
    // Load duty times
    loadUserDutyTimes('changeDutyTime', tomorrowStr);
}

function loadUserDutyTimes(selectId, date) {
    const select = document.getElementById(selectId);
    if (!select) return;
    
    select.innerHTML = '<option value="">Select duty time</option>';
    
    if (!date || !currentUser) return;
    
    const dutyTime = dutyRoster[date] && dutyRoster[date][currentUser.username];
    if (dutyTime) {
        const option = document.createElement('option');
        option.value = dutyTime;
        option.textContent = dutyTime === 'Off' ? 'Off Duty' : dutyTime;
        select.appendChild(option);
    } else {
        const option = document.createElement('option');
        option.value = 'No Duty';
        option.textContent = 'No duty scheduled';
        select.appendChild(option);
    }
}

function loadStaffDutyTimes(selectId, date, username) {
    const select = document.getElementById(selectId);
    if (!select) return;
    
    select.innerHTML = '<option value="">Select duty time</option>';
    
    if (!date || !username) return;
    
    const dutyTime = dutyRoster[date] && dutyRoster[date][username];
    if (dutyTime) {
        const option = document.createElement('option');
        option.value = dutyTime;
        option.textContent = dutyTime === 'Off' ? 'Off Duty' : dutyTime;
        select.appendChild(option);
    } else {
        const option = document.createElement('option');
        option.value = 'No Duty';
        option.textContent = 'No duty scheduled';
        select.appendChild(option);
    }
}

async function submitDutyChange(e) {
    e.preventDefault();
    
    const date = document.getElementById('changeDate').value;
    const dutyTime = document.getElementById('changeDutyTime').value;
    const toStaff = document.getElementById('requestToStaff').value;
    const toDutyTime = document.getElementById('requestToDutyTime').value;
    const reason = document.getElementById('changeReason').value;
    
    if (!date || !dutyTime || !toStaff || !toDutyTime) {
        showMobileToast('Please fill all required fields', 'warning');
        return;
    }
    
    if (dutyTime === 'No Duty' || toDutyTime === 'No Duty') {
        showMobileToast('Cannot request duty change when no duty is scheduled', 'warning');
        return;
    }
    
    const toUser = allUsers.find(u => u.username === toStaff);
    if (!toUser) {
        showMobileToast('Selected staff not found', 'danger');
        return;
    }
    
    // Check if date is at least 24 hours in advance
    const requestDate = new Date(date);
    const now = new Date();
    const hoursDifference = (requestDate - now) / (1000 * 60 * 60);
    
    if (hoursDifference < 24) {
        showMobileToast('Duty change must be requested at least 24 hours in advance', 'warning');
        return;
    }
    
    const request = {
        id: 'req_' + Date.now(),
        type: 'dutyChange',
        fromUsername: currentUser.username,
        fromName: currentUser.name,
        fromRcNo: currentUser.rcNo,
        date: date,
        dutyTime: dutyTime,
        toUsername: toStaff,
        toName: toUser.name,
        toRcNo: toUser.RCNo,
        toDutyTime: toDutyTime,
        reason: reason,
        status: 'pending',
        timestamp: new Date().toISOString(),
        history: [{
            action: 'created',
            by: currentUser.name,
            timestamp: new Date().toISOString()
        }]
    };
    
    allRequests.push(request);
    
    try {
        await saveAllRequests();
        updateRequestCounts();
        showMobileToast('Duty change request submitted!', 'success');
        showSection('myRequests');
        document.getElementById('dutyChangeForm').reset();
    } catch (error) {
        showMobileToast('Failed to submit request. Please try again.', 'danger');
    }
}

function loadLeaveForm() {
    // Set default date to tomorrow
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    const tomorrowStr = tomorrow.toISOString().split('T')[0];
    
    document.getElementById('leaveDate').value = tomorrowStr;
    document.getElementById('leaveDate').min = tomorrowStr;
    
    // Load duty times
    loadUserDutyTimes('leaveDutyTime', tomorrowStr);
    updateLeaveRules();
}

function updateLeaveRules() {
    const leaveType = document.getElementById('leaveType').value;
    const leaveDate = document.getElementById('leaveDate').value;
    const dutyTime = document.getElementById('leaveDutyTime').value;
    const alertDiv = document.getElementById('leaveRulesAlert');
    const submitBtn = document.getElementById('submitLeaveBtn');
    
    if (!leaveType || !leaveDate || !dutyTime || dutyTime === 'No Duty') {
        alertDiv.className = 'alert alert-warning';
        alertDiv.textContent = 'Please select leave type, date and duty time';
        if (submitBtn) submitBtn.disabled = true;
        return;
    }
    
    if (dutyTime === 'Off') {
        alertDiv.className = 'alert alert-warning';
        alertDiv.textContent = 'You are off duty on this date. No leave needed.';
        if (submitBtn) submitBtn.disabled = true;
        return;
    }
    
    const dutyStart = dutyTime.split('-')[0];
    const dutyDateTime = new Date(leaveDate + 'T' + dutyStart + ':00');
    const now = new Date();
    const hoursBeforeDuty = (dutyDateTime - now) / (1000 * 60 * 60);
    
    let canApply = false;
    let message = '';
    
    if (leaveType === 'Sick Leave') {
        canApply = hoursBeforeDuty >= 2;
        message = canApply 
            ? '✓ You can apply for Sick Leave (2+ hours before duty)'
            : `✗ Sick Leave must be applied at least 2 hours before duty (${Math.ceil(2 - hoursBeforeDuty)} more hours needed)`;
    } else if (leaveType === 'FRL') {
        canApply = hoursBeforeDuty >= 1;
        message = canApply
            ? '✓ You can apply for FRL (1+ hour before duty)'
            : `✗ FRL must be applied at least 1 hour before duty (${Math.ceil(1 - hoursBeforeDuty)} more hours needed)`;
    }
    
    alertDiv.className = canApply ? 'alert alert-success' : 'alert alert-danger';
    alertDiv.innerHTML = `<strong>${leaveType} Rules:</strong><br>${message}`;
    if (submitBtn) submitBtn.disabled = !canApply;
}

async function submitLeaveApplication(e) {
    e.preventDefault();
    
    const leaveType = document.getElementById('leaveType').value;
    const date = document.getElementById('leaveDate').value;
    const dutyTime = document.getElementById('leaveDutyTime').value;
    const duration = parseFloat(document.getElementById('leaveDuration').value);
    const reason = document.getElementById('leaveReason').value;
    
    if (!leaveType || !date || !dutyTime || !reason) {
        showMobileToast('Please fill all required fields', 'warning');
        return;
    }
    
    if (dutyTime === 'No Duty' || dutyTime === 'Off') {
        showMobileToast('You are off duty on this date. No leave needed.', 'warning');
        return;
    }
    
    // Check balance
    const userBalance = leaveBalances[currentUser.username];
    if (!userBalance) {
        showMobileToast('Error: User balance not found', 'danger');
        return;
    }
    
    // Validate sufficient balance
    if (leaveType === 'Sick Leave' && userBalance.SL < duration) {
        showMobileToast(`Insufficient Sick Leave balance. Available: ${userBalance.SL.toFixed(1)} days, Requested: ${duration} days`, 'warning');
        return;
    }
    
    if (leaveType === 'FRL' && userBalance.FRL < duration) {
        showMobileToast(`Insufficient FRL balance. Available: ${userBalance.FRL.toFixed(1)} days, Requested: ${duration} days`, 'warning');
        return;
    }
    
    const request = {
        id: 'req_' + Date.now(),
        type: 'leave',
        leaveType: leaveType,
        fromUsername: currentUser.username,
        fromName: currentUser.name,
        fromRcNo: currentUser.rcNo,
        date: date,
        dutyTime: dutyTime,
        duration: duration,
        reason: reason,
        status: 'pending',
        timestamp: new Date().toISOString(),
        history: [{
            action: 'created',
            by: currentUser.name,
            timestamp: new Date().toISOString()
        }]
    };
    
    allRequests.push(request);
    
    try {
        await saveAllRequests();
        updateRequestCounts();
        showMobileToast('Leave application submitted!', 'success');
        showSection('myRequests');
        document.getElementById('leaveApplicationForm').reset();
        
        // Force dashboard update
        updateMobileDashboard();
        updateUserBalance();
    } catch (error) {
        showMobileToast('Failed to submit leave application. Please try again.', 'danger');
    }
}

// My Requests
function loadMyRequests() {
    const container = document.getElementById('myRequestsList');
    if (!container) return;
    
    container.innerHTML = '';
    
    const myReqs = allRequests.filter(req => req.fromUsername === currentUser.username);
    
    if (myReqs.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-inbox"></i>
                <p>No requests found</p>
                <p class="small">You haven't made any requests yet.</p>
            </div>
        `;
        return;
    }
    
    // Sort by timestamp descending (newest first)
    myReqs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    
    myReqs.forEach(req => {
        const listItem = document.createElement('div');
        listItem.className = 'list-item';
        
        let details = '';
        let icon = '';
        
        if (req.type === 'dutyChange') {
            details = `Swap with ${req.toName}`;
            icon = '<i class="fas fa-exchange-alt"></i>';
        } else {
            details = `${req.leaveType} - ${req.duration} day(s)`;
            icon = '<i class="fas fa-calendar-minus"></i>';
        }
        
        const statusClass = `status-${req.status}`;
        const statusText = req.status.charAt(0).toUpperCase() + req.status.slice(1);
        
        listItem.innerHTML = `
            <div class="list-item-content">
                <div class="list-item-title">${icon} ${req.type === 'dutyChange' ? 'Duty Change' : 'Leave'}</div>
                <div class="list-item-subtitle">
                    ${formatMobileDate(req.date)} • ${details}<br>
                    <small>${req.reason ? req.reason.substring(0, 50) + (req.reason.length > 50 ? '...' : '') : ''}</small>
                </div>
            </div>
            <div class="list-item-badge ${statusClass}">${statusText}</div>
        `;
        
        // Add click handler for details
        listItem.addEventListener('click', function() {
            showRequestDetails(req);
        });
        
        container.appendChild(listItem);
    });
}

function filterMobileRequests(searchTerm) {
    const container = document.getElementById('myRequestsList');
    const items = container.querySelectorAll('.list-item');
    
    items.forEach(item => {
        const text = item.textContent.toLowerCase();
        if (text.includes(searchTerm.toLowerCase())) {
            item.style.display = 'flex';
        } else {
            item.style.display = 'none';
        }
    });
}

function showRequestDetails(request) {
    let details = '';
    
    if (request.type === 'dutyChange') {
        details = `
            <p><strong>Type:</strong> Duty Change</p>
            <p><strong>Date:</strong> ${request.date}</p>
            <p><strong>Your Duty:</strong> ${request.dutyTime}</p>
            <p><strong>Swap With:</strong> ${request.toName} (${request.toDutyTime})</p>
            ${request.reason ? `<p><strong>Reason:</strong> ${request.reason}</p>` : ''}
            <p><strong>Status:</strong> <span class="status-${request.status}">${request.status.charAt(0).toUpperCase() + request.status.slice(1)}</span></p>
            <p><strong>Submitted:</strong> ${formatDateTime(request.timestamp)}</p>
        `;
    } else {
        details = `
            <p><strong>Type:</strong> ${request.leaveType}</p>
            <p><strong>Date:</strong> ${request.date}</p>
            <p><strong>Duty Time:</strong> ${request.dutyTime}</p>
            <p><strong>Duration:</strong> ${request.duration} day(s)</p>
            <p><strong>Reason:</strong> ${request.reason}</p>
            <p><strong>Status:</strong> <span class="status-${request.status}">${request.status.charAt(0).toUpperCase() + request.status.slice(1)}</span></p>
            <p><strong>Submitted:</strong> ${formatDateTime(request.timestamp)}</p>
        `;
    }
    
    // Show history if available
    if (request.history && request.history.length > 0) {
        details += `<p><strong>History:</strong></p><ul>`;
        request.history.forEach(event => {
            details += `<li>${event.action} by ${event.by} (${formatTimeAgo(event.timestamp)})</li>`;
        });
        details += `</ul>`;
    }
    
    if (request.status === 'pending') {
        details += `
            <div style="margin-top: 20px;">
                <button class="btn btn-danger btn-block" onclick="cancelRequest('${request.id}')">
                    <i class="fas fa-times"></i> Cancel Request
                </button>
            </div>
        `;
    }
    
    openModal('Request Details', details);
}

// Roster Functions
function loadMyRoster() {
    const container = document.getElementById('myRosterContainer');
    const monthInput = document.getElementById('myRosterMonth').value;
    
    if (!monthInput) {
        container.innerHTML = '<div class="alert alert-warning">Please select a month</div>';
        return;
    }
    
    const [year, month] = monthInput.split('-');
    const startDate = new Date(year, month - 1, 1);
    const endDate = new Date(year, month, 0);
    
    displayMobileMyRoster(container, startDate, endDate, year, month);
}

function displayMobileMyRoster(container, startDate, endDate, year, month) {
    let html = `<h4 style="margin-bottom: 15px;">${getMonthName(month)} ${year}</h4>`;
    
    const today = new Date().toISOString().split('T')[0];
    let dutyCount = 0;
    let offCount = 0;
    let leaveCount = 0;
    
    html += '<div class="list-view">';
    
    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
        const dateStr = d.toISOString().split('T')[0];
        const dayName = d.toLocaleDateString('en-US', { weekday: 'short' });
        
        let dutyTime = 'Not Scheduled';
        let statusClass = '';
        let statusText = '';
        let isToday = dateStr === today;
        
        // Check for approved leave
        const approvedLeave = allRequests.find(req => 
            req.fromUsername === currentUser.username &&
            req.type === 'leave' &&
            req.status === 'approved' &&
            req.date === dateStr
        );
        
        if (approvedLeave) {
            dutyTime = `${approvedLeave.leaveType} - ${approvedLeave.duration} day(s)`;
            statusClass = 'status-approved';
            statusText = 'On Leave';
            leaveCount += approvedLeave.duration;
        } else if (dutyRoster[dateStr] && dutyRoster[dateStr][currentUser.username]) {
            dutyTime = dutyRoster[dateStr][currentUser.username];
            if (dutyTime === 'Off') {
                statusClass = 'status-off';
                statusText = 'Off Duty';
                offCount++;
            } else {
                statusClass = dateStr < today ? 'status-completed' : 'status-pending';
                statusText = dateStr < today ? 'Completed' : 'Scheduled';
                dutyCount++;
            }
        } else {
            statusClass = 'status-pending';
            statusText = 'Not Scheduled';
        }
        
        html += `
            <div class="list-item ${isToday ? 'today-item' : ''}" style="${isToday ? 'border-left: 4px solid #3498db;' : ''}">
                <div class="list-item-content">
                    <div class="list-item-title">
                        ${dateStr} ${isToday ? '<span style="color: #3498db; font-weight: bold;">(Today)</span>' : ''}
                    </div>
                    <div class="list-item-subtitle">
                        ${dayName} • ${dutyTime}
                    </div>
                </div>
                <div class="list-item-badge ${statusClass}">${statusText}</div>
            </div>
        `;
    }
    
    html += '</div>';
    
    // Add summary
    html += `
        <div class="alert alert-info" style="margin-top: 15px;">
            <strong>Summary:</strong><br>
            • ${dutyCount} duty days<br>
            • ${offCount} off days<br>
            • ${leaveCount.toFixed(1)} leave days
        </div>
    `;
    
    container.innerHTML = html;
}

function loadAllRoster() {
    const container = document.getElementById('allRosterContainer');
    const startDate = document.getElementById('allRosterStartDate').value;
    const endDate = document.getElementById('allRosterEndDate').value;
    
    if (!startDate || !endDate) {
        container.innerHTML = '<div class="alert alert-warning">Please select start and end dates</div>';
        return;
    }
    
    const start = new Date(startDate);
    const end = new Date(endDate);
    
    if (start > end) {
        container.innerHTML = '<div class="alert alert-warning">Start date must be before end date</div>';
        return;
    }
    
    displayMobileAllRoster(container, start, end);
}

function displayMobileAllRoster(container, startDate, endDate) {
    const today = new Date().toISOString().split('T')[0];
    
    let html = `<h4 style="margin-bottom: 15px;">${formatMobileDate(startDate)} to ${formatMobileDate(endDate)}</h4>`;
    
    // Group by date
    html += '<div class="list-view">';
    
    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
        const dateStr = d.toISOString().split('T')[0];
        const dayName = d.toLocaleDateString('en-US', { weekday: 'short' });
        const isToday = dateStr === today;
        
        html += `
            <div class="roster-day ${isToday ? 'today' : ''}">
                <div class="roster-day-header">
                    <div class="roster-date">${dateStr} ${isToday ? '<strong>(Today)</strong>' : ''}</div>
                    <div class="roster-day-name">${dayName}</div>
                </div>
        `;
        
        // Add staff duties for this day
        allUsers.forEach(user => {
            if (user.Level === 'User') {
                let dutyInfo = '';
                let dutyClass = '';
                
                // Check for approved leave
                const approvedLeave = allRequests.find(req => 
                    req.fromUsername === user.username &&
                    req.type === 'leave' &&
                    req.status === 'approved' &&
                    req.date === dateStr
                );
                
                if (approvedLeave) {
                    dutyInfo = `${user.name}: ${approvedLeave.leaveType} (${approvedLeave.duration} day)`;
                    dutyClass = 'duty-leave';
                } else if (dutyRoster[dateStr] && dutyRoster[dateStr][user.username]) {
                    const dutyTime = dutyRoster[dateStr][user.username];
                    if (dutyTime !== 'Off') {
                        dutyInfo = `${user.name}: ${dutyTime}`;
                        dutyClass = getDutyClass(dutyTime);
                    }
                }
                
                if (dutyInfo) {
                    html += `
                        <div class="roster-staff ${dutyClass}" style="margin: 5px 0; padding: 5px; border-radius: 4px;">
                            ${dutyInfo}
                        </div>
                    `;
                }
            }
        });
        
        html += `</div>`;
    }
    
    html += '</div>';
    
    // Add legend
    html += `
        <div class="alert alert-info" style="margin-top: 15px;">
            <strong>Legend:</strong><br>
            <span class="duty-0730" style="padding: 2px 5px;">07:30 Shift</span>
            <span class="duty-0830" style="padding: 2px 5px;">08:30 Shift</span>
            <span class="duty-leave" style="padding: 2px 5px;">Leave</span>
            <span class="off-day" style="padding: 2px 5px;">Off Duty</span>
        </div>
    `;
    
    container.innerHTML = html;
}

// Pending Requests
function loadPendingRequests() {
    const container = document.getElementById('pendingRequestsList');
    if (!container) return;
    
    container.innerHTML = '';
    
    const pendingReqs = allRequests.filter(req => 
        req.status === 'pending' && 
        req.type === 'dutyChange' && 
        req.toUsername === currentUser.username
    );
    
    if (pendingReqs.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-check-circle"></i>
                <p>No pending requests</p>
                <p class="small">You're all caught up!</p>
            </div>
        `;
        return;
    }
    
    pendingReqs.forEach(req => {
        const listItem = document.createElement('div');
        listItem.className = 'list-item';
        
        listItem.innerHTML = `
            <div class="list-item-content">
                <div class="list-item-title">
                    <i class="fas fa-exchange-alt"></i> Duty Change Request
                </div>
                <div class="list-item-subtitle">
                    From: ${req.fromName}<br>
                    Date: ${req.date}<br>
                    Swap: ${req.dutyTime} ↔ ${req.toDutyTime}
                    ${req.reason ? `<br><small>Reason: ${req.reason}</small>` : ''}
                </div>
            </div>
            <div class="action-buttons">
                <button class="action-btn approve" onclick="respondToRequest('${req.id}', 'approved')">
                    <i class="fas fa-check"></i>
                </button>
                <button class="action-btn reject" onclick="respondToRequest('${req.id}', 'rejected')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        
        container.appendChild(listItem);
    });
}

// Request Management
async function cancelRequest(requestId) {
    if (!confirm('Are you sure you want to cancel this request?')) return;
    
    const request = allRequests.find(req => req.id === requestId);
    if (request) {
        request.status = 'cancelled';
        request.history.push({
            action: 'cancelled',
            by: currentUser.name,
            timestamp: new Date().toISOString()
        });
        
        try {
            await saveAllRequests();
            loadMyRequests();
            updateRequestCounts();
            closeModal();
            showMobileToast('Request cancelled successfully', 'success');
        } catch (error) {
            showMobileToast('Failed to cancel request', 'danger');
        }
    }
}

async function respondToRequest(requestId, response) {
    const request = allRequests.find(req => req.id === requestId);
    if (!request) return;
    
    if (response === 'approved') {
        // Swap duty times in roster
        const date = request.date;
        if (dutyRoster[date]) {
            const temp = dutyRoster[date][request.fromUsername];
            dutyRoster[date][request.fromUsername] = dutyRoster[date][request.toUsername];
            dutyRoster[date][request.toUsername] = temp;
            await saveDutyRoster();
        }
    }
    
    request.status = response;
    request.respondedAt = new Date().toISOString();
    request.history.push({
        action: response,
        by: currentUser.name,
        timestamp: new Date().toISOString()
    });
    
    try {
        await saveAllRequests();
        showMobileToast(`Request ${response} successfully!`, 'success');
        loadPendingRequests();
        updateRequestCounts();
    } catch (error) {
        showMobileToast(`Failed to ${response} request`, 'danger');
    }
}

// Announcements Admin
function loadAnnouncementsAdmin() {
    // Setup announcement form
    setupAnnouncementForm();
    loadActiveAnnouncements();
}

function setupAnnouncementForm() {
    // Populate staff dropdown
    const staffSelect = document.getElementById('announcementStaff');
    staffSelect.innerHTML = '';
    
    allUsers.forEach(user => {
        if (user.Level === 'User') {
            const option = document.createElement('option');
            option.value = user.username;
            option.textContent = `${user.name} (${user.RCNo})`;
            staffSelect.appendChild(option);
        }
    });
}

function toggleStaffSelection() {
    const target = document.getElementById('announcementTarget').value;
    const staffGroup = document.getElementById('specificStaffGroup');
    
    if (target === 'specific') {
        staffGroup.style.display = 'block';
    } else {
        staffGroup.style.display = 'none';
    }
}

function selectPriority(priority) {
    document.getElementById('announcementPriority').value = priority;
    
    // Update button styles
    document.querySelectorAll('#announcementForm .btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    const activeBtn = document.querySelector(`#announcementForm .btn-${priority === 'high' ? 'danger' : priority === 'medium' ? 'warning' : 'success'}`);
    if (activeBtn) {
        activeBtn.classList.add('active');
    }
}

async function createAnnouncement(e) {
    e.preventDefault();
    
    const title = document.getElementById('announcementTitle').value.trim();
    const content = document.getElementById('announcementContent').value.trim();
    const priority = document.getElementById('announcementPriority').value;
    const target = document.getElementById('announcementTarget').value;
    
    if (!title || !content) {
        showMobileToast('Please fill in title and content', 'warning');
        return;
    }
    
    let targetUsers = [];
    if (target === 'specific') {
        const staffSelect = document.getElementById('announcementStaff');
        targetUsers = Array.from(staffSelect.selectedOptions).map(option => option.value);
        
        if (targetUsers.length === 0) {
            showMobileToast('Please select at least one staff member', 'warning');
            return;
        }
    }
    
    const announcement = {
        id: 'ann_' + Date.now(),
        title: title,
        content: content,
        priority: priority,
        target: target,
        targetUsers: targetUsers,
        createdBy: currentUser.name,
        createdByUsername: currentUser.username,
        createdAt: new Date().toISOString(),
        status: 'active'
    };
    
    announcements.push(announcement);
    
    try {
        await saveAnnouncements();
        showMobileToast('Announcement created successfully!', 'success');
        clearAnnouncementForm();
        loadActiveAnnouncements();
    } catch (error) {
        showMobileToast('Failed to create announcement', 'danger');
    }
}

function clearAnnouncementForm() {
    document.getElementById('announcementForm').reset();
    document.getElementById('announcementPriority').value = 'medium';
    document.getElementById('specificStaffGroup').style.display = 'none';
}

function loadActiveAnnouncements() {
    const container = document.getElementById('activeAnnouncementsList');
    if (!container) return;
    
    container.innerHTML = '';
    
    const now = new Date();
    const activeAnnouncements = announcements.filter(ann => {
        if (ann.status === 'expired' || ann.status === 'archived') return false;
        if (ann.expiry && new Date(ann.expiry) < now) return false;
        return true;
    });
    
    if (activeAnnouncements.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-bullhorn"></i>
                <p>No active announcements</p>
            </div>
        `;
        return;
    }
    
    activeAnnouncements.forEach(ann => {
        const announcementDiv = document.createElement('div');
        announcementDiv.className = `announcement-card ${ann.priority}`;
        
        let targetText = ann.target === 'all' ? 'All Staff' : 'Specific Staff';
        
        announcementDiv.innerHTML = `
            <div class="announcement-title">
                <i class="fas fa-bullhorn"></i> ${ann.title}
            </div>
            <div class="announcement-content">${ann.content}</div>
            <div class="announcement-meta">
                <div>By ${ann.createdBy} • ${formatTimeAgo(ann.createdAt)}</div>
                <div>${targetText}</div>
            </div>
            <div class="action-buttons" style="margin-top: 10px;">
                <button class="action-btn delete" onclick="deleteAnnouncement('${ann.id}')">
                    <i class="fas fa-trash"></i> Delete
                </button>
            </div>
        `;
        
        container.appendChild(announcementDiv);
    });
}

async function deleteAnnouncement(announcementId) {
    if (!confirm('Are you sure you want to delete this announcement?')) return;
    
    const index = announcements.findIndex(ann => ann.id === announcementId);
    if (index !== -1) {
        announcements.splice(index, 1);
        
        try {
            await saveAnnouncements();
            loadActiveAnnouncements();
            showMobileToast('Announcement deleted!', 'success');
        } catch (error) {
            showMobileToast('Failed to delete announcement', 'danger');
        }
    }
}

// Request Counts and Notifications
function updateRequestCounts() {
    if (!currentUser) return;
    
    // Count pending requests for current user
    const pendingForUser = allRequests.filter(req => 
        req.status === 'pending' && 
        req.type === 'dutyChange' && 
        req.toUsername === currentUser.username
    ).length;
    
    // Update notification badges
    updateNotificationBadge('mobilePendingCount', pendingForUser);
    updateNotificationBadge('bottomRequestCount', pendingForUser);
    
    // Show/hide pending requests in mobile nav
    const pendingItem = document.getElementById('mobilePendingRequests');
    if (pendingItem) {
        if (pendingForUser > 0) {
            pendingItem.style.display = 'flex';
        } else {
            pendingItem.style.display = 'none';
        }
    }
    
    // Update supervisor notifications
    if (currentUser.level === 'Supervisor') {
        const pendingRequests = allRequests.filter(req => 
            req.status === 'pending' && 
            (req.type === 'leave' || req.type === 'dutyChange')
        ).length;
        
        updateNotificationBadge('adminNotificationCount', pendingRequests);
    }
}

function updateNotificationBadge(elementId, count) {
    const element = document.getElementById(elementId);
    if (element) {
        if (count > 0) {
            element.textContent = count > 99 ? '99+' : count;
            element.style.display = 'inline-block';
        } else {
            element.style.display = 'none';
        }
    }
}

// Utility Functions
function setMinDates(today) {
    const dateInputs = document.querySelectorAll('input[type="date"], input[type="month"]');
    dateInputs.forEach(input => {
        if (input.type === 'date') {
            input.min = today;
        }
        if (!input.value) {
            if (input.type === 'date') {
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                input.value = tomorrow.toISOString().split('T')[0];
            } else if (input.type === 'month') {
                input.value = today.substring(0, 7);
            }
        }
    });
}

function formatMobileDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

function formatDateTime(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
}

function formatTime(date) {
    return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
}

function formatTimeAgo(timestamp) {
    const now = new Date();
    const past = new Date(timestamp);
    const diffMs = now - past;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMins / 60);
    const diffDays = Math.floor(diffHours / 24);
    
    if (diffMins < 1) return 'just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    if (diffDays < 7) return `${diffDays}d ago`;
    
    return past.toLocaleDateString();
}

function getMonthName(monthNumber) {
    const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
    return months[parseInt(monthNumber) - 1];
}

function getDutyClass(dutyTime) {
    if (!dutyTime) return '';
    
    const time = dutyTime.replace(/\s/g, '').toUpperCase();
    
    // Try exact match
    if (dutyTimeColorMap[time]) {
        return dutyTimeColorMap[time];
    }
    
    // Try partial match
    for (const key in dutyTimeColorMap) {
        if (time.includes(key)) {
            return dutyTimeColorMap[key];
        }
    }
    
    // Default based on time
    if (time.includes('07:30')) return 'duty-0730';
    if (time.includes('08:30')) return 'duty-0830';
    if (time.includes('10:30')) return 'duty-1030';
    if (time.includes('15:30')) return 'duty-1530';
    if (time.includes('16:30')) return 'duty-1630';
    if (time.includes('17:30')) return 'duty-1730';
    if (time.includes('00:30')) return 'duty-0030';
    
    return '';
}

// Mobile UI Functions
function toggleMobileMenu() {
    const nav = document.getElementById('mobileNav');
    const overlay = document.getElementById('navOverlay');
    
    nav.classList.toggle('active');
    overlay.classList.toggle('active');
    
    // Prevent body scroll when menu is open
    document.body.style.overflow = nav.classList.contains('active') ? 'hidden' : 'auto';
}

function closeMobileMenu() {
    document.getElementById('mobileNav').classList.remove('active');
    document.getElementById('navOverlay').classList.remove('active');
    document.body.style.overflow = 'auto';
}

function showAdminSections(show) {
    const adminElements = [
        'adminNavHeader',
        'mobilePendingRequests',
        'mobileAnnouncements',
        'mobileDutyRoster',
        'mobileLeaveBalance',
        'mobileApprovals'
    ];
    
    adminElements.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.style.display = show ? 'block' : 'none';
            if (element.classList.contains('nav-item')) {
                element.style.display = show ? 'flex' : 'none';
            }
        }
    });
}

function showMobileToast(message, type = 'info') {
    // Remove existing toast
    const existingToast = document.querySelector('.mobile-toast');
    if (existingToast) {
        existingToast.remove();
    }
    
    // Create toast
    const toast = document.createElement('div');
    toast.className = `mobile-toast toast-${type}`;
    toast.innerHTML = `
        <div class="toast-content">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
            <span>${message}</span>
        </div>
    `;
    
    // Add styles
    toast.style.cssText = `
        position: fixed;
        top: 70px;
        left: 50%;
        transform: translateX(-50%);
        background: ${type === 'success' ? '#27ae60' : type === 'danger' ? '#e74c3c' : type === 'warning' ? '#f39c12' : '#3498db'};
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 1000;
        animation: slideDown 0.3s ease;
        max-width: 90%;
        text-align: center;
    `;
    
    document.body.appendChild(toast);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        toast.style.animation = 'slideUp 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

function showMobileError(message) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'mobile-error';
    errorDiv.innerHTML = `
        <div style="text-align: center; padding: 20px;">
            <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #e74c3c; margin-bottom: 15px;"></i>
            <h3>System Error</h3>
            <p>${message}</p>
            <button onclick="location.reload()" style="margin-top: 15px; padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer;">
                Reload Page
            </button>
        </div>
    `;
    
    document.body.innerHTML = '';
    document.body.appendChild(errorDiv);
}

// Network Status Handling
function handleOnlineStatus() {
    showMobileToast('You are back online', 'success');
    // Refresh data when coming back online
    initializeMobileData();
}

function handleOfflineStatus() {
    showMobileToast('You are offline. Some features may not work.', 'warning');
}

function handleVisibilityChange() {
    if (!document.hidden) {
        // App became visible, refresh data
        updateMobileDashboard();
    }
}

// Auto-refresh
function startAutoRefresh() {
    // Clear existing timer
    if (refreshTimer) {
        clearInterval(refreshTimer);
    }
    
    // Refresh every 5 minutes
    refreshTimer = setInterval(() => {
        if (!document.hidden) {
            updateMobileDashboard();
        }
    }, 5 * 60 * 1000);
}

// Setup real-time listeners
function setupRealtimeListeners() {
    try {
        // Listen for announcement updates
        db.collection('announcements').doc('all')
            .onSnapshot((doc) => {
                if (doc.exists) {
                    announcements = doc.data().announcements || [];
                    if (document.getElementById('homeSection').classList.contains('active')) {
                        loadHomeAnnouncements();
                    }
                }
            }, handleFirebaseError);

        // Listen for request updates
        db.collection('requests').doc('all')
            .onSnapshot((doc) => {
                if (doc.exists && doc.data().requests) {
                    allRequests = doc.data().requests;
                    updateRequestCounts();
                    
                    // Refresh current view if it's requests-related
                    const activeSection = document.querySelector('.section.active');
                    if (activeSection && (activeSection.id.includes('Requests') || activeSection.id.includes('Approvals'))) {
                        loadSectionData(activeSection.id.replace('Section', ''));
                    }
                }
            }, handleFirebaseError);
            
        console.log('Real-time listeners established');
    } catch (error) {
        console.error('Error setting up real-time listeners:', error);
    }
}

function handleFirebaseError(error) {
    console.error('Firebase error:', error);
    
    if (error.code === 'failed-precondition' || error.message.includes('QUIC')) {
        console.log('Retrying Firebase operation...');
        setTimeout(() => {
            initializeMobileData();
        }, 2000);
    }
}

// Print functionality
function printAllRoster() {
    const content = document.getElementById('allRosterContainer').innerHTML;
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
        <head>
            <title>Duty Roster Report</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                .roster-day { margin-bottom: 15px; padding: 10px; border: 1px solid #ddd; }
                .roster-day-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
                .roster-staff { margin: 5px 0; padding: 3px; }
                .duty-0730 { background-color: #fff3cd; }
                .duty-0830 { background-color: #e2d9f3; }
                .duty-leave { background-color: #ffd8a6; border: 1px dashed #fd7e14; }
                .off-day { background-color: #d4edda; }
                h3 { color: #2c3e50; }
            </style>
        </head>
        <body>
            <h3>Duty Roster Report</h3>
            <p>Generated on: ${new Date().toLocaleString()}</p>
            <p>Generated by: ${currentUser.name}</p>
            ${content}
        </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
}

// Add CSS animations
const style = document.createElement('style');
style.textContent = `
    @keyframes slideDown {
        from { transform: translate(-50%, -100%); opacity: 0; }
        to { transform: translate(-50%, 0); opacity: 1; }
    }
    
    @keyframes slideUp {
        from { transform: translate(-50%, 0); opacity: 1; }
        to { transform: translate(-50%, -100%); opacity: 0; }
    }
    
    .today-item {
        background-color: rgba(52, 152, 219, 0.1);
        border-left: 4px solid #3498db !important;
    }
    
    .duty-0730 {
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        color: #856404;
    }
    
    .duty-0830 {
        background: linear-gradient(135deg, #e2d9f3 0%, #d6c6f7 100%);
        color: #563d7c;
    }
    
    .duty-1030 {
        background: linear-gradient(135deg, #fffde7 0%, #fff9c4 100%);
        color: #827717;
    }
    
    .duty-1530 {
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        color: #0d47a1;
    }
    
    .duty-1630 {
        background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);
        color: #424242;
    }
    
    .duty-1730 {
        background: linear-gradient(135deg, #eeeeee 0%, #bdbdbd 100%);
        color: #212121;
    }
    
    .duty-0030 {
        background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
        color: #c62828;
    }
    
    .duty-leave {
        background: linear-gradient(135deg, #ffd8a6 0%, #ffc078 100%);
        color: #e8590c;
        border: 1px dashed #fd7e14;
    }
    
    .off-day {
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        color: #155724;
    }
    
    .status-off {
        color: #7f8c8d;
    }
    
    .status-completed {
        color: #3498db;
    }
    
    .btn.active {
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
    }
`;
document.head.appendChild(style);

// Initialize the app
console.log('Mobile Duty Management System JavaScript loaded');
     </script>
     </body>
     </html> 
