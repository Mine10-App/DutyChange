<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duty Management System</title>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <!-- SHA-256 Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js"></script>
    
    <!-- External files -->
    <script src="dcfire.js" defer></script>
    <script src="user.js" defer></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        body {
            background: #f5f7fa;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        /* Login Page */
        .login-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            padding: 40px;
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo h1 {
            color: #2c3e50;
            font-size: 28px;
            margin-bottom: 5px;
        }

        .logo p {
            color: #7f8c8d;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #2c3e50;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e6ed;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .btn {
            width: 100%;
            padding: 14px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #27ae60;
        }

        .btn-success:hover {
            background: #219653;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-warning {
            background: #f39c12;
        }

        .btn-warning:hover {
            background: #d68910;
        }

        .error-message {
            background: #ffeaea;
            color: #e74c3c;
            padding: 12px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
            font-size: 14px;
        }

        /* Dashboard */
        .dashboard-container {
            display: none;
            width: 100%;
            max-width: 1200px;
            min-height: 600px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        /* Header */
        .dashboard-header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info h2 {
            font-size: 20px;
            margin-bottom: 5px;
        }

        .user-details {
            font-size: 14px;
            opacity: 0.9;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        /* Navigation */
        .dashboard-nav {
            background: #34495e;
            padding: 15px 30px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .nav-btn {
            background: none;
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .nav-btn.active {
            background: #3498db;
        }

        /* Content Area */
        .dashboard-content {
            padding: 30px;
            min-height: 500px;
        }

        .section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .section.active {
            display: block;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid #e0e6ed;
        }

        .card h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 18px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        /* Forms */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group-inline {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        select.form-control {
            background: white;
            cursor: pointer;
        }

        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e0e6ed;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .status-pending {
            color: #f39c12;
            font-weight: 500;
        }

        .status-approved {
            color: #27ae60;
            font-weight: 500;
        }

        .status-rejected {
            color: #e74c3c;
            font-weight: 500;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-btn.approve {
            background: #d4edda;
            color: #155724;
        }

        .action-btn.reject {
            background: #f8d7da;
            color: #721c24;
        }

        .action-btn.view {
            background: #d1ecf1;
            color: #0c5460;
        }

        /* Alerts */
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }

        .alert-info {
            background: #e8f4fc;
            border-color: #3498db;
            color: #2c3e50;
        }

        .alert-success {
            background: #d4edda;
            border-color: #27ae60;
            color: #155724;
        }

        .alert-warning {
            background: #fff3cd;
            border-color: #f39c12;
            color: #856404;
        }

        /* Calendar */
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        .calendar-header {
            text-align: center;
            font-weight: 600;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .calendar-day {
            padding: 15px;
            border: 1px solid #e0e6ed;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .calendar-day:hover {
            background: #f8f9fa;
        }

        .calendar-day.selected {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        .calendar-day.duty {
            background: #d4edda;
            border-color: #27ae60;
        }

        .calendar-day.off {
            background: #f8d7da;
            border-color: #e74c3c;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .dashboard-nav {
                flex-direction: column;
                gap: 10px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .calendar {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Login Container -->
    <div class="login-container" id="loginContainer">
        <div class="logo">
            <h1>Duty Management</h1>
            <p>Secure Login System</p>
        </div>
        
        <form id="loginForm">
            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" class="form-control" placeholder="Enter username" required>
            </div>
            
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" class="form-control" placeholder="Enter password" required>
            </div>
            
            <button type="submit" class="btn" id="loginBtn">Login</button>
            
            <div class="error-message" id="errorMessage">
                Invalid username or password
            </div>
        </form>
    </div>
    
    <!-- Dashboard Container -->
    <div class="dashboard-container" id="dashboardContainer">
        <!-- Header -->
        <div class="dashboard-header">
            <div class="user-info">
                <h2 id="userName">User Name</h2>
                <div class="user-details">
                    <span>RC: <span id="userRC">000</span></span> | 
                    <span>Level: <span id="userLevel">User</span></span>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn btn-danger" id="logoutBtn">Logout</button>
            </div>
        </div>
        
        <!-- Navigation -->
        <div class="dashboard-nav">
            <button class="nav-btn active" data-section="home">Dashboard</button>
            <button class="nav-btn" data-section="dutyChange">Duty Change Request</button>
            <button class="nav-btn" data-section="leaveApplication">Leave Application</button>
            <button class="nav-btn" data-section="myRequests">My Requests</button>
            <button class="nav-btn" data-section="pendingRequests" id="pendingRequestsBtn" style="display:none;">
                Pending Requests <span id="pendingCount" class="notification-badge">0</span>
            </button>
            <!-- Admin Only Sections -->
            <button class="nav-btn" data-section="adminDutyRoster" id="adminDutyRosterBtn" style="display:none;">
                Duty Roster
            </button>
            <button class="nav-btn" data-section="adminLeaveBalance" id="adminLeaveBalanceBtn" style="display:none;">
                Leave Balance
            </button>
            <button class="nav-btn" data-section="adminApprovals" id="adminApprovalsBtn" style="display:none;">
                Approve Requests
            </button>
        </div>
        
        <!-- Content Area -->
        <div class="dashboard-content">
            <!-- Home/Dashboard -->
            <div class="section active" id="homeSection">
                <div class="card">
                    <h3>Welcome, <span id="welcomeName">User</span>!</h3>
                    <div class="alert alert-info">
                        <p><strong>Today's Duty:</strong> <span id="todayDutyTime">Not Scheduled</span></p>
                        <p><strong>Next Duty:</strong> <span id="nextDutyTime">No upcoming duty</span></p>
                    </div>
                    
                    <div class="form-row">
                        <div class="card">
                            <h4>SL Balance: <span id="slBalance">0</span> hours</h4>
                        </div>
                        <div class="card">
                            <h4>FRL Balance: <span id="frlBalance">0</span> hours</h4>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3>Quick Actions</h3>
                        <div class="form-row">
                            <button class="btn btn-warning" onclick="showSection('dutyChange')">Request Duty Change</button>
                            <button class="btn btn-success" onclick="showSection('leaveApplication')">Apply Leave</button>
                            <button class="btn" onclick="showSection('myRequests')">View My Requests</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Duty Change Request -->
            <div class="section" id="dutyChangeSection">
                <div class="card">
                    <h3>Duty Change Request</h3>
                    <div class="alert alert-warning">
                        Note: Duty change requests must be made at least 24 hours in advance.
                    </div>
                    
                    <form id="dutyChangeForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="changeDate">Change Date *</label>
                                <input type="date" id="changeDate" class="form-control" required min="">
                            </div>
                            <div class="form-group">
                                <label for="changeDutyTime">Your Duty Time *</label>
                                <select id="changeDutyTime" class="form-control" required>
                                    <option value="">Select duty time</option>
                                    <!-- Populated by JavaScript -->
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="requestToStaff">Request To Staff *</label>
                                <select id="requestToStaff" class="form-control" required>
                                    <option value="">Select staff member</option>
                                    <!-- Populated by JavaScript -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="requestToRcNo">Staff RC No</label>
                                <input type="text" id="requestToRcNo" class="form-control" readonly>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="requestToDutyTime">Staff's Duty Time *</label>
                                <select id="requestToDutyTime" class="form-control" required>
                                    <option value="">Select duty time</option>
                                    <!-- Populated by JavaScript -->
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="changeReason">Reason for Change</label>
                                <textarea id="changeReason" class="form-control" rows="3" placeholder="Brief reason for duty change"></textarea>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <button type="submit" class="btn btn-success">Submit Request</button>
                            <button type="button" class="btn" onclick="showSection('home')">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Leave Application -->
            <div class="section" id="leaveApplicationSection">
                <div class="card">
                    <h3>Leave Application</h3>
                    <div class="alert alert-info">
                        <p><strong>Rules:</strong></p>
                        <p>• Sick Leave: Can apply up to 2 hours before duty time</p>
                        <p>• FRL: Can apply up to 1 hour before duty time</p>
                    </div>
                    
                    <form id="leaveApplicationForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="leaveType">Leave Type *</label>
                                <select id="leaveType" class="form-control" required>
                                    <option value="">Select leave type</option>
                                    <option value="Sick Leave">Sick Leave</option>
                                    <option value="FRL">FRL</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="leaveDate">Leave Date *</label>
                                <input type="date" id="leaveDate" class="form-control" required min="">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="leaveDutyTime">Duty Time *</label>
                                <select id="leaveDutyTime" class="form-control" required>
                                    <option value="">Select duty time</option>
                                    <!-- Populated by JavaScript -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="leaveDuration">Duration (hours) *</label>
                                <select id="leaveDuration" class="form-control" required>
                                    <option value="1">1 hour</option>
                                    <option value="2">2 hours</option>
                                    <option value="4">4 hours</option>
                                    <option value="8">8 hours</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="leaveReason">Reason *</label>
                                <textarea id="leaveReason" class="form-control" rows="4" placeholder="Please provide detailed reason for leave" required></textarea>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="alert alert-warning" id="leaveRulesAlert">
                                Please select leave type and date to see applicable rules
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <button type="submit" class="btn btn-success" id="submitLeaveBtn">Submit Application</button>
                            <button type="button" class="btn" onclick="showSection('home')">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- My Requests -->
            <div class="section" id="myRequestsSection">
                <div class="card">
                    <h3>My Requests</h3>
                    <div class="table-container">
                        <table id="myRequestsTable">
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Date</th>
                                    <th>Details</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Filled by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Pending Requests (for other users) -->
            <div class="section" id="pendingRequestsSection">
                <div class="card">
                    <h3>Pending Requests</h3>
                    <div class="table-container">
                        <table id="pendingRequestsTable">
                            <thead>
                                <tr>
                                    <th>From</th>
                                    <th>Type</th>
                                    <th>Date</th>
                                    <th>Details</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Filled by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Admin: Duty Roster Management -->
            <div class="section" id="adminDutyRosterSection">
                <div class="card">
                    <h3>Duty Roster Management</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="rosterStaff">Select Staff</label>
                            <select id="rosterStaff" class="form-control">
                                <option value="">All Staff</option>
                                <!-- Populated by JavaScript -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="rosterMonth">Month</label>
                            <input type="month" id="rosterMonth" class="form-control" value="">
                        </div>
                    </div>
                    
                    <div class="card" id="rosterCalendar">
                        <!-- Calendar will be generated here -->
                    </div>
                </div>
            </div>
            
            <!-- Admin: Leave Balance Management -->
            <div class="section" id="adminLeaveBalanceSection">
                <div class="card">
                    <h3>Leave Balance Management</h3>
                    <div class="table-container">
                        <table id="leaveBalanceTable">
                            <thead>
                                <tr>
                                    <th>Staff</th>
                                    <th>RC No</th>
                                    <th>SL Balance</th>
                                    <th>FRL Balance</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Filled by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Admin: Approve Requests -->
            <div class="section" id="adminApprovalsSection">
                <div class="card">
                    <h3>Approve Requests</h3>
                    <div class="table-container">
                        <table id="approvalRequestsTable">
                            <thead>
                                <tr>
                                    <th>Staff</th>
                                    <th>Type</th>
                                    <th>Date</th>
                                    <th>Details</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Filled by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let allUsers = [];
        let dutyRoster = {};
        let leaveBalances = {};
        let pendingRequests = [];
        let myRequests = [];

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(initApp, 100);
        });

        function initApp() {
            // Setup login form
            const loginForm = document.getElementById('loginForm');
            const loginContainer = document.getElementById('loginContainer');
            const dashboardContainer = document.getElementById('dashboardContainer');
            
            // Set minimum dates
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('changeDate').min = today;
            document.getElementById('leaveDate').min = today;
            
            // Set default month for roster
            const now = new Date();
            const currentMonth = now.toISOString().slice(0, 7);
            document.getElementById('rosterMonth').value = currentMonth;
            
            loginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                handleLogin();
            });
            
            // Check for existing session
            checkSession();
        }

        function checkSession() {
            const session = localStorage.getItem('dutyUserSession');
            if (session) {
                try {
                    const user = JSON.parse(session);
                    if (user.expiry > Date.now()) {
                        loginUser(user);
                        return;
                    }
                } catch (e) {
                    localStorage.removeItem('dutyUserSession');
                }
            }
        }

        function handleLogin() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const errorMsg = document.getElementById('errorMessage');
            
            if (!username || !password) {
                errorMsg.textContent = 'Please enter both username and password';
                errorMsg.style.display = 'block';
                return;
            }
            
            // Check users array
            if (!users || !Array.isArray(users)) {
                errorMsg.textContent = 'User database not loaded';
                errorMsg.style.display = 'block';
                return;
            }
            
            const user = users.find(u => u.username === username);
            
            if (!user) {
                errorMsg.textContent = 'Invalid username or password';
                errorMsg.style.display = 'block';
                return;
            }
            
            // Hash and check password
            const hashedPassword = sha256(password);
            
            if (hashedPassword === user.passwordHash) {
                // Create session
                const sessionData = {
                    username: user.username,
                    name: user.name,
                    rcNo: user.RCNo,
                    level: user.Level,
                    expiry: Date.now() + (8 * 60 * 60 * 1000)
                };
                
                localStorage.setItem('dutyUserSession', JSON.stringify(sessionData));
                loginUser(sessionData);
            } else {
                errorMsg.textContent = 'Invalid username or password';
                errorMsg.style.display = 'block';
            }
        }

        function loginUser(userData) {
            currentUser = userData;
            allUsers = users || [];
            
            // Update UI
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('dashboardContainer').style.display = 'block';
            
            document.getElementById('userName').textContent = userData.name;
            document.getElementById('userRC').textContent = userData.rcNo;
            document.getElementById('userLevel').textContent = userData.level;
            document.getElementById('welcomeName').textContent = userData.name;
            
            // Show/hide admin sections
            if (userData.level === 'Supervisor') {
                document.getElementById('adminDutyRosterBtn').style.display = 'block';
                document.getElementById('adminLeaveBalanceBtn').style.display = 'block';
                document.getElementById('adminApprovalsBtn').style.display = 'block';
            }
            
            // Initialize data
            loadUserData();
            setupNavigation();
            setupForms();
        }

        function loadUserData() {
            // Load from localStorage or Firebase
            loadDutyRoster();
            loadLeaveBalances();
            loadRequests();
            updateDashboard();
        }

        function loadDutyRoster() {
            // Try to load from localStorage
            const savedRoster = localStorage.getItem('dutyRoster');
            if (savedRoster) {
                dutyRoster = JSON.parse(savedRoster);
            } else {
                // Initialize with sample data
                dutyRoster = {};
                const today = new Date();
                for (let i = 0; i < 30; i++) {
                    const date = new Date(today);
                    date.setDate(today.getDate() + i);
                    const dateStr = date.toISOString().split('T')[0];
                    
                    dutyRoster[dateStr] = {};
                    allUsers.forEach(user => {
                        // Assign random duty times for demo
                        const times = ['08:00-16:00', '16:00-00:00', '00:00-08:00', 'Off'];
                        dutyRoster[dateStr][user.username] = times[Math.floor(Math.random() * times.length)];
                    });
                }
                saveDutyRoster();
            }
        }

        function saveDutyRoster() {
            localStorage.setItem('dutyRoster', JSON.stringify(dutyRoster));
            
            // Also save to Firebase if available
            if (typeof db !== 'undefined') {
                try {
                    db.collection('dutyRoster').doc('current').set(dutyRoster);
                } catch (error) {
                    console.log('Firebase save skipped');
                }
            }
        }

        function loadLeaveBalances() {
            const savedBalances = localStorage.getItem('leaveBalances');
            if (savedBalances) {
                leaveBalances = JSON.parse(savedBalances);
            } else {
                // Initialize with default balances
                leaveBalances = {};
                allUsers.forEach(user => {
                    leaveBalances[user.username] = {
                        SL: 48, // 6 days * 8 hours
                        FRL: 24  // 3 days * 8 hours
                    };
                });
                saveLeaveBalances();
            }
            
            // Update UI
            const userBalance = leaveBalances[currentUser.username] || {SL: 0, FRL: 0};
            document.getElementById('slBalance').textContent = userBalance.SL;
            document.getElementById('frlBalance').textContent = userBalance.FRL;
        }

        function saveLeaveBalances() {
            localStorage.setItem('leaveBalances', JSON.stringify(leaveBalances));
            
            if (typeof db !== 'undefined') {
                try {
                    db.collection('leaveBalances').doc('current').set(leaveBalances);
                } catch (error) {
                    console.log('Firebase save skipped');
                }
            }
        }

        function loadRequests() {
            const savedRequests = localStorage.getItem('dutyRequests');
            if (savedRequests) {
                const allRequests = JSON.parse(savedRequests);
                pendingRequests = [];
                myRequests = [];
                
                allRequests.forEach(request => {
                    if (request.status === 'pending') {
                        // Check if this request is for current user
                        if (request.type === 'dutyChange' && request.toUsername === currentUser.username) {
                            pendingRequests.push(request);
                        }
                    }
                    
                    // Check if this request is from current user
                    if (request.fromUsername === currentUser.username) {
                        myRequests.push(request);
                    }
                });
            }
            
            updatePendingCount();
            updateMyRequestsTable();
            updatePendingRequestsTable();
        }

        function saveRequest(request) {
            const savedRequests = localStorage.getItem('dutyRequests');
            let allRequests = savedRequests ? JSON.parse(savedRequests) : [];
            
            request.id = Date.now().toString();
            request.timestamp = new Date().toISOString();
            allRequests.push(request);
            
            localStorage.setItem('dutyRequests', JSON.stringify(allRequests));
            
            if (typeof db !== 'undefined') {
                try {
                    db.collection('requests').add(request);
                } catch (error) {
                    console.log('Firebase save skipped');
                }
            }
            
            loadRequests(); // Reload requests
        }

        function updateRequest(requestId, updates) {
            const savedRequests = localStorage.getItem('dutyRequests');
            if (!savedRequests) return;
            
            let allRequests = JSON.parse(savedRequests);
            allRequests = allRequests.map(req => {
                if (req.id === requestId) {
                    return {...req, ...updates};
                }
                return req;
            });
            
            localStorage.setItem('dutyRequests', JSON.stringify(allRequests));
            loadRequests();
        }

        function setupNavigation() {
            const navBtns = document.querySelectorAll('.nav-btn');
            navBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    // Remove active class from all buttons
                    navBtns.forEach(b => b.classList.remove('active'));
                    // Add active class to clicked button
                    this.classList.add('active');
                    // Show corresponding section
                    const sectionId = this.getAttribute('data-section');
                    showSection(sectionId);
                });
            });
            
            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', function() {
                localStorage.removeItem('dutyUserSession');
                location.reload();
            });
        }

        function showSection(sectionId) {
            // Hide all sections
            const sections = document.querySelectorAll('.section');
            sections.forEach(section => {
                section.classList.remove('active');
            });
            
            // Show selected section
            const section = document.getElementById(sectionId + 'Section');
            if (section) {
                section.classList.add('active');
                
                // Load section-specific data
                switch(sectionId) {
                    case 'dutyChange':
                        loadDutyChangeForm();
                        break;
                    case 'leaveApplication':
                        loadLeaveApplicationForm();
                        break;
                    case 'adminDutyRoster':
                        loadDutyRosterAdmin();
                        break;
                    case 'adminLeaveBalance':
                        loadLeaveBalanceAdmin();
                        break;
                    case 'adminApprovals':
                        loadApprovalRequests();
                        break;
                }
            }
        }

        function setupForms() {
            // Duty Change Form
            const dutyChangeForm = document.getElementById('dutyChangeForm');
            dutyChangeForm.addEventListener('submit', function(e) {
                e.preventDefault();
                submitDutyChange();
            });
            
            // Leave Application Form
            const leaveForm = document.getElementById('leaveApplicationForm');
            leaveForm.addEventListener('submit', function(e) {
                e.preventDefault();
                submitLeaveApplication();
            });
            
            // Date change handlers
            document.getElementById('changeDate').addEventListener('change', function() {
                loadDutyTimes('changeDutyTime', this.value, currentUser.username);
                document.getElementById('requestToDutyTime').innerHTML = '<option value="">Select staff first</option>';
            });
            
            document.getElementById('requestToStaff').addEventListener('change', function() {
                const selectedUser = allUsers.find(u => u.username === this.value);
                if (selectedUser) {
                    document.getElementById('requestToRcNo').value = selectedUser.RCNo;
                    const date = document.getElementById('changeDate').value;
                    if (date) {
                        loadDutyTimes('requestToDutyTime', date, selectedUser.username);
                    }
                }
            });
            
            document.getElementById('leaveDate').addEventListener('change', function() {
                loadDutyTimes('leaveDutyTime', this.value, currentUser.username);
            });
            
            document.getElementById('leaveType').addEventListener('change', updateLeaveRules);
            document.getElementById('leaveDate').addEventListener('change', updateLeaveRules);
            document.getElementById('leaveDutyTime').addEventListener('change', updateLeaveRules);
        }

        function loadDutyChangeForm() {
            // Populate staff dropdown (exclude current user)
            const staffSelect = document.getElementById('requestToStaff');
            staffSelect.innerHTML = '<option value="">Select staff member</option>';
            
            allUsers.forEach(user => {
                if (user.username !== currentUser.username && user.Level === 'User') {
                    const option = document.createElement('option');
                    option.value = user.username;
                    option.textContent = `${user.name} (RC: ${user.RCNo})`;
                    staffSelect.appendChild(option);
                }
            });
            
            // Set default date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('changeDate').value = tomorrow.toISOString().split('T')[0];
            
            // Load duty times
            loadDutyTimes('changeDutyTime', tomorrow.toISOString().split('T')[0], currentUser.username);
        }

        function loadLeaveApplicationForm() {
            // Set default date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('leaveDate').value = tomorrow.toISOString().split('T')[0];
            
            // Load duty times
            loadDutyTimes('leaveDutyTime', tomorrow.toISOString().split('T')[0], currentUser.username);
            
            updateLeaveRules();
        }

        function loadDutyTimes(selectId, date, username) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">Select duty time</option>';
            
            if (!date || !username) return;
            
            const dutyTime = dutyRoster[date] && dutyRoster[date][username];
            if (dutyTime && dutyTime !== 'Off') {
                const option = document.createElement('option');
                option.value = dutyTime;
                option.textContent = dutyTime;
                select.appendChild(option);
            } else {
                const option = document.createElement('option');
                option.value = 'Off';
                option.textContent = 'No duty scheduled';
                select.appendChild(option);
                select.disabled = true;
            }
        }

        function updateLeaveRules() {
            const leaveType = document.getElementById('leaveType').value;
            const leaveDate = document.getElementById('leaveDate').value;
            const dutyTime = document.getElementById('leaveDutyTime').value;
            const alertDiv = document.getElementById('leaveRulesAlert');
            const submitBtn = document.getElementById('submitLeaveBtn');
            
            if (!leaveType || !leaveDate || !dutyTime || dutyTime === 'Off') {
                alertDiv.className = 'alert alert-warning';
                alertDiv.textContent = 'Please select leave type, date and duty time';
                submitBtn.disabled = true;
                return;
            }
            
            const dutyStart = dutyTime.split('-')[0];
            const dutyDateTime = new Date(leaveDate + 'T' + dutyStart + ':00');
            const now = new Date();
            const hoursBeforeDuty = (dutyDateTime - now) / (1000 * 60 * 60);
            
            let canApply = false;
            let message = '';
            
            if (leaveType === 'Sick Leave') {
                canApply = hoursBeforeDuty >= 2;
                message = canApply 
                    ? '✓ You can apply for Sick Leave (2+ hours before duty)'
                    : `✗ Sick Leave must be applied at least 2 hours before duty (${Math.ceil(2 - hoursBeforeDuty)} more hours needed)`;
            } else if (leaveType === 'FRL') {
                canApply = hoursBeforeDuty >= 1;
                message = canApply
                    ? '✓ You can apply for FRL (1+ hour before duty)'
                    : `✗ FRL must be applied at least 1 hour before duty (${Math.ceil(1 - hoursBeforeDuty)} more hours needed)`;
            }
            
            alertDiv.className = canApply ? 'alert alert-success' : 'alert alert-danger';
            alertDiv.innerHTML = `<strong>${leaveType} Rules:</strong><br>${message}`;
            submitBtn.disabled = !canApply;
        }

        function submitDutyChange() {
            const date = document.getElementById('changeDate').value;
            const dutyTime = document.getElementById('changeDutyTime').value;
            const toStaff = document.getElementById('requestToStaff').value;
            const toRcNo = document.getElementById('requestToRcNo').value;
            const toDutyTime = document.getElementById('requestToDutyTime').value;
            const reason = document.getElementById('changeReason').value;
            
            if (!date || !dutyTime || !toStaff || !toDutyTime) {
                alert('Please fill all required fields');
                return;
            }
            
            const request = {
                type: 'dutyChange',
                fromUsername: currentUser.username,
                fromName: currentUser.name,
                fromRcNo: currentUser.rcNo,
                date: date,
                dutyTime: dutyTime,
                toUsername: toStaff,
                toRcNo: toRcNo,
                toDutyTime: toDutyTime,
                reason: reason,
                status: 'pending',
                timestamp: new Date().toISOString()
            };
            
            saveRequest(request);
            
            alert('Duty change request submitted successfully!');
            showSection('home');
            document.getElementById('dutyChangeForm').reset();
        }

        function submitLeaveApplication() {
            const leaveType = document.getElementById('leaveType').value;
            const date = document.getElementById('leaveDate').value;
            const dutyTime = document.getElementById('leaveDutyTime').value;
            const duration = document.getElementById('leaveDuration').value;
            const reason = document.getElementById('leaveReason').value;
            
            if (!leaveType || !date || !dutyTime || !reason) {
                alert('Please fill all required fields');
                return;
            }
            
            // Check balance
            const userBalance = leaveBalances[currentUser.username];
            if (!userBalance) {
                alert('Error: User balance not found');
                return;
            }
            
            if (leaveType === 'Sick Leave' && userBalance.SL < parseInt(duration)) {
                alert(`Insufficient Sick Leave balance. Available: ${userBalance.SL} hours, Requested: ${duration} hours`);
                return;
            }
            
            if (leaveType === 'FRL' && userBalance.FRL < parseInt(duration)) {
                alert(`Insufficient FRL balance. Available: ${userBalance.FRL} hours, Requested: ${duration} hours`);
                return;
            }
            
            const request = {
                type: 'leave',
                leaveType: leaveType,
                fromUsername: currentUser.username,
                fromName: currentUser.name,
                fromRcNo: currentUser.rcNo,
                date: date,
                dutyTime: dutyTime,
                duration: parseInt(duration),
                reason: reason,
                status: 'pending',
                timestamp: new Date().toISOString()
            };
            
            saveRequest(request);
            
            alert('Leave application submitted successfully!');
            showSection('home');
            document.getElementById('leaveApplicationForm').reset();
        }

        function updatePendingCount() {
            const count = pendingRequests.length;
            const btn = document.getElementById('pendingRequestsBtn');
            const countSpan = document.getElementById('pendingCount');
            
            if (count > 0) {
                btn.style.display = 'block';
                countSpan.textContent = count;
            } else {
                btn.style.display = 'none';
            }
        }

        function updateMyRequestsTable() {
            const tbody = document.querySelector('#myRequestsTable tbody');
            tbody.innerHTML = '';
            
            myRequests.forEach(request => {
                const tr = document.createElement('tr');
                
                let details = '';
                let statusClass = '';
                
                if (request.type === 'dutyChange') {
                    details = `Change with ${request.toName || request.toUsername} (${request.toDutyTime})`;
                } else if (request.type === 'leave') {
                    details = `${request.leaveType} - ${request.duration} hours`;
                }
                
                switch(request.status) {
                    case 'pending':
                        statusClass = 'status-pending';
                        break;
                    case 'approved':
                        statusClass = 'status-approved';
                        break;
                    case 'rejected':
                        statusClass = 'status-rejected';
                        break;
                }
                
                tr.innerHTML = `
                    <td>${request.type === 'dutyChange' ? 'Duty Change' : 'Leave'}</td>
                    <td>${request.date}</td>
                    <td>${details}</td>
                    <td class="${statusClass}">${request.status}</td>
                    <td>
                        ${request.status === 'pending' ? 
                            `<button class="action-btn view" onclick="cancelRequest('${request.id}')">Cancel</button>` : 
                            ''}
                    </td>
                `;
                
                tbody.appendChild(tr);
            });
        }

        function updatePendingRequestsTable() {
            const tbody = document.querySelector('#pendingRequestsTable tbody');
            tbody.innerHTML = '';
            
            pendingRequests.forEach(request => {
                const tr = document.createElement('tr');
                
                let details = '';
                if (request.type === 'dutyChange') {
                    details = `Swap ${request.dutyTime} with ${request.toDutyTime}`;
                }
                
                tr.innerHTML = `
                    <td>${request.fromName}</td>
                    <td>Duty Change</td>
                    <td>${request.date}</td>
                    <td>${details}<br><small>${request.reason || 'No reason provided'}</small></td>
                    <td class="action-buttons">
                        <button class="action-btn approve" onclick="respondToRequest('${request.id}', 'approved')">Accept</button>
                        <button class="action-btn reject" onclick="respondToRequest('${request.id}', 'rejected')">Reject</button>
                    </td>
                `;
                
                tbody.appendChild(tr);
            });
        }

        function respondToRequest(requestId, response) {
            const request = pendingRequests.find(r => r.id === requestId);
            if (!request) return;
            
            if (response === 'approved') {
                // Update duty roster
                const date = request.date;
                if (dutyRoster[date]) {
                    // Swap duty times
                    const temp = dutyRoster[date][request.fromUsername];
                    dutyRoster[date][request.fromUsername] = dutyRoster[date][request.toUsername];
                    dutyRoster[date][request.toUsername] = temp;
                    saveDutyRoster();
                }
            }
            
            updateRequest(requestId, {status: response, respondedAt: new Date().toISOString()});
            
            alert(`Request ${response} successfully`);
            showSection('home');
        }

        function cancelRequest(requestId) {
            if (confirm('Are you sure you want to cancel this request?')) {
                updateRequest(requestId, {status: 'cancelled'});
            }
        }

        function loadDutyRosterAdmin() {
            // Populate staff dropdown
            const staffSelect = document.getElementById('rosterStaff');
            staffSelect.innerHTML = '<option value="">All Staff</option>';
            
            allUsers.forEach(user => {
                const option = document.createElement('option');
                option.value = user.username;
                option.textContent = `${user.name} (${user.RCNo})`;
                staffSelect.appendChild(option);
            });
            
            staffSelect.addEventListener('change', updateRosterCalendar);
            document.getElementById('rosterMonth').addEventListener('change', updateRosterCalendar);
            
            updateRosterCalendar();
        }

        function updateRosterCalendar() {
            const selectedStaff = document.getElementById('rosterStaff').value;
            const selectedMonth = document.getElementById('rosterMonth').value;
            const calendarDiv = document.getElementById('rosterCalendar');
            
            // Create calendar
            const year = parseInt(selectedMonth.split('-')[0]);
            const month = parseInt(selectedMonth.split('-')[1]) - 1;
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            let calendarHTML = `
                <h4>${firstDay.toLocaleDateString('en-US', {month: 'long', year: 'numeric'})}</h4>
                <div class="calendar">
                    <div class="calendar-header">Sun</div>
                    <div class="calendar-header">Mon</div>
                    <div class="calendar-header">Tue</div>
                    <div class="calendar-header">Wed</div>
                    <div class="calendar-header">Thu</div>
                    <div class="calendar-header">Fri</div>
                    <div class="calendar-header">Sat</div>
            `;
            
            // Empty cells for days before first day of month
            for (let i = 0; i < firstDay.getDay(); i++) {
                calendarHTML += '<div class="calendar-day"></div>';
            }
            
            // Days of month
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(year, month, day);
                const dateStr = date.toISOString().split('T')[0];
                
                let dutyInfo = '';
                let dayClass = 'calendar-day';
                
                if (selectedStaff) {
                    const duty = dutyRoster[dateStr] && dutyRoster[dateStr][selectedStaff];
                    if (duty) {
                        dayClass += ' ' + (duty === 'Off' ? 'off' : 'duty');
                        dutyInfo = `<br><small>${duty}</small>`;
                    }
                } else {
                    // Show all staff duties
                    let staffCount = 0;
                    if (dutyRoster[dateStr]) {
                        for (const user in dutyRoster[dateStr]) {
                            if (dutyRoster[dateStr][user] !== 'Off') {
                                staffCount++;
                            }
                        }
                        if (staffCount > 0) {
                            dayClass += ' duty';
                            dutyInfo = `<br><small>${staffCount} on duty</small>`;
                        }
                    }
                }
                
                calendarHTML += `
                    <div class="${dayClass}" onclick="editDuty('${dateStr}', '${selectedStaff}')">
                        ${day}${dutyInfo}
                    </div>
                `;
            }
            
            calendarHTML += '</div>';
            calendarDiv.innerHTML = calendarHTML;
        }

        function editDuty(dateStr, staff) {
            if (!staff) {
                alert('Please select a staff member first');
                return;
            }
            
            const currentDuty = dutyRoster[dateStr] && dutyRoster[dateStr][staff];
            const newDuty = prompt(`Enter duty time for ${dateStr} (e.g., "08:00-16:00" or "Off"):`, currentDuty || '08:00-16:00');
            
            if (newDuty !== null) {
                if (!dutyRoster[dateStr]) dutyRoster[dateStr] = {};
                dutyRoster[dateStr][staff] = newDuty;
                saveDutyRoster();
                updateRosterCalendar();
            }
        }

        function loadLeaveBalanceAdmin() {
            const tbody = document.querySelector('#leaveBalanceTable tbody');
            tbody.innerHTML = '';
            
            allUsers.forEach(user => {
                const balance = leaveBalances[user.username] || {SL: 0, FRL: 0};
                const tr = document.createElement('tr');
                
                tr.innerHTML = `
                    <td>${user.name}</td>
                    <td>${user.RCNo}</td>
                    <td><input type="number" value="${balance.SL}" onchange="updateLeaveBalance('${user.username}', 'SL', this.value)" style="width: 60px;"> hours</td>
                    <td><input type="number" value="${balance.FRL}" onchange="updateLeaveBalance('${user.username}', 'FRL', this.value)" style="width: 60px;"> hours</td>
                    <td>
                        <button class="action-btn view" onclick="resetLeaveBalance('${user.username}')">Reset</button>
                    </td>
                `;
                
                tbody.appendChild(tr);
            });
        }

        function updateLeaveBalance(username, type, value) {
            if (!leaveBalances[username]) leaveBalances[username] = {SL: 0, FRL: 0};
            leaveBalances[username][type] = parseInt(value) || 0;
            saveLeaveBalances();
        }

        function resetLeaveBalance(username) {
            if (confirm(`Reset leave balance for ${username}?`)) {
                leaveBalances[username] = {SL: 48, FRL: 24};
                saveLeaveBalances();
                loadLeaveBalanceAdmin();
            }
        }

        function loadApprovalRequests() {
            const savedRequests = localStorage.getItem('dutyRequests');
            if (!savedRequests) return;
            
            const allRequests = JSON.parse(savedRequests);
            const pendingAdminRequests = allRequests.filter(req => req.status === 'pending');
            
            const tbody = document.querySelector('#approvalRequestsTable tbody');
            tbody.innerHTML = '';
            
            pendingAdminRequests.forEach(request => {
                const tr = document.createElement('tr');
                
                let details = '';
                if (request.type === 'dutyChange') {
                    details = `${request.fromName} ↔ ${request.toName}<br>${request.dutyTime} ↔ ${request.toDutyTime}`;
                } else if (request.type === 'leave') {
                    details = `${request.leaveType} - ${request.duration} hours<br>${request.reason}`;
                }
                
                tr.innerHTML = `
                    <td>${request.fromName}</td>
                    <td>${request.type === 'dutyChange' ? 'Duty Change' : 'Leave'}</td>
                    <td>${request.date}</td>
                    <td>${details}</td>
                    <td class="status-pending">Pending</td>
                    <td class="action-buttons">
                        <button class="action-btn approve" onclick="adminApproveRequest('${request.id}')">Approve</button>
                        <button class="action-btn reject" onclick="adminRejectRequest('${request.id}')">Reject</button>
                    </td>
                `;
                
                tbody.appendChild(tr);
            });
        }

        function adminApproveRequest(requestId) {
            const savedRequests = localStorage.getItem('dutyRequests');
            if (!savedRequests) return;
            
            let allRequests = JSON.parse(savedRequests);
            const request = allRequests.find(req => req.id === requestId);
            
            if (!request) return;
            
            if (request.type === 'leave') {
                // Deduct from leave balance
                const userBalance = leaveBalances[request.fromUsername];
                if (userBalance) {
                    if (request.leaveType === 'Sick Leave') {
                        userBalance.SL -= request.duration;
                    } else if (request.leaveType === 'FRL') {
                        userBalance.FRL -= request.duration;
                    }
                    saveLeaveBalances();
                }
            }
            
            allRequests = allRequests.map(req => {
                if (req.id === requestId) {
                    return {...req, status: 'approved', approvedAt: new Date().toISOString()};
                }
                return req;
            });
            
            localStorage.setItem('dutyRequests', JSON.stringify(allRequests));
            
            alert('Request approved successfully');
            loadApprovalRequests();
        }

        function adminRejectRequest(requestId) {
            if (confirm('Are you sure you want to reject this request?')) {
                updateRequest(requestId, {status: 'rejected', rejectedAt: new Date().toISOString()});
                loadApprovalRequests();
            }
        }

        function updateDashboard() {
            // Update today's duty
            const today = new Date().toISOString().split('T')[0];
            if (dutyRoster[today] && dutyRoster[today][currentUser.username]) {
                document.getElementById('todayDutyTime').textContent = dutyRoster[today][currentUser.username];
            }
            
            // Find next duty
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowStr = tomorrow.toISOString().split('T')[0];
            
            if (dutyRoster[tomorrowStr] && dutyRoster[tomorrowStr][currentUser.username]) {
                const duty = dutyRoster[tomorrowStr][currentUser.username];
                if (duty !== 'Off') {
                    document.getElementById('nextDutyTime').textContent = `${tomorrowStr}: ${duty}`;
                }
            }
        }
    </script>
</body>
</html>
