<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Duty Management System</title>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    
    <!-- SHA-256 Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js"></script>
    
    <style>
        /* ===== CSS Reset & Base Styles ===== */
        :root {
            --primary-color: #3498db;
            --primary-dark: #2980b9;
            --secondary-color: #2c3e50;
            --secondary-light: #34495e;
            --success-color: #27ae60;
            --success-dark: #219653;
            --danger-color: #e74c3c;
            --danger-dark: #c0392b;
            --warning-color: #f39c12;
            --warning-dark: #d68910;
            --info-color: #17a2b8;
            --light-color: #f5f7fa;
            --dark-color: #1a1a1a;
            --gray-light: #e0e6ed;
            --gray: #7f8c8d;
            --white: #ffffff;
            --shadow: 0 2px 15px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 5px 20px rgba(0, 0, 0, 0.1);
            --radius: 12px;
            --radius-sm: 8px;
            --transition: all 0.3s ease;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: var(--light-color);
            color: var(--secondary-color);
            min-height: 100vh;
            min-height: -webkit-fill-available;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
            line-height: 1.5;
        }

        /* ===== Login Page ===== */
        .login-container {
            background: var(--white);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 30px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-content {
            background: var(--white);
            border-radius: var(--radius);
            padding: 30px 25px;
            box-shadow: var(--shadow-lg);
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .logo {
            text-align: center;
            margin-bottom: 40px;
        }

        .logo h1 {
            color: var(--secondary-color);
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo p {
            color: var(--gray);
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            color: var(--secondary-color);
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .form-control {
            width: 100%;
            padding: 16px 18px;
            border: 2px solid var(--gray-light);
            border-radius: var(--radius-sm);
            font-size: 16px;
            transition: var(--transition);
            background: var(--white);
            color: var(--secondary-color);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        /* ===== Buttons ===== */
        .btn {
            padding: 16px 24px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
            min-height: 52px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            user-select: none;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: var(--white);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-color));
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color), var(--success-dark));
            color: var(--white);
        }

        .btn-success:hover {
            background: linear-gradient(135deg, var(--success-dark), var(--success-color));
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color), var(--danger-dark));
            color: var(--white);
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, var(--danger-dark), var(--danger-color));
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color), var(--warning-dark));
            color: var(--white);
        }

        .btn-warning:hover {
            background: linear-gradient(135deg, var(--warning-dark), var(--warning-color));
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--gray), #5d6d7e);
            color: var(--white);
        }

        .btn-block {
            width: 100%;
        }

        .btn-small {
            padding: 10px 16px;
            font-size: 14px;
            min-height: 40px;
        }

        .btn-icon {
            padding: 12px;
            min-width: 44px;
            min-height: 44px;
            border-radius: 50%;
        }

        .error-message {
            background: #ffeaea;
            color: var(--danger-color);
            padding: 15px;
            border-radius: var(--radius-sm);
            margin-top: 20px;
            display: none;
            font-size: 14px;
            border-left: 4px solid var(--danger-color);
        }

        /* ===== Dashboard ===== */
        .dashboard-container {
            display: none;
            min-height: 100vh;
            background: var(--light-color);
        }

        /* Mobile Header */
        .mobile-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, var(--secondary-color), var(--secondary-light));
            color: var(--white);
            padding: 15px 20px;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            height: 70px;
        }

        .mobile-header .user-info h2 {
            font-size: 16px;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
            font-weight: 600;
        }

        .mobile-header .user-details {
            font-size: 12px;
            opacity: 0.9;
            display: flex;
            gap: 10px;
        }

        .menu-toggle {
            background: none;
            border: none;
            color: var(--white);
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            margin: -8px;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Mobile Navigation */
        .mobile-nav {
            position: fixed;
            top: 70px;
            left: -280px;
            width: 280px;
            height: calc(100vh - 70px);
            background: var(--white);
            z-index: 999;
            transition: var(--transition);
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            overflow-y: auto;
            padding-bottom: 100px;
        }

        .mobile-nav.active {
            left: 0;
        }

        .nav-section {
            padding: 20px;
            border-bottom: 1px solid var(--gray-light);
        }

        .nav-section h3 {
            color: var(--secondary-color);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
            opacity: 0.7;
            font-weight: 600;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px;
            color: var(--secondary-color);
            text-decoration: none;
            border-radius: var(--radius-sm);
            margin-bottom: 6px;
            transition: var(--transition);
            font-weight: 500;
        }

        .nav-item:active {
            background: rgba(52, 152, 219, 0.1);
        }

        .nav-item.active {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: var(--white);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.2);
        }

        .nav-icon {
            width: 24px;
            text-align: center;
            font-size: 18px;
        }

        .notification-badge {
            background: var(--danger-color);
            color: var(--white);
            border-radius: 10px;
            padding: 3px 9px;
            font-size: 11px;
            font-weight: 600;
            margin-left: auto;
            min-width: 20px;
            text-align: center;
        }

        .notification-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: var(--danger-color);
            border-radius: 50%;
            margin-left: auto;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }

        /* Navigation Overlay */
        .nav-overlay {
            position: fixed;
            top: 70px;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 998;
            display: none;
            backdrop-filter: blur(2px);
        }

        .nav-overlay.active {
            display: block;
        }

        /* Content Area */
        .content-area {
            padding: 90px 15px 90px;
            min-height: 100vh;
        }

        .section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section.active {
            display: block;
        }

        /* Cards */
        .card {
            background: var(--white);
            border-radius: var(--radius);
            padding: 25px 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--gray-light);
            transition: var(--transition);
        }

        .card:hover {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.12);
        }

        .card h3 {
            color: var(--secondary-color);
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: 700;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card h3::before {
            content: "";
            width: 4px;
            height: 20px;
            background: var(--primary-color);
            border-radius: 2px;
        }

        /* ===== Banner & Event System ===== */
        .banner-container {
            margin-bottom: 20px;
            overflow: hidden;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .banner-slide {
            position: relative;
            min-height: 160px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-light));
            border-radius: var(--radius);
            overflow: hidden;
            color: var(--white);
            padding: 25px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            transition: var(--transition);
        }

        .banner-slide:hover {
            transform: translateY(-2px);
        }

        .banner-priority-high {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .banner-priority-medium {
            background: linear-gradient(135deg, #f39c12, #d68910);
        }

        .banner-priority-low {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-light));
        }

        .banner-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0,0,0,0.3);
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: 600;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .banner-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .banner-content {
            font-size: 14px;
            opacity: 0.95;
            margin-bottom: 15px;
            line-height: 1.4;
        }

        .banner-meta {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            opacity: 0.8;
        }

        .banner-actions {
            position: absolute;
            bottom: 15px;
            right: 15px;
            display: flex;
            gap: 8px;
        }

        .banner-action-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: var(--white);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            cursor: pointer;
            backdrop-filter: blur(10px);
            transition: var(--transition);
        }

        .banner-action-btn:active {
            background: rgba(255,255,255,0.3);
            transform: scale(0.95);
        }

        .banner-image {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: var(--radius) var(--radius) 0 0;
        }

        .banner-carousel {
            position: relative;
            overflow: hidden;
        }

        .carousel-dots {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 15px;
            padding: 0 10px;
        }

        .carousel-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(0,0,0,0.2);
            transition: var(--transition);
            cursor: pointer;
            border: none;
        }

        .carousel-dot.active {
            background: var(--primary-color);
            transform: scale(1.3);
        }

        .carousel-controls {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            transform: translateY(-50%);
            display: flex;
            justify-content: space-between;
            padding: 0 15px;
            pointer-events: none;
        }

        .carousel-btn {
            pointer-events: auto;
            background: rgba(0,0,0,0.5);
            border: none;
            color: var(--white);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            backdrop-filter: blur(10px);
            transition: var(--transition);
        }

        .carousel-btn:active {
            background: rgba(0,0,0,0.7);
        }

        /* Events Calendar */
        .event-calendar {
            background: var(--white);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .event-day {
            display: flex;
            align-items: flex-start;
            padding: 15px 0;
            border-bottom: 1px solid var(--gray-light);
            cursor: pointer;
            transition: var(--transition);
        }

        .event-day:active {
            background: rgba(52, 152, 219, 0.05);
            border-radius: var(--radius-sm);
            padding: 15px;
        }

        .event-day:last-child {
            border-bottom: none;
        }

        .event-date {
            min-width: 70px;
            text-align: center;
        }

        .event-date-day {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary-color);
            line-height: 1;
        }

        .event-date-month {
            font-size: 12px;
            color: var(--gray);
            text-transform: uppercase;
            font-weight: 600;
            margin-top: 4px;
        }

        .event-details {
            flex: 1;
            padding-left: 20px;
        }

        .event-title {
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--secondary-color);
            font-size: 16px;
        }

        .event-description {
            font-size: 14px;
            color: var(--gray);
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .event-time {
            font-size: 13px;
            color: var(--primary-color);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .event-time::before {
            content: "üïê";
            font-size: 12px;
        }

        /* Announcements List */
        .announcement-list {
            background: var(--white);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .announcement-item {
            display: flex;
            padding: 18px 0;
            border-bottom: 1px solid var(--gray-light);
            cursor: pointer;
            transition: var(--transition);
        }

        .announcement-item:active {
            background: rgba(52, 152, 219, 0.05);
            border-radius: var(--radius-sm);
            padding: 18px 15px;
        }

        .announcement-item:last-child {
            border-bottom: none;
        }

        .announcement-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: var(--white);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            margin-right: 15px;
            flex-shrink: 0;
            box-shadow: 0 4px 10px rgba(52, 152, 219, 0.2);
        }

        .announcement-content {
            flex: 1;
            min-width: 0;
        }

        .announcement-title {
            font-weight: 700;
            margin-bottom: 6px;
            color: var(--secondary-color);
            font-size: 16px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }

        .announcement-text {
            font-size: 14px;
            color: var(--gray);
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .announcement-meta {
            font-size: 12px;
            color: #999;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .announcement-priority {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .priority-high {
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .priority-medium {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .priority-low {
            background: linear-gradient(135deg, #d1ecf1, #bee5eb);
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* New Badge */
        .new-badge {
            background: var(--danger-color);
            color: var(--white);
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 700;
            margin-left: 8px;
            animation: pulse 2s infinite;
        }

        /* Read Status */
        .read-status {
            display: inline-block;
            width: 10px;
            height: 10px;
            background: var(--success-color);
            border-radius: 50%;
            margin-left: 8px;
        }

        .read-status.unread {
            background: var(--danger-color);
            animation: pulse 1.5s infinite;
        }

        /* Quick Stats */
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin: 20px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: var(--radius-sm);
            padding: 20px 15px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border: 1px solid var(--gray-light);
            transition: var(--transition);
        }

        .stat-card:active {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 28px;
            font-weight: 800;
            color: var(--primary-color);
            margin-bottom: 5px;
            line-height: 1;
        }

        .stat-label {
            font-size: 12px;
            color: var(--gray);
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 20px;
        }

        .quick-action-btn {
            padding: 20px 15px;
            background: var(--white);
            border: 2px solid var(--gray-light);
            border-radius: var(--radius-sm);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            text-align: center;
            text-decoration: none;
            color: var(--secondary-color);
            transition: var(--transition);
            cursor: pointer;
        }

        .quick-action-btn:active {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-color: var(--primary-color);
            transform: scale(0.98);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.15);
        }

        .quick-action-icon {
            font-size: 28px;
            color: var(--primary-color);
        }

        .quick-action-text {
            font-size: 14px;
            font-weight: 600;
        }

        /* Alerts */
        .alert {
            padding: 18px 20px;
            border-radius: var(--radius-sm);
            margin-bottom: 20px;
            border-left: 4px solid;
            font-size: 14px;
            background: var(--white);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .alert-info {
            background: #e8f4fc;
            border-color: var(--primary-color);
            color: var(--secondary-color);
        }

        .alert-success {
            background: #d4edda;
            border-color: var(--success-color);
            color: #155724;
        }

        .alert-warning {
            background: #fff3cd;
            border-color: var(--warning-color);
            color: #856404;
        }

        .alert-danger {
            background: #f8d7da;
            border-color: var(--danger-color);
            color: #721c24;
        }

        /* Forms */
        .form-row {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        textarea.form-control {
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
            line-height: 1.5;
            padding: 15px;
        }

        select.form-control {
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 16px;
            padding-right: 45px;
            appearance: none;
            -webkit-appearance: none;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            margin-top: 15px;
            border: 1px solid var(--gray-light);
            border-radius: var(--radius-sm);
            -webkit-overflow-scrolling: touch;
            background: var(--white);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--white);
            min-width: 600px;
        }

        th, td {
            padding: 14px;
            text-align: left;
            border-bottom: 1px solid var(--gray-light);
            font-size: 14px;
        }

        th {
            background: #f8f9fa;
            font-weight: 700;
            color: var(--secondary-color);
            white-space: nowrap;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover {
            background: #f8f9fa;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .action-btn {
            padding: 10px 16px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 13px;
            cursor: pointer;
            transition: var(--transition);
            flex: 1;
            min-width: 70px;
            font-weight: 600;
            text-align: center;
        }

        .action-btn:active {
            transform: scale(0.95);
        }

        .action-btn.approve {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .action-btn.reject {
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .action-btn.view {
            background: linear-gradient(135deg, #d1ecf1, #bee5eb);
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .action-btn.apply {
            background: linear-gradient(135deg, #cce5ff, #b8daff);
            color: #004085;
            border: 1px solid #b8daff;
        }

        /* Status Badges */
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            display: inline-block;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-pending {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status-approved {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-rejected {
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* ===== Admin Broadcast System ===== */
        .broadcast-tabs {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            margin-bottom: 20px;
            padding-bottom: 15px;
            scrollbar-width: none;
        }

        .broadcast-tabs::-webkit-scrollbar {
            display: none;
        }

        .broadcast-tab {
            padding: 12px 20px;
            background: #f0f0f0;
            border-radius: 25px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            flex-shrink: 0;
            transition: var(--transition);
            color: var(--gray);
        }

        .broadcast-tab:active {
            transform: scale(0.95);
        }

        .broadcast-tab.active {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: var(--white);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.2);
        }

        .broadcast-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .broadcast-content.active {
            display: block;
        }

        /* Event Form Container */
        .event-form-container {
            background: var(--white);
            border-radius: var(--radius);
            padding: 25px 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .form-section {
            margin-bottom: 30px;
        }

        .form-section-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--secondary-color);
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-section-title::before {
            content: "üìù";
            font-size: 18px;
        }

        /* Target Audience */
        .target-audience {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 15px;
        }

        @media (min-width: 480px) {
            .target-audience {
                flex-direction: row;
                flex-wrap: wrap;
            }
        }

        .target-option {
            flex: 1;
            min-width: 100%;
        }

        @media (min-width: 480px) {
            .target-option {
                min-width: 150px;
            }
        }

        .target-option input {
            display: none;
        }

        .target-option label {
            display: block;
            padding: 18px 15px;
            background: #f8f9fa;
            border: 2px solid var(--gray-light);
            border-radius: var(--radius-sm);
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            font-size: 14px;
        }

        .target-option label:active {
            transform: scale(0.98);
        }

        .target-option input:checked + label {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: var(--white);
            border-color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.2);
        }

        /* User Selection */
        .user-selection {
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid var(--gray-light);
            border-radius: var(--radius-sm);
            padding: 15px;
            margin-top: 15px;
            display: none;
            background: var(--white);
        }

        .user-selection.active {
            display: block;
        }

        .user-checkbox {
            display: flex;
            align-items: center;
            padding: 12px 10px;
            border-radius: var(--radius-sm);
            margin-bottom: 8px;
            transition: var(--transition);
        }

        .user-checkbox:active {
            background: rgba(52, 152, 219, 0.1);
        }

        .user-checkbox input {
            margin-right: 12px;
            width: 18px;
            height: 18px;
            accent-color: var(--primary-color);
        }

        /* Image Upload */
        .upload-area {
            border: 2px dashed var(--primary-color);
            border-radius: var(--radius-sm);
            padding: 40px 20px;
            text-align: center;
            background: #f8f9fa;
            cursor: pointer;
            transition: var(--transition);
            margin-top: 15px;
        }

        .upload-area:active {
            background: #e8f4fc;
            transform: scale(0.99);
        }

        .upload-area input {
            display: none;
        }

        .upload-icon {
            font-size: 48px;
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .image-preview {
            width: 100%;
            max-height: 200px;
            object-fit: cover;
            border-radius: var(--radius-sm);
            margin-top: 15px;
            display: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .image-preview.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        /* Broadcast Cards */
        .current-events {
            background: var(--white);
            border-radius: var(--radius);
            padding: 25px 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .event-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: var(--radius-sm);
            padding: 20px;
            margin-bottom: 20px;
            border-left: 5px solid var(--primary-color);
            transition: var(--transition);
        }

        .event-card:active {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .event-card.priority-high {
            border-left-color: var(--danger-color);
        }

        .event-card.priority-medium {
            border-left-color: var(--warning-color);
        }

        .event-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .event-card-title {
            font-weight: 700;
            color: var(--secondary-color);
            font-size: 16px;
            flex: 1;
            margin-right: 15px;
        }

        .event-card-actions {
            display: flex;
            gap: 8px;
        }

        .event-card-action {
            background: none;
            border: none;
            color: var(--gray);
            font-size: 18px;
            cursor: pointer;
            padding: 8px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: var(--transition);
        }

        .event-card-action:active {
            background: rgba(0,0,0,0.1);
            transform: scale(0.9);
        }

        .event-card-content {
            font-size: 14px;
            color: var(--gray);
            margin-bottom: 15px;
            line-height: 1.4;
        }

        .event-card-meta {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #999;
            flex-wrap: wrap;
            gap: 10px;
        }

        .event-stats {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--gray-light);
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--gray);
        }

        .stat-icon {
            font-size: 16px;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            display: flex;
            justify-content: space-around;
            padding: 12px 5px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 100;
            border-top: 1px solid var(--gray-light);
        }

        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 10px 5px;
            border: none;
            background: none;
            color: var(--gray);
            font-size: 10px;
            cursor: pointer;
            flex: 1;
            min-width: 60px;
            border-radius: var(--radius-sm);
            transition: var(--transition);
        }

        .bottom-nav-item:active {
            background: rgba(52, 152, 219, 0.1);
            transform: scale(0.95);
        }

        .bottom-nav-item.active {
            color: var(--primary-color);
        }

        .bottom-nav-icon {
            font-size: 22px;
        }

        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: var(--white);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            box-shadow: 0 4px 20px rgba(52, 152, 219, 0.3);
            cursor: pointer;
            z-index: 99;
            transition: var(--transition);
            border: none;
        }

        .fab:active {
            transform: scale(0.9);
            box-shadow: 0 2px 15px rgba(52, 152, 219, 0.3);
        }

        /* Modals */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: var(--white);
            border-radius: 20px;
            padding: 30px 25px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            animation: slideUp 0.3s ease;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-title {
            font-size: 20px;
            color: var(--secondary-color);
            font-weight: 700;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            color: var(--gray);
            cursor: pointer;
            padding: 5px;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: var(--transition);
        }

        .modal-close:active {
            background: rgba(0,0,0,0.1);
        }

        /* Offline Indicator */
        .offline-indicator {
            position: fixed;
            top: 70px;
            left: 0;
            right: 0;
            background: var(--warning-color);
            color: var(--white);
            text-align: center;
            padding: 12px;
            font-size: 14px;
            font-weight: 600;
            z-index: 1001;
            display: none;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
            }
            to {
                transform: translateY(0);
            }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--gray);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.2;
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--secondary-color);
            color: var(--white);
            padding: 16px 24px;
            border-radius: var(--radius-sm);
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 2001;
            animation: slideUp 0.3s ease, slideUp 0.3s ease 2.7s reverse forwards;
            font-weight: 600;
            text-align: center;
            max-width: 90%;
            backdrop-filter: blur(10px);
            background: rgba(44, 62, 80, 0.9);
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: var(--gray);
        }

        .spinner {
            border: 3px solid rgba(52, 152, 219, 0.1);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (min-width: 768px) {
            .login-container {
                padding: 40px;
                justify-content: center;
                align-items: center;
            }
            
            .login-content {
                max-width: 400px;
                width: 100%;
            }
            
            .mobile-header, .mobile-nav, .bottom-nav, .fab {
                display: none;
            }
            
            .dashboard-container {
                max-width: 1200px;
                margin: 20px auto;
                border-radius: 20px;
                box-shadow: var(--shadow-lg);
                min-height: calc(100vh - 40px);
                overflow: hidden;
            }
            
            .content-area {
                padding: 30px;
            }
            
            .form-row {
                flex-direction: row;
                flex-wrap: wrap;
            }
            
            .form-row > * {
                flex: 1;
                min-width: 200px;
            }
            
            .quick-stats {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .quick-actions {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .target-audience {
                flex-direction: row;
            }
            
            .target-option {
                min-width: 150px;
            }
            
            .table-container {
                min-width: auto;
            }
            
            table {
                min-width: auto;
            }
        }

        /* Dark Mode */
        @media (prefers-color-scheme: dark) {
            :root {
                --light-color: #1a1a1a;
                --white: #2c3e50;
                --gray-light: #34495e;
                --secondary-color: #ecf0f1;
                --gray: #bdc3c7;
            }
            
            body {
                background: var(--light-color);
                color: var(--secondary-color);
            }
            
            .card, .form-control, table, .announcement-list, .event-calendar, .current-events {
                background: var(--white);
                color: var(--secondary-color);
                border-color: var(--gray-light);
            }
            
            .form-control {
                background: var(--white);
                color: var(--secondary-color);
                border-color: var(--gray-light);
            }
            
            th {
                background: #34495e;
                color: var(--secondary-color);
            }
            
            tr:hover {
                background: #34495e;
            }
            
            .stat-card {
                background: #34495e;
                border-color: #4a6572;
            }
            
            .quick-action-btn {
                background: var(--white);
                border-color: var(--gray-light);
                color: var(--secondary-color);
            }
            
            .alert {
                background: #34495e;
                color: var(--secondary-color);
            }
            
            .upload-area {
                background: #34495e;
                border-color: var(--primary-color);
            }
            
            .event-card {
                background: #34495e;
            }
        }
    </style>
</head>
<body>
    <!-- Login Container -->
    <div class="login-container" id="loginContainer">
        <div class="login-content">
            <div class="logo">
                <h1>Duty Management</h1>
                <p>Secure Mobile Login</p>
            </div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" class="form-control" placeholder="Enter username" required autofocus>
                </div>
                
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" class="form-control" placeholder="Enter password" required>
                </div>
                
                <button type="submit" class="btn btn-primary btn-block" id="loginBtn">
                    <span>Login</span>
                    <span>‚Üí</span>
                </button>
                
                <div class="error-message" id="errorMessage">
                    Invalid username or password
                </div>
            </form>
            
            <div class="alert alert-info" style="margin-top: 30px; font-size: 13px;">
                <strong>üì± Mobile App:</strong> Add to home screen for best experience
            </div>
        </div>
    </div>
    
    <!-- Dashboard Container -->
    <div class="dashboard-container" id="dashboardContainer">
        <!-- Mobile Header -->
        <div class="mobile-header">
            <button class="menu-toggle" id="menuToggle">‚ò∞</button>
            <div class="user-info">
                <h2 id="userName">User Name</h2>
                <div class="user-details">
                    <span>RC: <span id="userRC">000</span></span>
                    <span>üëë <span id="userLevel">User</span></span>
                </div>
            </div>
            <button class="btn btn-icon btn-danger" id="logoutBtn">üö™</button>
        </div>
        
        <!-- Mobile Navigation -->
        <div class="mobile-nav" id="mobileNav">
            <div class="nav-section">
                <h3>Main Menu</h3>
                <a href="#" class="nav-item active" data-section="home">
                    <span class="nav-icon">üè†</span>
                    <span>Dashboard</span>
                </a>
                <a href="#" class="nav-item" data-section="dutyChange">
                    <span class="nav-icon">üîÑ</span>
                    <span>Duty Change</span>
                </a>
                <a href="#" class="nav-item" data-section="leaveApplication">
                    <span class="nav-icon">üìù</span>
                    <span>Apply Leave</span>
                </a>
                <a href="#" class="nav-item" data-section="myRequests">
                    <span class="nav-icon">üìã</span>
                    <span>My Requests</span>
                    <span id="requestCount" class="notification-badge" style="display:none">0</span>
                </a>
                <a href="#" class="nav-item" data-section="viewMyRoster">
                    <span class="nav-icon">üìÖ</span>
                    <span>My Roster</span>
                </a>
                <a href="#" class="nav-item" data-section="announcements">
                    <span class="nav-icon">üì¢</span>
                    <span>Announcements</span>
                    <span id="unreadAnnouncements" class="notification-badge" style="display:none">0</span>
                </a>
                <a href="#" class="nav-item" data-section="pendingRequests" id="pendingRequestsNav" style="display:none;">
                    <span class="nav-icon">‚è∞</span>
                    <span>Pending</span>
                    <span id="pendingCount" class="notification-badge">0</span>
                </a>
            </div>
            
            <div class="nav-section" id="adminNavSection" style="display:none;">
                <h3>Admin Tools</h3>
                <a href="#" class="nav-item" data-section="adminDutyRoster">
                    <span class="nav-icon">üë®‚Äçüíº</span>
                    <span>Duty Roster</span>
                </a>
                <a href="#" class="nav-item" data-section="adminLeaveBalance">
                    <span class="nav-icon">üí∞</span>
                    <span>Leave Balance</span>
                </a>
                <a href="#" class="nav-item" data-section="adminApprovals">
                    <span class="nav-icon">‚úÖ</span>
                    <span>Approvals</span>
                </a>
                <a href="#" class="nav-item" data-section="adminBroadcasts">
                    <span class="nav-icon">üì¢</span>
                    <span>Broadcasts</span>
                    <span id="broadcastNotification" class="notification-dot" style="display:none;"></span>
                </a>
                <a href="#" class="nav-item" data-section="adminRequestHistory">
                    <span class="nav-icon">üìä</span>
                    <span>History</span>
                </a>
                <a href="#" class="nav-item" data-section="viewAllRoster">
                    <span class="nav-icon">üë•</span>
                    <span>All Roster</span>
                </a>
            </div>
            
            <div class="nav-section">
                <h3>Settings</h3>
                <a href="#" class="nav-item" onclick="refreshApp()">
                    <span class="nav-icon">üîÑ</span>
                    <span>Refresh Data</span>
                </a>
                <a href="#" class="nav-item" onclick="toggleDarkMode()">
                    <span class="nav-icon">üåô</span>
                    <span>Dark Mode</span>
                </a>
                <a href="#" class="nav-item" onclick="exportData()">
                    <span class="nav-icon">üì§</span>
                    <span>Export Data</span>
                </a>
                <a href="#" class="nav-item" onclick="clearCache()">
                    <span class="nav-icon">üßπ</span>
                    <span>Clear Cache</span>
                </a>
            </div>
        </div>
        
        <!-- Navigation Overlay -->
        <div class="nav-overlay" id="navOverlay"></div>
        
        <!-- Offline Indicator -->
        <div class="offline-indicator" id="offlineIndicator">
            ‚ö†Ô∏è You are offline. Some features may be limited.
        </div>
        
        <!-- Content Area -->
        <div class="content-area" id="contentArea">
            <!-- Dashboard -->
            <div class="section active" id="homeSection">
                <!-- Banner Carousel -->
                <div class="banner-container" id="bannerCarousel">
                    <div class="loading">
                        <div class="spinner"></div>
                        Loading banners...
                    </div>
                </div>
                
                <div class="card">
                    <h3>Welcome, <span id="welcomeName">User</span>!</h3>
                    
                    <!-- Quick Stats -->
                    <div class="quick-stats">
                        <div class="stat-card">
                            <div class="stat-value" id="slBalance">0</div>
                            <div class="stat-label">Sick Leave</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="frlBalance">0</div>
                            <div class="stat-label">FRL</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="unreadCount">0</div>
                            <div class="stat-label">Unread</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="dutyDays">0</div>
                            <div class="stat-label">Duty Days</div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <p><strong>Today's Duty:</strong> <span id="todayDutyTime">Not Scheduled</span></p>
                        <p><strong>Next Duty:</strong> <span id="nextDutyTime">No upcoming duty</span></p>
                        <div id="homeNotifications" style="margin-top: 10px; display: none;"></div>
                    </div>
                    
                    <!-- Upcoming Events -->
                    <div class="event-calendar" id="upcomingEvents">
                        <h4 style="margin-bottom: 15px; color: var(--secondary-color); display: flex; align-items: center; gap: 10px;">
                            <span>üìÖ</span>
                            <span>Upcoming Events</span>
                        </h4>
                        <!-- Events loaded dynamically -->
                    </div>
                    
                    <div class="quick-actions">
                        <button class="quick-action-btn" onclick="showSection('dutyChange')">
                            <span class="quick-action-icon">üîÑ</span>
                            <span class="quick-action-text">Duty Change</span>
                        </button>
                        <button class="quick-action-btn" onclick="showSection('leaveApplication')">
                            <span class="quick-action-icon">üìù</span>
                            <span class="quick-action-text">Apply Leave</span>
                        </button>
                        <button class="quick-action-btn" onclick="showSection('announcements')">
                            <span class="quick-action-icon">üì¢</span>
                            <span class="quick-action-text">Announcements</span>
                            <span id="unreadBadge" class="new-badge" style="display:none">NEW</span>
                        </button>
                        <button class="quick-action-btn" onclick="showSection('viewMyRoster')">
                            <span class="quick-action-icon">üìÖ</span>
                            <span class="quick-action-text">My Roster</span>
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <h3>Recent Activity</h3>
                    <div id="recentActivity">
                        <div class="loading">
                            <div class="spinner"></div>
                            Loading activity...
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Announcements Section -->
            <div class="section" id="announcementsSection">
                <div class="card">
                    <div class="modal-header" style="margin-bottom: 20px; padding: 0;">
                        <h3 style="margin: 0;">Announcements & Events</h3>
                        <button class="btn btn-primary btn-small" onclick="markAllAsRead()">
                            <span>Mark All Read</span>
                        </button>
                    </div>
                    
                    <div class="broadcast-tabs">
                        <button class="broadcast-tab active" onclick="showBroadcastTab('all')">All</button>
                        <button class="broadcast-tab" onclick="showBroadcastTab('unread')">Unread</button>
                        <button class="broadcast-tab" onclick="showBroadcastTab('important')">Important</button>
                        <button class="broadcast-tab" onclick="showBroadcastTab('events')">Events</button>
                    </div>
                    
                    <div id="announcementsList" class="announcement-list">
                        <div class="loading">
                            <div class="spinner"></div>
                            Loading announcements...
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Admin Broadcast Management -->
            <div class="section" id="adminBroadcastsSection">
                <div class="card">
                    <h3>Broadcast Management</h3>
                    
                    <div class="broadcast-tabs">
                        <button class="broadcast-tab active" onclick="showBroadcastAdminTab('create')">Create New</button>
                        <button class="broadcast-tab" onclick="showBroadcastAdminTab('manage')">Manage</button>
                        <button class="broadcast-tab" onclick="showBroadcastAdminTab('analytics')">Analytics</button>
                    </div>
                    
                    <!-- Create Broadcast Tab -->
                    <div id="createBroadcastTab" class="broadcast-content active">
                        <div class="event-form-container">
                            <div class="form-section">
                                <h4 class="form-section-title">Create New Broadcast</h4>
                                
                                <form id="broadcastForm">
                                    <div class="form-group">
                                        <label for="broadcastType">Type *</label>
                                        <select id="broadcastType" class="form-control" required>
                                            <option value="">Select type</option>
                                            <option value="announcement">üì¢ Announcement</option>
                                            <option value="event">üìÖ Event</option>
                                            <option value="banner">üñºÔ∏è Banner</option>
                                            <option value="notice">üìã Notice</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="broadcastTitle">Title *</label>
                                        <input type="text" id="broadcastTitle" class="form-control" placeholder="Enter broadcast title" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="broadcastContent">Content *</label>
                                        <textarea id="broadcastContent" class="form-control" rows="5" placeholder="Enter broadcast content" required></textarea>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="broadcastPriority">Priority</label>
                                            <select id="broadcastPriority" class="form-control">
                                                <option value="low">üü¢ Low</option>
                                                <option value="medium" selected>üü° Medium</option>
                                                <option value="high">üî¥ High</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label for="broadcastExpiry">Expiry Date</label>
                                            <input type="date" id="broadcastExpiry" class="form-control">
                                        </div>
                                    </div>
                                    
                                    <!-- Image Upload for Banners -->
                                    <div id="bannerUploadSection" style="display:none;">
                                        <div class="form-group">
                                            <label>Banner Image</label>
                                            <div class="upload-area" onclick="document.getElementById('bannerImage').click()">
                                                <div class="upload-icon">üì∑</div>
                                                <p style="font-weight: 600; margin-bottom: 8px;">Click to upload image</p>
                                                <p style="font-size: 13px; color: var(--gray);">Recommended: 1200x400px ‚Ä¢ Max 5MB</p>
                                            </div>
                                            <input type="file" id="bannerImage" accept="image/*" style="display:none">
                                            <img id="bannerPreview" class="image-preview" src="" alt="Banner Preview">
                                        </div>
                                    </div>
                                    
                                    <!-- Event Specific Fields -->
                                    <div id="eventFields" style="display:none;">
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label for="eventDate">Event Date *</label>
                                                <input type="date" id="eventDate" class="form-control">
                                            </div>
                                            <div class="form-group">
                                                <label for="eventTime">Event Time</label>
                                                <input type="time" id="eventTime" class="form-control">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label for="eventLocation">Location</label>
                                            <input type="text" id="eventLocation" class="form-control" placeholder="Enter event location">
                                        </div>
                                    </div>
                                    
                                    <!-- Target Audience -->
                                    <div class="form-section">
                                        <h4 class="form-section-title">Target Audience</h4>
                                        <div class="target-audience">
                                            <div class="target-option">
                                                <input type="radio" id="targetAll" name="target" value="all" checked>
                                                <label for="targetAll">üë• All Users</label>
                                            </div>
                                            <div class="target-option">
                                                <input type="radio" id="targetSpecific" name="target" value="specific">
                                                <label for="targetSpecific">üë§ Specific Users</label>
                                            </div>
                                            <div class="target-option">
                                                <input type="radio" id="targetGroup" name="target" value="group">
                                                <label for="targetGroup">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ User Groups</label>
                                            </div>
                                        </div>
                                        
                                        <!-- Specific Users Selection -->
                                        <div id="specificUsers" class="user-selection">
                                            <h5 style="margin-bottom: 15px; color: var(--secondary-color);">Select Users:</h5>
                                            <div id="userCheckboxes">
                                                <!-- User checkboxes loaded dynamically -->
                                            </div>
                                        </div>
                                        
                                        <!-- Group Selection -->
                                        <div id="groupSelection" class="user-selection">
                                            <h5 style="margin-bottom: 15px; color: var(--secondary-color);">Select Groups:</h5>
                                            <div class="target-audience">
                                                <div class="target-option">
                                                    <input type="checkbox" id="groupShiftA" name="groups" value="shiftA">
                                                    <label for="groupShiftA">üåÖ Shift A</label>
                                                </div>
                                                <div class="target-option">
                                                    <input type="checkbox" id="groupShiftB" name="groups" value="shiftB">
                                                    <label for="groupShiftB">üåá Shift B</label>
                                                </div>
                                                <div class="target-option">
                                                    <input type="checkbox" id="groupShiftC" name="groups" value="shiftC">
                                                    <label for="groupShiftC">üåÉ Shift C</label>
                                                </div>
                                                <div class="target-option">
                                                    <input type="checkbox" id="groupSupervisors" name="groups" value="supervisors">
                                                    <label for="groupSupervisors">üëë Supervisors</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="action-buttons">
                                        <button type="submit" class="btn btn-success">üöÄ Publish Broadcast</button>
                                        <button type="button" class="btn btn-warning" onclick="saveDraft()">üíæ Save as Draft</button>
                                        <button type="button" class="btn btn-secondary" onclick="clearBroadcastForm()">üóëÔ∏è Clear Form</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Manage Broadcasts Tab -->
                    <div id="manageBroadcastsTab" class="broadcast-content">
                        <div class="current-events">
                            <h4 style="margin-bottom: 20px; color: var(--secondary-color); display: flex; align-items: center; gap: 10px;">
                                <span>üì¢</span>
                                <span>Active Broadcasts</span>
                            </h4>
                            <div id="activeBroadcasts">
                                <div class="loading">
                                    <div class="spinner"></div>
                                    Loading active broadcasts...
                                </div>
                            </div>
                        </div>
                        
                        <div class="current-events" style="margin-top: 20px;">
                            <h4 style="margin-bottom: 20px; color: var(--secondary-color); display: flex; align-items: center; gap: 10px;">
                                <span>üìù</span>
                                <span>Draft Broadcasts</span>
                            </h4>
                            <div id="draftBroadcasts">
                                <div class="loading">
                                    <div class="spinner"></div>
                                    Loading draft broadcasts...
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Analytics Tab -->
                    <div id="analyticsBroadcastsTab" class="broadcast-content">
                        <div class="quick-stats">
                            <div class="stat-card">
                                <div class="stat-value" id="totalBroadcasts">0</div>
                                <div class="stat-label">Total</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="activeBroadcastsCount">0</div>
                                <div class="stat-label">Active</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="avgReadRate">0%</div>
                                <div class="stat-label">Read Rate</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="userEngagement">0</div>
                                <div class="stat-label">Engagement</div>
                            </div>
                        </div>
                        
                        <div class="card" style="margin-top: 20px;">
                            <h4 style="display: flex; align-items: center; gap: 10px;">
                                <span>üìà</span>
                                <span>Broadcast Performance</span>
                            </h4>
                            <div id="broadcastChart" style="height: 200px; margin-top: 20px; display: flex; align-items: flex-end; justify-content: center; gap: 15px;">
                                <!-- Chart rendered dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Duty Change Request -->
            <div class="section" id="dutyChangeSection">
                <div class="card">
                    <h3>Duty Change Request</h3>
                    
                    <div class="alert alert-warning">
                        <strong>‚ö†Ô∏è Note:</strong> Requests must be made at least 24 hours in advance.
                    </div>
                    
                    <form id="dutyChangeForm">
                        <div class="form-group">
                            <label for="changeDate">Change Date *</label>
                            <input type="date" id="changeDate" class="form-control" required min="">
                        </div>
                        
                        <div class="form-group">
                            <label for="changeDutyTime">Your Duty Time *</label>
                            <select id="changeDutyTime" class="form-control" required>
                                <option value="">Select duty time</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="requestToStaff">Request To Staff *</label>
                            <select id="requestToStaff" class="form-control" required>
                                <option value="">Select staff member</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="requestToDutyTime">Staff's Duty Time *</label>
                            <select id="requestToDutyTime" class="form-control" required>
                                <option value="">Select duty time</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="changeReason">Reason (Optional)</label>
                            <textarea id="changeReason" class="form-control" rows="3" placeholder="Brief reason for duty change"></textarea>
                        </div>
                        
                        <div class="action-buttons">
                            <button type="submit" class="btn btn-success">‚úÖ Submit Request</button>
                            <button type="button" class="btn btn-danger" onclick="showSection('home')">‚ùå Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Leave Application -->
            <div class="section" id="leaveApplicationSection">
                <div class="card">
                    <h3>Leave Application</h3>
                    
                    <div class="alert alert-info">
                        <p><strong>üìã Application Rules:</strong></p>
                        <p>‚Ä¢ Sick Leave: Minimum 2 hours before duty time</p>
                        <p>‚Ä¢ FRL: Minimum 1 hour before duty time</p>
                        <p>‚Ä¢ No back dated applications allowed</p>
                    </div>
                    
                    <form id="leaveApplicationForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="leaveType">Leave Type *</label>
                                <select id="leaveType" class="form-control" required>
                                    <option value="">Select leave type</option>
                                    <option value="Sick Leave">ü§í Sick Leave</option>
                                    <option value="FRL">üèñÔ∏è FRL</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="leaveDate">Leave Date *</label>
                                <input type="date" id="leaveDate" class="form-control" required min="">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="leaveDutyTime">Duty Time *</label>
                                <select id="leaveDutyTime" class="form-control" required>
                                    <option value="">Select duty time</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="leaveDuration">Duration *</label>
                                <select id="leaveDuration" class="form-control" required>
                                    <option value="1">1 Day</option>
                                    <option value="0.5">Half Day</option>
                                    <option value="2">2 Days</option>
                                    <option value="3">3 Days</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="leaveReason">Reason *</label>
                            <textarea id="leaveReason" class="form-control" rows="4" placeholder="Please provide reason for leave" required></textarea>
                        </div>
                        
                        <div class="form-group">
                            <div class="alert" id="leaveRulesAlert">
                                Select leave type, date and duty time to see rules
                            </div>
                        </div>
                        
                        <div class="action-buttons">
                            <button type="submit" class="btn btn-success" id="submitLeaveBtn">üì§ Submit Application</button>
                            <button type="button" class="btn btn-danger" onclick="showSection('home')">‚ùå Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- My Requests -->
            <div class="section" id="myRequestsSection">
                <div class="card">
                    <h3>My Requests</h3>
                    
                    <div class="search-bar" style="position: relative; margin-bottom: 20px;">
                        <input type="text" class="form-control" placeholder="üîç Search requests..." id="searchRequests" style="padding-left: 45px;">
                        <div style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--gray);">
                            üîç
                        </div>
                    </div>
                    
                    <div id="myRequestsMobile" style="min-height: 200px;">
                        <div class="loading">
                            <div class="spinner"></div>
                            Loading your requests...
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- My Roster -->
            <div class="section" id="viewMyRosterSection">
                <div class="card">
                    <h3>My Duty Roster</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="myRosterMonth">View Month</label>
                            <input type="month" id="myRosterMonth" class="form-control" value="">
                        </div>
                        <div class="form-group">
                            <label for="myRosterViewType">View Type</label>
                            <select id="myRosterViewType" class="form-control">
                                <option value="table">üìä Table View</option>
                                <option value="calendar">üìÖ Calendar View</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="loadMyRoster()">üì• Load Roster</button>
                    </div>
                    
                    <div class="alert alert-info" style="margin-top: 20px;">
                        This shows your scheduled duties. Changes must be requested via Duty Change.
                    </div>
                    
                    <div id="myRosterContainer" style="margin-top: 20px; min-height: 200px;">
                        <!-- Roster loaded dynamically -->
                    </div>
                </div>
            </div>
            
            <!-- Pending Requests -->
            <div class="section" id="pendingRequestsSection">
                <div class="card">
                    <h3>Pending Requests For You</h3>
                    <div id="pendingRequestsMobile" style="min-height: 200px;">
                        <div class="loading">
                            <div class="spinner"></div>
                            Loading pending requests...
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Other sections (Admin Duty Roster, Leave Balance, Approvals, History, View All Roster) -->
            <!-- Due to character limit, these sections follow similar patterns -->
            
        </div>
        
        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <button class="bottom-nav-item active" data-section="home">
                <span class="bottom-nav-icon">üè†</span>
                <span>Home</span>
            </button>
            <button class="bottom-nav-item" data-section="dutyChange">
                <span class="bottom-nav-icon">üîÑ</span>
                <span>Change</span>
            </button>
            <button class="bottom-nav-item" data-section="leaveApplication">
                <span class="bottom-nav-icon">üìù</span>
                <span>Leave</span>
            </button>
            <button class="bottom-nav-item" data-section="myRequests">
                <span class="bottom-nav-icon">üìã</span>
                <span>Requests</span>
            </button>
            <button class="bottom-nav-item" data-section="announcements">
                <span class="bottom-nav-icon">üì¢</span>
                <span>News</span>
            </button>
        </div>
        
        <!-- Floating Action Button -->
        <button class="fab" id="fabButton" onclick="showQuickActionMenu()">+</button>
        
        <!-- Quick Action Modal -->
        <div class="modal" id="quickActionModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Quick Actions</h3>
                    <button class="modal-close" onclick="hideQuickActionMenu()">√ó</button>
                </div>
                <div class="quick-actions" style="margin: 0;">
                    <button class="quick-action-btn" onclick="showSection('dutyChange'); hideQuickActionMenu();">
                        <span class="quick-action-icon">üîÑ</span>
                        <span class="quick-action-text">Duty Change</span>
                    </button>
                    <button class="quick-action-btn" onclick="showSection('leaveApplication'); hideQuickActionMenu();">
                        <span class="quick-action-icon">üìù</span>
                        <span class="quick-action-text">Apply Leave</span>
                    </button>
                    <button class="quick-action-btn" onclick="refreshApp(); hideQuickActionMenu();">
                        <span class="quick-action-icon">üîÑ</span>
                        <span class="quick-action-text">Refresh</span>
                    </button>
                    <button class="quick-action-btn" onclick="updateDashboard(); hideQuickActionMenu();">
                        <span class="quick-action-icon">üìä</span>
                        <span class="quick-action-text">Dashboard</span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Important Broadcast Modal -->
        <div class="modal" id="importantBroadcastModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title" id="modalBroadcastTitle">Important Announcement</h3>
                    <button class="modal-close" onclick="closeBroadcastModal()">√ó</button>
                </div>
                <div id="modalBroadcastContent" style="line-height: 1.6; margin-bottom: 25px;">
                    <!-- Content loaded dynamically -->
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="markAsReadAndClose()">‚úÖ Mark as Read</button>
                    <button class="btn btn-secondary" onclick="closeBroadcastModal()">‚ùå Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== GLOBAL VARIABLES =====
        let currentUser = null;
        let allUsers = [];
        let dutyRoster = {};
        let leaveBalances = {};
        let allRequests = [];
        let broadcasts = [];
        let userBroadcasts = [];
        let currentBroadcastModal = null;
        let carouselIndex = 0;
        let carouselInterval = null;
        let isOnline = navigator.onLine;

        // ===== SAMPLE USER DATA (Replace with your actual user data) =====
        // This would normally come from dcfire.js and user.js
        const users = [
            {
                username: "iru1",
                passwordHash: "8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92", // "123456"
                name: "Irufan 1",
                RCNo: "001",
                Level: "User"
            },
            {
                username: "supervisor",
                passwordHash: "8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92", // "123456"
                name: "Supervisor",
                RCNo: "999",
                Level: "Supervisor"
            }
        ];

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
        });

        function initApp() {
            // Set minimum dates
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('changeDate').min = today;
            document.getElementById('leaveDate').min = today;
            
            // Set default values
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('changeDate').value = tomorrow.toISOString().split('T')[0];
            document.getElementById('leaveDate').value = tomorrow.toISOString().split('T')[0];
            document.getElementById('myRosterMonth').value = today.substring(0, 7);
            document.getElementById('broadcastExpiry').value = getDateAfterDays(today, 7);
            document.getElementById('eventDate').value = today;
            
            // Setup event listeners
            setupEventListeners();
            
            // Check for existing session
            checkSession();
            
            // Setup mobile features
            setupMobileFeatures();
            
            // Check network status
            updateOnlineStatus();
            
            // Initialize default roster data
            initializeDefaultRoster();
        }

        function setupEventListeners() {
            // Login form
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                handleLogin();
            });
            
            // Duty change form
            document.getElementById('dutyChangeForm').addEventListener('submit', function(e) {
                e.preventDefault();
                submitDutyChange();
            });
            
            // Leave application form
            document.getElementById('leaveApplicationForm').addEventListener('submit', function(e) {
                e.preventDefault();
                submitLeaveApplication();
            });
            
            // Broadcast form
            document.getElementById('broadcastForm').addEventListener('submit', function(e) {
                e.preventDefault();
                createBroadcast();
            });
            
            // Dynamic field listeners
            document.getElementById('changeDate').addEventListener('change', function() {
                loadUserDutyTimes('changeDutyTime', this.value);
            });
            
            document.getElementById('leaveDate').addEventListener('change', function() {
                loadUserDutyTimes('leaveDutyTime', this.value);
                updateLeaveRules();
            });
            
            document.getElementById('leaveType').addEventListener('change', updateLeaveRules);
            document.getElementById('leaveDutyTime').addEventListener('change', updateLeaveRules);
            
            document.getElementById('requestToStaff').addEventListener('change', function() {
                const user = allUsers.find(u => u.username === this.value);
                if (user) {
                    const date = document.getElementById('changeDate').value;
                    if (date) {
                        loadStaffDutyTimes('requestToDutyTime', date, user.username);
                    }
                }
            });
            
            // Broadcast type change
            document.getElementById('broadcastType').addEventListener('change', function() {
                const type = this.value;
                document.getElementById('bannerUploadSection').style.display = type === 'banner' ? 'block' : 'none';
                document.getElementById('eventFields').style.display = type === 'event' ? 'block' : 'none';
            });
            
            // Target audience change
            document.querySelectorAll('input[name="target"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    document.getElementById('specificUsers').classList.remove('active');
                    document.getElementById('groupSelection').classList.remove('active');
                    
                    if (this.value === 'specific') {
                        document.getElementById('specificUsers').classList.add('active');
                        loadUserCheckboxes();
                    } else if (this.value === 'group') {
                        document.getElementById('groupSelection').classList.add('active');
                    }
                });
            });
            
            // Image preview
            document.getElementById('bannerImage').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    if (file.size > 5 * 1024 * 1024) {
                        showToast('Image size should be less than 5MB');
                        this.value = '';
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const preview = document.getElementById('bannerPreview');
                        preview.src = e.target.result;
                        preview.classList.add('active');
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', function() {
                logout();
            });
            
            // Roster month change
            document.getElementById('myRosterMonth').addEventListener('change', function() {
                if (document.getElementById('viewMyRosterSection').classList.contains('active')) {
                    loadMyRoster();
                }
            });
            
            // Roster view type change
            document.getElementById('myRosterViewType').addEventListener('change', function() {
                if (document.getElementById('viewMyRosterSection').classList.contains('active')) {
                    loadMyRoster();
                }
            });
        }

        function setupMobileFeatures() {
            // Mobile menu toggle
            document.getElementById('menuToggle').addEventListener('click', toggleMobileMenu);
            document.getElementById('navOverlay').addEventListener('click', toggleMobileMenu);
            
            // Mobile navigation
            document.querySelectorAll('.mobile-nav .nav-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const section = this.getAttribute('data-section');
                    showSection(section);
                    toggleMobileMenu();
                });
            });
            
            // Bottom navigation
            document.querySelectorAll('.bottom-nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    document.querySelectorAll('.bottom-nav-item').forEach(i => i.classList.remove('active'));
                    this.classList.add('active');
                    const section = this.getAttribute('data-section');
                    showSection(section);
                });
            });
            
            // Swipe gestures for carousel
            setupSwipeGestures();
            
            // Pull to refresh
            setupPullToRefresh();
            
            // Network status
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            
            // Service Worker for PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js').catch(console.error);
            }
            
            // Add to home screen prompt
            let deferredPrompt;
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                showInstallPrompt();
            });
        }

        function setupSwipeGestures() {
            let touchStartX = 0;
            let touchEndX = 0;
            
            document.addEventListener('touchstart', e => {
                touchStartX = e.changedTouches[0].screenX;
            });
            
            document.addEventListener('touchend', e => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            });
            
            function handleSwipe() {
                const swipeThreshold = 50;
                const diff = touchStartX - touchEndX;
                
                if (Math.abs(diff) > swipeThreshold) {
                    const currentSection = document.querySelector('.section.active').id;
                    const sections = ['home', 'dutyChange', 'leaveApplication', 'myRequests', 'announcements'];
                    const currentIndex = sections.indexOf(currentSection.replace('Section', ''));
                    
                    if (diff > 0 && currentIndex < sections.length - 1) {
                        // Swipe left
                        showSection(sections[currentIndex + 1]);
                    } else if (diff < 0 && currentIndex > 0) {
                        // Swipe right
                        showSection(sections[currentIndex - 1]);
                    }
                }
            }
        }

        function setupPullToRefresh() {
            let pullStartY = 0;
            let pulling = false;
            
            document.addEventListener('touchstart', e => {
                if (window.scrollY === 0) {
                    pullStartY = e.touches[0].clientY;
                    pulling = true;
                }
            });
            
            document.addEventListener('touchmove', e => {
                if (!pulling) return;
                
                const pullDistance = e.touches[0].clientY - pullStartY;
                if (pullDistance > 100) {
                    // Trigger refresh
                    refreshCurrentSection();
                    pulling = false;
                }
            });
            
            document.addEventListener('touchend', () => {
                pulling = false;
            });
        }

        function toggleMobileMenu() {
            const nav = document.getElementById('mobileNav');
            const overlay = document.getElementById('navOverlay');
            nav.classList.toggle('active');
            overlay.classList.toggle('active');
            document.body.style.overflow = nav.classList.contains('active') ? 'hidden' : '';
        }

        // ===== AUTHENTICATION =====
        function checkSession() {
            const session = localStorage.getItem('dutySystemSession');
            if (session) {
                try {
                    const user = JSON.parse(session);
                    if (user.expiry > Date.now()) {
                        loginUser(user);
                    } else {
                        localStorage.removeItem('dutySystemSession');
                    }
                } catch (e) {
                    localStorage.removeItem('dutySystemSession');
                }
            }
        }

        function handleLogin() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const errorMsg = document.getElementById('errorMessage');
            
            if (!username || !password) {
                showError('Please enter both username and password');
                return;
            }
            
            const user = users.find(u => u.username === username);
            
            if (!user) {
                showError('Invalid username or password');
                return;
            }
            
            // Hash and check password
            const hashedPassword = sha256(password);
            
            if (hashedPassword === user.passwordHash) {
                const sessionData = {
                    username: user.username,
                    name: user.name,
                    rcNo: user.RCNo,
                    level: user.Level,
                    expiry: Date.now() + (8 * 60 * 60 * 1000) // 8 hours
                };
                
                localStorage.setItem('dutySystemSession', JSON.stringify(sessionData));
                loginUser(sessionData);
            } else {
                showError('Invalid username or password');
            }
        }

        function showError(message) {
            const errorMsg = document.getElementById('errorMessage');
            errorMsg.textContent = message;
            errorMsg.style.display = 'block';
            vibrate(100);
        }

        function loginUser(userData) {
            currentUser = userData;
            allUsers = users || [];
            
            // Update UI
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('dashboardContainer').style.display = 'block';
            
            // Update user info
            document.getElementById('userName').textContent = userData.name;
            document.getElementById('userRC').textContent = userData.rcNo;
            document.getElementById('userLevel').textContent = userData.level;
            document.getElementById('welcomeName').textContent = userData.name;
            
            // Show/hide admin sections
            if (userData.level === 'Supervisor') {
                document.getElementById('adminNavSection').style.display = 'block';
                document.getElementById('pendingRequestsNav').style.display = 'block';
            }
            
            // Initialize data
            initializeData();
            
            // Setup navigation
            setupNavigation();
            
            // Update dashboard
            updateDashboard();
            
            showToast(`Welcome back, ${userData.name}!`);
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('dutySystemSession');
                location.reload();
            }
        }

        // ===== DATA MANAGEMENT =====
        function initializeData() {
            // Load data from localStorage
            loadDutyRoster();
            loadLeaveBalances();
            loadAllRequests();
            loadBroadcasts();
            
            // Update user's balance display
            updateUserBalance();
        }

        function initializeDefaultRoster() {
            // Generate sample roster data if none exists
            if (Object.keys(dutyRoster).length === 0) {
                const today = new Date();
                for (let i = 0; i < 30; i++) {
                    const date = new Date();
                    date.setDate(today.getDate() + i);
                    const dateStr = date.toISOString().split('T')[0];
                    
                    dutyRoster[dateStr] = {};
                    
                    // Assign duties to all users
                    users.forEach(user => {
                        // Different shifts based on day
                        const dayOfWeek = date.getDay();
                        let dutyTime;
                        
                        if (dayOfWeek === 0 || dayOfWeek === 6) {
                            // Weekend: reduced staff
                            if (user.RCNo === "001") {
                                dutyTime = "08:00-16:00";
                            } else {
                                dutyTime = "Off";
                            }
                        } else {
                            // Weekday: full shifts
                            if (user.RCNo === "001") {
                                dutyTime = "08:00-16:00";
                            } else if (user.RCNo === "999") {
                                dutyTime = "16:00-00:00";
                            } else {
                                dutyTime = "00:00-08:00";
                            }
                        }
                        
                        dutyRoster[dateStr][user.username] = dutyTime;
                    });
                }
                saveDutyRoster();
            }
        }

        function loadDutyRoster() {
            const savedRoster = localStorage.getItem('dutyRosterData');
            if (savedRoster) {
                dutyRoster = JSON.parse(savedRoster);
            } else {
                dutyRoster = {};
                saveDutyRoster();
            }
        }

        function saveDutyRoster() {
            localStorage.setItem('dutyRosterData', JSON.stringify(dutyRoster));
            // In real app, sync with Firebase
        }

        function loadLeaveBalances() {
            const savedBalances = localStorage.getItem('leaveBalancesData');
            if (savedBalances) {
                leaveBalances = JSON.parse(savedBalances);
            } else {
                leaveBalances = {};
                allUsers.forEach(user => {
                    leaveBalances[user.username] = {
                        SL: 12,
                        FRL: 6
                    };
                });
                saveLeaveBalances();
            }
        }

        function saveLeaveBalances() {
            localStorage.setItem('leaveBalancesData', JSON.stringify(leaveBalances));
        }

        function loadAllRequests() {
            const savedRequests = localStorage.getItem('dutyRequestsData');
            if (savedRequests) {
                allRequests = JSON.parse(savedRequests);
            } else {
                allRequests = [];
            }
            updateRequestCounts();
        }

        function saveAllRequests() {
            localStorage.setItem('dutyRequestsData', JSON.stringify(allRequests));
        }

        function loadBroadcasts() {
            const savedBroadcasts = localStorage.getItem('broadcastsData');
            if (savedBroadcasts) {
                broadcasts = JSON.parse(savedBroadcasts);
            } else {
                broadcasts = [];
                // Add sample broadcasts
                broadcasts.push({
                    id: 'broadcast_1',
                    type: 'announcement',
                    title: 'Welcome to Duty Management System',
                    content: 'This is a new system for managing duties and leaves. Please explore all features.',
                    priority: 'medium',
                    target: 'all',
                    createdBy: 'System Admin',
                    createdAt: new Date().toISOString(),
                    status: 'published',
                    readBy: []
                });
                saveBroadcasts();
            }
            loadUserBroadcasts();
        }

        function saveBroadcasts() {
            localStorage.setItem('broadcastsData', JSON.stringify(broadcasts));
        }

        function loadUserBroadcasts() {
            if (!currentUser) return;
            
            userBroadcasts = broadcasts.filter(broadcast => {
                if (broadcast.target === 'all') return true;
                if (broadcast.target === 'specific' && broadcast.targetUsers && 
                    broadcast.targetUsers.includes(currentUser.username)) return true;
                if (broadcast.target === 'group' && broadcast.targetGroups) {
                    const userGroup = getUserGroup(currentUser.username);
                    return broadcast.targetGroups.includes(userGroup);
                }
                return false;
            });
            
            // Sort by priority and date
            userBroadcasts.sort((a, b) => {
                const priorityOrder = {high: 3, medium: 2, low: 1};
                if (priorityOrder[b.priority] !== priorityOrder[a.priority]) {
                    return priorityOrder[b.priority] - priorityOrder[a.priority];
                }
                return new Date(b.createdAt) - new Date(a.createdAt);
            });
            
            displayUserBroadcasts();
        }

        function getUserGroup(username) {
            const user = allUsers.find(u => u.username === username);
            if (user && user.RCNo) {
                const lastDigit = parseInt(user.RCNo.slice(-1));
                if (lastDigit <= 3) return 'shiftA';
                if (lastDigit <= 6) return 'shiftB';
                return 'shiftC';
            }
            return 'shiftA';
        }

        // ===== BROADCAST SYSTEM =====
        function displayUserBroadcasts() {
            displayBanners();
            displayUpcomingEvents();
            checkImportantBroadcasts();
            updateUnreadCount();
        }

        function displayBanners() {
            const bannerContainer = document.getElementById('bannerCarousel');
            const activeBanners = userBroadcasts.filter(b => 
                b.type === 'banner' && 
                b.status === 'published' &&
                (!b.expiryDate || new Date(b.expiryDate) > new Date())
            );
            
            if (activeBanners.length === 0) {
                bannerContainer.innerHTML = '<div class="banner-slide banner-priority-low"><div class="banner-content">No active banners</div></div>';
                return;
            }
            
            let html = '<div class="banner-carousel">';
            activeBanners.forEach((banner, index) => {
                const priorityClass = `banner-priority-${banner.priority}`;
                const isActive = index === 0 ? 'active' : '';
                
                html += `
                    <div class="banner-slide ${priorityClass} ${isActive}" id="bannerSlide${index}" style="display: ${index === 0 ? 'flex' : 'none'}">
                        <div class="banner-badge">${banner.type.toUpperCase()}</div>
                        <div class="banner-title">${banner.title}</div>
                        <div class="banner-content">${banner.content}</div>
                        <div class="banner-meta">
                            <span>From: ${banner.createdBy}</span>
                            <span>${formatDate(banner.createdAt)}</span>
                        </div>
                        ${!isBroadcastRead(banner.id) ? `
                        <div class="banner-actions">
                            <button class="banner-action-btn" onclick="markBroadcastAsRead('${banner.id}')">‚úì</button>
                        </div>` : ''}
                    </div>
                `;
            });
            
            // Add carousel controls
            if (activeBanners.length > 1) {
                html += `
                    <div class="carousel-controls">
                        <button class="carousel-btn" onclick="prevBanner()">‚Äπ</button>
                        <button class="carousel-btn" onclick="nextBanner()">‚Ä∫</button>
                    </div>
                    <div class="carousel-dots">
                        ${activeBanners.map((_, i) => `<button class="carousel-dot ${i === 0 ? 'active' : ''}" onclick="goToBanner(${i})"></button>`).join('')}
                    </div>
                `;
            }
            
            html += '</div>';
            bannerContainer.innerHTML = html;
            
            // Start auto-rotation
            if (activeBanners.length > 1) {
                startBannerRotation();
            }
        }

        function startBannerRotation() {
            if (carouselInterval) clearInterval(carouselInterval);
            carouselInterval = setInterval(nextBanner, 5000);
        }

        function nextBanner() {
            const banners = document.querySelectorAll('.banner-slide');
            const dots = document.querySelectorAll('.carousel-dot');
            
            if (banners.length === 0) return;
            
            banners[carouselIndex].style.display = 'none';
            if (dots[carouselIndex]) dots[carouselIndex].classList.remove('active');
            
            carouselIndex = (carouselIndex + 1) % banners.length;
            
            banners[carouselIndex].style.display = 'flex';
            if (dots[carouselIndex]) dots[carouselIndex].classList.add('active');
        }

        function prevBanner() {
            const banners = document.querySelectorAll('.banner-slide');
            const dots = document.querySelectorAll('.carousel-dot');
            
            if (banners.length === 0) return;
            
            banners[carouselIndex].style.display = 'none';
            if (dots[carouselIndex]) dots[carouselIndex].classList.remove('active');
            
            carouselIndex = (carouselIndex - 1 + banners.length) % banners.length;
            
            banners[carouselIndex].style.display = 'flex';
            if (dots[carouselIndex]) dots[carouselIndex].classList.add('active');
        }

        function goToBanner(index) {
            const banners = document.querySelectorAll('.banner-slide');
            const dots = document.querySelectorAll('.carousel-dot');
            
            if (banners.length === 0 || index >= banners.length) return;
            
            banners[carouselIndex].style.display = 'none';
            if (dots[carouselIndex]) dots[carouselIndex].classList.remove('active');
            
            carouselIndex = index;
            
            banners[carouselIndex].style.display = 'flex';
            if (dots[carouselIndex]) dots[carouselIndex].classList.add('active');
        }

        function displayUpcomingEvents() {
            const eventsContainer = document.getElementById('upcomingEvents');
            eventsContainer.innerHTML = `
                <h4 style="margin-bottom: 15px; color: var(--secondary-color); display: flex; align-items: center; gap: 10px;">
                    <span>üìÖ</span>
                    <span>Upcoming Events</span>
                </h4>
            `;
            
            const upcomingEvents = userBroadcasts.filter(b => 
                b.type === 'event' && 
                b.status === 'published' &&
                b.eventDate &&
                new Date(b.eventDate) >= new Date()
            ).slice(0, 3);
            
            if (upcomingEvents.length === 0) {
                eventsContainer.innerHTML += `
                    <div style="text-align: center; padding: 30px; color: var(--gray);">
                        <div style="font-size: 48px; margin-bottom: 15px; opacity: 0.3;">üìÖ</div>
                        <p>No upcoming events</p>
                    </div>
                `;
                return;
            }
            
            upcomingEvents.forEach(event => {
                const eventDate = new Date(event.eventDate);
                const day = eventDate.getDate();
                const month = eventDate.toLocaleString('default', { month: 'short' });
                const isRead = isBroadcastRead(event.id);
                
                eventsContainer.innerHTML += `
                    <div class="event-day" onclick="showEventDetails('${event.id}')">
                        <div class="event-date">
                            <div class="event-date-day">${day}</div>
                            <div class="event-date-month">${month}</div>
                        </div>
                        <div class="event-details">
                            <div class="event-title">
                                ${event.title}
                                ${!isRead ? '<span class="read-status unread"></span>' : ''}
                            </div>
                            <div class="event-description">${event.content.substring(0, 60)}...</div>
                            ${event.eventTime ? `<div class="event-time">${event.eventTime}</div>` : ''}
                        </div>
                    </div>
                `;
            });
        }

        function checkImportantBroadcasts() {
            if (!currentUser) return;
            
            const importantUnread = userBroadcasts.filter(b => 
                b.priority === 'high' && 
                b.status === 'published' &&
                !isBroadcastRead(b.id)
            );
            
            if (importantUnread.length > 0) {
                const broadcast = importantUnread[0];
                showBroadcastModal(broadcast);
            }
        }

        function showBroadcastModal(broadcast) {
            document.getElementById('modalBroadcastTitle').textContent = broadcast.title;
            
            let content = `
                <div style="margin-bottom: 15px;">
                    <span class="announcement-priority priority-${broadcast.priority}" style="margin-bottom: 10px; display: inline-block;">
                        ${broadcast.priority.toUpperCase()}
                    </span>
                </div>
                <div style="margin-bottom: 20px; line-height: 1.6; font-size: 15px;">
                    ${broadcast.content}
                </div>
            `;
            
            if (broadcast.eventDate) {
                content += `<div style="margin-bottom: 10px;"><strong>üìÖ Date:</strong> ${formatDate(broadcast.eventDate)}</div>`;
            }
            if (broadcast.eventTime) {
                content += `<div style="margin-bottom: 10px;"><strong>üïê Time:</strong> ${broadcast.eventTime}</div>`;
            }
            if (broadcast.eventLocation) {
                content += `<div style="margin-bottom: 10px;"><strong>üìç Location:</strong> ${broadcast.eventLocation}</div>`;
            }
            
            content += `
                <div style="font-size: 13px; color: var(--gray); margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--gray-light);">
                    Published by ${broadcast.createdBy} on ${formatDate(broadcast.createdAt)}
                </div>
            `;
            
            document.getElementById('modalBroadcastContent').innerHTML = content;
            currentBroadcastModal = broadcast.id;
            document.getElementById('importantBroadcastModal').classList.add('active');
        }

        function closeBroadcastModal() {
            document.getElementById('importantBroadcastModal').classList.remove('active');
            currentBroadcastModal = null;
        }

        function markAsReadAndClose() {
            if (currentBroadcastModal) {
                markBroadcastAsRead(currentBroadcastModal);
            }
            closeBroadcastModal();
        }

        function isBroadcastRead(broadcastId) {
            const broadcast = broadcasts.find(b => b.id === broadcastId);
            return broadcast && broadcast.readBy && broadcast.readBy.includes(currentUser.username);
        }

        function markBroadcastAsRead(broadcastId) {
            const broadcast = broadcasts.find(b => b.id === broadcastId);
            if (!broadcast) return;
            
            if (!broadcast.readBy) broadcast.readBy = [];
            if (!broadcast.readBy.includes(currentUser.username)) {
                broadcast.readBy.push(currentUser.username);
                saveBroadcasts();
                updateUnreadCount();
                vibrate(50);
                showToast('Marked as read');
            }
        }

        function markAllAsRead() {
            userBroadcasts.forEach(broadcast => {
                if (!broadcast.readBy) broadcast.readBy = [];
                if (!broadcast.readBy.includes(currentUser.username)) {
                    broadcast.readBy.push(currentUser.username);
                }
            });
            saveBroadcasts();
            updateUnreadCount();
            loadUserBroadcasts();
            showToast('All announcements marked as read');
        }

        function updateUnreadCount() {
            if (!currentUser) return;
            
            const unreadCount = userBroadcasts.filter(b => !isBroadcastRead(b.id)).length;
            
            document.getElementById('unreadCount').textContent = unreadCount;
            document.getElementById('unreadAnnouncements').textContent = unreadCount;
            
            if (unreadCount > 0) {
                document.getElementById('unreadAnnouncements').style.display = 'inline-block';
                document.getElementById('unreadBadge').style.display = 'inline-block';
                document.getElementById('requestCount').style.display = 'inline-block';
                document.getElementById('requestCount').textContent = unreadCount;
            } else {
                document.getElementById('unreadAnnouncements').style.display = 'none';
                document.getElementById('unreadBadge').style.display = 'none';
                document.getElementById('requestCount').style.display = 'none';
            }
        }

        // ===== ADMIN BROADCAST FUNCTIONS =====
        function loadUserCheckboxes() {
            const container = document.getElementById('userCheckboxes');
            container.innerHTML = '';
            
            allUsers.forEach(user => {
                const div = document.createElement('div');
                div.className = 'user-checkbox';
                div.innerHTML = `
                    <input type="checkbox" id="user_${user.username}" value="${user.username}">
                    <label for="user_${user.username}">${user.name} (RC: ${user.RCNo})</label>
                `;
                container.appendChild(div);
            });
        }

        function createBroadcast() {
            const type = document.getElementById('broadcastType').value;
            const title = document.getElementById('broadcastTitle').value;
            const content = document.getElementById('broadcastContent').value;
            const priority = document.getElementById('broadcastPriority').value;
            const expiry = document.getElementById('broadcastExpiry').value;
            const target = document.querySelector('input[name="target"]:checked').value;
            
            // Get target users/groups
            let targetUsers = [];
            let targetGroups = [];
            
            if (target === 'specific') {
                document.querySelectorAll('#userCheckboxes input:checked').forEach(cb => {
                    targetUsers.push(cb.value);
                });
            } else if (target === 'group') {
                document.querySelectorAll('#groupSelection input:checked').forEach(cb => {
                    targetGroups.push(cb.value);
                });
            }
            
            const broadcast = {
                id: 'broadcast_' + Date.now(),
                type: type,
                title: title,
                content: content,
                priority: priority,
                target: target,
                targetUsers: targetUsers,
                targetGroups: targetGroups,
                createdBy: currentUser.name,
                createdByUsername: currentUser.username,
                createdAt: new Date().toISOString(),
                status: 'published',
                readBy: [],
                expiryDate: expiry || null
            };
            
            // Add event-specific fields
            if (type === 'event') {
                broadcast.eventDate = document.getElementById('eventDate').value;
                broadcast.eventTime = document.getElementById('eventTime').value;
                broadcast.eventLocation = document.getElementById('eventLocation').value;
            }
            
            // Handle image upload
            if (type === 'banner') {
                const imageInput = document.getElementById('bannerImage');
                if (imageInput.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        broadcast.imageUrl = e.target.result;
                        saveBroadcastToSystem(broadcast);
                    };
                    reader.readAsDataURL(imageInput.files[0]);
                } else {
                    saveBroadcastToSystem(broadcast);
                }
            } else {
                saveBroadcastToSystem(broadcast);
            }
        }

        function saveBroadcastToSystem(broadcast) {
            broadcasts.push(broadcast);
            saveBroadcasts();
            
            showToast('Broadcast published successfully!');
            clearBroadcastForm();
            
            // Refresh views
            if (currentUser.level === 'Supervisor') {
                loadUserBroadcasts();
            }
        }

        function saveDraft() {
            const broadcast = {
                id: 'broadcast_' + Date.now(),
                type: document.getElementById('broadcastType').value,
                title: document.getElementById('broadcastTitle').value,
                content: document.getElementById('broadcastContent').value,
                priority: document.getElementById('broadcastPriority').value,
                target: document.querySelector('input[name="target"]:checked').value,
                createdBy: currentUser.name,
                createdAt: new Date().toISOString(),
                status: 'draft'
            };
            
            broadcasts.push(broadcast);
            saveBroadcasts();
            showToast('Draft saved successfully!');
        }

        function clearBroadcastForm() {
            document.getElementById('broadcastForm').reset();
            document.getElementById('bannerPreview').classList.remove('active');
            document.getElementById('bannerPreview').src = '';
            document.getElementById('specificUsers').classList.remove('active');
            document.getElementById('groupSelection').classList.remove('active');
        }

        function showBroadcastAdminTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('#adminBroadcastsSection .broadcast-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Update tab buttons
            document.querySelectorAll('#adminBroadcastsSection .broadcast-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + 'BroadcastsTab').classList.add('active');
            
            // Activate tab button
            document.querySelectorAll('#adminBroadcastsSection .broadcast-tab').forEach(btn => {
                if (btn.textContent.includes(tabName === 'create' ? 'Create' : 
                                             tabName === 'manage' ? 'Manage' : 'Analytics')) {
                    btn.classList.add('active');
                }
            });
            
            // Load data for tab
            if (tabName === 'manage') {
                loadActiveBroadcasts();
            } else if (tabName === 'analytics') {
                loadBroadcastAnalytics();
            }
        }

        function loadActiveBroadcasts() {
            const activeContainer = document.getElementById('activeBroadcasts');
            const draftContainer = document.getElementById('draftBroadcasts');
            
            const activeBroadcasts = broadcasts.filter(b => b.status === 'published');
            const draftBroadcasts = broadcasts.filter(b => b.status === 'draft');
            
            // Display active broadcasts
            activeContainer.innerHTML = '';
            if (activeBroadcasts.length === 0) {
                activeContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--gray);">No active broadcasts</div>';
            } else {
                activeBroadcasts.forEach(broadcast => {
                    const card = createBroadcastCard(broadcast);
                    activeContainer.appendChild(card);
                });
            }
            
            // Display draft broadcasts
            draftContainer.innerHTML = '';
            if (draftBroadcasts.length === 0) {
                draftContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--gray);">No draft broadcasts</div>';
            } else {
                draftBroadcasts.forEach(broadcast => {
                    const card = createBroadcastCard(broadcast, true);
                    draftContainer.appendChild(card);
                });
            }
        }

        function createBroadcastCard(broadcast, isDraft = false) {
            const card = document.createElement('div');
            card.className = `event-card priority-${broadcast.priority}`;
            
            // Calculate read rate
            const totalTarget = getTotalTargetCount(broadcast);
            const readCount = broadcast.readBy ? broadcast.readBy.length : 0;
            const readRate = totalTarget > 0 ? Math.round((readCount / totalTarget) * 100) : 0;
            
            card.innerHTML = `
                <div class="event-card-header">
                    <div class="event-card-title">
                        <div style="font-size: 12px; color: var(--gray); margin-bottom: 5px; text-transform: uppercase;">
                            ${broadcast.type} ‚Ä¢ ${broadcast.priority}
                        </div>
                        ${broadcast.title}
                    </div>
                    <div class="event-card-actions">
                        ${isDraft ? 
                            `<button class="event-card-action" onclick="publishDraft('${broadcast.id}')" title="Publish">üì§</button>` :
                            `<button class="event-card-action" onclick="editBroadcast('${broadcast.id}')" title="Edit">‚úèÔ∏è</button>`
                        }
                        <button class="event-card-action" onclick="deleteBroadcast('${broadcast.id}')" title="Delete">üóëÔ∏è</button>
                    </div>
                </div>
                <div class="event-card-content">${broadcast.content.substring(0, 120)}${broadcast.content.length > 120 ? '...' : ''}</div>
                <div class="event-card-meta">
                    <span>By: ${broadcast.createdBy}</span>
                    <span>${formatDate(broadcast.createdAt)}</span>
                </div>
                ${!isDraft ? `
                <div class="event-stats">
                    <div class="stat-item">
                        <span class="stat-icon">üëÅÔ∏è</span>
                        <span>${readCount}/${totalTarget} read</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-icon">üìà</span>
                        <span>${readRate}% read rate</span>
                    </div>
                </div>` : ''}
            `;
            
            return card;
        }

        function getTotalTargetCount(broadcast) {
            if (broadcast.target === 'all') return allUsers.length;
            if (broadcast.target === 'specific' && broadcast.targetUsers) return broadcast.targetUsers.length;
            if (broadcast.target === 'group' && broadcast.targetGroups) {
                // Count users in selected groups
                return allUsers.filter(user => {
                    const userGroup = getUserGroup(user.username);
                    return broadcast.targetGroups.includes(userGroup);
                }).length;
            }
            return 0;
        }

        function publishDraft(broadcastId) {
            const broadcast = broadcasts.find(b => b.id === broadcastId);
            if (broadcast) {
                broadcast.status = 'published';
                saveBroadcasts();
                loadActiveBroadcasts();
                showToast('Broadcast published!');
            }
        }

        function editBroadcast(broadcastId) {
            const broadcast = broadcasts.find(b => b.id === broadcastId);
            if (!broadcast) return;
            
            // Populate form
            document.getElementById('broadcastType').value = broadcast.type;
            document.getElementById('broadcastTitle').value = broadcast.title;
            document.getElementById('broadcastContent').value = broadcast.content;
            document.getElementById('broadcastPriority').value = broadcast.priority;
            document.getElementById('broadcastExpiry').value = broadcast.expiryDate || '';
            
            // Trigger change events
            document.getElementById('broadcastType').dispatchEvent(new Event('change'));
            
            // Show create tab
            showBroadcastAdminTab('create');
            
            // Scroll to form
            document.getElementById('createBroadcastTab').scrollIntoView({behavior: 'smooth'});
        }

        function deleteBroadcast(broadcastId) {
            if (confirm('Are you sure you want to delete this broadcast?')) {
                broadcasts = broadcasts.filter(b => b.id !== broadcastId);
                saveBroadcasts();
                loadActiveBroadcasts();
                showToast('Broadcast deleted');
            }
        }

        function loadBroadcastAnalytics() {
            const total = broadcasts.filter(b => b.status === 'published').length;
            const active = broadcasts.filter(b => 
                b.status === 'published' && 
                (!b.expiryDate || new Date(b.expiryDate) > new Date())
            ).length;
            
            // Calculate average read rate
            let totalReadRate = 0;
            let count = 0;
            
            broadcasts.forEach(b => {
                if (b.status === 'published') {
                    const targetCount = getTotalTargetCount(b);
                    const readCount = b.readBy ? b.readBy.length : 0;
                    if (targetCount > 0) {
                        totalReadRate += (readCount / targetCount) * 100;
                        count++;
                    }
                }
            });
            
            const avgReadRate = count > 0 ? Math.round(totalReadRate / count) : 0;
            
            // Update display
            document.getElementById('totalBroadcasts').textContent = total;
            document.getElementById('activeBroadcastsCount').textContent = active;
            document.getElementById('avgReadRate').textContent = avgReadRate + '%';
            document.getElementById('userEngagement').textContent = count;
            
            // Render simple chart
            renderBroadcastChart();
        }

        function renderBroadcastChart() {
            const container = document.getElementById('broadcastChart');
            
            // Get last 7 days data
            const last7Days = Array.from({length: 7}, (_, i) => {
                const date = new Date();
                date.setDate(date.getDate() - i);
                return date.toISOString().split('T')[0];
            }).reverse();
            
            const data = last7Days.map(date => {
                return broadcasts.filter(b => 
                    b.createdAt.startsWith(date) && b.status === 'published'
                ).length;
            });
            
            const maxData = Math.max(...data, 1);
            const chartHeight = 150;
            
            let html = '<div style="display: flex; align-items: flex-end; height: 100%; gap: 12px; justify-content: center;">';
            
            data.forEach((value, index) => {
                const height = (value / maxData) * chartHeight;
                const date = new Date(last7Days[index]);
                const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                
                html += `
                    <div style="display: flex; flex-direction: column; align-items: center; height: 100%;">
                        <div style="width: 25px; height: ${height}px; background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); border-radius: 6px 6px 0 0; transition: all 0.3s;"></div>
                        <div style="font-size: 11px; margin-top: 8px; color: var(--gray); font-weight: 600;">${dayName}</div>
                        <div style="font-size: 10px; color: var(--gray); margin-top: 4px;">${value}</div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        // ===== UTILITY FUNCTIONS =====
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('data-section') === sectionId) {
                    item.classList.add('active');
                }
            });
            
            // Update bottom nav
            document.querySelectorAll('.bottom-nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('data-section') === sectionId) {
                    item.classList.add('active');
                }
            });
            
            // Show selected section
            const section = document.getElementById(sectionId + 'Section');
            if (section) {
                section.classList.add('active');
                
                // Scroll to top
                window.scrollTo(0, 0);
                
                // Load section data
                switch(sectionId) {
                    case 'home':
                        loadMobileDashboard();
                        break;
                    case 'announcements':
                        loadAnnouncementsPage();
                        break;
                    case 'adminBroadcasts':
                        loadAdminBroadcasts();
                        break;
                    case 'dutyChange':
                        loadDutyChangeForm();
                        break;
                    case 'leaveApplication':
                        loadLeaveForm();
                        break;
                    case 'myRequests':
                        loadMyRequests();
                        break;
                    case 'viewMyRoster':
                        loadMyRoster();
                        break;
                    case 'pendingRequests':
                        loadPendingRequests();
                        break;
                }
            }
        }

        function setupNavigation() {
            // Bottom nav click handlers
            document.querySelectorAll('.bottom-nav-item').forEach(btn => {
                btn.addEventListener('click', function() {
                    const sectionId = this.getAttribute('data-section');
                    showSection(sectionId);
                });
            });
        }

        function updateDashboard() {
            if (!currentUser) return;
            
            // Update today's duty
            const today = new Date().toISOString().split('T')[0];
            if (dutyRoster[today] && dutyRoster[today][currentUser.username]) {
                const duty = dutyRoster[today][currentUser.username];
                document.getElementById('todayDutyTime').textContent = duty === 'Off' ? 'Off Duty' : duty;
            } else {
                document.getElementById('todayDutyTime').textContent = 'Not Scheduled';
            }
            
            // Find next duty
            const tomorrow = new Date();
            for (let i = 1; i <= 7; i++) {
                tomorrow.setDate(tomorrow.getDate() + 1);
                const dateStr = tomorrow.toISOString().split('T')[0];
                if (dutyRoster[dateStr] && dutyRoster[dateStr][currentUser.username]) {
                    const duty = dutyRoster[dateStr][currentUser.username];
                    if (duty !== 'Off') {
                        document.getElementById('nextDutyTime').textContent = `${formatDate(dateStr)}: ${duty}`;
                        break;
                    }
                }
            }
            
            // Update balance
            updateUserBalance();
            
            // Update duty days count
            updateDutyDaysCount();
        }

        function updateUserBalance() {
            if (!currentUser) return;
            
            const balance = leaveBalances[currentUser.username] || {SL: 0, FRL: 0};
            document.getElementById('slBalance').textContent = balance.SL.toFixed(1);
            document.getElementById('frlBalance').textContent = balance.FRL.toFixed(1);
        }

        function updateDutyDaysCount() {
            if (!currentUser) return;
            
            const today = new Date().toISOString().split('T')[0];
            const thisMonth = today.substring(0, 7);
            let dutyDays = 0;
            
            for (const date in dutyRoster) {
                if (date.startsWith(thisMonth) && dutyRoster[date][currentUser.username] && dutyRoster[date][currentUser.username] !== 'Off') {
                    dutyDays++;
                }
            }
            
            document.getElementById('dutyDays').textContent = dutyDays;
        }

        function loadMobileDashboard() {
            updateDashboard();
            loadRecentActivity();
        }

        function loadRecentActivity() {
            const container = document.getElementById('recentActivity');
            if (!currentUser) return;
            
            const userReqs = allRequests
                .filter(req => req.fromUsername === currentUser.username)
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .slice(0, 5);
            
            if (userReqs.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <p>No recent activity</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="announcement-list">';
            userReqs.forEach(req => {
                const timeAgo = formatTimeAgo(req.timestamp);
                
                html += `
                    <div class="announcement-item" style="cursor: default;">
                        <div class="announcement-icon" style="background: ${req.type === 'dutyChange' ? 'linear-gradient(135deg, var(--primary-color), var(--primary-dark))' : 'linear-gradient(135deg, var(--success-color), var(--success-dark))'}">
                            ${req.type === 'dutyChange' ? 'üîÑ' : 'üìù'}
                        </div>
                        <div class="announcement-content">
                            <div class="announcement-title">
                                ${req.type === 'dutyChange' ? 'Duty Change Request' : 'Leave Application'}
                                <span class="announcement-priority priority-${req.status === 'approved' ? 'low' : req.status === 'pending' ? 'medium' : 'high'}">
                                    ${req.status}
                                </span>
                            </div>
                            <div class="announcement-text">
                                ${req.type === 'dutyChange' ? 
                                    `Swap with ${req.toName || 'another staff'}` : 
                                    `${req.leaveType} - ${req.duration} day(s)`}
                            </div>
                            <div class="announcement-meta">
                                <span>${req.date}</span>
                                <span>${timeAgo}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        function loadAnnouncementsPage() {
            const container = document.getElementById('announcementsList');
            let html = '';
            
            userBroadcasts.forEach(broadcast => {
                const isRead = isBroadcastRead(broadcast.id);
                const priorityClass = `priority-${broadcast.priority}`;
                const icon = broadcast.type === 'event' ? 'üìÖ' : 
                            broadcast.type === 'banner' ? 'üñºÔ∏è' : 
                            broadcast.type === 'notice' ? 'üìã' : 'üì¢';
                
                html += `
                    <div class="announcement-item" onclick="showBroadcastModal('${broadcast.id}')">
                        <div class="announcement-icon">
                            ${icon}
                        </div>
                        <div class="announcement-content">
                            <div class="announcement-title">
                                ${broadcast.title}
                                <span class="announcement-priority ${priorityClass}">${broadcast.priority}</span>
                                ${!isRead ? '<span class="read-status unread"></span>' : ''}
                            </div>
                            <div class="announcement-text">${broadcast.content.substring(0, 120)}${broadcast.content.length > 120 ? '...' : ''}</div>
                            <div class="announcement-meta">
                                <span>${formatDate(broadcast.createdAt)}</span>
                                <span>From: ${broadcast.createdBy}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            if (userBroadcasts.length === 0) {
                html = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì¢</div>
                        <p>No announcements available</p>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        function loadAdminBroadcasts() {
            showBroadcastAdminTab('create');
            loadUserCheckboxes();
        }

        function showEventDetails(eventId) {
            const event = broadcasts.find(b => b.id === eventId);
            if (event) {
                showBroadcastModal(event);
            }
        }

        function showBroadcastTab(tab) {
            // Filter announcements based on tab
            const container = document.getElementById('announcementsList');
            let filteredBroadcasts = userBroadcasts;
            
            switch(tab) {
                case 'unread':
                    filteredBroadcasts = userBroadcasts.filter(b => !isBroadcastRead(b.id));
                    break;
                case 'important':
                    filteredBroadcasts = userBroadcasts.filter(b => b.priority === 'high');
                    break;
                case 'events':
                    filteredBroadcasts = userBroadcasts.filter(b => b.type === 'event');
                    break;
            }
            
            // Update tab buttons
            document.querySelectorAll('.broadcast-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Render filtered list
            let html = '';
            filteredBroadcasts.forEach(broadcast => {
                const isRead = isBroadcastRead(broadcast.id);
                const priorityClass = `priority-${broadcast.priority}`;
                const icon = broadcast.type === 'event' ? 'üìÖ' : 
                            broadcast.type === 'banner' ? 'üñºÔ∏è' : 
                            broadcast.type === 'notice' ? 'üìã' : 'üì¢';
                
                html += `
                    <div class="announcement-item" onclick="showBroadcastModal('${broadcast.id}')">
                        <div class="announcement-icon">
                            ${icon}
                        </div>
                        <div class="announcement-content">
                            <div class="announcement-title">
                                ${broadcast.title}
                                <span class="announcement-priority ${priorityClass}">${broadcast.priority}</span>
                                ${!isRead ? '<span class="read-status unread"></span>' : ''}
                            </div>
                            <div class="announcement-text">${broadcast.content.substring(0, 120)}${broadcast.content.length > 120 ? '...' : ''}</div>
                            <div class="announcement-meta">
                                <span>${formatDate(broadcast.createdAt)}</span>
                                <span>From: ${broadcast.createdBy}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            if (filteredBroadcasts.length === 0) {
                html = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <p>No ${tab} announcements</p>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        // ===== DUTY ROSTER FUNCTIONS =====
        function loadMyRoster() {
            if (!currentUser) return;
            
            const month = document.getElementById('myRosterMonth').value;
            const viewType = document.getElementById('myRosterViewType').value;
            const container = document.getElementById('myRosterContainer');
            
            if (!month) {
                container.innerHTML = '<div class="alert alert-warning">Please select a month</div>';
                return;
            }
            
            // Parse month
            const [year, monthNum] = month.split('-');
            const startDate = new Date(year, monthNum - 1, 1);
            const endDate = new Date(year, monthNum, 0);
            
            // Filter roster for selected month
            const monthRoster = {};
            for (const date in dutyRoster) {
                const rosterDate = new Date(date);
                if (rosterDate >= startDate && rosterDate <= endDate) {
                    if (dutyRoster[date][currentUser.username]) {
                        monthRoster[date] = dutyRoster[date][currentUser.username];
                    }
                }
            }
            
            // Display roster
            if (Object.keys(monthRoster).length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÖ</div>
                        <p>No roster data found for ${formatDate(startDate.toISOString())}</p>
                    </div>
                `;
                return;
            }
            
            if (viewType === 'calendar') {
                displayCalendarView(monthRoster, year, monthNum - 1);
            } else {
                displayTableView(monthRoster);
            }
        }

        function displayTableView(monthRoster) {
            const container = document.getElementById('myRosterContainer');
            let html = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Day</th>
                                <th>Duty Time</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // Sort dates
            const sortedDates = Object.keys(monthRoster).sort();
            
            sortedDates.forEach(date => {
                const duty = monthRoster[date];
                const dateObj = new Date(date);
                const dayName = dateObj.toLocaleDateString('en-US', { weekday: 'short' });
                const isToday = date === new Date().toISOString().split('T')[0];
                const isPast = new Date(date) < new Date();
                
                let statusClass = 'status-approved';
                let statusText = 'Scheduled';
                
                if (duty === 'Off') {
                    statusClass = 'status-pending';
                    statusText = 'Off Duty';
                } else if (isPast) {
                    statusClass = 'status-rejected';
                    statusText = 'Completed';
                } else if (isToday) {
                    statusClass = 'status-approved';
                    statusText = 'Today';
                }
                
                html += `
                    <tr>
                        <td><strong>${formatDate(date)}</strong></td>
                        <td>${dayName}</td>
                        <td>${duty}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
        }

        function displayCalendarView(monthRoster, year, month) {
            const container = document.getElementById('myRosterContainer');
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            
            let html = '<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-top: 20px;">';
            
            // Day headers
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                html += `<div style="text-align: center; font-weight: 600; color: var(--gray); padding: 10px;">${day}</div>`;
            });
            
            // Empty cells for days before first day
            const startDay = firstDay.getDay();
            for (let i = 0; i < startDay; i++) {
                html += '<div style="min-height: 80px;"></div>';
            }
            
            // Calendar days
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const duty = monthRoster[dateStr] || 'N/A';
                const dateObj = new Date(dateStr);
                const isToday = dateStr === new Date().toISOString().split('T')[0];
                
                let cellClass = '';
                let dutyColor = 'var(--gray)';
                
                if (duty === 'Off') {
                    cellClass = 'style="background: linear-gradient(135deg, #f8f9fa, #e9ecef);"';
                } else if (duty !== 'N/A') {
                    cellClass = 'style="background: linear-gradient(135deg, #e8f4fc, #d1ecf1);"';
                    dutyColor = 'var(--primary-color)';
                }
                
                if (isToday) {
                    cellClass = 'style="background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); color: white;"';
                    dutyColor = 'white';
                }
                
                html += `
                    <div ${cellClass} style="border-radius: 8px; padding: 10px; min-height: 80px; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 1px solid var(--gray-light);">
                        <div style="font-weight: ${isToday ? '700' : '600'}; margin-bottom: 5px; color: ${isToday ? 'white' : 'var(--secondary-color)'}">${day}</div>
                        <div style="font-size: 11px; text-align: center; color: ${dutyColor};">${duty}</div>
                    </div>
                `;
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        // ===== DUTY CHANGE & LEAVE FUNCTIONS =====
        function loadDutyChangeForm() {
            if (!currentUser) return;
            
            // Populate staff dropdown
            const staffSelect = document.getElementById('requestToStaff');
            staffSelect.innerHTML = '<option value="">Select staff member</option>';
            
            allUsers
                .filter(user => user.username !== currentUser.username)
                .forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.username;
                    option.textContent = `${user.name} (RC: ${user.RCNo})`;
                    staffSelect.appendChild(option);
                });
            
            // Set minimum date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('changeDate').min = tomorrow.toISOString().split('T')[0];
            document.getElementById('changeDate').value = tomorrow.toISOString().split('T')[0];
            
            // Load user's duty times
            loadUserDutyTimes('changeDutyTime', tomorrow.toISOString().split('T')[0]);
        }

        function loadLeaveForm() {
            // Set minimum date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('leaveDate').min = today;
            document.getElementById('leaveDate').value = today;
            
            // Load user's duty times
            loadUserDutyTimes('leaveDutyTime', today);
        }

        function loadMyRequests() {
            if (!currentUser) return;
            
            const container = document.getElementById('myRequestsMobile');
            const userRequests = allRequests
                .filter(req => req.fromUsername === currentUser.username)
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            if (userRequests.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <p>No requests found</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="announcement-list">';
            userRequests.forEach(req => {
                const timeAgo = formatTimeAgo(req.timestamp);
                const icon = req.type === 'dutyChange' ? 'üîÑ' : 'üìù';
                const bgColor = req.type === 'dutyChange' ? 
                    'linear-gradient(135deg, var(--primary-color), var(--primary-dark))' : 
                    'linear-gradient(135deg, var(--success-color), var(--success-dark))';
                
                html += `
                    <div class="announcement-item">
                        <div class="announcement-icon" style="background: ${bgColor}">
                            ${icon}
                        </div>
                        <div class="announcement-content">
                            <div class="announcement-title">
                                ${req.type === 'dutyChange' ? 'Duty Change' : 'Leave Application'}
                                <span class="announcement-priority priority-${req.status === 'approved' ? 'low' : req.status === 'pending' ? 'medium' : 'high'}">
                                    ${req.status}
                                </span>
                            </div>
                            <div class="announcement-text">
                                ${req.type === 'dutyChange' ? 
                                    `Swap duty on ${req.date}` : 
                                    `${req.leaveType} on ${req.date}`}
                            </div>
                            <div class="announcement-meta">
                                <span>${req.date}</span>
                                <span>${timeAgo}</span>
                                ${req.reason ? `<span style="color: var(--gray);">Reason: ${req.reason.substring(0, 30)}...</span>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        function loadPendingRequests() {
            if (!currentUser || currentUser.level !== 'Supervisor') return;
            
            const container = document.getElementById('pendingRequestsMobile');
            const pendingRequests = allRequests
                .filter(req => req.status === 'pending' && req.toUsername === currentUser.username)
                .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            
            if (pendingRequests.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚è∞</div>
                        <p>No pending requests</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="announcement-list">';
            pendingRequests.forEach(req => {
                const fromUser = allUsers.find(u => u.username === req.fromUsername);
                const timeAgo = formatTimeAgo(req.timestamp);
                
                html += `
                    <div class="announcement-item">
                        <div class="announcement-icon" style="background: linear-gradient(135deg, var(--warning-color), var(--warning-dark))">
                            ‚è∞
                        </div>
                        <div class="announcement-content">
                            <div class="announcement-title">
                                ${req.type === 'dutyChange' ? 'Duty Change Request' : 'Leave Application'}
                                <span class="announcement-priority priority-medium">
                                    Pending
                                </span>
                            </div>
                            <div class="announcement-text">
                                From: ${fromUser ? fromUser.name : req.fromUsername}
                                ${req.type === 'dutyChange' ? 
                                    `<br>Date: ${req.date}` : 
                                    `<br>Leave Type: ${req.leaveType}`}
                            </div>
                            <div class="announcement-meta">
                                <span>${req.date}</span>
                                <span>${timeAgo}</span>
                            </div>
                            <div class="action-buttons" style="margin-top: 10px;">
                                <button class="action-btn approve" onclick="approveRequest('${req.id}')">Approve</button>
                                <button class="action-btn reject" onclick="rejectRequest('${req.id}')">Reject</button>
                                <button class="action-btn view" onclick="viewRequestDetails('${req.id}')">View</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        function submitDutyChange() {
            if (!currentUser) return;
            
            const changeDate = document.getElementById('changeDate').value;
            const changeDutyTime = document.getElementById('changeDutyTime').value;
            const requestToStaff = document.getElementById('requestToStaff').value;
            const requestToDutyTime = document.getElementById('requestToDutyTime').value;
            const changeReason = document.getElementById('changeReason').value;
            
            if (!changeDate || !changeDutyTime || !requestToStaff || !requestToDutyTime) {
                showToast('Please fill all required fields');
                return;
            }
            
            const toUser = allUsers.find(u => u.username === requestToStaff);
            
            const request = {
                id: 'req_' + Date.now(),
                type: 'dutyChange',
                fromUsername: currentUser.username,
                fromName: currentUser.name,
                toUsername: toUser.username,
                toName: toUser.name,
                date: changeDate,
                fromDutyTime: changeDutyTime,
                toDutyTime: requestToDutyTime,
                reason: changeReason,
                status: 'pending',
                timestamp: new Date().toISOString()
            };
            
            allRequests.push(request);
            saveAllRequests();
            updateRequestCounts();
            
            showToast('Duty change request submitted!');
            showSection('home');
            
            // Reset form
            document.getElementById('dutyChangeForm').reset();
        }

        function submitLeaveApplication() {
            if (!currentUser) return;
            
            const leaveType = document.getElementById('leaveType').value;
            const leaveDate = document.getElementById('leaveDate').value;
            const leaveDutyTime = document.getElementById('leaveDutyTime').value;
            const leaveDuration = document.getElementById('leaveDuration').value;
            const leaveReason = document.getElementById('leaveReason').value;
            
            if (!leaveType || !leaveDate || !leaveDutyTime || !leaveDuration || !leaveReason) {
                showToast('Please fill all required fields');
                return;
            }
            
            // Check leave balance
            const userBalance = leaveBalances[currentUser.username] || {SL: 0, FRL: 0};
            const leaveDays = parseFloat(leaveDuration);
            
            if (leaveType === 'Sick Leave' && userBalance.SL < leaveDays) {
                showToast(`Insufficient Sick Leave balance. Available: ${userBalance.SL} days`);
                return;
            }
            
            if (leaveType === 'FRL' && userBalance.FRL < leaveDays) {
                showToast(`Insufficient FRL balance. Available: ${userBalance.FRL} days`);
                return;
            }
            
            // Find supervisor
            const supervisor = allUsers.find(u => u.level === 'Supervisor');
            
            const request = {
                id: 'req_' + Date.now(),
                type: 'leave',
                fromUsername: currentUser.username,
                fromName: currentUser.name,
                toUsername: supervisor ? supervisor.username : 'admin',
                toName: supervisor ? supervisor.name : 'Admin',
                date: leaveDate,
                leaveType: leaveType,
                duration: leaveDuration,
                dutyTime: leaveDutyTime,
                reason: leaveReason,
                status: 'pending',
                timestamp: new Date().toISOString()
            };
            
            allRequests.push(request);
            saveAllRequests();
            updateRequestCounts();
            
            showToast('Leave application submitted!');
            showSection('home');
            
            // Reset form
            document.getElementById('leaveApplicationForm').reset();
        }

        function updateLeaveRules() {
            const leaveType = document.getElementById('leaveType').value;
            const leaveDate = document.getElementById('leaveDate').value;
            const leaveDutyTime = document.getElementById('leaveDutyTime').value;
            const rulesAlert = document.getElementById('leaveRulesAlert');
            
            if (!leaveType || !leaveDate || !leaveDutyTime) {
                rulesAlert.textContent = 'Select leave type, date and duty time to see rules';
                rulesAlert.className = 'alert';
                return;
            }
            
            const now = new Date();
            const leaveDateTime = new Date(`${leaveDate}T${leaveDutyTime.split('-')[0]}`);
            const hoursDiff = (leaveDateTime - now) / (1000 * 60 * 60);
            
            if (leaveType === 'Sick Leave') {
                if (hoursDiff < 2) {
                    rulesAlert.textContent = '‚ö†Ô∏è Sick Leave must be applied at least 2 hours before duty time!';
                    rulesAlert.className = 'alert alert-danger';
                } else {
                    rulesAlert.textContent = '‚úÖ Sick Leave application meets minimum 2-hour requirement';
                    rulesAlert.className = 'alert alert-success';
                }
            } else if (leaveType === 'FRL') {
                if (hoursDiff < 1) {
                    rulesAlert.textContent = '‚ö†Ô∏è FRL must be applied at least 1 hour before duty time!';
                    rulesAlert.className = 'alert alert-danger';
                } else {
                    rulesAlert.textContent = '‚úÖ FRL application meets minimum 1-hour requirement';
                    rulesAlert.className = 'alert alert-success';
                }
            }
        }

        function loadUserDutyTimes(selectId, date) {
            if (!currentUser) return;
            
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">Select duty time</option>';
            
            if (dutyRoster[date] && dutyRoster[date][currentUser.username]) {
                const duty = dutyRoster[date][currentUser.username];
                if (duty !== 'Off') {
                    const option = document.createElement('option');
                    option.value = duty;
                    option.textContent = duty;
                    select.appendChild(option);
                } else {
                    const option = document.createElement('option');
                    option.value = 'Off';
                    option.textContent = 'Off Duty (No shift scheduled)';
                    select.appendChild(option);
                }
            } else {
                // Sample duty times if no roster data
                const dutyTimes = ['08:00-16:00', '16:00-00:00', '00:00-08:00'];
                dutyTimes.forEach(time => {
                    const option = document.createElement('option');
                    option.value = time;
                    option.textContent = time;
                    select.appendChild(option);
                });
            }
        }

        function loadStaffDutyTimes(selectId, date, username) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">Select duty time</option>';
            
            if (dutyRoster[date] && dutyRoster[date][username]) {
                const duty = dutyRoster[date][username];
                if (duty !== 'Off') {
                    const option = document.createElement('option');
                    option.value = duty;
                    option.textContent = duty;
                    select.appendChild(option);
                } else {
                    const option = document.createElement('option');
                    option.value = 'Off';
                    option.textContent = 'Off Duty';
                    select.appendChild(option);
                }
            } else {
                // Sample duty times
                const dutyTimes = ['08:00-16:00', '16:00-00:00', '00:00-08:00'];
                dutyTimes.forEach(time => {
                    const option = document.createElement('option');
                    option.value = time;
                    option.textContent = time;
                    select.appendChild(option);
                });
            }
        }

        function updateRequestCounts() {
            if (!currentUser) return;
            
            // Count pending requests for supervisor
            if (currentUser.level === 'Supervisor') {
                const pendingCount = allRequests.filter(req => 
                    req.status === 'pending' && req.toUsername === currentUser.username
                ).length;
                
                document.getElementById('pendingCount').textContent = pendingCount;
                document.getElementById('pendingCount').style.display = pendingCount > 0 ? 'inline-block' : 'none';
            }
        }

        function approveRequest(requestId) {
            const request = allRequests.find(req => req.id === requestId);
            if (request) {
                request.status = 'approved';
                request.approvedAt = new Date().toISOString();
                request.approvedBy = currentUser.username;
                
                // If it's a leave request, deduct from balance
                if (request.type === 'leave') {
                    const userBalance = leaveBalances[request.fromUsername] || {SL: 0, FRL: 0};
                    const leaveDays = parseFloat(request.duration);
                    
                    if (request.leaveType === 'Sick Leave') {
                        userBalance.SL = Math.max(0, userBalance.SL - leaveDays);
                    } else if (request.leaveType === 'FRL') {
                        userBalance.FRL = Math.max(0, userBalance.FRL - leaveDays);
                    }
                    
                    leaveBalances[request.fromUsername] = userBalance;
                    saveLeaveBalances();
                }
                
                saveAllRequests();
                loadPendingRequests();
                updateRequestCounts();
                showToast('Request approved!');
            }
        }

        function rejectRequest(requestId) {
            const request = allRequests.find(req => req.id === requestId);
            if (request) {
                request.status = 'rejected';
                request.rejectedAt = new Date().toISOString();
                request.rejectedBy = currentUser.username;
                saveAllRequests();
                loadPendingRequests();
                updateRequestCounts();
                showToast('Request rejected!');
            }
        }

        function viewRequestDetails(requestId) {
            const request = allRequests.find(req => req.id === requestId);
            if (request) {
                alert(`Request Details:\n\n` +
                      `Type: ${request.type}\n` +
                      `From: ${request.fromName}\n` +
                      `Date: ${request.date}\n` +
                      `Reason: ${request.reason || 'N/A'}\n` +
                      `Status: ${request.status}\n` +
                      `Submitted: ${formatTimeAgo(request.timestamp)}`);
            }
        }

        // ===== HELPER FUNCTIONS =====
        function getDateAfterDays(startDate, days) {
            const date = new Date(startDate);
            date.setDate(date.getDate() + days);
            return date.toISOString().split('T')[0];
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function formatTimeAgo(timestamp) {
            const now = new Date();
            const past = new Date(timestamp);
            const diffMs = now - past;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);
            
            if (diffMins < 1) return 'just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return formatDate(timestamp);
        }

        function showToast(message) {
            // Remove existing toast
            const existingToast = document.querySelector('.toast');
            if (existingToast) existingToast.remove();
            
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 3000);
        }

        function vibrate(duration = 50) {
            if ('vibrate' in navigator) {
                navigator.vibrate(duration);
            }
        }

        function updateOnlineStatus() {
            isOnline = navigator.onLine;
            const indicator = document.getElementById('offlineIndicator');
            if (!isOnline) {
                indicator.style.display = 'block';
                showToast('You are offline');
            } else {
                indicator.style.display = 'none';
                showToast('Back online');
            }
        }

        function showQuickActionMenu() {
            document.getElementById('quickActionModal').classList.add('active');
        }

        function hideQuickActionMenu() {
            document.getElementById('quickActionModal').classList.remove('active');
        }

        function refreshApp() {
            location.reload();
        }

        function refreshCurrentSection() {
            const currentSection = document.querySelector('.section.active').id;
            showSection(currentSection.replace('Section', ''));
            showToast('Refreshed');
        }

        function toggleDarkMode() {
            // This is a simple implementation
            // In production, you would use CSS variables and toggle a class
            showToast('Dark mode toggle coming soon');
        }

        function exportData() {
            const data = {
                dutyRoster,
                leaveBalances,
                allRequests,
                broadcasts,
                exportedAt: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `duty-system-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('Data exported successfully');
        }

        function clearCache() {
            if (confirm('Clear all local data? This will log you out.')) {
                localStorage.clear();
                location.reload();
            }
        }

        function showInstallPrompt() {
            // Show custom install prompt
            const prompt = document.createElement('div');
            prompt.className = 'alert alert-info';
            prompt.innerHTML = `
                <strong>Install App:</strong> Add to home screen for better experience
                <div style="margin-top: 10px; display: flex; gap: 10px;">
                    <button onclick="installApp()" class="btn btn-small btn-success">üì≤ Install</button>
                    <button onclick="this.parentElement.remove()" class="btn btn-small">Later</button>
                </div>
            `;
            document.getElementById('homeSection').prepend(prompt);
        }

        async function installApp() {
            // This would be handled by the beforeinstallprompt event
            showToast('Use browser menu to "Add to Home Screen"');
        }

        // Initialize the app
        window.onload = initApp;
    </script>
</body>
</html>
