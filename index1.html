<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Duty Management</title>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <!-- SHA-256 Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js"></script>
    
    <!-- External Firebase and User files -->
    <script src="dcfire.js" defer></script>
    <script src="user.js" defer></script>
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* MOBILE FIRST CSS - Optimized for mobile screens */
        :root {
            --primary-color: #3498db;
            --primary-dark: #2980b9;
            --secondary-color: #2c3e50;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --gray-color: #7f8c8d;
            --border-color: #e0e6ed;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            --radius: 12px;
            --radius-sm: 8px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        html {
            height: 100%;
            font-size: 16px;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.5;
            height: 100%;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Login Container - Mobile Optimized */
        .login-container {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 400px;
            padding: 30px 25px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            margin: 0;
        }
        
        .logo {
            text-align: center;
            margin-bottom: 25px;
        }
        
        .logo h1 {
            color: var(--secondary-color);
            font-size: 24px;
            margin-bottom: 5px;
            font-weight: 700;
        }
        
        .logo p {
            color: var(--gray-color);
            font-size: 14px;
        }
        
        .form-group {
            margin-bottom: 18px;
        }
        
        .form-group label {
            display: block;
            color: var(--secondary-color);
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .form-control {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 16px;
            transition: all 0.3s;
            background: white;
            -webkit-appearance: none;
            appearance: none;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        /* Buttons - Mobile Friendly */
        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            height: 50px;
            touch-action: manipulation;
        }
        
        .btn:active {
            transform: translateY(2px);
        }
        
        .btn-primary {
            background: var(--primary-color);
            color: white;
        }
        
        .btn-primary:active {
            background: var(--primary-dark);
        }
        
        .btn-success {
            background: var(--success-color);
            color: white;
        }
        
        .btn-danger {
            background: var(--danger-color);
            color: white;
        }
        
        .btn-warning {
            background: var(--warning-color);
            color: white;
        }
        
        .btn-secondary {
            background: var(--gray-color);
            color: white;
        }
        
        .btn-icon {
            width: 44px;
            height: 44px;
            padding: 0;
            border-radius: 50%;
            justify-content: center;
        }
        
        .btn-block {
            width: 100%;
        }
        
        /* Dashboard Container */
        .dashboard-container {
            display: none;
            width: 100%;
            min-height: 100vh;
            background: white;
            flex-direction: column;
        }
        
        /* Mobile Header */
        .dashboard-header {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            color: white;
            padding: 16px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .user-info h2 {
            font-size: 18px;
            margin-bottom: 4px;
            font-weight: 600;
        }
        
        .user-details {
            font-size: 12px;
            opacity: 0.9;
            display: flex;
            gap: 12px;
        }
        
        .menu-toggle {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            padding: 8px;
            cursor: pointer;
        }
        
        /* Mobile Navigation Drawer */
        .mobile-nav {
            position: fixed;
            top: 0;
            left: -280px;
            width: 280px;
            height: 100vh;
            background: white;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            transition: left 0.3s ease;
            overflow-y: auto;
            padding-top: 60px;
        }
        
        .mobile-nav.active {
            left: 0;
        }
        
        .nav-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }
        
        .nav-overlay.active {
            display: block;
        }
        
        .mobile-nav-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 10px;
        }
        
        .mobile-nav-header h3 {
            color: var(--secondary-color);
            font-size: 18px;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            text-decoration: none;
            color: var(--dark-color);
            transition: background 0.3s;
        }
        
        .nav-item:active {
            background: var(--light-color);
        }
        
        .nav-item i {
            width: 24px;
            margin-right: 12px;
            font-size: 18px;
            color: var(--primary-color);
        }
        
        .nav-item span {
            flex: 1;
            font-size: 16px;
        }
        
        .notification-badge {
            background: var(--danger-color);
            color: white;
            border-radius: 10px;
            padding: 2px 8px;
            font-size: 12px;
            min-width: 20px;
            text-align: center;
        }
        
        /* Bottom Navigation for Mobile */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }
        
        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px;
            text-decoration: none;
            color: var(--gray-color);
            flex: 1;
        }
        
        .bottom-nav-item.active {
            color: var(--primary-color);
        }
        
        .bottom-nav-item i {
            font-size: 20px;
            margin-bottom: 4px;
        }
        
        .bottom-nav-item span {
            font-size: 11px;
            text-align: center;
        }
        
        /* Content Area */
        .dashboard-content {
            flex: 1;
            padding: 20px 16px;
            padding-bottom: 70px; /* Space for bottom nav */
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .section {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .section.active {
            display: block;
        }
        
        /* Cards */
        .card {
            background: white;
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }
        
        .card h3 {
            color: var(--secondary-color);
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .card h3 i {
            font-size: 20px;
        }
        
        /* Quick Actions Grid */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 15px;
        }
        
        .action-card {
            background: white;
            border-radius: var(--radius-sm);
            padding: 16px;
            text-align: center;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            text-decoration: none;
            color: var(--dark-color);
            transition: transform 0.2s;
        }
        
        .action-card:active {
            transform: translateY(2px);
        }
        
        .action-card i {
            font-size: 24px;
            margin-bottom: 8px;
            color: var(--primary-color);
        }
        
        .action-card h4 {
            font-size: 14px;
            margin-bottom: 4px;
        }
        
        .action-card p {
            font-size: 12px;
            color: var(--gray-color);
        }
        
        /* Balance Display - Mobile */
        .balance-display {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin: 15px 0;
        }
        
        .balance-box {
            background: var(--light-color);
            padding: 16px;
            border-radius: var(--radius-sm);
            text-align: center;
            border: 2px solid var(--border-color);
        }
        
        .balance-value {
            font-size: 28px;
            font-weight: bold;
            color: var(--secondary-color);
            margin: 5px 0;
        }
        
        .balance-label {
            font-size: 12px;
            color: var(--gray-color);
            text-transform: uppercase;
        }
        
        /* Mobile Forms */
        .form-row {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-group-inline {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        select.form-control {
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 40px;
        }
        
        /* Mobile Tables */
        .table-container {
            overflow-x: auto;
            margin-top: 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            -webkit-overflow-scrolling: touch;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            min-width: 600px;
        }
        
        th, td {
            padding: 12px 10px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            font-size: 14px;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: var(--secondary-color);
            font-size: 13px;
            position: sticky;
            left: 0;
        }
        
        /* Mobile List Views */
        .list-view {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .list-item {
            background: white;
            border-radius: var(--radius-sm);
            padding: 16px;
            border: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .list-item-content {
            flex: 1;
        }
        
        .list-item-title {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .list-item-subtitle {
            font-size: 13px;
            color: var(--gray-color);
        }
        
        .list-item-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        /* Alerts */
        .alert {
            padding: 14px;
            border-radius: var(--radius-sm);
            margin-bottom: 15px;
            border-left: 4px solid;
            font-size: 14px;
        }
        
        .alert-info {
            background: #e8f4fc;
            border-color: var(--primary-color);
            color: var(--secondary-color);
        }
        
        .alert-success {
            background: #d4edda;
            border-color: var(--success-color);
            color: #155724;
        }
        
        .alert-warning {
            background: #fff3cd;
            border-color: var(--warning-color);
            color: #856404;
        }
        
        .alert-danger {
            background: #f8d7da;
            border-color: var(--danger-color);
            color: #721c24;
        }
        
        /* Mobile Tabs */
        .tab-controls {
            display: flex;
            overflow-x: auto;
            margin-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
            -webkit-overflow-scrolling: touch;
            gap: 5px;
        }
        
        .tab-btn {
            padding: 10px 16px;
            border: none;
            background: #f0f0f0;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .tab-btn.active {
            background: var(--primary-color);
            color: white;
        }
        
        /* Mobile Roster View */
        .roster-day {
            background: white;
            border-radius: var(--radius-sm);
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid var(--border-color);
        }
        
        .roster-day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .roster-date {
            font-weight: 600;
            color: var(--secondary-color);
        }
        
        .roster-duty {
            font-size: 14px;
            padding: 4px 10px;
            border-radius: 20px;
            background: var(--light-color);
        }
        
        /* Swipeable Content */
        .swipe-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scroll-snap-type: x mandatory;
        }
        
        .swipe-item {
            scroll-snap-align: start;
            min-width: 100%;
        }
        
        /* Loading States */
        .loading {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray-color);
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Pull to Refresh */
        .pull-to-refresh {
            position: absolute;
            top: -60px;
            left: 0;
            right: 0;
            text-align: center;
            padding: 20px;
            color: var(--gray-color);
        }
        
        /* Mobile Date Pickers */
        input[type="date"],
        input[type="month"] {
            min-height: 50px;
        }
        
        /* Announcements */
        .announcement-card {
            background: white;
            border-radius: var(--radius);
            padding: 18px;
            margin-bottom: 16px;
            border-left: 4px solid;
            box-shadow: var(--shadow);
        }
        
        .announcement-card.high {
            border-left-color: var(--danger-color);
            background: linear-gradient(135deg, #fff5f5, white);
        }
        
        .announcement-card.medium {
            border-left-color: var(--warning-color);
            background: linear-gradient(135deg, #fff9e6, white);
        }
        
        .announcement-card.low {
            border-left-color: var(--success-color);
            background: linear-gradient(135deg, #f0fff4, white);
        }
        
        .announcement-title {
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .announcement-content {
            font-size: 14px;
            margin-bottom: 12px;
            line-height: 1.5;
        }
        
        .announcement-meta {
            font-size: 12px;
            color: var(--gray-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* Status Badges */
        .status-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-approved {
            background: #d4edda;
            color: #155724;
        }
        
        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 8px 12px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .action-btn:active {
            transform: translateY(2px);
        }
        
        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray-color);
        }
        
        .empty-state i {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        /* Switches and Toggles */
        .switch {
            position: relative;
            display: inline-block;
            width: 52px;
            height: 26px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: var(--primary-color);
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        /* Search Bar */
        .search-bar {
            position: relative;
            margin-bottom: 16px;
        }
        
        .search-bar input {
            width: 100%;
            padding: 14px 16px 14px 44px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 16px;
        }
        
        .search-bar i {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-color);
        }
        
        /* Modal Overlay */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        
        .modal.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: white;
            border-radius: var(--radius);
            padding: 24px;
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            transform: translateY(20px);
            transition: transform 0.3s;
        }
        
        .modal.active .modal-content {
            transform: translateY(0);
        }
        
        /* Responsive Adjustments */
        @media (min-width: 768px) {
            .login-container {
                padding: 40px;
            }
            
            .quick-actions {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .form-row {
                flex-direction: row;
                flex-wrap: wrap;
            }
            
            .form-row .form-group {
                flex: 1;
                min-width: 200px;
            }
            
            .mobile-nav {
                display: none;
            }
            
            .bottom-nav {
                display: none;
            }
            
            .dashboard-content {
                padding-bottom: 20px;
            }
        }
        
        /* Print Styles */
        @media print {
            .bottom-nav,
            .dashboard-header,
            .btn {
                display: none !important;
            }
            
            .dashboard-content {
                padding: 0;
            }
            
            .card {
                box-shadow: none;
                border: 1px solid #000;
            }
        }
        
        /* High Contrast Mode */
        @media (prefers-contrast: high) {
            .btn {
                border: 2px solid currentColor;
            }
            
            .card {
                border: 2px solid currentColor;
            }
        }
        
        /* Reduced Motion */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <!-- Login Container -->
    <div class="login-container" id="loginContainer">
        <div class="logo">
            <h1>Duty Management</h1>
            <p>Secure Login System</p>
        </div>
        
        <form id="loginForm">
            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" class="form-control" placeholder="Enter username" required autofocus>
            </div>
            
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" class="form-control" placeholder="Enter password" required>
            </div>
            
            <button type="submit" class="btn btn-primary" id="loginBtn">
                <i class="fas fa-sign-in-alt"></i> Login
            </button>
            
            <div class="error-message" id="errorMessage">
                Invalid username or password
            </div>
        </form>
    </div>
    
    <!-- Dashboard Container -->
    <div class="dashboard-container" id="dashboardContainer">
        <!-- Mobile Header -->
        <div class="dashboard-header">
            <div class="header-top">
                <div class="user-info">
                    <h2 id="userName">User Name</h2>
                    <div class="user-details">
                        <span>RC: <span id="userRC">000</span></span>
                        <span>Level: <span id="userLevel">User</span></span>
                    </div>
                </div>
                <button class="menu-toggle" id="menuToggle">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </div>
        
        <!-- Mobile Navigation Drawer -->
        <div class="mobile-nav" id="mobileNav">
            <div class="mobile-nav-header">
                <h3>Navigation Menu</h3>
            </div>
            <a href="#" class="nav-item" data-section="home" onclick="showSection('home')">
                <i class="fas fa-home"></i>
                <span>Dashboard</span>
            </a>
            <a href="#" class="nav-item" data-section="dutyChange" onclick="showSection('dutyChange')">
                <i class="fas fa-exchange-alt"></i>
                <span>Duty Change</span>
            </a>
            <a href="#" class="nav-item" data-section="leaveApplication" onclick="showSection('leaveApplication')">
                <i class="fas fa-calendar-minus"></i>
                <span>Apply Leave</span>
            </a>
            <a href="#" class="nav-item" data-section="myRequests" onclick="showSection('myRequests')">
                <i class="fas fa-list"></i>
                <span>My Requests</span>
                <span class="notification-badge" id="mobileRequestCount">0</span>
            </a>
            <a href="#" class="nav-item" data-section="viewMyRoster" onclick="showSection('viewMyRoster')">
                <i class="fas fa-calendar-alt"></i>
                <span>My Roster</span>
            </a>
            <a href="#" class="nav-item" data-section="viewAllRoster" onclick="showSection('viewAllRoster')">
                <i class="fas fa-calendar-week"></i>
                <span>All Roster</span>
            </a>
            
            <!-- Admin Sections -->
            <div class="mobile-nav-header" id="adminNavHeader" style="display: none;">
                <h3>Admin</h3>
            </div>
            <a href="#" class="nav-item" data-section="pendingRequests" id="mobilePendingRequests" onclick="showSection('pendingRequests')" style="display: none;">
                <i class="fas fa-clock"></i>
                <span>Pending Requests</span>
                <span class="notification-badge" id="mobilePendingCount">0</span>
            </a>
            <a href="#" class="nav-item" data-section="adminAnnouncements" id="mobileAnnouncements" onclick="showSection('adminAnnouncements')" style="display: none;">
                <i class="fas fa-bullhorn"></i>
                <span>Announcements</span>
            </a>
            <a href="#" class="nav-item" data-section="adminDutyRoster" id="mobileDutyRoster" onclick="showSection('adminDutyRoster')" style="display: none;">
                <i class="fas fa-edit"></i>
                <span>Duty Roster</span>
            </a>
            <a href="#" class="nav-item" data-section="adminLeaveBalance" id="mobileLeaveBalance" onclick="showSection('adminLeaveBalance')" style="display: none;">
                <i class="fas fa-balance-scale"></i>
                <span>Leave Balance</span>
            </a>
            <a href="#" class="nav-item" data-section="adminApprovals" id="mobileApprovals" onclick="showSection('adminApprovals')" style="display: none;">
                <i class="fas fa-check-circle"></i>
                <span>Approvals</span>
            </a>
            
            <!-- Logout Button -->
            <div style="padding: 20px; border-top: 1px solid var(--border-color); margin-top: 20px;">
                <button class="btn btn-danger btn-block" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>
        
        <!-- Navigation Overlay -->
        <div class="nav-overlay" id="navOverlay"></div>
        
        <!-- Content Area -->
        <div class="dashboard-content">
            <!-- Dashboard -->
            <div class="section active" id="homeSection">
                <div id="homeAnnouncements">
                    <!-- Announcements will be loaded here -->
                </div>
                
                <div class="card">
                    <h3><i class="fas fa-tachometer-alt"></i> Dashboard</h3>
                    
                    <div class="balance-display">
                        <div class="balance-box">
                            <div class="balance-label">Sick Leave</div>
                            <div class="balance-value" id="slBalance">0</div>
                            <div class="balance-label">Days</div>
                        </div>
                        <div class="balance-box">
                            <div class="balance-label">FRL Balance</div>
                            <div class="balance-value" id="frlBalance">0</div>
                            <div class="balance-label">Days</div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <p><strong>Today's Duty:</strong> <span id="todayDutyTime">Not Scheduled</span></p>
                        <p><strong>Next Duty:</strong> <span id="nextDutyTime">No upcoming duty</span></p>
                        <div id="homeNotifications" style="margin-top: 10px; display: none;">
                            <!-- Notifications will appear here -->
                        </div>
                    </div>
                    
                    <h4 style="margin: 20px 0 10px 0;">Quick Actions</h4>
                    <div class="quick-actions">
                        <a href="#" class="action-card" onclick="showSection('dutyChange')">
                            <i class="fas fa-exchange-alt"></i>
                            <h4>Duty Change</h4>
                            <p>Request swap</p>
                        </a>
                        <a href="#" class="action-card" onclick="showSection('leaveApplication')">
                            <i class="fas fa-calendar-minus"></i>
                            <h4>Apply Leave</h4>
                            <p>Sick/FRL</p>
                        </a>
                        <a href="#" class="action-card" onclick="showSection('myRequests')">
                            <i class="fas fa-list"></i>
                            <h4>My Requests</h4>
                            <p>View status</p>
                        </a>
                        <a href="#" class="action-card" onclick="showSection('viewMyRoster')">
                            <i class="fas fa-calendar-alt"></i>
                            <h4>My Roster</h4>
                            <p>View schedule</p>
                        </a>
                        <a href="#" class="action-card" onclick="showSection('viewAllRoster')">
                            <i class="fas fa-calendar-week"></i>
                            <h4>All Roster</h4>
                            <p>Team schedule</p>
                        </a>
                        <a href="#" class="action-card" onclick="updateDashboard()">
                            <i class="fas fa-sync-alt"></i>
                            <h4>Refresh</h4>
                            <p>Update data</p>
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Duty Change Request -->
            <div class="section" id="dutyChangeSection">
                <div class="card">
                    <h3><i class="fas fa-exchange-alt"></i> Duty Change Request</h3>
                    
                    <div class="alert alert-warning">
                        <strong>Note:</strong> Requests must be made at least 24 hours in advance.
                    </div>
                    
                    <form id="dutyChangeForm">
                        <div class="form-group">
                            <label for="changeDate">Change Date *</label>
                            <input type="date" id="changeDate" class="form-control" required min="">
                        </div>
                        
                        <div class="form-group">
                            <label for="changeDutyTime">Your Duty Time *</label>
                            <select id="changeDutyTime" class="form-control" required>
                                <option value="">Select duty time</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="requestToStaff">Request To Staff *</label>
                            <select id="requestToStaff" class="form-control" required>
                                <option value="">Select staff member</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="requestToDutyTime">Staff's Duty Time *</label>
                            <select id="requestToDutyTime" class="form-control" required>
                                <option value="">Select duty time</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="changeReason">Reason (Optional)</label>
                            <textarea id="changeReason" class="form-control" rows="2" placeholder="Brief reason for duty change"></textarea>
                        </div>
                        
                        <div class="form-row" style="flex-direction: row; gap: 10px; margin-top: 20px;">
                            <button type="submit" class="btn btn-success" style="flex: 1;">
                                <i class="fas fa-paper-plane"></i> Submit
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="showSection('home')" style="flex: 1;">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Leave Application -->
            <div class="section" id="leaveApplicationSection">
                <div class="card">
                    <h3><i class="fas fa-calendar-minus"></i> Apply Leave</h3>
                    
                    <div class="alert alert-info">
                        <p><strong>Application Rules:</strong></p>
                        <p>• Sick Leave: 2+ hours before duty</p>
                        <p>• FRL: 1+ hour before duty</p>
                        <p>• No backdated applications</p>
                    </div>
                    
                    <form id="leaveApplicationForm">
                        <div class="form-group">
                            <label for="leaveType">Leave Type *</label>
                            <select id="leaveType" class="form-control" required>
                                <option value="">Select leave type</option>
                                <option value="Sick Leave">Sick Leave</option>
                                <option value="FRL">FRL</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="leaveDate">Leave Date *</label>
                            <input type="date" id="leaveDate" class="form-control" required min="">
                        </div>
                        
                        <div class="form-group">
                            <label for="leaveDutyTime">Duty Time *</label>
                            <select id="leaveDutyTime" class="form-control" required>
                                <option value="">Select duty time</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="leaveDuration">Duration *</label>
                            <select id="leaveDuration" class="form-control" required>
                                <option value="1">1 Day</option>
                                <option value="0.5">Half Day</option>
                                <option value="2">2 Days</option>
                                <option value="3">3 Days</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="leaveReason">Reason *</label>
                            <textarea id="leaveReason" class="form-control" rows="3" placeholder="Please provide reason for leave" required></textarea>
                        </div>
                        
                        <div class="alert" id="leaveRulesAlert">
                            Select leave type, date and duty time to see rules
                        </div>
                        
                        <div class="form-row" style="flex-direction: row; gap: 10px; margin-top: 20px;">
                            <button type="submit" class="btn btn-success" id="submitLeaveBtn" style="flex: 1;">
                                <i class="fas fa-paper-plane"></i> Submit
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="showSection('home')" style="flex: 1;">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- My Requests - Mobile Optimized -->
            <div class="section" id="myRequestsSection">
                <div class="card">
                    <h3><i class="fas fa-list"></i> My Requests</h3>
                    
                    <div class="search-bar">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchRequests" placeholder="Search requests...">
                    </div>
                    
                    <div class="list-view" id="myRequestsList">
                        <!-- Requests will be loaded here -->
                    </div>
                </div>
            </div>
            
            <!-- My Roster - Mobile View -->
            <div class="section" id="viewMyRosterSection">
                <div class="card">
                    <h3><i class="fas fa-calendar-alt"></i> My Roster</h3>
                    
                    <div class="form-row" style="flex-direction: row;">
                        <div class="form-group" style="flex: 2;">
                            <label for="myRosterMonth">Month</label>
                            <input type="month" id="myRosterMonth" class="form-control" value="">
                        </div>
                        <div class="form-group" style="flex: 1; margin-top: 25px;">
                            <button class="btn btn-primary" onclick="loadMyRoster()">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        Shows your scheduled duties. Changes via Duty Change.
                    </div>
                    
                    <div id="myRosterContainer" style="margin-top: 20px;">
                        <!-- Roster will be displayed here -->
                    </div>
                </div>
            </div>
            
            <!-- View All Roster - Mobile Optimized -->
            <div class="section" id="viewAllRosterSection">
                <div class="card">
                    <h3><i class="fas fa-calendar-week"></i> All Roster</h3>
                    
                    <div class="form-group">
                        <label for="allRosterStartDate">From Date</label>
                        <input type="date" id="allRosterStartDate" class="form-control" value="">
                    </div>
                    
                    <div class="form-group">
                        <label for="allRosterEndDate">To Date</label>
                        <input type="date" id="allRosterEndDate" class="form-control" value="">
                    </div>
                    
                    <div class="form-row" style="flex-direction: row; gap: 10px; margin-top: 10px;">
                        <button class="btn btn-primary" onclick="loadAllRoster()" style="flex: 1;">
                            <i class="fas fa-eye"></i> View
                        </button>
                        <button class="btn btn-secondary" onclick="printAllRoster()" style="flex: 1;">
                            <i class="fas fa-print"></i> Print
                        </button>
                    </div>
                    
                    <div class="alert alert-info">
                        Complete duty roster for all staff members.
                    </div>
                    
                    <div id="allRosterContainer" style="margin-top: 20px;">
                        <!-- Roster will be displayed here -->
                    </div>
                </div>
            </div>
            
            <!-- Pending Requests (Admin/User) -->
            <div class="section" id="pendingRequestsSection">
                <div class="card">
                    <h3><i class="fas fa-clock"></i> Pending Requests</h3>
                    
                    <div class="list-view" id="pendingRequestsList">
                        <!-- Pending requests will be loaded here -->
                    </div>
                </div>
            </div>
            
            <!-- Admin: Announcement Management -->
            <div class="section" id="adminAnnouncementsSection">
                <div class="card">
                    <h3><i class="fas fa-bullhorn"></i> Create Announcement</h3>
                    
                    <form id="announcementForm">
                        <div class="form-group">
                            <label for="announcementTitle">Title *</label>
                            <input type="text" id="announcementTitle" class="form-control" placeholder="Enter title" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="announcementContent">Content *</label>
                            <textarea id="announcementContent" class="form-control" rows="4" placeholder="Enter announcement details..." required></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>Priority *</label>
                            <div class="form-row" style="flex-direction: row;">
                                <button type="button" class="btn btn-danger" onclick="selectPriority('high')" style="flex: 1; margin: 2px;">High</button>
                                <button type="button" class="btn btn-warning" onclick="selectPriority('medium')" style="flex: 1; margin: 2px;">Medium</button>
                                <button type="button" class="btn btn-success" onclick="selectPriority('low')" style="flex: 1; margin: 2px;">Low</button>
                            </div>
                            <input type="hidden" id="announcementPriority" value="medium">
                        </div>
                        
                        <div class="form-group">
                            <label>Target Audience *</label>
                            <select id="announcementTarget" class="form-control" onchange="toggleStaffSelection()">
                                <option value="all">All Staff</option>
                                <option value="specific">Specific Staff</option>
                            </select>
                        </div>
                        
                        <div class="form-group" id="specificStaffGroup" style="display: none;">
                            <label for="announcementStaff">Select Staff</label>
                            <select id="announcementStaff" class="form-control" multiple style="height: 120px;">
                                <!-- Staff options will be loaded -->
                            </select>
                        </div>
                        
                        <div class="form-row" style="flex-direction: row; gap: 10px; margin-top: 20px;">
                            <button type="submit" class="btn btn-success" style="flex: 1;">
                                <i class="fas fa-plus"></i> Create
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="clearAnnouncementForm()" style="flex: 1;">
                                <i class="fas fa-times"></i> Clear
                            </button>
                        </div>
                    </form>
                </div>
                
                <div class="card">
                    <h3><i class="fas fa-bullhorn"></i> Active Announcements</h3>
                    <div id="activeAnnouncementsList">
                        <!-- Active announcements will be loaded here -->
                    </div>
                </div>
            </div>
            
            <!-- Other Admin Sections would follow similar mobile-optimized patterns -->
        </div>
        
        <!-- Bottom Navigation -->
        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <a href="#" class="bottom-nav-item active" data-section="home" onclick="showSection('home')">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </a>
            <a href="#" class="bottom-nav-item" data-section="dutyChange" onclick="showSection('dutyChange')">
                <i class="fas fa-exchange-alt"></i>
                <span>Change</span>
            </a>
            <a href="#" class="bottom-nav-item" data-section="leaveApplication" onclick="showSection('leaveApplication')">
                <i class="fas fa-calendar-minus"></i>
                <span>Leave</span>
            </a>
            <a href="#" class="bottom-nav-item" data-section="myRequests" onclick="showSection('myRequests')">
                <i class="fas fa-list"></i>
                <span>Requests</span>
                <span class="notification-badge" id="bottomRequestCount" style="position: absolute; top: 4px; right: 20px; font-size: 10px; padding: 1px 4px;">0</span>
            </a>
            <a href="#" class="bottom-nav-item" data-section="viewMyRoster" onclick="showSection('viewMyRoster')">
                <i class="fas fa-calendar-alt"></i>
                <span>Roster</span>
            </a>
        </div>
    </div>

    <!-- Modal for details -->
    <div class="modal" id="detailsModal">
        <div class="modal-content">
            <h3 id="modalTitle"></h3>
            <div id="modalContent"></div>
            <button class="btn btn-secondary btn-block" onclick="closeModal()" style="margin-top: 20px;">
                <i class="fas fa-times"></i> Close
            </button>
        </div>
    </div>

    <script>
// Mobile-First Responsive Duty Management System
// Global variables

// Add this at the beginning of your script
function checkFirebaseConnection() {
    console.log('Checking Firebase connection...');
    console.log('Firebase app name:', firebase.app().name);
    console.log('Firebase project ID:', firebase.app().options.projectId);
    
    // Test Firebase connection
    db.collection('test').doc('test').get()
        .then(() => console.log('Firebase connection successful'))
        .catch(error => console.error('Firebase connection failed:', error));
}

// Call this after Firebase is ready
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, checking Firebase...');
    
    // Check if Firebase and db are available
    if (typeof firebase === 'undefined') {
        console.error('Firebase SDK not loaded');
        return;
    }
    
    if (typeof db === 'undefined') {
        console.error('Firestore db not defined. Check dcfire.js');
        return;
    }
    
    // Test Firebase connection
    checkFirebaseConnection();
    
    // Rest of your initialization...
});


// Mobile-First Responsive Duty Management System
// Global variables
let currentUser = null;
let allUsers = [];
let dutyRoster = {};
let leaveBalances = {};
let allRequests = [];
let announcements = [];
let userDisplayNameMap = {};
let firebaseReady = false;

// Mobile menu toggle
function toggleMobileMenu() {
    const menuToggle = document.getElementById('menuToggle');
    const nav = document.getElementById('mobileNav');
    const overlay = document.getElementById('navOverlay');
    
    nav.classList.toggle('active');
    overlay.classList.toggle('active');
}

function closeMobileMenu() {
    const nav = document.getElementById('mobileNav');
    const overlay = document.getElementById('navOverlay');
    
    nav.classList.remove('active');
    overlay.classList.remove('active');
}

// Color mapping for duty times
const dutyTimeColorMap = {
    '0730-1530': 'duty-0730-1530',
    '0830-1630': 'duty-0830-1630',
    '1030-1830': 'duty-1030-1830',
    '1530-2330': 'duty-1530-2330',
    '1630-0030': 'duty-1630-0030',
    '1730-0130': 'duty-1730-0130',
    '0030-0830': 'duty-0030-0830',
    '0000-0800': 'duty-0000-0800',
    '0100-0900': 'duty-0100-0900',
    '0200-1000': 'duty-0200-1000',
    '0300-1100': 'duty-0300-1100',
    '0400-1200': 'duty-0400-1200',
    '0500-1300': 'duty-0500-1300',
    '0600-1400': 'duty-0600-1400',
    '0630-1430': 'duty-0630-1430',
    '0700-1500': 'duty-0700-1500',
    '0800-1600': 'duty-0800-1600',
    '1000-1800': 'duty-1000-1800',
    '1100-1900': 'duty-1100-1900',
    '1130-1930': 'duty-1130-1930',
    '1200-2000': 'duty-1200-2000',
    '1230-2030': 'duty-1230-2030',
    '1300-2100': 'duty-1300-2100',
    '1330-2130': 'duty-1330-2130',
    '1400-2200': 'duty-1400-2200',
    '1430-2230': 'duty-1430-2230',
    '1500-2300': 'duty-1500-2300',
    '1600-0000': 'duty-1600-0000',
    '1800-0200': 'duty-1800-0200',
    '1830-0230': 'duty-1830-0230',
    '1900-0300': 'duty-1900-0300',
    '1930-0330': 'duty-1930-0330',
    '2000-0400': 'duty-2000-0400',
    '2030-0430': 'duty-2030-0430',
    '2100-0500': 'duty-2100-0500',
    '2130-0530': 'duty-2130-0530',
    '2200-0600': 'duty-2200-0600',
    '2230-0630': 'duty-2230-0630',
    '2300-0700': 'duty-2300-0700',
    '2330-0730': 'duty-2330-0730',
    'mixed': 'duty-mixed',
    'special': 'duty-special',
    'leave': 'duty-leave'
};

// ========== DEBUGGING FUNCTIONS ==========
async function debugFirebase() {
    console.log('=== FIREBASE DEBUG ===');
    
    // Test 1: Simple write/read test
    console.log('\n1. Testing write/read permissions...');
    try {
        await db.collection('debug').doc('test').set({
            test: true,
            timestamp: new Date().toISOString()
        });
        console.log('✅ Write successful');
        
        const doc = await db.collection('debug').doc('test').get();
        console.log('✅ Read successful:', doc.data());
    } catch (error) {
        console.error('❌ Permission error:', error.message);
    }
    
    // Test 2: Check your specific collections
    console.log('\n2. Checking your collections...');
    const collections = ['dutyRoster', 'announcements', 'requests', 'leaveBalances'];
    
    for (const collectionName of collections) {
        console.log(`\nChecking ${collectionName}...`);
        try {
            const query = db.collection(collectionName);
            const snapshot = await query.limit(1).get();
            
            if (snapshot.empty) {
                console.log(`⚠️ ${collectionName} is empty`);
                
                // Try to get specific document
                const doc = await db.collection(collectionName).doc('current').get();
                if (!doc.exists) {
                    const doc2 = await db.collection(collectionName).doc('all').get();
                    console.log(`${collectionName}/all exists:`, doc2.exists);
                } else {
                    console.log(`${collectionName}/current exists:`, doc.exists);
                }
            } else {
                console.log(`✅ ${collectionName} has ${snapshot.size} documents`);
                snapshot.forEach(doc => {
                    console.log(`  Document ID: ${doc.id}`);
                    console.log(`  Data keys:`, Object.keys(doc.data()));
                });
            }
        } catch (error) {
            console.error(`❌ Error checking ${collectionName}:`, error.message);
        }
    }
    
    // Test 3: Create sample data if needed
    console.log('\n3. Creating sample data if needed...');
    await createSampleDataIfNeeded();
}

async function createSampleDataIfNeeded() {
    // Create sample announcements
    const announcementsRef = db.collection('announcements').doc('all');
    const announcementsDoc = await announcementsRef.get();
    
    if (!announcementsDoc.exists) {
        console.log('Creating sample announcements...');
        await announcementsRef.set({
            announcements: [
                {
                    id: '1',
                    title: 'Welcome to Duty Management System',
                    message: 'This is a test announcement. The system is now live!',
                    postedBy: 'Admin',
                    timestamp: new Date().toISOString(),
                    priority: 'high'
                },
                {
                    id: '2', 
                    title: 'System Maintenance',
                    message: 'The system will undergo maintenance tonight from 2-4 AM.',
                    postedBy: 'Admin',
                    timestamp: new Date().toISOString(),
                    priority: 'medium'
                }
            ]
        });
        console.log('✅ Sample announcements created');
    }
    
    // Create sample duty roster
    const rosterRef = db.collection('dutyRoster').doc('current');
    const rosterDoc = await rosterRef.get();
    
    if (!rosterDoc.exists) {
        console.log('Creating sample duty roster...');
        const today = new Date().toISOString().split('T')[0];
        const tomorrow = new Date(Date.now() + 86400000).toISOString().split('T')[0];
        
        const sampleRoster = {
            [today]: {
                'admin': '0730-1530',
                'user1': '0830-1630',
                'user2': '1030-1830'
            },
            [tomorrow]: {
                'admin': '1530-2330',
                'user1': '1630-0030',
                'user2': '0730-1530'
            }
        };
        
        await rosterRef.set(sampleRoster);
        console.log('✅ Sample duty roster created:', sampleRoster);
    }
    
    // Create sample leave balances
    const leaveRef = db.collection('leaveBalances').doc('current');
    const leaveDoc = await leaveRef.get();
    
    if (!leaveDoc.exists && users && Array.isArray(users)) {
        console.log('Creating sample leave balances...');
        const sampleBalances = {};
        
        users.forEach(user => {
            if (user.username) {
                sampleBalances[user.username] = {
                    SL: 12,
                    FRL: 6,
                    lastUpdated: new Date().toISOString()
                };
            }
        });
        
        await leaveRef.set(sampleBalances);
        console.log('✅ Sample leave balances created');
    }
}

async function checkFirebaseStructure() {
    console.log('=== CHECKING FIREBASE STRUCTURE ===');
    
    try {
        // Check what collections exist
        console.log('Listing all collections...');
        const collections = await db.listCollections();
        console.log('Available collections:', collections.map(c => c.id));
        
        // Check each collection
        for (const collection of collections) {
            console.log(`\nChecking collection: ${collection.id}`);
            
            // Get first few documents
            const snapshot = await collection.limit(3).get();
            console.log(`  Documents in ${collection.id}:`, snapshot.size);
            
            snapshot.forEach(doc => {
                console.log(`  Document ID: ${doc.id}`);
                const data = doc.data();
                console.log(`  Document has keys:`, Object.keys(data));
            });
        }
    } catch (error) {
        console.error('Error checking Firebase structure:', error);
    }
}
// ========== END DEBUGGING ==========

// Wait for Firebase and user data to load
document.addEventListener('DOMContentLoaded', function() {
    console.log('=== APP INITIALIZATION START ===');
    console.log('DOM fully loaded and parsed');
    
    // Check if Firebase is available
    if (typeof firebase === 'undefined') {
        console.error('Firebase SDK not loaded');
        showError('Firebase is not loaded. Please check your internet connection.');
        return;
    }
    
    if (typeof db === 'undefined') {
        console.error('Firestore db not defined. Check dcfire.js loading order.');
        showError('Database not initialized. Please refresh the page.');
        return;
    }
    
    console.log('Firebase and Firestore available');
    
    // Wait for user data to load
    let checkCount = 0;
    const maxChecks = 15;
    
    const checkDependencies = setInterval(() => {
        checkCount++;
        console.log(`Dependency check ${checkCount}/${maxChecks}:`);
        console.log('- Firebase:', typeof firebase !== 'undefined');
        console.log('- Firestore db:', typeof db !== 'undefined');
        console.log('- Users data:', typeof users !== 'undefined');
        console.log('- SHA256:', typeof sha256 !== 'undefined');
        
        // All dependencies loaded?
        if (typeof firebase !== 'undefined' && 
            typeof db !== 'undefined' && 
            typeof users !== 'undefined' &&
            typeof sha256 !== 'undefined') {
            
            console.log('✅ All dependencies loaded successfully!');
            clearInterval(checkDependencies);
            
            firebaseReady = true;
            setTimeout(initApp, 500);
            
        } else if (checkCount >= maxChecks) {
            console.error('❌ Failed to load all dependencies after maximum attempts');
            clearInterval(checkDependencies);
            
            // Show error to user
            showError('Failed to load required resources. Please refresh the page.');
            
            // Try to initialize anyway with what we have
            firebaseReady = true;
            setTimeout(initApp, 500);
        }
    }, 1000);
});

function initApp() {
    if (!firebaseReady) {
        console.log('Waiting for Firebase to be ready...');
        setTimeout(initApp, 500);
        return;
    }
    
    console.log('=== INIT APP START ===');
    
    // Setup mobile menu toggle
    const menuToggle = document.getElementById('menuToggle');
    if (menuToggle) {
        menuToggle.addEventListener('click', toggleMobileMenu);
        console.log('Menu toggle event listener added');
    } else {
        console.error('Menu toggle button not found!');
    }
    
    // Close menu when clicking on overlay
    const navOverlay = document.getElementById('navOverlay');
    if (navOverlay) {
        navOverlay.addEventListener('click', closeMobileMenu);
    }
    
    // Setup login form
    const loginForm = document.getElementById('loginForm');
    if (loginForm) {
        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            handleLogin();
        });
        console.log('Login form event listener added');
    }
    
    // Setup navigation items
    document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const section = this.getAttribute('data-section');
            if (section) {
                showSection(section);
                closeMobileMenu();
            }
        });
    });
    
    // Setup bottom navigation
    document.querySelectorAll('.bottom-nav-item').forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const section = this.getAttribute('data-section');
            if (section) {
                showSection(section);
            }
            
            // Update active state
            document.querySelectorAll('.bottom-nav-item').forEach(i => i.classList.remove('active'));
            this.classList.add('active');
        });
    });
    
    // Setup logout button
    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', function() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('dutySystemSession');
                location.reload();
            }
        });
    }
    
    // Set minimum dates
    const today = new Date().toISOString().split('T')[0];
    setMinimumDates(today);
    
    // Check session
    checkSession();
    
    console.log('=== INIT APP COMPLETE ===');
}

function setMinimumDates(today) {
    const dateInputs = [
        'changeDate', 'leaveDate', 'rosterDate', 'viewRosterDate',
        'allRosterStartDate', 'allRosterEndDate'
    ];
    
    dateInputs.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            if (id === 'allRosterStartDate') {
                element.value = today;
            } else if (id === 'allRosterEndDate') {
                element.value = getDateAfterDays(today, 7);
            } else if (id === 'changeDate' || id === 'leaveDate') {
                element.min = today;
                element.value = getDateAfterDays(today, 1);
            } else {
                element.value = today;
            }
        }
    });
    
    const myRosterMonth = document.getElementById('myRosterMonth');
    if (myRosterMonth) {
        myRosterMonth.value = today.substring(0, 7);
    }
}

function getDateAfterDays(startDate, days) {
    const date = new Date(startDate);
    date.setDate(date.getDate() + days);
    return date.toISOString().split('T')[0];
}

function checkSession() {
    const session = localStorage.getItem('dutySystemSession');
    if (session) {
        try {
            const user = JSON.parse(session);
            if (user.expiry > Date.now()) {
                console.log('Valid session found, auto-login');
                loginUser(user);
            } else {
                console.log('Session expired');
                localStorage.removeItem('dutySystemSession');
            }
        } catch (e) {
            console.error('Error parsing session:', e);
            localStorage.removeItem('dutySystemSession');
        }
    } else {
        console.log('No session found, showing login');
    }
}

function handleLogin() {
    try {
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value.trim();
        
        console.log('Login attempt for username:', username);
        
        if (!username || !password) {
            showError('Please enter both username and password');
            return;
        }
        
        if (!users || !Array.isArray(users)) {
            console.error('Users data is not properly loaded:', users);
            showError('User database not loaded. Please refresh the page.');
            return;
        }
        
        console.log('Total users in database:', users.length);
        
        const user = users.find(u => u.username === username);
        
        if (!user) {
            console.log('User not found:', username);
            showError('Invalid username or password');
            return;
        }
        
        console.log('User found:', user.username);
        
        // Hash and check password
        const hashedPassword = sha256(password);
        console.log('Password check - Input hash:', hashedPassword.substring(0, 10) + '...');
        console.log('Password check - Stored hash:', user.passwordHash?.substring(0, 10) + '...');
        
        if (hashedPassword === user.passwordHash) {
            const sessionData = {
                username: user.username,
                name: user.name,
                rcNo: user.RCNo,
                level: user.Level,
                expiry: Date.now() + (8 * 60 * 60 * 1000)
            };
            
            console.log('Login successful, creating session:', sessionData);
            
            localStorage.setItem('dutySystemSession', JSON.stringify(sessionData));
            loginUser(sessionData);
        } else {
            console.log('Password mismatch for user:', username);
            showError('Invalid username or password');
        }
    } catch (error) {
        console.error('Login error:', error);
        showError('An error occurred during login. Please try again.');
    }
}

function showError(message) {
    const errorMsg = document.getElementById('errorMessage');
    if (errorMsg) {
        errorMsg.textContent = message;
        errorMsg.style.display = 'block';
        
        // Auto hide error after 5 seconds
        setTimeout(() => {
            errorMsg.style.display = 'none';
        }, 5000);
    } else {
        console.error('Error (no error element):', message);
        alert(message);
    }
}

async function loginUser(userData) {
    try {
        console.log('=== LOGIN USER START ===');
        console.log('User data:', userData);
        
        currentUser = userData;
        allUsers = users || [];
        
        console.log('Current user set:', currentUser);
        console.log('Total users loaded:', allUsers.length);
        
        // Initialize user display name map
        initializeUserDisplayMap();
        
        // Update UI
        const loginContainer = document.getElementById('loginContainer');
        const dashboardContainer = document.getElementById('dashboardContainer');
        
        if (loginContainer) {
            loginContainer.style.display = 'none';
            console.log('Login container hidden');
        }
        
        if (dashboardContainer) {
            dashboardContainer.style.display = 'flex';
            console.log('Dashboard container shown');
        } else {
            console.error('Dashboard container not found!');
        }
        
        // Update user info
        updateUserInfo(userData);
        
        // Show/hide admin sections
        setupAdminSections();
        
        console.log('Checking Firebase structure...');
        await checkFirebaseStructure();
        
        console.log('Initializing data...');
        await initializeData();
        
        console.log('Setting up navigation and UI...');
        setupNavigation();
        setupEventListeners();
        updateDashboard();
        
        // Setup real-time listeners
        setTimeout(setupRealtimeListeners, 2000);
        
        console.log('=== LOGIN USER COMPLETE ===');
        
    } catch (error) {
        console.error('Error in loginUser:', error);
        alert('An error occurred during login: ' + error.message);
    }
}

function updateUserInfo(userData) {
    console.log('Updating user info:', userData);
    
    // Safely update all elements
    const elements = {
        'userName': userData.name,
        'userRC': userData.rcNo,
        'userLevel': userData.level
    };
    
    Object.keys(elements).forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.textContent = elements[id];
            console.log(`Updated #${id} to:`, elements[id]);
        } else {
            console.warn(`Element #${id} not found, skipping`);
        }
    });
}

function setupAdminSections() {
    console.log('Setting up admin sections for level:', currentUser?.level);
    
    const adminButtons = [
        'adminDutyRosterBtn',
        'adminLeaveBalanceBtn',
        'adminApprovalsBtn',
        'adminRequestHistoryBtn',
        'adminAnnouncementsBtn'
    ];
    
    const adminNavItems = [
        'mobilePendingRequests',
        'mobileAnnouncements',
        'mobileDutyRoster',
        'mobileLeaveBalance',
        'mobileApprovals'
    ];
    
    const adminNavHeader = document.getElementById('adminNavHeader');
    
    if (currentUser?.level === 'Supervisor') {
        console.log('User is Supervisor, showing admin sections');
        
        // Show admin buttons
        adminButtons.forEach(btnId => {
            const btn = document.getElementById(btnId);
            if (btn) {
                btn.style.display = 'inline-block';
            }
        });
        
        // Show admin nav items
        adminNavItems.forEach(itemId => {
            const item = document.getElementById(itemId);
            if (item) {
                item.style.display = 'flex';
            }
        });
        
        // Show admin nav header
        if (adminNavHeader) {
            adminNavHeader.style.display = 'block';
        }
    } else {
        console.log('User is not Supervisor, hiding admin sections');
        
        // Hide admin buttons
        adminButtons.forEach(btnId => {
            const btn = document.getElementById(btnId);
            if (btn) {
                btn.style.display = 'none';
            }
        });
        
        // Hide admin nav items
        adminNavItems.forEach(itemId => {
            const item = document.getElementById(itemId);
            if (item) {
                item.style.display = 'none';
            }
        });
        
        // Hide admin nav header
        if (adminNavHeader) {
            adminNavHeader.style.display = 'none';
        }
    }
    
    // Always show "View All Roster" button to all users
    const viewAllRosterBtn = document.getElementById('viewAllRosterBtn');
    if (viewAllRosterBtn) {
        viewAllRosterBtn.style.display = 'inline-block';
    }
}

function initializeUserDisplayMap() {
    console.log('Initializing user display name map');
    userDisplayNameMap = {};
    
    if (!allUsers || !Array.isArray(allUsers)) {
        console.error('allUsers is not an array:', allUsers);
        return;
    }
    
    allUsers.forEach(user => {
        if (user.username) {
            userDisplayNameMap[user.username] = user.username;
            
            if (user.name) {
                userDisplayNameMap[user.name] = user.username;
            }
            
            if (user.RCNo) {
                userDisplayNameMap[user.RCNo] = user.username;
            }
        }
    });
    
    console.log('User display map initialized with', Object.keys(userDisplayNameMap).length, 'entries');
}

// ========== FIREBASE FUNCTIONS ==========
async function loadDutyRoster() {
    console.log('🔍 Loading dutyRoster from: dutyRoster/current');
    
    try {
        const docRef = db.collection('dutyRoster').doc('current');
        console.log('Document reference created');
        
        const doc = await docRef.get();
        console.log('Document retrieved, exists:', doc.exists);
        
        if (doc.exists) {
            const data = doc.data();
            console.log('Raw data from Firebase:', data);
            
            if (data && typeof data === 'object') {
                dutyRoster = data;
                console.log('✅ Duty roster loaded successfully');
                console.log('Duty roster has dates:', Object.keys(dutyRoster).length);
                
                if (Object.keys(dutyRoster).length > 0) {
                    const firstDate = Object.keys(dutyRoster)[0];
                    console.log('Sample date:', firstDate);
                    console.log('Sample data:', dutyRoster[firstDate]);
                }
            } else {
                console.warn('⚠️ Duty roster data is not an object:', data);
                dutyRoster = {};
            }
        } else {
            console.warn('⚠️ dutyRoster/current document does not exist');
            console.log('Creating default empty duty roster...');
            dutyRoster = {};
            
            await docRef.set({});
            console.log('Created empty duty roster document');
        }
    } catch (error) {
        console.error('❌ Error loading duty roster:', error);
        console.error('Error details:', error.message, error.code);
        dutyRoster = {};
    }
}

async function saveDutyRoster() {
    try {
        console.log('Saving duty roster...');
        await db.collection('dutyRoster').doc('current').set(dutyRoster);
        console.log('✅ Duty roster saved');
    } catch (error) {
        console.error('❌ Error saving duty roster:', error);
        alert('Failed to save duty roster. Please try again.');
    }
}

async function loadLeaveBalances() {
    console.log('🔍 Loading leaveBalances from: leaveBalances/current');
    
    try {
        const docRef = db.collection('leaveBalances').doc('current');
        const doc = await docRef.get();
        console.log('Leave balances document exists:', doc.exists);
        
        if (doc.exists) {
            const data = doc.data();
            console.log('Raw leave balances data:', data);
            
            if (data && typeof data === 'object') {
                leaveBalances = data;
                console.log('✅ Leave balances loaded');
                console.log('Leave balance users:', Object.keys(leaveBalances).length);
                
                // Ensure current user has balance
                if (currentUser && !leaveBalances[currentUser.username]) {
                    console.log('Creating default balance for current user');
                    leaveBalances[currentUser.username] = {
                        SL: 12,
                        FRL: 6,
                        lastUpdated: new Date().toISOString()
                    };
                    await saveLeaveBalances();
                }
            } else {
                console.warn('⚠️ Unexpected leave balances data structure:', data);
                leaveBalances = {};
            }
        } else {
            console.warn('⚠️ leaveBalances/current document does not exist');
            leaveBalances = {};
            
            // Create default leave balances
            const defaultBalances = {};
            if (users && Array.isArray(users)) {
                users.forEach(user => {
                    if (user.username) {
                        defaultBalances[user.username] = {
                            SL: 12,
                            FRL: 6,
                            lastUpdated: new Date().toISOString()
                        };
                    }
                });
            }
            
            await docRef.set(defaultBalances);
            console.log('Created default leave balances for', Object.keys(defaultBalances).length, 'users');
            leaveBalances = defaultBalances;
        }
    } catch (error) {
        console.error('❌ Error loading leave balances:', error);
        console.error('Error details:', error.message, error.code);
        leaveBalances = {};
    }
}

async function saveLeaveBalances() {
    try {
        await db.collection('leaveBalances').doc('current').set(leaveBalances);
        console.log('✅ Leave balances saved');
    } catch (error) {
        console.error('❌ Error saving leave balances:', error);
        alert('Failed to save leave balances. Please try again.');
    }
}

async function loadAllRequests() {
    console.log('🔍 Loading requests from: requests/all');
    
    try {
        const docRef = db.collection('requests').doc('all');
        const doc = await docRef.get();
        console.log('Requests document exists:', doc.exists);
        
        if (doc.exists) {
            const data = doc.data();
            console.log('Raw requests data:', data);
            
            if (data && data.requests && Array.isArray(data.requests)) {
                allRequests = data.requests;
                console.log('✅ Requests loaded from data.requests');
            } else if (data && Array.isArray(data)) {
                allRequests = data;
                console.log('✅ Requests loaded from array data');
            } else if (data && typeof data === 'object') {
                // Try to find any array in the object
                const arrays = Object.values(data).filter(item => Array.isArray(item));
                if (arrays.length > 0) {
                    allRequests = arrays[0];
                    console.log('✅ Requests loaded from object array');
                } else {
                    console.warn('⚠️ Unexpected requests data structure:', data);
                    allRequests = [];
                }
            } else {
                console.warn('⚠️ Unexpected requests data structure:', data);
                allRequests = [];
            }
            
            console.log('Requests loaded:', allRequests.length);
            if (allRequests.length > 0) {
                console.log('First request:', allRequests[0]);
            }
        } else {
            console.warn('⚠️ requests/all document does not exist');
            allRequests = [];
            
            await docRef.set({ requests: [] });
            console.log('Created empty requests document');
        }
        
        updateRequestCounts();
    } catch (error) {
        console.error('❌ Error loading requests:', error);
        console.error('Error details:', error.message, error.code);
        allRequests = [];
    }
}

async function saveAllRequests() {
    try {
        await db.collection('requests').doc('all').set({ requests: allRequests });
        console.log('✅ Requests saved');
    } catch (error) {
        console.error('❌ Error saving requests:', error);
        alert('Failed to save requests. Please try again.');
    }
}

async function loadAnnouncements() {
    console.log('🔍 Loading announcements from: announcements/all');
    
    try {
        const docRef = db.collection('announcements').doc('all');
        const doc = await docRef.get();
        console.log('Announcements document exists:', doc.exists);
        
        if (doc.exists) {
            const data = doc.data();
            console.log('Raw announcements data:', data);
            
            // Check different possible data structures
            if (data && data.announcements && Array.isArray(data.announcements)) {
                announcements = data.announcements;
                console.log('✅ Announcements loaded from data.announcements');
            } else if (data && Array.isArray(data)) {
                announcements = data;
                console.log('✅ Announcements loaded from array data');
            } else if (data && typeof data === 'object') {
                // Try to extract announcements from object
                announcements = Object.values(data).filter(item => 
                    item && typeof item === 'object' && (item.title || item.message)
                );
                console.log('✅ Announcements extracted from object');
            } else {
                console.warn('⚠️ Unexpected announcements data structure:', data);
                announcements = [];
            }
            
            console.log('Announcements loaded:', announcements.length);
            if (announcements.length > 0) {
                console.log('First announcement:', announcements[0]);
            }
        } else {
            console.warn('⚠️ announcements/all document does not exist');
            announcements = [];
            
            await docRef.set({ announcements: [] });
            console.log('Created empty announcements document');
        }
    } catch (error) {
        console.error('❌ Error loading announcements:', error);
        console.error('Error details:', error.message, error.code);
        announcements = [];
    }
}

async function saveAnnouncements() {
    try {
        await db.collection('announcements').doc('all').set({ announcements: announcements });
        console.log('✅ Announcements saved');
    } catch (error) {
        console.error('❌ Error saving announcements:', error);
        alert('Failed to save announcements. Please try again.');
    }
}

async function initializeData() {
    console.log('=== INITIALIZE DATA START ===');
    
    try {
        // Load all data
        console.log('1. Loading duty roster...');
        await loadDutyRoster();
        
        console.log('2. Loading leave balances...');
        await loadLeaveBalances();
        
        console.log('3. Loading all requests...');
        await loadAllRequests();
        
        console.log('4. Loading announcements...');
        await loadAnnouncements();
        
        console.log('=== DATA LOADED SUMMARY ===');
        console.log('Duty Roster dates:', Object.keys(dutyRoster).length);
        console.log('Leave Balances users:', Object.keys(leaveBalances).length);
        console.log('All Requests count:', allRequests.length);
        console.log('Announcements count:', announcements.length);
        
        updateUserBalance();
        console.log('=== INITIALIZE DATA COMPLETE ===');
        
    } catch (error) {
        console.error('=== ERROR INITIALIZING DATA ===');
        console.error('Error:', error);
        console.error('Error message:', error.message);
        console.error('Error code:', error.code);
        
        // Try to create sample data
        console.log('Attempting to create sample data...');
        await createSampleDataIfNeeded();
        
        // Try loading again
        try {
            await loadDutyRoster();
            await loadAnnouncements();
        } catch (retryError) {
            console.error('Retry also failed:', retryError);
        }
    }
}

function updateUserBalance() {
    if (!currentUser) {
        console.warn('No current user for balance update');
        return;
    }
    
    const balance = leaveBalances[currentUser.username] || {SL: 12, FRL: 6};
    console.log('User balance:', balance);
    
    const slElement = document.getElementById('slBalance');
    const frlElement = document.getElementById('frlBalance');
    
    if (slElement) slElement.textContent = balance.SL.toFixed(1);
    if (frlElement) frlElement.textContent = balance.FRL.toFixed(1);
}

function setupNavigation() {
    console.log('Setting up navigation...');
    
    // Update request counts
    updateRequestCounts();
    
    console.log('Navigation setup complete');
}

function showSection(sectionId) {
    console.log('Showing section:', sectionId);
    
    // Hide all sections
    document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
    });
    
    // Show selected section
    const section = document.getElementById(sectionId + 'Section');
    if (section) {
        section.classList.add('active');
        
        // Update bottom navigation active state
        document.querySelectorAll('.bottom-nav-item').forEach(item => {
            item.classList.remove('active');
            if (item.getAttribute('data-section') === sectionId) {
                item.classList.add('active');
            }
        });
        
        // Load section data
        loadSectionData(sectionId);
    } else {
        console.error('Section not found:', sectionId + 'Section');
    }
    
    // Close mobile menu if open
    closeMobileMenu();
    
    // Scroll to top on mobile
    if (window.innerWidth <= 768) {
        window.scrollTo(0, 0);
    }
}

function loadSectionData(sectionId) {
    console.log('Loading data for section:', sectionId);
    
    switch(sectionId) {
        case 'home':
            loadHomeAnnouncements();
            updateDashboard();
            break;
        case 'dutyChange':
            loadDutyChangeForm();
            break;
        case 'leaveApplication':
            loadLeaveForm();
            break;
        case 'myRequests':
            loadMyRequests();
            break;
        case 'viewMyRoster':
            loadMyRoster();
            break;
        case 'viewAllRoster':
            loadAllRoster();
            break;
        case 'pendingRequests':
            loadPendingRequests();
            break;
        case 'adminAnnouncements':
            loadAnnouncementsAdmin();
            break;
        case 'adminDutyRoster':
            loadDutyRosterAdmin();
            break;
        case 'adminLeaveBalance':
            loadLeaveBalanceAdmin();
            break;
        case 'adminApprovals':
            loadAdminApprovals();
            break;
        case 'adminRequestHistory':
            loadAdminRequestHistory();
            break;
        default:
            console.log('No special data loading for section:', sectionId);
    }
}

// HOME SECTION FUNCTIONS
function loadHomeAnnouncements() {
    const container = document.getElementById('homeAnnouncements');
    if (!container) {
        console.error('Home announcements container not found');
        return;
    }
    
    console.log('Loading home announcements, count:', announcements.length);
    
    if (announcements.length === 0) {
        container.innerHTML = '<div class="alert alert-info">No announcements yet.</div>';
        return;
    }
    
    // Sort announcements by date (newest first)
    const sortedAnnouncements = [...announcements].sort((a, b) => 
        new Date(b.timestamp || b.date || 0) - new Date(a.timestamp || a.date || 0)
    );
    
    let html = '';
    const maxDisplay = window.innerWidth <= 768 ? 3 : 5;
    
    sortedAnnouncements.slice(0, maxDisplay).forEach(announcement => {
        const announcementDate = new Date(announcement.timestamp || announcement.date || Date.now());
        const formattedDate = announcementDate.toLocaleDateString('en-US', {
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        html += `
            <div class="announcement-card ${announcement.priority || 'medium'}">
                <div class="announcement-title">
                    <i class="fas fa-bullhorn"></i>
                    ${announcement.title || 'Announcement'}
                </div>
                <div class="announcement-content">
                    ${(announcement.message || announcement.content || '').replace(/\n/g, '<br>')}
                </div>
                <div class="announcement-meta">
                    <span>${formattedDate}</span>
                    <span>${announcement.postedBy || 'Admin'}</span>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
    console.log('Home announcements loaded:', sortedAnnouncements.length);
}

function updateDashboard() {
    if (!currentUser) {
        console.warn('No current user for dashboard update');
        return;
    }
    
    console.log('Updating dashboard...');
    
    // Update today's duty
    const today = new Date().toISOString().split('T')[0];
    const todayDutyElement = document.getElementById('todayDutyTime');
    
    if (todayDutyElement) {
        if (dutyRoster[today] && dutyRoster[today][currentUser.username]) {
            const duty = dutyRoster[today][currentUser.username];
            todayDutyElement.textContent = duty === 'Off' ? 'Off Duty' : duty;
            console.log('Today\'s duty:', duty);
        } else {
            todayDutyElement.textContent = 'Not Scheduled';
            console.log('Today\'s duty: Not scheduled');
        }
    }
    
    // Find next duty
    const nextDutyElement = document.getElementById('nextDutyTime');
    if (nextDutyElement) {
        const tomorrow = new Date();
        let nextDutyFound = false;
        
        for (let i = 1; i <= 7; i++) {
            tomorrow.setDate(tomorrow.getDate() + 1);
            const dateStr = tomorrow.toISOString().split('T')[0];
            if (dutyRoster[dateStr] && dutyRoster[dateStr][currentUser.username]) {
                const duty = dutyRoster[dateStr][currentUser.username];
                if (duty !== 'Off') {
                    nextDutyElement.textContent = `${dateStr}: ${duty}`;
                    nextDutyFound = true;
                    console.log('Next duty found:', dateStr, duty);
                    break;
                }
            }
        }
        
        if (!nextDutyFound) {
            nextDutyElement.textContent = 'No upcoming duty';
            console.log('No upcoming duty found');
        }
    }
    
    // Update balance display
    updateUserBalance();
    
    // Load announcements
    loadHomeAnnouncements();
    
    console.log('Dashboard update complete');
}

// DUTY CHANGE FUNCTIONS
function loadDutyChangeForm() {
    console.log('Loading duty change form');
    
    // Set default date to tomorrow
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    const tomorrowStr = tomorrow.toISOString().split('T')[0];
    
    const dateInput = document.getElementById('changeDate');
    if (dateInput) {
        dateInput.value = tomorrowStr;
        dateInput.min = new Date().toISOString().split('T')[0];
    }
    
    // Load duty times
    loadUserDutyTimes('changeDutyTime', tomorrowStr);
    
    // Load staff dropdown
    loadStaffDropdown('requestToStaff');
}

function loadUserDutyTimes(selectId, date) {
    if (!date || !dutyRoster[date] || !currentUser) {
        console.log('Cannot load duty times: missing data');
        return;
    }
    
    const select = document.getElementById(selectId);
    if (!select) return;
    
    select.innerHTML = '<option value="">Select Duty Time</option>';
    
    const userDuty = dutyRoster[date][currentUser.username];
    if (userDuty && userDuty !== 'Off') {
        const option = document.createElement('option');
        option.value = userDuty;
        option.textContent = userDuty;
        select.appendChild(option);
    } else {
        const option = document.createElement('option');
        option.value = 'Off';
        option.textContent = 'Off Duty';
        select.appendChild(option);
    }
    
    console.log('Duty times loaded for date:', date);
}

function loadStaffDropdown(selectId) {
    const select = document.getElementById(selectId);
    if (!select) return;
    
    select.innerHTML = '<option value="">Select staff member</option>';
    
    if (allUsers && Array.isArray(allUsers)) {
        allUsers.forEach(user => {
            if (user.username !== currentUser.username && user.Level === 'User') {
                const option = document.createElement('option');
                option.value = user.username;
                option.textContent = `${user.name} (${user.RCNo})`;
                select.appendChild(option);
            }
        });
    }
    
    console.log('Staff dropdown loaded with', allUsers?.length || 0, 'users');
}

// Setup event listeners
function setupEventListeners() {
    console.log('Setting up event listeners');
    
    // Duty Change Form
    const dutyChangeForm = document.getElementById('dutyChangeForm');
    if (dutyChangeForm) {
        dutyChangeForm.addEventListener('submit', function(e) {
            e.preventDefault();
            submitDutyChange();
        });
    }
    
    // Leave Application Form
    const leaveForm = document.getElementById('leaveApplicationForm');
    if (leaveForm) {
        leaveForm.addEventListener('submit', function(e) {
            e.preventDefault();
            submitLeaveApplication();
        });
    }
    
    // Date change handlers
    const changeDate = document.getElementById('changeDate');
    if (changeDate) {
        changeDate.addEventListener('change', function() {
            loadUserDutyTimes('changeDutyTime', this.value);
        });
    }
    
    const leaveDate = document.getElementById('leaveDate');
    if (leaveDate) {
        leaveDate.addEventListener('change', function() {
            loadUserDutyTimes('leaveDutyTime', this.value);
        });
    }
    
    console.log('Event listeners setup complete');
}

function updateRequestCounts() {
    if (!currentUser) return;
    
    // Pending requests count for supervisor
    if (currentUser.level === 'Supervisor') {
        const pendingCount = allRequests.filter(req => req.status === 'pending').length;
        console.log('Pending requests for supervisor:', pendingCount);
        
        const pendingBadge = document.getElementById('mobilePendingCount');
        if (pendingBadge) {
            pendingBadge.textContent = pendingCount;
            pendingBadge.style.display = pendingCount > 0 ? 'inline-block' : 'none';
        }
    }
    
    // User's pending requests count
    const userPendingCount = allRequests.filter(req => 
        req.fromUsername === currentUser.username && 
        req.status === 'pending'
    ).length;
    
    console.log('User pending requests:', userPendingCount);
    
    const myRequestsBadge = document.getElementById('mobileRequestCount');
    if (myRequestsBadge) {
        myRequestsBadge.textContent = userPendingCount;
        myRequestsBadge.style.display = userPendingCount > 0 ? 'inline-block' : 'none';
    }
    
    const bottomRequestBadge = document.getElementById('bottomRequestCount');
    if (bottomRequestBadge) {
        bottomRequestBadge.textContent = userPendingCount;
        bottomRequestBadge.style.display = userPendingCount > 0 ? 'inline-block' : 'none';
    }
}

function setupRealtimeListeners() {
    console.log('Setting up real-time listeners...');
    
    try {
        // Listen for announcement updates
        db.collection('announcements').doc('all')
            .onSnapshot((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    if (data && data.announcements && Array.isArray(data.announcements)) {
                        announcements = data.announcements;
                        console.log('Real-time: Announcements updated, count:', announcements.length);
                        
                        if (document.getElementById('homeSection')?.classList.contains('active')) {
                            loadHomeAnnouncements();
                        }
                    }
                }
            }, (error) => {
                console.error('Real-time announcements error:', error);
            });

        // Listen for request updates
        db.collection('requests').doc('all')
            .onSnapshot((doc) => {
                if (doc.exists && doc.data().requests) {
                    allRequests = doc.data().requests;
                    console.log('Real-time: Requests updated, count:', allRequests.length);
                    
                    updateRequestCounts();
                    
                    // Refresh relevant sections
                    const activeSection = document.querySelector('.section.active');
                    if (activeSection) {
                        const sectionId = activeSection.id.replace('Section', '');
                        loadSectionData(sectionId);
                    }
                }
            }, (error) => {
                console.error('Real-time requests error:', error);
            });
            
        console.log('Real-time listeners established');
    } catch (error) {
        console.error('Error setting up real-time listeners:', error);
    }
}

// Add to global scope for debugging
window.debugApp = function() {
    console.log('=== APP DEBUG INFO ===');
    console.log('Current user:', currentUser);
    console.log('All users:', allUsers?.length || 0);
    console.log('Duty roster dates:', Object.keys(dutyRoster).length);
    console.log('Announcements:', announcements.length);
    console.log('Leave balances:', Object.keys(leaveBalances).length);
    console.log('All requests:', allRequests.length);
    console.log('Firebase ready:', firebaseReady);
    console.log('========================');
};

// Add a test button to window
window.testFirebase = debugFirebase;

// Initialize when page loads
window.addEventListener('load', function() {
    console.log('Page fully loaded');
});
     </script>
     </body>
     </html> 
