<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Duty Management System</title>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <!-- SHA-256 Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js"></script>
    
    <!-- External files -->
    <script src="dcfire.js" defer></script>
    <script src="user.js" defer></script>
    
    <!-- Font Awesome for Mobile Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }

        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --light-color: #f5f7fa;
            --dark-color: #2c3e50;
            --border-color: #e0e6ed;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        body {
            background: var(--light-color);
            min-height: 100vh;
            padding: 0;
            font-size: 14px;
            -webkit-text-size-adjust: 100%;
        }

        /* Mobile Menu Overlay */
        .mobile-menu-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9998;
        }

        .mobile-menu-overlay.active {
            display: block;
        }

        /* Mobile Menu */
        .mobile-menu {
            position: fixed;
            top: 0;
            left: -280px;
            width: 280px;
            height: 100%;
            background: white;
            z-index: 9999;
            transition: left 0.3s ease;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }

        .mobile-menu.active {
            left: 0;
        }

        .mobile-menu-header {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            color: white;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .mobile-menu-header h3 {
            font-size: 18px;
        }

        .close-menu {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }

        .mobile-menu-nav {
            padding: 10px 0;
        }

        .mobile-nav-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            color: var(--dark-color);
            text-decoration: none;
            border-bottom: 1px solid var(--border-color);
            transition: background 0.2s;
        }

        .mobile-nav-item i {
            margin-right: 12px;
            width: 20px;
            text-align: center;
            font-size: 16px;
        }

        .mobile-nav-item.active {
            background: var(--primary-color);
            color: white;
        }

        .mobile-nav-item:hover {
            background: #f5f5f5;
        }

        .notification-badge-mobile {
            background: var(--danger-color);
            color: white;
            border-radius: 10px;
            padding: 2px 8px;
            font-size: 12px;
            margin-left: auto;
        }

        /* Login Page */
        .login-container {
            background: white;
            width: 100%;
            min-height: 100vh;
            padding: 30px 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo h1 {
            color: var(--secondary-color);
            font-size: 24px;
            margin-bottom: 5px;
        }

        .logo p {
            color: #7f8c8d;
            font-size: 13px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: var(--secondary-color);
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .form-control {
            width: 100%;
            padding: 14px 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
            -webkit-appearance: none;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background: #219653;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-warning {
            background: var(--warning-color);
            color: white;
        }

        .btn-warning:hover {
            background: #d68910;
        }

        .btn-block {
            width: 100%;
        }

        .btn-sm {
            padding: 8px 12px;
            font-size: 13px;
        }

        .btn-xs {
            padding: 4px 8px;
            font-size: 12px;
        }

        .error-message {
            background: #ffeaea;
            color: var(--danger-color);
            padding: 12px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
            font-size: 13px;
        }

        /* Dashboard */
        .dashboard-container {
            display: none;
            width: 100%;
            min-height: 100vh;
            background: white;
        }

        /* Mobile Header */
        .mobile-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            color: white;
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            height: 60px;
        }

        .mobile-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .menu-toggle {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
        }

        .menu-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .mobile-header-title h2 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .mobile-header-title p {
            font-size: 11px;
            opacity: 0.9;
        }

        .mobile-header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-notification {
            position: relative;
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
        }

        .header-notification:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .notification-indicator {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 8px;
            height: 8px;
            background: var(--danger-color);
            border-radius: 50%;
            border: 2px solid var(--primary-color);
        }

        /* Content Area */
        .dashboard-content {
            padding: 80px 15px 20px;
            min-height: 100vh;
            background: #f5f7fa;
        }

        .section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section.active {
            display: block;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .card h3 {
            color: var(--secondary-color);
            margin-bottom: 15px;
            font-size: 16px;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card h3 i {
            font-size: 18px;
        }

        /* Quick Actions Bar */
        .quick-actions-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            border-top: 1px solid var(--border-color);
            z-index: 1000;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }

        .quick-action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: none;
            border: none;
            color: #7f8c8d;
            font-size: 11px;
            cursor: pointer;
            padding: 5px;
            flex: 1;
            transition: color 0.2s;
        }

        .quick-action-btn i {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .quick-action-btn.active {
            color: var(--primary-color);
        }

        .quick-action-btn:hover {
            color: var(--primary-color);
        }

        /* Announcement Banner - Mobile */
        .announcement-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            position: relative;
            overflow: hidden;
        }

        .announcement-banner.priority-high {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            animation: pulse-banner 2s infinite;
        }

        .announcement-banner.priority-medium {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .announcement-banner.priority-low {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }

        @keyframes pulse-banner {
            0% { box-shadow: 0 0 0 0 rgba(245, 87, 108, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(245, 87, 108, 0); }
            100% { box-shadow: 0 0 0 0 rgba(245, 87, 108, 0); }
        }

        .announcement-title {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .announcement-icon {
            font-size: 18px;
        }

        .announcement-content {
            font-size: 13px;
            opacity: 0.95;
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .announcement-meta {
            font-size: 11px;
            opacity: 0.8;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }

        .announcement-target {
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
        }

        .announcement-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
        }

        .announcement-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.3s;
        }

        /* Forms - Mobile Optimized */
        .form-row {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-row-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }

        @media (min-width: 480px) {
            .form-row-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }

        .form-group-inline {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        textarea.form-control {
            min-height: 80px;
            resize: vertical;
            font-family: inherit;
        }

        select.form-control {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 16px;
            padding-right: 40px;
        }

        /* Tables - Mobile Responsive */
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-top: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: white;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
            background: white;
        }

        th, td {
            padding: 12px 10px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            font-size: 12px;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: var(--secondary-color);
            font-size: 12px;
            white-space: nowrap;
        }

        tr:hover {
            background: #f8f9fa;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 6px 10px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }

        .action-btn.approve {
            background: #d4edda;
            color: #155724;
        }

        .action-btn.reject {
            background: #f8d7da;
            color: #721c24;
        }

        .action-btn.view {
            background: #d1ecf1;
            color: #0c5460;
        }

        .action-btn.apply {
            background: #cce5ff;
            color: #004085;
        }

        .action-btn.delete {
            background: #f8d7da;
            color: #721c24;
        }

        .action-btn.edit {
            background: #fff3cd;
            color: #856404;
        }

        /* Alerts */
        .alert {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid;
            font-size: 13px;
            line-height: 1.4;
        }

        .alert-info {
            background: #e8f4fc;
            border-color: var(--primary-color);
            color: var(--secondary-color);
        }

        .alert-success {
            background: #d4edda;
            border-color: var(--success-color);
            color: #155724;
        }

        .alert-warning {
            background: #fff3cd;
            border-color: var(--warning-color);
            color: #856404;
        }

        .alert-danger {
            background: #f8d7da;
            border-color: var(--danger-color);
            color: #721c24;
        }

        /* Balance Display - Mobile */
        .balance-display {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .balance-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid var(--border-color);
        }

        .balance-value {
            font-size: 22px;
            font-weight: bold;
            color: var(--secondary-color);
            margin: 5px 0;
        }

        .balance-label {
            font-size: 11px;
            color: #7f8c8d;
            text-transform: uppercase;
        }

        /* Tab Controls - Mobile */
        .tab-controls {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .tab-controls::-webkit-scrollbar {
            display: none;
        }

        .tab-btn {
            padding: 8px 12px;
            border: none;
            background: #f0f0f0;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .tab-btn.active {
            background: var(--primary-color);
            color: white;
        }

        /* Loading Spinner */
        .loading {
            text-align: center;
            padding: 40px 20px;
            color: #7f8c8d;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Excel Import Area - Mobile */
        .excel-import-area {
            background: #f8f9fa;
            border: 2px dashed var(--primary-color);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            touch-action: manipulation;
        }

        .excel-import-area:active {
            background: #e8f4fc;
        }

        .excel-paste-box {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            resize: vertical;
        }

        /* Status Badges */
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            display: inline-block;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-approved {
            background: #d4edda;
            color: #155724;
        }

        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }

        .status-off {
            background: #e8f4fc;
            color: #0c5460;
        }

        .status-completed {
            background: #d1ecf1;
            color: #0c5460;
        }

        /* Calendar View - Mobile */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 3px;
            margin-top: 15px;
        }

        .calendar-day {
            border: 1px solid var(--border-color);
            padding: 6px;
            min-height: 50px;
            border-radius: 4px;
            background: #f8f9fa;
            font-size: 11px;
        }

        .calendar-day.off-day {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        }

        .calendar-day.duty-day {
            background: linear-gradient(135deg, #cce5ff 0%, #b8daff 100%);
        }

        .calendar-day.today {
            border: 2px solid var(--primary-color);
            background: linear-gradient(135deg, #e8f4fc 0%, #d1ecf1 100%);
        }

        .day-header {
            font-weight: bold;
            font-size: 11px;
            color: var(--secondary-color);
            margin-bottom: 3px;
            text-align: center;
        }

        .duty-time {
            font-size: 10px;
            color: #155724;
            text-align: center;
        }

        .off-time {
            font-size: 10px;
            color: #721c24;
            text-align: center;
        }

        /* Mobile Swipe Navigation */
        .swipe-indicator {
            position: fixed;
            bottom: 70px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 5px;
            z-index: 999;
            pointer-events: none;
        }

        .swipe-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.2);
            transition: background 0.3s;
        }

        .swipe-dot.active {
            background: var(--primary-color);
        }

        /* Duty Time Colors - Mobile Optimized */
        .duty-0730-1530 {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%) !important;
            color: #856404 !important;
        }

        .duty-0830-1630 {
            background: linear-gradient(135deg, #e2d9f3 0%, #d6c6f7 100%) !important;
            color: #563d7c !important;
        }

        .duty-1030-1830 {
            background: linear-gradient(135deg, #fffde7 0%, #fff9c4 100%) !important;
            color: #827717 !important;
        }

        .duty-1530-2330 {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%) !important;
            color: #0d47a1 !important;
        }

        .duty-1630-0030 {
            background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%) !important;
            color: #424242 !important;
        }

        .duty-1730-0130 {
            background: linear-gradient(135deg, #eeeeee 0%, #bdbdbd 100%) !important;
            color: #212121 !important;
        }

        .duty-0030-0830 {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%) !important;
            color: #c62828 !important;
        }

        .duty-leave {
            background: linear-gradient(135deg, #ffd8a6 0%, #ffc078 100%) !important;
            color: #e8590c !important;
            border: 1px dashed #fd7e14 !important;
        }

        .off-day-cell {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%) !important;
            color: #155724 !important;
        }

        .today-cell {
            border: 2px solid var(--primary-color) !important;
            box-shadow: 0 0 8px rgba(52, 152, 219, 0.3) !important;
        }

        /* Mobile Bottom Sheet for Forms */
        .bottom-sheet {
            position: fixed;
            bottom: -100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 20px 20px 0 0;
            padding: 20px;
            z-index: 1100;
            transition: bottom 0.3s ease;
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.2);
            max-height: 80vh;
            overflow-y: auto;
        }

        .bottom-sheet.active {
            bottom: 0;
        }

        .bottom-sheet-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .bottom-sheet-header h3 {
            margin: 0;
            color: var(--secondary-color);
            font-size: 18px;
        }

        .close-sheet {
            background: none;
            border: none;
            font-size: 20px;
            color: #7f8c8d;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .bottom-sheet-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1099;
            display: none;
        }

        .bottom-sheet-overlay.active {
            display: block;
        }

        /* Mobile Search Bar */
        .mobile-search-bar {
            position: fixed;
            top: 60px;
            left: 0;
            right: 0;
            background: white;
            padding: 10px 15px;
            z-index: 999;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .mobile-search-bar.active {
            display: block;
        }

        .search-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
        }

        /* Responsive Media Queries */
        @media (min-width: 768px) {
            body {
                padding: 20px;
                background: var(--light-color);
                display: flex;
                justify-content: center;
                align-items: center;
                min-height: 100vh;
            }

            .login-container {
                border-radius: 15px;
                box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
                max-width: 400px;
                min-height: auto;
                padding: 40px;
            }

            .dashboard-container {
                border-radius: 15px;
                box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
                max-width: 1200px;
                min-height: 600px;
                overflow: hidden;
            }

            .mobile-header {
                display: none;
            }

            .quick-actions-bar {
                display: none;
            }

            .dashboard-content {
                padding: 25px;
            }

            .mobile-menu-overlay,
            .mobile-menu {
                display: none;
            }

            .swipe-indicator {
                display: none;
            }

            .form-row-grid {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }

            .balance-display {
                grid-template-columns: repeat(4, 1fr);
            }

            table {
                min-width: auto;
            }

            th, td {
                font-size: 13px;
            }
        }

        @media (max-width: 767px) {
            .desktop-only {
                display: none !important;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .action-buttons {
                flex-direction: column;
                width: 100%;
            }
            
            .action-btn {
                width: 100%;
                justify-content: center;
            }
            
            .calendar-day {
                min-height: 40px;
                padding: 4px;
            }
            
            .day-header {
                font-size: 10px;
            }
        }

        @media (max-width: 480px) {
            .balance-display {
                grid-template-columns: 1fr;
            }
            
            .balance-box {
                padding: 12px;
            }
            
            .balance-value {
                font-size: 20px;
            }
            
            .card {
                padding: 15px;
            }
            
            .btn {
                padding: 12px 20px;
                font-size: 14px;
            }
            
            .announcement-title {
                font-size: 14px;
            }
            
            .announcement-content {
                font-size: 12px;
            }
        }

        /* Touch-friendly Improvements */
        button, 
        .btn,
        .action-btn,
        .tab-btn,
        .nav-btn {
            min-height: 44px;
            min-width: 44px;
            touch-action: manipulation;
        }

        input,
        select,
        textarea {
            font-size: 16px; /* Prevents iOS zoom on focus */
        }

        /* Hide scrollbars on mobile but keep functionality */
        .scrollable {
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .scrollable::-webkit-scrollbar {
            display: none;
        }

        /* Pull to refresh indicator */
        .pull-to-refresh {
            text-align: center;
            padding: 10px;
            color: #7f8c8d;
            font-size: 12px;
        }

        /* Offline indicator */
        .offline-indicator {
            position: fixed;
            top: 60px;
            left: 0;
            right: 0;
            background: var(--warning-color);
            color: white;
            padding: 10px;
            text-align: center;
            font-size: 12px;
            z-index: 1001;
            display: none;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #7f8c8d;
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* Loading skeleton */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 4px;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Print styles */
        @media print {
            .mobile-header,
            .quick-actions-bar,
            .btn,
            .action-buttons {
                display: none !important;
            }
            
            .dashboard-content {
                padding: 0;
            }
            
            .card {
                box-shadow: none;
                border: 1px solid #000;
            }
        }
    </style>
</head>
<body>
    <!-- Login Container -->
    <div class="login-container" id="loginContainer">
        <div class="logo">
            <h1><i class="fas fa-calendar-alt"></i> Duty Management</h1>
            <p>Secure Mobile Login System</p>
        </div>
        
        <form id="loginForm">
            <div class="form-group">
                <label for="username"><i class="fas fa-user"></i> Username</label>
                <input type="text" id="username" class="form-control" placeholder="Enter username" required autofocus>
            </div>
            
            <div class="form-group">
                <label for="password"><i class="fas fa-lock"></i> Password</label>
                <input type="password" id="password" class="form-control" placeholder="Enter password" required>
            </div>
            
            <button type="submit" class="btn btn-primary btn-block" id="loginBtn">
                <i class="fas fa-sign-in-alt"></i> Login
            </button>
            
            <div class="error-message" id="errorMessage">
                <i class="fas fa-exclamation-circle"></i> Invalid username or password
            </div>
        </form>
    </div>
    
    <!-- Dashboard Container -->
    <div class="dashboard-container" id="dashboardContainer">
        <!-- Mobile Header -->
        <div class="mobile-header">
            <div class="mobile-header-left">
                <button class="menu-toggle" id="menuToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="mobile-header-title">
                    <h2 id="mobileUserName">User Name</h2>
                    <p>RC: <span id="mobileUserRC">000</span> â€¢ <span id="mobileUserLevel">User</span></p>
                </div>
            </div>
            <div class="mobile-header-actions">
                <button class="header-notification" id="mobileNotificationBtn">
                    <i class="fas fa-bell"></i>
                    <span class="notification-indicator" id="mobileNotificationIndicator" style="display: none;"></span>
                </button>
                <button class="menu-toggle" id="mobileSearchToggle">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
        
        <!-- Mobile Search Bar -->
        <div class="mobile-search-bar" id="mobileSearchBar">
            <input type="text" class="search-input" id="mobileSearchInput" placeholder="Search...">
        </div>
        
        <!-- Mobile Menu Overlay -->
        <div class="mobile-menu-overlay" id="mobileMenuOverlay"></div>
        
        <!-- Mobile Menu -->
        <div class="mobile-menu" id="mobileMenu">
            <div class="mobile-menu-header">
                <h3><i class="fas fa-user-circle"></i> Menu</h3>
                <button class="close-menu" id="closeMenu">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="mobile-menu-nav">
                <a href="#" class="mobile-nav-item active" data-section="home">
                    <i class="fas fa-home"></i> Dashboard
                </a>
                <a href="#" class="mobile-nav-item" data-section="dutyChange">
                    <i class="fas fa-exchange-alt"></i> Duty Change
                </a>
                <a href="#" class="mobile-nav-item" data-section="leaveApplication">
                    <i class="fas fa-calendar-times"></i> Apply Leave
                </a>
                <a href="#" class="mobile-nav-item" data-section="myRequests">
                    <i class="fas fa-history"></i> My Requests
                </a>
                <a href="#" class="mobile-nav-item" data-section="viewMyRoster">
                    <i class="fas fa-calendar"></i> My Roster
                </a>
                <a href="#" class="mobile-nav-item" data-section="viewAllRoster">
                    <i class="fas fa-calendar-alt"></i> All Roster
                </a>
                <a href="#" class="mobile-nav-item" data-section="pendingRequests" id="mobilePendingRequestsBtn" style="display: none;">
                    <i class="fas fa-clock"></i> Pending 
                    <span id="mobilePendingCount" class="notification-badge-mobile">0</span>
                </a>
                <!-- Admin Only -->
                <a href="#" class="mobile-nav-item" data-section="adminDutyRoster" id="mobileAdminDutyRosterBtn" style="display: none;">
                    <i class="fas fa-calendar-plus"></i> Duty Roster
                </a>
                <a href="#" class="mobile-nav-item" data-section="adminLeaveBalance" id="mobileAdminLeaveBalanceBtn" style="display: none;">
                    <i class="fas fa-balance-scale"></i> Leave Balance
                </a>
                <a href="#" class="mobile-nav-item" data-section="adminApprovals" id="mobileAdminApprovalsBtn" style="display: none;">
                    <i class="fas fa-check-circle"></i> Approvals
                </a>
                <a href="#" class="mobile-nav-item" data-section="adminRequestHistory" id="mobileAdminRequestHistoryBtn" style="display: none;">
                    <i class="fas fa-history"></i> Request History
                    <span id="mobileHistoryNotification" class="notification-indicator" style="display: none;"></span>
                </a>
                <a href="#" class="mobile-nav-item" data-section="adminAnnouncements" id="mobileAdminAnnouncementsBtn" style="display: none;">
                    <i class="fas fa-bullhorn"></i> Announcements
                </a>
            </div>
            <div style="padding: 20px;">
                <button class="btn btn-danger btn-block" id="mobileLogoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>
        
        <!-- Offline Indicator -->
        <div class="offline-indicator" id="offlineIndicator">
            <i class="fas fa-wifi-slash"></i> You are offline. Some features may be limited.
        </div>
        
        <!-- Content Area -->
        <div class="dashboard-content" id="dashboardContent">
            <!-- Dashboard -->
            <div class="section active" id="homeSection">
                <div id="homeAnnouncements">
                    <!-- Announcements will be loaded here -->
                </div>
                
                <div class="card">
                    <h3><i class="fas fa-user"></i> Welcome, <span id="welcomeName">User</span>!</h3>
                    
                    <div class="balance-display">
                        <div class="balance-box">
                            <div class="balance-label">Sick Leave</div>
                            <div class="balance-value" id="slBalance">0</div>
                            <div class="balance-label">Days</div>
                        </div>
                        <div class="balance-box">
                            <div class="balance-label">FRL Balance</div>
                            <div class="balance-value" id="frlBalance">0</div>
                            <div class="balance-label">Days</div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <p><strong><i class="fas fa-clock"></i> Today's Duty:</strong> <span id="todayDutyTime">Not Scheduled</span></p>
                        <p><strong><i class="fas fa-calendar-check"></i> Next Duty:</strong> <span id="nextDutyTime">No upcoming duty</span></p>
                        <div id="homeNotifications" style="margin-top: 10px; display: none;">
                            <!-- Notifications will appear here -->
                        </div>
                    </div>
                    
                    <div class="form-row-grid">
                        <button class="btn btn-primary" onclick="updateDashboard()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button class="btn btn-warning" onclick="showSection('dutyChange')">
                            <i class="fas fa-exchange-alt"></i> Duty Change
                        </button>
                        <button class="btn btn-success" onclick="showSection('leaveApplication')">
                            <i class="fas fa-calendar-times"></i> Apply Leave
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <h3><i class="fas fa-tachometer-alt"></i> Quick Actions</h3>
                    <div class="form-row-grid">
                        <button class="btn btn-primary" onclick="showSection('myRequests')">
                            <i class="fas fa-history"></i> My Requests
                        </button>
                        <button class="btn btn-primary" onclick="showSection('viewMyRoster')">
                            <i class="fas fa-calendar"></i> My Roster
                        </button>
                        <button class="btn btn-primary" onclick="showSection('viewAllRoster')">
                            <i class="fas fa-calendar-alt"></i> All Roster
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Other sections remain the same as in your original code -->
            <!-- Due to character limit, I'll show the structure for one section -->
            
            <!-- Duty Change Request -->
            <div class="section" id="dutyChangeSection">
                <div class="card">
                    <h3><i class="fas fa-exchange-alt"></i> Duty Change Request</h3>
                    
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Note:</strong> Requests must be made at least 24 hours in advance. No back dates allowed.
                    </div>
                    
                    <form id="dutyChangeForm">
                        <div class="form-row-grid">
                            <div class="form-group">
                                <label for="changeDate"><i class="fas fa-calendar"></i> Change Date *</label>
                                <input type="date" id="changeDate" class="form-control" required min="">
                            </div>
                            <div class="form-group">
                                <label for="changeDutyTime"><i class="fas fa-clock"></i> Your Duty Time *</label>
                                <select id="changeDutyTime" class="form-control" required>
                                    <option value="">Select duty time</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Continue with the rest of the form... -->
                        <!-- Due to character limit, I'm showing the structure -->
                        
                        <div class="form-row">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-paper-plane"></i> Submit Request
                            </button>
                            <button type="button" class="btn btn-danger" onclick="showSection('home')">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Continue with other sections... -->
            <!-- Leave Application, My Requests, View My Roster, etc. -->
            
        </div>
        
        <!-- Quick Actions Bar -->
        <div class="quick-actions-bar">
            <button class="quick-action-btn active" data-section="home">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </button>
            <button class="quick-action-btn" data-section="dutyChange">
                <i class="fas fa-exchange-alt"></i>
                <span>Swap</span>
            </button>
            <button class="quick-action-btn" data-section="leaveApplication">
                <i class="fas fa-calendar-times"></i>
                <span>Leave</span>
            </button>
            <button class="quick-action-btn" data-section="myRequests">
                <i class="fas fa-history"></i>
                <span>Requests</span>
            </button>
            <button class="quick-action-btn" onclick="toggleMobileMenu()">
                <i class="fas fa-bars"></i>
                <span>Menu</span>
            </button>
        </div>
        
        <!-- Swipe Navigation Indicator -->
        <div class="swipe-indicator" id="swipeIndicator">
            <div class="swipe-dot active" data-index="0"></div>
            <div class="swipe-dot" data-index="1"></div>
            <div class="swipe-dot" data-index="2"></div>
            <div class="swipe-dot" data-index="3"></div>
            <div class="swipe-dot" data-index="4"></div>
        </div>
        
        <!-- Bottom Sheet for Forms -->
        <div class="bottom-sheet-overlay" id="bottomSheetOverlay"></div>
        <div class="bottom-sheet" id="bottomSheet">
            <div class="bottom-sheet-header">
                <h3 id="bottomSheetTitle">Form Title</h3>
                <button class="close-sheet" id="closeBottomSheet">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="bottomSheetContent">
                <!-- Form content will be loaded here -->
            </div>
        </div>
    </div>

    <script>
       // ============================================
// DUTY MANAGEMENT SYSTEM - COMPLETE JAVASCRIPT
// ============================================

// Global variables
let currentUser = null;
let allUsers = [];
let dutyRoster = {};
let leaveBalances = {};
let allRequests = [];
let announcements = [];
let userDisplayNameMap = {};
let currentSection = 'home';
let touchStartX = 0;
let touchEndX = 0;
let isOnline = navigator.onLine;
let swipeSections = ['home', 'dutyChange', 'leaveApplication', 'myRequests', 'viewMyRoster'];
let isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

// Color mapping for duty times
const dutyTimeColorMap = {
    '0730-1530': 'duty-0730-1530',
    '0830-1630': 'duty-0830-1630',
    '1030-1830': 'duty-1030-1830',
    '1530-2330': 'duty-1530-2330',
    '1630-0030': 'duty-1630-0030',
    '1730-0130': 'duty-1730-0130',
    '0030-0830': 'duty-0030-0830',
    'Off': 'off-day-cell',
    'Leave': 'duty-leave',
    'Not Scheduled': 'off-day-cell'
};

// Initialize app when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    initApp();
});

// ============================================
// INITIALIZATION FUNCTIONS
// ============================================

function initApp() {
    console.log('Initializing Duty Management System...');
    
    // Setup login
    document.getElementById('loginForm').addEventListener('submit', function(e) {
        e.preventDefault();
        handleLogin();
    });
    
    // Set minimum dates to today
    const today = new Date().toISOString().split('T')[0];
    setMinDates(today);
    
    // Setup mobile features
    setupMobileMenu();
    setupSwipeNavigation();
    setupOfflineDetection();
    setupQuickActions();
    setupMobileSearch();
    
    // Check for existing session
    checkSession();
    
    // Initialize date inputs
    initializeDateInputs(today);
    
    // Setup bottom sheet
    setupBottomSheet();
}

function setMinDates(today) {
    const dateInputs = ['changeDate', 'leaveDate', 'rosterDate', 'viewRosterDate', 'announcementExpiry'];
    dateInputs.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.min = today;
            if (id === 'changeDate' || id === 'leaveDate') {
                // Set default to tomorrow for requests
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                element.value = tomorrow.toISOString().split('T')[0];
            } else if (id === 'rosterDate' || id === 'viewRosterDate') {
                element.value = today;
            }
        }
    });
}

function initializeDateInputs(today) {
    // Set month inputs
    const monthInputs = ['myRosterMonth', 'allRosterStartDate', 'allRosterEndDate'];
    monthInputs.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            if (id === 'myRosterMonth') {
                element.value = today.substring(0, 7);
            } else if (id === 'allRosterStartDate') {
                element.value = today;
            } else if (id === 'allRosterEndDate') {
                const nextWeek = new Date(today);
                nextWeek.setDate(nextWeek.getDate() + 7);
                element.value = nextWeek.toISOString().split('T')[0];
            }
        }
    });
}

// ============================================
// MOBILE FEATURES SETUP
// ============================================

function setupMobileMenu() {
    const menuToggle = document.getElementById('menuToggle');
    const closeMenu = document.getElementById('closeMenu');
    const mobileMenu = document.getElementById('mobileMenu');
    const mobileMenuOverlay = document.getElementById('mobileMenuOverlay');
    const mobileNavItems = document.querySelectorAll('.mobile-nav-item');
    const quickActionBtns = document.querySelectorAll('.quick-action-btn');
    const mobileLogoutBtn = document.getElementById('mobileLogoutBtn');
    
    if (menuToggle) menuToggle.addEventListener('click', toggleMobileMenu);
    if (closeMenu) closeMenu.addEventListener('click', toggleMobileMenu);
    if (mobileMenuOverlay) mobileMenuOverlay.addEventListener('click', toggleMobileMenu);
    
    mobileNavItems.forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const section = this.getAttribute('data-section');
            showSection(section);
            toggleMobileMenu();
        });
    });
    
    quickActionBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const section = this.getAttribute('data-section');
            if (section) {
                showSection(section);
                updateQuickActions(section);
            } else {
                toggleMobileMenu();
            }
        });
    });
    
    if (mobileLogoutBtn) {
        mobileLogoutBtn.addEventListener('click', function() {
            localStorage.removeItem('dutySystemSession');
            location.reload();
        });
    }
    
    // Mobile search toggle
    const mobileSearchToggle = document.getElementById('mobileSearchToggle');
    if (mobileSearchToggle) {
        mobileSearchToggle.addEventListener('click', function() {
            const searchBar = document.getElementById('mobileSearchBar');
            if (searchBar) {
                searchBar.classList.toggle('active');
                if (searchBar.classList.contains('active')) {
                    document.getElementById('mobileSearchInput').focus();
                }
            }
        });
    }
    
    // Mobile notifications
    const mobileNotificationBtn = document.getElementById('mobileNotificationBtn');
    if (mobileNotificationBtn) {
        mobileNotificationBtn.addEventListener('click', showNotificationsPanel);
    }
}

function toggleMobileMenu() {
    const mobileMenu = document.getElementById('mobileMenu');
    const mobileMenuOverlay = document.getElementById('mobileMenuOverlay');
    
    if (mobileMenu && mobileMenuOverlay) {
        mobileMenu.classList.toggle('active');
        mobileMenuOverlay.classList.toggle('active');
        
        // Prevent body scroll when menu is open
        document.body.style.overflow = mobileMenu.classList.contains('active') ? 'hidden' : '';
    }
}

function setupSwipeNavigation() {
    const content = document.getElementById('dashboardContent');
    if (!content) return;
    
    content.addEventListener('touchstart', function(e) {
        touchStartX = e.changedTouches[0].screenX;
    }, {passive: true});
    
    content.addEventListener('touchend', function(e) {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipe();
    }, {passive: true});
    
    // Update swipe indicator
    updateSwipeIndicator();
}

function handleSwipe() {
    const swipeThreshold = 50;
    const swipeDistance = touchEndX - touchStartX;
    
    if (Math.abs(swipeDistance) < swipeThreshold) return;
    
    const currentIndex = swipeSections.indexOf(currentSection);
    let newIndex;
    
    if (swipeDistance > 0 && currentIndex > 0) {
        // Swipe right - go to previous section
        newIndex = currentIndex - 1;
    } else if (swipeDistance < 0 && currentIndex < swipeSections.length - 1) {
        // Swipe left - go to next section
        newIndex = currentIndex + 1;
    } else {
        return;
    }
    
    showSection(swipeSections[newIndex]);
    updateSwipeIndicator();
}

function updateSwipeIndicator() {
    const indicators = document.querySelectorAll('.swipe-dot');
    const currentIndex = swipeSections.indexOf(currentSection);
    
    indicators.forEach((dot, index) => {
        if (index === currentIndex) {
            dot.classList.add('active');
        } else {
            dot.classList.remove('active');
        }
    });
}

function setupOfflineDetection() {
    window.addEventListener('online', function() {
        isOnline = true;
        const offlineIndicator = document.getElementById('offlineIndicator');
        if (offlineIndicator) offlineIndicator.style.display = 'none';
        showUserNotification('You are back online!', 'success');
    });
    
    window.addEventListener('offline', function() {
        isOnline = false;
        const offlineIndicator = document.getElementById('offlineIndicator');
        if (offlineIndicator) offlineIndicator.style.display = 'block';
        showUserNotification('You are offline. Some features may not work.', 'warning');
    });
}

function setupQuickActions() {
    updateQuickActions(currentSection);
}

function updateQuickActions(section) {
    const buttons = document.querySelectorAll('.quick-action-btn');
    buttons.forEach(btn => {
        if (btn.getAttribute('data-section') === section) {
            btn.classList.add('active');
        } else {
            btn.classList.remove('active');
        }
    });
}

function setupMobileSearch() {
    const searchInput = document.getElementById('mobileSearchInput');
    if (searchInput) {
        searchInput.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            searchCurrentSection(searchTerm);
        });
    }
}

function searchCurrentSection(term) {
    // Search implementation based on current section
    switch(currentSection) {
        case 'myRequests':
            searchMyRequests(term);
            break;
        case 'viewAllRoster':
            searchAllRoster(term);
            break;
        case 'adminRequestHistory':
            searchRequestHistory(term);
            break;
        // Add more cases as needed
    }
}

function setupBottomSheet() {
    const closeBottomSheet = document.getElementById('closeBottomSheet');
    const bottomSheetOverlay = document.getElementById('bottomSheetOverlay');
    
    if (closeBottomSheet) {
        closeBottomSheet.addEventListener('click', closeBottomSheetFunc);
    }
    
    if (bottomSheetOverlay) {
        bottomSheetOverlay.addEventListener('click', closeBottomSheetFunc);
    }
}

// ============================================
// SESSION MANAGEMENT
// ============================================

function checkSession() {
    const session = localStorage.getItem('dutySystemSession');
    if (session) {
        try {
            const user = JSON.parse(session);
            if (user.expiry > Date.now()) {
                loginUser(user);
            } else {
                localStorage.removeItem('dutySystemSession');
            }
        } catch (e) {
            console.error('Session parse error:', e);
            localStorage.removeItem('dutySystemSession');
        }
    }
}

function handleLogin() {
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value.trim();
    const errorMsg = document.getElementById('errorMessage');
    
    if (!username || !password) {
        showError('Please enter both username and password');
        return;
    }
    
    if (!users || !Array.isArray(users)) {
        showError('User database not loaded');
        return;
    }
    
    const user = users.find(u => u.username === username);
    
    if (!user) {
        showError('Invalid username or password');
        return;
    }
    
    // Hash and check password
    const hashedPassword = sha256(password);
    
    if (hashedPassword === user.passwordHash) {
        const sessionData = {
            username: user.username,
            name: user.name,
            rcNo: user.RCNo,
            level: user.Level,
            expiry: Date.now() + (8 * 60 * 60 * 1000) // 8 hours
        };
        
        localStorage.setItem('dutySystemSession', JSON.stringify(sessionData));
        loginUser(sessionData);
    } else {
        showError('Invalid username or password');
    }
}

function showError(message) {
    const errorMsg = document.getElementById('errorMessage');
    if (errorMsg) {
        errorMsg.textContent = message;
        errorMsg.style.display = 'block';
        setTimeout(() => {
            errorMsg.style.display = 'none';
        }, 5000);
    }
}

function loginUser(userData) {
    currentUser = userData;
    allUsers = users || [];
    
    // Initialize user display name map
    initializeUserDisplayMap();
    
    // Update UI
    document.getElementById('loginContainer').style.display = 'none';
    document.getElementById('dashboardContainer').style.display = 'block';
    
    // Update user info
    updateUserInfo(userData);
    
    // Show/hide admin sections
    setupAdminSections(userData.level);
    
    // Initialize data and UI
    initializeData();
    setupEventListeners();
    updateDashboard();
    
    // Show welcome message
    showUserNotification(`Welcome back, ${userData.name}!`, 'success');
}

function updateUserInfo(userData) {
    const elements = {
        'userName': userData.name,
        'userRC': userData.rcNo,
        'userLevel': userData.level,
        'welcomeName': userData.name,
        'mobileUserName': userData.name,
        'mobileUserRC': userData.rcNo,
        'mobileUserLevel': userData.level
    };
    
    for (const [id, value] of Object.entries(elements)) {
        const element = document.getElementById(id);
        if (element) {
            element.textContent = value;
        }
    }
}

function initializeUserDisplayMap() {
    userDisplayNameMap = {};
    allUsers.forEach(user => {
        // Map common display names to usernames
        userDisplayNameMap[user.name] = user.username;
        userDisplayNameMap[user.RCNo] = user.username;
        userDisplayNameMap[user.username] = user.username;
        
        // Map lowercase versions
        userDisplayNameMap[user.name.toLowerCase()] = user.username;
        userDisplayNameMap[user.username.toLowerCase()] = user.username;
    });
}

function setupAdminSections(userLevel) {
    const adminElements = [
        'adminDutyRosterBtn', 'mobileAdminDutyRosterBtn',
        'adminLeaveBalanceBtn', 'mobileAdminLeaveBalanceBtn',
        'adminApprovalsBtn', 'mobileAdminApprovalsBtn',
        'adminRequestHistoryBtn', 'mobileAdminRequestHistoryBtn',
        'adminAnnouncementsBtn', 'mobileAdminAnnouncementsBtn'
    ];
    
    if (userLevel === 'Supervisor') {
        adminElements.forEach(id => {
            const element = document.getElementById(id);
            if (element) element.style.display = 'inline-block';
        });
    }
    
    // Always show these to all users
    const alwaysShow = ['viewAllRosterBtn', 'mobilePendingRequestsBtn'];
    alwaysShow.forEach(id => {
        const element = document.getElementById(id);
        if (element) element.style.display = 'inline-block';
    });
}

// ============================================
// DATA INITIALIZATION
// ============================================

function initializeData() {
    // Load data from localStorage
    loadDutyRoster();
    loadLeaveBalances();
    loadAllRequests();
    loadAnnouncements();
    
    // Update user's balance display
    updateUserBalance();
}

function loadDutyRoster() {
    const savedRoster = localStorage.getItem('dutyRosterData');
    if (savedRoster) {
        try {
            dutyRoster = JSON.parse(savedRoster);
        } catch (e) {
            console.error('Error parsing duty roster:', e);
            dutyRoster = {};
        }
    } else {
        dutyRoster = {};
    }
    saveDutyRoster(); // Ensure it's saved
}

function saveDutyRoster() {
    localStorage.setItem('dutyRosterData', JSON.stringify(dutyRoster));
    
    // Save to Firebase if available
    if (typeof db !== 'undefined') {
        try {
            db.collection('dutyRoster').doc('current').set(dutyRoster);
        } catch (error) {
            console.log('Firebase save skipped:', error);
        }
    }
}

function loadLeaveBalances() {
    const savedBalances = localStorage.getItem('leaveBalancesData');
    if (savedBalances) {
        try {
            leaveBalances = JSON.parse(savedBalances);
        } catch (e) {
            console.error('Error parsing leave balances:', e);
            leaveBalances = {};
        }
    } else {
        // Initialize with default balances
        leaveBalances = {};
        allUsers.forEach(user => {
            leaveBalances[user.username] = {
                SL: 12,  // 12 days Sick Leave
                FRL: 6   // 6 days FRL
            };
        });
        saveLeaveBalances();
    }
}

function saveLeaveBalances() {
    localStorage.setItem('leaveBalancesData', JSON.stringify(leaveBalances));
    
    if (typeof db !== 'undefined') {
        try {
            db.collection('leaveBalances').doc('current').set(leaveBalances);
        } catch (error) {
            console.log('Firebase save skipped:', error);
        }
    }
}

function loadAllRequests() {
    const savedRequests = localStorage.getItem('dutyRequestsData');
    if (savedRequests) {
        try {
            allRequests = JSON.parse(savedRequests);
        } catch (e) {
            console.error('Error parsing requests:', e);
            allRequests = [];
        }
    } else {
        allRequests = [];
    }
    
    updateRequestCounts();
}

function saveAllRequests() {
    localStorage.setItem('dutyRequestsData', JSON.stringify(allRequests));
    
    if (typeof db !== 'undefined') {
        try {
            db.collection('requests').doc('all').set({requests: allRequests});
        } catch (error) {
            console.log('Firebase save skipped:', error);
        }
    }
}

function loadAnnouncements() {
    const savedAnnouncements = localStorage.getItem('dutyAnnouncementsData');
    if (savedAnnouncements) {
        try {
            announcements = JSON.parse(savedAnnouncements);
        } catch (e) {
            console.error('Error parsing announcements:', e);
            announcements = [];
        }
    } else {
        announcements = [];
        saveAnnouncements();
    }
}

function saveAnnouncements() {
    localStorage.setItem('dutyAnnouncementsData', JSON.stringify(announcements));
    
    if (typeof db !== 'undefined') {
        try {
            db.collection('announcements').doc('all').set({announcements: announcements});
        } catch (error) {
            console.log('Firebase save skipped:', error);
        }
    }
}

function updateUserBalance() {
    if (!currentUser) return;
    
    const balance = leaveBalances[currentUser.username] || {SL: 0, FRL: 0};
    document.getElementById('slBalance').textContent = balance.SL.toFixed(1);
    document.getElementById('frlBalance').textContent = balance.FRL.toFixed(1);
}

// ============================================
// NAVIGATION AND SECTION MANAGEMENT
// ============================================

function showSection(sectionId) {
    // Hide all sections
    document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
    });
    
    // Update mobile menu active item
    document.querySelectorAll('.mobile-nav-item').forEach(item => {
        item.classList.remove('active');
    });
    const activeNavItem = document.querySelector(`.mobile-nav-item[data-section="${sectionId}"]`);
    if (activeNavItem) activeNavItem.classList.add('active');
    
    // Update desktop navigation
    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    const activeNavBtn = document.querySelector(`.nav-btn[data-section="${sectionId}"]`);
    if (activeNavBtn) activeNavBtn.classList.add('active');
    
    // Show selected section
    const section = document.getElementById(sectionId + 'Section');
    if (section) {
        section.classList.add('active');
        currentSection = sectionId;
        
        // Update quick actions
        updateQuickActions(sectionId);
        updateSwipeIndicator();
        
        // Update mobile header title
        updateMobileHeaderTitle(sectionId);
        
        // Load section data
        loadSectionData(sectionId);
        
        // Scroll to top
        const dashboardContent = document.getElementById('dashboardContent');
        if (dashboardContent) dashboardContent.scrollTo(0, 0);
        
        // Hide search bar if open
        const searchBar = document.getElementById('mobileSearchBar');
        if (searchBar) searchBar.classList.remove('active');
    }
}

function updateMobileHeaderTitle(sectionId) {
    const titles = {
        'home': 'Dashboard',
        'dutyChange': 'Duty Change',
        'leaveApplication': 'Apply Leave',
        'myRequests': 'My Requests',
        'viewMyRoster': 'My Roster',
        'viewAllRoster': 'All Roster',
        'pendingRequests': 'Pending Requests',
        'adminDutyRoster': 'Duty Roster',
        'adminLeaveBalance': 'Leave Balance',
        'adminApprovals': 'Approvals',
        'adminRequestHistory': 'Request History',
        'adminAnnouncements': 'Announcements'
    };
    
    const mobileUserName = document.getElementById('mobileUserName');
    if (mobileUserName) {
        mobileUserName.textContent = titles[sectionId] || 'Duty System';
    }
}

function loadSectionData(sectionId) {
    switch(sectionId) {
        case 'home':
            loadHomeAnnouncements();
            updateDashboard();
            break;
        case 'dutyChange':
            loadDutyChangeForm();
            break;
        case 'leaveApplication':
            loadLeaveForm();
            break;
        case 'myRequests':
            loadMyRequests();
            break;
        case 'viewMyRoster':
            loadMyRoster();
            break;
        case 'viewAllRoster':
            loadAllRoster();
            break;
        case 'pendingRequests':
            loadPendingRequests();
            break;
        case 'adminAnnouncements':
            loadAnnouncementsAdmin();
            break;
        case 'adminDutyRoster':
            loadDutyRosterAdmin();
            break;
        case 'adminLeaveBalance':
            loadLeaveBalanceAdmin();
            break;
        case 'adminApprovals':
            loadAdminApprovals();
            break;
        case 'adminRequestHistory':
            loadAdminRequestHistory();
            break;
    }
}

// ============================================
// EVENT LISTENERS SETUP
// ============================================

function setupEventListeners() {
    // Duty Change Form
    const dutyChangeForm = document.getElementById('dutyChangeForm');
    if (dutyChangeForm) {
        dutyChangeForm.addEventListener('submit', function(e) {
            e.preventDefault();
            submitDutyChange();
        });
    }
    
    // Leave Application Form
    const leaveApplicationForm = document.getElementById('leaveApplicationForm');
    if (leaveApplicationForm) {
        leaveApplicationForm.addEventListener('submit', function(e) {
            e.preventDefault();
            submitLeaveApplication();
        });
    }
    
    // Announcement Form
    const announcementForm = document.getElementById('announcementForm');
    if (announcementForm) {
        announcementForm.addEventListener('submit', function(e) {
            e.preventDefault();
            createAnnouncement();
        });
    }
    
    // Date change handlers
    document.getElementById('changeDate')?.addEventListener('change', function() {
        loadUserDutyTimes('changeDutyTime', this.value);
    });
    
    document.getElementById('requestToStaff')?.addEventListener('change', function() {
        const user = allUsers.find(u => u.username === this.value);
        if (user) {
            document.getElementById('requestToRcNo').value = user.RCNo;
            const date = document.getElementById('changeDate').value;
            if (date) {
                loadStaffDutyTimes('requestToDutyTime', date, user.username);
            }
        }
    });
    
    document.getElementById('leaveDate')?.addEventListener('change', function() {
        loadUserDutyTimes('leaveDutyTime', this.value);
        updateLeaveRules();
    });
    
    document.getElementById('leaveType')?.addEventListener('change', updateLeaveRules);
    document.getElementById('leaveDutyTime')?.addEventListener('change', updateLeaveRules);
    
    // Roster view type change
    document.getElementById('myRosterViewType')?.addEventListener('change', function() {
        loadMyRoster();
    });
    
    // Target audience radio buttons
    document.querySelectorAll('input[name="target"]').forEach(radio => {
        radio.addEventListener('change', updateTargetSelection);
    });
    
    // Logout button
    document.getElementById('logoutBtn')?.addEventListener('click', function() {
        localStorage.removeItem('dutySystemSession');
        location.reload();
    });
    
    // Navigation buttons
    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            const sectionId = this.getAttribute('data-section');
            showSection(sectionId);
        });
    });
    
    // Mobile form submissions
    setupMobileFormListeners();
}

function setupMobileFormListeners() {
    // Mobile form submission
    document.addEventListener('submit', function(e) {
        if (e.target.id === 'mobileForm') {
            e.preventDefault();
            // Handle mobile form submission
            closeBottomSheetFunc();
        }
    });
}

// ============================================
// DUTY CHANGE FUNCTIONALITY
// ============================================

function loadDutyChangeForm() {
    // Set default date to tomorrow
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    const dateInput = document.getElementById('changeDate');
    if (dateInput) dateInput.value = tomorrow.toISOString().split('T')[0];
    
    // Populate staff dropdown (exclude current user)
    const staffSelect = document.getElementById('requestToStaff');
    if (staffSelect) {
        staffSelect.innerHTML = '<option value="">Select staff member</option>';
        
        allUsers.forEach(user => {
            if (user.username !== currentUser.username && user.Level === 'User') {
                const option = document.createElement('option');
                option.value = user.username;
                option.textContent = `${user.name} (RC: ${user.RCNo})`;
                staffSelect.appendChild(option);
            }
        });
    }
    
    // Load duty times
    loadUserDutyTimes('changeDutyTime', tomorrow.toISOString().split('T')[0]);
}

function loadUserDutyTimes(selectId, date) {
    const select = document.getElementById(selectId);
    if (!select) return;
    
    select.innerHTML = '<option value="">Select duty time</option>';
    
    if (!date || !currentUser) return;
    
    const dutyTime = dutyRoster[date] && dutyRoster[date][currentUser.username];
    if (dutyTime) {
        const option = document.createElement('option');
        option.value = dutyTime;
        option.textContent = dutyTime === 'Off' ? 'Off Duty' : dutyTime;
        select.appendChild(option);
    } else {
        const option = document.createElement('option');
        option.value = 'No Duty';
        option.textContent = 'No duty scheduled';
        select.appendChild(option);
    }
}

function loadStaffDutyTimes(selectId, date, username) {
    const select = document.getElementById(selectId);
    if (!select) return;
    
    select.innerHTML = '<option value="">Select duty time</option>';
    
    if (!date || !username) return;
    
    const dutyTime = dutyRoster[date] && dutyRoster[date][username];
    if (dutyTime) {
        const option = document.createElement('option');
        option.value = dutyTime;
        option.textContent = dutyTime === 'Off' ? 'Off Duty' : dutyTime;
        select.appendChild(option);
    } else {
        const option = document.createElement('option');
        option.value = 'No Duty';
        option.textContent = 'No duty scheduled';
        select.appendChild(option);
    }
}

function submitDutyChange() {
    const date = document.getElementById('changeDate').value;
    const dutyTime = document.getElementById('changeDutyTime').value;
    const toStaff = document.getElementById('requestToStaff').value;
    const toRcNo = document.getElementById('requestToRcNo').value;
    const toDutyTime = document.getElementById('requestToDutyTime').value;
    const reason = document.getElementById('changeReason').value;
    
    if (!date || !dutyTime || !toStaff || !toDutyTime) {
        alert('Please fill all required fields');
        return;
    }
    
    if (dutyTime === 'No Duty' || toDutyTime === 'No Duty') {
        alert('Cannot request duty change when no duty is scheduled');
        return;
    }
    
    const toUser = allUsers.find(u => u.username === toStaff);
    if (!toUser) {
        alert('Selected staff not found');
        return;
    }
    
    const request = {
        id: 'req_' + Date.now(),
        type: 'dutyChange',
        fromUsername: currentUser.username,
        fromName: currentUser.name,
        fromRcNo: currentUser.rcNo,
        date: date,
        dutyTime: dutyTime,
        toUsername: toStaff,
        toName: toUser.name,
        toRcNo: toRcNo,
        toDutyTime: toDutyTime,
        reason: reason,
        status: 'pending',
        timestamp: new Date().toISOString(),
        history: [{
            action: 'created',
            by: currentUser.name,
            timestamp: new Date().toISOString()
        }]
    };
    
    allRequests.push(request);
    saveAllRequests();
    updateRequestCounts();
    
    alert('Duty change request submitted!');
    showSection('home');
    document.getElementById('dutyChangeForm').reset();
    
    // Reset date to tomorrow
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    document.getElementById('changeDate').value = tomorrow.toISOString().split('T')[0];
}

// ============================================
// LEAVE APPLICATION FUNCTIONALITY
// ============================================

function loadLeaveForm() {
    // Set default date to tomorrow
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    const dateInput = document.getElementById('leaveDate');
    if (dateInput) dateInput.value = tomorrow.toISOString().split('T')[0];
    
    // Load duty times
    loadUserDutyTimes('leaveDutyTime', tomorrow.toISOString().split('T')[0]);
    
    updateLeaveRules();
}

function updateLeaveRules() {
    const leaveType = document.getElementById('leaveType')?.value;
    const leaveDate = document.getElementById('leaveDate')?.value;
    const dutyTime = document.getElementById('leaveDutyTime')?.value;
    const alertDiv = document.getElementById('leaveRulesAlert');
    const submitBtn = document.getElementById('submitLeaveBtn');
    
    if (!alertDiv || !submitBtn) return;
    
    if (!leaveType || !leaveDate || !dutyTime || dutyTime === 'No Duty') {
        alertDiv.className = 'alert alert-warning';
        alertDiv.textContent = 'Please select leave type, date and duty time';
        submitBtn.disabled = true;
        return;
    }
    
    if (dutyTime === 'Off') {
        alertDiv.className = 'alert alert-warning';
        alertDiv.textContent = 'You are off duty on this date. No leave needed.';
        submitBtn.disabled = true;
        return;
    }
    
    const dutyStart = dutyTime.split('-')[0];
    const dutyDateTime = new Date(leaveDate + 'T' + dutyStart + ':00');
    const now = new Date();
    const hoursBeforeDuty = (dutyDateTime - now) / (1000 * 60 * 60);
    
    let canApply = false;
    let message = '';
    
    if (leaveType === 'Sick Leave') {
        canApply = hoursBeforeDuty >= 2;
        message = canApply 
            ? 'âœ“ You can apply for Sick Leave (2+ hours before duty)'
            : `âœ— Sick Leave must be applied at least 2 hours before duty (${Math.ceil(2 - hoursBeforeDuty)} more hours needed)`;
    } else if (leaveType === 'FRL') {
        canApply = hoursBeforeDuty >= 1;
        message = canApply
            ? 'âœ“ You can apply for FRL (1+ hour before duty)'
            : `âœ— FRL must be applied at least 1 hour before duty (${Math.ceil(1 - hoursBeforeDuty)} more hours needed)`;
    }
    
    alertDiv.className = canApply ? 'alert alert-success' : 'alert alert-danger';
    alertDiv.innerHTML = `<strong>${leaveType} Rules:</strong><br>${message}`;
    submitBtn.disabled = !canApply;
}

function submitLeaveApplication() {
    const leaveType = document.getElementById('leaveType').value;
    const date = document.getElementById('leaveDate').value;
    const dutyTime = document.getElementById('leaveDutyTime').value;
    const duration = parseFloat(document.getElementById('leaveDuration').value);
    const reason = document.getElementById('leaveReason').value;
    
    if (!leaveType || !date || !dutyTime || !reason) {
        alert('Please fill all required fields');
        return;
    }
    
    if (dutyTime === 'No Duty' || dutyTime === 'Off') {
        alert('You are off duty on this date. No leave needed.');
        return;
    }
    
    // Check balance
    const userBalance = leaveBalances[currentUser.username];
    if (!userBalance) {
        alert('Error: User balance not found');
        return;
    }
    
    // Validate sufficient balance
    if (leaveType === 'Sick Leave' && userBalance.SL < duration) {
        alert(`Insufficient Sick Leave balance. Available: ${userBalance.SL.toFixed(1)} days, Requested: ${duration} days`);
        return;
    }
    
    if (leaveType === 'FRL' && userBalance.FRL < duration) {
        alert(`Insufficient FRL balance. Available: ${userBalance.FRL.toFixed(1)} days, Requested: ${duration} days`);
        return;
    }
    
    const request = {
        id: 'req_' + Date.now(),
        type: 'leave',
        leaveType: leaveType,
        fromUsername: currentUser.username,
        fromName: currentUser.name,
        fromRcNo: currentUser.rcNo,
        date: date,
        dutyTime: dutyTime,
        duration: duration,
        reason: reason,
        status: 'pending',
        timestamp: new Date().toISOString(),
        history: [{
            action: 'created',
            by: currentUser.name,
            timestamp: new Date().toISOString()
        }]
    };
    
    allRequests.push(request);
    saveAllRequests();
    updateRequestCounts();
    
    alert('Leave application submitted! It will be processed after supervisor approval.');
    showSection('home');
    document.getElementById('leaveApplicationForm').reset();
    
    // Force dashboard update
    updateDashboard();
    updateUserBalance();
}

// ============================================
// MY REQUESTS FUNCTIONALITY
// ============================================

function loadMyRequests() {
    const tbody = document.getElementById('myRequestsTable');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    const myReqs = allRequests.filter(req => req.fromUsername === currentUser.username);
    
    if (myReqs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No requests found</td></tr>';
        return;
    }
    
    // Sort by timestamp descending (newest first)
    myReqs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    
    myReqs.forEach(req => {
        const tr = document.createElement('tr');
        
        let details = '';
        if (req.type === 'dutyChange') {
            details = `Swap with ${req.toName} (${req.toDutyTime})`;
            if (req.reason) details += `<br><small>Reason: ${req.reason}</small>`;
        } else {
            details = `${req.leaveType} - ${req.duration} day(s)`;
            if (req.reason) details += `<br><small>Reason: ${req.reason}</small>`;
        }
        
        let statusClass = 'status-' + req.status;
        let statusText = req.status.charAt(0).toUpperCase() + req.status.slice(1);
        
        // Get last update time
        let lastUpdate = 'Just now';
        if (req.history && req.history.length > 0) {
            const lastAction = req.history[req.history.length - 1];
            lastUpdate = formatTimeAgo(lastAction.timestamp);
        }
        
        tr.innerHTML = `
            <td>${req.type === 'dutyChange' ? 'Duty Change' : 'Leave'}</td>
            <td>${req.date}</td>
            <td>${details}</td>
            <td class="${statusClass}">${statusText}</td>
            <td class="timestamp">${lastUpdate}</td>
            <td>
                ${req.status === 'pending' ? 
                    `<button class="action-btn view" onclick="cancelRequest('${req.id}')">Cancel</button>` : ''}
                ${req.status === 'approved' ? 
                    `<span class="status-approved">âœ“ Applied</span>` : ''}
            </td>
        `;
        
        tbody.appendChild(tr);
    });
}

function cancelRequest(requestId) {
    if (confirm('Are you sure you want to cancel this request?')) {
        const request = allRequests.find(req => req.id === requestId);
        if (request) {
            request.status = 'cancelled';
            request.history.push({
                action: 'cancelled',
                by: currentUser.name,
                timestamp: new Date().toISOString()
            });
            saveAllRequests();
            loadMyRequests();
            updateRequestCounts();
        }
    }
}

// ============================================
// MY ROSTER FUNCTIONALITY
// ============================================

function loadMyRoster() {
    const container = document.getElementById('myRosterContainer');
    const monthInput = document.getElementById('myRosterMonth').value;
    const viewType = document.getElementById('myRosterViewType').value;
    
    if (!container) return;
    
    if (!monthInput) {
        container.innerHTML = '<div class="alert alert-warning">Please select a month</div>';
        return;
    }
    
    const [year, month] = monthInput.split('-');
    const startDate = new Date(year, month - 1, 1);
    const endDate = new Date(year, month, 0);
    
    if (viewType === 'calendar') {
        displayCalendarView(container, startDate, endDate, year, month, true);
    } else {
        displayTableView(container, startDate, endDate, year, month, true);
    }
}

function displayTableView(container, startDate, endDate, year, month, isMyRoster = false) {
    let html = `<h4>${isMyRoster ? 'Your Roster' : 'Staff Roster'} for ${month}/${year}</h4>`;
    
    if (isMyRoster) {
        html += '<div class="table-container"><table><thead><tr><th>Date</th><th>Day</th><th>Duty Time</th><th>Status</th></tr></thead><tbody>';
        
        const today = new Date().toISOString().split('T')[0];
        let dutyCount = 0;
        let offCount = 0;
        
        for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
            const dateStr = d.toISOString().split('T')[0];
            const dayName = d.toLocaleDateString('en-US', { weekday: 'short' });
            
            let dutyTime = 'Not Scheduled';
            let statusClass = '';
            let statusText = '';
            
            // Check for approved leave
            const approvedLeave = allRequests.find(req => 
                req.fromUsername === currentUser.username &&
                req.type === 'leave' &&
                req.status === 'approved' &&
                req.date === dateStr
            );
            
            if (approvedLeave) {
                dutyTime = `${approvedLeave.leaveType} - ${approvedLeave.duration} day(s)`;
                statusClass = 'status-approved';
                statusText = 'On Leave';
            } else if (dutyRoster[dateStr] && dutyRoster[dateStr][currentUser.username]) {
                dutyTime = dutyRoster[dateStr][currentUser.username];
                if (dutyTime === 'Off') {
                    statusClass = 'status-off';
                    statusText = 'Off Duty';
                    offCount++;
                } else {
                    statusClass = dateStr < today ? 'status-completed' : 'status-pending';
                    statusText = dateStr < today ? 'Completed' : 'Scheduled';
                    dutyCount++;
                }
            } else {
                statusClass = 'status-pending';
                statusText = 'Not Scheduled';
            }
            
            const isToday = dateStr === today;
            const rowClass = isToday ? 'style="background-color: #fff3cd;"' : '';
            
            html += `<tr ${rowClass}>
                <td>${dateStr}${isToday ? ' <strong>(Today)</strong>' : ''}</td>
                <td>${dayName}</td>
                <td>${dutyTime}</td>
                <td class="${statusClass}">${statusText}</td>
            </tr>`;
        }
        
        html += '</tbody></table></div>';
        
        // Add summary
        html += `<div class="alert alert-info" style="margin-top: 15px;">
            <strong>Summary:</strong> ${dutyCount} duty days, ${offCount} off days
        </div>`;
    } else {
        // Display all staff roster
        html += displayAllRosterTable(startDate, endDate, year, month);
    }
    
    container.innerHTML = html;
}

function displayCalendarView(container, startDate, endDate, year, month, isMyRoster = false) {
    let html = `<h4>${isMyRoster ? 'Your Roster' : 'Staff Roster'} for ${month}/${year} - Calendar View</h4>`;
    html += '<div class="calendar-grid">';
    
    // Add day headers
    const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    days.forEach(day => {
        html += `<div class="calendar-day" style="text-align: center; font-weight: bold;">${day}</div>`;
    });
    
    // Get first day of month (0 = Sunday, 1 = Monday, etc.)
    const firstDay = startDate.getDay();
    
    // Add empty cells for days before the first day of month
    for (let i = 0; i < firstDay; i++) {
        html += '<div class="calendar-day"></div>';
    }
    
    const today = new Date().toISOString().split('T')[0];
    
    // Add calendar days
    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
        const dateStr = d.toISOString().split('T')[0];
        const dayNum = d.getDate();
        const isToday = dateStr === today;
        
        let dayClass = 'calendar-day';
        let timeClass = '';
        let timeText = '';
        
        if (isMyRoster) {
            // Check for approved leave
            const approvedLeave = allRequests.find(req => 
                req.fromUsername === currentUser.username &&
                req.type === 'leave' &&
                req.status === 'approved' &&
                req.date === dateStr
            );
            
            if (approvedLeave) {
                dayClass += ' off-day';
                timeClass = 'off-time';
                timeText = `${approvedLeave.leaveType === 'Sick Leave' ? 'SL' : 'FRL'}`;
            } else if (dutyRoster[dateStr] && dutyRoster[dateStr][currentUser.username]) {
                const dutyTime = dutyRoster[dateStr][currentUser.username];
                if (dutyTime === 'Off') {
                    dayClass += ' off-day';
                    timeClass = 'off-time';
                    timeText = 'Off';
                } else {
                    dayClass += ' duty-day';
                    timeClass = 'duty-time';
                    timeText = dutyTime;
                }
            }
        }
        
        if (isToday) {
            dayClass += ' today';
        }
        
        html += `<div class="${dayClass}">
            <div class="day-header">${dayNum}</div>
            <div class="${timeClass}">${timeText}</div>
        </div>`;
    }
    
    html += '</div>';
    container.innerHTML = html;
}

// ============================================
// VIEW ALL ROSTER FUNCTIONALITY
// ============================================

function loadAllRoster() {
    const container = document.getElementById('allRosterContainer');
    const startDate = document.getElementById('allRosterStartDate').value;
    const endDate = document.getElementById('allRosterEndDate').value;
    const viewType = document.getElementById('allRosterViewType').value;
    
    if (!container) return;
    
    if (!startDate || !endDate) {
        container.innerHTML = '<div class="alert alert-warning">Please select start and end dates</div>';
        return;
    }
    
    const start = new Date(startDate);
    const end = new Date(endDate);
    
    if (start > end) {
        container.innerHTML = '<div class="alert alert-warning">Start date must be before end date</div>';
        return;
    }
    
    if (viewType === 'calendar') {
        displayAllRosterCalendar(container, start, end);
    } else if (viewType === 'staff') {
        displayAllRosterByStaff(container, start, end);
    } else {
        displayAllRosterDaily(container, start, end);
    }
}

function displayAllRosterDaily(container, startDate, endDate) {
    let html = `<h4>Complete Duty Roster (${startDate.toISOString().split('T')[0]} to ${endDate.toISOString().split('T')[0]})</h4>`;
    
    // Create date navigation
    const prevStart = new Date(startDate);
    prevStart.setDate(prevStart.getDate() - 7);
    const prevEnd = new Date(endDate);
    prevEnd.setDate(prevEnd.getDate() - 7);
    const nextStart = new Date(startDate);
    nextStart.setDate(nextStart.getDate() + 7);
    const nextEnd = new Date(endDate);
    nextEnd.setDate(nextEnd.getDate() + 7);
    
    html += `<div class="date-navigation">
        <button class="date-nav-btn" onclick="navigateAllRoster('${prevStart.toISOString().split('T')[0]}', '${prevEnd.toISOString().split('T')[0]}')">â† Previous Week</button>
        <span class="current-date-display">${formatDateRange(startDate, endDate)}</span>
        <button class="date-nav-btn" onclick="navigateAllRoster('${nextStart.toISOString().split('T')[0]}', '${nextEnd.toISOString().split('T')[0]}')">Next Week â†’</button>
    </div>`;
    
    // Create table
    html += '<div class="roster-all-view"><table><thead><tr><th>Date</th><th>Day</th>';
    
    // Add staff headers
    allUsers.forEach(user => {
        if (user.Level === 'User') {
            html += `<th class="staff-name">${user.name}<br><small>${user.RCNo}</small></th>`;
        }
    });
    
    html += '</tr></thead><tbody>';
    
    const today = new Date().toISOString().split('T')[0];
    
    // Add rows for each date
    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
        const dateStr = d.toISOString().split('T')[0];
        const dayName = d.toLocaleDateString('en-US', { weekday: 'short' });
        const isToday = dateStr === today;
        
        html += `<tr ${isToday ? 'style="background-color: #fff3cd;"' : ''}>`;
        html += `<td>${dateStr}${isToday ? ' <strong>(Today)</strong>' : ''}</td>`;
        html += `<td>${dayName}</td>`;
        
        // Add duty times for each staff
        allUsers.forEach(user => {
            if (user.Level === 'User') {
                let dutyTime = 'Not Scheduled';
                let cellClass = '';
                let leaveIndicator = '';
                
                // Check for approved leave
                const approvedLeave = allRequests.find(req => 
                    req.fromUsername === user.username &&
                    req.type === 'leave' &&
                    req.status === 'approved' &&
                    req.date === dateStr
                );
                
                if (approvedLeave) {
                    dutyTime = 'Leave';
                    cellClass = 'duty-leave';
                    leaveIndicator = `<span class="leave-indicator" title="${approvedLeave.leaveType} - ${approvedLeave.duration} day(s)">${approvedLeave.leaveType === 'Sick Leave' ? 'SL' : 'FRL'}</span>`;
                } else if (dutyRoster[dateStr] && dutyRoster[dateStr][user.username]) {
                    dutyTime = dutyRoster[dateStr][user.username];
                    cellClass = getDutyTimeClass(dutyTime);
                } else {
                    cellClass = 'off-day-cell';
                    dutyTime = 'Off';
                }
                
                if (isToday) {
                    cellClass += ' today-cell';
                }
                
                html += `<td class="${cellClass}">${dutyTime} ${leaveIndicator}</td>`;
            }
        });
        
        html += '</tr>';
    }
    
    html += '</tbody></table></div>';
    
    // Add summary statistics
    html += generateRosterSummary(startDate, endDate);
    
    container.innerHTML = html;
}

function getDutyTimeClass(dutyTime) {
    if (!dutyTime) return 'off-day-cell';
    
    if (dutyTime === 'Off') return 'off-day-cell';
    if (dutyTime === 'Leave' || dutyTime.includes('Leave')) return 'duty-leave';
    
    // Normalize the duty time format
    const normalizedTime = dutyTime.replace(/\s/g, '').toUpperCase();
    
    // Try exact match
    if (dutyTimeColorMap[normalizedTime]) {
        return dutyTimeColorMap[normalizedTime];
    }
    
    // Try to match known patterns
    for (const key in dutyTimeColorMap) {
        if (normalizedTime.includes(key) || key.includes(normalizedTime.substring(0, 4))) {
            return dutyTimeColorMap[key];
        }
    }
    
    return 'duty-other';
}

function displayAllRosterByStaff(container, startDate, endDate) {
    let html = `<h4>Staff Duty Summary (${startDate.toISOString().split('T')[0]} to ${endDate.toISOString().split('T')[0]})</h4>`;
    
    html += '<div class="table-container"><table><thead><tr><th>Staff</th><th>RC No</th><th>Duty Days</th><th>Off Days</th><th>Leave Days</th><th>Details</th></tr></thead><tbody>';
    
    allUsers.forEach(user => {
        if (user.Level === 'User') {
            let dutyDays = 0;
            let offDays = 0;
            let leaveDays = 0;
            let details = [];
            
            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                const dateStr = d.toISOString().split('T')[0];
                
                // Check for approved leave
                const approvedLeave = allRequests.find(req => 
                    req.fromUsername === user.username &&
                    req.type === 'leave' &&
                    req.status === 'approved' &&
                    req.date === dateStr
                );
                
                if (approvedLeave) {
                    leaveDays += approvedLeave.duration;
                    details.push(`${dateStr}: ${approvedLeave.leaveType} (${approvedLeave.duration} day)`);
                } else if (dutyRoster[dateStr] && dutyRoster[dateStr][user.username]) {
                    if (dutyRoster[dateStr][user.username] === 'Off') {
                        offDays++;
                    } else {
                        dutyDays++;
                        details.push(`${dateStr}: ${dutyRoster[dateStr][user.username]}`);
                    }
                }
            }
            
            html += `<tr>
                <td class="staff-name">${user.name}</td>
                <td>${user.RCNo}</td>
                <td>${dutyDays}</td>
                <td>${offDays}</td>
                <td>${leaveDays}</td>
                <td><small>${details.slice(0, 3).join('<br>')}${details.length > 3 ? '<br>...' : ''}</small></td>
            </tr>`;
        }
    });
    
    html += '</tbody></table></div>';
    
    container.innerHTML = html;
}

function displayAllRosterCalendar(container, startDate, endDate) {
    let html = `<h4>Calendar View (${startDate.toISOString().split('T')[0]} to ${endDate.toISOString().split('T')[0]})</h4>`;
    
    // Group by week
    const weeks = [];
    let currentWeek = [];
    let currentDate = new Date(startDate);
    
    while (currentDate <= endDate) {
        currentWeek.push(new Date(currentDate));
        if (currentWeek.length === 7 || currentDate.getTime() === endDate.getTime()) {
            weeks.push([...currentWeek]);
            currentWeek = [];
        }
        currentDate.setDate(currentDate.getDate() + 1);
    }
    
    // Display each week
    weeks.forEach((week, weekIndex) => {
        html += `<h5>Week ${weekIndex + 1}</h5>`;
        html += '<div class="calendar-grid">';
        
        // Day headers
        const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        days.forEach(day => {
            html += `<div class="calendar-day" style="text-align: center; font-weight: bold; background: #f0f0f0;">${day}</div>`;
        });
        
        // Calendar cells
        week.forEach(day => {
            const dateStr = day.toISOString().split('T')[0];
            const dayNum = day.getDate();
            const isToday = dateStr === new Date().toISOString().split('T')[0];
            
            let dayClass = 'calendar-day';
            let dayContent = `<div class="day-header">${dayNum}</div>`;
            
            // Add staff duties for this day
            allUsers.forEach(user => {
                if (user.Level === 'User') {
                    let dutyInfo = '';
                    
                    // Check for approved leave
                    const approvedLeave = allRequests.find(req => 
                        req.fromUsername === user.username &&
                        req.type === 'leave' &&
                        req.status === 'approved' &&
                        req.date === dateStr
                    );
                    
                    if (approvedLeave) {
                        dutyInfo = `${user.name.substring(0, 3)}: ${approvedLeave.leaveType === 'Sick Leave' ? 'SL' : 'FRL'}<br>`;
                    } else if (dutyRoster[dateStr] && dutyRoster[dateStr][user.username]) {
                        const dutyTime = dutyRoster[dateStr][user.username];
                        if (dutyTime !== 'Off') {
                            dutyInfo = `${user.name.substring(0, 3)}: ${dutyTime.substring(0, 5)}<br>`;
                        }
                    }
                    
                    dayContent += `<div style="font-size: 10px;">${dutyInfo}</div>`;
                }
            });
            
            if (isToday) {
                dayClass += ' today';
            }
            
            html += `<div class="${dayClass}" style="min-height: 100px; overflow-y: auto;">${dayContent}</div>`;
        });
        
        html += '</div>';
    });
    
    container.innerHTML = html;
}

function navigateAllRoster(startDate, endDate) {
    document.getElementById('allRosterStartDate').value = startDate;
    document.getElementById('allRosterEndDate').value = endDate;
    loadAllRoster();
}

function formatDateRange(startDate, endDate) {
    const start = new Date(startDate);
    const end = new Date(endDate);
    return `${start.toLocaleDateString()} - ${end.toLocaleDateString()}`;
}

function generateRosterSummary(startDate, endDate) {
    let html = '<div class="alert alert-info" style="margin-top: 15px;">';
    html += '<strong>Summary Statistics:</strong><br>';
    
    const stats = {
        totalStaff: allUsers.filter(u => u.Level === 'User').length,
        totalDays: Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1,
        totalDutySlots: 0,
        totalOffSlots: 0,
        totalLeaveSlots: 0
    };
    
    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
        const dateStr = d.toISOString().split('T')[0];
        
        allUsers.forEach(user => {
            if (user.Level === 'User') {
                // Check for approved leave
                const approvedLeave = allRequests.find(req => 
                    req.fromUsername === user.username &&
                    req.type === 'leave' &&
                    req.status === 'approved' &&
                    req.date === dateStr
                );
                
                if (approvedLeave) {
                    stats.totalLeaveSlots++;
                } else if (dutyRoster[dateStr] && dutyRoster[dateStr][user.username]) {
                    if (dutyRoster[dateStr][user.username] === 'Off') {
                        stats.totalOffSlots++;
                    } else {
                        stats.totalDutySlots++;
                    }
                }
            }
        });
    }
    
    html += `â€¢ ${stats.totalStaff} staff members<br>`;
    html += `â€¢ ${stats.totalDays} days in period<br>`;
    html += `â€¢ ${stats.totalDutySlots} duty assignments<br>`;
    html += `â€¢ ${stats.totalOffSlots} off days<br>`;
    html += `â€¢ ${stats.totalLeaveSlots} leave days (${stats.totalLeaveSlots > 0 ? 'SL/FRL' : 'None'})`;
    html += '</div>';
    
    return html;
}

function printAllRoster() {
    const container = document.getElementById('allRosterContainer').innerHTML;
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
        <head>
            <title>Duty Roster Report</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                table { border-collapse: collapse; width: 100%; margin-top: 20px; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                th { background-color: #f2f2f2; }
                .leave-indicator { background-color: #ffeaa7; padding: 2px 5px; border-radius: 3px; font-size: 10px; }
                .duty-0730-1530 { background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); color: #856404; }
                .duty-0830-1630 { background: linear-gradient(135deg, #e2d9f3 0%, #d6c6f7 100%); color: #563d7c; }
                .duty-1030-1830 { background: linear-gradient(135deg, #fffde7 0%, #fff9c4 100%); color: #827717; }
                .duty-1530-2330 { background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); color: #0d47a1; }
                .duty-1630-0030 { background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%); color: #424242; }
                .duty-1730-0130 { background: linear-gradient(135deg, #eeeeee 0%, #bdbdbd 100%); color: #212121; }
                .duty-0030-0830 { background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%); color: #c62828; }
                .duty-leave { background: linear-gradient(135deg, #ffd8a6 0%, #ffc078 100%); color: #e8590c; border: 1px dashed #fd7e14; }
                .off-day-cell { background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); color: #155724; }
                .today-cell { border: 2px solid #3498db !important; box-shadow: 0 0 10px rgba(52, 152, 219, 0.3) !important; }
                h3 { color: #2c3e50; }
            </style>
        </head>
        <body>
            <h3>Duty Roster Report</h3>
            <p>Generated on: ${new Date().toLocaleString()}</p>
            <p>Generated by: ${currentUser.name}</p>
            ${container}
        </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
}

// ============================================
// PENDING REQUESTS FUNCTIONALITY
// ============================================

function loadPendingRequests() {
    const tbody = document.getElementById('pendingRequestsTable');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    const pendingReqs = allRequests.filter(req => 
        req.status === 'pending' && 
        req.type === 'dutyChange' && 
        req.toUsername === currentUser.username
    );
    
    if (pendingReqs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No pending requests</td></tr>';
        return;
    }
    
    pendingReqs.forEach(req => {
        const tr = document.createElement('tr');
        
        tr.innerHTML = `
            <td>${req.fromName}</td>
            <td>${req.date}</td>
            <td>Swap ${req.dutyTime} with ${req.toDutyTime}<br>
                <small>${req.reason || 'No reason provided'}</small>
            </td>
            <td class="action-buttons">
                <button class="action-btn approve" onclick="respondToRequest('${req.id}', 'approved')">Accept</button>
                <button class="action-btn reject" onclick="respondToRequest('${req.id}', 'rejected')">Reject</button>
            </td>
        `;
        
        tbody.appendChild(tr);
    });
}

function respondToRequest(requestId, response) {
    const request = allRequests.find(req => req.id === requestId);
    if (!request) return;
    
    if (response === 'approved') {
        // Swap duty times in roster
        const date = request.date;
        if (dutyRoster[date]) {
            const temp = dutyRoster[date][request.fromUsername];
            dutyRoster[date][request.fromUsername] = dutyRoster[date][request.toUsername];
            dutyRoster[date][request.toUsername] = temp;
            saveDutyRoster();
        }
    }
    
    request.status = response;
    request.respondedAt = new Date().toISOString();
    request.history.push({
        action: response,
        by: currentUser.name,
        timestamp: new Date().toISOString()
    });
    saveAllRequests();
    
    alert(`Request ${response} successfully!`);
    
    // Show notification on user dashboard
    showUserNotification(`Your duty change request for ${request.date} was ${response} by ${request.toName}`);
    
    showSection('home');
    updateRequestCounts();
}

function updateRequestCounts() {
    if (!currentUser) return;
    
    // Count pending requests for current user
    const pendingForUser = allRequests.filter(req => 
        req.status === 'pending' && 
        req.type === 'dutyChange' && 
        req.toUsername === currentUser.username
    ).length;
    
    // Update desktop notification badge
    const pendingBtn = document.getElementById('pendingRequestsBtn');
    const countSpan = document.getElementById('pendingCount');
    
    if (pendingBtn && countSpan) {
        if (pendingForUser > 0) {
            pendingBtn.style.display = 'inline-block';
            countSpan.textContent = pendingForUser;
        } else {
            pendingBtn.style.display = 'none';
        }
    }
    
    // Update mobile notification badge
    const mobilePendingBtn = document.getElementById('mobilePendingRequestsBtn');
    const mobileCountSpan = document.getElementById('mobilePendingCount');
    
    if (mobilePendingBtn && mobileCountSpan) {
        if (pendingForUser > 0) {
            mobilePendingBtn.style.display = 'inline-block';
            mobileCountSpan.textContent = pendingForUser;
        } else {
            mobilePendingBtn.style.display = 'none';
        }
    }
    
    // Update notification dot for supervisor
    if (currentUser.level === 'Supervisor') {
        const pendingRequests = allRequests.filter(req => 
            req.status === 'pending' && 
            (req.type === 'leave' || req.type === 'dutyChange')
        ).length;
        
        // Desktop notification dot
        const notificationDot = document.getElementById('historyNotification');
        if (notificationDot) {
            if (pendingRequests > 0) {
                notificationDot.style.display = 'inline-block';
            } else {
                notificationDot.style.display = 'none';
            }
        }
        
        // Mobile notification indicator
        const mobileNotificationIndicator = document.getElementById('mobileNotificationIndicator');
        if (mobileNotificationIndicator) {
            if (pendingRequests > 0) {
                mobileNotificationIndicator.style.display = 'block';
            } else {
                mobileNotificationIndicator.style.display = 'none';
            }
        }
    }
}

// ============================================
// ANNOUNCEMENTS FUNCTIONALITY
// ============================================

function loadAnnouncementsAdmin() {
    // Setup announcement form
    setupAnnouncementForm();
    
    // Load active announcements
    loadActiveAnnouncements();
    
    // Load expired announcements
    loadExpiredAnnouncements();
}

function setupAnnouncementForm() {
    // Populate staff dropdown for specific announcements
    const staffSelect = document.getElementById('announcementStaff');
    if (staffSelect) {
        staffSelect.innerHTML = '';
        
        allUsers.forEach(user => {
            if (user.Level === 'User') {
                const option = document.createElement('option');
                option.value = user.username;
                option.textContent = `${user.name} (${user.RCNo})`;
                staffSelect.appendChild(option);
            }
        });
    }
    
    // Setup priority buttons
    document.querySelectorAll('.priority-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            selectPriority(this.dataset.priority);
        });
    });
}

function selectPriority(priority) {
    // Update UI
    document.querySelectorAll('.priority-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    const activeBtn = document.querySelector(`.priority-btn[data-priority="${priority}"]`);
    if (activeBtn) activeBtn.classList.add('active');
    
    // Update hidden input
    const priorityInput = document.getElementById('announcementPriority');
    if (priorityInput) priorityInput.value = priority;
}

function updateTargetSelection() {
    const specificSection = document.getElementById('specificStaffSection');
    if (!specificSection) return;
    
    const targetAll = document.querySelector('input[name="target"][value="all"]');
    if (targetAll && targetAll.checked) {
        specificSection.style.display = 'none';
    } else {
        specificSection.style.display = 'block';
    }
}

function createAnnouncement() {
    const title = document.getElementById('announcementTitle')?.value.trim();
    const content = document.getElementById('announcementContent')?.value.trim();
    const priority = document.getElementById('announcementPriority')?.value;
    const target = document.querySelector('input[name="target"]:checked')?.value;
    const expiry = document.getElementById('announcementExpiry')?.value;
    let targetUsers = [];
    
    if (!title || !content || !priority || !target) {
        alert('Please fill in all required fields');
        return;
    }
    
    if (target === 'specific') {
        const staffSelect = document.getElementById('announcementStaff');
        targetUsers = Array.from(staffSelect.selectedOptions).map(option => option.value);
        
        if (targetUsers.length === 0) {
            alert('Please select at least one staff member for specific announcement');
            return;
        }
    }
    
    const announcement = {
        id: 'ann_' + Date.now(),
        title: title,
        content: content,
        priority: priority,
        target: target,
        targetUsers: targetUsers,
        createdBy: currentUser.name,
        createdByUsername: currentUser.username,
        createdAt: new Date().toISOString(),
        expiry: expiry || null,
        status: 'active'
    };
    
    announcements.push(announcement);
    saveAnnouncements();
    
    alert('Announcement created successfully!');
    clearAnnouncementForm();
    
    // Reload announcements
    loadActiveAnnouncements();
    loadExpiredAnnouncements();
    
    // Show success message
    showUserNotification('New announcement created successfully!');
}

function clearAnnouncementForm() {
    const form = document.getElementById('announcementForm');
    if (form) form.reset();
    
    document.getElementById('announcementPriority').value = 'medium';
    selectPriority('medium');
    updateTargetSelection();
}

function loadActiveAnnouncements() {
    const container = document.getElementById('activeAnnouncementsList');
    if (!container) return;
    
    container.innerHTML = '';
    
    const now = new Date();
    const activeAnnouncements = announcements.filter(ann => {
        if (ann.status === 'expired' || ann.status === 'archived') return false;
        if (ann.expiry && new Date(ann.expiry) < now) {
            ann.status = 'expired';
            return false;
        }
        return true;
    });
    
    if (activeAnnouncements.length === 0) {
        container.innerHTML = `
            <div class="no-announcements">
                <div class="icon">ðŸ“¢</div>
                <p>No active announcements</p>
                <p style="font-size: 12px;">Create your first announcement above</p>
            </div>
        `;
        return;
    }
    
    // Sort by priority and date
    activeAnnouncements.sort((a, b) => {
        const priorityOrder = {high: 0, medium: 1, low: 2};
        if (priorityOrder[a.priority] !== priorityOrder[b.priority]) {
            return priorityOrder[a.priority] - priorityOrder[b.priority];
        }
        return new Date(b.createdAt) - new Date(a.createdAt);
    });
    
    activeAnnouncements.forEach(ann => {
        const announcementDiv = document.createElement('div');
        announcementDiv.className = `announcement-banner priority-${ann.priority}`;
        
        let targetText = '';
        if (ann.target === 'all') {
            targetText = 'All Staff';
        } else {
            const targetNames = ann.targetUsers.map(username => {
                const user = allUsers.find(u => u.username === username);
                return user ? user.name : username;
            }).join(', ');
            targetText = `For: ${targetNames}`;
        }
        
        announcementDiv.innerHTML = `
            <div class="announcement-actions">
                <button class="announcement-btn" onclick="editAnnouncement('${ann.id}')" title="Edit">âœï¸</button>
                <button class="announcement-btn" onclick="archiveAnnouncement('${ann.id}')" title="Archive">ðŸ“</button>
                <button class="announcement-btn" onclick="deleteAnnouncement('${ann.id}')" title="Delete">ðŸ—‘ï¸</button>
            </div>
            <div class="announcement-title">
                <span class="announcement-icon">ðŸ“¢</span>
                ${ann.title}
            </div>
            <div class="announcement-content">${ann.content}</div>
            <div class="announcement-meta">
                <div>
                    By: ${ann.createdBy} â€¢ ${formatTimeAgo(ann.createdAt)}
                    ${ann.expiry ? `<br>Expires: ${formatDate(ann.expiry)}` : ''}
                </div>
                <div class="announcement-target">${targetText}</div>
            </div>
        `;
        
        container.appendChild(announcementDiv);
    });
}

function loadExpiredAnnouncements() {
    const container = document.getElementById('expiredAnnouncementsList');
    if (!container) return;
    
    container.innerHTML = '';
    
    const now = new Date();
    const expiredAnnouncements = announcements.filter(ann => {
        if (ann.status === 'expired') return true;
        if (ann.expiry && new Date(ann.expiry) < now) {
            ann.status = 'expired';
            return true;
        }
        return false;
    });
    
    if (expiredAnnouncements.length === 0) {
        container.innerHTML = `
            <div class="no-announcements">
                <div class="icon">ðŸ“…</div>
                <p>No expired announcements</p>
            </div>
        `;
        return;
    }
    
    // Sort by expiry date (newest first)
    expiredAnnouncements.sort((a, b) => new Date(b.expiry || b.createdAt) - new Date(a.expiry || a.createdAt));
    
    expiredAnnouncements.forEach(ann => {
        const announcementDiv = document.createElement('div');
        announcementDiv.className = 'announcement-banner';
        announcementDiv.style.background = 'linear-gradient(135deg, #868f96 0%, #596164 100%)';
        announcementDiv.style.opacity = '0.8';
        
        let targetText = '';
        if (ann.target === 'all') {
            targetText = 'All Staff';
        } else {
            const targetNames = ann.targetUsers.map(username => {
                const user = allUsers.find(u => u.username === username);
                return user ? user.name : username;
            }).join(', ');
            targetText = `For: ${targetNames}`;
        }
        
        announcementDiv.innerHTML = `
            <div class="announcement-actions">
                <button class="announcement-btn" onclick="restoreAnnouncement('${ann.id}')" title="Restore">â†»</button>
                <button class="announcement-btn" onclick="deleteAnnouncement('${ann.id}')" title="Delete">ðŸ—‘ï¸</button>
            </div>
            <div class="announcement-title">
                <span class="announcement-icon">ðŸ“…</span>
                ${ann.title}
            </div>
            <div class="announcement-content">${ann.content}</div>
            <div class="announcement-meta">
                <div>
                    By: ${ann.createdBy} â€¢ ${formatTimeAgo(ann.createdAt)}
                    <br>Expired: ${formatDate(ann.expiry || ann.createdAt)}
                </div>
                <div class="announcement-target">${targetText}</div>
            </div>
        `;
        
        container.appendChild(announcementDiv);
    });
}

function editAnnouncement(announcementId) {
    const announcement = announcements.find(ann => ann.id === announcementId);
    if (!announcement) return;
    
    // Fill form with announcement data
    document.getElementById('announcementTitle').value = announcement.title;
    document.getElementById('announcementContent').value = announcement.content;
    selectPriority(announcement.priority);
    
    // Set target
    if (announcement.target === 'all') {
        document.querySelector('input[name="target"][value="all"]').checked = true;
    } else {
        document.querySelector('input[name="target"][value="specific"]').checked = true;
        updateTargetSelection();
        
        // Select staff members
        const staffSelect = document.getElementById('announcementStaff');
        Array.from(staffSelect.options).forEach(option => {
            option.selected = announcement.targetUsers.includes(option.value);
        });
    }
    
    // Set expiry
    document.getElementById('announcementExpiry').value = announcement.expiry || '';
    
    // Change button text
    const submitBtn = document.getElementById('createAnnouncementBtn');
    submitBtn.textContent = 'Update Announcement';
    submitBtn.onclick = function() {
        updateAnnouncement(announcementId);
        return false;
    };
}

function updateAnnouncement(announcementId) {
    const index = announcements.findIndex(ann => ann.id === announcementId);
    if (index === -1) return;
    
    const title = document.getElementById('announcementTitle').value.trim();
    const content = document.getElementById('announcementContent').value.trim();
    const priority = document.getElementById('announcementPriority').value;
    const target = document.querySelector('input[name="target"]:checked').value;
    const expiry = document.getElementById('announcementExpiry').value;
    let targetUsers = [];
    
    if (target === 'specific') {
        const staffSelect = document.getElementById('announcementStaff');
        targetUsers = Array.from(staffSelect.selectedOptions).map(option => option.value);
        
        if (targetUsers.length === 0) {
            alert('Please select at least one staff member for specific announcement');
            return;
        }
    }
    
    if (!title || !content) {
        alert('Please fill in title and content');
        return;
    }
    
    // Update announcement
    announcements[index] = {
        ...announcements[index],
        title: title,
        content: content,
        priority: priority,
        target: target,
        targetUsers: targetUsers,
        expiry: expiry || null,
        updatedAt: new Date().toISOString(),
        updatedBy: currentUser.name
    };
    
    saveAnnouncements();
    
    alert('Announcement updated successfully!');
    clearAnnouncementForm();
    
    // Reset button
    const submitBtn = document.getElementById('createAnnouncementBtn');
    submitBtn.textContent = 'Create Announcement';
    submitBtn.onclick = null;
    
    // Reload announcements
    loadActiveAnnouncements();
    loadExpiredAnnouncements();
}

function archiveAnnouncement(announcementId) {
    if (confirm('Are you sure you want to archive this announcement?')) {
        const index = announcements.findIndex(ann => ann.id === announcementId);
        if (index !== -1) {
            announcements[index].status = 'archived';
            saveAnnouncements();
            loadActiveAnnouncements();
            alert('Announcement archived!');
        }
    }
}

function deleteAnnouncement(announcementId) {
    if (confirm('Are you sure you want to delete this announcement? This action cannot be undone.')) {
        const index = announcements.findIndex(ann => ann.id === announcementId);
        if (index !== -1) {
            announcements.splice(index, 1);
            saveAnnouncements();
            loadActiveAnnouncements();
            loadExpiredAnnouncements();
            alert('Announcement deleted!');
        }
    }
}

function restoreAnnouncement(announcementId) {
    const index = announcements.findIndex(ann => ann.id === announcementId);
    if (index !== -1) {
        announcements[index].status = 'active';
        announcements[index].expiry = null; // Remove expiry when restoring
        saveAnnouncements();
        loadActiveAnnouncements();
        loadExpiredAnnouncements();
        alert('Announcement restored!');
    }
}

function loadHomeAnnouncements() {
    const container = document.getElementById('homeAnnouncements');
    if (!container) return;
    
    container.innerHTML = '';
    
    const now = new Date();
    const activeAnnouncements = announcements.filter(ann => {
        if (ann.status === 'expired' || ann.status === 'archived') return false;
        if (ann.expiry && new Date(ann.expiry) < now) return false;
        
        // Check if announcement is for current user
        if (ann.target === 'all') return true;
        if (ann.target === 'specific' && ann.targetUsers && ann.targetUsers.includes(currentUser.username)) return true;
        return false;
    });
    
    if (activeAnnouncements.length === 0) return;
    
    // Sort by priority (high to low) and date (newest first)
    activeAnnouncements.sort((a, b) => {
        const priorityOrder = {high: 0, medium: 1, low: 2};
        if (priorityOrder[a.priority] !== priorityOrder[b.priority]) {
            return priorityOrder[a.priority] - priorityOrder[b.priority];
        }
        return new Date(b.createdAt) - new Date(a.createdAt);
    });
    
    // Show only 3 most recent announcements on home
    const recentAnnouncements = activeAnnouncements.slice(0, 3);
    
    recentAnnouncements.forEach(ann => {
        const announcementDiv = document.createElement('div');
        announcementDiv.className = `announcement-banner priority-${ann.priority}`;
        
        let targetText = '';
        if (ann.target === 'all') {
            targetText = 'All Staff';
        } else {
            const targetNames = ann.targetUsers.map(username => {
                const user = allUsers.find(u => u.username === username);
                return user ? user.name : username;
            }).join(', ');
            targetText = `For: ${targetNames}`;
        }
        
        announcementDiv.innerHTML = `
            <div class="announcement-title">
                <span class="announcement-icon">ðŸ“¢</span>
                ${ann.title}
            </div>
            <div class="announcement-content">${ann.content}</div>
            <div class="announcement-meta">
                <div>
                    By: ${ann.createdBy} â€¢ ${formatTimeAgo(ann.createdAt)}
                    ${ann.expiry ? `<br>Expires: ${formatDate(ann.expiry)}` : ''}
                </div>
                <div class="announcement-target">${targetText}</div>
            </div>
        `;
        
        container.appendChild(announcementDiv);
    });
}

// ============================================
// DASHBOARD FUNCTIONALITY
// ============================================

function updateDashboard() {
    if (!currentUser) return;
    
    // Update today's duty
    const today = new Date().toISOString().split('T')[0];
    const todayDutyTime = document.getElementById('todayDutyTime');
    if (todayDutyTime) {
        if (dutyRoster[today] && dutyRoster[today][currentUser.username]) {
            const duty = dutyRoster[today][currentUser.username];
            todayDutyTime.textContent = duty === 'Off' ? 'Off Duty' : duty;
        } else {
            todayDutyTime.textContent = 'Not Scheduled';
        }
    }
    
    // Find next duty (next 7 days)
    const nextDutyTime = document.getElementById('nextDutyTime');
    if (nextDutyTime) {
        const tomorrow = new Date();
        let nextDutyFound = false;
        
        for (let i = 1; i <= 7; i++) {
            tomorrow.setDate(tomorrow.getDate() + 1);
            const dateStr = tomorrow.toISOString().split('T')[0];
            if (dutyRoster[dateStr] && dutyRoster[dateStr][currentUser.username]) {
                const duty = dutyRoster[dateStr][currentUser.username];
                if (duty !== 'Off') {
                    nextDutyTime.textContent = `${formatDate(dateStr)}: ${duty}`;
                    nextDutyFound = true;
                    break;
                }
            }
        }
        
        if (!nextDutyFound) {
            nextDutyTime.textContent = 'No upcoming duty';
        }
    }
    
    // Update balance display
    updateUserBalance();
    
    // Load announcements
    loadHomeAnnouncements();
    
    // Check for recent updates to user's requests
    checkForUserUpdates();
}

function checkForUserUpdates() {
    const userReqs = allRequests.filter(req => 
        req.fromUsername === currentUser.username && 
        req.status !== 'pending' &&
        req.history && req.history.length > 0
    );
    
    // Find requests updated in the last 24 hours
    const twentyFourHoursAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
    const recentUpdates = userReqs.filter(req => {
        const lastUpdate = new Date(req.history[req.history.length - 1].timestamp);
        return lastUpdate > twentyFourHoursAgo;
    });
    
    if (recentUpdates.length > 0) {
        showUserUpdates(recentUpdates);
    }
}

function showUserUpdates(updates) {
    const notificationContainer = document.getElementById('homeNotifications');
    if (!notificationContainer) return;
    
    let html = '<strong>Recent Updates:</strong><br>';
    
    updates.slice(0, 3).forEach(req => {
        const lastEvent = req.history[req.history.length - 1];
        const timeAgo = formatTimeAgo(lastEvent.timestamp);
        
        if (req.type === 'dutyChange') {
            html += `â€¢ Duty change ${req.status} ${timeAgo}<br>`;
        } else {
            html += `â€¢ Leave ${req.status} ${timeAgo}<br>`;
        }
    });
    
    notificationContainer.innerHTML = `<div class="alert alert-info">${html}</div>`;
    notificationContainer.style.display = 'block';
    
    // Auto hide after 10 seconds
    setTimeout(() => {
        notificationContainer.style.display = 'none';
    }, 10000);
}

function showUserNotification(message, type = 'info') {
    // Create temporary notification
    const notification = document.createElement('div');
    notification.className = `alert alert-${type}`;
    notification.innerHTML = `<i class="fas fa-info-circle"></i> ${message}`;
    notification.style.position = 'fixed';
    notification.style.top = '70px';
    notification.style.left = '10px';
    notification.style.right = '10px';
    notification.style.zIndex = '1001';
    notification.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
    
    document.body.appendChild(notification);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transition = 'opacity 0.5s';
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 500);
    }, 5000);
}

// ============================================
// ADMIN FUNCTIONALITY
// ============================================

function loadDutyRosterAdmin() {
    // Initialize tabs
    showRosterTab('excelImport');
    
    // Populate staff dropdowns
    const staffSelect = document.getElementById('rosterStaffSingle');
    const viewStaffSelect = document.getElementById('viewRosterStaff');
    
    if (staffSelect) {
        staffSelect.innerHTML = '<option value="">Select staff</option>';
        allUsers.forEach(user => {
            const option = document.createElement('option');
            option.value = user.username;
            option.textContent = `${user.name} (${user.RCNo})`;
            staffSelect.appendChild(option);
        });
    }
    
    if (viewStaffSelect) {
        viewStaffSelect.innerHTML = '<option value="">All Staff</option>';
        allUsers.forEach(user => {
            const option = document.createElement('option');
            option.value = user.username;
            option.textContent = `${user.name} (${user.RCNo})`;
            viewStaffSelect.appendChild(option);
        });
    }
    
    // Load today's entries
    loadTodayRoster();
}

function showRosterTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.roster-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remove active from all tab buttons
    document.querySelectorAll('#adminDutyRosterSection .tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab
    const tabElement = document.getElementById(tabName + 'Tab');
    if (tabElement) tabElement.classList.add('active');
    
    // Activate corresponding button
    document.querySelectorAll('#adminDutyRosterSection .tab-btn').forEach(btn => {
        if (btn.textContent.includes(tabName === 'excelImport' ? 'Excel' : 
                                     tabName === 'manualEntry' ? 'Manual' : 'View')) {
            btn.classList.add('active');
        }
    });
    
    if (tabName === 'viewRoster') {
        loadRosterView();
    }
}

function processExcelPaste() {
    const pasteText = document.getElementById('excelPasteBox')?.value.trim();
    if (!pasteText) {
        alert('Please paste Excel data first');
        return;
    }
    
    const lines = pasteText.split('\n').filter(line => line.trim());
    if (lines.length < 2) {
        alert('Invalid data format. Need at least header row and one data row.');
        return;
    }
    
    // Parse header (first line)
    const headers = lines[0].split('\t');
    if (headers.length < 2) {
        alert('Invalid format. First column should be Date, then staff names.');
        return;
    }
    
    // Create preview table
    const previewTable = document.getElementById('excelPreviewTable');
    if (!previewTable) return;
    
    previewTable.innerHTML = '';
    
    // Add header row
    let headerRow = '<tr>';
    headers.forEach(header => {
        headerRow += `<th>${header}</th>`;
    });
    headerRow += '</tr>';
    previewTable.innerHTML = headerRow;
    
    // Add data rows
    for (let i = 1; i < lines.length; i++) {
        const cells = lines[i].split('\t');
        let row = '<tr>';
        cells.forEach(cell => {
            row += `<td>${cell}</td>`;
        });
        row += '</tr>';
        previewTable.innerHTML += row;
    }
    
    // Show preview
    const excelPreview = document.getElementById('excelPreview');
    if (excelPreview) excelPreview.style.display = 'block';
}

function saveExcelData() {
    const pasteText = document.getElementById('excelPasteBox')?.value.trim();
    if (!pasteText) {
        alert('No data to save');
        return;
    }
    
    const lines = pasteText.split('\n').filter(line => line.trim());
    if (lines.length < 2) {
        alert('No data to save');
        return;
    }
    
    const headers = lines[0].split('\t');
    let successCount = 0;
    let errorCount = 0;
    
    for (let i = 1; i < lines.length; i++) {
        const cells = lines[i].split('\t');
        const date = cells[0];
        
        // Validate date format
        if (!isValidDate(date)) {
            console.log(`Skipping invalid date: ${date}`);
            errorCount++;
            continue;
        }
        
        if (!dutyRoster[date]) {
            dutyRoster[date] = {};
        }
        
        for (let j = 1; j < headers.length && j < cells.length; j++) {
            const displayName = headers[j];
            const dutyTime = cells[j] || 'Off';
            
            // Find username using display name map
            const username = findUsernameFromDisplayName(displayName);
            
            if (username) {
                dutyRoster[date][username] = dutyTime;
                successCount++;
            } else {
                console.log(`User not found for display name: ${displayName}`);
                errorCount++;
            }
        }
    }
    
    saveDutyRoster();
    alert(`Roster saved successfully! ${successCount} entries updated. ${errorCount > 0 ? errorCount + ' errors occurred.' : ''}`);
    
    const excelPreview = document.getElementById('excelPreview');
    if (excelPreview) excelPreview.style.display = 'none';
    
    const excelPasteBox = document.getElementById('excelPasteBox');
    if (excelPasteBox) excelPasteBox.value = '';
}

function findUsernameFromDisplayName(displayName) {
    // Try direct mapping first
    if (userDisplayNameMap[displayName]) {
        return userDisplayNameMap[displayName];
    }
    
    // Try case-insensitive matching
    const displayLower = displayName.toLowerCase();
    for (const key in userDisplayNameMap) {
        if (key.toLowerCase() === displayLower) {
            return userDisplayNameMap[key];
        }
    }
    
    // Try partial match
    for (const user of allUsers) {
        if (displayName.includes(user.name) || user.name.includes(displayName)) {
            return user.username;
        }
        if (displayName.includes(user.RCNo)) {
            return user.username;
        }
    }
    
    return null;
}

function isValidDate(dateString) {
    const regex = /^\d{4}-\d{2}-\d{2}$/;
    if (!dateString.match(regex)) return false;
    const date = new Date(dateString);
    return date instanceof Date && !isNaN(date);
}

function loadTodayRoster() {
    const tbody = document.querySelector('#todayRosterTable tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    const today = document.getElementById('rosterDate')?.value;
    if (!today || !dutyRoster[today]) return;
    
    for (const [username, dutyTime] of Object.entries(dutyRoster[today])) {
        const user = allUsers.find(u => u.username === username);
        if (user) {
            const tr = document.createElement('tr');
            const dutyClass = getDutyTimeClass(dutyTime);
            tr.innerHTML = `
                <td>${user.name} (${user.RCNo})</td>
                <td class="${dutyClass}">${dutyTime}</td>
                <td>
                    <button class="action-btn view" onclick="editRosterEntry('${today}', '${username}')">Edit</button>
                    <button class="action-btn reject" onclick="deleteRosterEntry('${today}', '${username}')">Delete</button>
                </td>
            `;
            tbody.appendChild(tr);
        }
    }
}

function addRosterEntry() {
    const date = document.getElementById('rosterDate')?.value;
    const staff = document.getElementById('rosterStaffSingle')?.value;
    const dutyTime = document.getElementById('rosterDutyTime')?.value.trim();
    
    if (!date || !staff || !dutyTime) {
        alert('Please fill all fields');
        return;
    }
    
    if (!dutyRoster[date]) {
        dutyRoster[date] = {};
    }
    
    dutyRoster[date][staff] = dutyTime;
    saveDutyRoster();
    
    alert('Entry added successfully!');
    clearRosterForm();
    loadTodayRoster();
}

function clearRosterForm() {
    const rosterDutyTime = document.getElementById('rosterDutyTime');
    if (rosterDutyTime) rosterDutyTime.value = '';
}

function editRosterEntry(date, username) {
    const currentTime = dutyRoster[date][username];
    const dutyTime = prompt('Enter new duty time:', currentTime);
    if (dutyTime !== null) {
        dutyRoster[date][username] = dutyTime;
        saveDutyRoster();
        loadTodayRoster();
    }
}

function deleteRosterEntry(date, username) {
    if (confirm('Are you sure you want to delete this entry?')) {
        delete dutyRoster[date][username];
        saveDutyRoster();
        loadTodayRoster();
    }
}

function loadRosterView() {
    const container = document.getElementById('rosterViewContainer');
    const date = document.getElementById('viewRosterDate')?.value;
    const staffFilter = document.getElementById('viewRosterStaff')?.value;
    
    if (!container) return;
    
    if (!date) {
        container.innerHTML = '<div class="alert alert-warning">Please select a date</div>';
        return;
    }
    
    let html = '<h4>Roster for ' + date + '</h4>';
    
    if (!dutyRoster[date] || Object.keys(dutyRoster[date]).length === 0) {
        html += '<div class="alert alert-warning">No roster entries for this date</div>';
        container.innerHTML = html;
        return;
    }
    
    html += '<div class="table-container"><table><thead><tr><th>Staff</th><th>RC No</th><th>Duty Time</th></tr></thead><tbody>';
    
    for (const [username, dutyTime] of Object.entries(dutyRoster[date])) {
        const user = allUsers.find(u => u.username === username);
        if (user && (!staffFilter || user.username === staffFilter)) {
            const dutyClass = getDutyTimeClass(dutyTime);
            html += `<tr>
                <td>${user.name}</td>
                <td>${user.RCNo}</td>
                <td class="${dutyClass}">${dutyTime}</td>
            </tr>`;
        }
    }
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
}

// ============================================
// LEAVE BALANCE ADMIN
// ============================================

function loadLeaveBalanceAdmin() {
    showBalanceTab('bulkUpdate');
    
    // Populate staff dropdown for individual tab
    const staffSelect = document.getElementById('balanceStaff');
    if (staffSelect) {
        staffSelect.innerHTML = '<option value="">Select staff</option>';
        allUsers.forEach(user => {
            const option = document.createElement('option');
            option.value = user.username;
            option.textContent = `${user.name} (${user.RCNo})`;
            staffSelect.appendChild(option);
        });
        
        staffSelect.addEventListener('change', function() {
            const form = document.getElementById('individualBalanceForm');
            if (this.value) {
                const balance = leaveBalances[this.value] || {SL: 0, FRL: 0};
                document.getElementById('individualSL').value = balance.SL;
                document.getElementById('individualFRL').value = balance.FRL;
                form.style.display = 'block';
            } else {
                form.style.display = 'none';
            }
        });
    }
    
    // Load bulk update table
    loadBulkBalanceTable();
}

function showBalanceTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.balance-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remove active from all tab buttons
    document.querySelectorAll('#adminLeaveBalanceSection .tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab
    const tabElement = document.getElementById(tabName + 'Tab');
    if (tabElement) tabElement.classList.add('active');
    
    // Activate corresponding button
    document.querySelectorAll('#adminLeaveBalanceSection .tab-btn').forEach(btn => {
        if (btn.textContent.includes(tabName === 'bulkUpdate' ? 'Bulk' : 'Individual')) {
            btn.classList.add('active');
        }
    });
}

function loadBulkBalanceTable() {
    const tbody = document.getElementById('bulkBalanceTable');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    allUsers.forEach(user => {
        const balance = leaveBalances[user.username] || {SL: 0, FRL: 0};
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${user.name}</td>
            <td>${user.RCNo}</td>
            <td>
                <input type="number" class="excel-input" 
                       value="${balance.SL}" 
                       step="0.5" 
                       min="0"
                       onchange="updateTempBalance('${user.username}', 'SL', this.value)">
            </td>
            <td>
                <input type="number" class="excel-input" 
                       value="${balance.FRL}" 
                       step="0.5" 
                       min="0"
                       onchange="updateTempBalance('${user.username}', 'FRL', this.value)">
            </td>
            <td>
                <button class="action-btn view" onclick="resetUserBalance('${user.username}')">Reset</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

function updateTempBalance(username, type, value) {
    if (!leaveBalances[username]) {
        leaveBalances[username] = {SL: 0, FRL: 0};
    }
    leaveBalances[username][type] = parseFloat(value) || 0;
}

function saveAllBalances() {
    saveLeaveBalances();
    alert('All balances saved successfully!');
    loadBulkBalanceTable();
    updateUserBalance();
}

function resetAllBalances() {
    if (confirm('Reset ALL balances to default (12 days SL, 6 days FRL)?')) {
        allUsers.forEach(user => {
            leaveBalances[user.username] = {SL: 12, FRL: 6};
        });
        saveLeaveBalances();
        loadBulkBalanceTable();
        updateUserBalance();
    }
}

function resetUserBalance(username) {
    if (confirm(`Reset balance for this user to default?`)) {
        leaveBalances[username] = {SL: 12, FRL: 6};
        saveLeaveBalances();
        loadBulkBalanceTable();
        if (username === currentUser.username) {
            updateUserBalance();
        }
    }
}

function saveIndividualBalance() {
    const staff = document.getElementById('balanceStaff')?.value;
    const sl = parseFloat(document.getElementById('individualSL')?.value) || 0;
    const frl = parseFloat(document.getElementById('individualFRL')?.value) || 0;
    
    if (!staff) {
        alert('Please select a staff member');
        return;
    }
    
    if (!leaveBalances[staff]) {
        leaveBalances[staff] = {SL: 0, FRL: 0};
    }
    
    leaveBalances[staff].SL = sl;
    leaveBalances[staff].FRL = frl;
    saveLeaveBalances();
    
    alert('Balance saved successfully!');
    
    // Update bulk table if on that view
    loadBulkBalanceTable();
    
    // Update current user's display if it's them
    if (staff === currentUser.username) {
        updateUserBalance();
    }
}

function resetIndividualBalance() {
    const staff = document.getElementById('balanceStaff')?.value;
    if (!staff) {
        alert('Please select a staff member');
        return;
    }
    
    if (confirm(`Reset balance for this staff to default (12 days SL, 6 days FRL)?`)) {
        leaveBalances[staff] = {SL: 12, FRL: 6};
        document.getElementById('individualSL').value = 12;
        document.getElementById('individualFRL').value = 6;
        saveLeaveBalances();
        
        // Update bulk table
        loadBulkBalanceTable();
        
        if (staff === currentUser.username) {
            updateUserBalance();
        }
    }
}

// ============================================
// ADMIN APPROVALS
// ============================================

function loadAdminApprovals() {
    showApprovalsTab('pending');
}

function showApprovalsTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.approvals-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remove active from all tab buttons
    document.querySelectorAll('#adminApprovalsSection .tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab
    const tabElement = document.getElementById(tabName + 'ApprovalsTab');
    if (tabElement) tabElement.classList.add('active');
    
    // Activate corresponding button
    document.querySelectorAll('#adminApprovalsSection .tab-btn').forEach(btn => {
        if (btn.textContent.includes(tabName)) {
            btn.classList.add('active');
        }
    });
    
    // Load data for the tab
    if (tabName === 'pending') {
        loadPendingApprovals();
    } else if (tabName === 'approved') {
        loadApprovedRequests();
    } else if (tabName === 'rejected') {
        loadRejectedRequests();
    }
}

function loadPendingApprovals() {
    const tbody = document.getElementById('adminApprovalsTable');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    const pendingRequests = allRequests.filter(req => req.status === 'pending');
    
    if (pendingRequests.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No pending requests</td></tr>';
        return;
    }
    
    // Sort by timestamp ascending (oldest first)
    pendingRequests.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
    
    pendingRequests.forEach(req => {
        const tr = document.createElement('tr');
        
        let details = '';
        if (req.type === 'dutyChange') {
            details = `
                <div class="request-details">
                    <strong>Swap Request:</strong><br>
                    ${req.fromName} (${req.dutyTime}) â†” ${req.toName} (${req.toDutyTime})
                </div>
            `;
        } else {
            details = `
                <div class="request-details">
                    <strong>${req.leaveType}:</strong> ${req.duration} day(s)<br>
                    <em>${req.reason}</em>
                </div>
            `;
        }
        
        tr.innerHTML = `
            <td>${req.fromName} (${req.fromRcNo})</td>
            <td>${req.type === 'dutyChange' ? 'Duty Change' : 'Leave'}</td>
            <td>${req.date}</td>
            <td>${details}</td>
            <td class="status-pending">Pending</td>
            <td class="action-buttons">
                <button class="action-btn approve" onclick="adminApprove('${req.id}')">Approve</button>
                <button class="action-btn reject" onclick="adminReject('${req.id}')">Reject</button>
                ${req.type === 'dutyChange' ? 
                    `<button class="action-btn apply" onclick="adminApplyDutyChange('${req.id}')">Apply & Approve</button>` : ''}
            </td>
        `;
        
        tbody.appendChild(tr);
    });
}

function adminApprove(requestId) {
    const request = allRequests.find(req => req.id === requestId);
    if (!request) return;
    
    if (request.type === 'leave') {
        // Check balance
        const userBalance = leaveBalances[request.fromUsername];
        if (!userBalance) {
            alert('Error: User balance not found');
            return;
        }
        
        // Check if leave was already approved (prevent double deduction)
        if (request.status === 'approved') {
            alert('This leave request is already approved!');
            return;
        }
        
        if (request.leaveType === 'Sick Leave' && userBalance.SL < request.duration) {
            alert(`Cannot approve: Insufficient Sick Leave balance. Available: ${userBalance.SL.toFixed(1)} days, Requested: ${request.duration} days`);
            return;
        }
        
        if (request.leaveType === 'FRL' && userBalance.FRL < request.duration) {
            alert(`Cannot approve: Insufficient FRL balance. Available: ${userBalance.FRL.toFixed(1)} days, Requested: ${request.duration} days`);
            return;
        }
        
        // Deduct from balance
        if (request.leaveType === 'Sick Leave') {
            userBalance.SL -= request.duration;
            userBalance.SL = Math.max(0, userBalance.SL);
        } else if (request.leaveType === 'FRL') {
            userBalance.FRL -= request.duration;
            userBalance.FRL = Math.max(0, userBalance.FRL);
        }
        saveLeaveBalances();
        
        // Show updated balance
        alert(`Request approved! Leave balance deducted. Remaining balance: ${request.leaveType === 'Sick Leave' ? userBalance.SL.toFixed(1) : userBalance.FRL.toFixed(1)} days`);
    }
    
    request.status = 'approved';
    request.approvedBy = currentUser.name;
    request.approvedAt = new Date().toISOString();
    request.history.push({
        action: 'approved',
        by: currentUser.name,
        timestamp: new Date().toISOString()
    });
    saveAllRequests();
    
    // Refresh the approvals view
    showApprovalsTab('approved');
    updateRequestCounts();
    
    // Update dashboard balance display if it's the current user's request
    if (request.fromUsername === currentUser.username) {
        updateUserBalance();
    }
}

function adminApplyDutyChange(requestId) {
    const request = allRequests.find(req => req.id === requestId);
    if (!request) return;
    
    // Apply the duty change immediately
    const date = request.date;
    if (dutyRoster[date]) {
        const temp = dutyRoster[date][request.fromUsername];
        dutyRoster[date][request.fromUsername] = dutyRoster[date][request.toUsername];
        dutyRoster[date][request.toUsername] = temp;
        saveDutyRoster();
    }
    
    // Mark as approved
    request.status = 'approved';
    request.approvedBy = currentUser.name;
    request.appliedBy = currentUser.name;
    request.approvedAt = new Date().toISOString();
    request.appliedAt = new Date().toISOString();
    request.history.push({
        action: 'applied_and_approved',
        by: currentUser.name,
        timestamp: new Date().toISOString()
    });
    saveAllRequests();
    
    alert('Duty change applied and approved! Roster updated.');
    showApprovalsTab('approved');
    updateRequestCounts();
}

function adminReject(requestId) {
    if (confirm('Are you sure you want to reject this request?')) {
        const request = allRequests.find(req => req.id === requestId);
        if (request) {
            request.status = 'rejected';
            request.rejectedBy = currentUser.name;
            request.rejectedAt = new Date().toISOString();
            request.history.push({
                action: 'rejected',
                by: currentUser.name,
                timestamp: new Date().toISOString()
            });
            saveAllRequests();
            
            alert('Request rejected!');
            showApprovalsTab('rejected');
            
            // Update counts
            updateRequestCounts();
        }
    }
}

function loadApprovedRequests() {
    const tbody = document.getElementById('approvedRequestsTable');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    const approvedRequests = allRequests.filter(req => req.status === 'approved');
    
    if (approvedRequests.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No approved requests</td></tr>';
        return;
    }
    
    // Sort by approval date descending (newest first)
    approvedRequests.sort((a, b) => {
        const aDate = a.approvedAt ? new Date(a.approvedAt) : new Date(0);
        const bDate = b.approvedAt ? new Date(b.approvedAt) : new Date(0);
        return bDate - aDate;
    });
    
    approvedRequests.forEach(req => {
        const tr = document.createElement('tr');
        
        let details = '';
        if (req.type === 'dutyChange') {
            details = `Swap with ${req.toName} (${req.toDutyTime})`;
            if (req.reason) details += `<br><small>Reason: ${req.reason}</small>`;
        } else {
            details = `${req.leaveType}: ${req.duration} day(s)`;
            if (req.reason) details += `<br><small>Reason: ${req.reason}</small>`;
        }
        
        const appliedBy = req.appliedBy || req.approvedBy || 'System';
        const appliedAt = req.appliedAt || req.approvedAt || req.timestamp;
        
        tr.innerHTML = `
            <td>${req.fromName} (${req.fromRcNo})</td>
            <td>${req.type === 'dutyChange' ? 'Duty Change' : 'Leave'}</td>
            <td>${req.date}</td>
            <td>${details}</td>
            <td class="status-approved">Approved</td>
            <td>${appliedBy}</td>
            <td class="timestamp">${formatDateTime(appliedAt)}</td>
        `;
        
        tbody.appendChild(tr);
    });
}

function loadRejectedRequests() {
    const tbody = document.getElementById('rejectedRequestsTable');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    const rejectedRequests = allRequests.filter(req => req.status === 'rejected');
    
    if (rejectedRequests.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No rejected requests</td></tr>';
        return;
    }
    
    rejectedRequests.forEach(req => {
        const tr = document.createElement('tr');
        
        let details = '';
        if (req.type === 'dutyChange') {
            details = `Swap with ${req.toName} (${req.toDutyTime})`;
            if (req.reason) details += `<br><small>Reason: ${req.reason}</small>`;
        } else {
            details = `${req.leaveType}: ${req.duration} day(s)`;
            if (req.reason) details += `<br><small>Reason: ${req.reason}</small>`;
        }
        
        const rejectedBy = req.rejectedBy || 'System';
        const rejectedAt = req.rejectedAt || req.timestamp;
        
        tr.innerHTML = `
            <td>${req.fromName} (${req.fromRcNo})</td>
            <td>${req.type === 'dutyChange' ? 'Duty Change' : 'Leave'}</td>
            <td>${req.date}</td>
            <td>${details}</td>
            <td class="status-rejected">Rejected</td>
            <td>${rejectedBy}</td>
            <td class="timestamp">${formatDateTime(rejectedAt)}</td>
        `;
        
        tbody.appendChild(tr);
    });
}

// ============================================
// ADMIN REQUEST HISTORY
// ============================================

function loadAdminRequestHistory() {
    // Populate staff filter dropdown
    const staffSelect = document.getElementById('historyFilterStaff');
    if (staffSelect) {
        staffSelect.innerHTML = '<option value="">All Staff</option>';
        allUsers.forEach(user => {
            const option = document.createElement('option');
            option.value = user.username;
            option.textContent = `${user.name} (${user.RCNo})`;
            staffSelect.appendChild(option);
        });
    }
    
    // Load all requests
    loadRequestHistory();
}

function loadRequestHistory() {
    const tbody = document.getElementById('requestHistoryTable');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    // Get filter values
    const staffFilter = document.getElementById('historyFilterStaff')?.value;
    const typeFilter = document.getElementById('historyFilterType')?.value;
    const statusFilter = document.getElementById('historyFilterStatus')?.value;
    const startDate = document.getElementById('historyStartDate')?.value;
    const endDate = document.getElementById('historyEndDate')?.value;
    
    // Filter requests
    let filteredRequests = allRequests;
    
    if (staffFilter) {
        filteredRequests = filteredRequests.filter(req => req.fromUsername === staffFilter);
    }
    
    if (typeFilter) {
        filteredRequests = filteredRequests.filter(req => req.type === typeFilter);
    }
    
    if (statusFilter) {
        filteredRequests = filteredRequests.filter(req => req.status === statusFilter);
    }
    
    if (startDate) {
        filteredRequests = filteredRequests.filter(req => req.date >= startDate);
    }
    
    if (endDate) {
        filteredRequests = filteredRequests.filter(req => req.date <= endDate);
    }
    
    if (filteredRequests.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No requests found</td></tr>';
        return;
    }
    
    // Sort by timestamp descending (newest first)
    filteredRequests.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    
    filteredRequests.forEach(req => {
        const tr = document.createElement('tr');
        
        let details = '';
        if (req.type === 'dutyChange') {
            details = `
                <div class="request-details">
                    <strong>Swap with:</strong> ${req.toName}<br>
                    <strong>From:</strong> ${req.dutyTime} â†’ <strong>To:</strong> ${req.toDutyTime}<br>
                    ${req.reason ? `<em>${req.reason}</em>` : ''}
                </div>
            `;
        } else {
            details = `
                <div class="request-details">
                    <strong>${req.leaveType}:</strong> ${req.duration} day(s)<br>
                    <em>${req.reason}</em>
                </div>
            `;
        }
        
        let statusClass = 'status-' + req.status;
        let statusText = req.status.charAt(0).toUpperCase() + req.status.slice(1);
        
        // Create timeline HTML
        let timeline = '';
        if (req.history && req.history.length > 0) {
            req.history.forEach((event, index) => {
                timeline += `<div class="status-update">${event.action} by ${event.by}<br>
                             <small>${formatTimeAgo(event.timestamp)}</small></div>`;
            });
        }
        
        tr.innerHTML = `
            <td>${req.fromName} (${req.fromRcNo})</td>
            <td>${req.type === 'dutyChange' ? 'Duty Change' : 'Leave'}</td>
            <td>${req.date}</td>
            <td>${details}</td>
            <td class="${statusClass}">${statusText}</td>
            <td>${timeline}</td>
            <td class="action-buttons">
                ${req.status === 'pending' ? 
                    `<button class="action-btn approve" onclick="adminApprove('${req.id}')">Approve</button>
                     <button class="action-btn reject" onclick="adminReject('${req.id}')">Reject</button>` : ''}
                ${req.type === 'dutyChange' && req.status === 'pending' ? 
                    `<button class="action-btn apply" onclick="adminApplyDutyChange('${req.id}')">Apply</button>` : ''}
            </td>
        `;
        
        tbody.appendChild(tr);
    });
}

function clearHistoryFilters() {
    document.getElementById('historyFilterStaff').value = '';
    document.getElementById('historyFilterType').value = '';
    document.getElementById('historyFilterStatus').value = '';
    document.getElementById('historyStartDate').value = '';
    document.getElementById('historyEndDate').value = '';
    loadRequestHistory();
}

// ============================================
// MOBILE SPECIFIC FUNCTIONS
// ============================================

function showNotificationsPanel() {
    // Create a bottom sheet for notifications
    const bottomSheet = document.getElementById('bottomSheet');
    const bottomSheetOverlay = document.getElementById('bottomSheetOverlay');
    const bottomSheetTitle = document.getElementById('bottomSheetTitle');
    const bottomSheetContent = document.getElementById('bottomSheetContent');
    
    if (!bottomSheet || !bottomSheetOverlay || !bottomSheetTitle || !bottomSheetContent) return;
    
    bottomSheetTitle.textContent = 'Notifications';
    bottomSheetContent.innerHTML = `
        <div class="pull-to-refresh" id="pullToRefresh">
            <i class="fas fa-arrow-down"></i> Pull down to refresh
        </div>
        <div id="notificationsList">
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading notifications...</p>
            </div>
        </div>
    `;
    
    bottomSheet.classList.add('active');
    bottomSheetOverlay.classList.add('active');
    
    // Load notifications
    loadMobileNotifications();
    
    // Setup pull to refresh
    setupMobilePullToRefresh();
}

function loadMobileNotifications() {
    const notificationsList = document.getElementById('notificationsList');
    if (!notificationsList) return;
    
    setTimeout(() => {
        if (allRequests && currentUser) {
            // Get pending duty change requests for current user
            const pendingReqs = allRequests.filter(req => 
                req.status === 'pending' && 
                req.type === 'dutyChange' && 
                req.toUsername === currentUser.username
            );
            
            // Get pending leave requests (for supervisors)
            const pendingLeaves = currentUser.level === 'Supervisor' ? 
                allRequests.filter(req => req.status === 'pending' && req.type === 'leave') : [];
            
            const allNotifications = [...pendingReqs, ...pendingLeaves];
            
            if (allNotifications.length > 0) {
                let html = '';
                
                if (pendingReqs.length > 0) {
                    html += `<div class="card" style="margin-bottom: 10px;">
                        <h3><i class="fas fa-clock"></i> Pending Requests (${pendingReqs.length})</h3>`;
                    
                    pendingReqs.forEach(req => {
                        html += `
                            <div style="padding: 10px; border-bottom: 1px solid #eee;">
                                <strong>${req.fromName}</strong> wants to swap duty<br>
                                <small>${req.date} â€¢ ${req.dutyTime} â†” ${req.toDutyTime}</small>
                                <div style="margin-top: 10px; display: flex; gap: 5px;">
                                    <button class="btn btn-sm btn-success" onclick="respondToRequest('${req.id}', 'approved'); closeBottomSheetFunc();">
                                        <i class="fas fa-check"></i> Accept
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="respondToRequest('${req.id}', 'rejected'); closeBottomSheetFunc();">
                                        <i class="fas fa-times"></i> Reject
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                }
                
                if (pendingLeaves.length > 0) {
                    html += `<div class="card">
                        <h3><i class="fas fa-calendar-times"></i> Pending Leave Requests (${pendingLeaves.length})</h3>`;
                    
                    pendingLeaves.slice(0, 3).forEach(req => {
                        html += `
                            <div style="padding: 10px; border-bottom: 1px solid #eee;">
                                <strong>${req.fromName}</strong> - ${req.leaveType}<br>
                                <small>${req.date} â€¢ ${req.duration} day(s)</small>
                                <div style="margin-top: 10px; display: flex; gap: 5px;">
                                    <button class="btn btn-sm btn-success" onclick="adminApprove('${req.id}'); closeBottomSheetFunc();">
                                        <i class="fas fa-check"></i> Approve
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="adminReject('${req.id}'); closeBottomSheetFunc();">
                                        <i class="fas fa-times"></i> Reject
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    
                    if (pendingLeaves.length > 3) {
                        html += `<div style="text-align: center; padding: 10px;">
                            <button class="btn btn-sm btn-primary" onclick="showSection('adminApprovals'); closeBottomSheetFunc();">
                                View All (${pendingLeaves.length})
                            </button>
                        </div>`;
                    }
                    
                    html += '</div>';
                }
                
                notificationsList.innerHTML = html;
            } else {
                notificationsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-bell-slash"></i>
                        <p>No new notifications</p>
                        <p style="font-size: 12px; margin-top: 10px;">You're all caught up!</p>
                    </div>
                `;
            }
        }
    }, 500);
}

function setupMobilePullToRefresh() {
    let startY = 0;
    let currentY = 0;
    const pullToRefresh = document.getElementById('pullToRefresh');
    const content = document.getElementById('bottomSheetContent');
    
    if (!pullToRefresh || !content) return;
    
    content.addEventListener('touchstart', function(e) {
        startY = e.touches[0].pageY;
    }, {passive: true});
    
    content.addEventListener('touchmove', function(e) {
        if (content.scrollTop === 0) {
            currentY = e.touches[0].pageY;
            const diff = currentY - startY;
            
            if (diff > 0) {
                e.preventDefault();
                pullToRefresh.style.transform = `translateY(${Math.min(diff, 60)}px)`;
                
                if (diff > 60) {
                    pullToRefresh.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> Refreshing...';
                }
            }
        }
    }, {passive: false});
    
    content.addEventListener('touchend', function() {
        if (currentY - startY > 60) {
            // Refresh notifications
            loadMobileNotifications();
        }
        pullToRefresh.style.transform = 'translateY(0)';
        pullToRefresh.innerHTML = '<i class="fas fa-arrow-down"></i> Pull down to refresh';
    }, {passive: true});
}

function closeBottomSheetFunc() {
    const bottomSheet = document.getElementById('bottomSheet');
    const bottomSheetOverlay = document.getElementById('bottomSheetOverlay');
    
    if (bottomSheet) bottomSheet.classList.remove('active');
    if (bottomSheetOverlay) bottomSheetOverlay.classList.remove('active');
}

function showMobileForm(formType) {
    let title = '';
    let formHtml = '';
    
    switch(formType) {
        case 'dutyChange':
            title = 'Duty Change Request';
            // Load form data first
            loadDutyChangeForm();
            formHtml = document.getElementById('dutyChangeForm').innerHTML;
            break;
        case 'leave':
            title = 'Leave Application';
            // Load form data first
            loadLeaveForm();
            formHtml = document.getElementById('leaveApplicationForm').innerHTML;
            break;
    }
    
    showBottomSheet(title, `
        <form id="mobileForm">
            ${formHtml}
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button type="submit" class="btn btn-success" style="flex: 1;">
                    <i class="fas fa-paper-plane"></i> Submit
                </button>
                <button type="button" class="btn btn-danger" onclick="closeBottomSheetFunc()" style="flex: 1;">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </form>
    `);
    
    // Reattach form submission
    const mobileForm = document.getElementById('mobileForm');
    if (mobileForm) {
        mobileForm.addEventListener('submit', function(e) {
            e.preventDefault();
            if (formType === 'dutyChange') {
                submitDutyChange();
            } else if (formType === 'leave') {
                submitLeaveApplication();
            }
            closeBottomSheetFunc();
        });
    }
}

function showBottomSheet(title, content) {
    const bottomSheet = document.getElementById('bottomSheet');
    const bottomSheetOverlay = document.getElementById('bottomSheetOverlay');
    const bottomSheetTitle = document.getElementById('bottomSheetTitle');
    const bottomSheetContent = document.getElementById('bottomSheetContent');
    
    if (!bottomSheet || !bottomSheetOverlay || !bottomSheetTitle || !bottomSheetContent) return;
    
    bottomSheetTitle.textContent = title;
    bottomSheetContent.innerHTML = content;
    
    bottomSheet.classList.add('active');
    bottomSheetOverlay.classList.add('active');
}

// ============================================
// UTILITY FUNCTIONS
// ============================================

function formatTimeAgo(timestamp) {
    const now = new Date();
    const past = new Date(timestamp);
    const diffMs = now - past;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMins / 60);
    const diffDays = Math.floor(diffHours / 24);
    
    if (diffMins < 1) return 'just now';
    if (diffMins < 60) return `${diffMins} minute${diffMins !== 1 ? 's' : ''} ago`;
    if (diffHours < 24) return `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
    if (diffDays < 7) return `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;
    
    return formatDate(timestamp);
}

function formatDateTime(timestamp) {
    const date = new Date(timestamp);
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString();
}

// ============================================
// SEARCH FUNCTIONALITY
// ============================================

function searchMyRequests(term) {
    const tbody = document.getElementById('myRequestsTable');
    if (!tbody) return;
    
    const rows = tbody.getElementsByTagName('tr');
    
    for (let row of rows) {
        const text = row.textContent.toLowerCase();
        if (text.includes(term.toLowerCase())) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    }
}

function searchAllRoster(term) {
    const container = document.getElementById('allRosterContainer');
    if (!container) return;
    
    // This would need to be implemented based on the current view type
    // For simplicity, we'll reload the roster with search highlighting
    loadAllRoster();
    
    // Add search highlighting logic here
    if (term) {
        setTimeout(() => {
            highlightSearchTerms(container, term);
        }, 100);
    }
}

function searchRequestHistory(term) {
    const tbody = document.getElementById('requestHistoryTable');
    if (!tbody) return;
    
    const rows = tbody.getElementsByTagName('tr');
    
    for (let row of rows) {
        const text = row.textContent.toLowerCase();
        if (text.includes(term.toLowerCase())) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    }
}

function highlightSearchTerms(container, term) {
    const elements = container.querySelectorAll('td, .staff-name, .balance-value');
    const searchTerm = term.toLowerCase();
    
    elements.forEach(element => {
        const originalHTML = element.innerHTML;
        const text = element.textContent.toLowerCase();
        
        if (text.includes(searchTerm)) {
            const regex = new RegExp(`(${searchTerm})`, 'gi');
            element.innerHTML = originalHTML.replace(regex, '<mark>$1</mark>');
        }
    });
}

// ============================================
// MOBILE OPTIMIZATION FUNCTIONS
// ============================================

function optimizeForMobile() {
    if (!isMobile) return;
    
    // Add mobile-specific classes
    document.body.classList.add('mobile-device');
    
    // Optimize touch events
    document.addEventListener('touchstart', function(e) {
        // Prevent zoom on input focus
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA') {
            e.target.style.fontSize = '16px'; // Prevents iOS zoom
        }
    }, {passive: true});
    
    // Restore font size after blur
    document.addEventListener('blur', function(e) {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA') {
            setTimeout(() => {
                e.target.style.fontSize = '';
            }, 100);
        }
    }, true);
    
    // Prevent long press on buttons
    document.addEventListener('contextmenu', function(e) {
        if (e.target.tagName === 'BUTTON' || e.target.classList.contains('btn')) {
            e.preventDefault();
        }
    });
}

// Initialize mobile optimization when DOM is loaded
if (isMobile) {
    document.addEventListener('DOMContentLoaded', optimizeForMobile);
}

// ============================================
// EXPORT FUNCTIONS FOR GLOBAL ACCESS
// ============================================

// Make essential functions available globally
window.showSection = showSection;
window.updateDashboard = updateDashboard;
window.loadMyRoster = loadMyRoster;
window.loadAllRoster = loadAllRoster;
window.printAllRoster = printAllRoster;
window.navigateAllRoster = navigateAllRoster;
window.cancelRequest = cancelRequest;
window.respondToRequest = respondToRequest;
window.selectPriority = selectPriority;
window.updateTargetSelection = updateTargetSelection;
window.clearAnnouncementForm = clearAnnouncementForm;
window.editAnnouncement = editAnnouncement;
window.updateAnnouncement = updateAnnouncement;
window.archiveAnnouncement = archiveAnnouncement;
window.deleteAnnouncement = deleteAnnouncement;
window.restoreAnnouncement = restoreAnnouncement;
window.processExcelPaste = processExcelPaste;
window.saveExcelData = saveExcelData;
window.clearExcelPaste = clearExcelPaste;
window.addRosterEntry = addRosterEntry;
window.clearRosterForm = clearRosterForm;
window.editRosterEntry = editRosterEntry;
window.deleteRosterEntry = deleteRosterEntry;
window.loadRosterView = loadRosterView;
window.showRosterTab = showRosterTab;
window.updateTempBalance = updateTempBalance;
window.saveAllBalances = saveAllBalances;
window.resetAllBalances = resetAllBalances;
window.resetUserBalance = resetUserBalance;
window.saveIndividualBalance = saveIndividualBalance;
window.resetIndividualBalance = resetIndividualBalance;
window.showBalanceTab = showBalanceTab;
window.adminApprove = adminApprove;
window.adminApplyDutyChange = adminApplyDutyChange;
window.adminReject = adminReject;
window.showApprovalsTab = showApprovalsTab;
window.loadRequestHistory = loadRequestHistory;
window.clearHistoryFilters = clearHistoryFilters;
window.toggleMobileMenu = toggleMobileMenu;
window.showMobileForm = showMobileForm;
window.closeBottomSheetFunc = closeBottomSheetFunc;

// Initialize when window loads
window.addEventListener('load', function() {
    // Check if we're on a mobile device
    if (isMobile) {
        console.log('Mobile device detected, optimizing interface...');
        // Additional mobile optimizations can go here
    }
    
    // Check for updates every 5 minutes
    setInterval(() => {
        if (currentUser) {
            updateRequestCounts();
            loadHomeAnnouncements();
        }
    }, 5 * 60 * 1000);
});

// Handle page visibility changes
document.addEventListener('visibilitychange', function() {
    if (!document.hidden && currentUser) {
        // Page became visible, refresh data
        updateDashboard();
        updateRequestCounts();
    }
});

// Handle beforeunload to save data
window.addEventListener('beforeunload', function() {
    if (currentUser) {
        // Save all data before leaving
        saveDutyRoster();
        saveLeaveBalances();
        saveAllRequests();
        saveAnnouncements();
    }
});
    </script>
</body>
</html>
