<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Duty Management System</title>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <!-- SHA-256 Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js"></script>
    
    <!-- Ionicons for Mobile Icons -->
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    
    <!-- External Firebase and User files -->
    <script src="dcfire.js" defer></script>
    <script src="user.js" defer></script>
    
    <style>
        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #3498db;
            --primary-dark: #2980b9;
            --secondary: #2c3e50;
            --success: #27ae60;
            --danger: #e74c3c;
            --warning: #f39c12;
            --info: #17a2b8;
            --light: #f8f9fa;
            --dark: #343a40;
            --gray: #6c757d;
            --light-gray: #e9ecef;
            --white: #ffffff;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            --radius: 10px;
            --radius-sm: 5px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--light);
            color: var(--dark);
            line-height: 1.5;
            overflow-x: hidden;
            min-height: 100vh;
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* Mobile Optimized Container */
        .app-container {
            max-width: 100%;
            min-height: 100vh;
            position: relative;
            background: var(--white);
        }

        /* Login Screen */
        .login-screen {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        }

        .login-card {
            background: var(--white);
            border-radius: var(--radius);
            padding: 30px 20px;
            box-shadow: var(--shadow);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .app-logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .app-logo h1 {
            font-size: 24px;
            color: var(--secondary);
            margin-bottom: 5px;
            font-weight: 600;
        }

        .app-logo p {
            color: var(--gray);
            font-size: 14px;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--secondary);
        }

        .form-control {
            width: 100%;
            padding: 14px;
            border: 2px solid var(--light-gray);
            border-radius: var(--radius-sm);
            font-size: 16px;
            transition: all 0.3s;
            background: var(--white);
            -webkit-appearance: none;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 14px 24px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            gap: 8px;
            width: 100%;
            -webkit-touch-callout: none;
            user-select: none;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: var(--primary);
            color: var(--white);
        }

        .btn-primary:active {
            background: var(--primary-dark);
        }

        .btn-success {
            background: var(--success);
            color: var(--white);
        }

        .btn-danger {
            background: var(--danger);
            color: var(--white);
        }

        .btn-warning {
            background: var(--warning);
            color: var(--white);
        }

        .btn-secondary {
            background: var(--gray);
            color: var(--white);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 14px;
        }

        .btn-icon {
            width: 44px;
            height: 44px;
            padding: 0;
            border-radius: 50%;
        }

        /* Dashboard Layout */
        .dashboard {
            display: none;
            min-height: 100vh;
            position: relative;
            padding-top: env(safe-area-inset-top);
        }

        /* Header */
        .app-header {
            background: linear-gradient(135deg, var(--secondary) 0%, var(--primary) 100%);
            color: var(--white);
            padding: 15px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding-top: calc(15px + env(safe-area-inset-top));
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .user-info {
            flex: 1;
        }

        .user-info h2 {
            font-size: 18px;
            margin-bottom: 4px;
            font-weight: 600;
        }

        .user-details {
            font-size: 12px;
            opacity: 0.9;
            display: flex;
            gap: 10px;
        }

        .menu-btn {
            background: none;
            border: none;
            color: var(--white);
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            margin-left: 10px;
        }

        /* Side Menu */
        .side-menu {
            position: fixed;
            top: 0;
            left: -280px;
            width: 280px;
            height: 100%;
            background: var(--white);
            z-index: 1000;
            transition: left 0.3s ease;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            padding-top: env(safe-area-inset-top);
        }

        .side-menu.open {
            left: 0;
        }

        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }

        .menu-overlay.active {
            display: block;
        }

        .menu-header {
            padding: 20px;
            background: linear-gradient(135deg, var(--secondary) 0%, var(--primary) 100%);
            color: var(--white);
        }

        .menu-header h3 {
            font-size: 20px;
            margin-bottom: 5px;
        }

        .menu-header p {
            font-size: 12px;
            opacity: 0.9;
        }

        .menu-items {
            padding: 10px 0;
            max-height: calc(100vh - 150px);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            color: var(--dark);
            text-decoration: none;
            border-left: 4px solid transparent;
            transition: all 0.3s;
            gap: 12px;
        }

        .menu-item:hover,
        .menu-item.active {
            background: rgba(52, 152, 219, 0.1);
            border-left-color: var(--primary);
            color: var(--primary);
        }

        .menu-item .icon {
            font-size: 20px;
            width: 24px;
            text-align: center;
        }

        .menu-item .badge {
            margin-left: auto;
            background: var(--danger);
            color: var(--white);
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 10px;
            min-width: 20px;
            text-align: center;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            border-top: 1px solid var(--light-gray);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            z-index: 100;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--gray);
            padding: 8px;
            flex: 1;
            transition: all 0.3s;
            -webkit-tap-highlight-color: transparent;
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-item .icon {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .nav-item .label {
            font-size: 11px;
            font-weight: 500;
        }

        /* Content Area */
        .content-area {
            padding: 15px;
            padding-bottom: calc(70px + env(safe-area-inset-bottom));
            min-height: 100vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Cards */
        .card {
            background: var(--white);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
            border: 1px solid var(--light-gray);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary);
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--secondary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-title .icon {
            font-size: 20px;
        }

        /* Dashboard Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: var(--white);
            border-radius: var(--radius-sm);
            padding: 15px;
            text-align: center;
        }

        .stat-card:nth-child(2) {
            background: linear-gradient(135deg, var(--success) 0%, #219653 100%);
        }

        .stat-card:nth-child(3) {
            background: linear-gradient(135deg, var(--warning) 0%, #d68910 100%);
        }

        .stat-card:nth-child(4) {
            background: linear-gradient(135deg, var(--danger) 0%, #c0392b 100%);
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        /* Announcements */
        .announcement {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--white);
            border-radius: var(--radius);
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
        }

        .announcement.priority-high {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .announcement.priority-medium {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .announcement.priority-low {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }

        .announcement-title {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .announcement-content {
            font-size: 13px;
            opacity: 0.95;
            margin-bottom: 10px;
        }

        .announcement-meta {
            font-size: 11px;
            opacity: 0.8;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Forms */
        .form-row {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        @media (min-width: 768px) {
            .form-row {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        textarea.form-control {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }

        select.form-control {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 16px;
            padding-right: 40px;
        }

        /* Tables */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-top: 15px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--light-gray);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--white);
            min-width: 600px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--light-gray);
            font-size: 14px;
        }

        th {
            background: var(--light);
            font-weight: 600;
            color: var(--secondary);
            font-size: 13px;
            position: sticky;
            left: 0;
        }

        tr:last-child td {
            border-bottom: none;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 60px;
        }

        .action-btn.approve {
            background: #d4edda;
            color: #155724;
        }

        .action-btn.reject {
            background: #f8d7da;
            color: #721c24;
        }

        .action-btn.view {
            background: #d1ecf1;
            color: #0c5460;
        }

        .action-btn.apply {
            background: #cce5ff;
            color: #004085;
        }

        /* Status Badges */
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-approved {
            background: #d4edda;
            color: #155724;
        }

        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }

        .status-off {
            background: #e2e3e5;
            color: #383d41;
        }

        /* Alerts */
        .alert {
            padding: 12px 15px;
            border-radius: var(--radius-sm);
            margin-bottom: 15px;
            border-left: 4px solid;
            font-size: 14px;
        }

        .alert-info {
            background: #e8f4fc;
            border-color: var(--primary);
            color: var(--secondary);
        }

        .alert-success {
            background: #d4edda;
            border-color: var(--success);
            color: #155724;
        }

        .alert-warning {
            background: #fff3cd;
            border-color: var(--warning);
            color: #856404;
        }

        .alert-danger {
            background: #f8d7da;
            border-color: var(--danger);
            color: #721c24;
        }

        /* Roster Colors */
        .duty-0730-1530 {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%) !important;
            color: #856404 !important;
        }
        
        .duty-0830-1630 {
            background: linear-gradient(135deg, #e2d9f3 0%, #d6c6f7 100%) !important;
            color: #563d7c !important;
        }
        
        .duty-1030-1830 {
            background: linear-gradient(135deg, #fffde7 0%, #fff9c4 100%) !important;
            color: #827717 !important;
        }
        
        .duty-1530-2330 {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%) !important;
            color: #0d47a1 !important;
        }
        
        .duty-1630-0030 {
            background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%) !important;
            color: #424242 !important;
        }
        
        .duty-1730-0130 {
            background: linear-gradient(135deg, #eeeeee 0%, #bdbdbd 100%) !important;
            color: #212121 !important;
        }
        
        .duty-0030-0830 {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%) !important;
            color: #c62828 !important;
        }
        
        .duty-leave {
            background: linear-gradient(135deg, #ffd8a6 0%, #ffc078 100%) !important;
            color: #e8590c !important;
            border: 1px dashed #fd7e14 !important;
        }
        
        .off-day-cell {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%) !important;
            color: #155724 !important;
        }

        .today-cell {
            border: 2px solid var(--primary) !important;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.3) !important;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 5px;
        }

        .tab-btn {
            padding: 10px 15px;
            border: none;
            background: var(--light);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .tab-btn.active {
            background: var(--primary);
            color: var(--white);
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray);
        }

        .spinner {
            border: 3px solid var(--light-gray);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            max-width: 300px;
        }

        .toast {
            background: var(--white);
            border-radius: var(--radius);
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            animation: slideInRight 0.3s ease;
            border-left: 4px solid var(--primary);
        }

        .toast.success {
            border-left-color: var(--success);
        }

        .toast.error {
            border-left-color: var(--danger);
        }

        .toast.warning {
            border-left-color: var(--warning);
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--white);
            border-radius: var(--radius);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--secondary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--gray);
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--light-gray);
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* Swipe Actions */
        .swipe-actions {
            display: flex;
        }

        .swipe-action {
            padding: 10px 15px;
            border: none;
            color: var(--white);
            font-size: 14px;
            cursor: pointer;
            flex: 1;
        }

        .swipe-action.approve {
            background: var(--success);
        }

        .swipe-action.reject {
            background: var(--danger);
        }

        /* Pull to Refresh */
        .refresh-indicator {
            position: absolute;
            top: -50px;
            left: 0;
            right: 0;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .refresh-indicator.active {
            opacity: 1;
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray);
        }

        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.3;
        }

        /* Print Styles */
        @media print {
            .bottom-nav,
            .menu-btn,
            .action-buttons {
                display: none !important;
            }
            
            .content-area {
                padding-bottom: 20px;
            }
            
            .card {
                box-shadow: none;
                border: 1px solid #000;
            }
        }

        /* Landscape Optimization */
        @media (orientation: landscape) {
            .form-row {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .quick-actions {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* Dark Mode Support */
        @media (prefers-color-scheme: dark) {
            :root {
                --primary: #3498db;
                --primary-dark: #2980b9;
                --secondary: #ecf0f1;
                --success: #27ae60;
                --danger: #e74c3c;
                --warning: #f39c12;
                --info: #17a2b8;
                --light: #2c3e50;
                --dark: #ecf0f1;
                --gray: #bdc3c7;
                --light-gray: #34495e;
                --white: #1a252f;
            }
            
            body {
                background: #1a252f;
                color: var(--dark);
            }
            
            .card {
                background: var(--white);
                border-color: var(--light-gray);
            }
            
            .form-control {
                background: var(--light);
                border-color: var(--light-gray);
                color: var(--dark);
            }
            
            table {
                background: var(--white);
            }
            
            th {
                background: var(--light);
            }
        }

        /* iOS Safe Areas */
        @supports (padding: max(0px)) {
            .content-area {
                padding-left: max(15px, env(safe-area-inset-left));
                padding-right: max(15px, env(safe-area-inset-right));
            }
            
            .bottom-nav {
                padding-left: max(10px, env(safe-area-inset-left));
                padding-right: max(10px, env(safe-area-inset-right));
            }
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Login Screen -->
    <div class="app-container" id="loginScreen">
        <div class="login-screen">
            <div class="login-card">
                <div class="app-logo">
                    <h1>Duty Management</h1>
                    <p>Secure Mobile Access</p>
                </div>
                
                <form id="loginForm">
                    <div class="form-group">
                        <label for="username" class="form-label">Username</label>
                        <input type="text" id="username" class="form-control" placeholder="Enter username" required autofocus>
                    </div>
                    
                    <div class="form-group">
                        <label for="password" class="form-label">Password</label>
                        <input type="password" id="password" class="form-control" placeholder="Enter password" required>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" id="loginBtn">
                        <ion-icon name="log-in-outline"></ion-icon>
                        Login
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="dashboard" id="dashboard">
        <!-- Header -->
        <header class="app-header">
            <div class="header-content">
                <div class="user-info">
                    <h2 id="userName">User Name</h2>
                    <div class="user-details">
                        <span>RC: <span id="userRC">000</span></span>
                        <span>Level: <span id="userLevel">User</span></span>
                    </div>
                </div>
                <button class="menu-btn" id="menuBtn">
                    <ion-icon name="menu-outline"></ion-icon>
                </button>
            </div>
        </header>

        <!-- Side Menu -->
        <div class="menu-overlay" id="menuOverlay"></div>
        <div class="side-menu" id="sideMenu">
            <div class="menu-header">
                <h3 id="menuUserName">User Name</h3>
                <p>RC: <span id="menuUserRC">000</span> â€¢ Level: <span id="menuUserLevel">User</span></p>
            </div>
            
            <div class="menu-items">
                <!-- Common Menu Items -->
                <a href="#" class="menu-item active" data-section="home">
                    <ion-icon name="home-outline" class="icon"></ion-icon>
                    Dashboard
                </a>
                <a href="#" class="menu-item" data-section="dutyChange">
                    <ion-icon name="swap-horizontal-outline" class="icon"></ion-icon>
                    Duty Change
                </a>
                <a href="#" class="menu-item" data-section="leaveApplication">
                    <ion-icon name="calendar-outline" class="icon"></ion-icon>
                    Apply Leave
                </a>
                <a href="#" class="menu-item" data-section="myRequests">
                    <ion-icon name="document-text-outline" class="icon"></ion-icon>
                    My Requests
                </a>
                <a href="#" class="menu-item" data-section="viewMyRoster">
                    <ion-icon name="time-outline" class="icon"></ion-icon>
                    My Roster
                </a>
                <a href="#" class="menu-item" data-section="viewAllRoster">
                    <ion-icon name="people-outline" class="icon"></ion-icon>
                    All Roster
                </a>
                <a href="#" class="menu-item" data-section="pendingRequests" id="pendingRequestsMenu">
                    <ion-icon name="notifications-outline" class="icon"></ion-icon>
                    Pending Requests
                    <span class="badge" id="pendingCountMenu">0</span>
                </a>
                
                <!-- Admin Menu Items -->
                <div class="menu-header" style="background: #34495e; padding: 10px 20px; margin-top: 10px;">
                    <h4 style="font-size: 14px;">Admin Tools</h4>
                </div>
                <a href="#" class="menu-item" data-section="adminDutyRoster" id="adminDutyRosterMenu" style="display: none;">
                    <ion-icon name="grid-outline" class="icon"></ion-icon>
                    Duty Roster
                </a>
                <a href="#" class="menu-item" data-section="adminLeaveBalance" id="adminLeaveBalanceMenu" style="display: none;">
                    <ion-icon name="calculator-outline" class="icon"></ion-icon>
                    Leave Balance
                </a>
                <a href="#" class="menu-item" data-section="adminApprovals" id="adminApprovalsMenu" style="display: none;">
                    <ion-icon name="checkmark-done-outline" class="icon"></ion-icon>
                    Approvals
                    <span class="badge" id="approvalCountMenu" style="display: none;">0</span>
                </a>
                <a href="#" class="menu-item" data-section="adminRequestHistory" id="adminRequestHistoryMenu" style="display: none;">
                    <ion-icon name="archive-outline" class="icon"></ion-icon>
                    Request History
                </a>
                <a href="#" class="menu-item" data-section="adminAnnouncements" id="adminAnnouncementsMenu" style="display: none;">
                    <ion-icon name="megaphone-outline" class="icon"></ion-icon>
                    Announcements
                </a>
                
                <div class="menu-item" style="border-top: 1px solid var(--light-gray); margin-top: 10px;">
                    <button class="btn btn-danger" id="logoutBtn" style="width: 100%;">
                        <ion-icon name="log-out-outline"></ion-icon>
                        Logout
                    </button>
                </div>
            </div>
        </div>

        <!-- Content Area -->
        <div class="content-area" id="contentArea">
            <!-- Dashboard Section -->
            <div class="section active" id="homeSection">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <ion-icon name="home-outline"></ion-icon>
                            Dashboard
                        </h3>
                        <button class="btn btn-sm btn-primary" onclick="updateDashboard()">
                            <ion-icon name="refresh-outline"></ion-icon>
                            Refresh
                        </button>
                    </div>
                    
                    <div id="homeAnnouncements">
                        <!-- Announcements will be loaded here -->
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="slBalance">0</div>
                            <div class="stat-label">Sick Leave</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="frlBalance">0</div>
                            <div class="stat-label">FRL Balance</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="todayDutyTimeStat">-</div>
                            <div class="stat-label">Today's Duty</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="pendingRequestsStat">0</div>
                            <div class="stat-label">Pending</div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <p><strong>Today's Duty:</strong> <span id="todayDutyTime">Not Scheduled</span></p>
                        <p><strong>Next Duty:</strong> <span id="nextDutyTime">No upcoming duty</span></p>
                    </div>
                    
                    <div class="quick-actions">
                        <button class="btn btn-primary" onclick="showSection('dutyChange')">
                            <ion-icon name="swap-horizontal-outline"></ion-icon>
                            Duty Change
                        </button>
                        <button class="btn btn-success" onclick="showSection('leaveApplication')">
                            <ion-icon name="calendar-outline"></ion-icon>
                            Apply Leave
                        </button>
                        <button class="btn btn-warning" onclick="showSection('myRequests')">
                            <ion-icon name="document-text-outline"></ion-icon>
                            My Requests
                        </button>
                        <button class="btn btn-secondary" onclick="showSection('viewAllRoster')">
                            <ion-icon name="people-outline"></ion-icon>
                            All Roster
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <ion-icon name="notifications-outline"></ion-icon>
                            Recent Updates
                        </h3>
                    </div>
                    <div id="recentUpdates">
                        <!-- Recent updates will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Other sections will be inserted here by JavaScript -->
            <div id="sectionContainer"></div>
        </div>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <a href="#" class="nav-item active" data-section="home">
                <ion-icon name="home-outline" class="icon"></ion-icon>
                <span class="label">Home</span>
            </a>
            <a href="#" class="nav-item" data-section="dutyChange">
                <ion-icon name="swap-horizontal-outline" class="icon"></ion-icon>
                <span class="label">Change</span>
            </a>
            <a href="#" class="nav-item" data-section="leaveApplication">
                <ion-icon name="calendar-outline" class="icon"></ion-icon>
                <span class="label">Leave</span>
            </a>
            <a href="#" class="nav-item" data-section="myRequests">
                <ion-icon name="document-text-outline" class="icon"></ion-icon>
                <span class="label">Requests</span>
            </a>
            <a href="#" class="nav-item" id="moreNavItem">
                <ion-icon name="menu-outline" class="icon"></ion-icon>
                <span class="label">More</span>
            </a>
        </nav>
    </div>

    <!-- Loading Modal -->
    <div class="modal" id="loadingModal">
        <div class="modal-content">
            <div class="modal-body">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal" id="confirmModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="confirmTitle">Confirm Action</h3>
                <button class="modal-close" onclick="hideModal('confirmModal')">
                    <ion-icon name="close-outline"></ion-icon>
                </button>
            </div>
            <div class="modal-body">
                <p id="confirmMessage">Are you sure you want to perform this action?</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('confirmModal')">Cancel</button>
                <button class="btn btn-danger" id="confirmActionBtn">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let allUsers = [];
        let dutyRoster = {};
        let leaveBalances = {};
        let allRequests = [];
        let announcements = [];
        let userDisplayNameMap = {};
        let firebaseReady = false;
        let currentSection = 'home';
        let pendingConfirmAction = null;

        // Wait for Firebase and user data to load
        document.addEventListener('DOMContentLoaded', function() {
            // Check if Firebase is available
            if (typeof db === 'undefined') {
                console.error('Firebase is not initialized. Make sure dcfire.js is loaded.');
                showToast('Firebase initialization failed. Please check your configuration.', 'error');
                return;
            }
            
            // Wait a bit for user data to load
            setTimeout(() => {
                if (typeof users === 'undefined') {
                    console.error('User data not loaded. Make sure user.js is loaded.');
                    showToast('User data not loaded. Please check user.js file.', 'error');
                    return;
                }
                
                firebaseReady = true;
                console.log('Firebase and user data loaded successfully');
                initApp();
            }, 1000);
        });

        // Initialize the application
        function initApp() {
            if (!firebaseReady) {
                console.log('Waiting for Firebase to be ready...');
                setTimeout(initApp, 500);
                return;
            }
            
            console.log('Initializing mobile application...');
            
            // Setup login form
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                handleLogin();
            });
            
            // Setup menu toggle
            document.getElementById('menuBtn').addEventListener('click', toggleMenu);
            document.getElementById('menuOverlay').addEventListener('click', toggleMenu);
            document.getElementById('moreNavItem').addEventListener('click', function(e) {
                e.preventDefault();
                toggleMenu();
            });
            
            // Setup menu item clicks
            document.querySelectorAll('.menu-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (this.dataset.section) {
                        showSection(this.dataset.section);
                        toggleMenu();
                    }
                });
            });
            
            // Setup bottom navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (this.dataset.section) {
                        showSection(this.dataset.section);
                        setActiveNavItem(this.dataset.section);
                    }
                });
            });
            
            // Setup logout
            document.getElementById('logoutBtn').addEventListener('click', function() {
                confirmAction('Logout', 'Are you sure you want to logout?', function() {
                    localStorage.removeItem('dutySystemSession');
                    location.reload();
                });
            });
            
            // Set minimum dates for forms
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('loginForm').querySelector('#username').focus();
            
            // Check for existing session
            checkSession();
            
            // Initialize touch events for mobile
            initTouchEvents();
        }

        // Initialize touch events for mobile
        function initTouchEvents() {
            let touchStartY = 0;
            let touchEndY = 0;
            
            document.addEventListener('touchstart', function(e) {
                touchStartY = e.changedTouches[0].screenY;
            }, { passive: true });
            
            document.addEventListener('touchend', function(e) {
                touchEndY = e.changedTouches[0].screenY;
                
                // Pull to refresh logic
                if (touchStartY - touchEndY > 100) {
                    // Swipe up
                    if (currentSection === 'home') {
                        updateDashboard();
                        showToast('Refreshed dashboard', 'success');
                    }
                }
            }, { passive: true });
            
            // Prevent zoom on double tap
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function(event) {
                const now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    event.preventDefault();
                }
                lastTouchEnd = now;
            }, false);
        }

        // Check for existing session
        function checkSession() {
            const session = localStorage.getItem('dutySystemSession');
            if (session) {
                try {
                    const user = JSON.parse(session);
                    if (user.expiry > Date.now()) {
                        loginUser(user);
                    } else {
                        localStorage.removeItem('dutySystemSession');
                        showToast('Session expired. Please login again.', 'warning');
                    }
                } catch (e) {
                    localStorage.removeItem('dutySystemSession');
                }
            }
        }

        // Handle login
        function handleLogin() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            
            if (!username || !password) {
                showToast('Please enter both username and password', 'warning');
                return;
            }
            
            if (!users || !Array.isArray(users)) {
                showToast('User database not loaded', 'error');
                return;
            }
            
            const user = users.find(u => u.username === username);
            
            if (!user) {
                showToast('Invalid username or password', 'error');
                return;
            }
            
            // Hash and check password
            const hashedPassword = sha256(password);
            
            if (hashedPassword === user.passwordHash) {
                showLoading('Logging in...');
                
                setTimeout(() => {
                    const sessionData = {
                        username: user.username,
                        name: user.name,
                        rcNo: user.RCNo,
                        level: user.Level,
                        expiry: Date.now() + (8 * 60 * 60 * 1000) // 8 hours
                    };
                    
                    localStorage.setItem('dutySystemSession', JSON.stringify(sessionData));
                    loginUser(sessionData);
                    hideLoading();
                    showToast('Login successful!', 'success');
                }, 1000);
            } else {
                showToast('Invalid username or password', 'error');
            }
        }

        // Login user
        function loginUser(userData) {
            currentUser = userData;
            allUsers = users || [];
            
            console.log('User logged in:', currentUser);
            
            // Initialize user display name map
            initializeUserDisplayMap();
            
            // Update UI
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            
            // Update user info
            document.getElementById('userName').textContent = userData.name;
            document.getElementById('userRC').textContent = userData.rcNo;
            document.getElementById('userLevel').textContent = userData.level;
            document.getElementById('menuUserName').textContent = userData.name;
            document.getElementById('menuUserRC').textContent = userData.rcNo;
            document.getElementById('menuUserLevel').textContent = userData.level;
            
            // Show/hide admin sections
            if (userData.level === 'Supervisor') {
                document.querySelectorAll('[id$="Menu"]').forEach(el => {
                    if (el.id.includes('admin')) {
                        el.style.display = 'flex';
                    }
                });
            }
            
            // Initialize data and UI
            initializeData();
            setupEventListeners();
            updateDashboard();
            
            // Setup real-time listeners
            setupRealtimeListeners();
        }

        // Initialize user display map
        function initializeUserDisplayMap() {
            userDisplayNameMap = {};
            allUsers.forEach(user => {
                userDisplayNameMap[user.name] = user.username;
                userDisplayNameMap[user.RCNo] = user.username;
                userDisplayNameMap[user.username] = user.username;
                
                // For names like "Irufan1", "Irufan2"
                if (user.name.includes('Irufan')) {
                    const match = user.name.match(/Irufan\s*(\d*)/i);
                    if (match && match[1]) {
                        userDisplayNameMap[`Irufan${match[1]}`] = user.username;
                    }
                }
                
                // Map common variations
                const nameLower = user.name.toLowerCase();
                const usernameLower = user.username.toLowerCase();
                userDisplayNameMap[nameLower] = user.username;
                userDisplayNameMap[usernameLower] = user.username;
            });
            
            console.log('User display map initialized');
        }

        // Initialize data from Firebase
        async function initializeData() {
            console.log('Initializing all data from Firebase...');
            showLoading('Loading data...');
            
            try {
                // Load all data from Firebase
                await Promise.all([
                    loadDutyRoster(),
                    loadLeaveBalances(),
                    loadAllRequests(),
                    loadAnnouncements()
                ]);
                
                console.log('All data loaded successfully from Firebase');
                
                // Update user's balance display
                updateUserBalance();
                hideLoading();
                
            } catch (error) {
                console.error('Error initializing data:', error);
                hideLoading();
                showToast('Failed to load data. Please refresh.', 'error');
            }
        }

        // FIREBASE FUNCTIONS
        async function loadDutyRoster() {
            console.log('Loading duty roster from Firebase...');
            try {
                const doc = await db.collection('dutyRoster').doc('current').get();
                if (doc.exists) {
                    dutyRoster = doc.data() || {};
                    console.log('Duty roster loaded:', Object.keys(dutyRoster).length, 'dates');
                } else {
                    dutyRoster = {};
                    await saveDutyRoster();
                }
            } catch (error) {
                console.error('Error loading duty roster:', error);
                dutyRoster = {};
            }
        }

        async function saveDutyRoster() {
            console.log('Saving duty roster to Firebase...');
            try {
                await db.collection('dutyRoster').doc('current').set(dutyRoster);
                console.log('Duty roster saved');
            } catch (error) {
                console.error('Error saving duty roster:', error);
                throw error;
            }
        }

        async function loadLeaveBalances() {
            console.log('Loading leave balances from Firebase...');
            try {
                const doc = await db.collection('leaveBalances').doc('current').get();
                if (doc.exists) {
                    leaveBalances = doc.data() || {};
                    console.log('Leave balances loaded:', Object.keys(leaveBalances).length, 'users');
                } else {
                    leaveBalances = {};
                    allUsers.forEach(user => {
                        leaveBalances[user.username] = {
                            SL: 12,
                            FRL: 6
                        };
                    });
                    await saveLeaveBalances();
                }
            } catch (error) {
                console.error('Error loading leave balances:', error);
                leaveBalances = {};
            }
        }

        async function saveLeaveBalances() {
            console.log('Saving leave balances to Firebase...');
            try {
                await db.collection('leaveBalances').doc('current').set(leaveBalances);
                console.log('Leave balances saved');
            } catch (error) {
                console.error('Error saving leave balances:', error);
                throw error;
            }
        }

        async function loadAllRequests() {
            console.log('Loading all requests from Firebase...');
            try {
                const doc = await db.collection('requests').doc('all').get();
                if (doc.exists && doc.data().requests) {
                    allRequests = doc.data().requests;
                    console.log('Requests loaded:', allRequests.length, 'requests');
                } else {
                    allRequests = [];
                }
                updateRequestCounts();
            } catch (error) {
                console.error('Error loading requests:', error);
                allRequests = [];
            }
        }

        async function saveAllRequests() {
            console.log('Saving all requests to Firebase...');
            try {
                await db.collection('requests').doc('all').set({ requests: allRequests });
                console.log('Requests saved');
            } catch (error) {
                console.error('Error saving requests:', error);
                throw error;
            }
        }

        async function loadAnnouncements() {
            console.log('Loading announcements from Firebase...');
            try {
                const doc = await db.collection('announcements').doc('all').get();
                if (doc.exists && doc.data().announcements) {
                    announcements = doc.data().announcements;
                    console.log('Announcements loaded:', announcements.length, 'announcements');
                } else {
                    announcements = [];
                    await saveAnnouncements();
                }
            } catch (error) {
                console.error('Error loading announcements:', error);
                announcements = [];
            }
        }

        async function saveAnnouncements() {
            console.log('Saving announcements to Firebase...');
            try {
                await db.collection('announcements').doc('all').set({ announcements: announcements });
                console.log('Announcements saved');
            } catch (error) {
                console.error('Error saving announcements:', error);
                throw error;
            }
        }

        // Update user balance display
        function updateUserBalance() {
            if (!currentUser) return;
            
            const balance = leaveBalances[currentUser.username] || {SL: 0, FRL: 0};
            document.getElementById('slBalance').textContent = balance.SL.toFixed(1);
            document.getElementById('frlBalance').textContent = balance.FRL.toFixed(1);
        }

        // Update request counts
        function updateRequestCounts() {
            if (!currentUser) return;
            
            // Count pending requests for current user
            const pendingForUser = allRequests.filter(req => 
                req.status === 'pending' && 
                req.type === 'dutyChange' && 
                req.toUsername === currentUser.username
            ).length;
            
            // Update menu badge
            const pendingBadge = document.getElementById('pendingCountMenu');
            if (pendingForUser > 0) {
                pendingBadge.textContent = pendingForUser;
                pendingBadge.style.display = 'inline-block';
                document.getElementById('pendingRequestsStat').textContent = pendingForUser;
                document.getElementById('pendingRequestsMenu').style.display = 'flex';
            } else {
                pendingBadge.style.display = 'none';
                document.getElementById('pendingRequestsStat').textContent = '0';
            }
            
            // Update approval badge for supervisor
            if (currentUser.level === 'Supervisor') {
                const pendingApprovals = allRequests.filter(req => 
                    req.status === 'pending' && 
                    (req.type === 'leave' || req.type === 'dutyChange')
                ).length;
                
                const approvalBadge = document.getElementById('approvalCountMenu');
                if (pendingApprovals > 0) {
                    approvalBadge.textContent = pendingApprovals;
                    approvalBadge.style.display = 'inline-block';
                } else {
                    approvalBadge.style.display = 'none';
                }
            }
        }

        // Toggle side menu
        function toggleMenu() {
            const menu = document.getElementById('sideMenu');
            const overlay = document.getElementById('menuOverlay');
            menu.classList.toggle('open');
            overlay.classList.toggle('active');
            document.body.style.overflow = menu.classList.contains('open') ? 'hidden' : '';
        }

        // Show section
        function showSection(sectionId) {
            currentSection = sectionId;
            
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Remove active from all menu items
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Set active nav item
            setActiveNavItem(sectionId);
            
            // Set active menu item
            const menuItem = document.querySelector(`.menu-item[data-section="${sectionId}"]`);
            if (menuItem) {
                menuItem.classList.add('active');
            }
            
            // Check if section exists in content area
            let section = document.getElementById(sectionId + 'Section');
            
            if (!section) {
                // Create section if it doesn't exist
                section = createSection(sectionId);
                document.getElementById('sectionContainer').appendChild(section);
            }
            
            // Show section
            section.classList.add('active');
            
            // Load section data
            loadSectionData(sectionId);
            
            // Scroll to top
            document.getElementById('contentArea').scrollTop = 0;
        }

        // Set active navigation item
        function setActiveNavItem(sectionId) {
            // Only set active for main nav items
            const mainSections = ['home', 'dutyChange', 'leaveApplication', 'myRequests'];
            if (mainSections.includes(sectionId)) {
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.dataset.section === sectionId) {
                        item.classList.add('active');
                    }
                });
            } else {
                // For other sections, set "More" as active
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.id === 'moreNavItem') {
                        item.classList.add('active');
                    }
                });
            }
        }

        // Create section dynamically
        function createSection(sectionId) {
            const section = document.createElement('div');
            section.id = sectionId + 'Section';
            section.className = 'section';
            
            // Create section content based on sectionId
            let content = '';
            
            switch(sectionId) {
                case 'dutyChange':
                    content = createDutyChangeSection();
                    break;
                case 'leaveApplication':
                    content = createLeaveApplicationSection();
                    break;
                case 'myRequests':
                    content = createMyRequestsSection();
                    break;
                case 'viewMyRoster':
                    content = createViewMyRosterSection();
                    break;
                case 'viewAllRoster':
                    content = createViewAllRosterSection();
                    break;
                case 'pendingRequests':
                    content = createPendingRequestsSection();
                    break;
                case 'adminDutyRoster':
                    content = createAdminDutyRosterSection();
                    break;
                case 'adminLeaveBalance':
                    content = createAdminLeaveBalanceSection();
                    break;
                case 'adminApprovals':
                    content = createAdminApprovalsSection();
                    break;
                case 'adminRequestHistory':
                    content = createAdminRequestHistorySection();
                    break;
                case 'adminAnnouncements':
                    content = createAdminAnnouncementsSection();
                    break;
                default:
                    content = '<div class="card"><p>Section not found</p></div>';
            }
            
            section.innerHTML = content;
            return section;
        }

        // Load section data
        function loadSectionData(sectionId) {
            switch(sectionId) {
                case 'home':
                    loadHomeAnnouncements();
                    loadRecentUpdates();
                    break;
                case 'dutyChange':
                    loadDutyChangeForm();
                    break;
                case 'leaveApplication':
                    loadLeaveForm();
                    break;
                case 'myRequests':
                    loadMyRequests();
                    break;
                case 'viewMyRoster':
                    loadMyRoster();
                    break;
                case 'viewAllRoster':
                    loadAllRoster();
                    break;
                case 'pendingRequests':
                    loadPendingRequests();
                    break;
                case 'adminAnnouncements':
                    loadAnnouncementsAdmin();
                    break;
                case 'adminDutyRoster':
                    loadDutyRosterAdmin();
                    break;
                case 'adminLeaveBalance':
                    loadLeaveBalanceAdmin();
                    break;
                case 'adminApprovals':
                    loadAdminApprovals();
                    break;
                case 'adminRequestHistory':
                    loadAdminRequestHistory();
                    break;
            }
        }

        // Create section templates
        function createDutyChangeSection() {
            return `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <ion-icon name="swap-horizontal-outline"></ion-icon>
                            Duty Change Request
                        </h3>
                    </div>
                    
                    <div class="alert alert-warning">
                        <strong>Note:</strong> Requests must be made at least 24 hours in advance. No back dates allowed.
                    </div>
                    
                    <form id="dutyChangeForm">
                        <div class="form-group">
                            <label for="changeDate" class="form-label">Change Date *</label>
                            <input type="date" id="changeDate" class="form-control" required min="">
                        </div>
                        
                        <div class="form-group">
                            <label for="changeDutyTime" class="form-label">Your Duty Time *</label>
                            <select id="changeDutyTime" class="form-control" required>
                                <option value="">Select duty time</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="requestToStaff" class="form-label">Request To Staff *</label>
                            <select id="requestToStaff" class="form-control" required>
                                <option value="">Select staff member</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="requestToRcNo" class="form-label">Staff RC No</label>
                            <input type="text" id="requestToRcNo" class="form-control" readonly>
                        </div>
                        
                        <div class="form-group">
                            <label for="requestToDutyTime" class="form-label">Staff's Duty Time *</label>
                            <select id="requestToDutyTime" class="form-control" required>
                                <option value="">Select duty time</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="changeReason" class="form-label">Reason (Optional)</label>
                            <textarea id="changeReason" class="form-control" rows="2" placeholder="Brief reason for duty change"></textarea>
                        </div>
                        
                        <div class="form-row">
                            <button type="submit" class="btn btn-success">Submit Request</button>
                            <button type="button" class="btn btn-secondary" onclick="showSection('home')">Cancel</button>
                        </div>
                    </form>
                </div>
            `;
        }

        function createLeaveApplicationSection() {
            return `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <ion-icon name="calendar-outline"></ion-icon>
                            Leave Application
                        </h3>
                    </div>
                    
                    <div class="alert alert-info">
                        <p><strong>Application Rules:</strong></p>
                        <p>â€¢ Sick Leave: Minimum 2 hours before duty time</p>
                        <p>â€¢ FRL: Minimum 1 hour before duty time</p>
                        <p>â€¢ No back dated applications allowed</p>
                    </div>
                    
                    <form id="leaveApplicationForm">
                        <div class="form-group">
                            <label for="leaveType" class="form-label">Leave Type *</label>
                            <select id="leaveType" class="form-control" required>
                                <option value="">Select leave type</option>
                                <option value="Sick Leave">Sick Leave</option>
                                <option value="FRL">FRL</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="leaveDate" class="form-label">Leave Date *</label>
                            <input type="date" id="leaveDate" class="form-control" required min="">
                        </div>
                        
                        <div class="form-group">
                            <label for="leaveDutyTime" class="form-label">Duty Time *</label>
                            <select id="leaveDutyTime" class="form-control" required>
                                <option value="">Select duty time</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="leaveDuration" class="form-label">Duration *</label>
                            <select id="leaveDuration" class="form-control" required>
                                <option value="1">1 Day</option>
                                <option value="0.5">Half Day</option>
                                <option value="2">2 Days</option>
                                <option value="3">3 Days</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="leaveReason" class="form-label">Reason *</label>
                            <textarea id="leaveReason" class="form-control" rows="3" placeholder="Please provide reason for leave" required></textarea>
                        </div>
                        
                        <div class="alert" id="leaveRulesAlert">
                            Select leave type, date and duty time to see rules
                        </div>
                        
                        <div class="form-row">
                            <button type="submit" class="btn btn-success" id="submitLeaveBtn">Submit Application</button>
                            <button type="button" class="btn btn-secondary" onclick="showSection('home')">Cancel</button>
                        </div>
                    </form>
                </div>
            `;
        }

        // ... Additional section creation functions ...

        // Setup event listeners for dynamic forms
        function setupEventListeners() {
            // Reattach event listeners after dynamic content creation
            setTimeout(() => {
                // Duty Change Form
                const dutyChangeForm = document.getElementById('dutyChangeForm');
                if (dutyChangeForm) {
                    dutyChangeForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        submitDutyChange();
                    });
                }
                
                // Leave Application Form
                const leaveForm = document.getElementById('leaveApplicationForm');
                if (leaveForm) {
                    leaveForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        submitLeaveApplication();
                    });
                }
                
                // Add other form event listeners here...
            }, 100);
        }

        // Update dashboard
        function updateDashboard() {
            if (!currentUser) return;
            
            // Update today's duty
            const today = new Date().toISOString().split('T')[0];
            let todayDuty = 'Not Scheduled';
            if (dutyRoster[today] && dutyRoster[today][currentUser.username]) {
                const duty = dutyRoster[today][currentUser.username];
                todayDuty = duty === 'Off' ? 'Off Duty' : duty;
            }
            document.getElementById('todayDutyTime').textContent = todayDuty;
            document.getElementById('todayDutyTimeStat').textContent = todayDuty.split(' ')[0];
            
            // Find next duty
            const tomorrow = new Date();
            let nextDuty = 'No upcoming duty';
            for (let i = 1; i <= 7; i++) {
                tomorrow.setDate(tomorrow.getDate() + 1);
                const dateStr = tomorrow.toISOString().split('T')[0];
                if (dutyRoster[dateStr] && dutyRoster[dateStr][currentUser.username]) {
                    const duty = dutyRoster[dateStr][currentUser.username];
                    if (duty !== 'Off') {
                        nextDuty = `${formatDate(dateStr)}: ${duty}`;
                        break;
                    }
                }
            }
            document.getElementById('nextDutyTime').textContent = nextDuty;
            
            // Update balance display
            updateUserBalance();
            
            // Load announcements
            loadHomeAnnouncements();
            
            // Load recent updates
            loadRecentUpdates();
        }

        // Load home announcements
        function loadHomeAnnouncements() {
            const container = document.getElementById('homeAnnouncements');
            if (!container) return;
            
            container.innerHTML = '';
            
            const now = new Date();
            const activeAnnouncements = announcements.filter(ann => {
                if (ann.status === 'expired' || ann.status === 'archived') return false;
                if (ann.expiry && new Date(ann.expiry) < now) return false;
                
                if (ann.target === 'all') return true;
                if (ann.target === 'specific' && ann.targetUsers && ann.targetUsers.includes(currentUser.username)) return true;
                return false;
            });
            
            if (activeAnnouncements.length === 0) return;
            
            // Sort by priority
            activeAnnouncements.sort((a, b) => {
                const priorityOrder = {high: 0, medium: 1, low: 2};
                if (priorityOrder[a.priority] !== priorityOrder[b.priority]) {
                    return priorityOrder[a.priority] - priorityOrder[b.priority];
                }
                return new Date(b.createdAt) - new Date(a.createdAt);
            });
            
            // Show only 3 most recent
            activeAnnouncements.slice(0, 3).forEach(ann => {
                const announcementDiv = document.createElement('div');
                announcementDiv.className = `announcement priority-${ann.priority}`;
                
                announcementDiv.innerHTML = `
                    <div class="announcement-title">
                        <ion-icon name="megaphone-outline"></ion-icon>
                        ${ann.title}
                    </div>
                    <div class="announcement-content">${ann.content}</div>
                    <div class="announcement-meta">
                        <div>${formatTimeAgo(ann.createdAt)}</div>
                        <div>${ann.target === 'all' ? 'All Staff' : 'Specific'}</div>
                    </div>
                `;
                
                container.appendChild(announcementDiv);
            });
        }

        // Load recent updates
        function loadRecentUpdates() {
            const container = document.getElementById('recentUpdates');
            if (!container) return;
            
            container.innerHTML = '';
            
            const userReqs = allRequests.filter(req => 
                req.fromUsername === currentUser.username
            );
            
            if (userReqs.length === 0) {
                container.innerHTML = '<p class="empty-state">No recent updates</p>';
                return;
            }
            
            // Sort by timestamp descending
            userReqs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            // Show only 5 most recent
            userReqs.slice(0, 5).forEach(req => {
                const div = document.createElement('div');
                div.className = 'alert alert-info';
                div.style.marginBottom = '10px';
                
                let details = '';
                if (req.type === 'dutyChange') {
                    details = `Duty change with ${req.toName}`;
                } else {
                    details = `${req.leaveType} for ${req.duration} day(s)`;
                }
                
                div.innerHTML = `
                    <strong>${req.status.charAt(0).toUpperCase() + req.status.slice(1)}</strong>
                    <p>${details} on ${req.date}</p>
                    <small>${formatTimeAgo(req.timestamp)}</small>
                `;
                
                container.appendChild(div);
            });
        }

        // Submit duty change
        async function submitDutyChange() {
            const date = document.getElementById('changeDate').value;
            const dutyTime = document.getElementById('changeDutyTime').value;
            const toStaff = document.getElementById('requestToStaff').value;
            const toRcNo = document.getElementById('requestToRcNo').value;
            const toDutyTime = document.getElementById('requestToDutyTime').value;
            const reason = document.getElementById('changeReason').value;
            
            if (!date || !dutyTime || !toStaff || !toDutyTime) {
                showToast('Please fill all required fields', 'warning');
                return;
            }
            
            if (dutyTime === 'No Duty' || toDutyTime === 'No Duty') {
                showToast('Cannot request duty change when no duty is scheduled', 'warning');
                return;
            }
            
            const toUser = allUsers.find(u => u.username === toStaff);
            if (!toUser) {
                showToast('Selected staff not found', 'error');
                return;
            }
            
            const request = {
                id: 'req_' + Date.now(),
                type: 'dutyChange',
                fromUsername: currentUser.username,
                fromName: currentUser.name,
                fromRcNo: currentUser.rcNo,
                date: date,
                dutyTime: dutyTime,
                toUsername: toStaff,
                toName: toUser.name,
                toRcNo: toRcNo,
                toDutyTime: toDutyTime,
                reason: reason,
                status: 'pending',
                timestamp: new Date().toISOString(),
                history: [{
                    action: 'created',
                    by: currentUser.name,
                    timestamp: new Date().toISOString()
                }]
            };
            
            allRequests.push(request);
            
            try {
                await saveAllRequests();
                updateRequestCounts();
                showToast('Duty change request submitted!', 'success');
                showSection('home');
                // Reset form
                const form = document.getElementById('dutyChangeForm');
                if (form) form.reset();
            } catch (error) {
                showToast('Failed to submit request. Please try again.', 'error');
            }
        }

        // Submit leave application
        async function submitLeaveApplication() {
            const leaveType = document.getElementById('leaveType').value;
            const date = document.getElementById('leaveDate').value;
            const dutyTime = document.getElementById('leaveDutyTime').value;
            const duration = parseFloat(document.getElementById('leaveDuration').value);
            const reason = document.getElementById('leaveReason').value;
            
            if (!leaveType || !date || !dutyTime || !reason) {
                showToast('Please fill all required fields', 'warning');
                return;
            }
            
            if (dutyTime === 'No Duty' || dutyTime === 'Off') {
                showToast('You are off duty on this date. No leave needed.', 'warning');
                return;
            }
            
            // Check balance
            const userBalance = leaveBalances[currentUser.username];
            if (!userBalance) {
                showToast('Error: User balance not found', 'error');
                return;
            }
            
            // Validate sufficient balance
            if (leaveType === 'Sick Leave' && userBalance.SL < duration) {
                showToast(`Insufficient Sick Leave balance. Available: ${userBalance.SL.toFixed(1)} days, Requested: ${duration} days`, 'warning');
                return;
            }
            
            if (leaveType === 'FRL' && userBalance.FRL < duration) {
                showToast(`Insufficient FRL balance. Available: ${userBalance.FRL.toFixed(1)} days, Requested: ${duration} days`, 'warning');
                return;
            }
            
            const request = {
                id: 'req_' + Date.now(),
                type: 'leave',
                leaveType: leaveType,
                fromUsername: currentUser.username,
                fromName: currentUser.name,
                fromRcNo: currentUser.rcNo,
                date: date,
                dutyTime: dutyTime,
                duration: duration,
                reason: reason,
                status: 'pending',
                timestamp: new Date().toISOString(),
                history: [{
                    action: 'created',
                    by: currentUser.name,
                    timestamp: new Date().toISOString()
                }]
            };
            
            allRequests.push(request);
            
            try {
                await saveAllRequests();
                updateRequestCounts();
                showToast('Leave application submitted! It will be processed after supervisor approval.', 'success');
                showSection('home');
                // Reset form
                const form = document.getElementById('leaveApplicationForm');
                if (form) form.reset();
                updateDashboard();
                updateUserBalance();
            } catch (error) {
                showToast('Failed to submit leave application. Please try again.', 'error');
            }
        }

        // Utility functions
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = message;
            
            container.appendChild(toast);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                toast.style.animation = 'slideInRight 0.3s ease reverse';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 5000);
        }

        function showLoading(message = 'Loading...') {
            const modal = document.getElementById('loadingModal');
            const messageEl = modal.querySelector('p');
            if (messageEl) {
                messageEl.textContent = message;
            }
            modal.classList.add('active');
        }

        function hideLoading() {
            const modal = document.getElementById('loadingModal');
            modal.classList.remove('active');
        }

        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
        }

        function hideModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('active');
                document.body.style.overflow = '';
            }
        }

        function confirmAction(title, message, action) {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            
            const confirmBtn = document.getElementById('confirmActionBtn');
            confirmBtn.onclick = function() {
                action();
                hideModal('confirmModal');
            };
            
            showModal('confirmModal');
        }

        function formatTimeAgo(timestamp) {
            const now = new Date();
            const past = new Date(timestamp);
            const diffMs = now - past;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);
            
            if (diffMins < 1) return 'just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            
            return past.toLocaleDateString();
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        // Setup real-time listeners
        function setupRealtimeListeners() {
            try {
                // Listen for announcement updates
                db.collection('announcements').doc('all')
                    .onSnapshot((doc) => {
                        if (doc.exists) {
                            announcements = doc.data().announcements || [];
                            if (currentSection === 'home') {
                                loadHomeAnnouncements();
                            }
                        }
                    }, handleFirebaseError);

                // Listen for request updates
                db.collection('requests').doc('all')
                    .onSnapshot((doc) => {
                        if (doc.exists && doc.data().requests) {
                            allRequests = doc.data().requests;
                            updateRequestCounts();
                            if (currentSection === 'home') {
                                loadRecentUpdates();
                            }
                        }
                    }, handleFirebaseError);
                    
                console.log('Real-time listeners established');
            } catch (error) {
                console.error('Error setting up real-time listeners:', error);
            }
        }

        function handleFirebaseError(error) {
            console.error('Firebase error:', error);
            if (error.code === 'failed-precondition' || error.message.includes('QUIC')) {
                console.log('Retrying Firebase operation...');
                setTimeout(() => {
                    initializeData();
                }, 2000);
            }
        }

        // Create remaining section templates (simplified for brevity)
        function createMyRequestsSection() {
            return `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <ion-icon name="document-text-outline"></ion-icon>
                            My Requests
                        </h3>
                    </div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Date</th>
                                    <th>Details</th>
                                    <th>Status</th>
                                    <th>Updated</th>
                                </tr>
                            </thead>
                            <tbody id="myRequestsTable">
                                <!-- Filled by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function createViewMyRosterSection() {
            return `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <ion-icon name="time-outline"></ion-icon>
                            My Duty Roster
                        </h3>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="myRosterMonth" class="form-label">View Month</label>
                            <input type="month" id="myRosterMonth" class="form-control" value="">
                        </div>
                        <div class="form-group">
                            <label for="myRosterViewType" class="form-label">View Type</label>
                            <select id="myRosterViewType" class="form-control">
                                <option value="table">Table View</option>
                                <option value="calendar">Calendar View</option>
                            </select>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="loadMyRoster()">
                        <ion-icon name="search-outline"></ion-icon>
                        Load Roster
                    </button>
                    
                    <div class="alert alert-info" style="margin-top: 15px;">
                        This shows your scheduled duties. Changes must be requested via Duty Change.
                    </div>
                    
                    <div id="myRosterContainer" style="margin-top: 20px;">
                        <!-- Roster will be displayed here -->
                    </div>
                </div>
            `;
        }

        function createViewAllRosterSection() {
            return `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <ion-icon name="people-outline"></ion-icon>
                            Complete Duty Roster
                        </h3>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="allRosterStartDate" class="form-label">From Date</label>
                            <input type="date" id="allRosterStartDate" class="form-control" value="">
                        </div>
                        <div class="form-group">
                            <label for="allRosterEndDate" class="form-label">To Date</label>
                            <input type="date" id="allRosterEndDate" class="form-control" value="">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="allRosterViewType" class="form-label">View Type</label>
                            <select id="allRosterViewType" class="form-control">
                                <option value="table">Daily Table</option>
                                <option value="staff">Staff View</option>
                                <option value="calendar">Calendar View</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <button class="btn btn-primary" onclick="loadAllRoster()">
                            <ion-icon name="search-outline"></ion-icon>
                            Load Roster
                        </button>
                        <button class="btn btn-secondary" onclick="printAllRoster()">
                            <ion-icon name="print-outline"></ion-icon>
                            Print
                        </button>
                    </div>
                    
                    <div id="allRosterContainer" style="margin-top: 20px;">
                        <!-- Complete roster will be displayed here -->
                    </div>
                </div>
            `;
        }

       // Continue the script after the createViewAllRosterSection function

function createPendingRequestsSection() {
    return `
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <ion-icon name="notifications-outline"></ion-icon>
                    Pending Requests
                    <span class="badge" id="pendingCountHeader" style="background: var(--danger); color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; margin-left: 8px;">0</span>
                </h3>
                <button class="btn btn-sm btn-primary" onclick="refreshPendingRequests()">
                    <ion-icon name="refresh-outline"></ion-icon>
                    Refresh
                </button>
            </div>
            
            <div class="alert alert-info">
                These are duty change requests from other staff that require your approval.
            </div>
            
            <div class="tabs" id="pendingRequestsTabs">
                <button class="tab-btn active" data-type="dutyChange">Duty Change</button>
                <button class="tab-btn" data-type="leave">Leave Applications</button>
            </div>
            
            <div id="pendingRequestsContainer">
                <!-- Pending requests will be loaded here -->
            </div>
            
            <div id="noPendingRequests" class="empty-state" style="display: none;">
                <ion-icon name="checkmark-circle-outline" style="font-size: 48px; color: var(--success);"></ion-icon>
                <h3>No Pending Requests</h3>
                <p>You're all caught up!</p>
            </div>
        </div>
    `;
}

function createAdminDutyRosterSection() {
    return `
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <ion-icon name="grid-outline"></ion-icon>
                    Admin: Duty Roster Management
                </h3>
            </div>
            
            <div class="alert alert-warning">
                <strong>Supervisor Access Only:</strong> Manage and edit duty rosters for all staff.
            </div>
            
            <div class="tabs" id="rosterAdminTabs">
                <button class="tab-btn active" data-view="edit">Edit Roster</button>
                <button class="tab-btn" data-view="bulk">Bulk Update</button>
                <button class="tab-btn" data-view="templates">Templates</button>
                <button class="tab-btn" data-view="reports">Reports</button>
            </div>
            
            <div id="rosterAdminContent">
                <!-- Admin roster management content -->
            </div>
        </div>
    `;
}

function createAdminLeaveBalanceSection() {
    return `
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <ion-icon name="calculator-outline"></ion-icon>
                    Admin: Leave Balance Management
                </h3>
            </div>
            
            <div class="alert alert-warning">
                <strong>Supervisor Access Only:</strong> View and manage leave balances for all staff.
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="balanceStaffFilter" class="form-label">Filter by Staff</label>
                    <select id="balanceStaffFilter" class="form-control">
                        <option value="all">All Staff</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="balanceLeaveTypeFilter" class="form-label">Leave Type</label>
                    <select id="balanceLeaveTypeFilter" class="form-control">
                        <option value="all">All Types</option>
                        <option value="SL">Sick Leave</option>
                        <option value="FRL">FRL</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <button class="btn btn-primary" onclick="loadLeaveBalanceAdmin()">
                    <ion-icon name="search-outline"></ion-icon>
                    Load Balances
                </button>
                <button class="btn btn-success" onclick="showAdjustBalanceModal()">
                    <ion-icon name="add-outline"></ion-icon>
                    Adjust Balance
                </button>
            </div>
            
            <div class="table-responsive" style="margin-top: 20px;">
                <table>
                    <thead>
                        <tr>
                            <th>Staff Name</th>
                            <th>Sick Leave</th>
                            <th>FRL</th>
                            <th>Last Updated</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="leaveBalanceTable">
                        <!-- Leave balances will be loaded here -->
                    </tbody>
                </table>
            </div>
            
            <div class="card-footer" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--light-gray);">
                <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="stat-card" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);">
                        <div class="stat-value" id="totalSL">0</div>
                        <div class="stat-label">Total SL Days</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #27ae60 0%, #219653 100%);">
                        <div class="stat-value" id="totalFRL">0</div>
                        <div class="stat-label">Total FRL Days</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #f39c12 0%, #d68910 100%);">
                        <div class="stat-value" id="totalStaff">0</div>
                        <div class="stat-label">Total Staff</div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function createAdminApprovalsSection() {
    return `
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <ion-icon name="checkmark-done-outline"></ion-icon>
                    Admin: Approvals
                    <span class="badge" id="approvalCountHeader" style="background: var(--warning); color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; margin-left: 8px;">0</span>
                </h3>
                <button class="btn btn-sm btn-primary" onclick="refreshAdminApprovals()">
                    <ion-icon name="refresh-outline"></ion-icon>
                    Refresh
                </button>
            </div>
            
            <div class="alert alert-warning">
                <strong>Supervisor Access Only:</strong> Approve or reject leave and duty change requests.
            </div>
            
            <div class="tabs" id="approvalsTabs">
                <button class="tab-btn active" data-type="all">All Pending</button>
                <button class="tab-btn" data-type="leave">Leave Apps</button>
                <button class="tab-btn" data-type="dutyChange">Duty Changes</button>
            </div>
            
            <div id="approvalsContainer">
                <!-- Approval requests will be loaded here -->
            </div>
            
            <div id="noApprovals" class="empty-state" style="display: none;">
                <ion-icon name="checkmark-circle-outline" style="font-size: 48px; color: var(--success);"></ion-icon>
                <h3>No Pending Approvals</h3>
                <p>All requests have been processed!</p>
            </div>
        </div>
    `;
}

function createAdminRequestHistorySection() {
    return `
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <ion-icon name="archive-outline"></ion-icon>
                    Admin: Request History
                </h3>
            </div>
            
            <div class="alert alert-warning">
                <strong>Supervisor Access Only:</strong> View history of all requests.
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="historyTypeFilter" class="form-label">Request Type</label>
                    <select id="historyTypeFilter" class="form-control">
                        <option value="all">All Types</option>
                        <option value="leave">Leave Applications</option>
                        <option value="dutyChange">Duty Changes</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="historyStatusFilter" class="form-label">Status</label>
                    <select id="historyStatusFilter" class="form-control">
                        <option value="all">All Status</option>
                        <option value="approved">Approved</option>
                        <option value="rejected">Rejected</option>
                        <option value="pending">Pending</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="historyDateFrom" class="form-label">From Date</label>
                    <input type="date" id="historyDateFrom" class="form-control">
                </div>
                <div class="form-group">
                    <label for="historyDateTo" class="form-label">To Date</label>
                    <input type="date" id="historyDateTo" class="form-control">
                </div>
            </div>
            
            <div class="form-row">
                <button class="btn btn-primary" onclick="loadAdminRequestHistory()">
                    <ion-icon name="search-outline"></ion-icon>
                    Load History
                </button>
                <button class="btn btn-secondary" onclick="exportRequestHistory()">
                    <ion-icon name="download-outline"></ion-icon>
                    Export CSV
                </button>
            </div>
            
            <div class="table-responsive" style="margin-top: 20px;">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Staff</th>
                            <th>Type</th>
                            <th>Details</th>
                            <th>Status</th>
                            <th>Processed By</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="requestHistoryTable">
                        <!-- Request history will be loaded here -->
                    </tbody>
                </table>
            </div>
            
            <div class="card-footer" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--light-gray); text-align: center;">
                <button class="btn btn-sm btn-outline" onclick="clearOldHistory()">
                    <ion-icon name="trash-outline"></ion-icon>
                    Clear Old Records (30+ days)
                </button>
            </div>
        </div>
    `;
}

function createAdminAnnouncementsSection() {
    return `
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <ion-icon name="megaphone-outline"></ion-icon>
                    Admin: Announcements
                </h3>
                <button class="btn btn-sm btn-success" onclick="showNewAnnouncementModal()">
                    <ion-icon name="add-outline"></ion-icon>
                    New Announcement
                </button>
            </div>
            
            <div class="alert alert-warning">
                <strong>Supervisor Access Only:</strong> Create and manage announcements for staff.
            </div>
            
            <div class="tabs" id="announcementsTabs">
                <button class="tab-btn active" data-status="active">Active</button>
                <button class="tab-btn" data-status="scheduled">Scheduled</button>
                <button class="tab-btn" data-status="expired">Expired</button>
                <button class="tab-btn" data-status="archived">Archived</button>
            </div>
            
            <div id="announcementsContainer">
                <!-- Announcements will be loaded here -->
            </div>
        </div>
    `;
}

// Load section-specific data functions
function loadDutyChangeForm() {
    if (!currentUser) return;
    
    const today = new Date().toISOString().split('T')[0];
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    const tomorrowStr = tomorrow.toISOString().split('T')[0];
    
    // Set min date (tomorrow, no same-day changes)
    const dateInput = document.getElementById('changeDate');
    if (dateInput) {
        dateInput.min = tomorrowStr;
        dateInput.value = tomorrowStr;
    }
    
    // Populate duty times
    const dutyTimeSelect = document.getElementById('changeDutyTime');
    const toDutyTimeSelect = document.getElementById('requestToDutyTime');
    if (dutyTimeSelect && toDutyTimeSelect) {
        const dutyTimes = getAvailableDutyTimes();
        dutyTimeSelect.innerHTML = '<option value="">Select duty time</option>';
        toDutyTimeSelect.innerHTML = '<option value="">Select duty time</option>';
        
        dutyTimes.forEach(time => {
            dutyTimeSelect.innerHTML += `<option value="${time}">${time}</option>`;
            toDutyTimeSelect.innerHTML += `<option value="${time}">${time}</option>`;
        });
    }
    
    // Populate staff dropdown
    const staffSelect = document.getElementById('requestToStaff');
    if (staffSelect) {
        staffSelect.innerHTML = '<option value="">Select staff member</option>';
        
        // Filter out current user
        const otherStaff = allUsers.filter(user => user.username !== currentUser.username);
        
        otherStaff.forEach(user => {
            staffSelect.innerHTML += `<option value="${user.username}">${user.name} (RC: ${user.RCNo})</option>`;
        });
        
        // Add event listener for staff selection
        staffSelect.addEventListener('change', function() {
            const selectedUser = allUsers.find(u => u.username === this.value);
            if (selectedUser) {
                document.getElementById('requestToRcNo').value = selectedUser.RCNo;
                
                // Auto-populate staff's duty time if date is selected
                const date = document.getElementById('changeDate').value;
                if (date && dutyRoster[date] && dutyRoster[date][selectedUser.username]) {
                    const dutyTime = dutyRoster[date][selectedUser.username];
                    document.getElementById('requestToDutyTime').value = dutyTime;
                }
            }
        });
    }
    
    // Add date change listener to update duty times
    if (dateInput) {
        dateInput.addEventListener('change', function() {
            const date = this.value;
            const staffSelect = document.getElementById('requestToStaff');
            const selectedStaff = staffSelect.value;
            
            // Update current user's duty time
            if (dutyRoster[date] && dutyRoster[date][currentUser.username]) {
                document.getElementById('changeDutyTime').value = dutyRoster[date][currentUser.username];
            } else {
                document.getElementById('changeDutyTime').value = '';
            }
            
            // Update selected staff's duty time
            if (selectedStaff && dutyRoster[date] && dutyRoster[date][selectedStaff]) {
                document.getElementById('requestToDutyTime').value = dutyRoster[date][selectedStaff];
            }
        });
    }
}

function loadLeaveForm() {
    if (!currentUser) return;
    
    const today = new Date().toISOString().split('T')[0];
    const minDate = new Date();
    minDate.setHours(minDate.getHours() + 2); // Minimum 2 hours from now for sick leave
    const minDateStr = minDate.toISOString().split('T')[0];
    
    // Set min date
    const dateInput = document.getElementById('leaveDate');
    if (dateInput) {
        dateInput.min = minDateStr;
        dateInput.value = minDateStr;
    }
    
    // Populate duty times
    const dutyTimeSelect = document.getElementById('leaveDutyTime');
    if (dutyTimeSelect) {
        const dutyTimes = getAvailableDutyTimes();
        dutyTimeSelect.innerHTML = '<option value="">Select duty time</option>';
        dutyTimes.forEach(time => {
            dutyTimeSelect.innerHTML += `<option value="${time}">${time}</option>`;
        });
    }
    
    // Add event listeners for rule checking
    const leaveTypeSelect = document.getElementById('leaveType');
    const leaveDateInput = document.getElementById('leaveDate');
    const leaveDutyTimeSelect = document.getElementById('leaveDutyTime');
    const rulesAlert = document.getElementById('leaveRulesAlert');
    
    function updateLeaveRules() {
        if (!rulesAlert) return;
        
        const leaveType = leaveTypeSelect.value;
        const date = leaveDateInput.value;
        const dutyTime = leaveDutyTimeSelect.value;
        
        if (!leaveType || !date || !dutyTime) {
            rulesAlert.textContent = 'Select leave type, date and duty time to see rules';
            rulesAlert.className = 'alert';
            return;
        }
        
        // Check if duty time exists
        if (dutyTime === 'No Duty' || dutyTime === 'Off') {
            rulesAlert.innerHTML = '<strong>No Duty Scheduled:</strong> You are off duty on this date. No leave needed.';
            rulesAlert.className = 'alert alert-warning';
            return;
        }
        
        // Calculate minimum request time
        const requestTime = new Date(`${date}T${dutyTime.split('-')[0]}:00`);
        const now = new Date();
        
        if (leaveType === 'Sick Leave') {
            const minTime = new Date(requestTime);
            minTime.setHours(minTime.getHours() - 2); // 2 hours before duty
            
            if (now > minTime) {
                rulesAlert.innerHTML = '<strong>âš ï¸ Late Request:</strong> Sick leave must be requested at least 2 hours before duty time. Contact supervisor directly.';
                rulesAlert.className = 'alert alert-danger';
            } else {
                rulesAlert.innerHTML = '<strong>âœ“ Valid Request:</strong> Sick leave request meets timing requirements.';
                rulesAlert.className = 'alert alert-success';
            }
        } else if (leaveType === 'FRL') {
            const minTime = new Date(requestTime);
            minTime.setHours(minTime.getHours() - 1); // 1 hour before duty
            
            if (now > minTime) {
                rulesAlert.innerHTML = '<strong>âš ï¸ Late Request:</strong> FRL must be requested at least 1 hour before duty time. Contact supervisor directly.';
                rulesAlert.className = 'alert alert-danger';
            } else {
                rulesAlert.innerHTML = '<strong>âœ“ Valid Request:</strong> FRL request meets timing requirements.';
                rulesAlert.className = 'alert alert-success';
            }
        }
    }
    
    if (leaveTypeSelect) leaveTypeSelect.addEventListener('change', updateLeaveRules);
    if (leaveDateInput) leaveDateInput.addEventListener('change', updateLeaveRules);
    if (leaveDutyTimeSelect) leaveDutyTimeSelect.addEventListener('change', updateLeaveRules);
    
    // Initialize rules display
    updateLeaveRules();
}

function loadMyRequests() {
    if (!currentUser) return;
    
    const container = document.getElementById('myRequestsTable');
    if (!container) return;
    
    container.innerHTML = '';
    
    const userReqs = allRequests.filter(req => 
        req.fromUsername === currentUser.username
    ).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    
    if (userReqs.length === 0) {
        container.innerHTML = `
            <tr>
                <td colspan="5" style="text-align: center; padding: 30px;">
                    <ion-icon name="document-outline" style="font-size: 48px; color: var(--gray); opacity: 0.3;"></ion-icon>
                    <p style="margin-top: 10px;">No requests found</p>
                </td>
            </tr>
        `;
        return;
    }
    
    userReqs.forEach(req => {
        const row = document.createElement('tr');
        
        let details = '';
        let typeIcon = '';
        
        if (req.type === 'dutyChange') {
            typeIcon = 'swap-horizontal-outline';
            details = `Change with ${req.toName} (${req.toDutyTime})`;
        } else {
            typeIcon = 'calendar-outline';
            details = `${req.leaveType} - ${req.duration} day(s)`;
        }
        
        row.innerHTML = `
            <td>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <ion-icon name="${typeIcon}" style="font-size: 18px;"></ion-icon>
                    <span>${req.type === 'dutyChange' ? 'Duty Change' : 'Leave'}</span>
                </div>
            </td>
            <td>${req.date}</td>
            <td>${details}</td>
            <td>
                <span class="status-badge status-${req.status}">
                    ${req.status.charAt(0).toUpperCase() + req.status.slice(1)}
                </span>
            </td>
            <td>${formatTimeAgo(req.timestamp)}</td>
        `;
        
        // Add click to view details
        row.style.cursor = 'pointer';
        row.addEventListener('click', () => viewRequestDetails(req));
        
        container.appendChild(row);
    });
}

function viewRequestDetails(request) {
    let details = '';
    
    if (request.type === 'dutyChange') {
        details = `
            <h4>Duty Change Request</h4>
            <p><strong>From:</strong> ${request.fromName} (RC: ${request.fromRcNo})</p>
            <p><strong>To:</strong> ${request.toName} (RC: ${request.toRcNo})</p>
            <p><strong>Date:</strong> ${request.date}</p>
            <p><strong>Your Duty:</strong> ${request.dutyTime}</p>
            <p><strong>Staff's Duty:</strong> ${request.toDutyTime}</p>
            <p><strong>Reason:</strong> ${request.reason || 'Not provided'}</p>
        `;
    } else {
        details = `
            <h4>Leave Application</h4>
            <p><strong>Staff:</strong> ${request.fromName} (RC: ${request.fromRcNo})</p>
            <p><strong>Type:</strong> ${request.leaveType}</p>
            <p><strong>Date:</strong> ${request.date}</p>
            <p><strong>Duty Time:</strong> ${request.dutyTime}</p>
            <p><strong>Duration:</strong> ${request.duration} day(s)</p>
            <p><strong>Reason:</strong> ${request.reason}</p>
        `;
    }
    
    // Add history
    let historyHtml = '';
    if (request.history && request.history.length > 0) {
        historyHtml = '<h4>Request History</h4><ul>';
        request.history.forEach(entry => {
            historyHtml += `<li>${formatTimeAgo(entry.timestamp)}: ${entry.action} by ${entry.by}</li>`;
        });
        historyHtml += '</ul>';
    }
    
    const modalContent = `
        <div class="modal-header">
            <h3 class="modal-title">Request Details</h3>
            <button class="modal-close" onclick="hideModal('requestDetailsModal')">
                <ion-icon name="close-outline"></ion-icon>
            </button>
        </div>
        <div class="modal-body">
            ${details}
            ${historyHtml}
            <div class="status-badge status-${request.status}" style="font-size: 14px; margin-top: 15px;">
                Status: ${request.status.charAt(0).toUpperCase() + request.status.slice(1)}
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="hideModal('requestDetailsModal')">Close</button>
            ${request.status === 'pending' ? `
                <button class="btn btn-danger" onclick="cancelRequest('${request.id}')">Cancel Request</button>
            ` : ''}
        </div>
    `;
    
    // Create or update modal
    let modal = document.getElementById('requestDetailsModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'requestDetailsModal';
        modal.className = 'modal';
        modal.innerHTML = `<div class="modal-content" style="max-width: 500px;">${modalContent}</div>`;
        document.body.appendChild(modal);
    } else {
        modal.querySelector('.modal-content').innerHTML = modalContent;
    }
    
    modal.classList.add('active');
}

function cancelRequest(requestId) {
    confirmAction('Cancel Request', 'Are you sure you want to cancel this request? This action cannot be undone.', async function() {
        const request = allRequests.find(req => req.id === requestId);
        if (!request) {
            showToast('Request not found', 'error');
            return;
        }
        
        if (request.status !== 'pending') {
            showToast('Only pending requests can be cancelled', 'warning');
            return;
        }
        
        request.status = 'cancelled';
        request.history.push({
            action: 'cancelled',
            by: currentUser.name,
            timestamp: new Date().toISOString()
        });
        
        try {
            await saveAllRequests();
            showToast('Request cancelled successfully', 'success');
            hideModal('requestDetailsModal');
            loadMyRequests();
            updateDashboard();
        } catch (error) {
            showToast('Failed to cancel request', 'error');
        }
    });
}

function loadMyRoster() {
    if (!currentUser) return;
    
    const container = document.getElementById('myRosterContainer');
    if (!container) return;
    
    const monthInput = document.getElementById('myRosterMonth');
    const viewTypeSelect = document.getElementById('myRosterViewType');
    
    let year, month;
    
    if (monthInput && monthInput.value) {
        [year, month] = monthInput.value.split('-').map(Number);
    } else {
        const today = new Date();
        year = today.getFullYear();
        month = today.getMonth() + 1;
        if (monthInput) monthInput.value = `${year}-${month.toString().padStart(2, '0')}`;
    }
    
    const viewType = viewTypeSelect ? viewTypeSelect.value : 'table';
    
    container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading roster...</p></div>';
    
    // Simulate loading delay
    setTimeout(() => {
        if (viewType === 'calendar') {
            container.innerHTML = createCalendarView(year, month, currentUser.username);
        } else {
            container.innerHTML = createTableView(year, month, currentUser.username);
        }
        
        // Add swipe actions for mobile
        initSwipeActions(container);
    }, 500);
}

function createCalendarView(year, month, username) {
    const firstDay = new Date(year, month - 1, 1);
    const lastDay = new Date(year, month, 0);
    const daysInMonth = lastDay.getDate();
    const firstDayOfWeek = firstDay.getDay();
    
    let html = `
        <div class="calendar-view" style="background: white; border-radius: var(--radius); overflow: hidden;">
            <div class="calendar-header" style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: var(--primary); color: white;">
                <h4 style="margin: 0; font-weight: 600;">${new Date(year, month - 1).toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}</h4>
                <div style="display: flex; gap: 5px;">
                    <button class="btn btn-sm" onclick="changeCalendarMonth(-1)" style="background: rgba(255,255,255,0.2); color: white;">
                        <ion-icon name="chevron-back-outline"></ion-icon>
                    </button>
                    <button class="btn btn-sm" onclick="changeCalendarMonth(1)" style="background: rgba(255,255,255,0.2); color: white;">
                        <ion-icon name="chevron-forward-outline"></ion-icon>
                    </button>
                </div>
            </div>
            
            <div class="calendar-grid" style="display: grid; grid-template-columns: repeat(7, 1fr);">
                ${['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => `
                    <div style="padding: 10px; text-align: center; font-weight: 600; border-bottom: 1px solid var(--light-gray);">${day}</div>
                `).join('')}
    `;
    
    // Empty cells for days before first day of month
    for (let i = 0; i < firstDayOfWeek; i++) {
        html += '<div style="padding: 20px 10px; min-height: 60px; background: var(--light);"></div>';
    }
    
    // Days of the month
    const today = new Date().toISOString().split('T')[0];
    
    for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
        const duty = dutyRoster[dateStr] && dutyRoster[dateStr][username];
        const isToday = dateStr === today;
        
        let dutyClass = '';
        let dutyText = duty || 'Off';
        
        if (duty) {
            dutyClass = `duty-${duty.replace(':', '')}`;
        } else {
            dutyClass = 'off-day-cell';
        }
        
        if (isToday) dutyClass += ' today-cell';
        
        html += `
            <div class="${dutyClass}" style="padding: 10px; min-height: 60px; border-bottom: 1px solid var(--light-gray); ${isToday ? 'position: relative;' : ''}">
                <div style="font-size: 12px; margin-bottom: 5px; ${isToday ? 'font-weight: bold;' : ''}">${day}</div>
                <div style="font-size: 11px; line-height: 1.2;">${dutyText}</div>
                ${isToday ? '<div style="position: absolute; top: 2px; right: 2px; width: 6px; height: 6px; background: var(--primary); border-radius: 50%;"></div>' : ''}
            </div>
        `;
    }
    
    // Fill remaining cells
    const totalCells = 42; // 6 rows * 7 days
    const filledCells = firstDayOfWeek + daysInMonth;
    for (let i = filledCells; i < totalCells; i++) {
        html += '<div style="padding: 20px 10px; min-height: 60px; background: var(--light);"></div>';
    }
    
    html += '</div></div>';
    
    return html;
}

function changeCalendarMonth(delta) {
    const monthInput = document.getElementById('myRosterMonth');
    if (!monthInput) return;
    
    const [year, month] = monthInput.value.split('-').map(Number);
    const newDate = new Date(year, month - 1 + delta, 1);
    const newYear = newDate.getFullYear();
    const newMonth = newDate.getMonth() + 1;
    
    monthInput.value = `${newYear}-${newMonth.toString().padStart(2, '0')}`;
    loadMyRoster();
}

function createTableView(year, month, username) {
    const daysInMonth = new Date(year, month, 0).getDate();
    let html = `
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Day</th>
                        <th>Duty Time</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    const today = new Date().toISOString().split('T')[0];
    
    for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
        const date = new Date(dateStr);
        const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
        const duty = dutyRoster[dateStr] && dutyRoster[dateStr][username];
        const isToday = dateStr === today;
        const isPast = date < new Date() && !isToday;
        
        let dutyClass = '';
        let dutyText = duty || 'Off';
        
        if (duty) {
            dutyClass = `duty-${duty.replace(':', '')}`;
        }
        
        html += `
            <tr ${isToday ? 'style="background: rgba(52, 152, 219, 0.1);"' : ''}>
                <td ${isToday ? 'style="font-weight: bold;"' : ''}>${day}/${month}</td>
                <td>${dayName}</td>
                <td><span class="${dutyClass}" style="padding: 4px 8px; border-radius: 4px; display: inline-block;">${dutyText}</span></td>
                <td>${isPast ? 'Completed' : isToday ? 'Today' : 'Upcoming'}</td>
                <td>
                    ${!isPast && duty && duty !== 'Off' ? `
                        <button class="action-btn apply" onclick="showDutyChangeForDate('${dateStr}', '${duty}')">
                            Request Change
                        </button>
                    ` : '-'}
                </td>
            </tr>
        `;
    }
    
    html += '</tbody></table></div>';
    
    // Add summary
    const dutyDays = Object.keys(dutyRoster).filter(date => {
        const dateObj = new Date(date);
        return dateObj.getFullYear() === year && 
               dateObj.getMonth() + 1 === month &&
               dutyRoster[date][username] && 
               dutyRoster[date][username] !== 'Off';
    }).length;
    
    const offDays = daysInMonth - dutyDays;
    
    html += `
        <div class="card" style="margin-top: 15px;">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value">${dutyDays}</div>
                    <div class="stat-label">Duty Days</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${offDays}</div>
                    <div class="stat-label">Off Days</div>
                </div>
            </div>
        </div>
    `;
    
    return html;
}

function showDutyChangeForDate(date, currentDuty) {
    // Set up duty change form with pre-filled values
    showSection('dutyChange');
    
    setTimeout(() => {
        const dateInput = document.getElementById('changeDate');
        const dutyTimeSelect = document.getElementById('changeDutyTime');
        
        if (dateInput) dateInput.value = date;
        if (dutyTimeSelect) dutyTimeSelect.value = currentDuty;
        
        // Trigger change event to update other fields
        if (dateInput) dateInput.dispatchEvent(new Event('change'));
    }, 300);
}

function initSwipeActions(container) {
    if (!container) return;
    
    let touchStartX = 0;
    let touchEndX = 0;
    
    container.addEventListener('touchstart', function(e) {
        touchStartX = e.changedTouches[0].screenX;
    }, { passive: true });
    
    container.addEventListener('touchend', function(e) {
        touchEndX = e.changedTouches[0].screenX;
        
        const swipeThreshold = 50;
        const diff = touchEndX - touchStartX;
        
        if (Math.abs(diff) > swipeThreshold) {
            const target = e.target.closest('tr, .calendar-day');
            if (target) {
                if (diff > 0) {
                    // Swipe right - show request change
                    const date = target.dataset.date;
                    const duty = target.dataset.duty;
                    if (date && duty && duty !== 'Off') {
                        showDutyChangeForDate(date, duty);
                    }
                } else {
                    // Swipe left - show details
                    target.click();
                }
            }
        }
    }, { passive: true });
}

// Continue with other section loading functions...
function loadAllRoster() {
    const container = document.getElementById('allRosterContainer');
    if (!container) return;
    
    const startDateInput = document.getElementById('allRosterStartDate');
    const endDateInput = document.getElementById('allRosterEndDate');
    const viewTypeSelect = document.getElementById('allRosterViewType');
    
    // Set default dates if not set
    const today = new Date();
    const defaultStart = new Date(today);
    defaultStart.setDate(defaultStart.getDate() - 7);
    
    if (!startDateInput.value) {
        startDateInput.value = defaultStart.toISOString().split('T')[0];
    }
    if (!endDateInput.value) {
        endDateInput.value = new Date(today.getTime() + 14 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
    }
    
    const startDate = new Date(startDateInput.value);
    const endDate = new Date(endDateInput.value);
    const viewType = viewTypeSelect ? viewTypeSelect.value : 'table';
    
    container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading complete roster...</p></div>';
    
    setTimeout(() => {
        if (viewType === 'staff') {
            container.innerHTML = createStaffViewRoster(startDate, endDate);
        } else if (viewType === 'calendar') {
            container.innerHTML = createCalendarRoster(startDate, endDate);
        } else {
            container.innerHTML = createDailyRoster(startDate, endDate);
        }
    }, 500);
}

function createDailyRoster(startDate, endDate) {
    const dateArray = [];
    const currentDate = new Date(startDate);
    
    while (currentDate <= endDate) {
        dateArray.push(new Date(currentDate));
        currentDate.setDate(currentDate.getDate() + 1);
    }
    
    let html = `
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>Staff Name</th>
                        ${dateArray.map(date => `
                            <th style="text-align: center; min-width: 100px;">
                                <div>${date.toLocaleDateString('en-US', { weekday: 'short' })}</div>
                                <div>${date.getDate()}/${date.getMonth() + 1}</div>
                            </th>
                        `).join('')}
                    </tr>
                </thead>
                <tbody>
    `;
    
    // Get active staff (exclude any test or inactive users)
    const activeStaff = allUsers.filter(user => 
        !user.name.toLowerCase().includes('test') && 
        user.Level !== 'Inactive'
    );
    
    activeStaff.forEach(staff => {
        html += `
            <tr>
                <td style="position: sticky; left: 0; background: white; z-index: 1;">
                    <div style="font-weight: 500;">${staff.name}</div>
                    <div style="font-size: 11px; color: var(--gray);">RC: ${staff.RCNo}</div>
                </td>
                ${dateArray.map(date => {
                    const dateStr = date.toISOString().split('T')[0];
                    const duty = dutyRoster[dateStr] && dutyRoster[dateStr][staff.username];
                    const isToday = dateStr === new Date().toISOString().split('T')[0];
                    
                    let cellClass = '';
                    let dutyText = duty || 'Off';
                    
                    if (duty) {
                        cellClass = `duty-${duty.replace(':', '')}`;
                    } else {
                        cellClass = 'off-day-cell';
                    }
                    
                    if (isToday) cellClass += ' today-cell';
                    
                    return `
                        <td class="${cellClass}" style="text-align: center; padding: 8px; min-width: 100px;">
                            <div style="font-size: 12px; font-weight: ${isToday ? 'bold' : 'normal'};">${dutyText}</div>
                        </td>
                    `;
                }).join('')}
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    
    // Add summary
    html += createRosterSummary(dateArray);
    
    return html;
}

function createRosterSummary(dateArray) {
    const today = new Date().toISOString().split('T')[0];
    const activeStaff = allUsers.filter(user => 
        !user.name.toLowerCase().includes('test') && 
        user.Level !== 'Inactive'
    );
    
    const dutyTimes = getAvailableDutyTimes();
    let summaryHtml = '<div class="card" style="margin-top: 15px;"><h4 style="margin-bottom: 15px;">Roster Summary</h4>';
    
    // Summary by duty time
    dutyTimes.forEach(dutyTime => {
        summaryHtml += `<div style="margin-bottom: 10px;"><strong>${dutyTime}:</strong> `;
        
        dateArray.forEach(date => {
            const dateStr = date.toISOString().split('T')[0];
            const count = activeStaff.filter(staff => 
                dutyRoster[dateStr] && 
                dutyRoster[dateStr][staff.username] === dutyTime
            ).length;
            
            if (count > 0) {
                const dateFormatted = `${date.getDate()}/${date.getMonth() + 1}`;
                summaryHtml += `${dateFormatted}(${count}) `;
            }
        });
        
        summaryHtml += '</div>';
    });
    
    // Staff with most duties
    const staffDutyCounts = activeStaff.map(staff => {
        const count = dateArray.filter(date => {
            const dateStr = date.toISOString().split('T')[0];
            return dutyRoster[dateStr] && 
                   dutyRoster[dateStr][staff.username] && 
                   dutyRoster[dateStr][staff.username] !== 'Off';
        }).length;
        return { name: staff.name, count };
    }).sort((a, b) => b.count - a.count);
    
    summaryHtml += '<div style="margin-top: 15px; border-top: 1px solid var(--light-gray); padding-top: 15px;">';
    summaryHtml += '<h5>Staff Duty Counts</h5>';
    summaryHtml += '<div class="stats-grid" style="grid-template-columns: repeat(2, 1fr); gap: 10px;">';
    
    staffDutyCounts.slice(0, 6).forEach(staff => {
        summaryHtml += `
            <div class="stat-card" style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);">
                <div class="stat-value">${staff.count}</div>
                <div class="stat-label">${staff.name.split(' ')[0]}</div>
            </div>
        `;
    });
    
    summaryHtml += '</div></div></div>';
    
    return summaryHtml;
}

function printAllRoster() {
    const container = document.getElementById('allRosterContainer');
    if (!container) return;
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
            <head>
                <title>Duty Roster - ${new Date().toLocaleDateString()}</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; }
                    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
                    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
                    th { background-color: #f2f2f2; }
                    .duty-cell { font-weight: bold; }
                    .header { text-align: center; margin-bottom: 20px; }
                    .date-range { margin-top: 10px; color: #666; }
                    @media print {
                        @page { size: landscape; }
                        body { margin: 0; }
                    }
                </style>
            </head>
            <body>
                <div class="header">
                    <h2>Complete Duty Roster</h2>
                    <div class="date-range">Generated: ${new Date().toLocaleString()}</div>
                </div>
                ${container.innerHTML}
                <script>
                    window.onload = function() {
                        window.print();
                        setTimeout(() => window.close(), 500);
                    }
                </script>
            </body>
        </html>
    `);
    printWindow.document.close();
}

// Add this function to get available duty times
function getAvailableDutyTimes() {
    return [
        '07:30-15:30',
        '08:30-16:30', 
        '10:30-18:30',
        '15:30-23:30',
        '16:30-00:30',
        '17:30-01:30',
        '00:30-08:30',
        'Off',
        'No Duty'
    ];
}

// Add this modal creation for adjust balance
function showAdjustBalanceModal() {
    if (currentUser.level !== 'Supervisor') {
        showToast('Only supervisors can adjust balances', 'warning');
        return;
    }
    
    const modalContent = `
        <div class="modal-header">
            <h3 class="modal-title">Adjust Leave Balance</h3>
            <button class="modal-close" onclick="hideModal('adjustBalanceModal')">
                <ion-icon name="close-outline"></ion-icon>
            </button>
        </div>
        <div class="modal-body">
            <form id="adjustBalanceForm">
                <div class="form-group">
                    <label for="adjustStaff" class="form-label">Select Staff *</label>
                    <select id="adjustStaff" class="form-control" required>
                        <option value="">Select staff member</option>
                        ${allUsers.map(user => `
                            <option value="${user.username}">${user.name} (RC: ${user.RCNo})</option>
                        `).join('')}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="adjustLeaveType" class="form-label">Leave Type *</label>
                    <select id="adjustLeaveType" class="form-control" required>
                        <option value="">Select type</option>
                        <option value="SL">Sick Leave</option>
                        <option value="FRL">FRL</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="adjustAction" class="form-label">Action *</label>
                    <select id="adjustAction" class="form-control" required>
                        <option value="">Select action</option>
                        <option value="add">Add Days</option>
                        <option value="subtract">Subtract Days</option>
                        <option value="set">Set to Specific Value</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="adjustDays" class="form-label">Number of Days *</label>
                    <input type="number" id="adjustDays" class="form-control" 
                           min="0" max="365" step="0.5" required 
                           placeholder="Enter number of days">
                </div>
                
                <div class="form-group">
                    <label for="adjustReason" class="form-label">Reason for Adjustment *</label>
                    <textarea id="adjustReason" class="form-control" rows="3" 
                              placeholder="Provide reason for this adjustment" required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="currentBalance" class="form-label">Current Balance</label>
                    <input type="text" id="currentBalance" class="form-control" readonly>
                </div>
                
                <div class="form-group">
                    <label for="newBalance" class="form-label">New Balance Will Be</label>
                    <input type="text" id="newBalance" class="form-control" readonly>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="hideModal('adjustBalanceModal')">Cancel</button>
            <button class="btn btn-primary" onclick="submitBalanceAdjustment()">Apply Adjustment</button>
        </div>
    `;
    
    // Create or update modal
    let modal = document.getElementById('adjustBalanceModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'adjustBalanceModal';
        modal.className = 'modal';
        modal.innerHTML = `<div class="modal-content" style="max-width: 500px;">${modalContent}</div>`;
        document.body.appendChild(modal);
        
        // Add event listeners for real-time calculation
        const staffSelect = modal.querySelector('#adjustStaff');
        const typeSelect = modal.querySelector('#adjustLeaveType');
        const actionSelect = modal.querySelector('#adjustAction');
        const daysInput = modal.querySelector('#adjustDays');
        
        function calculateNewBalance() {
            const staff = staffSelect.value;
            const type = typeSelect.value;
            const action = actionSelect.value;
            const days = parseFloat(daysInput.value) || 0;
            
            if (!staff || !type || !action) return;
            
            const currentBal = leaveBalances[staff] || {SL: 0, FRL: 0};
            const currentValue = currentBal[type];
            
            modal.querySelector('#currentBalance').value = `${currentValue} days`;
            
            let newValue = currentValue;
            switch(action) {
                case 'add':
                    newValue = currentValue + days;
                    break;
                case 'subtract':
                    newValue = Math.max(0, currentValue - days);
                    break;
                case 'set':
                    newValue = days;
                    break;
            }
            
            modal.querySelector('#newBalance').value = `${newValue} days`;
        }
        
        if (staffSelect) staffSelect.addEventListener('change', calculateNewBalance);
        if (typeSelect) typeSelect.addEventListener('change', calculateNewBalance);
        if (actionSelect) actionSelect.addEventListener('change', calculateNewBalance);
        if (daysInput) daysInput.addEventListener('input', calculateNewBalance);
    } else {
        modal.querySelector('.modal-content').innerHTML = modalContent;
    }
    
    modal.classList.add('active');
}

async function submitBalanceAdjustment() {
    const staff = document.getElementById('adjustStaff').value;
    const type = document.getElementById('adjustLeaveType').value;
    const action = document.getElementById('adjustAction').value;
    const days = parseFloat(document.getElementById('adjustDays').value);
    const reason = document.getElementById('adjustReason').value;
    
    if (!staff || !type || !action || !days || !reason) {
        showToast('Please fill all fields', 'warning');
        return;
    }
    
    if (!leaveBalances[staff]) {
        leaveBalances[staff] = {SL: 0, FRL: 0};
    }
    
    const currentValue = leaveBalances[staff][type];
    let newValue = currentValue;
    
    switch(action) {
        case 'add':
            newValue = currentValue + days;
            break;
        case 'subtract':
            newValue = Math.max(0, currentValue - days);
            if (newValue === 0 && currentValue > 0) {
                showToast('Balance will be set to zero', 'warning');
            }
            break;
        case 'set':
            newValue = days;
            break;
    }
    
    // Create balance adjustment record
    const adjustment = {
        id: 'adj_' + Date.now(),
        staff: staff,
        staffName: allUsers.find(u => u.username === staff)?.name || 'Unknown',
        leaveType: type,
        action: action,
        days: days,
        previousValue: currentValue,
        newValue: newValue,
        reason: reason,
        adjustedBy: currentUser.name,
        timestamp: new Date().toISOString()
    };
    
    // Update balance
    leaveBalances[staff][type] = newValue;
    
    // Save adjustment to history (you might want a separate collection for this)
    if (!leaveBalances._adjustments) leaveBalances._adjustments = [];
    leaveBalances._adjustments.push(adjustment);
    
    try {
        await saveLeaveBalances();
        showToast(`Balance updated successfully. New ${type} balance: ${newValue} days`, 'success');
        hideModal('adjustBalanceModal');
        
        // Refresh the balance display
        if (currentSection === 'adminLeaveBalance') {
            loadLeaveBalanceAdmin();
        }
        
        // Update user's own display if they adjusted their own balance
        if (staff === currentUser.username) {
            updateUserBalance();
        }
    } catch (error) {
        showToast('Failed to update balance', 'error');
    }
}

// Add this function to load leave balance admin view
async function loadLeaveBalanceAdmin() {
    if (!currentUser || currentUser.level !== 'Supervisor') {
        showToast('Only supervisors can access this page', 'warning');
        showSection('home');
        return;
    }
    
    const container = document.getElementById('leaveBalanceTable');
    if (!container) return;
    
    container.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;"><div class="spinner" style="margin: 0 auto 10px;"></div><p>Loading...</p></td></tr>';
    
    setTimeout(() => {
        const staffFilter = document.getElementById('balanceStaffFilter');
        const typeFilter = document.getElementById('balanceLeaveTypeFilter');
        
        let filteredStaff = allUsers.filter(user => 
            !user.name.toLowerCase().includes('test') && 
            user.Level !== 'Inactive'
        );
        
        if (staffFilter && staffFilter.value !== 'all') {
            filteredStaff = filteredStaff.filter(user => user.username === staffFilter.value);
        }
        
        container.innerHTML = '';
        
        if (filteredStaff.length === 0) {
            container.innerHTML = `
                <tr>
                    <td colspan="5" style="text-align: center; padding: 30px;">
                        <ion-icon name="people-outline" style="font-size: 48px; color: var(--gray); opacity: 0.3;"></ion-icon>
                        <p style="margin-top: 10px;">No staff found</p>
                    </td>
                </tr>
            `;
            return;
        }
        
        let totalSL = 0;
        let totalFRL = 0;
        
        filteredStaff.forEach(user => {
            const balance = leaveBalances[user.username] || {SL: 0, FRL: 0};
            
            if (typeFilter && typeFilter.value !== 'all') {
                const type = typeFilter.value;
                const value = balance[type];
                
                if (type === 'SL') totalSL += value;
                if (type === 'FRL') totalFRL += value;
                
                container.innerHTML += `
                    <tr>
                        <td>${user.name}</td>
                        <td>${type === 'SL' ? value.toFixed(1) : '-'}</td>
                        <td>${type === 'FRL' ? value.toFixed(1) : '-'}</td>
                        <td>${leaveBalances._adjustments ? 
                            formatTimeAgo(leaveBalances._adjustments
                                .filter(adj => adj.staff === user.username)
                                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))[0]?.timestamp) || 'Never'
                            : 'Never'}</td>
                        <td>
                            <button class="action-btn view" onclick="viewBalanceHistory('${user.username}')">
                                View History
                            </button>
                        </td>
                    </tr>
                `;
            } else {
                totalSL += balance.SL;
                totalFRL += balance.FRL;
                
                container.innerHTML += `
                    <tr>
                        <td>${user.name}</td>
                        <td>${balance.SL.toFixed(1)}</td>
                        <td>${balance.FRL.toFixed(1)}</td>
                        <td>${leaveBalances._adjustments ? 
                            formatTimeAgo(leaveBalances._adjustments
                                .filter(adj => adj.staff === user.username)
                                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))[0]?.timestamp) || 'Never'
                            : 'Never'}</td>
                        <td>
                            <button class="action-btn view" onclick="viewBalanceHistory('${user.username}')">
                                View History
                            </button>
                        </td>
                    </tr>
                `;
            }
        });
        
        // Update summary stats
        document.getElementById('totalSL').textContent = totalSL.toFixed(1);
        document.getElementById('totalFRL').textContent = totalFRL.toFixed(1);
        document.getElementById('totalStaff').textContent = filteredStaff.length;
        
    }, 500);
}

function viewBalanceHistory(username) {
    const user = allUsers.find(u => u.username === username);
    if (!user) {
        showToast('User not found', 'error');
        return;
    }
    
    const balance = leaveBalances[username] || {SL: 0, FRL: 0};
    const adjustments = (leaveBalances._adjustments || [])
        .filter(adj => adj.staff === username)
        .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    
    let historyHtml = '';
    if (adjustments.length > 0) {
        historyHtml = '<h4>Adjustment History</h4><div class="table-responsive"><table>';
        historyHtml += '<thead><tr><th>Date</th><th>Type</th><th>Action</th><th>Days</th><th>From</th><th>To</th><th>By</th><th>Reason</th></tr></thead><tbody>';
        
        adjustments.forEach(adj => {
            historyHtml += `
                <tr>
                    <td>${formatTimeAgo(adj.timestamp)}</td>
                    <td>${adj.leaveType}</td>
                    <td>${adj.action}</td>
                    <td>${adj.days}</td>
                    <td>${adj.previousValue.toFixed(1)}</td>
                    <td>${adj.newValue.toFixed(1)}</td>
                    <td>${adj.adjustedBy}</td>
                    <td style="max-width: 200px; word-wrap: break-word;">${adj.reason}</td>
                </tr>
            `;
        });
        
        historyHtml += '</tbody></table></div>';
    } else {
        historyHtml = '<p>No adjustment history found</p>';
    }
    
    const modalContent = `
        <div class="modal-header">
            <h3 class="modal-title">Leave Balance History - ${user.name}</h3>
            <button class="modal-close" onclick="hideModal('balanceHistoryModal')">
                <ion-icon name="close-outline"></ion-icon>
            </button>
        </div>
        <div class="modal-body">
            <div style="margin-bottom: 20px;">
                <h4>Current Balances</h4>
                <div class="stats-grid" style="grid-template-columns: repeat(2, 1fr);">
                    <div class="stat-card">
                        <div class="stat-value">${balance.SL.toFixed(1)}</div>
                        <div class="stat-label">Sick Leave</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${balance.FRL.toFixed(1)}</div>
                        <div class="stat-label">FRL</div>
                    </div>
                </div>
            </div>
            ${historyHtml}
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="hideModal('balanceHistoryModal')">Close</button>
        </div>
    `;
    
    let modal = document.getElementById('balanceHistoryModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'balanceHistoryModal';
        modal.className = 'modal';
        modal.innerHTML = `<div class="modal-content" style="max-width: 800px; max-height: 80vh;">${modalContent}</div>`;
        document.body.appendChild(modal);
    } else {
        modal.querySelector('.modal-content').innerHTML = modalContent;
    }
    
    modal.classList.add('active');
}

// Add this function to handle pending requests
async function loadPendingRequests() {
    if (!currentUser) return;
    
    const container = document.getElementById('pendingRequestsContainer');
    const noRequestsDiv = document.getElementById('noPendingRequests');
    const tabs = document.getElementById('pendingRequestsTabs');
    
    if (!container) return;
    
    container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading pending requests...</p></div>';
    
    setTimeout(() => {
        const activeTab = tabs ? tabs.querySelector('.tab-btn.active') : null;
        const requestType = activeTab ? activeTab.dataset.type : 'dutyChange';
        
        const pendingRequests = allRequests.filter(req => 
            req.status === 'pending' && 
            req.type === requestType &&
            ((requestType === 'dutyChange' && req.toUsername === currentUser.username) ||
             (requestType === 'leave' && currentUser.level === 'Supervisor'))
        );
        
        // Update badge
        const badge = document.getElementById('pendingCountHeader');
        if (badge) {
            badge.textContent = pendingRequests.length;
        }
        
        if (pendingRequests.length === 0) {
            container.innerHTML = '';
            if (noRequestsDiv) noRequestsDiv.style.display = 'block';
            return;
        }
        
        if (noRequestsDiv) noRequestsDiv.style.display = 'none';
        container.innerHTML = '';
        
        pendingRequests.forEach(req => {
            const card = document.createElement('div');
            card.className = 'card';
            card.style.marginBottom = '10px';
            card.dataset.requestId = req.id;
            
            let details = '';
            let actions = '';
            
            if (req.type === 'dutyChange') {
                details = `
                    <p><strong>From:</strong> ${req.fromName} (RC: ${req.fromRcNo})</p>
                    <p><strong>Requesting:</strong> Swap duty on ${req.date}</p>
                    <p><strong>Their Duty:</strong> ${req.dutyTime} â†’ Your Duty: ${req.toDutyTime}</p>
                    <p><strong>Reason:</strong> ${req.reason || 'Not provided'}</p>
                `;
                
                actions = `
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button class="btn btn-success" onclick="approveRequest('${req.id}')" style="flex: 1;">
                            <ion-icon name="checkmark-outline"></ion-icon>
                            Approve
                        </button>
                        <button class="btn btn-danger" onclick="rejectRequest('${req.id}')" style="flex: 1;">
                            <ion-icon name="close-outline"></ion-icon>
                            Reject
                        </button>
                    </div>
                `;
            } else if (req.type === 'leave') {
                details = `
                    <p><strong>Staff:</strong> ${req.fromName} (RC: ${req.fromRcNo})</p>
                    <p><strong>Leave Type:</strong> ${req.leaveType}</p>
                    <p><strong>Date:</strong> ${req.date}</p>
                    <p><strong>Duration:</strong> ${req.duration} day(s)</p>
                    <p><strong>Reason:</strong> ${req.reason}</p>
                    <p><strong>Current Balance:</strong> 
                        SL: ${(leaveBalances[req.fromUsername]?.SL || 0).toFixed(1)} days, 
                        FRL: ${(leaveBalances[req.fromUsername]?.FRL || 0).toFixed(1)} days
                    </p>
                `;
                
                actions = `
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button class="btn btn-success" onclick="approveRequest('${req.id}')" style="flex: 1;">
                            <ion-icon name="checkmark-outline"></ion-icon>
                            Approve
                        </button>
                        <button class="btn btn-danger" onclick="rejectRequest('${req.id}')" style="flex: 1;">
                            <ion-icon name="close-outline"></ion-icon>
                            Reject
                        </button>
                        <button class="btn btn-secondary" onclick="viewRequestDetailsModal('${req.id}')" style="flex: 0.5;">
                            <ion-icon name="information-outline"></ion-icon>
                            Details
                        </button>
                    </div>
                `;
            }
            
            card.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                    <div>
                        <h4 style="margin: 0;">${req.type === 'dutyChange' ? 'Duty Change Request' : 'Leave Application'}</h4>
                        <small style="color: var(--gray);">${formatTimeAgo(req.timestamp)}</small>
                    </div>
                    <span class="status-badge status-pending">Pending</span>
                </div>
                ${details}
                ${actions}
            `;
            
            container.appendChild(card);
        });
        
        // Add swipe actions for mobile
        const cards = container.querySelectorAll('.card');
        cards.forEach(card => {
            initCardSwipeActions(card);
        });
        
    }, 500);
}

function initCardSwipeActions(card) {
    let touchStartX = 0;
    let touchEndX = 0;
    
    card.addEventListener('touchstart', function(e) {
        touchStartX = e.changedTouches[0].clientX;
    }, { passive: true });
    
    card.addEventListener('touchend', function(e) {
        touchEndX = e.changedTouches[0].clientX;
        
        const swipeThreshold = 50;
        const diff = touchEndX - touchStartX;
        
        if (Math.abs(diff) > swipeThreshold) {
            const requestId = this.dataset.requestId;
            if (diff > 0) {
                // Swipe right - approve
                approveRequest(requestId);
            } else {
                // Swipe left - reject
                rejectRequest(requestId);
            }
        }
    }, { passive: true });
}

async function approveRequest(requestId) {
    const request = allRequests.find(req => req.id === requestId);
    if (!request) {
        showToast('Request not found', 'error');
        return;
    }
    
    if (request.type === 'leave' && currentUser.level !== 'Supervisor') {
        showToast('Only supervisors can approve leave requests', 'warning');
        return;
    }
    
    confirmAction('Approve Request', 'Are you sure you want to approve this request?', async function() {
        showLoading('Processing approval...');
        
        try {
            // Update request status
            request.status = 'approved';
            request.history.push({
                action: 'approved',
                by: currentUser.name,
                timestamp: new Date().toISOString()
            });
            
            // Process based on request type
            if (request.type === 'leave') {
                // Deduct leave balance
                if (!leaveBalances[request.fromUsername]) {
                    leaveBalances[request.fromUsername] = {SL: 0, FRL: 0};
                }
                
                if (request.leaveType === 'Sick Leave') {
                    leaveBalances[request.fromUsername].SL -= request.duration;
                    if (leaveBalances[request.fromUsername].SL < 0) {
                        leaveBalances[request.fromUsername].SL = 0;
                    }
                } else if (request.leaveType === 'FRL') {
                    leaveBalances[request.fromUsername].FRL -= request.duration;
                    if (leaveBalances[request.fromUsername].FRL < 0) {
                        leaveBalances[request.fromUsername].FRL = 0;
                    }
                }
                
                // Update duty roster to show leave
                if (dutyRoster[request.date]) {
                    dutyRoster[request.date][request.fromUsername] = 'Leave';
                }
                
                await saveLeaveBalances();
            } else if (request.type === 'dutyChange') {
                // Swap duties in roster
                if (dutyRoster[request.date]) {
                    const temp = dutyRoster[request.date][request.fromUsername];
                    dutyRoster[request.date][request.fromUsername] = request.toDutyTime;
                    dutyRoster[request.date][request.toUsername] = temp;
                    await saveDutyRoster();
                }
            }
            
            await saveAllRequests();
            
            hideLoading();
            showToast('Request approved successfully', 'success');
            
            // Refresh appropriate sections
            if (currentSection === 'pendingRequests') {
                loadPendingRequests();
            } else if (currentSection === 'adminApprovals') {
                loadAdminApprovals();
            }
            
            updateRequestCounts();
            updateDashboard();
            
        } catch (error) {
            hideLoading();
            showToast('Failed to approve request: ' + error.message, 'error');
        }
    });
}

async function rejectRequest(requestId) {
    const request = allRequests.find(req => req.id === requestId);
    if (!request) {
        showToast('Request not found', 'error');
        return;
    }
    
    // Show reason input modal
    const modalContent = `
        <div class="modal-header">
            <h3 class="modal-title">Reject Request</h3>
            <button class="modal-close" onclick="hideModal('rejectReasonModal')">
                <ion-icon name="close-outline"></ion-icon>
            </button>
        </div>
        <div class="modal-body">
            <p>Please provide a reason for rejecting this request:</p>
            <div class="form-group">
                <textarea id="rejectReason" class="form-control" rows="3" 
                          placeholder="Reason for rejection..." required></textarea>
            </div>
            <p><strong>Request Details:</strong></p>
            <p>${request.type === 'dutyChange' ? 
                `Duty change from ${request.fromName} on ${request.date}` : 
                `${request.leaveType} application from ${request.fromName} for ${request.duration} day(s)`}
            </p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="hideModal('rejectReasonModal')">Cancel</button>
            <button class="btn btn-danger" onclick="submitRejection('${requestId}')">Reject Request</button>
        </div>
    `;
    
    let modal = document.getElementById('rejectReasonModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'rejectReasonModal';
        modal.className = 'modal';
        modal.innerHTML = `<div class="modal-content" style="max-width: 500px;">${modalContent}</div>`;
        document.body.appendChild(modal);
    } else {
        modal.querySelector('.modal-content').innerHTML = modalContent;
    }
    
    modal.classList.add('active');
}

async function submitRejection(requestId) {
    const reason = document.getElementById('rejectReason')?.value;
    if (!reason || reason.trim() === '') {
        showToast('Please provide a rejection reason', 'warning');
        return;
    }
    
    const request = allRequests.find(req => req.id === requestId);
    if (!request) {
        showToast('Request not found', 'error');
        return;
    }
    
    showLoading('Processing rejection...');
    
    try {
        request.status = 'rejected';
        request.rejectionReason = reason;
        request.history.push({
            action: 'rejected',
            by: currentUser.name,
            reason: reason,
            timestamp: new Date().toISOString()
        });
        
        await saveAllRequests();
        
        hideModal('rejectReasonModal');
        hideLoading();
        showToast('Request rejected successfully', 'success');
        
        // Refresh appropriate sections
        if (currentSection === 'pendingRequests') {
            loadPendingRequests();
        } else if (currentSection === 'adminApprovals') {
            loadAdminApprovals();
        }
        
        updateRequestCounts();
        
    } catch (error) {
        hideLoading();
        showToast('Failed to reject request: ' + error.message, 'error');
    }
}

function refreshPendingRequests() {
    loadPendingRequests();
}

// Add this for admin approvals
async function loadAdminApprovals() {
    if (!currentUser || currentUser.level !== 'Supervisor') {
        showToast('Only supervisors can access this page', 'warning');
        showSection('home');
        return;
    }
    
    const container = document.getElementById('approvalsContainer');
    const noApprovalsDiv = document.getElementById('noApprovals');
    const tabs = document.getElementById('approvalsTabs');
    
    if (!container) return;
    
    container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading approvals...</p></div>';
    
    setTimeout(() => {
        const activeTab = tabs ? tabs.querySelector('.tab-btn.active') : null;
        const filterType = activeTab ? activeTab.dataset.type : 'all';
        
        let pendingRequests = allRequests.filter(req => req.status === 'pending');
        
        if (filterType !== 'all') {
            pendingRequests = pendingRequests.filter(req => req.type === filterType);
        }
        
        // Update badge
        const badge = document.getElementById('approvalCountHeader');
        if (badge) {
            badge.textContent = pendingRequests.length;
        }
        
        if (pendingRequests.length === 0) {
            container.innerHTML = '';
            if (noApprovalsDiv) noApprovalsDiv.style.display = 'block';
            return;
        }
        
        if (noApprovalsDiv) noApprovalsDiv.style.display = 'none';
        container.innerHTML = '';
        
        pendingRequests.forEach(req => {
            const card = document.createElement('div');
            card.className = 'card';
            card.style.marginBottom = '10px';
            card.dataset.requestId = req.id;
            
            let details = '';
            
            if (req.type === 'dutyChange') {
                details = `
                    <p><strong>Type:</strong> Duty Change Request</p>
                    <p><strong>From:</strong> ${req.fromName} (RC: ${req.fromRcNo})</p>
                    <p><strong>To:</strong> ${req.toName} (RC: ${req.toRcNo})</p>
                    <p><strong>Date:</strong> ${req.date}</p>
                    <p><strong>Swap:</strong> ${req.dutyTime} â†” ${req.toDutyTime}</p>
                    <p><strong>Reason:</strong> ${req.reason || 'Not provided'}</p>
                `;
            } else {
                details = `
                    <p><strong>Type:</strong> Leave Application</p>
                    <p><strong>Staff:</strong> ${req.fromName} (RC: ${req.fromRcNo})</p>
                    <p><strong>Leave Type:</strong> ${req.leaveType}</p>
                    <p><strong>Date:</strong> ${req.date}</p>
                    <p><strong>Duration:</strong> ${req.duration} day(s)</p>
                    <p><strong>Current Balance:</strong> 
                        SL: ${(leaveBalances[req.fromUsername]?.SL || 0).toFixed(1)} days, 
                        FRL: ${(leaveBalances[req.fromUsername]?.FRL || 0).toFixed(1)} days
                    </p>
                    <p><strong>Reason:</strong> ${req.reason}</p>
                `;
            }
            
            card.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                    <div>
                        <h4 style="margin: 0;">${req.type === 'dutyChange' ? 'Duty Change' : req.leaveType} Request</h4>
                        <small style="color: var(--gray);">${formatTimeAgo(req.timestamp)}</small>
                    </div>
                    <span class="status-badge status-pending">Pending</span>
                </div>
                ${details}
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button class="btn btn-success" onclick="approveRequest('${req.id}')" style="flex: 1;">
                        <ion-icon name="checkmark-outline"></ion-icon>
                        Approve
                    </button>
                    <button class="btn btn-danger" onclick="rejectRequest('${req.id}')" style="flex: 1;">
                        <ion-icon name="close-outline"></ion-icon>
                        Reject
                    </button>
                    <button class="btn btn-secondary" onclick="viewRequestDetailsModal('${req.id}')" style="flex: 0.5;">
                        <ion-icon name="information-outline"></ion-icon>
                        Details
                    </button>
                </div>
            `;
            
            container.appendChild(card);
        });
        
    }, 500);
}

function refreshAdminApprovals() {
    loadAdminApprovals();
}

function viewRequestDetailsModal(requestId) {
    const request = allRequests.find(req => req.id === requestId);
    if (!request) {
        showToast('Request not found', 'error');
        return;
    }
    
    viewRequestDetails(request);
}

// Add this for admin request history
async function loadAdminRequestHistory() {
    if (!currentUser || currentUser.level !== 'Supervisor') {
        showToast('Only supervisors can access this page', 'warning');
        showSection('home');
        return;
    }
    
    const container = document.getElementById('requestHistoryTable');
    if (!container) return;
    
    container.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;"><div class="spinner" style="margin: 0 auto 10px;"></div><p>Loading history...</p></td></tr>';
    
    setTimeout(() => {
        const typeFilter = document.getElementById('historyTypeFilter')?.value || 'all';
        const statusFilter = document.getElementById('historyStatusFilter')?.value || 'all';
        const dateFrom = document.getElementById('historyDateFrom')?.value;
        const dateTo = document.getElementById('historyDateTo')?.value;
        
        let filteredRequests = allRequests;
        
        // Apply filters
        if (typeFilter !== 'all') {
            filteredRequests = filteredRequests.filter(req => req.type === typeFilter);
        }
        
        if (statusFilter !== 'all') {
            filteredRequests = filteredRequests.filter(req => req.status === statusFilter);
        }
        
        if (dateFrom) {
            filteredRequests = filteredRequests.filter(req => req.date >= dateFrom);
        }
        
        if (dateTo) {
            filteredRequests = filteredRequests.filter(req => req.date <= dateTo);
        }
        
        // Sort by timestamp descending
        filteredRequests.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        
        container.innerHTML = '';
        
        if (filteredRequests.length === 0) {
            container.innerHTML = `
                <tr>
                    <td colspan="7" style="text-align: center; padding: 30px;">
                        <ion-icon name="archive-outline" style="font-size: 48px; color: var(--gray); opacity: 0.3;"></ion-icon>
                        <p style="margin-top: 10px;">No request history found</p>
                    </td>
                </tr>
            `;
            return;
        }
        
        // Limit to 100 records for performance
        const displayRequests = filteredRequests.slice(0, 100);
        
        displayRequests.forEach(req => {
            let details = '';
            let processedBy = '-';
            
            if (req.type === 'dutyChange') {
                details = `Swap with ${req.toName}`;
            } else {
                details = `${req.leaveType} - ${req.duration} day(s)`;
            }
            
            // Find who processed the request
            if (req.history && req.history.length > 0) {
                const approval = req.history.find(h => 
                    h.action === 'approved' || h.action === 'rejected'
                );
                if (approval) {
                    processedBy = approval.by;
                }
            }
            
            container.innerHTML += `
                <tr>
                    <td>${req.date}</td>
                    <td>${req.fromName}</td>
                    <td>${req.type === 'dutyChange' ? 'Duty Change' : 'Leave'}</td>
                    <td>${details}</td>
                    <td><span class="status-badge status-${req.status}">${req.status}</span></td>
                    <td>${processedBy}</td>
                    <td>
                        <button class="action-btn view" onclick="viewRequestDetailsModal('${req.id}')">
                            View Details
                        </button>
                    </td>
                </tr>
            `;
        });
        
        // Add summary row if we limited results
        if (filteredRequests.length > 100) {
            container.innerHTML += `
                <tr>
                    <td colspan="7" style="text-align: center; padding: 10px; background: var(--light);">
                        Showing 100 of ${filteredRequests.length} records. Use date filters to narrow results.
                    </td>
                </tr>
            `;
        }
        
    }, 500);
}

function exportRequestHistory() {
    // Create CSV data
    const headers = ['Date', 'Staff Name', 'RC No', 'Type', 'Leave Type', 'Duration', 'Status', 'Reason', 'Timestamp'];
    const rows = allRequests.map(req => [
        req.date,
        req.fromName,
        req.fromRcNo,
        req.type === 'dutyChange' ? 'Duty Change' : 'Leave',
        req.leaveType || '',
        req.duration || '',
        req.status,
        req.reason || '',
        req.timestamp
    ]);
    
    const csvContent = [
        headers.join(','),
        ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
    ].join('\n');
    
    // Create download link
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    
    link.setAttribute('href', url);
    link.setAttribute('download', `request_history_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showToast('CSV export started', 'success');
}

function clearOldHistory() {
    confirmAction('Clear Old Records', 
        'This will remove all request records older than 30 days. This action cannot be undone. Continue?',
        async function() {
            showLoading('Clearing old records...');
            
            try {
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                
                // Keep recent requests and all pending requests
                allRequests = allRequests.filter(req => {
                    if (req.status === 'pending') return true;
                    const reqDate = new Date(req.timestamp);
                    return reqDate > thirtyDaysAgo;
                });
                
                await saveAllRequests();
                hideLoading();
                showToast('Old records cleared successfully', 'success');
                
                if (currentSection === 'adminRequestHistory') {
                    loadAdminRequestHistory();
                }
                
            } catch (error) {
                hideLoading();
                showToast('Failed to clear old records: ' + error.message, 'error');
            }
        }
    );
}

// Add this for announcements admin
async function loadAnnouncementsAdmin() {
    if (!currentUser || currentUser.level !== 'Supervisor') {
        showToast('Only supervisors can access this page', 'warning');
        showSection('home');
        return;
    }
    
    const container = document.getElementById('announcementsContainer');
    const tabs = document.getElementById('announcementsTabs');
    
    if (!container) return;
    
    container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading announcements...</p></div>';
    
    setTimeout(() => {
        const activeTab = tabs ? tabs.querySelector('.tab-btn.active') : null;
        const filterStatus = activeTab ? activeTab.dataset.status : 'active';
        
        let filteredAnnouncements = announcements;
        
        if (filterStatus !== 'all') {
            filteredAnnouncements = announcements.filter(ann => ann.status === filterStatus);
        }
        
        // Sort by date
        filteredAnnouncements.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        
        container.innerHTML = '';
        
        if (filteredAnnouncements.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <ion-icon name="megaphone-outline"></ion-icon>
                    <h3>No Announcements</h3>
                    <p>No ${filterStatus} announcements found</p>
                </div>
            `;
            return;
        }
        
        filteredAnnouncements.forEach(ann => {
            const card = document.createElement('div');
            card.className = 'card';
            card.style.marginBottom = '10px';
            card.dataset.announcementId = ann.id;
            
            let statusBadge = '';
            if (ann.status === 'active') {
                statusBadge = '<span class="status-badge status-approved">Active</span>';
            } else if (ann.status === 'scheduled') {
                statusBadge = '<span class="status-badge status-pending">Scheduled</span>';
            } else if (ann.status === 'expired') {
                statusBadge = '<span class="status-badge status-rejected">Expired</span>';
            } else {
                statusBadge = '<span class="status-badge status-off">Archived</span>';
            }
            
            let targetInfo = '';
            if (ann.target === 'all') {
                targetInfo = '<p><strong>Target:</strong> All Staff</p>';
            } else if (ann.target === 'specific' && ann.targetUsers) {
                targetInfo = `<p><strong>Target:</strong> Specific Staff (${ann.targetUsers.length} users)</p>`;
            }
            
            card.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                    <div>
                        <h4 style="margin: 0;">${ann.title}</h4>
                        <small style="color: var(--gray);">Created: ${formatTimeAgo(ann.createdAt)}</small>
                    </div>
                    ${statusBadge}
                </div>
                
                <div class="announcement-content" style="margin: 10px 0; padding: 10px; background: var(--light); border-radius: var(--radius-sm);">
                    ${ann.content}
                </div>
                
                ${targetInfo}
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px; font-size: 12px; color: var(--gray);">
                    <div>
                        <span>Priority: <strong>${ann.priority}</strong></span>
                        ${ann.expiry ? `<span style="margin-left: 15px;">Expires: ${new Date(ann.expiry).toLocaleDateString()}</span>` : ''}
                    </div>
                    <div style="display: flex; gap: 5px;">
                        <button class="btn btn-sm" onclick="editAnnouncement('${ann.id}')" style="padding: 4px 8px; font-size: 11px;">
                            <ion-icon name="create-outline"></ion-icon>
                        </button>
                        <button class="btn btn-sm" onclick="deleteAnnouncement('${ann.id}')" style="padding: 4px 8px; font-size: 11px; background: var(--danger); color: white;">
                            <ion-icon name="trash-outline"></ion-icon>
                        </button>
                    </div>
                </div>
            `;
            
            container.appendChild(card);
        });
        
    }, 500);
}

function showNewAnnouncementModal() {
    const modalContent = `
        <div class="modal-header">
            <h3 class="modal-title">Create New Announcement</h3>
            <button class="modal-close" onclick="hideModal('newAnnouncementModal')">
                <ion-icon name="close-outline"></ion-icon>
            </button>
        </div>
        <div class="modal-body">
            <form id="newAnnouncementForm">
                <div class="form-group">
                    <label for="announcementTitle" class="form-label">Title *</label>
                    <input type="text" id="announcementTitle" name="announcementTitle" class="form-control" 
                           required autocomplete="off">
                </div>
                
                <div class="form-group">
                    <label for="announcementContent" class="form-label">Content *</label>
                    <textarea id="announcementContent" name="announcementContent" class="form-control" 
                              rows="4" required autocomplete="off"></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="announcementPriority" class="form-label">Priority *</label>
                        <select id="announcementPriority" name="announcementPriority" class="form-control" required>
                            <option value="high">High</option>
                            <option value="medium" selected>Medium</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="announcementStatus" class="form-label">Status *</label>
                        <select id="announcementStatus" name="announcementStatus" class="form-control" required>
                            <option value="active">Active</option>
                            <option value="scheduled">Scheduled</option>
                            <option value="draft">Draft</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="announcementTarget" class="form-label">Target Audience *</label>
                    <select id="announcementTarget" name="announcementTarget" class="form-control" required>
                        <option value="all">All Staff</option>
                        <option value="specific">Specific Staff</option>
                    </select>
                </div>
                
                <div id="specificStaffContainer" style="display: none;">
                    <label class="form-label">Select Staff</label>
                    <div style="max-height: 150px; overflow-y: auto; border: 1px solid var(--light-gray); border-radius: var(--radius-sm); padding: 10px;">
                        ${allUsers.filter(user => user.Level !== 'Inactive').map(user => {
                            const checkboxId = `staff_${user.username}_new`;
                            return `
                                <div style="margin-bottom: 5px;">
                                    <label for="${checkboxId}" style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" id="${checkboxId}" name="${checkboxId}" 
                                               value="${user.username}" style="margin-right: 8px;">
                                        ${user.name} (RC: ${user.RCNo})
                                    </label>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="announcementExpiry" class="form-label">Expiry Date (Optional)</label>
                    <input type="date" id="announcementExpiry" name="announcementExpiry" class="form-control" autocomplete="off">
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="hideModal('newAnnouncementModal')">Cancel</button>
            <button class="btn btn-primary" onclick="submitNewAnnouncement()">Create Announcement</button>
        </div>
    `;
    
    let modal = document.getElementById('newAnnouncementModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'newAnnouncementModal';
        modal.className = 'modal';
        modal.innerHTML = `<div class="modal-content" style="max-width: 500px;">${modalContent}</div>`;
        document.body.appendChild(modal);
        
        // Add event listener for target change
        const targetSelect = modal.querySelector('#announcementTarget');
        const specificContainer = modal.querySelector('#specificStaffContainer');
        
        if (targetSelect && specificContainer) {
            targetSelect.addEventListener('change', function() {
                specificContainer.style.display = this.value === 'specific' ? 'block' : 'none';
            });
        }
    } else {
        modal.querySelector('.modal-content').innerHTML = modalContent;
    }
    
    modal.classList.add('active');
}

async function submitNewAnnouncement() {
    const title = document.getElementById('announcementTitle').value;
    const content = document.getElementById('announcementContent').value;
    const priority = document.getElementById('announcementPriority').value;
    const status = document.getElementById('announcementStatus').value;
    const target = document.getElementById('announcementTarget').value;
    const expiryInput = document.getElementById('announcementExpiry').value; // Only declare once
    
    if (!title || !content) {
        showToast('Please fill all required fields', 'warning');
        return;
    }
    
    let targetUsers = [];
    if (target === 'specific') {
        const checkboxes = document.querySelectorAll('#specificStaffContainer input[type="checkbox"]:checked');
        targetUsers = Array.from(checkboxes).map(cb => cb.value);
        
        if (targetUsers.length === 0) {
            showToast('Please select at least one staff member', 'warning');
            return;
        }
    }
    
    let expiry = null;
    if (expiryInput) {
        const expiryDate = new Date(expiryInput);
        expiry = expiryDate.toISOString();
    }
    
    const announcement = {
        id: 'ann_' + Date.now(),
        title: title,
        content: content,
        priority: priority,
        status: status,
        target: target,
        targetUsers: targetUsers,
        expiry: expiry,
        createdAt: new Date().toISOString(),
        createdBy: currentUser.name
    };
    
    announcements.push(announcement);
    
    try {
        await saveAnnouncements();
        hideModal('newAnnouncementModal');
        showToast('Announcement created successfully', 'success');
        
        if (currentSection === 'adminAnnouncements') {
            loadAnnouncementsAdmin();
        }
        
        // Refresh home announcements if needed
        if (currentSection === 'home' && (target === 'all' || targetUsers.includes(currentUser.username))) {
            loadHomeAnnouncements();
        }
        
    } catch (error) {
        showToast('Failed to create announcement: ' + error.message, 'error');
    }
}

function editAnnouncement(announcementId) {
    const announcement = announcements.find(ann => ann.id === announcementId);
    if (!announcement) {
        showToast('Announcement not found', 'error');
        return;
    }
    
    // Format expiry date correctly for input field
    let expiryDate = '';
    if (announcement.expiry) {
        try {
            const expiry = new Date(announcement.expiry);
            if (!isNaN(expiry.getTime())) {
                expiryDate = expiry.toISOString().split('T')[0];
            }
        } catch (e) {
            console.error('Error parsing expiry date:', e);
        }
    }
    
    // Build the staff checkboxes
    let staffCheckboxes = '';
    allUsers
        .filter(user => user.Level !== 'Inactive')
        .forEach(user => {
            const isChecked = announcement.targetUsers && 
                            announcement.targetUsers.includes(user.username) ? 'checked' : '';
            const checkboxId = `staff_${user.username}_edit`;
            staffCheckboxes += `
                <div style="margin-bottom: 5px;">
                    <label for="${checkboxId}" style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="${checkboxId}" name="${checkboxId}" value="${user.username}" 
                               ${isChecked}
                               style="margin-right: 8px;">
                        ${user.name} (RC: ${user.RCNo})
                    </label>
                </div>
            `;
        });

    // Determine display style
    const displayStyle = announcement.target === 'specific' ? 'block' : 'none';

    const modalContent = `
        <div class="modal-header">
            <h3 class="modal-title">Edit Announcement</h3>
            <button class="modal-close" onclick="hideModal('editAnnouncementModal')">
                <ion-icon name="close-outline"></ion-icon>
            </button>
        </div>
        <div class="modal-body">
            <form id="editAnnouncementForm">
                <div class="form-group">
                    <label for="editAnnouncementTitle" class="form-label">Title *</label>
                    <input type="text" id="editAnnouncementTitle" name="editAnnouncementTitle" class="form-control" 
                           value="${announcement.title.replace(/"/g, '&quot;')}" required autocomplete="off">
                </div>
                
                <div class="form-group">
                    <label for="editAnnouncementContent" class="form-label">Content *</label>
                    <textarea id="editAnnouncementContent" name="editAnnouncementContent" class="form-control" 
                              rows="4" required autocomplete="off">${announcement.content}</textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="editAnnouncementPriority" class="form-label">Priority *</label>
                        <select id="editAnnouncementPriority" name="editAnnouncementPriority" class="form-control" required>
                            <option value="high" ${announcement.priority === 'high' ? 'selected' : ''}>High</option>
                            <option value="medium" ${announcement.priority === 'medium' ? 'selected' : ''}>Medium</option>
                            <option value="low" ${announcement.priority === 'low' ? 'selected' : ''}>Low</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editAnnouncementStatus" class="form-label">Status *</label>
                        <select id="editAnnouncementStatus" name="editAnnouncementStatus" class="form-control" required>
                            <option value="active" ${announcement.status === 'active' ? 'selected' : ''}>Active</option>
                            <option value="scheduled" ${announcement.status === 'scheduled' ? 'selected' : ''}>Scheduled</option>
                            <option value="draft" ${announcement.status === 'draft' ? 'selected' : ''}>Draft</option>
                            <option value="expired" ${announcement.status === 'expired' ? 'selected' : ''}>Expired</option>
                            <option value="archived" ${announcement.status === 'archived' ? 'selected' : ''}>Archived</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="editAnnouncementTarget" class="form-label">Target Audience *</label>
                    <select id="editAnnouncementTarget" name="editAnnouncementTarget" class="form-control" required>
                        <option value="all" ${announcement.target === 'all' ? 'selected' : ''}>All Staff</option>
                        <option value="specific" ${announcement.target === 'specific' ? 'selected' : ''}>Specific Staff</option>
                    </select>
                </div>
                
                <div id="editSpecificStaffContainer" style="display: ${displayStyle};">
                    <label class="form-label">Select Staff</label>
                    <div style="max-height: 150px; overflow-y: auto; border: 1px solid var(--light-gray); border-radius: var(--radius-sm); padding: 10px;">
                        ${staffCheckboxes}
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="editAnnouncementExpiry" class="form-label">Expiry Date</label>
                    <input type="date" id="editAnnouncementExpiry" name="editAnnouncementExpiry" class="form-control" 
                           value="${expiryDate}" autocomplete="off">
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="hideModal('editAnnouncementModal')">Cancel</button>
            <button class="btn btn-primary" onclick="submitEditAnnouncement('${announcementId}')">Update Announcement</button>
        </div>
    `;
    
    let modal = document.getElementById('editAnnouncementModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'editAnnouncementModal';
        modal.className = 'modal';
        modal.innerHTML = `<div class="modal-content" style="max-width: 500px;">${modalContent}</div>`;
        document.body.appendChild(modal);
        
        // Add event listener for target change
        const targetSelect = modal.querySelector('#editAnnouncementTarget');
        const specificContainer = modal.querySelector('#editSpecificStaffContainer');
        
        if (targetSelect && specificContainer) {
            targetSelect.addEventListener('change', function() {
                specificContainer.style.display = this.value === 'specific' ? 'block' : 'none';
            });
        }
    } else {
        modal.querySelector('.modal-content').innerHTML = modalContent;
    }
    
    modal.classList.add('active');
}

async function submitEditAnnouncement(announcementId) {
    const title = document.getElementById('editAnnouncementTitle').value;
    const content = document.getElementById('editAnnouncementContent').value;
    const priority = document.getElementById('editAnnouncementPriority').value;
    const status = document.getElementById('editAnnouncementStatus').value;
    const target = document.getElementById('editAnnouncementTarget').value;
    const expiry = document.getElementById('editAnnouncementExpiry').value;
    
    if (!title || !content) {
        showToast('Please fill all required fields', 'warning');
        return;
    }
    
    let targetUsers = [];
    if (target === 'specific') {
        const checkboxes = document.querySelectorAll('#editSpecificStaffContainer input[type="checkbox"]:checked');
        targetUsers = Array.from(checkboxes).map(cb => cb.value);
        
        if (targetUsers.length === 0) {
            showToast('Please select at least one staff member', 'warning');
            return;
        }
    }
    
    const announcementIndex = announcements.findIndex(ann => ann.id === announcementId);
    if (announcementIndex === -1) {
        showToast('Announcement not found', 'error');
        return;
    }
    
    announcements[announcementIndex] = {
        ...announcements[announcementIndex],
        title: title,
        content: content,
        priority: priority,
        status: status,
        target: target,
        targetUsers: targetUsers,
        expiry: expiry || null,
        updatedAt: new Date().toISOString(),
        updatedBy: currentUser.name
    };
    
    try {
        await saveAnnouncements();
        hideModal('editAnnouncementModal');
        showToast('Announcement updated successfully', 'success');
        
        if (currentSection === 'adminAnnouncements') {
            loadAnnouncementsAdmin();
        }
        
        // Refresh home announcements if needed
        if (currentSection === 'home') {
            loadHomeAnnouncements();
        }
        
    } catch (error) {
        showToast('Failed to update announcement: ' + error.message, 'error');
    }
}

async function deleteAnnouncement(announcementId) {
    confirmAction('Delete Announcement', 
        'Are you sure you want to delete this announcement? This action cannot be undone.',
        async function() {
            const announcementIndex = announcements.findIndex(ann => ann.id === announcementId);
            if (announcementIndex === -1) {
                showToast('Announcement not found', 'error');
                return;
            }
            
            announcements.splice(announcementIndex, 1);
            
            try {
                await saveAnnouncements();
                showToast('Announcement deleted successfully', 'success');
                
                if (currentSection === 'adminAnnouncements') {
                    loadAnnouncementsAdmin();
                }
                
                // Refresh home announcements
                if (currentSection === 'home') {
                    loadHomeAnnouncements();
                }
                
            } catch (error) {
                showToast('Failed to delete announcement: ' + error.message, 'error');
            }
        }
    );
}

// Add tab switching functionality
document.addEventListener('click', function(e) {
    // Handle tab switching
    if (e.target.classList.contains('tab-btn') && !e.target.classList.contains('active')) {
        const tabContainer = e.target.closest('.tabs');
        if (tabContainer) {
            // Remove active from all tabs
            tabContainer.querySelectorAll('.tab-btn').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Add active to clicked tab
            e.target.classList.add('active');
            
            // Refresh content based on current section and active tab
            if (currentSection === 'pendingRequests') {
                loadPendingRequests();
            } else if (currentSection === 'adminApprovals') {
                loadAdminApprovals();
            } else if (currentSection === 'adminAnnouncements') {
                loadAnnouncementsAdmin();
            }
        }
    }
});

// Initialize offline detection
function initOfflineDetection() {
    // Check online status
    function updateOnlineStatus() {
        if (navigator.onLine) {
            showToast('You are back online', 'success');
            // Sync any pending changes when coming back online
            if (currentUser) {
                updateDashboard();
            }
        } else {
            showToast('You are offline. Some features may be limited.', 'warning');
        }
    }
    
    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);
    
    // Initial check
    updateOnlineStatus();
}

// Initialize the app when DOM is loaded
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        initOfflineDetection();
        // Other initialization code...
    });
} else {
    initOfflineDetection();
}

// Add service worker for PWA capabilities (optional)
if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
        navigator.serviceWorker.register('/sw.js').then(function(registration) {
            console.log('ServiceWorker registration successful with scope: ', registration.scope);
        }, function(err) {
            console.log('ServiceWorker registration failed: ', err);
        });
    });
}

// Prevent accidental navigation away
window.addEventListener('beforeunload', function(e) {
    // Check if there are unsaved changes
    const hasUnsavedChanges = false; // Implement your own logic here
    
    if (hasUnsavedChanges) {
        e.preventDefault();
        e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
        return e.returnValue;
    }
});

// Handle back button on mobile
window.addEventListener('popstate', function() {
    if (currentSection !== 'home') {
        showSection('home');
        history.pushState(null, null, window.location.pathname);
    }
});

// Initialize with home section in history
history.pushState({ section: 'home' }, '', window.location.pathname);

// Handle app visibility changes
document.addEventListener('visibilitychange', function() {
    if (!document.hidden && currentUser) {
        // App came to foreground, refresh data
        updateDashboard();
    }
});

// Add error boundary for unhandled errors
window.onerror = function(message, source, lineno, colno, error) {
    console.error('Global error:', { message, source, lineno, colno, error });
    showToast('An unexpected error occurred. Please refresh the app.', 'error');
    return true; // Prevent default error handling
};

// Add promise rejection handler
window.addEventListener('unhandledrejection', function(event) {
    console.error('Unhandled promise rejection:', event.reason);
    showToast('An operation failed. Please try again.', 'error');
});
    </script>
    </body>
    </html>
